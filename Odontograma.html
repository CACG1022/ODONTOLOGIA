<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Odontograma FDI</title>

<!-- =========================
     SUPABASE / SESIÓN
========================= -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
);

window.supabase = supabase;

const APP_URLS = {
  LOGIN: "login.html",
  HOME: "index.html"
};

async function verificarSesion() {
  const { data:{session} } = await supabase.auth.getSession();
  if (!session) {
    window.location.href = APP_URLS.LOGIN;
  }
}
verificarSesion();
</script>

<style>
/* ====== ESTILOS ODONTOGRAMA (IGUAL AL ORIGINAL) ====== */
body{
  margin:0;
  font-family:system-ui,Segoe UI,Arial;
  background:#f6f8fb;
}
#odontograma-wrapper *{ box-sizing:border-box }
#odontograma-wrapper{
  background:#f9f9f9;
  padding:20px 10px 40px;
  border-radius:14px;
}
h1{
  text-align:center;
  color:#0D47A1;
}

.odontograma{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:40px;
  width:max-content;
  margin:0 auto;
}

.fila{ display:flex; gap:10px }
.contenedor-diente{ text-align:center }
.diente{
  width:56px;height:56px;border-radius:50%;
  border:2px solid #ccc;
  position:relative;background:white;
}
.cara{
  position:absolute;width:100%;height:100%;
  cursor:pointer;
}
.superior{clip-path:polygon(50% 50%,0 0,100% 0)}
.inferior{clip-path:polygon(50% 50%,0 100%,100% 100%)}
.izquierda{clip-path:polygon(50% 50%,0 0,0 100%)}
.derecha{clip-path:polygon(50% 50%,100% 0,100% 100%)}
.centro{
  position:absolute;
  width:20px;height:20px;
  border-radius:50%;
  border:1px solid gray;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  cursor:pointer;
}

.numero{font-size:11px;margin-top:4px;color:#555}

.popup{
  position:absolute;
  background:white;
  border:1px solid #ccc;
  padding:10px;
  z-index:9999;
  box-shadow:0 4px 8px rgba(0,0,0,.2);
}
.popup div{
  display:flex;
  align-items:center;
  gap:6px;
  cursor:pointer;
  font-size:13px;
}
.color-box{
  width:12px;height:12px;border:1px solid #444
}

.leyenda{
  max-width:900px;
  margin:40px auto 0;
  background:white;
  padding:20px;
  border-radius:10px;
}
.leyenda-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:8px 14px;
}
</style>
</head>

<body>

<div id="odontograma-wrapper">
  <h1>Odontograma Internacional FDI</h1>

  <div class="odontograma">
    <div class="fila" id="fila-superior"></div>
    <div class="fila" id="fila-inferior"></div>
  </div>

  <div class="leyenda">
    <h3>Leyenda de Preexistencias</h3>
    <div class="leyenda-grid" id="grid-leyenda"></div>
  </div>

  <div style="text-align:center;margin-top:20px">
    <button onclick="exportarOdontograma()" style="
      padding:12px 20px;
      border:none;
      background:#009688;
      color:white;
      font-weight:700;
      border-radius:8px;
      cursor:pointer">
      Guardar odontograma
    </button>
  </div>
</div>

<script>
/* ====== ODONTOGRAMA (MISMA LÓGICA ORIGINAL) ====== */

const preexistencias = {
  Caries:'red', Sano:'#8BC34A', Resina:'#a06c3f',
  Amalgama:'#2B2B2B', Endodoncia:'#005E94',
  Fractura:'orange', Ausente:'#c3c5c7'
};

const dientesSuperior=[18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28];
const dientesInferior=[48,47,46,45,44,43,42,41,31,32,33,34,35,36,37,38];

let reporte={};

const leyenda=document.getElementById("grid-leyenda");
Object.entries(preexistencias).forEach(([n,c])=>{
  const d=document.createElement("div");
  d.innerHTML=`<span class="color-box" style="background:${c}"></span>${n}`;
  leyenda.appendChild(d);
});

function crearDiente(num, cont){
  const c=document.createElement("div");
  c.className="contenedor-diente";

  const d=document.createElement("div");
  d.className="diente";
  d.dataset.numero=num;

  ["superior","inferior","izquierda","derecha"].forEach(r=>{
    const x=document.createElement("div");
    x.className="cara "+r;
    x.dataset.region=r;
    x.onclick=e=>popup(e,x);
    d.appendChild(x);
  });

  const centro=document.createElement("div");
  centro.className="centro";
  centro.dataset.region="centro";
  centro.onclick=e=>popup(e,centro);
  d.appendChild(centro);

  c.appendChild(d);
  c.appendChild(Object.assign(document.createElement("div"),{className:"numero",textContent:num}));
  cont.appendChild(c);
}

function popup(e,el){
  e.stopPropagation();
  document.querySelectorAll(".popup").forEach(p=>p.remove());
  const m=document.createElement("div");
  m.className="popup";

  Object.entries(preexistencias).forEach(([n,c])=>{
    const i=document.createElement("div");
    i.innerHTML=`<span class="color-box" style="background:${c}"></span>${n}`;
    i.onclick=()=>{
      el.style.background=c;
      const d=el.parentElement.dataset.numero;
      const cara=el.dataset.region;
      if(!reporte[d])reporte[d]={};
      reporte[d][cara]=n;
      m.remove();
    };
    m.appendChild(i);
  });

  document.body.appendChild(m);
  m.style.left=e.pageX+"px";
  m.style.top=e.pageY+"px";
}

dientesSuperior.forEach(n=>crearDiente(n,document.getElementById("fila-superior")));
dientesInferior.forEach(n=>crearDiente(n,document.getElementById("fila-inferior")));

function exportarOdontograma(){
  console.log("ODONTOGRAMA:",reporte);
  alert("Odontograma listo (ver consola).");
}
</script>

</body>
</html>

