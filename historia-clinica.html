<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reconocimiento de Voz OdontologÃ­a</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .estado {
      font-weight: bold;
      padding: 6px 12px;
      border-radius: 5px;
      margin-left: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    .activo {
      background-color: #4CAF50;
      color: white;
    }

    .inactivo {
      background-color: #f44336;
      color: white;
    }

    textarea {
      width: 100%;
      height: 120px;
      font-size: 16px;
      margin-bottom: 20px;
      padding: 10px;
    }

    .instrucciones {
      background-color: #f0f8ff;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .instrucciones h3 {
      margin-top: 0;
    }

    .botones {
      margin-bottom: 20px;
    }

    .botones button {
      margin-right: 10px;
      padding: 10px 15px;
      font-size: 15px;
    }
  </style>
</head>
<body>
  <h2>Reconocimiento de Voz OdontologÃ­a</h2>

  <div class="instrucciones">
    <h3>ğŸ—£ï¸ Instrucciones de activaciÃ³n por voz:</h3>
    <ul>
      <li>âœ… Di: <strong>â€œdictado historia clÃ­nicaâ€</strong> para comenzar dictado en historia clÃ­nica</li>
      <li>ğŸš« Di: <strong>â€œterminar historia clÃ­nicaâ€</strong> para detenerlo</li>
      <li>âœ… Di: <strong>â€œdictado plan de tratamientoâ€</strong> para comenzar en plan de tratamiento</li>
      <li>ğŸš« Di: <strong>â€œterminar plan de tratamientoâ€</strong> para detenerlo</li>
      <li>ğŸ–ï¸ TambiÃ©n puedes <strong>hacer clic en los botones de estado</strong> para activar/desactivar manualmente el dictado</li>
    </ul>
  </div>

  <div class="botones">
    <button id="startButton">ğŸ¤ Iniciar Reconocimiento</button>
    <button id="stopButton">ğŸ›‘ Detener Reconocimiento</button>
  </div>

  <h3>Historia ClÃ­nica
    <span id="estadoHC" class="estado inactivo">Dictado inactivo</span>
  </h3>
  <textarea id="historiaClinica" placeholder="Dictado aquÃ­..."></textarea>

  <h3>Plan de Tratamiento
    <span id="estadoPT" class="estado inactivo">Dictado inactivo</span>
  </h3>
  <textarea id="planTratamiento" placeholder="Dictado aquÃ­..."></textarea>

  <script>
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const historiaClinica = document.getElementById('historiaClinica');
    const planTratamiento = document.getElementById('planTratamiento');
    const estadoHC = document.getElementById('estadoHC');
    const estadoPT = document.getElementById('estadoPT');

    let modo = null;
    let reconocimientoActivo = false;

    function beep() {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();

      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
      gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);

      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      oscillator.start();
      oscillator.stop(audioCtx.currentTime + 0.2);
    }

    function actualizarEstado(campo, activo) {
      const estado = campo === 'hc' ? estadoHC : estadoPT;
      if (activo) {
        estado.textContent = 'Dictado activo';
        estado.classList.remove('inactivo');
        estado.classList.add('activo');
      } else {
        estado.textContent = 'Dictado inactivo';
        estado.classList.remove('activo');
        estado.classList.add('inactivo');
      }
    }

    function activarManual(campo) {
      if (!reconocimientoActivo) return;

      if (modo === campo) {
        // Si ya estaba activo, lo desactiva
        modo = null;
        actualizarEstado(campo, false);
      } else {
        // Activa ese campo y desactiva el otro
        modo = campo;
        actualizarEstado('hc', campo === 'hc');
        actualizarEstado('pt', campo === 'pt');
        beep();
      }
    }

    estadoHC.addEventListener('click', () => activarManual('hc'));
    estadoPT.addEventListener('click', () => activarManual('pt'));

    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'es-ES';
    recognition.continuous = true;
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
      console.log("Escuchado:", transcript);

      if (transcript.includes("dictado historia clÃ­nica")) {
        modo = 'hc';
        actualizarEstado('hc', true);
        actualizarEstado('pt', false);
        beep();
      } else if (transcript.includes("terminar historia clÃ­nica")) {
        modo = null;
        actualizarEstado('hc', false);
        beep();
      } else if (transcript.includes("dictado plan de tratamiento")) {
        modo = 'pt';
        actualizarEstado('pt', true);
        actualizarEstado('hc', false);
        beep();
      } else if (transcript.includes("terminar plan de tratamiento")) {
        modo = null;
        actualizarEstado('pt', false);
        beep();
      } else if (modo === 'hc') {
        historiaClinica.value += transcript + '. ';
      } else if (modo === 'pt') {
        planTratamiento.value += transcript + '. ';
      }
    };

    recognition.onerror = (event) => {
      console.error("Error:", event.error);
    };

    recognition.onend = () => {
      if (reconocimientoActivo) recognition.start();
    };

    startButton.addEventListener("click", () => {
      reconocimientoActivo = true;
      recognition.start();
      alert("ğŸ§ Escuchando... Usa voz o haz clic en los botones para activar el dictado.");
    });

    stopButton.addEventListener("click", () => {
      reconocimientoActivo = false;
      recognition.stop();
      modo = null;
      actualizarEstado('hc', false);
      actualizarEstado('pt', false);
    });
  </script>
</body>
</html>

