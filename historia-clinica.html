<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historia Cl√≠nica Odontol√≥gica + Odontograma</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- üîê LOGIN CON SUPABASE -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
    );

    // ‚úÖ Para que cerrarSesion() funcione desde el <script> normal
    window.supabase = supabase;

    async function verificarSesion() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
      }
    }

    verificarSesion();

    supabase.auth.onAuthStateChange((_event, session) => {
      if (!session) {
        window.location.href = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
      }
    });
  </script>

  <style>
    :root{
      --ink:#19324d;
      --muted:#6b7a90;
      --bg:#f6f8fb;
      --card:#ffffff;
      --brand:#2a5d84;
      --gap:18px;
      --radius:14px;
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --line:#e7edf5;
      --input:#cbd5e1;
    }

    *{box-sizing:border-box}
    body{
      margin:0; padding:24px; font-family:system-ui,Segoe UI,Arial; color:var(--ink); background:var(--bg);
    }
    .container{ max-width:1100px; margin:0 auto; }
    h1{ margin:0 0 14px; font-size:28px; color:var(--brand); }
    h2{ font-size:18px; margin:0 0 14px; color:var(--brand); }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:var(--shadow);
      margin-bottom:22px;
    }
    .legend{ font-weight:700; margin-bottom:8px; color:var(--brand); }

    form#historia-form{ margin-bottom:28px; }

    .grid{ display:grid; gap:var(--gap); }
    .g-2{ grid-template-columns:1fr 1fr; }
    .g-3{ grid-template-columns:repeat(3,1fr); }
    .g-4{ grid-template-columns:repeat(4,1fr); }
    .full{ grid-column:1 / -1; }

    .ctrl{ display:flex; flex-direction:column; gap:8px; }
    .ctrl label{ font-size:13px; color:var(--muted); }

    input[type="text"],input[type="email"],input[type="tel"],
    input[type="number"],input[type="date"],input[type="time"], textarea{
      width:100%; border:1px solid var(--input); border-radius:10px; padding:12px;
      font-size:15px; background:#fff;
    }
    select {
     width:100%;
     border:1px solid var(--input);
     border-radius:10px;
     padding:12px;
     font-size:15px;
     background:#fff;
     cursor:pointer;
    }

    textarea{ min-height:120px; resize:vertical; }
    .inline{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:4px 10px;
      border:1px solid var(--line); border-radius:999px; background:#fff;
    }

    .checks{
      display:grid; gap:10px 18px;
      grid-template-columns:repeat(2,minmax(220px,1fr));
      padding-top:10px;
    }
    .check{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px dashed var(--line); border-radius:10px; background:#fafcff;
    }

    .rowline{ height:1px; background:var(--line); margin:12px 0; }

    .botones{ display:flex; gap:10px; margin-bottom:10px; }
    .botones button{
      padding:10px 16px; border-radius:10px; border:1px solid var(--line);
      background:#fff; cursor:pointer;
    }

    @media (max-width:980px){
      .g-4{ grid-template-columns:1fr 1fr; }
      .g-3{ grid-template-columns:1fr 1fr; }
    }
    @media (max-width:680px){
      .g-2,.g-3,.g-4{ grid-template-columns:1fr; }
      .checks{ grid-template-columns:1fr; }
    }

    /* ==========================
       BOTONES DE BUSQUEDA / AGENDA / SALIR
    ============================== */
    .search-grid{ grid-template-columns: 1.2fr 1fr; align-items:end; }
    .btn{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      color:white;
      font-size:14px;
    }
    .btn-buscar{ background:#0D47A1; }
    .btn-agenda{ background:#009688; }
    .btn-salir{ background:#009688; }
    .btn-agendar{ background:#009688; }
    .btn-guardar{ background:#009688; }
    .btn-inicio{
      background:#E3E3E3;
      color:#009688;
      font-weight:700;
     }

    /* =====================================================
       EVOLUCIONES (tabla)
    ===================================================== */
    .tabla-evo{
      width:100%;
      border-collapse:collapse;
    }
    .tabla-evo th,.tabla-evo td{
      padding:10px;
      border:1px solid var(--line);
      vertical-align:top;
    }
    .tabla-evo thead tr{
      background:#eef6ff;
    }

    /* =====================================================
       ESTILOS DEL ODONTOGRAMA
    ===================================================== */
    #odontograma-wrapper * {
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }

    #odontograma-wrapper {
      background: #f9f9f9;
      padding: 20px 0 40px;
      margin-top: 30px;
      border-radius: 14px;
    }

    #odontograma-wrapper h1 {
      text-align: center;
      color: #0D47A1;
      margin-bottom: 10px;
    }

    .odontograma {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 40px;
      position: relative;
      z-index: 10;
      overflow-x: visible !important;
      width: max-content;
      margin: 0 auto;

    }

    .seccion { text-align: center; }
    .etiqueta {
      font-weight: bold;
      color: #D0D0D0;
      margin-bottom: 10px;
    }

    .fila {
  display: flex;
  flex-wrap: nowrap;
  justify-content: center;
  gap: var(--tooth-gap);
  min-width: max-content;
        }

    .contenedor-diente {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .diente {
  position: relative;
  width: var(--tooth-size);
  height: var(--tooth-size);
  border-radius: 50%;
  border: 2px solid #ccc;
  background: white;
  overflow: hidden;
}

    .cara {
      position: absolute;
      width: 100%;
      height: 100%;
      cursor: pointer;
      transition: background 0.2s;
      z-index: 1;
    }

    .cara::before,
    .cara::after {
      content: "";
      position: absolute;
      width: 1px;
      height: 100%;
      background: gray;
      left: 50%;
      top: 0;
      z-index: 0;
    }

    .cara::before { transform: rotate(45deg); }
    .cara::after  { transform: rotate(-45deg); }

    .superior { clip-path: polygon(50% 50%, 0% 0%, 100% 0%); }
    .inferior { clip-path: polygon(50% 50%, 0% 100%, 100% 100%); }
    .izquierda { clip-path: polygon(50% 50%, 0% 0%, 0% 100%); }
    .derecha   { clip-path: polygon(50% 50%, 100% 0%, 100% 100%); }

    .centro {
  width: var(--center-size);
  height: var(--center-size);
  border-radius: 50%;
  border: 1.5px solid gray;
  background: white;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 5;
  cursor: pointer;
}

  .numero {
  font-size: var(--num-size);
  color: #555;
  margin-top: 5px;
}

    .popup {
  position: absolute;
  display: none;
  background: #fff;
  border: 1px solid #ccc;
  padding: 10px;
  z-index: 1000002;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  max-height: 250px;
  overflow-y: auto;
}


    .popup div {
      margin: 4px 0;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .color-box {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      display: inline-block;
      margin-right: 4px;
    }

    .leyenda {
      max-width: 1000px;
      margin: 60px auto 20px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .leyenda h2 {
      text-align: center;
      color: #0D47A1;
      margin-bottom: 16px;
    }

    .leyenda-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 8px 16px;
      font-size: 14px;
    }
   /* ====== VOZ POR CAMPO (auto bot√≥n mic al lado) ====== */
.ctrl .input-voz-wrap{
  display:flex;
  gap:10px;
  align-items:center;
}

.btn-mic{
  width:44px;
  min-width:44px;
  height:44px;
  border-radius:10px;
  border:1px solid var(--line);
  background:#fff;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
}

.btn-mic.grabando{
  background:#0D47A1;
  color:#fff;
}
/* ====== VOZ POR CAMPO (auto-inyecta bot√≥n üé§) ====== */
.vwrap{
  position: relative;
  display: flex;
  align-items: center;
  gap: 10px;
}
.vwrap .vfield{
  flex: 1;
}
.vbtn{
  width: 44px;
  min-width: 44px;
  height: 44px;
  border-radius: 10px;
  border: 1px solid var(--line);
  background: #F5F5F5;      /* gris */
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: transparent;        /* por si quedara algo */
}
.vbtn.on{
  background: #9ca3af;      /* gris m√°s oscuro cuando graba */
  border-color: #9ca3af;
  color: transparent;
}

.vbtn.on{
  background: #0D47A1;
  color: #fff;
  border-color: #0D47A1;
}
.vhint{
  margin-top: 6px;
  font-size: 12px;
  color: var(--muted);
}
/* ==========================
   üñ•Ô∏èüîé ODONTOGRAMA FULLSCREEN
========================== */
#odontograma-wrapper.fullscreen{
  position: fixed;
  inset: 0;
  z-index: 99999;
  background: #f9f9f9;
  margin: 0 !important;
  border-radius: 0 !important;
  padding: 10px 10px 25px;
  overflow: auto;
}

/* Cuando est√© en fullscreen, centramos mejor y dejamos scroll horizontal/vertical */
#odontograma-wrapper.fullscreen .odontograma{
  margin-left: 0 !important;
  padding: 10px;
}

/* Bot√≥n flotante para salir (se crea por JS) */
#btnExitOdonFS{
  position: fixed;
  top: 12px;
  right: 12px;
  z-index: 100000;
  border: none;
  border-radius: 12px;
  padding: 10px 14px;
  cursor: pointer;
  background: #0D47A1;
  color: #fff;
  font-weight: 700;
  box-shadow: 0 8px 18px rgba(0,0,0,.18);
}
/* ==========================
   üéØ CENTRAR ODONTOGRAMA EN FULLSCREEN
========================== */
#odontograma-wrapper.fullscreen .odontograma{
  margin-left: auto !important;
  margin-right: auto !important;
  width: max-content;
  min-width: max-content;
}
/* ‚úÖ En fullscreen: solo centramos la caja de gu√≠as */
#odontograma-wrapper.fullscreen #odontograma-guias{
  max-width: none !important;
  width: 1300px !important; /* igual al ancho de la l√≠nea */
  margin: 5px auto 0 !important;
}
  /* ‚úÖ Ajuste fino: tama√±o y separaci√≥n de dientes */
#odontograma-wrapper{
  --tooth-size: 56px;   /* antes 64px */
  --tooth-gap: 10px;    /* antes 16px */
  --num-size: 11px;     /* antes 12px */
  --center-size: 20px;  /* antes 24px */
}
  /* ‚úÖ etiqueta con l√≠nea centrada */
.etiqueta-eje{
  position: relative;
  display: inline-block;
  padding: 0 10px;
}

/* ‚úÖ la l√≠nea vertical azul */
/* Base com√∫n */
.linea-media{
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  width: 3px;
  background: #E3E3E3;
  z-index: 999999;
  pointer-events: none;
}

/* L√≠nea del maxilar superior ‚Üí baja */
.etiqueta-eje .linea-media{
  top: 100%;
  height: 0px;   /* üîß AJUSTE FINO */
}

/* L√≠nea del maxilar inferior ‚Üí sube */
.eje-inferior .linea-media{
  top: auto;
  bottom: 100%;
  height: 0px;   /* üîß MISMA ALTURA */
}

 /* ‚úÖ L√≠nea horizontal en el punto de cruce (al final de la l√≠nea superior) */
.linea-media.linea-cruce::after{
  content:"";
  position:absolute;
  left:50%;
  bottom:0;                  
  transform:translateX(-50%);
  width:1000px;               
  height:2px;
  background:#E3E3E3;
  border-radius:2px;
}

  .extra-etiquetas{
  margin-top: 25px;
  font-size: 15px;
  color: #D0D0D0;
  line-height: 1.1;
  font-weight: 600;
  text-align: center;
}
.extra-etiquetas .lingual{
  margin-top: 5px; /* ‚úÖ separa Lingual hacia abajo */
}
  </style>
</head>

<body>
<div class="container">
  <!-- ==========================
       BUSCAR HISTORIA CL√çNICA EXISTENTE
  ============================== -->
  <section class="card">
   <div class="ctrl full">
   <!--<label>üéôÔ∏è Diligenciamiento por voz</label>
  <div class="inline" style="gap:10px;">
   <button type="button" class="btn btn-agenda" onclick="vozStart()">Iniciar voz</button>
    <button type="button" class="btn btn-buscar" onclick="vozStop()">Detener</button>
    <button type="button" class="btn btn-agenda" onclick="vozModo('focus')">Modo: Dictado por foco</button>
    <button type="button" class="btn btn-agenda" onclick="vozModo('cmd')">Modo: Comandos</button>
  </div>
  <small id="voz_estado" style="color:#6b7a90;">Estado: apagado</small>
  <div id="voz_ultima" style="margin-top:6px; font-size:13px; color:#19324d;"></div>
</div>-->

    <div class="legend">Buscar historia cl√≠nica existente</div>

    <div class="grid g-2 search-grid">
      <div class="ctrl">
        <label for="buscar_cedula">Ingrese n√∫mero de identificaci√≥n</label>
        <input id="buscar_cedula" type="text" placeholder="Ej: 10229566001">
      </div>
      <div class="ctrl">
        <label>&nbsp;</label>
        <button type="button" onclick="buscarHistoria()" class="btn btn-buscar">Buscar</button>
      </div>
      <div class="ctrl">
        <button type="button" onclick="irInicio()" class="btn btn-inicio">
         IR A INICIO
         </button>
       </div>
      <div class="ctrl">
        <button type="button" onclick="cerrarSesion()" class="btn btn-salir">Cerrar sesi√≥n</button>
      </div>
      <div class="ctrl">
        <button type="button" onclick="irAgendamiento()" class="btn btn-agenda">VER AGENDA</button>
      </div>

      <div class="ctrl">
        <button type="button" onclick="enviarAN8N()" class="btn btn-guardar">GUARDAR Y ENVIAR</button>
      </div>
      <div class="ctrl">
        <button type="button" onclick="irAgendar()" class="btn btn-agendar">AGENDAR</button>
      </div>
     
      <div class="ctrl">
        <button type="button" onclick="irPlanTratamiento()" class="btn btn-agenda">PLAN DE TRATAMIENTO</button>
      </div>

    </div>
  </section>

  <h1>Historia Cl√≠nica Odontol√≥gica</h1>

  <!-- ==========================
       DATOS B√ÅSICOS DEL PACIENTE
  ============================== -->
  <section class="card">
    <div class="legend">Datos b√°sicos del paciente</div>
    <div class="grid g-2">

      <div class="ctrl">
        <label for="paciente_nombre">*Nombres y apellidos</label>
        <input id="paciente_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_edad">*Edad</label>
        <input id="paciente_edad" type="number" min="0">
      </div>

      <div class="ctrl full">
        <label>*Identificaci√≥n</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="idtipo" value="CC"> C.C.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="CE"> C.E.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="TI"> T.I.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="RC"> R.C.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="Otro"> Otro</label>
          <span class="hint">Complemente con No. y lugar</span>
        </div>
      </div>

      <div class="ctrl">
        <label for="paciente_numdoc">*No.</label>
        <input
          id="paciente_numdoc"
          type="text"
          inputmode="numeric"
          pattern="[0-9]+"
          required
          oninput="this.value = this.value.replace(/[^0-9]/g, '')"
          placeholder="Solo n√∫meros">
      </div>

      <div class="ctrl">
        <label for="paciente_lugardoc">de</label>
        <input id="paciente_lugardoc" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_nacimiento">*Fecha de nacimiento</label>
        <input id="paciente_nacimiento" type="date">
      </div>

      <div class="ctrl">
        <label for="paciente_lugarnac">Lugar de nacimiento</label>
        <input id="paciente_lugarnac" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_direccion">Direcci√≥n de residencia</label>
        <input id="paciente_direccion" type="text">
      </div>

      <div class="ctrl">
        <label for="Ciudad de Residencia">Ciudad de Residencia</label>
        <input id="Ciudad de Residencia" type="text">
      </div>

      <div class="ctrl">
        <label for="EPS_Paciente">EPS</label>
        <input id="EPS_Paciente" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_ocupacion">Ocupaci√≥n</label>
        <input id="paciente_ocupacion" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_tel">Tel√©fono</label>
        <input id="paciente_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="paciente_ciudad">Ciudad</label>
        <input id="paciente_ciudad" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_cel">Celular</label>
        <input id="paciente_cel" type="tel">
      </div>

      <div class="ctrl">
        <label for="paciente_email">Correo electr√≥nico</label>
        <input id="paciente_email" type="email">
      </div>

      <div class="ctrl">
        <label for="paciente_estadocivil">Estado civil</label>
        <input id="paciente_estadocivil" type="text">
      </div>

      <div class="ctrl">
        <label>Hijos</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="hijos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="hijos" value="No"> No</label>
        </div>
      </div>

    </div>
  </section>

  <!-- ==========================
       DATOS DEL ACUDIENTE
  ============================== -->
  <section class="card">
    <div class="legend">Datos del acudiente</div>

    <div class="grid g-2">

      <div class="ctrl">
        <label for="padre_nombre">Nombre del padre</label>
        <input id="padre_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="madre_nombre">Nombre de la madre</label>
        <input id="madre_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="padre_tel">Tel√©fono padre</label>
        <input id="padre_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="madre_tel">Tel√©fono madre</label>
        <input id="madre_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="padre_eps">E.P.S. padre</label>
        <input id="padre_eps" type="text">
      </div>

      <div class="ctrl">
        <label for="madre_eps">E.P.S. madre</label>
        <input id="madre_eps" type="text">
      </div>

      <div class="ctrl">
        <label for="padre_tipo">Beneficiario / Cotizante (padre)</label>
        <select id="padre_tipo" name="padre_tipo">
          <option value="">Seleccione</option>
          <option value="Beneficiario">Beneficiario</option>
          <option value="Cotizante">Cotizante</option>
        </select>
      </div>

      <div class="ctrl">
        <label for="madre_tipo">Beneficiario / Cotizante (madre)</label>
        <select id="madre_tipo" name="madre_tipo">
          <option value="">Seleccione</option>
          <option value="Beneficiario">Beneficiario</option>
          <option value="Cotizante">Cotizante</option>
        </select>
      </div>

    </div>
  </section>

  <!-- ==========================
       EMERGENCIA
  ============================== -->
  <section class="card">
    <div class="legend">En caso de emergencia avisar a</div>

    <div class="grid g-2">

      <div class="ctrl">
        <label for="emergencia_nombre">Nombres y apellidos</label>
        <input id="emergencia_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="emergencia_parentesco">Parentesco</label>
        <input id="emergencia_parentesco" type="text">
      </div>

      <div class="ctrl">
        <label for="emergencia_tel">Tel√©fono</label>
        <input id="emergencia_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="emergencia_cel">Celular</label>
        <input id="emergencia_cel" type="tel">
      </div>

    </div>
  </section>

  <!-- ==========================
       HISTORIA M√âDICA
  ============================== -->
  <section class="card">
    <div class="legend">Historia m√©dica</div>

    <div class="grid g-2">
      <div class="ctrl">
        <label>¬øEnfermedad grave actualmente o previa?</label>
        <div class="inline">
          <label class="chip">
            <input type="checkbox" name="grave" value="Si"> S√≠
          </label>

          <label class="chip">
            <input type="checkbox" name="grave" value="No"> No
          </label>
        </div>
      </div>

      <div class="ctrl">
        <label for="grave_cual">¬øCu√°l?</label>
        <input id="grave_cual" type="text">
      </div>
    </div>

    <div class="ctrl">
      <label>Condiciones (marque las que apliquen)</label>

      <div class="checks">
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones card√≠acas">Alteraciones card√≠acas</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Asma">Asma</label>
        <label class="check"><input type="checkbox" name="condiciones" value="C√°ncer">C√°ncer</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones vasculares o circulatorias">Alteraciones vasculares o circulatorias</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones psicol√≥gicas o psiqui√°tricas">Alteraciones psicol√≥gicas o psiqui√°tricas</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Enfisema">Enfisema</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Artritis">Artritis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Diabetes">Diabetes</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hepatitis">Hepatitis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Desmayos o convulsiones">Desmayos o convulsiones</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hospitalizaciones">Hospitalizaciones</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hipotiroidismo">Hipotiroidismo</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Fiebre reum√°tica">Fiebre reum√°tica</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hipertiroidismos o hiperparatiroidismo">Hipertiroidismos o hiperparatiroidismo</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Lupus">Lupus</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hipertensi√≥n">Hipertensi√≥n</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Leucemia">Leucemia</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Sinusitis">Sinusitis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Irradiaciones">Irradiaciones</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Problemas renales">Problemas renales</label>
        <label class="check"><input type="checkbox" name="condiciones" value="VIH (Sida)">VIH (Sida)</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Osteoporosis">Osteoporosis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Trauma">Trauma</label>

        <div class="check" style="display:block;">
          <div class="grid g-2">
            <label class="inline">
              <input type="checkbox" name="condiciones" value="Otra">
              Otra
            </label>
            <input id="otra_cual" type="text" name="otra_cual" placeholder="¬øCu√°l?">
          </div>
        </div>

        <label class="check"><input type="checkbox" name="condiciones" value="Tuberculosis">Tuberculosis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones nutricionales">Alteraciones nutricionales</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones del h√≠gado">Alteraciones del h√≠gado</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Anemia">Anemia</label>
      </div>
    </div>

    <div class="rowline"></div>

    <div class="grid g-3">
      <div class="ctrl">
        <label>¬øProblemas de coagulaci√≥n?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="coagulacion" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="coagulacion" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øToma anticoagulantes?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="anticoagulantes" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="anticoagulantes" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øToma medicamentos?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="toma_medicamentos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="toma_medicamentos" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label for="medicamentos_cuales">¬øCu√°les?</label>
        <input id="medicamentos_cuales" type="text">
      </div>

      <div class="ctrl">
        <label for="med_dosis">Dosis y frecuencia</label>
        <input id="med_dosis" type="text">
      </div>

      <div class="ctrl">
        <label for="alergia_meds">Alergia a medicamentos</label>
        <input id="alergia_meds" type="text">
      </div>
    </div>

    <div class="rowline"></div>

    <div class="grid g-2">
      <div class="ctrl">
        <label>¬øToma bebidas alcoh√≥licas?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="alcohol" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="alcohol" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øFuma?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="fuma" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="fuma" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øConsume drogas psicoactivas?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="drogas" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="drogas" value="No"> No</label>
        </div>
      </div>
    </div>
  </section>

  <!-- ==========================
       S√ìLO MUJERES
  ============================== -->
  <section class="card">
    <div class="legend">S√≥lo para mujeres</div>

    <div class="grid g-3">
      <div class="ctrl">
        <label>¬øHa tenido embarazos y partos?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="embarazos_partos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="embarazos_partos" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label for="numero_hijos">No. de hijos</label>
        <input id="numero_hijos" type="number" min="0">
      </div>

      <div class="ctrl">
        <label>¬øActualmente est√° embarazada?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="embarazada" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="embarazada" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label for="tiempo_embarazo">Tiempo</label>
        <input id="tiempo_embarazo" type="text">
      </div>

      <div class="ctrl">
        <label>¬øToma anticonceptivos?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="anticonceptivos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="anticonceptivos" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øHisterectom√≠a o menopausia?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="histerectomia_menopausia" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="histerectomia_menopausia" value="No"> No</label>
        </div>
      </div>
    </div>
  </section>

  <!-- ==========================
       HISTORIA ODONTOL√ìGICA
  ============================== -->
  <section class="card">
    <div class="legend">Historia odontol√≥gica</div>

    <div class="grid g-2">
      <div class="ctrl full">
        <label for="motivo_consulta">Motivo de consulta odontol√≥gica</label>
        <input id="motivo_consulta" type="text">
      </div>

      <div class="ctrl">
        <label>¬øPresenta dolor en‚Ä¶?</label>
        <div class="inline">
          <label class="chip">boca <input type="checkbox" name="dolor[]" value="boca"></label>
          <label class="chip">cara <input type="checkbox" name="dolor[]" value="cara"></label>
          <label class="chip">cuello <input type="checkbox" name="dolor[]" value="cuello"></label>
        </div>
      </div>

      <div class="ctrl full">
        <label>Tratamientos recibidos</label>
        <div class="checks">
          <label class="check"><input type="checkbox" name="tratamientos" value="Ortodoncia"> Ortodoncia</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Periodoncia"> Periodoncia</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Endodoncia"> Endodoncia</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Cirug√≠a maxilofacial"> Cirug√≠a maxilofacial</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Implantes dentales"> Implantes dentales</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Restauraci√≥n oral"> Restauraci√≥n oral</label>
        </div>
      </div>

      <p class="hint full">Abajo est√° el odontograma para marcar preexistencias.</p>
    </div>
  </section>

  <!-- ==========================
       ‚úÖ EVOLUCIONES
  ============================== -->
  <section class="card">
    <div class="legend">Evoluciones (procedimientos realizados)</div>

    <div class="grid g-3">
      <div class="ctrl">
        <label for="evo_fecha">Fecha</label>
        <input id="evo_fecha" type="date" disabled>
      </div>

      <div class="ctrl">
        <label for="evo_hora">Hora</label>
        <input id="evo_hora" type="time" readonly>
      </div>

<div class="ctrl">
  <label for="evo_profesional">Profesional</label>

  <div class="inline" style="gap:10px;">
    <input
      id="evo_profesional"
      type="text"
      list="profesionales_list"
      placeholder="Buscar o escribir profesional..."
      autocomplete="off"
      style="flex:1;"
    />

    <button
      type="button"
      onclick="agregarProfesionalDesdeCampo()"
      class="btn btn-agenda"
      style="width:auto; padding:10px 14px;"
      title="Agregar el texto actual al listado"
    >
      + Agregar
    </button>
  </div>

  <datalist id="profesionales_list"></datalist>
</div>


<div class="ctrl">
  <label for="evo_tipo">Procedimiento</label>

  <div class="inline" style="gap:10px;">
    <!-- ‚úÖ Input con b√∫squeda (datalist) -->
    <input
      id="evo_tipo"
      type="text"
      list="procedimientos_list"
      placeholder="Buscar o escribir procedimiento..."
      autocomplete="off"
      style="flex:1;"
    />

    <!-- ‚úÖ Bot√≥n para agregar si no existe -->
    <button
      type="button"
      onclick="agregarProcedimientoDesdeCampo()"
      class="btn btn-agenda"
      style="width:auto; padding:10px 14px;"
      title="Agregar el texto actual al listado"
    >
      + Agregar
    </button>
  </div>

  <!-- ‚úÖ Datalist (desplegable con b√∫squeda) -->
  <datalist id="procedimientos_list"></datalist>
</div>


      <div class="ctrl full">
        <label for="evo_detalle">Detalle / Observaciones</label>
        <textarea id="evo_detalle" placeholder="Descripci√≥n del procedimiento, piezas intervenidas, materiales, etc."></textarea>
      </div>
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button type="button" onclick="agregarEvolucion()" class="btn btn-agenda" style="max-width:260px;">
        Agregar evoluci√≥n
      </button>

      <button type="button" onclick="limpiarEvolucionForm()" class="btn btn-buscar" style="max-width:260px;">
        Limpiar
      </button>
    </div>

    <div class="rowline"></div>

    <div style="overflow:auto;">
      <table class="tabla-evo">
        <thead>
          <tr>
            <th>ID Evoluci√≥n</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Profesional</th>
            <th>Procedimiento</th>
            <th>Detalle</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla_evoluciones"></tbody>
      </table>
    </div>
  </section>

  <!-- ==========================
       ODONTOGRAMA COMPLETO
  ============================== -->
  <div id="odontograma-wrapper">
    <h1>Odontograma Internacional FDI</h1>
    <div id="odontograma-guias" style="position:relative; width:100%; max-width:900px; margin:5px auto 0; height:20px;">
      <div style="position:absolute; top:70px; left:-130px; color:#D0D0D0; font-weight:bold;">Distal1</div>
      <div style="position:absolute; top:70px; right:-130px; color:#D0D0D0; font-weight:bold;">Distal2</div>
      <div style="position:absolute; top:230px; left:-130px; color:#D0D0D0; font-weight:bold;">Distal4</div>
      <div style="position:absolute; top:230px; right:-130px; color:#D0D0D0; font-weight:bold;">Distal3</div>
    </div>

   <div class="odontograma">

  <!-- MAXILAR SUPERIOR -->
  <div class="seccion">
    <div class="etiqueta etiqueta-eje">
      Vestibular---------------------Maxilar superior--------------------Vestibular
      <span class="linea-media linea-cruce"></span>
    </div>
    <div class="fila" id="fila-superior"></div>
  </div>

  <!-- MAXILAR INFERIOR -->
<div class="seccion">
  <div class="fila" id="fila-inferior"></div>

    <div class="etiqueta etiqueta-eje eje-inferior">
    Vestibular--------------------Maxilar inferior--------------------Vestibular
    <span class="linea-media"></span>
  </div>
</div>

</div>

    <div class="leyenda">
      <h2>Leyenda de Preexistencias</h2>
      <div class="leyenda-grid" id="grid-leyenda"></div>
    </div>

    <div style="text-align:center; margin-top:40px;">
      <button onclick="mostrarReporte()" style="padding:10px 20px; background:#0D47A1; color:white; border:none; border-radius:6px; cursor:pointer;">
        Generar reporte de preexistencias
      </button>

      <div style="text-align:center; margin-top:20px;">
        <button onclick="enviarAN8N()" style="padding:10px 20px; background:#009688; color:white; border:none; border-radius:6px; cursor:pointer;">
          Guardar y enviar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- üì§ FORMULARIO OCULTO PARA N8N -->
<form id="formN8N"
  action="https://ftth-n8n2.pzveh5.easypanel.host/webhook/62804cbf-8f21-453b-823e-e5c1b94f31c8"
  method="POST"
  style="display:none;">

  <input type="hidden" id="dataN8N" name="data">
  <input type="hidden" id="usuarioN8N" name="usuario_logueado">
</form>

<script>
  // ==============================
  // CERRAR SESI√ìN + AUTO CIERRE POR INACTIVIDAD (5 min)
  // ==============================
  const LOGIN_URL = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
  const INACTIVIDAD_MS = 5 * 60 * 1000; // 5 minutos

  async function cerrarSesion(motivo = "") {
    try {
      if (window.supabase?.auth?.signOut) {
        await window.supabase.auth.signOut();
      }
    } catch (e) {
      console.warn("Error cerrando sesi√≥n:", e);
    }

    try { localStorage.removeItem("usuario_logueado"); } catch(e) {}

    if (motivo) alert(motivo);
    window.location.href = LOGIN_URL;
  }

  let _timerInactividad = null;
  function _reiniciarTimerInactividad() {
    if (_timerInactividad) clearTimeout(_timerInactividad);
    _timerInactividad = setTimeout(() => {
      cerrarSesion("Tu sesi√≥n se cerr√≥ por inactividad (5 minutos).");
    }, INACTIVIDAD_MS);
  }

  ["click","mousemove","keydown","scroll","touchstart"].forEach(evt => {
    window.addEventListener(evt, _reiniciarTimerInactividad, { passive: true });
  });

  _reiniciarTimerInactividad();

  // ==============================
  // LINKS DE AGENDA
  // ==============================
  const URL_AGENDAMIENTO = "https://calendar.google.com/calendar/u/0?cid=ZHJhbGVpZGlzaWx2YUBnbWFpbC5jb20";
  const URL_AGENDAR = "https://calendar.app.google/kbWJdv1f1TZd9bS36";
  const URL_PLAN_TRATAMIENTO = "https://cacg1022.github.io/ODONTOLOGIA/plandetratamiento";
  const URL_INICIO = "https://cacg1022.github.io/ODONTOLOGIA/index.html";

  function irInicio() {
  window.location.href = URL_INICIO;
  }

  function irAgendamiento() { window.open(URL_AGENDAMIENTO, "_blank"); }
  function irAgendar() { window.open(URL_AGENDAR, "_blank"); }

  // ‚úÖ Plan de tratamiento: abre la p√°gina y env√≠a la c√©dula del paciente
  function irPlanTratamiento() {
    const cedula = (
      document.getElementById("paciente_numdoc")?.value ||
      document.getElementById("buscar_cedula")?.value ||
      ""
    ).trim();

    if (!cedula) {
      alert("‚ö†Ô∏è Primero ingresa o busca la c√©dula del paciente para abrir el plan de tratamiento.");
      return;
    }

    try { localStorage.setItem("cedula_paciente_plan", cedula); } catch(e) {}

    const url = URL_PLAN_TRATAMIENTO + (URL_PLAN_TRATAMIENTO.includes("?") ? "&" : "?") + "cedula=" + encodeURIComponent(cedula);
    window.open(url, "_blank");
  }

  // ==============================
  // ‚úÖ EVOLUCIONES
  // ==============================
  let evoluciones = [];

  function _uuidFallback() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }
  function generarEvolucionId() {
    try {
      return (crypto && crypto.randomUUID) ? crypto.randomUUID() : _uuidFallback();
    } catch (e) {
      return _uuidFallback();
    }
  }

  function _hoyISO() {
    const d = new Date();
    return d.toISOString().slice(0, 10);
  }
  function _horaHHMM() {
    const d = new Date();
    return String(d.getHours()).padStart(2, "0") + ":" + String(d.getMinutes()).padStart(2, "0");
  }

  function limpiarEvolucionForm() {
    const f = document.getElementById("evo_fecha");
    const h = document.getElementById("evo_hora");
    const p = document.getElementById("evo_profesional");
    const t = document.getElementById("evo_tipo");
    const d = document.getElementById("evo_detalle");

    if (f) f.value = _hoyISO();
    if (h) h.value = _horaHHMM();
    if (p) p.value = "";
    if (t) t.value = "";
    if (d) d.value = "";
  }

async function agregarEvolucion() {
  const fecha = (document.getElementById("evo_fecha").value || _hoyISO()).trim();
  const hora = (document.getElementById("evo_hora").value || _horaHHMM()).trim();
  const profesional = document.getElementById("evo_profesional").value.trim();
  const tipo = document.getElementById("evo_tipo").value.trim();
  const detalle = document.getElementById("evo_detalle").value.trim();

  if (!profesional) { alert("‚ö†Ô∏è Debes ingresar el nombre del profesional."); return; }
  if (!tipo) { alert("‚ö†Ô∏è Debes ingresar el procedimiento."); return; }

  const usuario = localStorage.getItem("usuario_logueado") || "desconocido";
  const cedula = (
    document.getElementById("paciente_numdoc")?.value ||
    document.getElementById("buscar_cedula")?.value ||
    ""
  ).trim();

  if (!cedula) {
    alert("‚ö†Ô∏è Primero debes tener la c√©dula del paciente (buscar o diligenciar identificaci√≥n).");
    return;
  }

  const item = {
    id: generarEvolucionId(),
    fecha,
    hora,
    profesional,
    procedimiento: tipo,
    detalle,
    cedula_paciente: cedula,
    usuario,
    ts: new Date().toISOString()
  };

  // ‚úÖ 1) Guarda local (no se pierde)
  evoluciones.unshift(item);
  renderEvoluciones();
  limpiarEvolucionForm();

  // ‚úÖ 2) Enviar a n8n (SIN recargar, SIN abrir otra pesta√±a)
  try {
    const url = "https://ftth-n8n2.pzveh5.easypanel.host/webhook/569051e4-4bdf-44e9-b0d3-34694d6077e9";

    const payload = {
      evento: "agregar_evolucion",
      cedula: cedula,
      evolucion: item,
      fecha_envio: new Date().toISOString(),
      usuario_logueado: usuario
    };

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!resp.ok) throw new Error("HTTP " + resp.status);

    console.log("‚úÖ Evoluci√≥n enviada a n8n");
  } catch (err) {
    console.warn("‚ö†Ô∏è Evoluci√≥n guardada pero NO se pudo enviar a n8n:", err);
    alert("‚ö†Ô∏è Evoluci√≥n guardada, pero no se pudo enviar a n8n. Verifica conexi√≥n o webhook.");
  }
}

  function eliminarEvolucion(idx) {
    evoluciones.splice(idx, 1);
    renderEvoluciones();
  }

  function _soloFechaYYYYMMDD(valor) {
    if (!valor) return "";
    if (typeof valor === "string" && valor.includes("T")) return valor.split("T")[0];
    return String(valor);
  }

  function _soloHoraHHMM(valor) {
    if (!valor) return "";
    const s = String(valor);
    if (/^\d{2}:\d{2}:\d{2}/.test(s)) return s.slice(0,5);
    return s;
  }

  function renderEvoluciones() {
  const tbody = document.getElementById("tabla_evoluciones");
  if (!tbody) return;

  tbody.innerHTML = "";

  evoluciones.forEach((evo, idx) => {
    const tr = document.createElement("tr");

    const idEvo = evo.id_evolucion ?? evo["id-evolucion"] ?? evo.id ?? "";
    const fecha = _soloFechaYYYYMMDD(evo.fecha ?? evo.evo_fecha);
    const hora  = _soloHoraHHMM(evo.hora ?? evo.evo_hora);
    const profesional = evo.profesional ?? evo.evo_profesional ?? "";
    const procedimiento = evo.procedimiento ?? evo.evo_tipo ?? "";
    const detalle = evo.detalle ?? evo.evo_detalle ?? "";

    // ‚úÖ Estado de consentimiento (simple: si existe para esa evoluci√≥n)
    const tieneConsent = Array.isArray(consentimientos) && consentimientos.some(c => c.evolucion_id === idEvo);

    tr.innerHTML = `
      <td style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;">
        ${idEvo}
      </td>
      <td>${fecha}</td>
      <td>${hora}</td>
      <td>${String(profesional).toUpperCase()}</td>
      <td>${String(procedimiento).toUpperCase()}</td>
      <td style="white-space:pre-wrap;">${detalle}</td>
      <td style="display:flex; gap:8px; flex-wrap:wrap;">
        <button type="button" class="btn ${tieneConsent ? "btn-agenda" : "btn-buscar"}"
          style="padding:8px 10px; width:auto;"
          onclick="abrirConsentimiento('${idEvo}')">
          ${tieneConsent ? "Consentimiento ‚úÖ" : "Consentimiento"}
        </button>

        <button type="button" class="btn btn-buscar"
          style="padding:8px 10px; width:auto;"
          onclick="eliminarEvolucion(${idx})">
          Eliminar
        </button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}


  function normalizarEvolucionesDeWebhook(data) {
    let raw = data?.evoluciones;

    if (raw && !Array.isArray(raw) && typeof raw === "object" && Array.isArray(raw.evoluciones)) {
      raw = raw.evoluciones;
    }

    if (typeof raw === "string") {
      try { raw = JSON.parse(raw); } catch(e) { raw = []; }
    }

    if (!Array.isArray(raw)) raw = [];

    return raw.map((e) => ({
      id: e.id_evolucion ?? e["id-evolucion"] ?? e.id ?? generarEvolucionId(),
      fecha: _soloFechaYYYYMMDD(e.fecha ?? e.evo_fecha),
      hora: _soloHoraHHMM(e.hora ?? e.evo_hora),
      profesional: e.profesional ?? e.evo_profesional ?? "",
      procedimiento: e.procedimiento ?? e.evo_tipo ?? "",
      detalle: e.detalle ?? e.evo_detalle ?? "",
      created_at: e.created_at ?? null,
      ts: e.ts ?? e.created_at ?? new Date().toISOString()
    }));
  }

  document.addEventListener("DOMContentLoaded", () => {
    if (document.getElementById("evo_fecha")) {
      limpiarEvolucionForm();
      renderEvoluciones();
    }
  });

  // ==============================
  // ODONTOGRAMA
  // ==============================
  const preexistencias = {
    Caries: 'red',
    Corona: 'blue',
    Endodoncia: '#005E94',
    Obturaci√≥n: 'green',
    Fractura: 'orange',
    Ausente: '#c3c5c7',
    Implante: '#7eff42',
    "Extracci√≥n indicada": '#333',
    Exodoncia: '#ff38ef',
    P√≥ntico: 'cyan',
    "Movilidad dental": 'pink',
    Retenido: 'purple',
    "Pr√≥tesis fija": '#880E4F',
    "Pr√≥tesis removible": '#42ffc6',
    "Pr√≥tesis total": '#fff642',
    Amalgama: '#42b7ff',
    Resina: '#FBC02D',
    Sano: '#8BC34A'
  };

  let reporte = {};

  const contenedorLeyenda = document.getElementById('grid-leyenda');
  Object.entries(preexistencias).forEach(([nombre, color]) => {
    const item = document.createElement('div');
    item.innerHTML = `<span class="color-box" style="background:${color}; border:1px solid #444;"></span>${nombre}`;
    contenedorLeyenda.appendChild(item);
  });

  const dientesSuperior = [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28];
  const dientesInferior = [48,47,46,45,44,43,42,41,31,32,33,34,35,36,37,38];

  function crearDiente(numero, contenedor) {
    const contenedorDiente = document.createElement('div');
    contenedorDiente.className = 'contenedor-diente';

    const diente = document.createElement('div');
    diente.className = 'diente';
    diente.dataset.numero = numero;

    ['superior','inferior','izquierda','derecha'].forEach(region => {
      const div = document.createElement('div');
      div.className = `cara ${region}`;
      div.dataset.region = region;
      div.onclick = (event) => mostrarPopup(event, div);
      diente.appendChild(div);
    });

    const centro = document.createElement('div');
    centro.className = 'centro';
    centro.dataset.region = 'centro';
    centro.onclick = (event) => mostrarPopup(event, centro);
    diente.appendChild(centro);

    const label = document.createElement('div');
    label.className = 'numero';
    label.textContent = numero;

    contenedorDiente.appendChild(diente);
    contenedorDiente.appendChild(label);

    if (numero === 14 || numero === 24) {
      const extra = document.createElement("div");
      extra.className = "extra-etiquetas";
      extra.innerHTML = `
      <div>Palatino</div>
      <div class="lingual">Lingual</div>
    `;
      contenedorDiente.appendChild(extra);
    }

    contenedor.appendChild(contenedorDiente);
  }

  function mostrarPopup(event, elemento) {
    event.stopPropagation();
    document.querySelectorAll('.popup').forEach(p => p.remove());

    const menu = document.createElement('div');
    menu.className = 'popup';

    const limpiar = document.createElement('div');
    limpiar.innerHTML = `<span class='color-box' style="background:white; border:1px solid #444;"></span> Limpiar`;

    limpiar.onclick = () => {
      elemento.style.background = "white";

      const dienteNumero = elemento.parentElement.dataset.numero;
      const cara = elemento.dataset.region;

      if (reporte[dienteNumero] && reporte[dienteNumero][cara]) {
        delete reporte[dienteNumero][cara];
      }

      if (reporte[dienteNumero] && Object.keys(reporte[dienteNumero]).length === 0) {
        delete reporte[dienteNumero];
      }

      menu.remove();
    };

    menu.appendChild(limpiar);

    Object.entries(preexistencias).forEach(([nombre, color]) => {
      const item = document.createElement('div');
      item.innerHTML = `<span class='color-box' style="background:${color}; border:1px solid #444;"></span>${nombre}`;

      item.onclick = () => {
        const dienteNumero = elemento.parentElement.dataset.numero;
        const cara = elemento.dataset.region;

        if (!reporte[dienteNumero]) reporte[dienteNumero] = {};

        if (nombre === "Sano" || nombre === "Ausente") {
          elemento.parentElement.querySelectorAll(".cara, .centro")
            .forEach(c => c.style.background = preexistencias[nombre]);

          ["superior","inferior","izquierda","derecha","centro"].forEach(c => {
            reporte[dienteNumero][c] = nombre;
          });
        } else {
          elemento.style.background = color;
          reporte[dienteNumero][cara] = nombre;
        }

        menu.remove();
      };

      menu.appendChild(item);
    });

    document.body.appendChild(menu);
    menu.style.left = `${event.pageX + 5}px`;
    menu.style.top  = `${event.pageY + 5}px`;
    menu.style.display = 'block';
  }

  const filaSuperior = document.getElementById('fila-superior');
  dientesSuperior.forEach(num => crearDiente(num, filaSuperior));

  const filaInferior = document.getElementById('fila-inferior');
  dientesInferior.forEach(num => crearDiente(num, filaInferior));

  function ajustarLineaMedia() {
    const topEtiqueta = document.querySelector(".seccion .etiqueta-eje:not(.eje-inferior)");
    const topLinea = topEtiqueta?.querySelector(".linea-media");
    const bottomEtiqueta = document.querySelector(".etiqueta-eje.eje-inferior");
    const bottomLinea = bottomEtiqueta?.querySelector(".linea-media");

    if (!topEtiqueta || !topLinea || !bottomEtiqueta || !bottomLinea) return;

    const rTop = topEtiqueta.getBoundingClientRect();
    const rBottom = bottomEtiqueta.getBoundingClientRect();

    const dist = rBottom.top - rTop.bottom;
    const h = Math.max(0, Math.round(dist / 2));

    topLinea.style.height = h + "px";
    bottomLinea.style.height = h + "px";
  }

  window.addEventListener("load", ajustarLineaMedia);
  window.addEventListener("resize", ajustarLineaMedia);

  document.addEventListener("click", (e) => {
    if (e.target?.id === "btnExitOdonFS") setTimeout(ajustarLineaMedia, 50);
  });

  document.body.addEventListener('click', () => {
    document.querySelectorAll('.popup').forEach(p => p.remove());
  });

  function obtenerRegion(diente, cara) {
    diente = parseInt(diente);
    if (cara === "centro") return "Oclusal";

    if (diente >= 11 && diente <= 28) {
      if (cara === "superior") return "Vestibular";
      if (cara === "inferior") return "Palatino";
    }

    if (diente >= 31 && diente <= 48) {
      if (cara === "superior") return "Lingual";
      if (cara === "inferior") return "Vestibular";
    }

    const derechaEsMesial = (
      (diente >= 11 && diente <= 18) ||
      (diente >= 41 && diente <= 48)
    );

    if (cara === "derecha") return derechaEsMesial ? "Mesial" : "Distal";
    if (cara === "izquierda") return derechaEsMesial ? "Distal" : "Mesial";
    return null;
  }

  function mostrarReporte() {
    let html = `
      <h2>Reporte de Preexistencias</h2>
      <table border="1" cellpadding="6" style="border-collapse:collapse; margin:20px auto; width:95%; text-align:center;">
        <tr style="background:#eee; font-weight:bold;">
          <th>Diente</th>
          <th>Mesial</th>
          <th>Distal</th>
          <th>Oclusal</th>
          <th>Vestibular</th>
          <th>Lingual</th>
          <th>Palatino</th>
        </tr>
    `;

    Object.entries(reporte).forEach(([diente, caras]) => {
      let fila = { Mesial:"", Distal:"", Oclusal:"", Vestibular:"", Lingual:"", Palatino:"" };

      Object.entries(caras).forEach(([cara, preexistencia]) => {
        let region = obtenerRegion(diente, cara);
        if (region) fila[region] = preexistencia.toUpperCase();
      });

      html += `
        <tr>
          <td>${diente}</td>
          <td>${fila.Mesial}</td>
          <td>${fila.Distal}</td>
          <td>${fila.Oclusal}</td>
          <td>${fila.Vestibular}</td>
          <td>${fila.Lingual}</td>
          <td>${fila.Palatino}</td>
        </tr>
      `;
    });

    html += "</table>";

    const win = window.open("", "_blank");
    win.document.write(html);
    win.document.close();
  }

  function obtenerDatosHistoriaClinica() {
    const data = {};
    document.querySelectorAll(".container input, .container textarea, .container select")
      .forEach(campo => {
        const nombre = campo.id || campo.name;
        if (!nombre) return;

        if (campo.type === "checkbox") {
          if (!data[nombre]) data[nombre] = [];
          if (campo.checked) data[nombre].push(campo.value || true);
        } else {
          data[nombre] = campo.value;
        }
      });
    return data;
  }

  function validarCamposObligatorios() {
    const errores = [];

    const nombre = document.getElementById("paciente_nombre").value.trim();
    if (!nombre) errores.push("Nombres y apellidos");

    const edad = document.getElementById("paciente_edad").value;
    if (!edad) errores.push("Edad");

    const tipoID = document.querySelectorAll("input[name='idtipo']:checked");
    if (tipoID.length === 0) errores.push("Tipo de identificaci√≥n");

    const numDoc = document.getElementById("paciente_numdoc").value.trim();
    if (!numDoc) errores.push("N√∫mero de identificaci√≥n");

    const fechaNac = document.getElementById("paciente_nacimiento").value;
    if (!fechaNac) errores.push("Fecha de nacimiento");

    if (!reporte || Object.keys(reporte).length === 0) {
      errores.push("Odontograma (debe marcar al menos un diente)");
    }

    if (errores.length > 0) {
      alert(
        "‚ö†Ô∏è No se puede enviar la historia cl√≠nica.\n\n" +
        "Faltan los siguientes campos obligatorios:\n\n" +
        errores.map(e => "‚Ä¢ " + e).join("\n")
      );
      return false;
    }

    return true;
  }

  function enviarAN8N() {
    if (!validarCamposObligatorios()) return;

    const todosLosDientes = [
      18,17,16,15,14,13,12,11,
      21,22,23,24,25,26,27,28,
      48,47,46,45,44,43,42,41,
      31,32,33,34,35,36,37,38
    ];

    const odontogramaCompleto = {};
    todosLosDientes.forEach(num => {
      odontogramaCompleto[num] = { Mesial:"", Distal:"", Oclusal:"", Vestibular:"", Lingual:"", Palatino:"" };
    });

    Object.entries(reporte).forEach(([diente, caras]) => {
      Object.entries(caras).forEach(([cara, preexistencia]) => {
        const region = obtenerRegion(diente, cara);
        if (region) odontogramaCompleto[diente][region] = preexistencia.toUpperCase();
      });
    });

    const datosHistoria = obtenerDatosHistoriaClinica();
    const usuario = localStorage.getItem("usuario_logueado") || "desconocido";

    document.getElementById("usuarioN8N").value = usuario;

    const payload = {
  historia_clinica: datosHistoria,
  odontograma: odontogramaCompleto,
  evoluciones: evoluciones,
  consentimientos: consentimientos, // ‚úÖ NUEVO
  fecha_envio: new Date().toISOString(),
  usuario_logueado: usuario
};


    document.getElementById("dataN8N").value = JSON.stringify(payload);
    document.getElementById("formN8N").submit();

    alert("Informaci√≥n enviada correctamente a N8N");
  }

function normalizarConsentimientosDeWebhook(data) {
  let raw = data?.consentimientos;

  // Caso: vienen dentro de data.consentimientos.consentimientos
  if (raw && !Array.isArray(raw) && typeof raw === "object" && Array.isArray(raw.consentimientos)) {
    raw = raw.consentimientos;
  }

  // Caso: string JSON
  if (typeof raw === "string") {
    try { raw = JSON.parse(raw); } catch (e) { raw = []; }
  }

  if (!Array.isArray(raw)) raw = [];

  // Normaliza campos y nombres
  return raw.map(c => ({
    cedula_paciente: c.cedula_paciente ?? c.paciente_doc ?? c.doc ?? "",
    paciente_nombre: c.paciente_nombre ?? c.paciente ?? "",
    evolucion_id: c.evolucion_id ?? c.evolucionId ?? c.id_evolucion ?? c.idEvolucion ?? "",
    procedimiento: c.procedimiento ?? "",
    profesional: c.profesional ?? "",
    template: c.template ?? c.template_key ?? c.templateKey ?? "AUTO",
    texto: c.texto ?? c.consent_texto ?? "",
    firma_paciente: c.firma_paciente ?? c.firmaPaciente ?? c.firma_pac ?? c.firmaPacienteBase64 ?? c.firmaPacienteData ?? "",
    firma_profesional: c.firma_profesional ?? c.firmaProfesional ?? c.firma_prof ?? c.firmaProfesionalBase64 ?? c.firmaProfesionalData ?? "",
    firmado_en: c.firmado_en ?? c.firmadoEn ?? null,
    creado_en: c.creado_en ?? c.creadoEn ?? null,
    creado_por: c.creado_por ?? c.creadoPor ?? null,
    hash_documento: c.hash_documento ?? c.hash ?? null,
    pdf_path: c.pdf_path ?? null
  })).filter(x => String(x.evolucion_id || "").trim() !== "");
}

/* ‚úÖ‚úÖ FIX FIRMA: normalizador robusto (soporta json string, objeto, comillas, escapes, urlencoded, base64 sin prefijo) */
function _normalizarDataURLFirma(valor) {
  if (valor == null) return "";

  // Si viene como objeto
  if (typeof valor === "object") {
    valor = valor.data || valor.base64 || valor.firma || valor.value || "";
  }

  let v = String(valor).trim();
  if (!v) return "";

  // Si viene como string JSON: {"data":"..."}
  if ((v.startsWith("{") && v.endsWith("}")) || (v.startsWith("[") && v.endsWith("]"))) {
    try {
      const obj = JSON.parse(v);
      if (obj && typeof obj === "object") {
        v = String(
          obj.data ||
          obj.base64 ||
          obj.firma ||
          obj.value ||
          (Array.isArray(obj) ? obj[0] : "") ||
          ""
        ).trim();
      }
    } catch(e) {}
  }

  // Quitar comillas envolventes
  v = v.replace(/^"+|"+$/g, "").trim();

  // Quitar escapes comunes
  v = v.replace(/\\n/g, "").replace(/\\"/g, '"').trim();

  // Si viene URL-encoded
  try { v = decodeURIComponent(v); } catch(e) {}

  // Arregla base64 da√±ado por espacios
  v = v.replace(/\s/g, "+");

  // Si ya es dataURL (png/jpg/jpeg/webp)
  if (v.startsWith("data:image/")) return v;

  // Si viene solo base64 sin prefijo
  if (/^[A-Za-z0-9+/]+=*$/.test(v) && v.length > 100) {
    return "data:image/png;base64," + v;
  }

  // Si viene como "image/png;base64,...." (sin data:)
  if (v.startsWith("image/") && v.includes("base64,")) {
    return "data:" + v;
  }

  return "";
}


  
  // ==============================
  // ‚úÖ BUSCAR HISTORIA
  // ==============================
  async function buscarHistoria() {
    const cedula = document.getElementById("buscar_cedula").value.trim();

    if (!cedula) {
      alert("Ingrese una c√©dula");
      return;
    }

    const url = `https://ftth-n8n2.pzveh5.easypanel.host/webhook/62804cbf-8f21-453b-823e-e5c1b94f31c8?cedula=${cedula}`;

    try {
      const resp = await fetch(url);
      const data = await resp.json();

      if (!data.existe) {
        evoluciones = [];
        renderEvoluciones();
        alert("No existe historia cl√≠nica para este paciente");
        return;
      }

      const h = data.historia || {};
      const od = data.odontograma || {};

      evoluciones = normalizarEvolucionesDeWebhook(data);

      // ‚úÖ NUEVO: cargar consentimientos desde webhook
      consentimientos = normalizarConsentimientosDeWebhook(data);

      // ‚úÖ Guardar en localStorage (para que el ‚úÖ salga de inmediato)
      try { localStorage.setItem(LS_CONS_KEY, JSON.stringify(consentimientos)); } catch(e){}

      renderEvoluciones();

      document.getElementById("paciente_nombre").value = h["Nombre y apellido"] ?? "";
      document.getElementById("paciente_edad").value = h["Edad"] ?? "";
      document.getElementById("paciente_numdoc").value = data.id ?? "";
      document.getElementById("paciente_lugardoc").value = h["Lugar exp"] ?? "";
      document.getElementById("paciente_nacimiento").value = h["Fecha de nacimiento"] ?? "";
      document.getElementById("paciente_lugarnac").value = h["Lugar de nacimiento"] ?? "";
      document.getElementById("paciente_direccion").value = h["paciente_direccion"] ?? "";
      document.getElementById("Ciudad de Residencia").value = h["Ciudad_de_Residencia"] ?? "";
      document.getElementById("EPS_Paciente").value = h["EPS_Paciente"] ?? "";
      document.getElementById("paciente_ocupacion").value = h["paciente_ocupacion"] ?? "";
      document.getElementById("paciente_tel").value = h["paciente_tel"] ?? "";
      document.getElementById("paciente_ciudad").value = h["paciente_ciudad"] ?? "";
      document.getElementById("paciente_cel").value = h["paciente_cel"] ?? "";
      document.getElementById("paciente_email").value = h["paciente_email"] ?? "";
      document.getElementById("paciente_estadocivil").value = h["paciente_estadocivil"] ?? "";
      document.getElementById("padre_tipo").value = h["padre_tipo"] ?? "";
      document.getElementById("madre_tipo").value = h["madre_tipo"] ?? "";

      let tiposID = [];
      try { tiposID = JSON.parse(h["Tipo identificaci√≥n"] || "[]"); } catch(e) { tiposID = []; }
      document.querySelectorAll("input[name='idtipo']").forEach(c => { c.checked = tiposID.includes(c.value); });

      let hijos = [];
      try { hijos = JSON.parse(h["paciente_hijos"] || "[]"); } catch(e) { hijos = []; }
      document.querySelectorAll("input[name='hijos']").forEach(c => { c.checked = hijos.includes(c.value); });

      document.getElementById("padre_nombre").value = h["Nombre padre"] ?? "";
      document.getElementById("madre_nombre").value = h["Nombre madre"] ?? "";
      document.getElementById("padre_tel").value = h["Tel√©fono padre"] ?? "";
      document.getElementById("madre_tel").value = h["Tel√©fono madre"] ?? "";
      document.getElementById("padre_eps").value = h["EPS padre"] ?? "";
      document.getElementById("madre_eps").value = h["EPS madre"] ?? "";

      document.getElementById("emergencia_nombre").value = h["Emergencia nombre"] ?? "";
      document.getElementById("emergencia_parentesco").value = h["Emergencia parentesco"] ?? "";
      document.getElementById("emergencia_tel").value = h["Emergencia tel√©fono"] ?? "";
      document.getElementById("emergencia_cel").value = h["Emergencia celular"] ?? "";

      document.querySelectorAll("input[name='grave']").forEach(c => { c.checked = (h["Enfermedad grave"] ?? []).includes(c.value); });
      document.getElementById("grave_cual").value = h["Enfermedad grave cu√°l"] ?? "";
      document.getElementById("otra_cual").value = h["Otra condici√≥n cu√°l"] ?? "";
      document.getElementById("medicamentos_cuales").value = h["Medicamentos cu√°les"] ?? "";
      document.getElementById("med_dosis").value = h["Medicamentos dosis"] ?? "";
      document.getElementById("alergia_meds").value = h["Alergias medicamentos"] ?? "";

      document.getElementById("numero_hijos").value = h["N√∫mero hijos"] ?? "";
      document.getElementById("tiempo_embarazo").value = h["Tiempo embarazo"] ?? "";

      let condiciones = [];
      try { condiciones = JSON.parse(h["Condiciones"] || "[]"); } catch(e) { condiciones = []; }
      document.querySelectorAll("input[name='condiciones']").forEach(c => { c.checked = condiciones.includes(c.value); });

      let coagulacion = [];
      try { coagulacion = JSON.parse(h["coagulacion"] || "[]"); } catch(e) { coagulacion = []; }
      document.querySelectorAll("input[name='coagulacion']").forEach(c => { c.checked = coagulacion.includes(c.value); });

      let anticoagulantes = [];
      try { anticoagulantes = JSON.parse(h["anticoagulantes"] || "[]"); } catch(e) { anticoagulantes = []; }
      document.querySelectorAll("input[name='anticoagulantes']").forEach(c => { c.checked = anticoagulantes.includes(c.value); });

      let toma_medicamentos = [];
      try { toma_medicamentos = JSON.parse(h["toma_medicamentos"] || "[]"); } catch(e) { toma_medicamentos = []; }
      document.querySelectorAll("input[name='toma_medicamentos']").forEach(c => { c.checked = toma_medicamentos.includes(c.value); });

      let alcohol = [];
      try { alcohol = JSON.parse(h["alcohol"] || "[]"); } catch(e) { alcohol = []; }
      document.querySelectorAll("input[name='alcohol']").forEach(c => { c.checked = alcohol.includes(c.value); });

      let fuma = [];
      try { fuma = JSON.parse(h["fuma"] || "[]"); } catch(e) { fuma = []; }
      document.querySelectorAll("input[name='fuma']").forEach(c => { c.checked = fuma.includes(c.value); });

      let dolor = [];
      try {
        let raw = h["dolor"];
        if (Array.isArray(raw)) dolor = raw;
        else if (typeof raw === "string") {
          raw = raw.replace(/\\"/g, '"');
          dolor = JSON.parse(raw);
        }
      } catch(e) { dolor = []; }

      document.querySelectorAll("input[name='dolor[]']").forEach(c => {
        c.checked = dolor.includes(c.value);
      });

      document.getElementById("motivo_consulta").value = h["Motivo consulta"] ?? "";
      document.querySelectorAll("input[name='tratamientos']").forEach(c => {
        c.checked = (h["Tratamientos"] ?? []).includes(c.value);
      });

      document.querySelectorAll(".cara, .centro").forEach(c => c.style.background = "white");
      reporte = {};

      Object.entries(od).forEach(([diente, regiones]) => {
        Object.entries(regiones).forEach(([region, estado]) => {
          if (!estado) return;

          const estadoNormalizado =
            estado.charAt(0).toUpperCase() + estado.slice(1).toLowerCase();

          const color = preexistencias[estadoNormalizado];
          if (!color) return;

          let cara = null;

          switch(region) {
            case "Mesial":     cara = "derecha"; break;
            case "Distal":     cara = "izquierda"; break;
            case "Oclusal":    cara = "centro"; break;
            case "Vestibular":
              cara = (diente >= 11 && diente <= 28) ? "superior" : "inferior";
              break;
            case "Lingual":    cara = "superior"; break;
            case "Palatino":   cara = "inferior"; break;
          }

          if (!cara) return;

          const selector = `.diente[data-numero='${diente}'] .${cara}`;
          const elem = document.querySelector(selector);
          if (!elem) return;

          elem.style.background = color;

          if (!reporte[diente]) reporte[diente] = {};
          reporte[diente][cara] = estadoNormalizado;
        });
      });

      alert("Historia cl√≠nica cargada con √©xito");

    } catch (err) {
      console.error(err);
      alert("Error consultando N8N");
    }
  }

  // ==============================
  // ‚úÖ PROCEDIMIENTOS / PROFESIONALES (tu c√≥digo igual)
  // ==============================
  const PROCEDIMIENTOS_BASE = [/* ... (igual a tu lista) ... */];
  const LS_PROC_KEY = "procedimientos_custom";
  function _normProc(s) { return String(s || "").trim().replace(/\s+/g, " ").toUpperCase(); }
  function _cargarProcedimientosCustom() { try { const raw = localStorage.getItem(LS_PROC_KEY); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr) ? arr : []; } catch (e) { return []; } }
  function _guardarProcedimientosCustom(arr) { try { localStorage.setItem(LS_PROC_KEY, JSON.stringify(arr)); } catch(e) {} }
  function _getProcedimientosUnicos() { const base = PROCEDIMIENTOS_BASE.map(_normProc); const custom = _cargarProcedimientosCustom().map(_normProc); const set = new Set([...base, ...custom].filter(Boolean)); return Array.from(set).sort((a,b) => a.localeCompare(b, "es")); }
  function _poblarDatalistProcedimientos() { const dl = document.getElementById("procedimientos_list"); if (!dl) return; const items = _getProcedimientosUnicos(); dl.innerHTML = items.map(p => `<option value="${p}"></option>`).join(""); }
  function agregarProcedimientoDesdeCampo() { const input = document.getElementById("evo_tipo"); if (!input) return; const val = _normProc(input.value); if (!val) { alert("‚ö†Ô∏è Escribe un procedimiento para agregar."); return; } const actuales = _getProcedimientosUnicos(); if (actuales.includes(val)) { alert("‚úÖ Ese procedimiento ya existe en la lista."); return; } const custom = _cargarProcedimientosCustom().map(_normProc); custom.push(val); _guardarProcedimientosCustom(Array.from(new Set(custom))); _poblarDatalistProcedimientos(); alert("‚úÖ Procedimiento agregado al listado."); }
  document.addEventListener("DOMContentLoaded", () => {
    _poblarDatalistProcedimientos();
    const input = document.getElementById("evo_tipo");
    if (input) {
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const val = _normProc(input.value);
          if (!val) return;
          const actuales = _getProcedimientosUnicos();
          if (!actuales.includes(val)) {
            const ok = confirm("Este procedimiento no est√° en la lista.\n\n¬øDeseas agregarlo?");
            if (ok) agregarProcedimientoDesdeCampo();
          }
        }
      });
    }
  });

  const PROFESIONALES_BASE = ["LEIDI FERNANDA SILVA OROPEZA"];
  const LS_PROF_KEY = "profesionales_custom";
  function _normProf(s) { return String(s || "").trim().replace(/\s+/g, " ").toUpperCase(); }
  function _cargarProfesionalesCustom() { try { const raw = localStorage.getItem(LS_PROF_KEY); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr) ? arr : []; } catch (e) { return []; } }
  function _guardarProfesionalesCustom(arr) { try { localStorage.setItem(LS_PROF_KEY, JSON.stringify(arr)); } catch(e) {} }
  function _getProfesionalesUnicos() { const base = PROFESIONALES_BASE.map(_normProf); const custom = _cargarProfesionalesCustom().map(_normProf); const set = new Set([...base, ...custom].filter(Boolean)); return Array.from(set).sort((a,b) => a.localeCompare(b, "es")); }
  function _poblarDatalistProfesionales() { const dl = document.getElementById("profesionales_list"); if (!dl) return; const items = _getProfesionalesUnicos(); dl.innerHTML = items.map(p => `<option value="${p}"></option>`).join(""); }
  function agregarProfesionalDesdeCampo() { const input = document.getElementById("evo_profesional"); if (!input) return; const val = _normProf(input.value); if (!val) { alert("‚ö†Ô∏è Escribe el nombre del profesional para agregar."); return; } const actuales = _getProfesionalesUnicos(); if (actuales.includes(val)) { alert("‚úÖ Ese profesional ya existe en la lista."); return; } const custom = _cargarProfesionalesCustom().map(_normProf); custom.push(val); _guardarProfesionalesCustom(Array.from(new Set(custom))); _poblarDatalistProfesionales(); alert("‚úÖ Profesional agregado al listado."); }
  document.addEventListener("DOMContentLoaded", () => {
    _poblarDatalistProfesionales();
    const input = document.getElementById("evo_profesional");
    if (input) {
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const val = _normProf(input.value);
          if (!val) return;
          const actuales = _getProfesionalesUnicos();
          if (!actuales.includes(val)) {
            const ok = confirm("Este profesional no est√° en la lista.\n\n¬øDeseas agregarlo?");
            if (ok) agregarProfesionalDesdeCampo();
          }
        }
      });
    }
  });

  /* ======================================================
     üé§ VOZ POR CAMPO ‚Äì MODO TOGGLE (CLICK ON / CLICK OFF)
     ‚úÖ FIX: evo_detalle ahora NO sobreescribe, sino que AGREGA
     ====================================================== */
  (function () {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("‚ö†Ô∏è Tu navegador no soporta reconocimiento de voz (usa Chrome o Edge).");
      return;
    }

    let rec = null;
    let escuchando = false;
    let campoActivo = null;
    let botonActivo = null;

    const LANG = "es-CO";

    function norm(s) {
      return String(s || "")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .trim();
    }

    function dispatchInput(el) {
      el.dispatchEvent(new Event("input", { bubbles: true }));
      el.dispatchEvent(new Event("change", { bubbles: true }));
    }

    function parseFecha(txt) {
      txt = norm(txt);
      if (/^\d{4}-\d{2}-\d{2}$/.test(txt)) return txt;
      const m = txt.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m) {
        return `${m[3]}-${m[2].padStart(2,"0")}-${m[1].padStart(2,"0")}`;
      }
      return null;
    }

    // ‚úÖ Inserta texto sin borrar (respeta cursor). Usado SOLO para evo_detalle.
    function insertAtCursor(el, text) {
      if (!el) return;
      const start = el.selectionStart ?? el.value.length;
      const end = el.selectionEnd ?? el.value.length;

      const before = el.value.slice(0, start);
      const after = el.value.slice(end);

      // separador suave
      const needsSpace =
        before.length > 0 &&
        !before.endsWith(" ") &&
        !before.endsWith("\n") &&
        !text.startsWith(" ");

      const sep = needsSpace ? " " : "";

      el.value = before + sep + text + after;

      const newPos = (before + sep + text).length;
      try { el.setSelectionRange(newPos, newPos); } catch(e) {}
    }

    function escribir(el, texto) {
      if (!el || el.disabled || el.readOnly) return;

      // ‚úÖ SOLO PARA Detalle/Observaciones: agregar, no reemplazar
      if (el.id === "evo_detalle") {
        insertAtCursor(el, texto);
        dispatchInput(el);
        return;
      }

      // ‚úÖ Para el resto, se mantiene tu comportamiento: reemplazar valor
      if (el.type === "date") {
        el.value = parseFecha(texto) || texto;
      } else if (el.type === "number") {
        el.value = texto.replace(/[^\d]/g, "");
      } else if (el.type === "tel") {
        el.value = texto.replace(/[^\d+]/g, "");
      } else if (el.tagName === "SELECT") {
        const opt = [...el.options].find(o =>
          norm(o.textContent) === norm(texto) ||
          norm(o.value) === norm(texto)
        );
        if (opt) el.value = opt.value;
      } else {
        el.value = texto;
      }

      dispatchInput(el);
    }

    function setEstado(txt) {
      const e = document.getElementById("voz_estado");
      if (e) e.textContent = "Estado: " + txt;
    }

    function setBoton(b, on) {
      if (!b) return;
      b.classList.toggle("on", on);
    }

    function initRec() {
      const r = new SpeechRecognition();
      r.lang = LANG;
      r.continuous = true;
      r.interimResults = false;

      r.onstart = () => {
        escuchando = true;
        setEstado("escuchando");
        setBoton(botonActivo, true);
      };

      r.onend = () => {
        escuchando = false;
        setEstado("apagado");
        setBoton(botonActivo, false);
        campoActivo = null;
        botonActivo = null;
      };

      r.onerror = (e) => {
        console.warn("Voz error:", e);
        setEstado("error");
        setBoton(botonActivo, false);
      };

      r.onresult = (ev) => {
        const res = ev.results[ev.results.length - 1];
        const texto = res[0].transcript.trim();
        if (campoActivo) escribir(campoActivo, texto);
      };

      return r;
    }

    function toggleDictado(campo, boton) {
      if (!rec) rec = initRec();

      // üîÅ Si ya est√° grabando ESTE campo ‚Üí apagar
      if (escuchando && campoActivo === campo) {
        rec.stop();
        return;
      }

      // üîÅ Si estaba grabando otro campo ‚Üí cambiar
      if (escuchando) rec.stop();

      campoActivo = campo;
      botonActivo = boton;

      campo.focus();
      campo.scrollIntoView({ behavior: "smooth", block: "center" });

      try { rec.start(); } catch(e) {}
    }

    function wrapCampos() {
      const campos = document.querySelectorAll(".container input, .container textarea, .container select");

      campos.forEach(el => {
        if (el.type === "hidden" || el.type === "checkbox" || el.type === "radio") return;
        if (el.closest(".vwrap")) return;

        const wrap = document.createElement("div");
        wrap.className = "vwrap";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "vbtn";
        btn.textContent = "";
        btn.title = "Dictar por voz (click para iniciar / detener)";

        btn.addEventListener("click", () => toggleDictado(el, btn));

        el.parentNode.insertBefore(wrap, el);
        wrap.appendChild(el);
        wrap.appendChild(btn);
      });

      setEstado("apagado");
    }

    document.addEventListener("DOMContentLoaded", wrapCampos);

    // Compatibilidad con botones viejos
    window.vozStart = () => alert("Usa el üé§ del campo que quieras dictar.");
    window.vozStop = () => rec && rec.stop();
    window.vozModo  = () => alert("El dictado ahora es por campo üé§.");

  })();

  /* ======================================================
     üîé ODONTOGRAMA: DOBLE CLICK / DOBLE TAP => PANTALLA COMPLETA
     ====================================================== */
  (function(){
    const wrapper = document.getElementById("odontograma-wrapper");
    if (!wrapper) return;

    let isFS = false;
    let exitBtn = null;

    function crearBotonSalir(){
      if (exitBtn) return;
      exitBtn = document.createElement("button");
      exitBtn.id = "btnExitOdonFS";
      exitBtn.type = "button";
      exitBtn.textContent = "Salir ‚úï";
      exitBtn.addEventListener("click", salirFullscreen);
      document.body.appendChild(exitBtn);
    }

    function quitarBotonSalir(){
      if (exitBtn) exitBtn.remove();
      exitBtn = null;
    }

    function entrarFullscreen(){
      if (isFS) return;
      isFS = true;
      wrapper.classList.add("fullscreen");
      crearBotonSalir();

      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";

      wrapper.scrollTop = 0;
      wrapper.scrollLeft = 0;
      setTimeout(ajustarLineaMedia, 50);
    }

    function salirFullscreen(){
      if (!isFS) return;
      isFS = false;
      wrapper.classList.remove("fullscreen");
      quitarBotonSalir();

      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
      setTimeout(ajustarLineaMedia, 50);
    }

    function toggleFullscreen(){
      if (isFS) salirFullscreen();
      else entrarFullscreen();
    }

    wrapper.addEventListener("dblclick", (e) => {
      e.preventDefault();
      toggleFullscreen();
    });

    let lastTap = 0;
    wrapper.addEventListener("touchend", (e) => {
      const now = Date.now();
      if (now - lastTap < 300) {
        e.preventDefault();
        toggleFullscreen();
      }
      lastTap = now;
    }, { passive: false });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") salirFullscreen();
    });
  })();


// ==============================
// ‚úÖ CONSENTIMIENTOS INFORMADOS (COMPLETO)
// ==============================
let consentimientos = [];
const LS_CONS_KEY = "consentimientos_local";

// ‚ö†Ô∏è Cambia por tu webhook real de n8n (para consentimientos)
const N8N_WEBHOOK_CONSENT = "https://ftth-n8n2.pzveh5.easypanel.host/webhook/9a2c4949-da38-4f56-b6ff-d292eee820af";


// ---- Plantillas (puedes editar los textos a tu gusto)
const CONSENT_TEMPLATES = {
  ODONTO_GENERAL: ({paciente, doc, procedimiento, profesional, fecha}) => `
CONSENTIMIENTO INFORMADO DE ODONTOLOG√çA GENERAL

Paciente: ${paciente} - Identificaci√≥n: ${doc}
Procedimiento: ${procedimiento}
Profesional: ${profesional}
Fecha: ${fecha}

Usted tiene derecho a conocer el procedimiento a que va a ser sometido y las posibles complicaciones.
Lea atentamente y pregunte cualquier duda.

CONSISTE:
Procedimientos odontol√≥gicos generales orientados a mantener salud bucal, diagnosticar, prevenir y tratar condiciones comunes.

BENEFICIOS:
- Prevenci√≥n y detecci√≥n temprana
- Eliminaci√≥n/control de caries y placa
- Conservaci√≥n de estructura dental
- Educaci√≥n en higiene oral

RIESGOS / COMPLICACIONES POSIBLES:
- Sensibilidad temporal
- Irritaci√≥n gingival
- Desprendimiento de restauraciones
- En casos poco comunes: reacciones al√©rgicas

CONSECUENCIAS DE NO REALIZAR EL PROCEDIMIENTO:
- Progresi√≥n de caries, dolor, infecci√≥n
- Mayor complejidad y costo futuro
- Riesgo de p√©rdida dental

ACEPTACI√ìN:
Declaro que he sido informado(a), he podido preguntar y entiendo beneficios, riesgos y alternativas. Autorizo la realizaci√≥n del procedimiento.
`.trim(),

  REHABILITACION: ({paciente, doc, procedimiento, profesional, fecha}) => `
CONSENTIMIENTO INFORMADO DE REHABILITACI√ìN ORAL

Paciente: ${paciente} - Identificaci√≥n: ${doc}
Procedimiento: ${procedimiento}
Profesional: ${profesional}
Fecha: ${fecha}

Usted tiene derecho a conocer el procedimiento y las posibles complicaciones.
Lea atentamente y pregunte cualquier duda.

CONSISTE:
La rehabilitaci√≥n oral busca restaurar salud, funci√≥n y est√©tica (pr√≥tesis, coronas, carillas, puentes, etc.).

BENEFICIOS:
- Recuperar funci√≥n masticatoria y fon√©tica
- Mejorar est√©tica
- Prevenir problemas oclusales/ATM
- Mejorar calidad de vida

RIESGOS / COMPLICACIONES POSIBLES:
- Molestias o sensibilidad
- Fractura/aflojamiento de pr√≥tesis
- Inflamaci√≥n o infecci√≥n
- Necesidad de ajustes y controles adicionales

COMPROMISOS DEL PACIENTE:
- Asistir a controles
- Seguir indicaciones
- Mantener higiene oral

ACEPTACI√ìN:
Declaro que he sido informado(a), entiendo beneficios, riesgos y alternativas, y autorizo la realizaci√≥n del procedimiento.
`.trim(),

  GENERICA: ({paciente, doc, procedimiento, profesional, fecha}) => `
CONSENTIMIENTO INFORMADO

Paciente: ${paciente} - Identificaci√≥n: ${doc}
Procedimiento: ${procedimiento}
Profesional: ${profesional}
Fecha: ${fecha}

Declaro que he recibido explicaci√≥n clara del procedimiento, beneficios, riesgos, alternativas y consecuencias de no realizarlo.
He podido realizar preguntas y se me han resuelto dudas. Autorizo de manera libre e informada la realizaci√≥n del procedimiento descrito.
`.trim()
};

// Mapeo AUTO por palabras clave (ajusta como quieras)
function _plantillaAutoPorProcedimiento(proc) {
  const p = String(proc || "").toUpperCase();

  const esRehab = /(NUCLEO|N√öCLEO|CORONA|PUENTE|CARILLA|PROTESIS|PR√ìTESIS|REHABILITACION|REHABILITACI√ìN)/.test(p);
  const esGeneral = /(HIGIEN|HIGIENE|PROFILAXIS|SELLANTES|RESINA|AMALGAMA|OBTURACION|OBTURACI√ìN|OPERATORIA)/.test(p);

  if (esRehab) return "REHABILITACION";
  if (esGeneral) return "ODONTO_GENERAL";
  return "GENERICA";
}

function _cargarConsentimientosLS(){
  try {
    const raw = localStorage.getItem(LS_CONS_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  } catch(e){ return []; }
}
function _guardarConsentimientosLS(){
  try { localStorage.setItem(LS_CONS_KEY, JSON.stringify(consentimientos)); } catch(e){}
}

document.addEventListener("DOMContentLoaded", () => {
  consentimientos = _cargarConsentimientosLS();
  _initCanvasFirma("firmaPaciente");
  _initCanvasFirma("firmaProfesional");
});

// ---- Modal open/close
let _evolucionActualId = null;

/* ‚úÖ‚úÖ FIX FIRMA: abrir modal ANTES de pintar firmas */
function abrirConsentimiento(evolucionId){
  _evolucionActualId = evolucionId;

  const evo = evoluciones.find(x => (x.id_evolucion ?? x.id) === evolucionId) ||
              evoluciones.find(x => x.id === evolucionId);

  if (!evo) { alert("No se encontr√≥ la evoluci√≥n."); return; }

  const paciente = (document.getElementById("paciente_nombre")?.value || "").trim();
  const doc = (document.getElementById("paciente_numdoc")?.value || "").trim();

  const procedimiento = (evo.procedimiento || evo.evo_tipo || "").trim();
  const profesional = (evo.profesional || evo.evo_profesional || "").trim();
  const fecha = (evo.fecha || evo.evo_fecha || _hoyISO()).trim();

  document.getElementById("consent_procedimiento").value = procedimiento;

  // ‚úÖ Mostrar modal primero (clav√≠simo para que canvas pinte bien)
  document.getElementById("modalConsent").style.display = "block";

  // Si ya existe consentimiento para esa evoluci√≥n ‚Üí cargarlo
  const existente = consentimientos.find(c => c.evolucion_id === evolucionId);
  if (existente){
    document.getElementById("consent_template").value = existente.template || "AUTO";
    document.getElementById("consent_texto").value = existente.texto || "";

    // ‚úÖ pinta firmas (espera a que canvas tenga tama√±o visible)
setTimeout(() => {
  _setFirmaDesdeDataURL("firmaPaciente", existente.firma_paciente || existente.firmaPaciente || "");
  _setFirmaDesdeDataURL("firmaProfesional", existente.firma_profesional || existente.firmaProfesional || "");
}, 120);

  } else {
    document.getElementById("consent_template").value = "AUTO";
    const autoKey = _plantillaAutoPorProcedimiento(procedimiento);
    const texto = (CONSENT_TEMPLATES[autoKey] || CONSENT_TEMPLATES.GENERICA)({
      paciente, doc, procedimiento, profesional, fecha
    });
    document.getElementById("consent_texto").value = texto;
    limpiarFirma("PAC");
    limpiarFirma("PRO");
  }

  document.getElementById("consent_meta").textContent =
    `Evoluci√≥n: ${evolucionId} ‚Ä¢ Paciente: ${paciente || "-"} ‚Ä¢ Doc: ${doc || "-"} ‚Ä¢ Profesional: ${profesional || "-"}`;
}

function cerrarConsentimiento(){
  document.getElementById("modalConsent").style.display = "none";
  _evolucionActualId = null;

  // refresca tabla para que muestre ‚úÖ si guardaste
  renderEvoluciones();
}

function cargarPlantillaConsentimiento(){
  if (!_evolucionActualId) return;

  const evo = evoluciones.find(x => (x.id_evolucion ?? x.id) === _evolucionActualId) ||
              evoluciones.find(x => x.id === _evolucionActualId);
  if (!evo) return;

  const paciente = (document.getElementById("paciente_nombre")?.value || "").trim();
  const doc = (document.getElementById("paciente_numdoc")?.value || "").trim();
  const procedimiento = (evo.procedimiento || evo.evo_tipo || "").trim();
  const profesional = (evo.profesional || evo.evo_profesional || "").trim();
  const fecha = (evo.fecha || evo.evo_fecha || _hoyISO()).trim();

  const sel = document.getElementById("consent_template").value;

  let key = sel;
  if (sel === "AUTO") key = _plantillaAutoPorProcedimiento(procedimiento);
  if (!CONSENT_TEMPLATES[key]) key = "GENERICA";

  document.getElementById("consent_texto").value =
    CONSENT_TEMPLATES[key]({paciente, doc, procedimiento, profesional, fecha});
}

// ---- Firmas (canvas)
const _firmas = {}; // por canvasId: {drawing,lastX,lastY}

function _initCanvasFirma(canvasId){
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;

  const ctx = canvas.getContext("2d");
  ctx.lineWidth = 2;
  ctx.lineCap = "round";

  _firmas[canvasId] = { drawing:false, lastX:0, lastY:0 };

  function pos(e){
    const r = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - r.left, y: clientY - r.top };
  }

  function start(e){
    e.preventDefault();
    const p = pos(e);
    _firmas[canvasId].drawing = true;
    _firmas[canvasId].lastX = p.x;
    _firmas[canvasId].lastY = p.y;
  }

  function move(e){
    if (!_firmas[canvasId].drawing) return;
    e.preventDefault();
    const p = pos(e);
    ctx.beginPath();
    ctx.moveTo(_firmas[canvasId].lastX, _firmas[canvasId].lastY);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    _firmas[canvasId].lastX = p.x;
    _firmas[canvasId].lastY = p.y;
  }

  function end(e){
    e.preventDefault();
    _firmas[canvasId].drawing = false;
  }

  // mouse
  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  window.addEventListener("mouseup", end);

  // touch
  canvas.addEventListener("touchstart", start, { passive:false });
  canvas.addEventListener("touchmove", move, { passive:false });
  canvas.addEventListener("touchend", end, { passive:false });
}

function limpiarFirma(tipo){
  const id = (tipo === "PAC") ? "firmaPaciente" : "firmaProfesional";
  const canvas = document.getElementById(id);
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width, canvas.height);
}

function _getFirmaDataURL(canvasId){
  const canvas = document.getElementById(canvasId);
  if (!canvas) return "";

  // si est√° vac√≠o, devuelve ""
  const ctx = canvas.getContext("2d");
  const pixels = ctx.getImageData(0,0,canvas.width, canvas.height).data;
  let hasInk = false;
  for (let i=3; i<pixels.length; i+=4){ // alpha
    if (pixels[i] !== 0) { hasInk = true; break; }
  }
  return hasInk ? canvas.toDataURL("image/png") : "";
}

function _resizeCanvasToDisplaySize(canvas){
  // Ajusta el tama√±o interno del canvas al tama√±o CSS real (y a DPI)
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;

  // Si el canvas est√° oculto, rect puede dar 0
  if (!rect.width || !rect.height) return false;

  const width = Math.round(rect.width * dpr);
  const height = Math.round(rect.height * dpr);

  if (canvas.width !== width || canvas.height !== height) {
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // coord en CSS px
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
  }
  return true;
}

function _setFirmaDesdeDataURL(canvasId, dataURL, intentos = 20){
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;

  // üîÅ Esperar a que el canvas sea visible y tenga tama√±o
  const okSize = _resizeCanvasToDisplaySize(canvas);

  if (!okSize) {
    if (intentos <= 0) {
      console.warn("‚ùå Canvas sin tama√±o visible:", canvasId);
      return;
    }
    setTimeout(() => _setFirmaDesdeDataURL(canvasId, dataURL, intentos - 1), 80);
    return;
  }

  const ctx = canvas.getContext("2d");
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const fijo = _normalizarDataURLFirma(dataURL);
  if (!fijo) {
    // console.warn("‚ö†Ô∏è Firma vac√≠a/ inv√°lida para", canvasId);
    return;
  }

  const img = new Image();
  img.decoding = "async";

  img.onload = () => {
    try {
      // ‚úÖ dibuja usando el tama√±o CSS (por el setTransform del resize)
      const cssW = canvas.getBoundingClientRect().width;
      const cssH = canvas.getBoundingClientRect().height;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, cssW, cssH);
    } catch (e) {
      console.warn("‚ùå drawImage fall√≥:", e);
    }
  };

  img.onerror = () => {
    console.warn("‚ùå Firma inv√°lida/no carg√≥:", (fijo || "").slice(0, 80) + "...");
  };

  img.src = fijo;
}


function _uuidConsent() {
  try { return (crypto && crypto.randomUUID) ? crypto.randomUUID() : _uuidFallback(); }
  catch(e){ return _uuidFallback(); }
}

// ---- Guardar consentimiento
async function sha256Hex(text) {
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
}

async function guardarConsentimiento(){
  if (!_evolucionActualId) { alert("No hay evoluci√≥n activa."); return; }

  const evo = evoluciones.find(x => (x.id_evolucion ?? x.id) === _evolucionActualId) ||
              evoluciones.find(x => x.id === _evolucionActualId);
  if (!evo) { alert("No se encontr√≥ la evoluci√≥n."); return; }

  const paciente_nombre = (document.getElementById("paciente_nombre")?.value || "").trim();
  const cedula_paciente  = (document.getElementById("paciente_numdoc")?.value || "").trim();

  const procedimiento = (evo.procedimiento || evo.evo_tipo || "").trim();
  const profesional   = (evo.profesional || evo.evo_profesional || "").trim();
  const texto         = (document.getElementById("consent_texto")?.value || "").trim();

  if (!cedula_paciente) { alert("Falta la c√©dula del paciente."); return; }
  if (!paciente_nombre) { alert("Falta el nombre del paciente."); return; }
  if (!procedimiento)   { alert("Falta el procedimiento."); return; }
  if (!profesional)     { alert("Falta el profesional."); return; }
  if (!texto)           { alert("El texto del consentimiento est√° vac√≠o."); return; }

  const firma_paciente = _getFirmaDataURL("firmaPaciente");
  const firma_profesional = _getFirmaDataURL("firmaProfesional");

  if (!firma_paciente) { alert("Falta la firma del paciente."); return; }
  if (!firma_profesional) { alert("Falta la firma del profesional."); return; }

  const template_key = document.getElementById("consent_template")?.value || "AUTO";
  const creado_por = localStorage.getItem("usuario_logueado") || "desconocido";

  const firmado_en = new Date().toISOString();
  const creado_en = firmado_en;

  // ‚úÖ Hash (texto + firmas + datos claves) para trazabilidad
  const hash_documento = await sha256Hex(
    JSON.stringify({
      cedula_paciente, paciente_nombre, procedimiento, profesional, template_key,
      texto, firma_paciente, firma_profesional, firmado_en
    })
  );

  // ‚úÖ Armamos el registro EXACTO para tu tabla `consentimientos`
  const row = {
    cedula_paciente,
    paciente_nombre,
    paciente_doc: cedula_paciente,
    evolucion_id: _evolucionActualId,
    procedimiento,
    profesional,
    template_key,
    texto,
    firma_paciente,
    firma_profesional,
    pdf_path: null,
    firmado_en,
    creado_en,
    creado_por,
    ip: null,
    user_agent: navigator.userAgent,
    hash_documento
  };

  // ‚úÖ Guardado local (opcional)
  const i = consentimientos.findIndex(c => c.evolucion_id === _evolucionActualId);
  if (i >= 0) consentimientos[i] = row;
  else consentimientos.unshift(row);
  try { localStorage.setItem(LS_CONS_KEY, JSON.stringify(consentimientos)); } catch(e){}

  // ‚úÖ Enviar a n8n
  try {
    const payload = { evento: "guardar_consentimiento", row };

    const resp = await fetch(N8N_WEBHOOK_CONSENT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!resp.ok) throw new Error("HTTP " + resp.status);

    alert("‚úÖ Consentimiento enviado a n8n y listo para guardar en Supabase.");
    cerrarConsentimiento();
    renderEvoluciones();
  } catch (err) {
    console.warn("‚ö†Ô∏è Guardado local, pero no se pudo enviar a n8n:", err);
    alert("‚ö†Ô∏è Consentimiento guardado localmente, pero NO se pudo enviar a n8n.");
  }
}

</script>

<!-- ==========================
     ‚úÖ MODAL CONSENTIMIENTOS
========================== -->
<div id="modalConsent" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000003; padding:18px;">
  <div style="max-width:980px; margin:0 auto; background:#fff; border-radius:14px; border:1px solid #e7edf5; box-shadow:0 10px 30px rgba(0,0,0,.18); overflow:hidden;">
    <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px; background:#eef6ff; border-bottom:1px solid #e7edf5;">
      <div>
        <div style="font-weight:800; color:#0D47A1;">Consentimiento informado</div>
        <div style="font-size:12px; color:#6b7a90;" id="consent_meta"></div>
      </div>
      <button type="button" class="btn btn-buscar" style="width:auto; padding:8px 12px;" onclick="cerrarConsentimiento()">Cerrar ‚úï</button>
    </div>

    <div style="padding:16px;">
      <div class="grid g-2">
        <div class="ctrl">
          <label>Procedimiento (desde la evoluci√≥n)</label>
          <input id="consent_procedimiento" type="text" readonly>
        </div>

        <div class="ctrl">
          <label>Plantilla</label>
          <select id="consent_template" onchange="cargarPlantillaConsentimiento()">
            <option value="AUTO">Autom√°tica (seg√∫n procedimiento)</option>
            <option value="ODONTO_GENERAL">Odontolog√≠a general</option>
            <option value="REHABILITACION">Rehabilitaci√≥n oral</option>
            <option value="GENERICA">Gen√©rica</option>
          </select>
        </div>

        <div class="ctrl full">
          <label>Texto del consentimiento (editable)</label>
          <textarea id="consent_texto" style="min-height:220px;"></textarea>
        </div>
      </div>

      <div class="rowline"></div>

      <div class="grid g-2">
        <div class="ctrl">
          <label>Firma paciente</label>
          <canvas id="firmaPaciente" width="420" height="160" style="border:1px solid #cbd5e1; border-radius:10px; background:#fff;"></canvas>
          <div class="inline" style="margin-top:8px;">
            <button type="button" class="btn btn-buscar" style="width:auto;" onclick="limpiarFirma('PAC')">Limpiar</button>
          </div>
        </div>

        <div class="ctrl">
          <label>Firma profesional</label>
          <canvas id="firmaProfesional" width="420" height="160" style="border:1px solid #cbd5e1; border-radius:10px; background:#fff;"></canvas>
          <div class="inline" style="margin-top:8px;">
            <button type="button" class="btn btn-buscar" style="width:auto;" onclick="limpiarFirma('PRO')">Limpiar</button>
          </div>
        </div>
      </div>

      <div class="rowline"></div>

      <div class="inline" style="justify-content:flex-end; gap:10px;">
        <button type="button" class="btn btn-agenda" style="width:auto;" onclick="guardarConsentimiento()">
          Guardar consentimiento
        </button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
















