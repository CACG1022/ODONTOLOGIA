<!DOCTYPE html>
<html lang="es">
<head>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <meta charset="UTF-8" />
  <title>Historia Cl√≠nica Odontol√≥gica + Odontograma</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- üîê LOGIN CON SUPABASE -->
  <script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // ==============================
  // üîê CONFIG SUPABASE
  // ==============================
  const supabase = createClient(
    "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
  );

  window.supabase = supabase;

  window.APP_URLS = {
    LOGIN: "https://cacg1022.github.io/ODONTOLOGIA/login.html",
    HOME:  "https://cacg1022.github.io/ODONTOLOGIA/index.html",
  };

  const MODULO = "historia_clinica";

  async function verificarSesion() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      window.location.href = window.APP_URLS.LOGIN;
      return null;
    }
    return session;
  }

  async function validarPermisoModulo() {
    const session = await verificarSesion();
    if (!session) return;

    const { data: perfil, error: ePerfil } = await supabase
      .from("profiles")
      .select("role")
      .eq("id", session.user.id)
      .single();

    if (ePerfil || !perfil?.role) {
      alert("No se pudo obtener tu rol.");
      window.location.href = window.APP_URLS.HOME;
      return;
    }

    const rol = perfil.role;

    const { data: permiso, error: ePerm } = await supabase
      .from("modulos_permisos")
      .select("admin, doctor, auxiliar, paciente")
      .eq("modulo", MODULO)
      .single();

    if (ePerm || !permiso) {
      alert("M√≥dulo no configurado en permisos.");
      window.location.href = window.APP_URLS.HOME;
      return;
    }

    if (!permiso[rol]) {
      alert("‚õî No tienes permiso para acceder a Historia Cl√≠nica.");
      window.location.href = window.APP_URLS.HOME;
      return;
    }

    console.log("‚úÖ Acceso permitido a Historia Cl√≠nica para:", rol);
  }

  // ‚úÖ EJECUCI√ìN SEGURA (sin await directo)
  validarPermisoModulo();

  supabase.auth.onAuthStateChange((_event, session) => {
    if (!session) {
      window.location.href = window.APP_URLS.LOGIN;
    }
  });

    // ==============================
// ‚úÖ DICTADO POR VOZ (Evoluciones: evo_detalle)
// ==============================
let _srEvo = null;
let _srEvoOn = false;

function _soportaDictado() {
  return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
}

function _appendEnTextarea(textarea, texto) {
  if (!textarea) return;

  const actual = textarea.value || "";
  const add = (texto || "").trim();
  if (!add) return;

  // Agregar sin reemplazar, con separador inteligente
  const sep = actual.trim().length ? (actual.endsWith("\n") ? "" : "\n") : "";
  textarea.value = actual + sep + add;

  // cursor al final
  textarea.focus();
  textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
}

function iniciarDictadoEvoDetalle() {
  const ta = document.getElementById("evo_detalle");
  const btn = document.getElementById("btnDictadoEvoDetalle");
  const hint = document.getElementById("dictadoHintEvo");

  if (!_soportaDictado()) {
    alert("‚ö†Ô∏è Tu navegador no soporta dictado por voz. Usa Chrome o Edge.");
    return;
  }

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  _srEvo = new SR();

  _srEvo.lang = "es-CO";         // puedes cambiar a "es-ES", "es-MX", etc.
  _srEvo.continuous = true;      // seguir escuchando
  _srEvo.interimResults = true;  // mostrar parciales (no los agregamos hasta que sean finales)

  let bufferFinal = "";

  _srEvo.onstart = () => {
    _srEvoOn = true;
    if (btn) btn.classList.add("on");
    if (hint) hint.style.display = "block";
  };

  _srEvo.onresult = (event) => {
    let textoFinal = "";

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const res = event.results[i];
      const t = (res[0]?.transcript || "").trim();
      if (!t) continue;

      if (res.isFinal) {
        textoFinal += (textoFinal ? " " : "") + t;
      }
    }

    if (textoFinal) {
      // lo vamos acumulando y lo insertamos de una vez por cada "final"
      bufferFinal += (bufferFinal ? " " : "") + textoFinal;

      // ‚úÖ agrega al textarea SIN borrar lo que ya existe
      _appendEnTextarea(ta, bufferFinal);
      bufferFinal = "";
    }
  };

  _srEvo.onerror = (e) => {
    console.warn("Dictado error:", e);
    // Errores t√≠picos: "not-allowed" (sin permiso), "no-speech"
    if (e?.error === "not-allowed" || e?.error === "service-not-allowed") {
      alert("‚ö†Ô∏è Permiso de micr√≥fono denegado. Habil√≠talo en el navegador.");
      detenerDictadoEvoDetalle();
    }
  };

  _srEvo.onend = () => {
    // Si estaba encendido y el navegador lo corta, intentamos reanudar
    // (√∫til cuando continuous=true pero Chrome a veces lo detiene)
    if (_srEvoOn) {
      try { _srEvo.start(); } catch (err) {}
      return;
    }
    if (btn) btn.classList.remove("on");
    if (hint) hint.style.display = "none";
  };

  try {
    _srEvo.start();
  } catch (e) {
    console.warn("No se pudo iniciar dictado:", e);
  }
}

function detenerDictadoEvoDetalle() {
  const btn = document.getElementById("btnDictadoEvoDetalle");
  const hint = document.getElementById("dictadoHintEvo");

  _srEvoOn = false;

  if (_srEvo) {
    try { _srEvo.onend = null; } catch(e) {}
    try { _srEvo.stop(); } catch(e) {}
    _srEvo = null;
  }

  if (btn) btn.classList.remove("on");
  if (hint) hint.style.display = "none";
}

function toggleDictadoEvoDetalle() {
  if (_srEvoOn) detenerDictadoEvoDetalle();
  else iniciarDictadoEvoDetalle();
}

// opcional: detener dictado si cambias de p√°gina o cierras
window.addEventListener("beforeunload", () => {
  try { detenerDictadoEvoDetalle(); } catch(e) {}
});
window.toggleDictadoEvoDetalle = toggleDictadoEvoDetalle;

function _fmt(val){
  if (val === null || val === undefined) return "";
  if (Array.isArray(val)) return val.join(", ");
  return String(val);
}

function _siNo(arr){
  const v = Array.isArray(arr) ? arr.join(", ") : String(arr || "");
  return v || "";
}

function _tableRow(k, v){
  return `<tr><td class="k">${escapeHtml(k)}</td><td>${escapeHtml(_fmt(v))}</td></tr>`;
}

// Odontograma a tabla (ya lo tienes como odontogramaCompleto en enviarAN8N)
function _odontogramaToHTML(odontogramaCompleto){
  let html = `
    <h3>Odontograma (FDI)</h3>
    <table class="t">
      <thead>
        <tr>
          <th>Diente</th><th>Mesial</th><th>Distal</th><th>Oclusal</th>
          <th>Vestibular</th><th>Lingual</th><th>Palatino</th>
        </tr>
      </thead><tbody>
  `;

  Object.entries(odontogramaCompleto || {}).forEach(([diente, r]) => {
    html += `
      <tr>
        <td>${escapeHtml(diente)}</td>
        <td>${escapeHtml((r.Mesial||"").toUpperCase())}</td>
        <td>${escapeHtml((r.Distal||"").toUpperCase())}</td>
        <td>${escapeHtml((r.Oclusal||"").toUpperCase())}</td>
        <td>${escapeHtml((r.Vestibular||"").toUpperCase())}</td>
        <td>${escapeHtml((r.Lingual||"").toUpperCase())}</td>
        <td>${escapeHtml((r.Palatino||"").toUpperCase())}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  return html;
}

function _evolucionesToHTML(evos){
  const lista = Array.isArray(evos) ? evos : [];
  if (!lista.length) return `<h3>Evoluciones</h3><div class="muted">Sin evoluciones registradas.</div>`;

  let html = `
    <h3>Evoluciones</h3>
    <table class="t">
      <thead>
        <tr>
          <th>Fecha</th><th>Hora</th><th>Profesional</th><th>Procedimiento</th><th>Detalle</th>
        </tr>
      </thead><tbody>
  `;

  lista.forEach(e => {
    const fecha = _soloFechaYYYYMMDD(e.fecha || e.evo_fecha || "");
    const hora  = _soloHoraHHMM(e.hora || e.evo_hora || "");
    html += `
      <tr>
        <td>${escapeHtml(fecha)}</td>
        <td>${escapeHtml(hora)}</td>
        <td>${escapeHtml(String(e.profesional || "").toUpperCase())}</td>
        <td>${escapeHtml(String(e.procedimiento || e.evo_tipo || "").toUpperCase())}</td>
        <td style="white-space:pre-wrap;">${escapeHtml(e.detalle || "")}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  return html;
} 

  </script>

  <style>
    :root{
      --ink:#19324d;
      --muted:#6b7a90;
      --bg:#f6f8fb;
      --card:#ffffff;
      --brand:#2a5d84;
      --gap:18px;
      --radius:14px;
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --line:#e7edf5;
      --input:#cbd5e1;
    }

    *{box-sizing:border-box}
    body{
      margin:0; padding:24px; font-family:system-ui,Segoe UI,Arial; color:var(--ink); background:var(--bg);
    }
    .container{ max-width:1100px; margin:0 auto; }
    h1{ margin:0 0 14px; font-size:28px; color:var(--brand); }
    h2{ font-size:18px; margin:0 0 14px; color:var(--brand); }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:var(--shadow);
      margin-bottom:22px;
    }
    .legend{ font-weight:700; margin-bottom:8px; color:var(--brand); }

    .grid{ display:grid; gap:var(--gap); }
    .g-2{ grid-template-columns:1fr 1fr; }
    .g-3{ grid-template-columns:repeat(3,1fr); }
    .g-4{ grid-template-columns:repeat(4,1fr); }
    .full{ grid-column:1 / -1; }

    .ctrl{ display:flex; flex-direction:column; gap:8px; }
    .ctrl label{ font-size:13px; color:var(--muted); }

    input[type="text"],input[type="email"],input[type="tel"],
    input[type="number"],input[type="date"],input[type="time"], textarea{
      width:100%; border:1px solid var(--input); border-radius:10px; padding:12px;
      font-size:15px; background:#fff;
    }
    select {
      width:100%;
      border:1px solid var(--input);
      border-radius:10px;
      padding:12px;
      font-size:15px;
      background:#fff;
      cursor:pointer;
    }

    textarea{ min-height:120px; resize:vertical; }
    .inline{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:4px 10px;
      border:1px solid var(--line); border-radius:999px; background:#fff;
    }

    .checks{
      display:grid; gap:10px 18px;
      grid-template-columns:repeat(2,minmax(220px,1fr));
      padding-top:10px;
    }
    .check{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px dashed var(--line); border-radius:10px; background:#fafcff;
    }

    .rowline{ height:1px; background:var(--line); margin:12px 0; }

    @media (max-width:980px){
      .g-4{ grid-template-columns:1fr 1fr; }
      .g-3{ grid-template-columns:1fr 1fr; }
    }
    @media (max-width:680px){
      .g-2,.g-3,.g-4{ grid-template-columns:1fr; }
      .checks{ grid-template-columns:1fr; }
    }

    .search-grid{ grid-template-columns: 1.2fr 1fr; align-items:end; }
    .btn{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      color:white;
      font-size:14px;
    }
    .btn-buscar{ background:#0D47A1; }
    .btn-agenda{ background:#009688; }
    .btn-salir{ background:#009688; }
    .btn-agendar{ background:#009688; }
    .btn-guardar{ background:#009688; }
    .btn-inicio{
      background:#E3E3E3;
      color:#009688;
      font-weight:700;
    }

    .tabla-evo{
      width:100%;
      border-collapse:collapse;
    }
    .tabla-evo th,.tabla-evo td{
      padding:10px;
      border:1px solid var(--line);
      vertical-align:top;
    }
    .tabla-evo thead tr{
      background:#eef6ff;
    }

    .tabla-docs{
      width:100%;
      border-collapse:collapse;
    }
    .tabla-docs th,.tabla-docs td{
      padding:10px;
      border:1px solid var(--line);
      vertical-align:top;
    }
    .tabla-docs thead tr{ background:#eef6ff; }

    /* ODONTOGRAMA (igual) */
    #odontograma-wrapper * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    #odontograma-wrapper { background: #f9f9f9; padding: 20px 0 40px; margin-top: 30px; border-radius: 14px; }
    #odontograma-wrapper h1 { text-align: center; color: #0D47A1; margin-bottom: 10px; }
    .odontograma { display: flex; flex-direction: column; align-items: center; gap: 40px; position: relative; z-index: 10; overflow-x: visible !important; width: max-content; margin: 0 auto; }
    .seccion { text-align: center; }
    .etiqueta { font-weight: bold; color: #D0D0D0; margin-bottom: 10px; }
    .fila { display: flex; flex-wrap: nowrap; justify-content: center; gap: var(--tooth-gap); min-width: max-content; }
    .contenedor-diente { display: flex; flex-direction: column; align-items: center; }
    .diente { position: relative; width: var(--tooth-size); height: var(--tooth-size); border-radius: 50%; border: 2px solid #ccc; background: white; overflow: hidden; }
    .cara { position: absolute; width: 100%; height: 100%; cursor: pointer; transition: background 0.2s; z-index: 1; }
    .cara::before,.cara::after { content: ""; position: absolute; width: 1px; height: 100%; background: gray; left: 50%; top: 0; z-index: 0; }
    .cara::before { transform: rotate(45deg); }
    .cara::after  { transform: rotate(-45deg); }
    .superior { clip-path: polygon(50% 50%, 0% 0%, 100% 0%); }
    .inferior { clip-path: polygon(50% 50%, 0% 100%, 100% 100%); }
    .izquierda { clip-path: polygon(50% 50%, 0% 0%, 0% 100%); }
    .derecha   { clip-path: polygon(50% 50%, 100% 0%, 100% 100%); }
    .centro { width: var(--center-size); height: var(--center-size); border-radius: 50%; border: 1.5px solid gray; background: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; cursor: pointer; }
    .numero { font-size: var(--num-size); color: #555; margin-top: 5px; }
    .popup { position: absolute; display: none; background: #fff; border: 1px solid #ccc; padding: 10px; z-index: 1000002; box-shadow: 0 4px 8px rgba(0,0,0,0.2); max-height: 250px; overflow-y: auto; }
    .popup div { margin: 4px 0; font-size: 13px; display: flex; align-items: center; gap: 6px; cursor: pointer; }
    .color-box { width: 12px; height: 12px; border-radius: 2px; display: inline-block; margin-right: 4px; }
    .leyenda { max-width: 1000px; margin: 60px auto 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .leyenda h2 { text-align: center; color: #0D47A1; margin-bottom: 16px; }
    .leyenda-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px 16px; font-size: 14px; }

    .vwrap{ position: relative; display: flex; align-items: center; gap: 10px; }
    .vwrap .vfield{ flex: 1; }
    .vbtn{ width: 44px; min-width: 44px; height: 44px; border-radius: 10px; border: 1px solid var(--line); background: #F5F5F5; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 18px; color: transparent; }
    .vbtn.on{ background: #0D47A1; color: #fff; border-color: #0D47A1; }

    #odontograma-wrapper.fullscreen{
      position: fixed; inset: 0; z-index: 99999; background: #f9f9f9;
      margin: 0 !important; border-radius: 0 !important; padding: 10px 10px 25px; overflow: auto;
    }
    #odontograma-wrapper.fullscreen .odontograma{ margin-left: auto !important; margin-right: auto !important; width: max-content; min-width: max-content; padding: 10px; }
    #btnExitOdonFS{
      position: fixed; top: 12px; right: 12px; z-index: 100000;
      border: none; border-radius: 12px; padding: 10px 14px; cursor: pointer;
      background: #0D47A1; color: #fff; font-weight: 700; box-shadow:0 8px 18px rgba(0,0,0,.18);
    }
    #odontograma-wrapper.fullscreen #odontograma-guias{ max-width: none !important; width: 1300px !important; margin: 5px auto 0 !important; }

    #odontograma-wrapper{ --tooth-size: 56px; --tooth-gap: 10px; --num-size: 11px; --center-size: 20px; }

    .extra-etiquetas{ margin-top: 25px; font-size: 15px; color: #D0D0D0; line-height: 1.1; font-weight: 600; text-align: center; }
    .extra-etiquetas .lingual{ margin-top: 5px; }

    .etiqueta-eje{ position: relative; display: inline-block; padding: 0 10px; }
    .linea-media{ position: absolute; left: 50%; transform: translateX(-50%); width: 3px; background: #E3E3E3; z-index: 999999; pointer-events: none; }
    .etiqueta-eje .linea-media{ top: 100%; height: 0px; }
    .eje-inferior .linea-media{ top: auto; bottom: 100%; height: 0px; }
    .linea-media.linea-cruce::after{
      content:""; position:absolute; left:50%; bottom:0; transform:translateX(-50%);
      width:1000px; height:2px; background:#E3E3E3; border-radius:2px;
    }
    .print-wrap{
  margin-top: 16px; /* ajusta: 8px, 16px, etc */
     }

  </style>
</head>

<body>
<div class="container">

  <!-- BUSCAR -->
  <section class="card">
    <div class="legend">Buscar historia cl√≠nica existente</div>

    <div class="grid g-2 search-grid">
      <div class="ctrl">
        <label for="buscar_cedula">Ingrese n√∫mero de identificaci√≥n</label>
        <input id="buscar_cedula" type="text" placeholder="Ej: 10229566001">
      </div>
      <div class="ctrl">
        <label>&nbsp;</label>
        <button type="button" onclick="buscarHistoria()" class="btn btn-buscar">Buscar</button>
      </div>

      <div class="ctrl">
        <button type="button" onclick="irInicio()" class="btn btn-inicio">IR A INICIO</button>
      </div>
      <div class="ctrl">
        <button type="button" onclick="cerrarSesion()" class="btn btn-salir">Cerrar sesi√≥n</button>
      </div>
      <div class="ctrl">
        <button type="button" onclick="irAgendamiento()" class="btn btn-agenda">VER AGENDA</button>
      </div>

      <div class="ctrl">
        <button type="button" onclick="enviarAN8N()" class="btn btn-guardar">GUARDAR Y ENVIAR</button>
      </div>
      <div class="ctrl">
        <button type="button" onclick="irAgendar()" class="btn btn-agendar">AGENDAR</button>
      </div>

      <div class="ctrl">
        <button type="button" onclick="irPlanTratamiento()" class="btn btn-agenda">PLAN DE TRATAMIENTO</button>
      </div>
    </div>

    <div class="ctrl print-wrap">
  <button type="button" onclick="imprimirHistoriaClinica()" class="btn btn-buscar">
    IMPRIMIR HISTORIA CL√çNICA
  </button>
  </div>

  </section>

  <h1>Historia Cl√≠nica Odontol√≥gica</h1>

  <!-- DATOS B√ÅSICOS -->
  <section class="card">
    <div class="legend">Datos b√°sicos del paciente</div>
    <div class="grid g-2">
      <div class="ctrl">
        <label for="paciente_nombre">*Nombres y apellidos</label>
        <input id="paciente_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_edad">*Edad</label>
        <input id="paciente_edad" type="number" min="0">
      </div>

      <div class="ctrl full">
        <label>*Identificaci√≥n</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="idtipo" value="CC"> C.C.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="CE"> C.E.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="TI"> T.I.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="RC"> R.C.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="Otro"> Otro</label>
          <span class="hint">Complemente con No. y lugar</span>
        </div>
      </div>

      <div class="ctrl">
        <label for="paciente_numdoc">*No.</label>
        <input
          id="paciente_numdoc"
          type="text"
          inputmode="numeric"
          pattern="[0-9]+"
          required
          oninput="this.value = this.value.replace(/[^0-9]/g, '')"
          placeholder="Solo n√∫meros">
      </div>

      <div class="ctrl">
        <label for="paciente_lugardoc">de</label>
        <input id="paciente_lugardoc" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_nacimiento">*Fecha de nacimiento</label>
        <input id="paciente_nacimiento" type="date">
      </div>

      <div class="ctrl">
        <label for="paciente_lugarnac">Lugar de nacimiento</label>
        <input id="paciente_lugarnac" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_direccion">Direcci√≥n de residencia</label>
        <input id="paciente_direccion" type="text">
      </div>

      <!-- ‚úÖ FIX: id sin espacios -->
      <div class="ctrl">
        <label for="Ciudad_de_Residencia">Ciudad de Residencia</label>
        <input id="Ciudad_de_Residencia" type="text">
      </div>

      <div class="ctrl">
        <label for="EPS_Paciente">EPS</label>
        <input id="EPS_Paciente" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_ocupacion">Ocupaci√≥n</label>
        <input id="paciente_ocupacion" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_tel">Tel√©fono</label>
        <input id="paciente_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="paciente_ciudad">Ciudad</label>
        <input id="paciente_ciudad" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_cel">Celular</label>
        <input id="paciente_cel" type="tel">
      </div>

      <div class="ctrl">
        <label for="paciente_email">Correo electr√≥nico</label>
        <input id="paciente_email" type="email">
      </div>

      <div class="ctrl">
        <label for="paciente_estadocivil">Estado civil</label>
        <input id="paciente_estadocivil" type="text">
      </div>

      <div class="ctrl">
        <label>Hijos</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="hijos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="hijos" value="No"> No</label>
        </div>
      </div>
    </div>
  </section>

  <!-- ==========================
       DATOS DEL ACUDIENTE
  ============================== -->
  <section class="card">
    <div class="legend">Datos del acudiente</div>

    <div class="grid g-2">
      <div class="ctrl">
        <label for="padre_nombre">Nombre del padre</label>
        <input id="padre_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="madre_nombre">Nombre de la madre</label>
        <input id="madre_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="padre_tel">Tel√©fono padre</label>
        <input id="padre_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="madre_tel">Tel√©fono madre</label>
        <input id="madre_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="padre_eps">E.P.S. padre</label>
        <input id="padre_eps" type="text">
      </div>

      <div class="ctrl">
        <label for="madre_eps">E.P.S. madre</label>
        <input id="madre_eps" type="text">
      </div>

      <div class="ctrl">
        <label for="padre_tipo">Beneficiario / Cotizante (padre)</label>
        <select id="padre_tipo" name="padre_tipo">
          <option value="">Seleccione</option>
          <option value="Beneficiario">Beneficiario</option>
          <option value="Cotizante">Cotizante</option>
        </select>
      </div>

      <div class="ctrl">
        <label for="madre_tipo">Beneficiario / Cotizante (madre)</label>
        <select id="madre_tipo" name="madre_tipo">
          <option value="">Seleccione</option>
          <option value="Beneficiario">Beneficiario</option>
          <option value="Cotizante">Cotizante</option>
        </select>
      </div>
    </div>
  </section>

  <!-- ==========================
       EMERGENCIA
  ============================== -->
  <section class="card">
    <div class="legend">En caso de emergencia avisar a</div>

    <div class="grid g-2">
      <div class="ctrl">
        <label for="emergencia_nombre">Nombres y apellidos</label>
        <input id="emergencia_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="emergencia_parentesco">Parentesco</label>
        <input id="emergencia_parentesco" type="text">
      </div>

      <div class="ctrl">
        <label for="emergencia_tel">Tel√©fono</label>
        <input id="emergencia_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="emergencia_cel">Celular</label>
        <input id="emergencia_cel" type="tel">
      </div>
    </div>
  </section>

  <!-- ==========================
       HISTORIA M√âDICA
  ============================== -->
  <section class="card">
    <div class="legend">Historia m√©dica</div>

    <div class="grid g-2">
      <div class="ctrl">
        <label>¬øEnfermedad grave actualmente o previa?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="grave" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="grave" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label for="grave_cual">¬øCu√°l?</label>
        <input id="grave_cual" type="text">
      </div>
    </div>

    <div class="ctrl">
      <label>Condiciones (marque las que apliquen)</label>

      <div class="checks">
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones card√≠acas">Alteraciones card√≠acas</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Asma">Asma</label>
        <label class="check"><input type="checkbox" name="condiciones" value="C√°ncer">C√°ncer</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones vasculares o circulatorias">Alteraciones vasculares o circulatorias</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones psicol√≥gicas o psiqui√°tricas">Alteraciones psicol√≥gicas o psiqui√°tricas</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Enfisema">Enfisema</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Artritis">Artritis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Diabetes">Diabetes</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hepatitis">Hepatitis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Desmayos o convulsiones">Desmayos o convulsiones</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hospitalizaciones">Hospitalizaciones</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hipotiroidismo">Hipotiroidismo</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Fiebre reum√°tica">Fiebre reum√°tica</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hipertiroidismos o hiperparatiroidismo">Hipertiroidismos o hiperparatiroidismo</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Lupus">Lupus</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hipertensi√≥n">Hipertensi√≥n</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Leucemia">Leucemia</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Sinusitis">Sinusitis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Irradiaciones">Irradiaciones</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Problemas renales">Problemas renales</label>
        <label class="check"><input type="checkbox" name="condiciones" value="VIH (Sida)">VIH (Sida)</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Osteoporosis">Osteoporosis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Trauma">Trauma</label>

        <div class="check" style="display:block;">
          <div class="grid g-2">
            <label class="inline">
              <input type="checkbox" name="condiciones" value="Otra">
              Otra
            </label>
            <input id="otra_cual" type="text" name="otra_cual" placeholder="¬øCu√°l?">
          </div>
        </div>

        <label class="check"><input type="checkbox" name="condiciones" value="Tuberculosis">Tuberculosis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones nutricionales">Alteraciones nutricionales</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones del h√≠gado">Alteraciones del h√≠gado</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Anemia">Anemia</label>
      </div>
    </div>

    <div class="rowline"></div>

    <div class="grid g-3">
      <div class="ctrl">
        <label>¬øProblemas de coagulaci√≥n?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="coagulacion" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="coagulacion" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øToma anticoagulantes?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="anticoagulantes" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="anticoagulantes" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øToma medicamentos?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="toma_medicamentos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="toma_medicamentos" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label for="medicamentos_cuales">¬øCu√°les?</label>
        <input id="medicamentos_cuales" type="text">
      </div>

      <div class="ctrl">
        <label for="med_dosis">Dosis y frecuencia</label>
        <input id="med_dosis" type="text">
      </div>

      <div class="ctrl">
        <label for="alergia_meds">Alergia a medicamentos</label>
        <input id="alergia_meds" type="text">
      </div>
    </div>

    <div class="rowline"></div>

    <div class="grid g-2">
      <div class="ctrl">
        <label>¬øToma bebidas alcoh√≥licas?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="alcohol" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="alcohol" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øFuma?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="fuma" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="fuma" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øConsume drogas psicoactivas?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="drogas" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="drogas" value="No"> No</label>
        </div>
      </div>
    </div>
  </section>

  <!-- ==========================
       S√ìLO MUJERES
  ============================== -->
  <section class="card">
    <div class="legend">S√≥lo para mujeres</div>

    <div class="grid g-3">
      <div class="ctrl">
        <label>¬øHa tenido embarazos y partos?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="embarazos_partos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="embarazos_partos" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label for="numero_hijos">No. de hijos</label>
        <input id="numero_hijos" type="number" min="0">
      </div>

      <div class="ctrl">
        <label>¬øActualmente est√° embarazada?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="embarazada" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="embarazada" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label for="tiempo_embarazo">Tiempo</label>
        <input id="tiempo_embarazo" type="text">
      </div>

      <div class="ctrl">
        <label>¬øToma anticonceptivos?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="anticonceptivos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="anticonceptivos" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øHisterectom√≠a o menopausia?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="histerectomia_menopausia" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="histerectomia_menopausia" value="No"> No</label>
        </div>
      </div>
    </div>
  </section>

  <!-- ==========================
       HISTORIA ODONTOL√ìGICA
  ============================== -->
  <section class="card">
    <div class="legend">Historia odontol√≥gica</div>

    <div class="grid g-2">
      <div class="ctrl full">
        <label for="motivo_consulta">Motivo de consulta odontol√≥gica</label>
        <input id="motivo_consulta" type="text">
      </div>

      <div class="ctrl">
        <label>¬øPresenta dolor en‚Ä¶?</label>
        <div class="inline">
          <label class="chip">boca <input type="checkbox" name="dolor[]" value="boca"></label>
          <label class="chip">cara <input type="checkbox" name="dolor[]" value="cara"></label>
          <label class="chip">cuello <input type="checkbox" name="dolor[]" value="cuello"></label>
        </div>
      </div>

      <div class="ctrl full">
        <label>Tratamientos recibidos</label>
        <div class="checks">
          <label class="check"><input type="checkbox" name="tratamientos" value="Ortodoncia"> Ortodoncia</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Periodoncia"> Periodoncia</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Endodoncia"> Endodoncia</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Cirug√≠a maxilofacial"> Cirug√≠a maxilofacial</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Implantes dentales"> Implantes dentales</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Restauraci√≥n oral"> Restauraci√≥n oral</label>
        </div>
      </div>

      <p class="hint full">Abajo est√° el odontograma para marcar preexistencias.</p>
    </div>
  </section>
  <!-- ‚úÖ EVOLUCIONES -->
  <section class="card">
    <div class="legend">Evoluciones (procedimientos realizados)</div>

    <div class="grid g-3">
      <div class="ctrl">
        <label for="evo_fecha">Fecha</label>
        <input id="evo_fecha" type="date" disabled>
      </div>

      <div class="ctrl">
        <label for="evo_hora">Hora</label>
        <input id="evo_hora" type="time" readonly>
      </div>

      <div class="ctrl">
        <label for="evo_profesional">Profesional</label>
        <div class="inline" style="gap:10px;">
       <select id="evo_profesional">
        <option value="">Seleccione profesional...</option>
        </select>
          </div>
      </div>


      <div class="ctrl">
        <label for="evo_tipo">Procedimiento</label>
        <div class="inline" style="gap:10px;">
          <input id="evo_tipo" type="text" list="procedimientos_list_supabase" placeholder="Buscar o escribir procedimiento..." autocomplete="off" style="flex:1;" />
        </div>
      </div>

      <div class="ctrl full">
  <label for="evo_detalle">Detalle / Observaciones</label>

  <div class="vwrap">
    <div class="vfield">
      <textarea id="evo_detalle" placeholder="Descripci√≥n del procedimiento, piezas intervenidas, materiales, etc."></textarea>
    </div>

    <button
      id="btnDictadoEvoDetalle"
      type="button"
      class="vbtn"
      title="Dictar por voz"
      aria-label="Dictar por voz"
      onclick="toggleDictadoEvoDetalle()"
    >üé§</button>
  </div>

  <div id="dictadoHintEvo" style="font-size:12px; color:#6b7a90; margin-top:6px; display:none;">
    üéôÔ∏è Dictando... habla normal. (Se agregar√° al final del texto)
  </div>
</div>

    </div>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button type="button" onclick="agregarEvolucion()" class="btn btn-agenda" style="max-width:260px;">Agregar evoluci√≥n</button>
      <button type="button" onclick="limpiarEvolucionForm()" class="btn btn-buscar" style="max-width:260px;">Limpiar</button>
    </div>

    <div class="rowline"></div>

    <div style="overflow:auto;">
      <table class="tabla-evo">
        <thead>
          <tr>
            <th>ID Evoluci√≥n</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Profesional</th>
            <th>Procedimiento</th>
            <th>Detalle</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla_evoluciones"></tbody>
      </table>
    </div>
  </section>

  <!-- ODONTOGRAMA -->
  <div id="odontograma-wrapper">
    <h1>Odontograma Internacional FDI</h1>
    <div id="odontograma-guias" style="position:relative; width:100%; max-width:900px; margin:5px auto 0; height:20px;">
     <!-- <div style="position:absolute; top:70px; left:-130px; color:#D0D0D0; font-weight:bold;">Distal1</div>
      <div style="position:absolute; top:70px; right:-130px; color:#D0D0D0; font-weight:bold;">Distal2</div>
      <div style="position:absolute; top:230px; left:-130px; color:#D0D0D0; font-weight:bold;">Distal4</div>
      <div style="position:absolute; top:230px; right:-130px; color:#D0D0D0; font-weight:bold;">Distal3</div>-->
    </div>

    <div class="odontograma">
      <div class="seccion">
        <div class="etiqueta etiqueta-eje">
          Vestibular---------------------Maxilar superior--------------------Vestibular
          <span class="linea-media linea-cruce"></span>
        </div>
        <div class="fila" id="fila-superior"></div>
      </div>

      <div class="seccion">
        <div class="fila" id="fila-inferior"></div>
        <div class="etiqueta etiqueta-eje eje-inferior">
          Vestibular--------------------Maxilar inferior--------------------Vestibular
          <span class="linea-media"></span>
        </div>
      </div>
    </div>

    <div class="leyenda">
      <h2>Leyenda de Preexistencias</h2>
      <div class="leyenda-grid" id="grid-leyenda"></div>
    </div>

    <div style="text-align:center; margin-top:40px;">
      <button onclick="mostrarReporte()" style="padding:10px 20px; background:#0D47A1; color:white; border:none; border-radius:6px; cursor:pointer;">
        Generar reporte de preexistencias
      </button>

      <div style="text-align:center; margin-top:20px;">
        <button onclick="enviarAN8N()" style="padding:10px 20px; background:#009688; color:white; border:none; border-radius:6px; cursor:pointer;">
          Guardar y enviar
        </button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ DOCUMENTOS1 -->
  <section class="card" id="seccionDocumentos">
    <div class="legend">CONSENTIMIENTOS INFORMADOS</div>

    <div class="grid g-3">
      <div class="ctrl">
        <label>ID documento (autom√°tico)</label>
        <input id="doc_id" type="text" readonly>
      </div>

      <div class="ctrl">
        <label>Tipo de documento</label>
        <select id="doc_tipo">
          <option value="CONSENTIMIENTO">Consentimiento informado</option>
        </select>
      </div>

      <div class="ctrl">
        <label>Fecha</label>
        <input id="doc_fecha" type="date">
      </div>

      <div class="ctrl">
        <label>Procedimiento</label>
        <input id="doc_procedimiento" type="text" list="procedimientos_list_supabase" placeholder="Ej: / HIGIENE / RESINA...">
      </div>

      <div class="ctrl">
        <label>Profesional</label>
        <select id="doc_profesional">
        <option value="">Seleccione profesional...</option>
        </select>

      </div>

      <div class="ctrl">
        <label>Plantilla</label>
        <select id="doc_template">
          <option value="AUTO">Autom√°tica (seg√∫n procedimiento)</option>
          <option value="GENERICA">Gen√©rica</option>
        </select>
      </div>

      <div class="ctrl full">
        <label>Texto del documento (editable)</label>
        <textarea id="doc_texto" style="min-height:220px;"></textarea>
      </div>
    </div>

    <div class="rowline"></div>

    <div class="grid g-2">
      <div class="ctrl">
        <label>Firma paciente</label>
        <canvas id="doc_firmaPaciente" width="420" height="160" style="border:1px solid #cbd5e1; border-radius:10px; background:#fff;"></canvas>
        <div class="inline" style="margin-top:8px;">
          <button type="button" class="btn btn-buscar" style="width:auto;" onclick="limpiarFirmaDocumento('PAC')">Limpiar</button>
        </div>
      </div>

      <div class="ctrl">
        <label>Firma profesional</label>
        <canvas id="doc_firmaProfesional" width="420" height="160" style="border:1px solid #cbd5e1; border-radius:10px; background:#fff;"></canvas>
        <div class="inline" style="margin-top:8px;">
          <button type="button" class="btn btn-buscar" style="width:auto;" onclick="limpiarFirmaDocumento('PRO')">Limpiar</button>
        </div>
      </div>
    </div>

    <div class="rowline"></div>

    <div class="inline" style="justify-content:flex-end; gap:10px;">
  <button type="button" class="btn btn-buscar" style="width:auto;" onclick="abrirModalPlantillas()">Crear plantilla</button>
  <button type="button" class="btn btn-buscar" style="width:auto;" onclick="nuevoDocumento()">Nuevo documento</button>
  <button type="button" class="btn btn-agenda" style="width:auto;" onclick="guardarDocumentoSupabase()">Guardar documento</button>
</div>


    <div class="rowline"></div>

    <div style="overflow:auto;">
      <table class="tabla-docs">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Procedimiento</th>
            <th>Profesional</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla_documentos"></tbody>
      </table>
      <div id="docs_empty" style="margin-top:10px; color:#6b7a90; display:none;">
        Este paciente no tiene documentos registrados.
      </div>
    </div>
  </section>

  <!-- ‚úÖ MODAL VER DOCUMENTO -->
  <div id="modalVerDoc" style="
    display:none; position:fixed; inset:0; background:rgba(0,0,0,.45);
    z-index:1000003; padding:20px;">
    <div style="
  max-width:1000px; margin:0 auto; background:#fff; border-radius:14px;
  border:1px solid #e7edf5; box-shadow:0 10px 30px rgba(0,0,0,.2);
  overflow:hidden;
  max-height: calc(100vh - 40px);
  display:flex; flex-direction:column;
">

      <div style="
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 16px;
  background:#eef6ff;
  border-bottom:1px solid #e7edf5;
  gap:16px;
">
  <!-- IZQUIERDA: T√çTULO -->
  <div style="font-weight:800; color:#2a5d84; font-size:16px;">
    Vista del documento
  </div>

  <!-- DERECHA: LOGO + BOT√ìN -->
  <div style="display:flex; align-items:center; gap:12px;">
    <img
      src="https://static.wixstatic.com/media/63e6ec_3973b230e8aa49869f3127b467fb3e6e~mv2.png/v1/fill/w_426,h_426,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/LOGO%20LEIDI%20SILVA%202%20(1).png"
      alt="Logo Cl√≠nica"
      style="height:48px; object-fit:contain;"
    >

    <button type="button" onclick="cerrarModalVerDoc()" style="
      border:none;
      background:#0D47A1;
      color:#fff;
      font-weight:700;
      border-radius:10px;
      padding:10px 12px;
      cursor:pointer;
    ">
      Cerrar ‚úï
    </button>
  </div>
</div>

  
      <div style="padding:16px; overflow-y:auto; flex:1;">
        <div style="display:grid; gap:14px; grid-template-columns:1fr 1fr;">
          <div style="border:1px solid #e7edf5; border-radius:12px; padding:12px;">
            <div style="font-weight:700; color:#19324d; margin-bottom:8px;">Informaci√≥n</div>
            <div style="font-size:14px; color:#19324d; line-height:1.6;">
              <div><b>ID:</b> <span id="verDoc_id"></span></div>
              <div><b>Fecha:</b> <span id="verDoc_fecha"></span></div>
              <div><b>Tipo:</b> <span id="verDoc_tipo"></span></div>
              <div><b>Procedimiento:</b> <span id="verDoc_procedimiento"></span></div>
              <div><b>Profesional:</b> <span id="verDoc_profesional"></span></div>
            </div>
          </div>

          <div style="border:1px solid #e7edf5; border-radius:12px; padding:12px;">
            <div style="font-weight:700; color:#19324d; margin-bottom:8px;">Acciones</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button type="button" onclick="imprimirDocumento()" style="
                border:none; background:#009688; color:#fff; font-weight:700; border-radius:10px;
                padding:10px 12px; cursor:pointer;">Imprimir</button>

              <button type="button" onclick="descargarHTMLDocumento()" style="
                border:none; background:#0D47A1; color:#fff; font-weight:700; border-radius:10px;
                padding:10px 12px; cursor:pointer;">Descargar (HTML)</button>
            </div>
            <div style="margin-top:10px; font-size:12px; color:#6b7a90;">
              (Imprimir sirve para guardar como PDF desde el navegador)
            </div>
          </div>
        </div>

        <div style="margin-top:14px; border:1px solid #e7edf5; border-radius:12px; overflow:hidden;">
          <div style="background:#fafcff; border-bottom:1px solid #e7edf5; padding:10px 12px; font-weight:700; color:#19324d;">
            Texto del documento
          </div>
          <pre id="verDoc_texto" style="
            margin:0; padding:14px; white-space:pre-wrap;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            font-size:14px; color:#19324d; min-height:160px;"></pre>
        </div>

        <div style="margin-top:14px; display:grid; gap:14px; grid-template-columns:1fr 1fr;">
          <div style="border:1px solid #e7edf5; border-radius:12px; padding:12px;">
            <div style="font-weight:700; color:#19324d; margin-bottom:8px;">Firma paciente</div>
            <img id="verDoc_firmaPaciente" alt="Firma paciente" style="
              width:100%; height:180px; object-fit:contain;
              border:1px solid #cbd5e1; border-radius:10px; background:#fff;">
          </div>

          <div style="border:1px solid #e7edf5; border-radius:12px; padding:12px;">
            <div style="font-weight:700; color:#19324d; margin-bottom:8px;">Firma profesional</div>
            <img id="verDoc_firmaProfesional" alt="Firma profesional" style="
              width:100%; height:180px; object-fit:contain;
              border:1px solid #cbd5e1; border-radius:10px; background:#fff;">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ MODAL PLANTILLAS -->
<div id="modalPlantillas" style="
  display:none; position:fixed; inset:0; background:rgba(0,0,0,.45);
  z-index:1000004; padding:20px;">
  <div style="max-width:1000px; margin:0 auto; background:#fff; border-radius:14px;
    border:1px solid #e7edf5; box-shadow:0 10px 30px rgba(0,0,0,.2); overflow:hidden;">

    <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px;
      background:#eef6ff; border-bottom:1px solid #e7edf5;">
      <div style="font-weight:800; color:#2a5d84;">Plantillas de consentimientos informados</div>
      <button type="button" onclick="cerrarModalPlantillas()" style="
        border:none; background:#0D47A1; color:#fff; font-weight:700; border-radius:10px;
        padding:10px 12px; cursor:pointer;">Cerrar ‚úï</button>
    </div>

    <div style="padding:16px; display:grid; gap:14px; grid-template-columns: 1fr 1.2fr;">
      <!-- LISTADO -->
      <div style="border:1px solid #e7edf5; border-radius:12px; padding:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div style="font-weight:700; color:#19324d;">Mis plantillas</div>
          <button type="button" onclick="nuevaPlantillaUI()" style="
            border:none; background:#009688; color:#fff; font-weight:700; border-radius:10px;
            padding:8px 10px; cursor:pointer;">+ Nueva</button>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:10px;">
          <input id="tpl_buscar" type="text" placeholder="Buscar por nombre o procedimiento..." style="flex:1;">
          <button type="button" onclick="renderListaPlantillas()" style="
            border:none; background:#0D47A1; color:#fff; font-weight:700; border-radius:10px;
            padding:10px 12px; cursor:pointer;">Buscar</button>
        </div>

        <div style="max-height:420px; overflow:auto;">
          <table class="tabla-docs">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Procedimiento</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla_plantillas"></tbody>
          </table>
          <div id="tpl_empty" style="margin-top:10px; color:#6b7a90; display:none;">
            No hay plantillas creadas.
          </div>
        </div>
      </div>

      <!-- FORM -->
      <div style="border:1px solid #e7edf5; border-radius:12px; padding:12px;">
        <div style="font-weight:700; color:#19324d; margin-bottom:10px;">Editor de plantilla</div>

        <input id="tpl_id" type="text" readonly style="display:none;">

        <div class="ctrl">
          <label>Nombre de la plantilla</label>
          <input id="tpl_nombre" type="text" placeholder="Ej: Consentimiento Resina">
        </div>

        <div class="ctrl" style="margin-top:10px;">
          <label>Procedimiento asociado</label>
          <input id="tpl_procedimiento" type="text" list="procedimientos_list_supabase" placeholder="Ej: CACC / HIGIENE / RESINA o GENERICA">
          <div style="font-size:12px; color:#6b7a90; margin-top:6px;">
            Tip: si pones <b>GENERICA</b>, aparecer√° como plantilla general.
          </div>
        </div>

        <div class="ctrl" style="margin-top:10px;">
          <label>Contenido (puedes usar variables)</label>
          <textarea id="tpl_contenido" style="min-height:260px;" placeholder="Ej:
CONSENTIMIENTO INFORMADO
Paciente: {{PACIENTE}} - Identificaci√≥n: {{CEDULA}}
Procedimiento: {{PROCEDIMIENTO}}
Profesional: {{PROFESIONAL}}
Fecha: {{FECHA}}
..."></textarea>
          <div style="font-size:12px; color:#6b7a90; margin-top:6px;">
            Variables disponibles:
            <b>{{PACIENTE}}</b>, <b>{{CEDULA}}</b>, <b>{{PROCEDIMIENTO}}</b>, <b>{{PROFESIONAL}}</b>, <b>{{FECHA}}</b>
          </div>
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap;">
          <button type="button" onclick="probarPlantillaEnDocumento()" style="
            border:none; background:#0D47A1; color:#fff; font-weight:700; border-radius:10px;
            padding:10px 12px; cursor:pointer;">Probar en documento</button>

          <button type="button" onclick="guardarPlantillaSupabase()" style="
            border:none; background:#009688; color:#fff; font-weight:700; border-radius:10px;
            padding:10px 12px; cursor:pointer;">Guardar plantilla</button>

          <button type="button" onclick="eliminarPlantillaSupabase()" style="
            border:none; background:#e53935; color:#fff; font-weight:700; border-radius:10px;
            padding:10px 12px; cursor:pointer;">Eliminar</button>
        </div>
      </div>
    </div>
  </div>
</div>


</div>

<!-- üì§ FORMULARIO OCULTO PARA N8N -->
<form id="formN8N"
  action="https://ftth-n8n2.pzveh5.easypanel.host/webhook/62804cbf-8f21-453b-823e-e5c1b94f31c8"
  method="POST"
  style="display:none;">
  <input type="hidden" id="dataN8N" name="data">
  <input type="hidden" id="usuarioN8N" name="usuario_logueado">
</form>

<datalist id="procedimientos_list_supabase"></datalist>

<script>
  // ==============================
  // CERRAR SESI√ìN + AUTO CIERRE POR INACTIVIDAD (5 min)
  // ==============================
  const LOGIN_URL = window.APP_URLS?.LOGIN || "https://cacg1022.github.io/ODONTOLOGIA/login.html";
  const INACTIVIDAD_MS = 5 * 60 * 1000;

  async function cerrarSesion(motivo = "") {
    try {
      if (window.supabase?.auth?.signOut) {
        await window.supabase.auth.signOut();
      }
    } catch (e) { console.warn("Error cerrando sesi√≥n:", e); }

    try { localStorage.removeItem("usuario_logueado"); } catch(e) {}
    if (motivo) alert(motivo);
    window.location.href = LOGIN_URL;
  }

  let _timerInactividad = null;
  function _reiniciarTimerInactividad() {
    if (_timerInactividad) clearTimeout(_timerInactividad);
    _timerInactividad = setTimeout(() => {
      cerrarSesion("Tu sesi√≥n se cerr√≥ por inactividad (5 minutos).");
    }, INACTIVIDAD_MS);
  }
  ["click","mousemove","keydown","scroll","touchstart"].forEach(evt => {
    window.addEventListener(evt, _reiniciarTimerInactividad, { passive: true });
  });
  _reiniciarTimerInactividad();

  // LINKS
  const URL_AGENDAMIENTO = "https://calendar.google.com/calendar/u/0?cid=ZHJhbGVpZGlzaWx2YUBnbWFpbC5jb20";
  const URL_AGENDAR = "https://calendar.app.google/kbWJdv1f1TZd9bS36";
  const URL_PLAN_TRATAMIENTO = "https://cacg1022.github.io/ODONTOLOGIA/plandetratamiento";
  const URL_INICIO = "https://cacg1022.github.io/ODONTOLOGIA/index.html";
  const LOGO_CLINICA = "https://static.wixstatic.com/media/63e6ec_3973b230e8aa49869f3127b467fb3e6e~mv2.png/v1/fill/w_426,h_426,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/LOGO%20LEIDI%20SILVA%202%20(1).png";


  function irInicio() { window.location.href = URL_INICIO; }
  function irAgendamiento() { window.open(URL_AGENDAMIENTO, "_blank"); }
  function irAgendar() { window.open(URL_AGENDAR, "_blank"); }

  function irPlanTratamiento() {
    const cedula = (
      document.getElementById("paciente_numdoc")?.value ||
      document.getElementById("buscar_cedula")?.value ||
      ""
    ).trim();

    if (!cedula) {
      alert("‚ö†Ô∏è Primero ingresa o busca la c√©dula del paciente para abrir el plan de tratamiento.");
      return;
    }

    try { localStorage.setItem("cedula_paciente_plan", cedula); } catch(e) {}
    const url = URL_PLAN_TRATAMIENTO + (URL_PLAN_TRATAMIENTO.includes("?") ? "&" : "?") + "cedula=" + encodeURIComponent(cedula);
    window.open(url, "_blank");
  }

  // UTILIDADES
  function _uuidFallback() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }
  function uuid() {
    try { return (crypto && crypto.randomUUID) ? crypto.randomUUID() : _uuidFallback(); }
    catch(e){ return _uuidFallback(); }
  }
  function _hoyISO() { return new Date().toISOString().slice(0, 10); }
  function _horaHHMM() {
    const d = new Date();
    return String(d.getHours()).padStart(2, "0") + ":" + String(d.getMinutes()).padStart(2, "0");
  }
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ==============================
  // ‚úÖ PROCEDIMIENTOS DESDE SUPABASE
  // ==============================
  async function cargarProcedimientosDesdeSupabase() {
    const dl = document.getElementById("procedimientos_list_supabase");
    if (!dl) return;

    let tries = 0;
    while (!window.supabase && tries < 40) {
      await new Promise(r => setTimeout(r, 100));
      tries++;
    }
    if (!window.supabase) return;

    try {
      const { data, error } = await window.supabase
        .from("procedimientos_precios")
        .select("procedimiento, activo")
        .eq("activo", true)
        .order("procedimiento", { ascending: true });

      if (error) throw error;

      const items = (data || [])
        .map(x => String(x.procedimiento || "").trim())
        .filter(Boolean);

      dl.innerHTML = items.map(p => `<option value="${escapeHtml(p)}"></option>`).join("");
    } catch (e) {
      console.warn("‚ö†Ô∏è Error cargando procedimientos:", e);
    }
  }
  document.addEventListener("DOMContentLoaded", cargarProcedimientosDesdeSupabase);

  // ==============================
// ‚úÖ PROFESIONALES DESDE SUPABASE
// ==============================
async function cargarProfesionalesDesdeSupabase() {
  // Esperar a que window.supabase exista
  let tries = 0;
  while (!window.supabase && tries < 40) {
    await new Promise(r => setTimeout(r, 100));
    tries++;
  }
  if (!window.supabase) return;

  const selEvo = document.getElementById("evo_profesional");
  const selDoc = document.getElementById("doc_profesional");
  if (!selEvo && !selDoc) return;

  const placeholder = `<option value="">Seleccione profesional...</option>`;
  if (selEvo) selEvo.innerHTML = placeholder;
  if (selDoc) selDoc.innerHTML = placeholder;

  try {
    const { data, error } = await window.supabase
      .from("profesionales")
      .select("id, nombre, cedula, activo")
      .eq("activo", true)
      .order("nombre", { ascending: true });

    if (error) throw error;

    const options = (data || []).map(p => {
      const nombre = (p.nombre || "").trim();
      const cedula = (p.cedula || "").trim();

      // ‚úÖ ESTO ES LO IMPORTANTE:
      // el value ser√° lo que quieres que quede guardado e impreso
      const valor = `${cedula} ${nombre}`.trim(); // ejemplo: "1022956631 Camilo Andres..."
      const label = nombre; // SOLO nombre

      return `<option value="${escapeHtml(valor)}">${escapeHtml(label)}</option>`;
    }).join("");

    if (selEvo) selEvo.innerHTML = placeholder + options;
    if (selDoc) selDoc.innerHTML = placeholder + options;

  } catch (e) {
    console.warn("‚ö†Ô∏è Error cargando profesionales:", e);
  }
}


  // ==============================
  // ‚úÖ EVOLUCIONES
  // ==============================
  let evoluciones = [];

  function limpiarEvolucionForm() {
    const f = document.getElementById("evo_fecha");
    const h = document.getElementById("evo_hora");
    const p = document.getElementById("evo_profesional");
    const t = document.getElementById("evo_tipo");
    const d = document.getElementById("evo_detalle");

    if (f) f.value = _hoyISO();
    if (h) h.value = _horaHHMM();
    if (p) p.value = "";
    if (t) t.value = "";
    if (d) d.value = "";
  }

  function generarEvolucionId() { return uuid(); }

  async function agregarEvolucion() {
    const fecha = (document.getElementById("evo_fecha").value || _hoyISO()).trim();
    const hora = (document.getElementById("evo_hora").value || _horaHHMM()).trim();
    const profesional = document.getElementById("evo_profesional").value.trim();
    const tipo = document.getElementById("evo_tipo").value.trim();
    const detalle = document.getElementById("evo_detalle").value.trim();

    if (!profesional) { alert("‚ö†Ô∏è Debes ingresar el nombre del profesional."); return; }
    if (!tipo) { alert("‚ö†Ô∏è Debes ingresar el procedimiento."); return; }

    const usuario = localStorage.getItem("usuario_logueado") || "desconocido";
    const cedula = (
      document.getElementById("paciente_numdoc")?.value ||
      document.getElementById("buscar_cedula")?.value ||
      ""
    ).trim();

    if (!cedula) {
      alert("‚ö†Ô∏è Primero debes tener la c√©dula del paciente.");
      return;
    }

    const item = {
      id: generarEvolucionId(),
      fecha,
      hora,
      profesional,
      procedimiento: tipo,
      detalle,
      cedula_paciente: cedula,
      usuario,
      ts: new Date().toISOString()
    };

    evoluciones.unshift(item);
    renderEvoluciones();
    limpiarEvolucionForm();

    try {
      const url = "https://ftth-n8n2.pzveh5.easypanel.host/webhook/569051e4-4bdf-44e9-b0d3-34694d6077e9";
      const payload = {
        evento: "agregar_evolucion",
        cedula: cedula,
        evolucion: item,
        fecha_envio: new Date().toISOString(),
        usuario_logueado: usuario
      };

      const resp = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) throw new Error("HTTP " + resp.status);
    } catch (err) {
      console.warn("‚ö†Ô∏è Evoluci√≥n guardada pero NO enviada:", err);
      alert("‚ö†Ô∏è Evoluci√≥n guardada, pero no se pudo enviar a n8n.");
    }
  }

  function eliminarEvolucion(idx) {
    evoluciones.splice(idx, 1);
    renderEvoluciones();
  }

  function _soloFechaYYYYMMDD(valor) {
    if (!valor) return "";
    if (typeof valor === "string" && valor.includes("T")) return valor.split("T")[0];
    return String(valor);
  }
  function _soloHoraHHMM(valor) {
    if (!valor) return "";
    const s = String(valor);
    if (/^\d{2}:\d{2}:\d{2}/.test(s)) return s.slice(0,5);
    return s;
  }

  function renderEvoluciones() {
    const tbody = document.getElementById("tabla_evoluciones");
    if (!tbody) return;

    tbody.innerHTML = "";

    evoluciones.forEach((evo, idx) => {
      const tr = document.createElement("tr");

      const idEvo = evo.id_evolucion ?? evo["id-evolucion"] ?? evo.id ?? "";
      const fecha = _soloFechaYYYYMMDD(evo.fecha ?? evo.evo_fecha);
      const hora  = _soloHoraHHMM(evo.hora ?? evo.evo_hora);
      const profesional = evo.profesional ?? evo.evo_profesional ?? "";
      const procedimiento = evo.procedimiento ?? evo.evo_tipo ?? "";
      const detalle = evo.detalle ?? evo.evo_detalle ?? "";

      tr.innerHTML = `
        <td style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;">
          ${escapeHtml(idEvo)}
        </td>
        <td>${escapeHtml(fecha)}</td>
        <td>${escapeHtml(hora)}</td>
        <td>${escapeHtml(String(profesional).toUpperCase())}</td>
        <td>${escapeHtml(String(procedimiento).toUpperCase())}</td>
        <td style="white-space:pre-wrap;">${escapeHtml(detalle)}</td>
        <td style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" class="btn btn-buscar" style="padding:8px 10px; width:auto;" onclick="eliminarEvolucion(${idx})">
            Eliminar
          </button>
        </td>
      `;

      tbody.appendChild(tr);
    });
  }

  function normalizarEvolucionesDeWebhook(data) {
    let raw = data?.evoluciones;

    if (raw && !Array.isArray(raw) && typeof raw === "object" && Array.isArray(raw.evoluciones)) {
      raw = raw.evoluciones;
    }
    if (typeof raw === "string") {
      try { raw = JSON.parse(raw); } catch(e) { raw = []; }
    }
    if (!Array.isArray(raw)) raw = [];

    return raw.map((e) => ({
      id: e.id_evolucion ?? e["id-evolucion"] ?? e.id ?? generarEvolucionId(),
      fecha: _soloFechaYYYYMMDD(e.fecha ?? e.evo_fecha),
      hora: _soloHoraHHMM(e.hora ?? e.evo_hora),
      profesional: e.profesional ?? e.evo_profesional ?? "",
      procedimiento: e.procedimiento ?? e.evo_tipo ?? "",
      detalle: e.detalle ?? e.evo_detalle ?? "",
      created_at: e.created_at ?? null,
      ts: e.ts ?? e.created_at ?? new Date().toISOString()
    }));
  }

  document.addEventListener("DOMContentLoaded", () => {
  _initCanvasDoc("doc_firmaPaciente");
  _initCanvasDoc("doc_firmaProfesional");
  nuevoDocumento();
  cargarPlantillasDesdeSupabase(); // ‚úÖ NUEVO
  cargarProfesionalesDesdeSupabase();
});


  // ==============================
  // ODONTOGRAMA
  // ==============================
  const preexistencias = {
    Caries: 'red',
    Sano: '#8BC34A',
    Resina: '#a06c3f',
    Corona_adaptada: 'blue',
    Corona_desadaptada: '#C299F7',
    Endodoncia: '#005E94',
    Obturaci√≥n: 'green',
    Fractura: 'orange',
    Ausente: '#c3c5c7',
    Implante: '#7eff42',
    "Extracci√≥n indicada": '#42b7ff',
    Exodoncia: '#ff38ef',
    P√≥ntico: 'cyan',
    "Movilidad dental": 'pink',
    Retenido: 'purple',
    "Pr√≥tesis fija": '#880E4F',
    "Pr√≥tesis removible": '#42ffc6',
    "Pr√≥tesis total": '#fff642',
    Amalgama: '#2B2B2B'
  };

  let reporte = {};
  const contenedorLeyenda = document.getElementById('grid-leyenda');
  Object.entries(preexistencias).forEach(([nombre, color]) => {
    const item = document.createElement('div');
    item.innerHTML = `<span class="color-box" style="background:${color}; border:1px solid #444;"></span>${nombre}`;
    contenedorLeyenda.appendChild(item);
  });

  const dientesSuperior = [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28];
  const dientesInferior = [48,47,46,45,44,43,42,41,31,32,33,34,35,36,37,38];

  function crearDiente(numero, contenedor) {
    const contenedorDiente = document.createElement('div');
    contenedorDiente.className = 'contenedor-diente';

    const diente = document.createElement('div');
    diente.className = 'diente';
    diente.dataset.numero = numero;

    ['superior','inferior','izquierda','derecha'].forEach(region => {
      const div = document.createElement('div');
      div.className = `cara ${region}`;
      div.dataset.region = region;
      div.onclick = (event) => mostrarPopup(event, div);
      diente.appendChild(div);
    });

    const centro = document.createElement('div');
    centro.className = 'centro';
    centro.dataset.region = 'centro';
    centro.onclick = (event) => mostrarPopup(event, centro);
    diente.appendChild(centro);

    const label = document.createElement('div');
    label.className = 'numero';
    label.textContent = numero;

    contenedorDiente.appendChild(diente);
    contenedorDiente.appendChild(label);

    if (numero === 14 || numero === 24) {
      const extra = document.createElement("div");
      extra.className = "extra-etiquetas";
      extra.innerHTML = `<div>Palatino</div><div class="lingual">Lingual</div>`;
      contenedorDiente.appendChild(extra);
    }

    contenedor.appendChild(contenedorDiente);
  }

  function mostrarPopup(event, elemento) {
    event.stopPropagation();
    document.querySelectorAll('.popup').forEach(p => p.remove());

    const menu = document.createElement('div');
    menu.className = 'popup';

    const limpiar = document.createElement('div');
    limpiar.innerHTML = `<span class='color-box' style="background:white; border:1px solid #444;"></span> Limpiar`;

    limpiar.onclick = () => {
      elemento.style.background = "white";

      const dienteNumero = elemento.parentElement.dataset.numero;
      const cara = elemento.dataset.region;

      if (reporte[dienteNumero] && reporte[dienteNumero][cara]) {
        delete reporte[dienteNumero][cara];
      }
      if (reporte[dienteNumero] && Object.keys(reporte[dienteNumero]).length === 0) {
        delete reporte[dienteNumero];
      }

      menu.remove();
    };

    menu.appendChild(limpiar);

    Object.entries(preexistencias).forEach(([nombre, color]) => {
      const item = document.createElement('div');
      item.innerHTML = `<span class='color-box' style="background:${color}; border:1px solid #444;"></span>${nombre}`;

      item.onclick = () => {
        const dienteNumero = elemento.parentElement.dataset.numero;
        const cara = elemento.dataset.region;

        if (!reporte[dienteNumero]) reporte[dienteNumero] = {};

        if (nombre === "Sano" || nombre === "Ausente"|| nombre === "Corona_adaptada"|| nombre === "Corona_desadaptada") {
          elemento.parentElement.querySelectorAll(".cara, .centro")
            .forEach(c => c.style.background = preexistencias[nombre]);

          ["superior","inferior","izquierda","derecha","centro"].forEach(c => {
            reporte[dienteNumero][c] = nombre;
          });
        } else {
          elemento.style.background = color;
          reporte[dienteNumero][cara] = nombre;
        }

        menu.remove();
      };

      menu.appendChild(item);
    });

    document.body.appendChild(menu);
    menu.style.left = `${event.pageX + 5}px`;
    menu.style.top  = `${event.pageY + 5}px`;
    menu.style.display = 'block';
  }

  const filaSuperior = document.getElementById('fila-superior');
  dientesSuperior.forEach(num => crearDiente(num, filaSuperior));

  const filaInferior = document.getElementById('fila-inferior');
  dientesInferior.forEach(num => crearDiente(num, filaInferior));

  function ajustarLineaMedia() {
    const topEtiqueta = document.querySelector(".seccion .etiqueta-eje:not(.eje-inferior)");
    const topLinea = topEtiqueta?.querySelector(".linea-media");
    const bottomEtiqueta = document.querySelector(".etiqueta-eje.eje-inferior");
    const bottomLinea = bottomEtiqueta?.querySelector(".linea-media");

    if (!topEtiqueta || !topLinea || !bottomEtiqueta || !bottomLinea) return;

    const rTop = topEtiqueta.getBoundingClientRect();
    const rBottom = bottomEtiqueta.getBoundingClientRect();

    const dist = rBottom.top - rTop.bottom;
    const h = Math.max(0, Math.round(dist / 2));

    topLinea.style.height = h + "px";
    bottomLinea.style.height = h + "px";
  }

  window.addEventListener("load", ajustarLineaMedia);
  window.addEventListener("resize", ajustarLineaMedia);
  document.body.addEventListener('click', () => document.querySelectorAll('.popup').forEach(p => p.remove()));

  function obtenerRegion(diente, cara) {
    diente = parseInt(diente);
    if (cara === "centro") return "Oclusal";

    if (diente >= 11 && diente <= 28) {
      if (cara === "superior") return "Vestibular";
      if (cara === "inferior") return "Palatino";
    }
    if (diente >= 31 && diente <= 48) {
      if (cara === "superior") return "Lingual";
      if (cara === "inferior") return "Vestibular";
    }

    const derechaEsMesial = (
      (diente >= 11 && diente <= 18) ||
      (diente >= 41 && diente <= 48)
    );

    if (cara === "derecha") return derechaEsMesial ? "Mesial" : "Distal";
    if (cara === "izquierda") return derechaEsMesial ? "Distal" : "Mesial";
    return null;
  }

  function mostrarReporte() {
    let html = `
      <h2>Reporte de Preexistencias</h2>
      <table border="1" cellpadding="6" style="border-collapse:collapse; margin:20px auto; width:95%; text-align:center;">
        <tr style="background:#eee; font-weight:bold;">
          <th>Diente</th><th>Mesial</th><th>Distal</th><th>Oclusal</th><th>Vestibular</th><th>Lingual</th><th>Palatino</th>
        </tr>
    `;

    Object.entries(reporte).forEach(([diente, caras]) => {
      let fila = { Mesial:"", Distal:"", Oclusal:"", Vestibular:"", Lingual:"", Palatino:"" };
      Object.entries(caras).forEach(([cara, preexistencia]) => {
        let region = obtenerRegion(diente, cara);
        if (region) fila[region] = String(preexistencia || "").toUpperCase();
      });

      html += `
        <tr>
          <td>${diente}</td>
          <td>${fila.Mesial}</td>
          <td>${fila.Distal}</td>
          <td>${fila.Oclusal}</td>
          <td>${fila.Vestibular}</td>
          <td>${fila.Lingual}</td>
          <td>${fila.Palatino}</td>
        </tr>
      `;
    });

    html += "</table>";
    const win = window.open("", "_blank");
    win.document.write(html);
    win.document.close();
  }

  function obtenerDatosHistoriaClinica() {
    const data = {};
    document.querySelectorAll(".container input, .container textarea, .container select")
      .forEach(campo => {
        const nombre = campo.id || campo.name;
        if (!nombre) return;

        if (campo.type === "checkbox") {
          if (!data[nombre]) data[nombre] = [];
          if (campo.checked) data[nombre].push(campo.value || true);
        } else {
          data[nombre] = campo.value;
        }
      });
    return data;
  }

  function validarCamposObligatorios() {
    const errores = [];
    const nombre = document.getElementById("paciente_nombre")?.value?.trim() || "";
    if (!nombre) errores.push("Nombres y apellidos");
    const edad = document.getElementById("paciente_edad")?.value || "";
    if (!edad) errores.push("Edad");
    const tipoID = document.querySelectorAll("input[name='idtipo']:checked");
    if (tipoID.length === 0) errores.push("Tipo de identificaci√≥n");
    const numDoc = document.getElementById("paciente_numdoc")?.value?.trim() || "";
    if (!numDoc) errores.push("N√∫mero de identificaci√≥n");
    const fechaNac = document.getElementById("paciente_nacimiento")?.value || "";
    if (!fechaNac) errores.push("Fecha de nacimiento");
    if (!reporte || Object.keys(reporte).length === 0) errores.push("Odontograma (debe marcar al menos un diente)");

    if (errores.length > 0) {
      alert(
        "‚ö†Ô∏è No se puede enviar la historia cl√≠nica.\n\n" +
        "Faltan los siguientes campos obligatorios:\n\n" +
        errores.map(e => "‚Ä¢ " + e).join("\n")
      );
      return false;
    }
    return true;
  }

  function enviarAN8N() {
    if (!validarCamposObligatorios()) return;

    const todosLosDientes = [
      18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28,
      48,47,46,45,44,43,42,41,31,32,33,34,35,36,37,38
    ];

    const odontogramaCompleto = {};
    todosLosDientes.forEach(num => {
      odontogramaCompleto[num] = { Mesial:"", Distal:"", Oclusal:"", Vestibular:"", Lingual:"", Palatino:"" };
    });

    Object.entries(reporte).forEach(([diente, caras]) => {
      Object.entries(caras).forEach(([cara, preexistencia]) => {
        const region = obtenerRegion(diente, cara);
        if (region) odontogramaCompleto[diente][region] = String(preexistencia || "").toUpperCase();
      });
    });

    const datosHistoria = obtenerDatosHistoriaClinica();
    const usuario = localStorage.getItem("usuario_logueado") || "desconocido";
    document.getElementById("usuarioN8N").value = usuario;

    const payload = {
      historia_clinica: datosHistoria,
      odontograma: odontogramaCompleto,
      evoluciones: evoluciones,
      fecha_envio: new Date().toISOString(),
      usuario_logueado: usuario
    };

    document.getElementById("dataN8N").value = JSON.stringify(payload);
    document.getElementById("formN8N").submit();
    alert("Informaci√≥n enviada correctamente a N8N");
  }

  // ==============================
  // ‚úÖ PROFESIONALES
  // ==============================
  const PROFESIONALES_BASE = ["LEIDI FERNANDA SILVA OROPEZA"];
  const LS_PROF_KEY = "profesionales_custom";
  function _normProf(s) { return String(s || "").trim().replace(/\s+/g, " ").toUpperCase(); }
  function _cargarProfesionalesCustom() {
    try { const raw = localStorage.getItem(LS_PROF_KEY); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr) ? arr : []; }
    catch (e) { return []; }
  }
  function _guardarProfesionalesCustom(arr) { try { localStorage.setItem(LS_PROF_KEY, JSON.stringify(arr)); } catch(e) {} }
  function _getProfesionalesUnicos() {
    const base = PROFESIONALES_BASE.map(_normProf);
    const custom = _cargarProfesionalesCustom().map(_normProf);
    const set = new Set([...base, ...custom].filter(Boolean));
    return Array.from(set).sort((a,b) => a.localeCompare(b, "es"));
  }
  function _poblarDatalistProfesionales() {
    const dl = document.getElementById("profesionales_list");
    if (!dl) return;
    const items = _getProfesionalesUnicos();
    dl.innerHTML = items.map(p => `<option value="${escapeHtml(p)}"></option>`).join("");
  }
  function agregarProfesionalDesdeCampo() {
    const input = document.getElementById("evo_profesional");
    if (!input) return;
    const val = _normProf(input.value);
    if (!val) { alert("‚ö†Ô∏è Escribe el nombre del profesional para agregar."); return; }
    const actuales = _getProfesionalesUnicos();
    if (actuales.includes(val)) { alert("‚úÖ Ese profesional ya existe en la lista."); return; }
    const custom = _cargarProfesionalesCustom().map(_normProf);
    custom.push(val);
    _guardarProfesionalesCustom(Array.from(new Set(custom)));
    _poblarDatalistProfesionales();
    alert("‚úÖ Profesional agregado al listado.");
  }
  document.addEventListener("DOMContentLoaded", _poblarDatalistProfesionales);

  // ==============================
  // ‚úÖ ODONTOGRAMA FULLSCREEN
  // ==============================
  (function(){
    const wrapper = document.getElementById("odontograma-wrapper");
    if (!wrapper) return;

    let isFS = false;
    let exitBtn = null;

    function crearBotonSalir(){
      if (exitBtn) return;
      exitBtn = document.createElement("button");
      exitBtn.id = "btnExitOdonFS";
      exitBtn.type = "button";
      exitBtn.textContent = "Salir ‚úï";
      exitBtn.addEventListener("click", salirFullscreen);
      document.body.appendChild(exitBtn);
    }
    function quitarBotonSalir(){ if (exitBtn) exitBtn.remove(); exitBtn = null; }
    function entrarFullscreen(){
      if (isFS) return;
      isFS = true;
      wrapper.classList.add("fullscreen");
      crearBotonSalir();
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";
      wrapper.scrollTop = 0; wrapper.scrollLeft = 0;
      setTimeout(ajustarLineaMedia, 50);
    }
    function salirFullscreen(){
      if (!isFS) return;
      isFS = false;
      wrapper.classList.remove("fullscreen");
      quitarBotonSalir();
      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
      setTimeout(ajustarLineaMedia, 50);
    }
    function toggleFullscreen(){ if (isFS) salirFullscreen(); else entrarFullscreen(); }

    wrapper.addEventListener("dblclick", (e) => { e.preventDefault(); toggleFullscreen(); });

    let lastTap = 0;
    wrapper.addEventListener("touchend", (e) => {
      const now = Date.now();
      if (now - lastTap < 300) { e.preventDefault(); toggleFullscreen(); }
      lastTap = now;
    }, { passive: false });

    document.addEventListener("keydown", (e) => { if (e.key === "Escape") salirFullscreen(); });
  })();

  // =====================================================================
  // ‚úÖ‚úÖ‚úÖ DOCUMENTOS (CONSENTIMIENTOS) - CON FIX DE COLUMNAS: *_path
  // =====================================================================
  let documentos = [];
  let _docEditId = null;
  let _docVistaActual = null;
  let _cedulaActual = "";

  const _IMG_TRANSPARENTE =
    "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO1p0wAAAABJRU5ErkJggg==";

  function _normalizarDataURLFirma(valor) {
    if (!valor) return "";
    let v = String(valor).trim();

    // si viene urlencoded
    try { v = decodeURIComponent(v); } catch(e) {}

    // si viene con espacios, se da√±an los +
    v = v.replace(/\s/g, "+");

    // si ya es dataURL completo
    if (v.startsWith("data:image")) return v;

    // si parece base64 "puro"
    if (/^[A-Za-z0-9+/]+=*$/.test(v) && v.length > 100) {
      return "data:image/png;base64," + v;
    }
    return "";
  }

  const DOC_TEMPLATES = {
    GENERICA: ({paciente, doc, procedimiento, profesional, fecha}) => `
CONSENTIMIENTO INFORMADO

Paciente: ${paciente} - Identificaci√≥n: ${doc}
Procedimiento: ${procedimiento}
Profesional: ${profesional}
Fecha: ${fecha}

Declaro que he recibido explicaci√≥n clara del procedimiento, beneficios, riesgos, alternativas y consecuencias de no realizarlo.
He podido realizar preguntas y se me han resuelto dudas. Autorizo de manera libre e informada la realizaci√≥n del procedimiento descrito.
`.trim()
  };

  // Canvas firmas
  const _docFirmas = {};
  function _initCanvasDoc(canvasId){
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    ctx.lineWidth = 2;
    ctx.lineCap = "round";

    _docFirmas[canvasId] = { drawing:false, lastX:0, lastY:0 };

    function pos(e){
      const r = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: clientX - r.left, y: clientY - r.top };
    }
    function start(e){
      e.preventDefault();
      const p = pos(e);
      _docFirmas[canvasId].drawing = true;
      _docFirmas[canvasId].lastX = p.x;
      _docFirmas[canvasId].lastY = p.y;
    }
    function move(e){
      if (!_docFirmas[canvasId].drawing) return;
      e.preventDefault();
      const p = pos(e);
      ctx.beginPath();
      ctx.moveTo(_docFirmas[canvasId].lastX, _docFirmas[canvasId].lastY);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      _docFirmas[canvasId].lastX = p.x;
      _docFirmas[canvasId].lastY = p.y;
    }
    function end(e){
      e.preventDefault();
      _docFirmas[canvasId].drawing = false;
    }

    canvas.addEventListener("mousedown", start);
    canvas.addEventListener("mousemove", move);
    window.addEventListener("mouseup", end);

    canvas.addEventListener("touchstart", start, { passive:false });
    canvas.addEventListener("touchmove", move, { passive:false });
    canvas.addEventListener("touchend", end, { passive:false });
  }

  function limpiarFirmaDocumento(tipo){
    const id = (tipo === "PAC") ? "doc_firmaPaciente" : "doc_firmaProfesional";
    const canvas = document.getElementById(id);
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width, canvas.height);
  }

  function _getFirmaDataURLDoc(canvasId){
    const canvas = document.getElementById(canvasId);
    if (!canvas) return "";
    const ctx = canvas.getContext("2d");
    const pixels = ctx.getImageData(0,0,canvas.width, canvas.height).data;
    let hasInk = false;
    for (let i=3; i<pixels.length; i+=4){
      if (pixels[i] !== 0) { hasInk = true; break; }
    }
    return hasInk ? canvas.toDataURL("image/png") : "";
  }

  function _pintarFirmaEnCanvas(canvas, dataURL) {
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const fijo = _normalizarDataURLFirma(dataURL);
    if (!fijo) return;

    const img = new Image();
    img.onload = () => {
      const w = canvas.width || 420;
      const h = canvas.height || 160;
      ctx.clearRect(0, 0, w, h);
      ctx.drawImage(img, 0, 0, w, h);
    };
    img.onerror = () => console.warn("‚ùå Firma inv√°lida:", fijo.slice(0, 80));
    img.src = fijo;
  }

  function _setFirmaDocDesdeDataURL(canvasId, dataURL) {
    const canvas = document.getElementById(canvasId);
    _pintarFirmaEnCanvas(canvas, dataURL);
  }

  function nuevoDocumento(){
    _docEditId = null;
    document.getElementById("doc_id").value = uuid();
    document.getElementById("doc_tipo").value = "CONSENTIMIENTO";
    document.getElementById("doc_fecha").value = _hoyISO();
    document.getElementById("doc_procedimiento").value = "";
    document.getElementById("doc_profesional").value = "";
    document.getElementById("doc_template").value = "AUTO";
    document.getElementById("doc_texto").value = "";
    limpiarFirmaDocumento("PAC");
    limpiarFirmaDocumento("PRO");

    const paciente = (document.getElementById("paciente_nombre")?.value || "").trim();
    const doc = (document.getElementById("paciente_numdoc")?.value || "").trim();
    if (paciente && doc) {
      document.getElementById("doc_texto").value = DOC_TEMPLATES.GENERICA({
        paciente, doc, procedimiento:"", profesional:"", fecha:_hoyISO()
      });
    }
  }

  function renderDocumentos(){
    const tbody = document.getElementById("tabla_documentos");
    const empty = document.getElementById("docs_empty");
    if (!tbody) return;

    tbody.innerHTML = "";

    if (!documentos || documentos.length === 0) {
      if (empty) empty.style.display = "block";
      return;
    }
    if (empty) empty.style.display = "none";

    documentos.forEach((d) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;">
          ${escapeHtml(d.id || "")}
        </td>
        <td>${escapeHtml(_soloFechaYYYYMMDD(d.firmado_en || d.creado_en || d.fecha || ""))}</td>
        <td>${escapeHtml(d.tipo || "CONSENTIMIENTO")}</td>
        <td>${escapeHtml(d.procedimiento || "")}</td>
        <td>${escapeHtml(d.profesional || "")}</td>
        <td style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" class="btn btn-buscar" style="padding:8px 10px; width:auto;"
            data-action="ver" data-id="${escapeHtml(d.id || "")}">Ver</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  document.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-action][data-id]");
    if (!btn) return;
    const action = btn.getAttribute("data-action");
    const id = btn.getAttribute("data-id");

    if (action === "ver") return verDocumento(id);
    if (action === "editar") return editarDocumento(id);
    if (action === "eliminar") return eliminarDocumentoSupabase(id);
  });

  function _docById(id){
    return (documentos || []).find(x => String(x.id) === String(id));
  }

  function abrirModalVerDoc(){
    const m = document.getElementById("modalVerDoc");
    if (m) m.style.display = "block";
  }
  function cerrarModalVerDoc(){
    const m = document.getElementById("modalVerDoc");
    if (m) m.style.display = "none";
    _docVistaActual = null;
  }

  // ‚úÖ FIX: leer desde firma_paciente_path / firma_profesional_path
  function verDocumento(id){
    const d = _docById(id);
    if (!d) { alert("Documento no encontrado."); return; }

    _docVistaActual = d;

    document.getElementById("verDoc_id").textContent = d.id || "";
    document.getElementById("verDoc_fecha").textContent = _soloFechaYYYYMMDD(d.firmado_en || d.creado_en || d.fecha || "");
    document.getElementById("verDoc_tipo").textContent = d.tipo || "CONSENTIMIENTO";
    document.getElementById("verDoc_procedimiento").textContent = d.procedimiento || "";
    document.getElementById("verDoc_profesional").textContent = d.profesional || "";
    document.getElementById("verDoc_texto").textContent = d.texto || "";

    // ‚úÖ leer firmas desde lo que cargamos (ya normalizado)
    const fp   = _normalizarDataURLFirma(d.firma_paciente || "");
    const fpro = _normalizarDataURLFirma(d.firma_profesional || "");

    const imgPac = document.getElementById("verDoc_firmaPaciente");
    const imgPro = document.getElementById("verDoc_firmaProfesional");

    imgPac.src = fp || _IMG_TRANSPARENTE;
    imgPro.src = fpro || _IMG_TRANSPARENTE;

    imgPac.style.opacity = fp ? "1" : ".25";
    imgPro.style.opacity = fpro ? "1" : ".25";

    abrirModalVerDoc();
  }

  // ‚úÖ FIX: cargar al canvas desde *_path
  function editarDocumento(id){
    const d = _docById(id);
    if (!d) { alert("Documento no encontrado."); return; }

    _docEditId = d.id;

    document.getElementById("doc_id").value = d.id || "";
    document.getElementById("doc_tipo").value = "CONSENTIMIENTO";
    document.getElementById("doc_fecha").value = _soloFechaYYYYMMDD(d.firmado_en || d.creado_en || d.fecha || _hoyISO());
    document.getElementById("doc_procedimiento").value = d.procedimiento || "";
    document.getElementById("doc_profesional").value = d.profesional || "";
    document.getElementById("doc_template").value = d.template_key || d.template || "AUTO";
    document.getElementById("doc_texto").value = d.texto || "";

    limpiarFirmaDocumento("PAC");
    limpiarFirmaDocumento("PRO");

    setTimeout(() => {
      _setFirmaDocDesdeDataURL("doc_firmaPaciente", d.firma_paciente_path || "");
      _setFirmaDocDesdeDataURL("doc_firmaProfesional", d.firma_profesional_path || "");
    }, 250);
  }

  async function sha256Hex(text) {
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
  }

  // ‚úÖ FIX: mapear desde Supabase con *_path
  // ============================================================
  // ‚úÖ‚úÖ‚úÖ DOCUMENTOS (CONSENTIMIENTOS) - AJUSTADO A TU TABLA REAL
  // Columnas en Supabase:
  // firma_paciente_path, firma_profesional_path
  // ============================================================

  async function cargarDocumentosPacienteDesdeSupabase(cedula){
    documentos = [];
    renderDocumentos();
    if (!cedula) return;

    let tries = 0;
    while (!window.supabase && tries < 40) {
      await new Promise(r => setTimeout(r, 100));
      tries++;
    }
    if (!window.supabase) return;

    try {
      const { data, error } = await window.supabase
        .from("consentimientos")
        .select("*")
        .eq("cedula_paciente", cedula)
        .order("creado_en", { ascending: false });

      if (error) throw error;

      documentos = (data || []).map(x => ({
        id: x.id ?? x.documento_id ?? x.doc_id ?? "",
        tipo: x.tipo ?? "CONSENTIMIENTO",
        cedula_paciente: x.cedula_paciente ?? "",
        paciente_nombre: x.paciente_nombre ?? "",
        procedimiento: x.procedimiento ?? "",
        profesional: x.profesional ?? "",
        template_key: x.template_key ?? x.template ?? "AUTO",
        texto: x.texto ?? "",

        // ‚úÖ OJO: TU TABLA REAL
        firma_paciente: x.firma_paciente_path ?? x.firma_paciente ?? "",
        firma_profesional: x.firma_profesional_path ?? x.firma_profesional ?? "",

        firmado_en: x.firmado_en ?? null,
        creado_en: x.creado_en ?? x.created_at ?? null,
        creado_por: x.creado_por ?? null,
        hash_documento: x.hash_documento ?? null
      })).filter(d => String(d.id).trim() !== "");

      renderDocumentos();
    } catch (e) {
      console.warn("‚ö†Ô∏è No se pudieron cargar documentos:", e);
      documentos = [];
      renderDocumentos();
    }
  }

  // ‚úÖ FIX: guardar en Supabase usando firma_paciente_path / firma_profesional_path
  async function guardarDocumentoSupabase(){
    const cedula_paciente = (document.getElementById("paciente_numdoc")?.value || "").trim();
    const paciente_nombre = (document.getElementById("paciente_nombre")?.value || "").trim();

    if (!cedula_paciente || !paciente_nombre) {
      alert("‚ö†Ô∏è Primero debes cargar/buscar el paciente (nombre y c√©dula).");
      return;
    }

    const id = (document.getElementById("doc_id")?.value || "").trim() || uuid();
    const procedimiento = (document.getElementById("doc_procedimiento")?.value || "").trim();
    const profesional = (document.getElementById("doc_profesional")?.value || "").trim();
    const template_key = (document.getElementById("doc_template")?.value || "AUTO").trim();
    const texto = (document.getElementById("doc_texto")?.value || "").trim();
    const fecha = (document.getElementById("doc_fecha")?.value || _hoyISO()).trim();

    if (!procedimiento) { alert("‚ö†Ô∏è Falta el procedimiento."); return; }
    if (!profesional) { alert("‚ö†Ô∏è Falta el profesional."); return; }
    if (!texto) { alert("‚ö†Ô∏è El texto est√° vac√≠o."); return; }

    // ‚úÖ firmas desde canvas
    const firma_paciente_dataurl = _getFirmaDataURLDoc("doc_firmaPaciente");
    const firma_profesional_dataurl = _getFirmaDataURLDoc("doc_firmaProfesional");

    if (!firma_paciente_dataurl) { alert("‚ö†Ô∏è Falta la firma del paciente."); return; }
    if (!firma_profesional_dataurl) { alert("‚ö†Ô∏è Falta la firma del profesional."); return; }

    const creado_por = localStorage.getItem("usuario_logueado") || "desconocido";
    const firmado_en = new Date(fecha + "T00:00:00").toISOString();
    const creado_en = new Date().toISOString();

    const hash_documento = await sha256Hex(
      JSON.stringify({
        id, cedula_paciente, paciente_nombre,
        procedimiento, profesional, template_key, texto,
        firma_paciente_dataurl, firma_profesional_dataurl,
        firmado_en
      })
    );

    // ‚úÖ‚úÖ‚úÖ AQU√ç EST√Å EL FIX: NOMBRES EXACTOS DE TU TABLA
    const row = {
      id,
      cedula_paciente,
      paciente_nombre,
      procedimiento,
      profesional,
      template_key,
      texto,

      // ‚úÖ En tu tabla se llaman *_path
      firma_paciente_path: firma_paciente_dataurl,
      firma_profesional_path: firma_profesional_dataurl,

      firmado_en,
      creado_en,
      creado_por,
      user_agent: navigator.userAgent,
      hash_documento
    };

    try {
      let tries = 0;
      while (!window.supabase && tries < 40) {
        await new Promise(r => setTimeout(r, 100));
        tries++;
      }
      if (!window.supabase) throw new Error("Supabase no disponible");

      const { error } = await window.supabase
        .from("consentimientos")
        .upsert(row, { onConflict: "id" });

      if (error) throw error;

      alert("‚úÖ Documento guardado en Supabase.");
      await cargarDocumentosPacienteDesdeSupabase(cedula_paciente);

      document.getElementById("doc_id").value = id;
      _docEditId = id;
    } catch (e) {
      // ‚úÖ ahora s√≠ ver√°s el error real
      console.warn("‚ùå Error guardando documento:", e);
      alert("‚ùå No se pudo guardar. Error:\n\n" + (e?.message || JSON.stringify(e)));
    }
  }

  async function eliminarDocumentoSupabase(id){
    const cedula_paciente = (document.getElementById("paciente_numdoc")?.value || "").trim();
    if (!id) return;

    const ok = confirm("¬øEliminar este documento?");
    if (!ok) return;

    try {
      let tries = 0;
      while (!window.supabase && tries < 40) {
        await new Promise(r => setTimeout(r, 100));
        tries++;
      }
      if (!window.supabase) throw new Error("Supabase no disponible");

      const { error } = await window.supabase
        .from("consentimientos")
        .delete()
        .eq("id", id);

      if (error) throw error;

      alert("‚úÖ Documento eliminado.");
      await cargarDocumentosPacienteDesdeSupabase(cedula_paciente);
      nuevoDocumento();
    } catch (e) {
      console.warn("‚ùå Error eliminando documento:", e);
      alert("‚ùå No se pudo eliminar. Revisa consola.");
    }
  }

  // ==============================
  // ‚úÖ IMPRIMIR / DESCARGAR HTML (FIX *_path)
  // ==============================
 function imprimirDocumento(){
  if (!_docVistaActual) return;
  const d = _docVistaActual;
const pacienteNombre = (d.paciente_nombre || document.getElementById("paciente_nombre")?.value || "").trim();
const pacienteCedula = (d.cedula_paciente || document.getElementById("paciente_numdoc")?.value || "").trim();
const profesionalNombre = (d.profesional || "").trim();


  const fp = _normalizarDataURLFirma(d.firma_paciente || d.firma_paciente_path || "");
  const fpro = _normalizarDataURLFirma(d.firma_profesional || d.firma_profesional_path || "");

  const html = `
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<title>Documento ${escapeHtml(d.id || "")}</title>
<style>
  body{ font-family: system-ui, Segoe UI, Arial; padding:20px; color:#111; }
  .header{ display:flex; justify-content:space-between; align-items:flex-start; gap:16px; }
  .logo{
  height:110px;
  max-width:220px;
  object-fit:contain;
}

  .meta{ font-size:13px; line-height:1.5; margin:10px 0 14px; }
  pre{ white-space:pre-wrap; border:1px solid #ddd; border-radius:10px; padding:14px; font-size:13px; }

  .box{ border:1px solid #ddd; border-radius:10px; padding:10px; }
  img.firma{ width:100%; height:160px; object-fit:contain; border:1px solid #eee; border-radius:8px; display:block; }
  .nofirma{ opacity:.6; padding:20px 0; text-align:center; }

  @media print{
  body{ padding:0; }
  .logo{
    height:130px;
    max-width:260px;
  }
}
.grid{ display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-top:14px; }

.sigbox{
  border:1px solid #ddd;
  border-radius:10px;
  padding:12px;
}

.sigbox img{
  width:100%;
  height:150px;
  object-fit:contain;
  display:block;
}

.sigline{
  border-top:2px solid #000;
  margin:10px 0 6px;
}

.sigtext{
  font-size:13px;
  text-align:center;
  line-height:1.25;
}

</style>
</head>
<body>

  <div class="header">
    <div>
      <h2 style="margin:0;">${escapeHtml(d.tipo || "CONSENTIMIENTO")}</h2>
      <div class="meta">
        <div><b>ID:</b> ${escapeHtml(d.id || "")}</div>
        <div><b>Fecha:</b> ${escapeHtml(_soloFechaYYYYMMDD(d.firmado_en || d.creado_en || d.fecha || ""))}</div>
        <div><b>Procedimiento:</b> ${escapeHtml(d.procedimiento || "")}</div>
        <div><b>Profesional:</b> ${escapeHtml(d.profesional || "")}</div>
      </div>
    </div>

    <img class="logo" src="${LOGO_CLINICA}" alt="Logo Cl√≠nica">
  </div>

  <pre>${escapeHtml(d.texto || "")}</pre>

 <div class="grid">
  <div class="sigbox">
    ${fp ? `<img id="imgPac" src="${fp}">` : `<div class="nofirma">Sin firma</div>`}
    <div class="sigline"></div>
    <div class="sigtext">
      <b>Paciente:</b> ${escapeHtml(pacienteCedula)} ${escapeHtml(pacienteNombre.toUpperCase())}
    </div>
  </div>

  <div class="sigbox">
    ${fpro ? `<img id="imgPro" src="${fpro}">` : `<div class="nofirma">Sin firma</div>`}
    <div class="sigline"></div>
    <div class="sigtext">
      <b>Profesional:</b> ${escapeHtml(profesionalNombre.toUpperCase())}
    </div>
  </div>
</div>

<script>
(async function(){
  const imgs = Array.from(document.images || []);
  const waits = imgs.map(img => {
    if (img.complete) return Promise.resolve();
    return new Promise(res => { img.onload = res; img.onerror = res; });
  });
  await Promise.all(waits);
  setTimeout(() => window.print(), 200);
})();
<\/script>
</body>
</html>`;

  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
}


  function descargarHTMLDocumento(){
    if (!_docVistaActual) return;
    const d = _docVistaActual;

    const fp = _normalizarDataURLFirma(d.firma_paciente_path || "");
    const fpro = _normalizarDataURLFirma(d.firma_profesional_path || "");

    const html = `<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8">
<title>Documento ${escapeHtml(d.id || "")}</title></head>
<body style="font-family:system-ui,Segoe UI,Arial;padding:20px;">
<h2>${escapeHtml(d.tipo || "CONSENTIMIENTO")}</h2>
<p><b>ID:</b> ${escapeHtml(d.id || "")}<br>
<b>Fecha:</b> ${escapeHtml(_soloFechaYYYYMMDD(d.firmado_en || d.creado_en || d.fecha || ""))}<br>
<b>Procedimiento:</b> ${escapeHtml(d.procedimiento || "")}<br>
<b>Profesional:</b> ${escapeHtml(d.profesional || "")}</p>
<pre style="white-space:pre-wrap;border:1px solid #ddd;border-radius:10px;padding:14px;">${escapeHtml(d.texto || "")}</pre>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px;">
  <div style="border:1px solid #ddd;border-radius:10px;padding:10px;">
    <b>Firma paciente</b><br>
    ${fp ? `<img src="${fp}" style="width:100%;height:160px;object-fit:contain;border:1px solid #eee;border-radius:8px;">` : `<span style="opacity:.6;">Sin firma</span>`}
  </div>
  <div style="border:1px solid #ddd;border-radius:10px;padding:10px;">
    <b>Firma profesional</b><br>
    ${fpro ? `<img src="${fpro}" style="width:100%;height:160px;object-fit:contain;border:1px solid #eee;border-radius:8px;">` : `<span style="opacity:.6;">Sin firma</span>`}
  </div>
</div>
</body></html>`;

    const blob = new Blob([html], { type: "text/html;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `documento_${(d.id || "sin_id")}.html`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // Init documentos
  document.addEventListener("DOMContentLoaded", () => {
    _initCanvasDoc("doc_firmaPaciente");
    _initCanvasDoc("doc_firmaProfesional");
    nuevoDocumento();
  });

  // ==============================
  // ‚úÖ BUSCAR HISTORIA (FIX Ciudad_de_Residencia + carga docs)
  // ==============================
  async function buscarHistoria() {
    const cedula = document.getElementById("buscar_cedula").value.trim();
    if (!cedula) { alert("Ingrese una c√©dula"); return; }

    _cedulaActual = cedula;

    documentos = [];
    renderDocumentos();
    nuevoDocumento();

    const url = `https://ftth-n8n2.pzveh5.easypanel.host/webhook/62804cbf-8f21-453b-823e-e5c1b94f31c8?cedula=${cedula}`;

    try {
      const resp = await fetch(url);
      const data = await resp.json();

      if (!data.existe) {
        evoluciones = [];
        renderEvoluciones();
        alert("No existe historia cl√≠nica para este paciente");
        return;
      }

      const h = data.historia || {};
      const od = data.odontograma || {};
      evoluciones = normalizarEvolucionesDeWebhook(data);
      renderEvoluciones();
      // ‚úÖ cargar historia / odontograma / evoluciones SIEMPRE
      document.getElementById("paciente_nombre").value = h["Nombre y apellido"] ?? "";
      document.getElementById("paciente_edad").value = h["Edad"] ?? "";
      document.getElementById("paciente_numdoc").value = data.id ?? cedula;
      document.getElementById("paciente_lugardoc").value = h["Lugar exp"] ?? "";
      document.getElementById("paciente_nacimiento").value = h["Fecha de nacimiento"] ?? "";
      document.getElementById("paciente_lugarnac").value = h["Lugar de nacimiento"] ?? "";
      document.getElementById("paciente_direccion").value = h["paciente_direccion"] ?? "";

      // ‚úÖ FIX: id sin espacios
      document.getElementById("Ciudad_de_Residencia").value = h["Ciudad_de_Residencia"] ?? "";

      document.getElementById("EPS_Paciente").value = h["EPS_Paciente"] ?? "";
      document.getElementById("paciente_ocupacion").value = h["paciente_ocupacion"] ?? "";
      document.getElementById("paciente_tel").value = h["paciente_tel"] ?? "";
      document.getElementById("paciente_ciudad").value = h["paciente_ciudad"] ?? "";
      document.getElementById("paciente_cel").value = h["paciente_cel"] ?? "";
      document.getElementById("paciente_email").value = h["paciente_email"] ?? "";
      document.getElementById("paciente_estadocivil").value = h["paciente_estadocivil"] ?? "";
      document.getElementById("padre_tipo").value = h["padre_tipo"] ?? "";
      document.getElementById("madre_tipo").value = h["madre_tipo"] ?? "";

      let tiposID = [];
      try { tiposID = JSON.parse(h["Tipo identificaci√≥n"] || "[]"); } catch(e) { tiposID = []; }
      document.querySelectorAll("input[name='idtipo']").forEach(c => { c.checked = tiposID.includes(c.value); });

      let hijos = [];
      try { hijos = JSON.parse(h["paciente_hijos"] || "[]"); } catch(e) { hijos = []; }
      document.querySelectorAll("input[name='hijos']").forEach(c => { c.checked = hijos.includes(c.value); });

      document.getElementById("padre_nombre").value = h["Nombre padre"] ?? "";
      document.getElementById("madre_nombre").value = h["Nombre madre"] ?? "";
      document.getElementById("padre_tel").value = h["Tel√©fono padre"] ?? "";
      document.getElementById("madre_tel").value = h["Tel√©fono madre"] ?? "";
      document.getElementById("padre_eps").value = h["EPS padre"] ?? "";
      document.getElementById("madre_eps").value = h["EPS madre"] ?? "";

      document.getElementById("emergencia_nombre").value = h["Emergencia nombre"] ?? "";
      document.getElementById("emergencia_parentesco").value = h["Emergencia parentesco"] ?? "";
      document.getElementById("emergencia_tel").value = h["Emergencia tel√©fono"] ?? "";
      document.getElementById("emergencia_cel").value = h["Emergencia celular"] ?? "";

      document.querySelectorAll("input[name='grave']").forEach(c => { c.checked = (h["Enfermedad grave"] ?? []).includes(c.value); });
      document.getElementById("grave_cual").value = h["Enfermedad grave cu√°l"] ?? "";
      document.getElementById("otra_cual").value = h["Otra condici√≥n cu√°l"] ?? "";
      document.getElementById("medicamentos_cuales").value = h["Medicamentos cu√°les"] ?? "";
      document.getElementById("med_dosis").value = h["Medicamentos dosis"] ?? "";
      document.getElementById("alergia_meds").value = h["Alergias medicamentos"] ?? "";

      document.getElementById("numero_hijos").value = h["N√∫mero hijos"] ?? "";
      document.getElementById("tiempo_embarazo").value = h["Tiempo embarazo"] ?? "";

      let condiciones = [];
      try { condiciones = JSON.parse(h["Condiciones"] || "[]"); } catch(e) { condiciones = []; }
      document.querySelectorAll("input[name='condiciones']").forEach(c => { c.checked = condiciones.includes(c.value); });

      let coagulacion = [];
      try { coagulacion = JSON.parse(h["coagulacion"] || "[]"); } catch(e) { coagulacion = []; }
      document.querySelectorAll("input[name='coagulacion']").forEach(c => { c.checked = coagulacion.includes(c.value); });

      let anticoagulantes = [];
      try { anticoagulantes = JSON.parse(h["anticoagulantes"] || "[]"); } catch(e) { anticoagulantes = []; }
      document.querySelectorAll("input[name='anticoagulantes']").forEach(c => { c.checked = anticoagulantes.includes(c.value); });

      let toma_medicamentos = [];
      try { toma_medicamentos = JSON.parse(h["toma_medicamentos"] || "[]"); } catch(e) { toma_medicamentos = []; }
      document.querySelectorAll("input[name='toma_medicamentos']").forEach(c => { c.checked = toma_medicamentos.includes(c.value); });

      let alcohol = [];
      try { alcohol = JSON.parse(h["alcohol"] || "[]"); } catch(e) { alcohol = []; }
      document.querySelectorAll("input[name='alcohol']").forEach(c => { c.checked = alcohol.includes(c.value); });

      let fuma = [];
      try { fuma = JSON.parse(h["fuma"] || "[]"); } catch(e) { fuma = []; }
      document.querySelectorAll("input[name='fuma']").forEach(c => { c.checked = fuma.includes(c.value); });

      let dolor = [];
      try {
        let raw = h["dolor"];
        if (Array.isArray(raw)) dolor = raw;
        else if (typeof raw === "string") {
          raw = raw.replace(/\\"/g, '"');
          dolor = JSON.parse(raw);
        }
      } catch(e) { dolor = []; }

      document.querySelectorAll("input[name='dolor[]']").forEach(c => {
        c.checked = dolor.includes(c.value);
      });

      document.getElementById("motivo_consulta").value = h["Motivo consulta"] ?? "";
      document.querySelectorAll("input[name='tratamientos']").forEach(c => {
        c.checked = (h["Tratamientos"] ?? []).includes(c.value);
      });
      // odontograma (tu mismo mapping)
      document.querySelectorAll(".cara, .centro").forEach(c => c.style.background = "white");
      reporte = {};

      Object.entries(od).forEach(([diente, regiones]) => {
        Object.entries(regiones).forEach(([region, estado]) => {
          if (!estado) return;
          const estadoNormalizado = estado.charAt(0).toUpperCase() + estado.slice(1).toLowerCase();
          const color = preexistencias[estadoNormalizado];
          if (!color) return;

          let cara = null;
          switch(region) {
            case "Mesial":     cara = "derecha"; break;
            case "Distal":     cara = "izquierda"; break;
            case "Oclusal":    cara = "centro"; break;
            case "Vestibular":
              cara = (diente >= 11 && diente <= 28) ? "superior" : "inferior";
              break;
            case "Lingual":    cara = "superior"; break;
            case "Palatino":   cara = "inferior"; break;
          }
          if (!cara) return;

          const selector = `.diente[data-numero='${diente}'] .${cara}`;
          const elem = document.querySelector(selector);
          if (!elem) return;

          elem.style.background = color;
          if (!reporte[diente]) reporte[diente] = {};
          reporte[diente][cara] = estadoNormalizado;
        });
      });

      // ‚úÖ cargar documentos del paciente
      await cargarDocumentosPacienteDesdeSupabase(cedula);

      // preparar doc nuevo
      document.getElementById("doc_id").value = uuid();
      document.getElementById("doc_fecha").value = _hoyISO();
      document.getElementById("doc_profesional").value = "";
      document.getElementById("doc_procedimiento").value = "";
      document.getElementById("doc_template").value = "AUTO";
      document.getElementById("doc_texto").value = DOC_TEMPLATES.GENERICA({
        paciente: (document.getElementById("paciente_nombre").value || "").trim(),
        doc: (document.getElementById("paciente_numdoc").value || "").trim(),
        procedimiento: "",
        profesional: "",
        fecha: _hoyISO()
      });

      alert("Historia cl√≠nica cargada con √©xito");
    } catch (err) {
      console.error(err);
      alert("Error consultando N8N");
    }
  }

  // ============================================================
// ‚úÖ‚úÖ‚úÖ PLANTILLAS DE CONSENTIMIENTOS (SUPABASE)
// Tabla: consentimiento_plantillas
// ============================================================
let plantillas = [];
let _tplEditId = null;

function abrirModalPlantillas(){
  const m = document.getElementById("modalPlantillas");
  if (m) m.style.display = "block";
  cargarPlantillasDesdeSupabase();
}
function cerrarModalPlantillas(){
  const m = document.getElementById("modalPlantillas");
  if (m) m.style.display = "none";
}

function nuevaPlantillaUI(){
  _tplEditId = null;
  document.getElementById("tpl_id").value = "";
  document.getElementById("tpl_nombre").value = "";
  document.getElementById("tpl_procedimiento").value = "GENERICA";
  document.getElementById("tpl_contenido").value =
`CONSENTIMIENTO INFORMADO

Paciente: {{PACIENTE}} - Identificaci√≥n: {{CEDULA}}
Procedimiento: {{PROCEDIMIENTO}}
Profesional: {{PROFESIONAL}}
Fecha: {{FECHA}}

Declaro que he recibido explicaci√≥n clara del procedimiento, beneficios, riesgos, alternativas y consecuencias de no realizarlo.
He podido realizar preguntas y se me han resuelto dudas. Autorizo de manera libre e informada la realizaci√≥n del procedimiento descrito.`;
}

async function cargarPlantillasDesdeSupabase(){
  let tries = 0;
  while (!window.supabase && tries < 40) {
    await new Promise(r => setTimeout(r, 100));
    tries++;
  }
  if (!window.supabase) return;

  try{
    const { data, error } = await window.supabase
      .from("consentimiento_plantillas")
      .select("*")
      .eq("activo", true)
      .order("creado_en", { ascending:false });

    if (error) throw error;

    plantillas = (data || []).map(x => ({
      id: x.id,
      nombre: x.nombre || "",
      procedimiento: (x.procedimiento || "GENERICA").toUpperCase(),
      contenido: x.contenido || "",
      creado_en: x.creado_en || null,
      activo: x.activo !== false
    }));

    renderListaPlantillas();
    poblarSelectPlantillas();
  }catch(e){
    console.warn("‚ùå Error cargando plantillas:", e);
    plantillas = [];
    renderListaPlantillas();
    poblarSelectPlantillas();
  }
}

function renderListaPlantillas(){
  const tbody = document.getElementById("tabla_plantillas");
  const empty = document.getElementById("tpl_empty");
  if (!tbody) return;

  const q = (document.getElementById("tpl_buscar")?.value || "").trim().toUpperCase();

  const lista = (plantillas || []).filter(p => {
    if (!q) return true;
    return (p.nombre || "").toUpperCase().includes(q) || (p.procedimiento || "").toUpperCase().includes(q);
  });

  tbody.innerHTML = "";
  if (!lista.length){
    if (empty) empty.style.display = "block";
    return;
  }
  if (empty) empty.style.display = "none";

  lista.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(p.nombre)}</td>
      <td>${escapeHtml(p.procedimiento)}</td>
      <td style="display:flex; gap:8px; flex-wrap:wrap;">
        <button type="button" class="btn btn-agenda" style="padding:8px 10px; width:auto;"
          onclick="editarPlantillaUI('${escapeHtml(p.id)}')">Editar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function editarPlantillaUI(id){
  const p = (plantillas || []).find(x => String(x.id) === String(id));
  if (!p) return;

  _tplEditId = p.id;
  document.getElementById("tpl_id").value = p.id;
  document.getElementById("tpl_nombre").value = p.nombre || "";
  document.getElementById("tpl_procedimiento").value = p.procedimiento || "GENERICA";
  document.getElementById("tpl_contenido").value = p.contenido || "";
}

async function guardarPlantillaSupabase(){
  const nombre = (document.getElementById("tpl_nombre")?.value || "").trim();
  const procedimiento = (document.getElementById("tpl_procedimiento")?.value || "GENERICA").trim().toUpperCase();
  const contenido = (document.getElementById("tpl_contenido")?.value || "").trim();

  if (!nombre) { alert("‚ö†Ô∏è Falta el nombre de la plantilla."); return; }
  if (!procedimiento) { alert("‚ö†Ô∏è Falta el procedimiento."); return; }
  if (!contenido) { alert("‚ö†Ô∏è El contenido est√° vac√≠o."); return; }

  let tries = 0;
  while (!window.supabase && tries < 40) {
    await new Promise(r => setTimeout(r, 100));
    tries++;
  }
  if (!window.supabase) { alert("Supabase no disponible"); return; }

  const row = {
    id: _tplEditId || undefined,
    nombre,
    procedimiento,
    contenido,
    activo: true
  };

  try{
    const { error } = await window.supabase
      .from("consentimiento_plantillas")
      .upsert(row, { onConflict: "id" });

    if (error) throw error;

    alert("‚úÖ Plantilla guardada.");
    await cargarPlantillasDesdeSupabase();
  }catch(e){
    console.warn("‚ùå Error guardando plantilla:", e);
    alert("‚ùå No se pudo guardar la plantilla.\n\n" + (e?.message || JSON.stringify(e)));
  }
}

async function eliminarPlantillaSupabase(){
  const id = _tplEditId || (document.getElementById("tpl_id")?.value || "").trim();
  if (!id) { alert("‚ö†Ô∏è Selecciona una plantilla primero."); return; }

  const ok = confirm("¬øEliminar esta plantilla?");
  if (!ok) return;

  try{
    const { error } = await window.supabase
      .from("consentimiento_plantillas")
      .update({ activo:false })
      .eq("id", id);

    if (error) throw error;

    alert("‚úÖ Plantilla eliminada.");
    _tplEditId = null;
    nuevaPlantillaUI();
    await cargarPlantillasDesdeSupabase();
  }catch(e){
    console.warn("‚ùå Error eliminando plantilla:", e);
    alert("‚ùå No se pudo eliminar.\n\n" + (e?.message || JSON.stringify(e)));
  }
}

// ‚úÖ Mete plantillas en el select doc_template
function poblarSelectPlantillas(){
  const sel = document.getElementById("doc_template");
  if (!sel) return;

  // Mantener AUTO y GENERICA (por compatibilidad)
  const base = [
    { value:"AUTO", label:"Autom√°tica (seg√∫n procedimiento)" },
    { value:"GENERICA", label:"Gen√©rica" }
  ];

  // Plantillas de Supabase
  const dyn = (plantillas || []).map(p => ({
    value: "TPL:" + p.id,
    label: `${p.nombre} (${p.procedimiento})`
  }));

  sel.innerHTML = base.map(x => `<option value="${escapeHtml(x.value)}">${escapeHtml(x.label)}</option>`).join("")
    + dyn.map(x => `<option value="${escapeHtml(x.value)}">${escapeHtml(x.label)}</option>`).join("");
}

// ‚úÖ Reemplaza variables en contenido
function aplicarVariablesPlantilla(texto){
  const paciente = (document.getElementById("paciente_nombre")?.value || "").trim();
  const cedula   = (document.getElementById("paciente_numdoc")?.value || "").trim();
  const procedimiento = (document.getElementById("doc_procedimiento")?.value || "").trim();
  const profesional   = (document.getElementById("doc_profesional")?.value || "").trim();
  const fecha         = (document.getElementById("doc_fecha")?.value || _hoyISO()).trim();

  return String(texto || "")
    .replaceAll("{{PACIENTE}}", paciente)
    .replaceAll("{{CEDULA}}", cedula)
    .replaceAll("{{PROCEDIMIENTO}}", procedimiento)
    .replaceAll("{{PROFESIONAL}}", profesional)
    .replaceAll("{{FECHA}}", fecha);
}

// ‚úÖ Cuando cambie el select, aplicar plantilla
document.addEventListener("DOMContentLoaded", () => {
  const sel = document.getElementById("doc_template");
  if (sel){
    sel.addEventListener("change", () => {
      aplicarPlantillaSeleccionada();
    });
  }
});

function aplicarPlantillaSeleccionada(){
  const sel = document.getElementById("doc_template");
  if (!sel) return;

  const val = sel.value;

  // AUTO: si quieres, lo dejamos igual que antes (usa GEN√âRICA por defecto)
  if (val === "AUTO"){
    const paciente = (document.getElementById("paciente_nombre")?.value || "").trim();
    const doc = (document.getElementById("paciente_numdoc")?.value || "").trim();
    document.getElementById("doc_texto").value = DOC_TEMPLATES.GENERICA({
      paciente, doc,
      procedimiento: (document.getElementById("doc_procedimiento")?.value || "").trim(),
      profesional: (document.getElementById("doc_profesional")?.value || "").trim(),
      fecha: (document.getElementById("doc_fecha")?.value || _hoyISO()).trim()
    });
    return;
  }

  if (val === "GENERICA"){
    const paciente = (document.getElementById("paciente_nombre")?.value || "").trim();
    const doc = (document.getElementById("paciente_numdoc")?.value || "").trim();
    document.getElementById("doc_texto").value = DOC_TEMPLATES.GENERICA({
      paciente, doc,
      procedimiento: (document.getElementById("doc_procedimiento")?.value || "").trim(),
      profesional: (document.getElementById("doc_profesional")?.value || "").trim(),
      fecha: (document.getElementById("doc_fecha")?.value || _hoyISO()).trim()
    });
    return;
  }

  // Plantilla Supabase
  if (val.startsWith("TPL:")){
    const id = val.slice(4);
    const p = (plantillas || []).find(x => String(x.id) === String(id));
    if (!p) return;
    document.getElementById("doc_texto").value = aplicarVariablesPlantilla(p.contenido);
  }
}

function probarPlantillaEnDocumento(){
  const contenido = (document.getElementById("tpl_contenido")?.value || "").trim();
  if (!contenido) { alert("‚ö†Ô∏è El contenido est√° vac√≠o."); return; }
  document.getElementById("doc_texto").value = aplicarVariablesPlantilla(contenido);
  alert("‚úÖ Plantilla aplicada al documento (campo Texto).");
}

  // Exponer funciones usadas en HTML
  window.buscarHistoria = buscarHistoria;
  window.enviarAN8N = enviarAN8N;
  window.mostrarReporte = mostrarReporte;

  window.nuevoDocumento = nuevoDocumento;
  window.guardarDocumentoSupabase = guardarDocumentoSupabase;
  window.eliminarDocumentoSupabase = eliminarDocumentoSupabase;
  window.verDocumento = verDocumento;
  window.editarDocumento = editarDocumento;
  window.cerrarModalVerDoc = cerrarModalVerDoc;
  window.abrirModalVerDoc = abrirModalVerDoc;
  window.imprimirDocumento = imprimirDocumento;
  window.descargarHTMLDocumento = descargarHTMLDocumento;
  window.limpiarFirmaDocumento = limpiarFirmaDocumento;
  window.cargarDocumentosPacienteDesdeSupabase = cargarDocumentosPacienteDesdeSupabase;
  window.cerrarSesion = cerrarSesion;

  window.agregarEvolucion = agregarEvolucion;
  window.eliminarEvolucion = eliminarEvolucion;
  window.limpiarEvolucionForm = limpiarEvolucionForm;

  window.agregarProfesionalDesdeCampo = agregarProfesionalDesdeCampo;
  window.abrirModalPlantillas = abrirModalPlantillas;
window.cerrarModalPlantillas = cerrarModalPlantillas;
window.nuevaPlantillaUI = nuevaPlantillaUI;
window.editarPlantillaUI = editarPlantillaUI;
window.guardarPlantillaSupabase = guardarPlantillaSupabase;
window.eliminarPlantillaSupabase = eliminarPlantillaSupabase;
window.cargarPlantillasDesdeSupabase = cargarPlantillasDesdeSupabase;
window.probarPlantillaEnDocumento = probarPlantillaEnDocumento;
window.aplicarPlantillaSeleccionada = aplicarPlantillaSeleccionada;

async function capturarOdontogramaPNG(){
  const el = document.getElementById("odontograma-wrapper");
  if (!el || !window.html2canvas) return "";
  const canvas = await html2canvas(el, { scale: 2, backgroundColor: "#ffffff" });
  return canvas.toDataURL("image/png");
}

async function imprimirHistoriaClinica(){
  // Si quieres obligar a que tenga campos m√≠nimos:
  // if (!validarCamposObligatorios()) return;

  // 1) Datos del formulario
  const datos = obtenerDatosHistoriaClinica();

  // 2) Armar odontograma completo (igual a enviarAN8N)
  const todosLosDientes = [
    18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28,
    48,47,46,45,44,43,42,41,31,32,33,34,35,36,37,38
  ];
  const odontogramaCompleto = {};
  todosLosDientes.forEach(num => {
    odontogramaCompleto[num] = { Mesial:"", Distal:"", Oclusal:"", Vestibular:"", Lingual:"", Palatino:"" };
  });
  Object.entries(reporte || {}).forEach(([diente, caras]) => {
    Object.entries(caras).forEach(([cara, preexistencia]) => {
      const region = obtenerRegion(diente, cara);
      if (region) odontogramaCompleto[diente][region] = String(preexistencia || "").toUpperCase();
    });
  });

  // 3) (Opcional) capturar odontograma visual
  const odontogramaImg = await capturarOdontogramaPNG(); // si no instalaste html2canvas, devuelve ""

  // 4) Construir HTML imprimible
  const paciente = (document.getElementById("paciente_nombre")?.value || "").trim();
  const cedula   = (document.getElementById("paciente_numdoc")?.value || "").trim();
  const fechaImp = new Date().toISOString().slice(0,10);

  const html = `
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Historia Cl√≠nica - ${escapeHtml(cedula)}</title>
<style>
  body{ font-family: system-ui, Segoe UI, Arial; color:#111; padding:18px; }
  h1{ margin:0 0 8px; font-size:20px; }
  h2{ margin:18px 0 10px; font-size:16px; }
  h3{ margin:14px 0 8px; font-size:14px; }
  .muted{ color:#666; font-size:12px; }
  .top{ display:flex; justify-content:space-between; gap:16px; align-items:flex-start; }
  .logo{ height:80px; object-fit:contain; }
  .box{ border:1px solid #ddd; border-radius:10px; padding:12px; margin-top:10px; }
  .t{ width:100%; border-collapse:collapse; font-size:12px; }
  .t th,.t td{ border:1px solid #ddd; padding:8px; vertical-align:top; }
  .t thead th{ background:#f3f6fb; }
  .kv .k{ width:240px; font-weight:700; background:#fafafa; }
  img.odon{ width:100%; max-width:900px; border:1px solid #ddd; border-radius:10px; }
  @media print{
    body{ padding:0; }
    .noPrint{ display:none !important; }
    .box{ break-inside:avoid; }
    table{ break-inside:auto; }
    tr{ break-inside:avoid; break-after:auto; }
  }
</style>
</head>
<body>

<div class="top">
  <div>
    <h1>Historia Cl√≠nica Odontol√≥gica</h1>
    <div class="muted">
      Paciente: <b>${escapeHtml(paciente)}</b> &nbsp;|&nbsp;
      Identificaci√≥n: <b>${escapeHtml(cedula)}</b> &nbsp;|&nbsp;
      Fecha impresi√≥n: <b>${escapeHtml(fechaImp)}</b>
    </div>
  </div>
  <img class="logo" src="${LOGO_CLINICA}" alt="Logo">
</div>

<div class="box">
  <h2>Datos b√°sicos</h2>
  <table class="t kv">
    <tbody>
      ${_tableRow("Nombres y apellidos", datos.paciente_nombre)}
      ${_tableRow("Edad", datos.paciente_edad)}
      ${_tableRow("Tipo identificaci√≥n", _siNo(datos.idtipo))}
      ${_tableRow("No. documento", datos.paciente_numdoc)}
      ${_tableRow("Lugar expedici√≥n", datos.paciente_lugardoc)}
      ${_tableRow("Fecha nacimiento", datos.paciente_nacimiento)}
      ${_tableRow("Lugar nacimiento", datos.paciente_lugarnac)}
      ${_tableRow("Direcci√≥n", datos.paciente_direccion)}
      ${_tableRow("Ciudad residencia", datos.Ciudad_de_Residencia)}
      ${_tableRow("EPS", datos.EPS_Paciente)}
      ${_tableRow("Ocupaci√≥n", datos.paciente_ocupacion)}
      ${_tableRow("Tel√©fono", datos.paciente_tel)}
      ${_tableRow("Celular", datos.paciente_cel)}
      ${_tableRow("Correo", datos.paciente_email)}
      ${_tableRow("Estado civil", datos.paciente_estadocivil)}
      ${_tableRow("Hijos", _siNo(datos.hijos))}
    </tbody>
  </table>
</div>

<div class="box">
  <h2>Acudiente</h2>
  <table class="t kv">
    <tbody>
      ${_tableRow("Nombre padre", datos.padre_nombre)}
      ${_tableRow("Tel√©fono padre", datos.padre_tel)}
      ${_tableRow("EPS padre", datos.padre_eps)}
      ${_tableRow("Tipo (padre)", datos.padre_tipo)}
      ${_tableRow("Nombre madre", datos.madre_nombre)}
      ${_tableRow("Tel√©fono madre", datos.madre_tel)}
      ${_tableRow("EPS madre", datos.madre_eps)}
      ${_tableRow("Tipo (madre)", datos.madre_tipo)}
    </tbody>
  </table>
</div>

<div class="box">
  <h2>Emergencia</h2>
  <table class="t kv">
    <tbody>
      ${_tableRow("Nombre", datos.emergencia_nombre)}
      ${_tableRow("Parentesco", datos.emergencia_parentesco)}
      ${_tableRow("Tel√©fono", datos.emergencia_tel)}
      ${_tableRow("Celular", datos.emergencia_cel)}
    </tbody>
  </table>
</div>

<div class="box">
  <h2>Historia m√©dica</h2>
  <table class="t kv">
    <tbody>
      ${_tableRow("Enfermedad grave", _siNo(datos.grave))}
      ${_tableRow("¬øCu√°l?", datos.grave_cual)}
      ${_tableRow("Condiciones", _siNo(datos.condiciones))}
      ${_tableRow("Otra condici√≥n ¬øCu√°l?", datos.otra_cual)}
      ${_tableRow("Coagulaci√≥n", _siNo(datos.coagulacion))}
      ${_tableRow("Anticoagulantes", _siNo(datos.anticoagulantes))}
      ${_tableRow("Toma medicamentos", _siNo(datos.toma_medicamentos))}
      ${_tableRow("Medicamentos ¬øCu√°les?", datos.medicamentos_cuales)}
      ${_tableRow("Dosis y frecuencia", datos.med_dosis)}
      ${_tableRow("Alergia a medicamentos", datos.alergia_meds)}
      ${_tableRow("Alcohol", _siNo(datos.alcohol))}
      ${_tableRow("Fuma", _siNo(datos.fuma))}
      ${_tableRow("Drogas", _siNo(datos.drogas))}
    </tbody>
  </table>
</div>

<div class="box">
  <h2>Historia odontol√≥gica</h2>
  <table class="t kv">
    <tbody>
      ${_tableRow("Motivo consulta", datos.motivo_consulta)}
      ${_tableRow("Dolor", _siNo(datos["dolor[]"]))}
      ${_tableRow("Tratamientos recibidos", _siNo(datos.tratamientos))}
    </tbody>
  </table>
</div>

<div class="box">
  <h2>Odontograma</h2>
  ${odontogramaImg ? `<div style="margin:10px 0;"><img class="odon" src="${odontogramaImg}" alt="Odontograma"></div>` : ""}
  ${_odontogramaToHTML(odontogramaCompleto)}
</div>

<div class="box">
  ${_evolucionesToHTML(evoluciones)}
</div>

<script>
(async function(){
  const imgs = Array.from(document.images || []);
  const waits = imgs.map(img => img.complete ? Promise.resolve() : new Promise(r => { img.onload=r; img.onerror=r; }));
  await Promise.all(waits);
  setTimeout(() => window.print(), 200);
})();
<\/script>

</body></html>
`;

  // 5) Abrir y imprimir
  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
}

window.imprimirHistoriaClinica = imprimirHistoriaClinica;
function _fmt(val){
  if (val === null || val === undefined) return "";
  if (Array.isArray(val)) return val.join(", ");
  return String(val);
}

function _siNo(arr){
  const v = Array.isArray(arr) ? arr.join(", ") : String(arr || "");
  return v || "";
}

function _tableRow(k, v){
  return `<tr><td class="k">${escapeHtml(k)}</td><td>${escapeHtml(_fmt(v))}</td></tr>`;
}

function _odontogramaToHTML(odontogramaCompleto){
  let html = `
    <h3>Odontograma (FDI)</h3>
    <table class="t">
      <thead>
        <tr>
          <th>Diente</th><th>Mesial</th><th>Distal</th><th>Oclusal</th>
          <th>Vestibular</th><th>Lingual</th><th>Palatino</th>
        </tr>
      </thead><tbody>
  `;

  Object.entries(odontogramaCompleto || {}).forEach(([diente, r]) => {
    html += `
      <tr>
        <td>${escapeHtml(diente)}</td>
        <td>${escapeHtml((r.Mesial||"").toUpperCase())}</td>
        <td>${escapeHtml((r.Distal||"").toUpperCase())}</td>
        <td>${escapeHtml((r.Oclusal||"").toUpperCase())}</td>
        <td>${escapeHtml((r.Vestibular||"").toUpperCase())}</td>
        <td>${escapeHtml((r.Lingual||"").toUpperCase())}</td>
        <td>${escapeHtml((r.Palatino||"").toUpperCase())}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  return html;
}

function _evolucionesToHTML(evos){
  const lista = Array.isArray(evos) ? evos : [];
  if (!lista.length) return `<h3>Evoluciones</h3><div class="muted">Sin evoluciones registradas.</div>`;

  let html = `
    <h3>Evoluciones</h3>
    <table class="t">
      <thead>
        <tr>
          <th>Fecha</th><th>Hora</th><th>Profesional</th><th>Procedimiento</th><th>Detalle</th>
        </tr>
      </thead><tbody>
  `;

  lista.forEach(e => {
    const fecha = _soloFechaYYYYMMDD(e.fecha || e.evo_fecha || "");
    const hora  = _soloHoraHHMM(e.hora || e.evo_hora || "");
    html += `
      <tr>
        <td>${escapeHtml(fecha)}</td>
        <td>${escapeHtml(hora)}</td>
        <td>${escapeHtml(String(e.profesional || "").toUpperCase())}</td>
        <td>${escapeHtml(String(e.procedimiento || e.evo_tipo || "").toUpperCase())}</td>
        <td style="white-space:pre-wrap;">${escapeHtml(e.detalle || "")}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  return html;
}
 
</script>
</body>
</html>








