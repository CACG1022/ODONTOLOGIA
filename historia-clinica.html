<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historia Cl√≠nica Odontol√≥gica + Odontograma</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- üîê LOGIN CON SUPABASE -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
    );

    // ‚úÖ Para que cerrarSesion() funcione desde el <script> normal
    window.supabase = supabase;

    async function verificarSesion() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
      }
    }

    verificarSesion();

    supabase.auth.onAuthStateChange((_event, session) => {
      if (!session) {
        window.location.href = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
      }
    });
  </script>

  <style>
    :root{
      --ink:#19324d;
      --muted:#6b7a90;
      --bg:#f6f8fb;
      --card:#ffffff;
      --brand:#2a5d84;
      --gap:18px;
      --radius:14px;
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --line:#e7edf5;
      --input:#cbd5e1;
    }

    *{box-sizing:border-box}
    body{
      margin:0; padding:24px; font-family:system-ui,Segoe UI,Arial; color:var(--ink); background:var(--bg);
    }
    .container{ max-width:1100px; margin:0 auto; }
    h1{ margin:0 0 14px; font-size:28px; color:var(--brand); }
    h2{ font-size:18px; margin:0 0 14px; color:var(--brand); }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:var(--shadow);
      margin-bottom:22px;
    }
    .legend{ font-weight:700; margin-bottom:8px; color:var(--brand); }

    form#historia-form{ margin-bottom:28px; }

    .grid{ display:grid; gap:var(--gap); }
    .g-2{ grid-template-columns:1fr 1fr; }
    .g-3{ grid-template-columns:repeat(3,1fr); }
    .g-4{ grid-template-columns:repeat(4,1fr); }
    .full{ grid-column:1 / -1; }

    .ctrl{ display:flex; flex-direction:column; gap:8px; }
    .ctrl label{ font-size:13px; color:var(--muted); }

    input[type="text"],input[type="email"],input[type="tel"],
    input[type="number"],input[type="date"],input[type="time"], textarea{
      width:100%; border:1px solid var(--input); border-radius:10px; padding:12px;
      font-size:15px; background:#fff;
    }
    select {
     width:100%;
     border:1px solid var(--input);
     border-radius:10px;
     padding:12px;
     font-size:15px;
     background:#fff;
     cursor:pointer;
    }

    textarea{ min-height:120px; resize:vertical; }
    .inline{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:4px 10px;
      border:1px solid var(--line); border-radius:999px; background:#fff;
    }

    .checks{
      display:grid; gap:10px 18px;
      grid-template-columns:repeat(2,minmax(220px,1fr));
      padding-top:10px;
    }
    .check{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px dashed var(--line); border-radius:10px; background:#fafcff;
    }

    .rowline{ height:1px; background:var(--line); margin:12px 0; }

    .botones{ display:flex; gap:10px; margin-bottom:10px; }
    .botones button{
      padding:10px 16px; border-radius:10px; border:1px solid var(--line);
      background:#fff; cursor:pointer;
    }

    @media (max-width:980px){
      .g-4{ grid-template-columns:1fr 1fr; }
      .g-3{ grid-template-columns:1fr 1fr; }
    }
    @media (max-width:680px){
      .g-2,.g-3,.g-4{ grid-template-columns:1fr; }
      .checks{ grid-template-columns:1fr; }
    }

    /* ==========================
       BOTONES DE BUSQUEDA / AGENDA / SALIR
    ============================== */
    .search-grid{ grid-template-columns: 1.2fr 1fr; align-items:end; }
    .btn{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      color:white;
      font-size:14px;
    }
    .btn-buscar{ background:#0D47A1; }
    .btn-agenda{ background:#009688; }
    .btn-salir{ background:#009688; }
    .btn-agendar{ background:#009688; }
    .btn-guardar{ background:#009688; }

    /* =====================================================
       EVOLUCIONES (tabla)
    ===================================================== */
    .tabla-evo{
      width:100%;
      border-collapse:collapse;
    }
    .tabla-evo th,.tabla-evo td{
      padding:10px;
      border:1px solid var(--line);
      vertical-align:top;
    }
    .tabla-evo thead tr{
      background:#eef6ff;
    }

    /* =====================================================
       ESTILOS DEL ODONTOGRAMA
    ===================================================== */
    #odontograma-wrapper * {
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }

    #odontograma-wrapper {
      background: #f9f9f9;
      padding: 20px 0 40px;
      margin-top: 30px;
      border-radius: 14px;
    }

    #odontograma-wrapper h1 {
      text-align: center;
      color: #0D47A1;
      margin-bottom: 10px;
    }

    .odontograma {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 40px;
      position: relative;
      z-index: 10;
      overflow-x: visible !important;
      width: max-content;
      margin: 0 auto;

    }

    .seccion { text-align: center; }
    .etiqueta {
      font-weight: bold;
      color: #0D47A1;
      margin-bottom: 10px;
    }

    .fila {
  display: flex;
  flex-wrap: nowrap;
  justify-content: center;
  gap: var(--tooth-gap);      /* ‚úÖ antes 16px */
  min-width: max-content;
        }

    .contenedor-diente {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .diente {
  position: relative;
  width: var(--tooth-size);   /* ‚úÖ antes 64px */
  height: var(--tooth-size);  /* ‚úÖ antes 64px */
  border-radius: 50%;
  border: 2px solid #ccc;
  background: white;
  overflow: hidden;
}

    .cara {
      position: absolute;
      width: 100%;
      height: 100%;
      cursor: pointer;
      transition: background 0.2s;
      z-index: 1;
    }

    .cara::before,
    .cara::after {
      content: "";
      position: absolute;
      width: 1px;
      height: 100%;
      background: gray;
      left: 50%;
      top: 0;
      z-index: 0;
    }

    .cara::before { transform: rotate(45deg); }
    .cara::after  { transform: rotate(-45deg); }

    .superior { clip-path: polygon(50% 50%, 0% 0%, 100% 0%); }
    .inferior { clip-path: polygon(50% 50%, 0% 100%, 100% 100%); }
    .izquierda { clip-path: polygon(50% 50%, 0% 0%, 0% 100%); }
    .derecha   { clip-path: polygon(50% 50%, 100% 0%, 100% 100%); }

    .centro {
  width: var(--center-size);  /* ‚úÖ antes 24px */
  height: var(--center-size); /* ‚úÖ antes 24px */
  border-radius: 50%;
  border: 1.5px solid gray;
  background: white;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 5;
  cursor: pointer;
}

  .numero {
  font-size: var(--num-size); /* ‚úÖ antes 12px */
  color: #555;
  margin-top: 5px;
}

    .popup {
  position: absolute;
  display: none;
  background: #fff;
  border: 1px solid #ccc;
  padding: 10px;
  z-index: 1000002; /* ‚úÖ m√°s alto que fullscreen */
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  max-height: 250px;
  overflow-y: auto;
}


    .popup div {
      margin: 4px 0;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .color-box {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      display: inline-block;
      margin-right: 4px;
    }

    .leyenda {
      max-width: 1000px;
      margin: 60px auto 20px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .leyenda h2 {
      text-align: center;
      color: #0D47A1;
      margin-bottom: 16px;
    }

    .leyenda-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 8px 16px;
      font-size: 14px;
    }
   /* ====== VOZ POR CAMPO (auto bot√≥n mic al lado) ====== */
.ctrl .input-voz-wrap{
  display:flex;
  gap:10px;
  align-items:center;
}

.btn-mic{
  width:44px;
  min-width:44px;
  height:44px;
  border-radius:10px;
  border:1px solid var(--line);
  background:#fff;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
}

.btn-mic.grabando{
  background:#0D47A1;
  color:#fff;
}
/* ====== VOZ POR CAMPO (auto-inyecta bot√≥n üé§) ====== */
.vwrap{
  position: relative;
  display: flex;
  align-items: center;
  gap: 10px;
}
.vwrap .vfield{
  flex: 1;
}
.vbtn{
  width: 44px;
  min-width: 44px;
  height: 44px;
  border-radius: 10px;
  border: 1px solid var(--line);
  background: #fff;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}
.vbtn.on{
  background: #0D47A1;
  color: #fff;
  border-color: #0D47A1;
}
.vhint{
  margin-top: 6px;
  font-size: 12px;
  color: var(--muted);
}
/* ==========================
   üñ•Ô∏èüîé ODONTOGRAMA FULLSCREEN
========================== */
#odontograma-wrapper.fullscreen{
  position: fixed;
  inset: 0;
  z-index: 99999;
  background: #f9f9f9;
  margin: 0 !important;
  border-radius: 0 !important;
  padding: 10px 10px 25px;
  overflow: auto;
}

/* Cuando est√© en fullscreen, centramos mejor y dejamos scroll horizontal/vertical */
#odontograma-wrapper.fullscreen .odontograma{
  margin-left: 0 !important;
  padding: 10px;
}

/* Bot√≥n flotante para salir (se crea por JS) */
#btnExitOdonFS{
  position: fixed;
  top: 12px;
  right: 12px;
  z-index: 100000;
  border: none;
  border-radius: 12px;
  padding: 10px 14px;
  cursor: pointer;
  background: #0D47A1;
  color: #fff;
  font-weight: 700;
  box-shadow: 0 8px 18px rgba(0,0,0,.18);
}
/* ==========================
   üéØ CENTRAR ODONTOGRAMA EN FULLSCREEN
========================== */
#odontograma-wrapper.fullscreen .odontograma{
  margin-left: auto !important;
  margin-right: auto !important;
  width: max-content;
  min-width: max-content;
}
/* ‚úÖ En fullscreen: solo centramos la caja de gu√≠as */
#odontograma-wrapper.fullscreen #odontograma-guias{
  max-width: none !important;
  width: 1300px !important; /* igual al ancho de la l√≠nea */
  margin: 5px auto 0 !important;
}
  /* ‚úÖ Ajuste fino: tama√±o y separaci√≥n de dientes */
#odontograma-wrapper{
  --tooth-size: 56px;   /* antes 64px */
  --tooth-gap: 10px;    /* antes 16px */
  --num-size: 11px;     /* antes 12px */
  --center-size: 20px;  /* antes 24px */
}
  /* ‚úÖ etiqueta con l√≠nea centrada */
.etiqueta-eje{
  position: relative;
  display: inline-block;
  padding: 0 10px;
}

/* ‚úÖ la l√≠nea vertical azul */
.linea-media{
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  top: 100%;              /* arranca justo debajo del texto */
  width: 3px;
  height: 90px;          /* ajusta si quieres m√°s larga */
  background: #0D47A1;     /* azul */
  z-index: 999999;        /* por encima de todo */
  pointer-events: none;
}

    
  </style>
</head>

<body>
<div class="container">
  <!-- ==========================
       BUSCAR HISTORIA CL√çNICA EXISTENTE
  ============================== -->
  <section class="card">
   <div class="ctrl full">
  <label>üéôÔ∏è Diligenciamiento por voz</label>
  <div class="inline" style="gap:10px;">
    <button type="button" class="btn btn-agenda" onclick="vozStart()">Iniciar voz</button>
    <button type="button" class="btn btn-buscar" onclick="vozStop()">Detener</button>
    <button type="button" class="btn btn-agenda" onclick="vozModo('focus')">Modo: Dictado por foco</button>
    <button type="button" class="btn btn-agenda" onclick="vozModo('cmd')">Modo: Comandos</button>
  </div>
  <small id="voz_estado" style="color:#6b7a90;">Estado: apagado</small>
  <div id="voz_ultima" style="margin-top:6px; font-size:13px; color:#19324d;"></div>
</div>


    
    <div class="legend">Buscar historia cl√≠nica existente</div>

    <div class="grid g-2 search-grid">
      <div class="ctrl">
        <label for="buscar_cedula">Ingrese n√∫mero de identificaci√≥n</label>
        <input id="buscar_cedula" type="text" placeholder="Ej: 10229566001">
      </div>
      <div class="ctrl">
        <label>&nbsp;</label>
        <button type="button" onclick="buscarHistoria()" class="btn btn-buscar">Buscar</button>
      </div>

      <div class="ctrl">
        <button type="button" onclick="cerrarSesion()" class="btn btn-salir">Cerrar sesi√≥n</button>
      </div>
      <div class="ctrl">
        <button type="button" onclick="irAgendamiento()" class="btn btn-agenda">VER AGENDA</button>
      </div>

      <div class="ctrl">
        <button type="button" onclick="enviarAN8N()" class="btn btn-guardar">GUARDAR Y ENVIAR</button>
      </div>
      <div class="ctrl">
        <button type="button" onclick="irAgendar()" class="btn btn-agendar">AGENDAR</button>
      </div>

      <div class="ctrl"></div>
      <div class="ctrl">
        <button type="button" onclick="irPlanTratamiento()" class="btn btn-agenda">PLAN DE TRATAMIENTO</button>
      </div>
    </div>
  </section>

  <h1>Historia Cl√≠nica Odontol√≥gica</h1>

  <!-- ==========================
       DATOS B√ÅSICOS DEL PACIENTE
  ============================== -->
  <section class="card">
    <div class="legend">Datos b√°sicos del paciente</div>
    <div class="grid g-2">

      <div class="ctrl">
        <label for="paciente_nombre">*Nombres y apellidos</label>
        <input id="paciente_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_edad">*Edad</label>
        <input id="paciente_edad" type="number" min="0">
      </div>

      <div class="ctrl full">
        <label>*Identificaci√≥n</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="idtipo" value="CC"> C.C.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="CE"> C.E.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="TI"> T.I.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="RC"> R.C.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="Otro"> Otro</label>
          <span class="hint">Complemente con No. y lugar</span>
        </div>
      </div>

      <div class="ctrl">
        <label for="paciente_numdoc">*No.</label>
        <input
          id="paciente_numdoc"
          type="text"
          inputmode="numeric"
          pattern="[0-9]+"
          required
          oninput="this.value = this.value.replace(/[^0-9]/g, '')"
          placeholder="Solo n√∫meros">
      </div>

      <div class="ctrl">
        <label for="paciente_lugardoc">de</label>
        <input id="paciente_lugardoc" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_nacimiento">*Fecha de nacimiento</label>
        <input id="paciente_nacimiento" type="date">
      </div>

      <div class="ctrl">
        <label for="paciente_lugarnac">Lugar de nacimiento</label>
        <input id="paciente_lugarnac" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_direccion">Direcci√≥n de residencia</label>
        <input id="paciente_direccion" type="text">
      </div>

      <div class="ctrl">
        <label for="Ciudad de Residencia">Ciudad de Residencia</label>
        <input id="Ciudad de Residencia" type="text">
      </div>

      <div class="ctrl">
        <label for="EPS_Paciente">EPS</label>
        <input id="EPS_Paciente" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_ocupacion">Ocupaci√≥n</label>
        <input id="paciente_ocupacion" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_tel">Tel√©fono</label>
        <input id="paciente_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="paciente_ciudad">Ciudad</label>
        <input id="paciente_ciudad" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_cel">Celular</label>
        <input id="paciente_cel" type="tel">
      </div>

      <div class="ctrl">
        <label for="paciente_email">Correo electr√≥nico</label>
        <input id="paciente_email" type="email">
      </div>

      <div class="ctrl">
        <label for="paciente_estadocivil">Estado civil</label>
        <input id="paciente_estadocivil" type="text">
      </div>

      <div class="ctrl">
        <label>Hijos</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="hijos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="hijos" value="No"> No</label>
        </div>
      </div>

    </div>
  </section>

  <!-- ==========================
       DATOS DEL ACUDIENTE
  ============================== -->
  <section class="card">
    <div class="legend">Datos del acudiente</div>

    <div class="grid g-2">

      <div class="ctrl">
        <label for="padre_nombre">Nombre del padre</label>
        <input id="padre_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="madre_nombre">Nombre de la madre</label>
        <input id="madre_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="padre_tel">Tel√©fono padre</label>
        <input id="padre_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="madre_tel">Tel√©fono madre</label>
        <input id="madre_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="padre_eps">E.P.S. padre</label>
        <input id="padre_eps" type="text">
      </div>

      <div class="ctrl">
        <label for="madre_eps">E.P.S. madre</label>
        <input id="madre_eps" type="text">
      </div>

      <div class="ctrl">
        <label for="padre_tipo">Beneficiario / Cotizante (padre)</label>
        <select id="padre_tipo" name="padre_tipo">
          <option value="">Seleccione</option>
          <option value="Beneficiario">Beneficiario</option>
          <option value="Cotizante">Cotizante</option>
        </select>
      </div>

      <div class="ctrl">
        <label for="madre_tipo">Beneficiario / Cotizante (madre)</label>
        <select id="madre_tipo" name="madre_tipo">
          <option value="">Seleccione</option>
          <option value="Beneficiario">Beneficiario</option>
          <option value="Cotizante">Cotizante</option>
        </select>
      </div>

    </div>
  </section>

  <!-- ==========================
       EMERGENCIA
  ============================== -->
  <section class="card">
    <div class="legend">En caso de emergencia avisar a</div>

    <div class="grid g-2">

      <div class="ctrl">
        <label for="emergencia_nombre">Nombres y apellidos</label>
        <input id="emergencia_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="emergencia_parentesco">Parentesco</label>
        <input id="emergencia_parentesco" type="text">
      </div>

      <div class="ctrl">
        <label for="emergencia_tel">Tel√©fono</label>
        <input id="emergencia_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="emergencia_cel">Celular</label>
        <input id="emergencia_cel" type="tel">
      </div>

    </div>
  </section>

  <!-- ==========================
       HISTORIA M√âDICA
  ============================== -->
  <section class="card">
    <div class="legend">Historia m√©dica</div>

    <div class="grid g-2">
      <div class="ctrl">
        <label>¬øEnfermedad grave actualmente o previa?</label>
        <div class="inline">
          <label class="chip">
            <input type="checkbox" name="grave" value="Si"> S√≠
          </label>

          <label class="chip">
            <input type="checkbox" name="grave" value="No"> No
          </label>
        </div>
      </div>

      <div class="ctrl">
        <label for="grave_cual">¬øCu√°l?</label>
        <input id="grave_cual" type="text">
      </div>
    </div>

    <div class="ctrl">
      <label>Condiciones (marque las que apliquen)</label>

      <div class="checks">
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones card√≠acas">Alteraciones card√≠acas</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Asma">Asma</label>
        <label class="check"><input type="checkbox" name="condiciones" value="C√°ncer">C√°ncer</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones vasculares o circulatorias">Alteraciones vasculares o circulatorias</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones psicol√≥gicas o psiqui√°tricas">Alteraciones psicol√≥gicas o psiqui√°tricas</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Enfisema">Enfisema</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Artritis">Artritis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Diabetes">Diabetes</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hepatitis">Hepatitis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Desmayos o convulsiones">Desmayos o convulsiones</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hospitalizaciones">Hospitalizaciones</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hipotiroidismo">Hipotiroidismo</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Fiebre reum√°tica">Fiebre reum√°tica</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hipertiroidismos o hiperparatiroidismo">Hipertiroidismos o hiperparatiroidismo</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Lupus">Lupus</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hipertensi√≥n">Hipertensi√≥n</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Leucemia">Leucemia</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Sinusitis">Sinusitis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Irradiaciones">Irradiaciones</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Problemas renales">Problemas renales</label>
        <label class="check"><input type="checkbox" name="condiciones" value="VIH (Sida)">VIH (Sida)</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Osteoporosis">Osteoporosis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Trauma">Trauma</label>

        <div class="check" style="display:block;">
          <div class="grid g-2">
            <label class="inline">
              <input type="checkbox" name="condiciones" value="Otra">
              Otra
            </label>
            <input id="otra_cual" type="text" name="otra_cual" placeholder="¬øCu√°l?">
          </div>
        </div>

        <label class="check"><input type="checkbox" name="condiciones" value="Tuberculosis">Tuberculosis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones nutricionales">Alteraciones nutricionales</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones del h√≠gado">Alteraciones del h√≠gado</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Anemia">Anemia</label>
      </div>
    </div>

    <div class="rowline"></div>

    <div class="grid g-3">
      <div class="ctrl">
        <label>¬øProblemas de coagulaci√≥n?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="coagulacion" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="coagulacion" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øToma anticoagulantes?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="anticoagulantes" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="anticoagulantes" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øToma medicamentos?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="toma_medicamentos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="toma_medicamentos" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label for="medicamentos_cuales">¬øCu√°les?</label>
        <input id="medicamentos_cuales" type="text">
      </div>

      <div class="ctrl">
        <label for="med_dosis">Dosis y frecuencia</label>
        <input id="med_dosis" type="text">
      </div>

      <div class="ctrl">
        <label for="alergia_meds">Alergia a medicamentos</label>
        <input id="alergia_meds" type="text">
      </div>
    </div>

    <div class="rowline"></div>

    <div class="grid g-2">
      <div class="ctrl">
        <label>¬øToma bebidas alcoh√≥licas?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="alcohol" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="alcohol" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øFuma?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="fuma" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="fuma" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øConsume drogas psicoactivas?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="drogas" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="drogas" value="No"> No</label>
        </div>
      </div>
    </div>
  </section>

  <!-- ==========================
       S√ìLO MUJERES
  ============================== -->
  <section class="card">
    <div class="legend">S√≥lo para mujeres</div>

    <div class="grid g-3">
      <div class="ctrl">
        <label>¬øHa tenido embarazos y partos?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="embarazos_partos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="embarazos_partos" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label for="numero_hijos">No. de hijos</label>
        <input id="numero_hijos" type="number" min="0">
      </div>

      <div class="ctrl">
        <label>¬øActualmente est√° embarazada?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="embarazada" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="embarazada" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label for="tiempo_embarazo">Tiempo</label>
        <input id="tiempo_embarazo" type="text">
      </div>

      <div class="ctrl">
        <label>¬øToma anticonceptivos?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="anticonceptivos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="anticonceptivos" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øHisterectom√≠a o menopausia?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="histerectomia_menopausia" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="histerectomia_menopausia" value="No"> No</label>
        </div>
      </div>
    </div>
  </section>

  <!-- ==========================
       HISTORIA ODONTOL√ìGICA
  ============================== -->
  <section class="card">
    <div class="legend">Historia odontol√≥gica</div>

    <div class="grid g-2">
      <div class="ctrl full">
        <label for="motivo_consulta">Motivo de consulta odontol√≥gica</label>
        <input id="motivo_consulta" type="text">
      </div>

      <div class="ctrl">
        <label>¬øPresenta dolor en‚Ä¶?</label>
        <div class="inline">
          <label class="chip">boca <input type="checkbox" name="dolor[]" value="boca"></label>
          <label class="chip">cara <input type="checkbox" name="dolor[]" value="cara"></label>
          <label class="chip">cuello <input type="checkbox" name="dolor[]" value="cuello"></label>
        </div>
      </div>

      <div class="ctrl full">
        <label>Tratamientos recibidos</label>
        <div class="checks">
          <label class="check"><input type="checkbox" name="tratamientos" value="Ortodoncia"> Ortodoncia</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Periodoncia"> Periodoncia</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Endodoncia"> Endodoncia</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Cirug√≠a maxilofacial"> Cirug√≠a maxilofacial</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Implantes dentales"> Implantes dentales</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Restauraci√≥n oral"> Restauraci√≥n oral</label>
        </div>
      </div>

      <p class="hint full">Abajo est√° el odontograma para marcar preexistencias.</p>
    </div>
  </section>

  <!-- ==========================
       ‚úÖ EVOLUCIONES
  ============================== -->
  <section class="card">
    <div class="legend">Evoluciones (procedimientos realizados)</div>

    <div class="grid g-3">
      <div class="ctrl">
        <label for="evo_fecha">Fecha</label>
        <input id="evo_fecha" type="date" disabled>
      </div>

      <div class="ctrl">
        <label for="evo_hora">Hora</label>
        <input id="evo_hora" type="time" readonly>
      </div>

<div class="ctrl">
  <label for="evo_profesional">Profesional</label>

  <div class="inline" style="gap:10px;">
    <input
      id="evo_profesional"
      type="text"
      list="profesionales_list"
      placeholder="Buscar o escribir profesional..."
      autocomplete="off"
      style="flex:1;"
    />

    <button
      type="button"
      onclick="agregarProfesionalDesdeCampo()"
      class="btn btn-agenda"
      style="width:auto; padding:10px 14px;"
      title="Agregar el texto actual al listado"
    >
      + Agregar
    </button>
  </div>

  <datalist id="profesionales_list"></datalist>
</div>


<div class="ctrl">
  <label for="evo_tipo">Procedimiento</label>

  <div class="inline" style="gap:10px;">
    <!-- ‚úÖ Input con b√∫squeda (datalist) -->
    <input
      id="evo_tipo"
      type="text"
      list="procedimientos_list"
      placeholder="Buscar o escribir procedimiento..."
      autocomplete="off"
      style="flex:1;"
    />

    <!-- ‚úÖ Bot√≥n para agregar si no existe -->
    <button
      type="button"
      onclick="agregarProcedimientoDesdeCampo()"
      class="btn btn-agenda"
      style="width:auto; padding:10px 14px;"
      title="Agregar el texto actual al listado"
    >
      + Agregar
    </button>
  </div>

  <!-- ‚úÖ Datalist (desplegable con b√∫squeda) -->
  <datalist id="procedimientos_list"></datalist>
</div>


      <div class="ctrl full">
        <label for="evo_detalle">Detalle / Observaciones</label>
        <textarea id="evo_detalle" placeholder="Descripci√≥n del procedimiento, piezas intervenidas, materiales, etc."></textarea>
      </div>
    </div>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button type="button" onclick="agregarEvolucion()" class="btn btn-agenda" style="max-width:260px;">
        Agregar evoluci√≥n
      </button>

      <button type="button" onclick="limpiarEvolucionForm()" class="btn btn-buscar" style="max-width:260px;">
        Limpiar
      </button>
    </div>

    <div class="rowline"></div>

    <div style="overflow:auto;">
      <table class="tabla-evo">
        <thead>
          <tr>
            <th>ID Evoluci√≥n</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Profesional</th>
            <th>Procedimiento</th>
            <th>Detalle</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla_evoluciones"></tbody>
      </table>
    </div>
  </section>

  <!-- ==========================
       ODONTOGRAMA COMPLETO
  ============================== -->
  <div id="odontograma-wrapper">
    <h1>Odontograma Internacional FDI</h1>
    <div id="odontograma-guias" style="position:relative; width:100%; max-width:900px; margin:5px auto 0; height:20px;">
      <div style="position:absolute; top:170px; left:50%; transform:translateX(-50%); width:1300px; height:1px; background:#D0D0D0; z-index:3;"></div>
      <div style="position:absolute; top:119px; left:50%; width:1px; height:100px; transform:translateX(-50%); background:#D0D0D0; z-index:3;"></div>

      <div style="position:absolute; top:70px; left:-130px; color:#D0D0D0; font-weight:bold;">Distal1</div>
      <div style="position:absolute; top:70px; right:-130px; color:#D0D0D0; font-weight:bold;">Distal2</div>

      <div style="position:absolute; top:140px; left:20%; transform:translateX(-50%); color:#D0D0D0; font-weight:bold;">Palatino1</div>
      <div style="position:absolute; top:140px; left:83%; transform:translateX(-50%); color:#D0D0D0; font-weight:bold;">Palatino2</div>

      <div style="position:absolute; top:180px; left:20%; transform:translateX(-50%); color:#D0D0D0; font-weight:bold;">Lingual4</div>
      <div style="position:absolute; top:180px; left:83%; transform:translateX(-50%); color:#D0D0D0; font-weight:bold;">Lingual3</div>

      <div style="position:absolute; top:300px; left:83%; transform:translateX(-50%); color:#D0D0D0; font-weight:bold;">Vestibular3</div>
      <div style="position:absolute; top:10px; left:83%; transform:translateX(-50%); color:#D0D0D0; font-weight:bold;">Vestibular2</div>
      <div style="position:absolute; top:10px; left:20%; transform:translateX(-50%); color:#D0D0D0; font-weight:bold;">Vestibular1</div>
      <div style="position:absolute; top:300px; left:20%; transform:translateX(-50%); color:#D0D0D0; font-weight:bold;">Vestibular4</div>

      <div style="position:absolute; top:230px; left:-130px; color:#D0D0D0; font-weight:bold;">Distal4</div>
      <div style="position:absolute; top:230px; right:-130px; color:#D0D0D0; font-weight:bold;">Distal3</div>

      <div style="position:absolute; top:60px; left:50%; transform:translateX(-50%) rotate(180deg); color:#D0D0D0; font-weight:bold; writing-mode:vertical-rl;">Mesial1</div>
      <div style="position:absolute; top:220px; left:50%; transform:translateX(-50%) rotate(180deg); color:#D0D0D0; font-weight:bold; writing-mode:vertical-rl;">Mesial2</div>
    </div>

   <div class="odontograma">

  <!-- MAXILAR SUPERIOR -->
  <div class="seccion">
    <div class="etiqueta etiqueta-eje">
      Maxilar superior
      <span class="linea-media"></span>
    </div>
    <div class="fila" id="fila-superior"></div>
  </div>

  <!-- MAXILAR INFERIOR -->
<div class="seccion">
  <div class="fila" id="fila-inferior"></div>

  <div class="etiqueta etiqueta-eje" style="margin-top:10px;">
    Maxilar inferior
    <span class="linea-media"></span>
  </div>
</div>


</div>

    <div class="leyenda">
      <h2>Leyenda de Preexistencias</h2>
      <div class="leyenda-grid" id="grid-leyenda"></div>
    </div>

    <div style="text-align:center; margin-top:40px;">
      <button onclick="mostrarReporte()" style="padding:10px 20px; background:#0D47A1; color:white; border:none; border-radius:6px; cursor:pointer;">
        Generar reporte de preexistencias
      </button>

      <div style="text-align:center; margin-top:20px;">
        <button onclick="enviarAN8N()" style="padding:10px 20px; background:#009688; color:white; border:none; border-radius:6px; cursor:pointer;">
          Guardar y enviar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- üì§ FORMULARIO OCULTO PARA N8N -->
<form id="formN8N"
  action="https://ftth-n8n2.pzveh5.easypanel.host/webhook/62804cbf-8f21-453b-823e-e5c1b94f31c8"
  method="POST"
  style="display:none;">

  <input type="hidden" id="dataN8N" name="data">
  <input type="hidden" id="usuarioN8N" name="usuario_logueado">
</form>

<script>
  // ==============================
  // CERRAR SESI√ìN + AUTO CIERRE POR INACTIVIDAD (5 min)
  // ==============================
  const LOGIN_URL = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
  const INACTIVIDAD_MS = 5 * 60 * 1000; // 5 minutos

  async function cerrarSesion(motivo = "") {
    try {
      if (window.supabase?.auth?.signOut) {
        await window.supabase.auth.signOut();
      }
    } catch (e) {
      console.warn("Error cerrando sesi√≥n:", e);
    }

    try { localStorage.removeItem("usuario_logueado"); } catch(e) {}

    if (motivo) alert(motivo);
    window.location.href = LOGIN_URL;
  }

  let _timerInactividad = null;
  function _reiniciarTimerInactividad() {
    if (_timerInactividad) clearTimeout(_timerInactividad);
    _timerInactividad = setTimeout(() => {
      cerrarSesion("Tu sesi√≥n se cerr√≥ por inactividad (5 minutos).");
    }, INACTIVIDAD_MS);
  }

  ["click","mousemove","keydown","scroll","touchstart"].forEach(evt => {
    window.addEventListener(evt, _reiniciarTimerInactividad, { passive: true });
  });

  _reiniciarTimerInactividad();

  // ==============================
  // LINKS DE AGENDA
  // ==============================
  const URL_AGENDAMIENTO = "https://calendar.google.com/calendar/u/0?cid=ZHJhbGVpZGlzaWx2YUBnbWFpbC5jb20";
  const URL_AGENDAR = "https://calendar.app.google/kbWJdv1f1TZd9bS36";
  const URL_PLAN_TRATAMIENTO = "https://cacg1022.github.io/ODONTOLOGIA/";

  function irAgendamiento() { window.open(URL_AGENDAMIENTO, "_blank"); }
  function irAgendar() { window.open(URL_AGENDAR, "_blank"); }

  // ‚úÖ Plan de tratamiento: abre la p√°gina y env√≠a la c√©dula del paciente
  function irPlanTratamiento() {
    const cedula = (
      document.getElementById("paciente_numdoc")?.value ||
      document.getElementById("buscar_cedula")?.value ||
      ""
    ).trim();

    if (!cedula) {
      alert("‚ö†Ô∏è Primero ingresa o busca la c√©dula del paciente para abrir el plan de tratamiento.");
      return;
    }

    try { localStorage.setItem("cedula_paciente_plan", cedula); } catch(e) {}

    const url = URL_PLAN_TRATAMIENTO + (URL_PLAN_TRATAMIENTO.includes("?") ? "&" : "?") + "cedula=" + encodeURIComponent(cedula);
    window.open(url, "_blank");
  }

  // ==============================
  // ‚úÖ EVOLUCIONES
  // ==============================
  let evoluciones = [];

  function _uuidFallback() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }
  function generarEvolucionId() {
    try {
      return (crypto && crypto.randomUUID) ? crypto.randomUUID() : _uuidFallback();
    } catch (e) {
      return _uuidFallback();
    }
  }

  function _hoyISO() {
    const d = new Date();
    return d.toISOString().slice(0, 10);
  }
  function _horaHHMM() {
    const d = new Date();
    return String(d.getHours()).padStart(2, "0") + ":" + String(d.getMinutes()).padStart(2, "0");
  }

  function limpiarEvolucionForm() {
    const f = document.getElementById("evo_fecha");
    const h = document.getElementById("evo_hora");
    const p = document.getElementById("evo_profesional");
    const t = document.getElementById("evo_tipo");
    const d = document.getElementById("evo_detalle");

    if (f) f.value = _hoyISO();
    if (h) h.value = _horaHHMM();
    if (p) p.value = "";
    if (t) t.value = "";
    if (d) d.value = "";
  }

async function agregarEvolucion() {
  const fecha = (document.getElementById("evo_fecha").value || _hoyISO()).trim();
  const hora = (document.getElementById("evo_hora").value || _horaHHMM()).trim();
  const profesional = document.getElementById("evo_profesional").value.trim();
  const tipo = document.getElementById("evo_tipo").value.trim();
  const detalle = document.getElementById("evo_detalle").value.trim();

  if (!profesional) { alert("‚ö†Ô∏è Debes ingresar el nombre del profesional."); return; }
  if (!tipo) { alert("‚ö†Ô∏è Debes ingresar el procedimiento."); return; }

  const usuario = localStorage.getItem("usuario_logueado") || "desconocido";
  const cedula = (
    document.getElementById("paciente_numdoc")?.value ||
    document.getElementById("buscar_cedula")?.value ||
    ""
  ).trim();

  if (!cedula) {
    alert("‚ö†Ô∏è Primero debes tener la c√©dula del paciente (buscar o diligenciar identificaci√≥n).");
    return;
  }

  const item = {
    id: generarEvolucionId(),
    fecha,
    hora,
    profesional,
    procedimiento: tipo,
    detalle,
    cedula_paciente: cedula,
    usuario,
    ts: new Date().toISOString()
  };

  // ‚úÖ 1) Guarda local (no se pierde)
  evoluciones.unshift(item);
  renderEvoluciones();
  limpiarEvolucionForm();

  // ‚úÖ 2) Enviar a n8n (SIN recargar, SIN abrir otra pesta√±a)
  try {
    const url = "https://ftth-n8n2.pzveh5.easypanel.host/webhook/569051e4-4bdf-44e9-b0d3-34694d6077e9";

    const payload = {
      evento: "agregar_evolucion",
      cedula: cedula,
      evolucion: item,
      fecha_envio: new Date().toISOString(),
      usuario_logueado: usuario
    };

    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!resp.ok) throw new Error("HTTP " + resp.status);

    // opcional: si n8n responde json
    // const data = await resp.json();

    console.log("‚úÖ Evoluci√≥n enviada a n8n");
    // alert("‚úÖ Evoluci√≥n guardada y enviada a n8n");
  } catch (err) {
    console.warn("‚ö†Ô∏è Evoluci√≥n guardada pero NO se pudo enviar a n8n:", err);
    alert("‚ö†Ô∏è Evoluci√≥n guardada, pero no se pudo enviar a n8n. Verifica conexi√≥n o webhook.");
  }
}


  function eliminarEvolucion(idx) {
    evoluciones.splice(idx, 1);
    renderEvoluciones();
  }

  function _soloFechaYYYYMMDD(valor) {
    if (!valor) return "";
    // si viene timestamp "2025-12-22T00:00:00+00:00" -> "2025-12-22"
    if (typeof valor === "string" && valor.includes("T")) return valor.split("T")[0];
    return String(valor);
  }

  function _soloHoraHHMM(valor) {
    if (!valor) return "";
    // si viene "18:25:00" -> "18:25"
    const s = String(valor);
    if (/^\d{2}:\d{2}:\d{2}/.test(s)) return s.slice(0,5);
    return s;
  }

  function renderEvoluciones() {
    const tbody = document.getElementById("tabla_evoluciones");
    if (!tbody) return;

    tbody.innerHTML = "";

    evoluciones.forEach((evo, idx) => {
      const tr = document.createElement("tr");

      const idEvo = evo.id_evolucion ?? evo["id-evolucion"] ?? evo.id ?? "";
      const fecha = _soloFechaYYYYMMDD(evo.fecha ?? evo.evo_fecha);
      const hora  = _soloHoraHHMM(evo.hora ?? evo.evo_hora);
      const profesional = evo.profesional ?? evo.evo_profesional ?? "";
      const procedimiento = evo.procedimiento ?? evo.evo_tipo ?? "";
      const detalle = evo.detalle ?? evo.evo_detalle ?? "";

      tr.innerHTML = `
        <td style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;">
          ${idEvo}
        </td>
        <td>${fecha}</td>
        <td>${hora}</td>
        <td>${String(profesional).toUpperCase()}</td>
        <td>${String(procedimiento).toUpperCase()}</td>
        <td style="white-space:pre-wrap;">${detalle}</td>
        <td>
          <button type="button" class="btn btn-buscar" style="padding:8px 10px; width:auto;" onclick="eliminarEvolucion(${idx})">
            Eliminar
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ‚úÖ Normaliza lo que venga del webhook a un array est√°ndar
  function normalizarEvolucionesDeWebhook(data) {
    let raw = data?.evoluciones;

    // Caso: viene anidado { evoluciones: [...] }
    if (raw && !Array.isArray(raw) && typeof raw === "object" && Array.isArray(raw.evoluciones)) {
      raw = raw.evoluciones;
    }

    // Caso: viene string JSON
    if (typeof raw === "string") {
      try { raw = JSON.parse(raw); } catch(e) { raw = []; }
    }

    if (!Array.isArray(raw)) raw = [];

    // Normalizamos llaves y formatos
    return raw.map((e) => ({
      // id √∫nico: prioriza id-evolucion / id_evolucion, si no existe usa id, si no existe genera uuid
      id: e.id_evolucion ?? e["id-evolucion"] ?? e.id ?? generarEvolucionId(),

      fecha: _soloFechaYYYYMMDD(e.fecha ?? e.evo_fecha),
      hora: _soloHoraHHMM(e.hora ?? e.evo_hora),

      profesional: e.profesional ?? e.evo_profesional ?? "",
      procedimiento: e.procedimiento ?? e.evo_tipo ?? "",
      detalle: e.detalle ?? e.evo_detalle ?? "",

      // extras si vienen
      created_at: e.created_at ?? null,
      ts: e.ts ?? e.created_at ?? new Date().toISOString()
    }));
  }

  document.addEventListener("DOMContentLoaded", () => {
    if (document.getElementById("evo_fecha")) {
      limpiarEvolucionForm();
      renderEvoluciones();
    }
  });

  // ==============================
  // ODONTOGRAMA
  // ==============================
  const preexistencias = {
    Caries: 'red',
    Corona: 'blue',
    Endodoncia: '#005E94',
    Obturaci√≥n: 'green',
    Fractura: 'orange',
    Ausente: '#c3c5c7',
    Implante: '#7eff42',
    "Extracci√≥n indicada": '#333',
    Exodoncia: '#ff38ef',
    P√≥ntico: 'cyan',
    "Movilidad dental": 'pink',
    Retenido: 'purple',
    "Pr√≥tesis fija": '#880E4F',
    "Pr√≥tesis removible": '#42ffc6',
    "Pr√≥tesis total": '#fff642',
    Amalgama: '#42b7ff',
    Resina: '#FBC02D',
    Sano: '#8BC34A'
  };

  let reporte = {};

  const contenedorLeyenda = document.getElementById('grid-leyenda');
  Object.entries(preexistencias).forEach(([nombre, color]) => {
    const item = document.createElement('div');
    item.innerHTML = `<span class="color-box" style="background:${color}; border:1px solid #444;"></span>${nombre}`;
    contenedorLeyenda.appendChild(item);
  });

  const dientesSuperior = [18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28];
  const dientesInferior = [48,47,46,45,44,43,42,41,31,32,33,34,35,36,37,38];

  function crearDiente(numero, contenedor) {
    const contenedorDiente = document.createElement('div');
    contenedorDiente.className = 'contenedor-diente';

    const diente = document.createElement('div');
    diente.className = 'diente';
    diente.dataset.numero = numero;

    ['superior','inferior','izquierda','derecha'].forEach(region => {
      const div = document.createElement('div');
      div.className = `cara ${region}`;
      div.dataset.region = region;
      div.onclick = (event) => mostrarPopup(event, div);
      diente.appendChild(div);
    });

    const centro = document.createElement('div');
    centro.className = 'centro';
    centro.dataset.region = 'centro';
    centro.onclick = (event) => mostrarPopup(event, centro);
    diente.appendChild(centro);

    const label = document.createElement('div');
    label.className = 'numero';
    label.textContent = numero;

    contenedorDiente.appendChild(diente);
    contenedorDiente.appendChild(label);
    contenedor.appendChild(contenedorDiente);
  }

  function mostrarPopup(event, elemento) {
    event.stopPropagation();
    document.querySelectorAll('.popup').forEach(p => p.remove());

    const menu = document.createElement('div');
    menu.className = 'popup';

    const limpiar = document.createElement('div');
    limpiar.innerHTML = `<span class='color-box' style="background:white; border:1px solid #444;"></span> Limpiar`;

    limpiar.onclick = () => {
      elemento.style.background = "white";

      const dienteNumero = elemento.parentElement.dataset.numero;
      const cara = elemento.dataset.region;

      if (reporte[dienteNumero] && reporte[dienteNumero][cara]) {
        delete reporte[dienteNumero][cara];
      }

      if (reporte[dienteNumero] && Object.keys(reporte[dienteNumero]).length === 0) {
        delete reporte[dienteNumero];
      }

      menu.remove();
    };

    menu.appendChild(limpiar);

    Object.entries(preexistencias).forEach(([nombre, color]) => {
      const item = document.createElement('div');
      item.innerHTML = `<span class='color-box' style="background:${color}; border:1px solid #444;"></span>${nombre}`;

      item.onclick = () => {
        const dienteNumero = elemento.parentElement.dataset.numero;
        const cara = elemento.dataset.region;

        if (!reporte[dienteNumero]) reporte[dienteNumero] = {};

        if (nombre === "Sano" || nombre === "Ausente") {
          elemento.parentElement.querySelectorAll(".cara, .centro")
            .forEach(c => c.style.background = preexistencias[nombre]);

          ["superior","inferior","izquierda","derecha","centro"].forEach(c => {
            reporte[dienteNumero][c] = nombre;
          });
        } else {
          elemento.style.background = color;
          reporte[dienteNumero][cara] = nombre;
        }

        menu.remove();
      };

      menu.appendChild(item);
    });

    document.body.appendChild(menu);
    menu.style.left = `${event.pageX + 5}px`;
    menu.style.top  = `${event.pageY + 5}px`;
    menu.style.display = 'block';
  }

  const filaSuperior = document.getElementById('fila-superior');
  dientesSuperior.forEach(num => crearDiente(num, filaSuperior));

  const filaInferior = document.getElementById('fila-inferior');
  dientesInferior.forEach(num => crearDiente(num, filaInferior));

  document.body.addEventListener('click', () => {
    document.querySelectorAll('.popup').forEach(p => p.remove());
  });

  function obtenerRegion(diente, cara) {
    diente = parseInt(diente);
    if (cara === "centro") return "Oclusal";

    if (diente >= 11 && diente <= 28) {
      if (cara === "superior") return "Vestibular";
      if (cara === "inferior") return "Palatino";
    }

    if (diente >= 31 && diente <= 48) {
      if (cara === "superior") return "Lingual";
      if (cara === "inferior") return "Vestibular";
    }

    const derechaEsMesial = (
      (diente >= 11 && diente <= 18) ||
      (diente >= 41 && diente <= 48)
    );

    if (cara === "derecha") return derechaEsMesial ? "Mesial" : "Distal";
    if (cara === "izquierda") return derechaEsMesial ? "Distal" : "Mesial";
    return null;
  }

  function mostrarReporte() {
    let html = `
      <h2>Reporte de Preexistencias</h2>
      <table border="1" cellpadding="6" style="border-collapse:collapse; margin:20px auto; width:95%; text-align:center;">
        <tr style="background:#eee; font-weight:bold;">
          <th>Diente</th>
          <th>Mesial</th>
          <th>Distal</th>
          <th>Oclusal</th>
          <th>Vestibular</th>
          <th>Lingual</th>
          <th>Palatino</th>
        </tr>
    `;

    Object.entries(reporte).forEach(([diente, caras]) => {
      let fila = { Mesial:"", Distal:"", Oclusal:"", Vestibular:"", Lingual:"", Palatino:"" };

      Object.entries(caras).forEach(([cara, preexistencia]) => {
        let region = obtenerRegion(diente, cara);
        if (region) fila[region] = preexistencia.toUpperCase();
      });

      html += `
        <tr>
          <td>${diente}</td>
          <td>${fila.Mesial}</td>
          <td>${fila.Distal}</td>
          <td>${fila.Oclusal}</td>
          <td>${fila.Vestibular}</td>
          <td>${fila.Lingual}</td>
          <td>${fila.Palatino}</td>
        </tr>
      `;
    });

    html += "</table>";

    const win = window.open("", "_blank");
    win.document.write(html);
    win.document.close();
  }

  function obtenerDatosHistoriaClinica() {
    const data = {};
    document.querySelectorAll(".container input, .container textarea, .container select")
      .forEach(campo => {
        const nombre = campo.id || campo.name;
        if (!nombre) return;

        if (campo.type === "checkbox") {
          if (!data[nombre]) data[nombre] = [];
          if (campo.checked) data[nombre].push(campo.value || true);
        } else {
          data[nombre] = campo.value;
        }
      });
    return data;
  }

  function validarCamposObligatorios() {
    const errores = [];

    const nombre = document.getElementById("paciente_nombre").value.trim();
    if (!nombre) errores.push("Nombres y apellidos");

    const edad = document.getElementById("paciente_edad").value;
    if (!edad) errores.push("Edad");

    const tipoID = document.querySelectorAll("input[name='idtipo']:checked");
    if (tipoID.length === 0) errores.push("Tipo de identificaci√≥n");

    const numDoc = document.getElementById("paciente_numdoc").value.trim();
    if (!numDoc) errores.push("N√∫mero de identificaci√≥n");

    const fechaNac = document.getElementById("paciente_nacimiento").value;
    if (!fechaNac) errores.push("Fecha de nacimiento");

    if (!reporte || Object.keys(reporte).length === 0) {
      errores.push("Odontograma (debe marcar al menos un diente)");
    }

    if (errores.length > 0) {
      alert(
        "‚ö†Ô∏è No se puede enviar la historia cl√≠nica.\n\n" +
        "Faltan los siguientes campos obligatorios:\n\n" +
        errores.map(e => "‚Ä¢ " + e).join("\n")
      );
      return false;
    }

    return true;
  }

  function enviarAN8N() {
    if (!validarCamposObligatorios()) return;

    const todosLosDientes = [
      18,17,16,15,14,13,12,11,
      21,22,23,24,25,26,27,28,
      48,47,46,45,44,43,42,41,
      31,32,33,34,35,36,37,38
    ];

    const odontogramaCompleto = {};
    todosLosDientes.forEach(num => {
      odontogramaCompleto[num] = { Mesial:"", Distal:"", Oclusal:"", Vestibular:"", Lingual:"", Palatino:"" };
    });

    Object.entries(reporte).forEach(([diente, caras]) => {
      Object.entries(caras).forEach(([cara, preexistencia]) => {
        const region = obtenerRegion(diente, cara);
        if (region) odontogramaCompleto[diente][region] = preexistencia.toUpperCase();
      });
    });

    const datosHistoria = obtenerDatosHistoriaClinica();
    const usuario = localStorage.getItem("usuario_logueado") || "desconocido";

    document.getElementById("usuarioN8N").value = usuario;

    const payload = {
      historia_clinica: datosHistoria,
      odontograma: odontogramaCompleto,
      evoluciones: evoluciones,
      fecha_envio: new Date().toISOString(),
      usuario_logueado: usuario
    };

    document.getElementById("dataN8N").value = JSON.stringify(payload);
    document.getElementById("formN8N").submit();

    alert("Informaci√≥n enviada correctamente a N8N");
  }

  // ==============================
  // ‚úÖ BUSCAR HISTORIA (ahora tambi√©n carga evoluciones SIEMPRE)
  // ==============================
  async function buscarHistoria() {
    const cedula = document.getElementById("buscar_cedula").value.trim();

    if (!cedula) {
      alert("Ingrese una c√©dula");
      return;
    }

    const url = `https://ftth-n8n2.pzveh5.easypanel.host/webhook/62804cbf-8f21-453b-823e-e5c1b94f31c8?cedula=${cedula}`;

    try {
      const resp = await fetch(url);
      const data = await resp.json();

      if (!data.existe) {
        evoluciones = [];
        renderEvoluciones();
        alert("No existe historia cl√≠nica para este paciente");
        return;
      }

      const h = data.historia || {};
      const od = data.odontograma || {};

      // ‚úÖ CARGA + NORMALIZA EVOLUCIONES AQU√ç
      evoluciones = normalizarEvolucionesDeWebhook(data);
      renderEvoluciones();

      document.getElementById("paciente_nombre").value = h["Nombre y apellido"] ?? "";
      document.getElementById("paciente_edad").value = h["Edad"] ?? "";
      document.getElementById("paciente_numdoc").value = data.id ?? "";
      document.getElementById("paciente_lugardoc").value = h["Lugar exp"] ?? "";
      document.getElementById("paciente_nacimiento").value = h["Fecha de nacimiento"] ?? "";
      document.getElementById("paciente_lugarnac").value = h["Lugar de nacimiento"] ?? "";
      document.getElementById("paciente_direccion").value = h["paciente_direccion"] ?? "";
      document.getElementById("Ciudad de Residencia").value = h["Ciudad_de_Residencia"] ?? "";
      document.getElementById("EPS_Paciente").value = h["EPS_Paciente"] ?? "";
      document.getElementById("paciente_ocupacion").value = h["paciente_ocupacion"] ?? "";
      document.getElementById("paciente_tel").value = h["paciente_tel"] ?? "";
      document.getElementById("paciente_ciudad").value = h["paciente_ciudad"] ?? "";
      document.getElementById("paciente_cel").value = h["paciente_cel"] ?? "";
      document.getElementById("paciente_email").value = h["paciente_email"] ?? "";
      document.getElementById("paciente_estadocivil").value = h["paciente_estadocivil"] ?? "";
      document.getElementById("padre_tipo").value = h["padre_tipo"] ?? "";
      document.getElementById("madre_tipo").value = h["madre_tipo"] ?? "";

      let tiposID = [];
      try { tiposID = JSON.parse(h["Tipo identificaci√≥n"] || "[]"); } catch(e) { tiposID = []; }
      document.querySelectorAll("input[name='idtipo']").forEach(c => { c.checked = tiposID.includes(c.value); });

      let hijos = [];
      try { hijos = JSON.parse(h["paciente_hijos"] || "[]"); } catch(e) { hijos = []; }
      document.querySelectorAll("input[name='hijos']").forEach(c => { c.checked = hijos.includes(c.value); });

      document.getElementById("padre_nombre").value = h["Nombre padre"] ?? "";
      document.getElementById("madre_nombre").value = h["Nombre madre"] ?? "";
      document.getElementById("padre_tel").value = h["Tel√©fono padre"] ?? "";
      document.getElementById("madre_tel").value = h["Tel√©fono madre"] ?? "";
      document.getElementById("padre_eps").value = h["EPS padre"] ?? "";
      document.getElementById("madre_eps").value = h["EPS madre"] ?? "";

      document.getElementById("emergencia_nombre").value = h["Emergencia nombre"] ?? "";
      document.getElementById("emergencia_parentesco").value = h["Emergencia parentesco"] ?? "";
      document.getElementById("emergencia_tel").value = h["Emergencia tel√©fono"] ?? "";
      document.getElementById("emergencia_cel").value = h["Emergencia celular"] ?? "";

      document.querySelectorAll("input[name='grave']").forEach(c => { c.checked = (h["Enfermedad grave"] ?? []).includes(c.value); });
      document.getElementById("grave_cual").value = h["Enfermedad grave cu√°l"] ?? "";
      document.getElementById("otra_cual").value = h["Otra condici√≥n cu√°l"] ?? "";
      document.getElementById("medicamentos_cuales").value = h["Medicamentos cu√°les"] ?? "";
      document.getElementById("med_dosis").value = h["Medicamentos dosis"] ?? "";
      document.getElementById("alergia_meds").value = h["Alergias medicamentos"] ?? "";

      document.getElementById("numero_hijos").value = h["N√∫mero hijos"] ?? "";
      document.getElementById("tiempo_embarazo").value = h["Tiempo embarazo"] ?? "";

      let condiciones = [];
      try { condiciones = JSON.parse(h["Condiciones"] || "[]"); } catch(e) { condiciones = []; }
      document.querySelectorAll("input[name='condiciones']").forEach(c => { c.checked = condiciones.includes(c.value); });

      let coagulacion = [];
      try { coagulacion = JSON.parse(h["coagulacion"] || "[]"); } catch(e) { coagulacion = []; }
      document.querySelectorAll("input[name='coagulacion']").forEach(c => { c.checked = coagulacion.includes(c.value); });

      let anticoagulantes = [];
      try { anticoagulantes = JSON.parse(h["anticoagulantes"] || "[]"); } catch(e) { anticoagulantes = []; }
      document.querySelectorAll("input[name='anticoagulantes']").forEach(c => { c.checked = anticoagulantes.includes(c.value); });

      let toma_medicamentos = [];
      try { toma_medicamentos = JSON.parse(h["toma_medicamentos"] || "[]"); } catch(e) { toma_medicamentos = []; }
      document.querySelectorAll("input[name='toma_medicamentos']").forEach(c => { c.checked = toma_medicamentos.includes(c.value); });

      let alcohol = [];
      try { alcohol = JSON.parse(h["alcohol"] || "[]"); } catch(e) { alcohol = []; }
      document.querySelectorAll("input[name='alcohol']").forEach(c => { c.checked = alcohol.includes(c.value); });

      let fuma = [];
      try { fuma = JSON.parse(h["fuma"] || "[]"); } catch(e) { fuma = []; }
      document.querySelectorAll("input[name='fuma']").forEach(c => { c.checked = fuma.includes(c.value); });

      let dolor = [];
      try {
        let raw = h["dolor"];
        if (Array.isArray(raw)) dolor = raw;
        else if (typeof raw === "string") {
          raw = raw.replace(/\\"/g, '"');
          dolor = JSON.parse(raw);
        }
      } catch(e) { dolor = []; }

      document.querySelectorAll("input[name='dolor[]']").forEach(c => {
        c.checked = dolor.includes(c.value);
      });

      document.getElementById("motivo_consulta").value = h["Motivo consulta"] ?? "";
      document.querySelectorAll("input[name='tratamientos']").forEach(c => {
        c.checked = (h["Tratamientos"] ?? []).includes(c.value);
      });

      document.querySelectorAll(".cara, .centro").forEach(c => c.style.background = "white");
      reporte = {};

      Object.entries(od).forEach(([diente, regiones]) => {
        Object.entries(regiones).forEach(([region, estado]) => {
          if (!estado) return;

          const estadoNormalizado =
            estado.charAt(0).toUpperCase() + estado.slice(1).toLowerCase();

          const color = preexistencias[estadoNormalizado];
          if (!color) return;

          let cara = null;

          switch(region) {
            case "Mesial":     cara = "derecha"; break;
            case "Distal":     cara = "izquierda"; break;
            case "Oclusal":    cara = "centro"; break;
            case "Vestibular":
              cara = (diente >= 11 && diente <= 28) ? "superior" : "inferior";
              break;
            case "Lingual":    cara = "superior"; break;
            case "Palatino":   cara = "inferior"; break;
          }

          if (!cara) return;

          const selector = `.diente[data-numero='${diente}'] .${cara}`;
          const elem = document.querySelector(selector);
          if (!elem) return;

          elem.style.background = color;

          if (!reporte[diente]) reporte[diente] = {};
          reporte[diente][cara] = estadoNormalizado;
        });
      });

      alert("Historia cl√≠nica cargada con √©xito");

    } catch (err) {
      console.error(err);
      alert("Error consultando N8N");
    }
  }
// ==============================
// ‚úÖ PROCEDIMIENTOS (desplegable con b√∫squeda + agregar)
// ==============================

// Lista base (√∫nicos). Puedes agregar m√°s si luego te faltan.
const PROCEDIMIENTOS_BASE = [
  "ACLARACION",
  "ACLARAMIENTO DENTAL ACTIVADO CON LUZ",
  "ACLARAMIENTO DENTAL CON CUBETAS",
  "ACLARAMIENTO INTERNO",
  "ALARGAMIENTO CORONAL",
  "ALARGAMIENTO CORONAL POR DIENTE",
  "ALISADO RADICULAR",
  "AMPLIACION",
  "CAJA DE RETENEDORES √ì PLACA",
  "CAMBIO DE TORNILLOS PASANTES DE 44 Y 46",
  "CANCELA CITA",
  "CAUCHOS DE RETENCION",
  "CEMENTACI√ìN",
  "CEMENTACION CARILLAS",
  "CEMENTACI√ìN CORONA METAL-CERAMICA",
  "CEMENTACI√ìN CORONA ZIRCONIO",
  "CEMENTACI√ìN DE INCRUSTACI√ìN",
  "CEMENTACI√ìN DE NUCLEO COLADO",
  "CEMENTACI√ìN INCRUSTACI√ìN",
  "CEMENTACI√ìN POSTE FIBRA DE VIDRIO",
  "CIRUG√çA DE IMPLANTE",
  "CIRUGIA ENDODONTICA",
  "CIRUG√çA EXPLORATORIA",
  "CITA INCUMPLIDA",
  "CITA MAL AGENDADA",
  "CITA MODIFICADA POR PACIENTE",
  "COLOCACION DE IMPLANTE",
  "COLOCACI√ìN DE MINI IMPLANTE",
  "COLOCACION DE MINI IMPLANTE ORTODONTICO",
  "CONSULTA PERIODONCIA",
  "CONTRAREMISION",
  "CONTROL",
  "CONTROL CORONA SOBRE IMPLANTE",
  "CONTROL DE ORTOPEDIA N¬∞ 3",
  "CONTROL DE REHABILITACI√ìN",
  "CONTROL DE RESINA",
  "CONTROL DE RETENEDORES",
  "CONTROL DE RETENEDOR",
  "CONTROL ORTODONCIA",
  "CONTROL PERIODONTAL",
  "CORONA 16",
  "CORONA IMPLANTOSOPORTADA PRUEBA",
  "CORRECCI√ìN",
  "CU√ëA DISTAL",
  "DEBRIDAMIENTO",
  "DEBRIDAMIENTO QUIRURGICO",
  "DESOBTURACION ENDODONTICA",
  "DETARTRAJE DE 4 CUADRANTES Y PROFILAXIS",
  "ELASTICOS",
  "ELEVACION SENO MAXILAR",
  "ENDODONCIA",
  "ENDODONCIA MULTIRRADICULAR",
  "ENTREGA APARATO ORTOPEDIA",
  "ENTREGA APARATOS ORTOPEDIA",
  "ENTREGA CARILLAS DISILICATO DE LITIO",
  "ENTREGA CORONA IMPLANTOSOPORTADA",
  "ENTREGA CORONA METAL PORCELANA",
  "ENTREGA CORONA ZIRCONIO",
  "ENTREGA DE APARATOLOGIA",
  "ENTREGA DE CORONA IMPLANTOSOPORTADA 26",
  "ENTREGA DE CORONA METAL-CER√ÅMICA DEL 26",
  "ENTREGA DE KIT DE HIGIENE",
  "ENTREGA DE PACIENTES",
  "ENTREGA DE PLACA NMR",
  "ENTREGA DE PROVISIONALES",
  "ENTREGA DE RETENEDOR",
  "ENTREGA DE TEMPORL",
  "ENTREGA KIT DE ORTODONCIA",
  "ENTREGA MUCOSOPORTADA",
  "ENTREGA PPF METAL CER√ÅMICA",
  "ENTREGA PROTESIS INMEDIATA",
  "ENTREGA PROTESIS TOTAL",
  "ENTREGA REHABILITACION ORAL",
  "ERROR DE EVOLUCION",
  "EXODONCIA",
  "EXODONCIA METODO ABIERTO DE 37 Y 47",
  "EXODONCIA METODO CERRADO ALTA Y MEDIO",
  "EXODONCIA SIMPLE",
  "EXPLANTE (RETIRO DE IMPLANTE)",
  "FASE HIGIENICA",
  "FASE HIGIENICA PERIODONTAL",
  "FASE HIGIENICA POR HIGIENISTA ORAL",
  "FASE HIGIENICA Y RESINA",
  "FERULIZACION",
  "FINAL",
  "FRENILLECTOMIA",
  "GARANTIA DE BRACKET",
  "GINGIVECTOMIA POR DIENTE",
  "GINGIVECTOMIA POR SEXTANTE",
  "HUESO MISS 0.5",
  "IMPRESI√ìN DEFINITIVA",
  "IMPRESION PARA ORTOPEDIA",
  "IMPRESI√ìN PRELIMINAR",
  "INJERTO DE TEJIDO CONECTIVO",
  "LIMPIEZA DENTAL",
  "LLEGA TARDE 15 MIN SE REPROGRAMA CITA",
  "MANTENIMIENTO PERIODONTAL IMPLANTE",
  "MONTAJE INFERIOR",
  "MONTAJE SUPERIOR",
  "MONTAJE SUPERIOR E INFERIOR",
  "NO ASISTENCIA",
  "NO ASISTENCIA A CONTROL DE ORTODONCIA",
  "NO ASISTI√ì",
  "OBTURACION",
  "OBTURACION EN RESINA",
  "ORIENTACI√ìN DE RODETE",
  "ORIENTACI√ìN DE RODETES Y TOMA DE COLOR",
  "ORTODONCIA INVISIBLE",
  "PACIENTE AGENDADO POR ERROR",
  "PACIENTE CON CONVENIO- COMPENSAR",
  "PACIENTE LLEGA TARDE A CITA PROGRAMADA",
  "PACIENTE NO ASISTE A CONSULTA",
  "PACIENTE NO ASISTE A LA CITA",
  "PACK FASE HIGIENICA",
  "PANORAMICA DE CONTROL ESPECIALISTA",
  "PANORAMICA PRIMERA VEZ",
  "PANORAMICA REEVALUACION",
  "PAQUETE DE FINALIZACION ORTODONCIA",
  "PAQUETE INCIAL DE ORTODONCIA",
  "PATRON DE NUCLEO",
  "PEDIDO REHABILITACI√ìN",
  "POSTE EN FIBRA DE VIDRIO",
  "PROFILAXIS",
  "PROTESIS",
  "PR√ìTESIS FLEXIDENT SUPERIOR",
  "PROVISIONAL",
  "PROVISIONAL EN CONSULTORIO",
  "PRUEBA COFIAS EN METAL",
  "PRUEBA DE CERAMICA SOBRE IMPLANTE",
  "PRUEBA DE COFIA EN PATTERN RESIN",
  "PRUEBA DE COFIA EN ZIRCONIO",
  "PRUEBA DE ENFILADO",
  "PRUEBA DE ESTRUCTURA",
  "PRUEBA DE REHABILITACI√ìN",
  "PRUEBA DE RODETE",
  "PRUEBA METALICA SOBRE IMPLANTE",
  "PULPECTOMIA",
  "SEGUNDA FASE IMPLANTE",
  "SEGUNDA FASE QUIR√öRGICA",
  "SELLANTES",
  "TERAPIA DE MANTENIMIENTO PERIODONTAL",
  "TERAPIA ENDODONTICA",
  "TOMA DE IMPRESION",
  "TOMA DE IMPRESIONES",
  "URGENCIA",
  "URGENCIA ORTODONCIA",
  "VALORACION",
  "VALORACION ASEGURADORA",
  "VALORACION CLINICA Y RADIOGRAFICA",
  "VALORACION ENDODONCIA",
  "VALORACION MAS RADIOGRAFIA",
  "VALORACION ORTODONCIA",
  "VALORACION PERIODONTAL",
  "VALORACI√ìN REHABILITACI√ìN ORAL",
  "VENTANA QUIR√öRGICA"
];

// Key para guardar nuevos procedimientos
const LS_PROC_KEY = "procedimientos_custom";

// Normaliza para comparar (quita dobles espacios, may√∫sculas)
function _normProc(s) {
  return String(s || "")
    .trim()
    .replace(/\s+/g, " ")
    .toUpperCase();
}

function _cargarProcedimientosCustom() {
  try {
    const raw = localStorage.getItem(LS_PROC_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  } catch (e) {
    return [];
  }
}

function _guardarProcedimientosCustom(arr) {
  try { localStorage.setItem(LS_PROC_KEY, JSON.stringify(arr)); } catch(e) {}
}

function _getProcedimientosUnicos() {
  const base = PROCEDIMIENTOS_BASE.map(_normProc);
  const custom = _cargarProcedimientosCustom().map(_normProc);

  const set = new Set([...base, ...custom].filter(Boolean));
  return Array.from(set).sort((a,b) => a.localeCompare(b, "es"));
}

function _poblarDatalistProcedimientos() {
  const dl = document.getElementById("procedimientos_list");
  if (!dl) return;

  const items = _getProcedimientosUnicos();

  dl.innerHTML = items.map(p => `<option value="${p}"></option>`).join("");
}

// Bot√≥n + Agregar
function agregarProcedimientoDesdeCampo() {
  const input = document.getElementById("evo_tipo");
  if (!input) return;

  const val = _normProc(input.value);
  if (!val) { alert("‚ö†Ô∏è Escribe un procedimiento para agregar."); return; }

  const actuales = _getProcedimientosUnicos();
  if (actuales.includes(val)) {
    alert("‚úÖ Ese procedimiento ya existe en la lista.");
    return;
  }

  // Guardar en custom
  const custom = _cargarProcedimientosCustom().map(_normProc);
  custom.push(val);
  _guardarProcedimientosCustom(Array.from(new Set(custom)));

  _poblarDatalistProcedimientos();
  alert("‚úÖ Procedimiento agregado al listado.");
}

// Inicializa al cargar
document.addEventListener("DOMContentLoaded", () => {
  _poblarDatalistProcedimientos();

  // Si presionas Enter en el campo y NO existe, pregunta si lo agrega
  const input = document.getElementById("evo_tipo");
  if (input) {
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        // evita que el Enter dispare cosas raras
        e.preventDefault();

        const val = _normProc(input.value);
        if (!val) return;

        const actuales = _getProcedimientosUnicos();
        if (!actuales.includes(val)) {
          const ok = confirm("Este procedimiento no est√° en la lista.\n\n¬øDeseas agregarlo?");
          if (ok) agregarProcedimientoDesdeCampo();
        }
      }
    });
  }
});

 // ==============================
// ‚úÖ PROFESIONALES (desplegable con b√∫squeda + agregar)
// ==============================

const PROFESIONALES_BASE = [
  "LEIDI FERNANDA SILVA OROPEZA"
];

const LS_PROF_KEY = "profesionales_custom";

function _normProf(s) {
  return String(s || "")
    .trim()
    .replace(/\s+/g, " ")
    .toUpperCase();
}

function _cargarProfesionalesCustom() {
  try {
    const raw = localStorage.getItem(LS_PROF_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  } catch (e) {
    return [];
  }
}

function _guardarProfesionalesCustom(arr) {
  try { localStorage.setItem(LS_PROF_KEY, JSON.stringify(arr)); } catch(e) {}
}

function _getProfesionalesUnicos() {
  const base = PROFESIONALES_BASE.map(_normProf);
  const custom = _cargarProfesionalesCustom().map(_normProf);

  const set = new Set([...base, ...custom].filter(Boolean));
  return Array.from(set).sort((a,b) => a.localeCompare(b, "es"));
}

function _poblarDatalistProfesionales() {
  const dl = document.getElementById("profesionales_list");
  if (!dl) return;

  const items = _getProfesionalesUnicos();
  dl.innerHTML = items.map(p => `<option value="${p}"></option>`).join("");
}

function agregarProfesionalDesdeCampo() {
  const input = document.getElementById("evo_profesional");
  if (!input) return;

  const val = _normProf(input.value);
  if (!val) { alert("‚ö†Ô∏è Escribe el nombre del profesional para agregar."); return; }

  const actuales = _getProfesionalesUnicos();
  if (actuales.includes(val)) {
    alert("‚úÖ Ese profesional ya existe en la lista.");
    return;
  }

  const custom = _cargarProfesionalesCustom().map(_normProf);
  custom.push(val);
  _guardarProfesionalesCustom(Array.from(new Set(custom)));

  _poblarDatalistProfesionales();
  alert("‚úÖ Profesional agregado al listado.");
}

document.addEventListener("DOMContentLoaded", () => {
  _poblarDatalistProfesionales();

  const input = document.getElementById("evo_profesional");
  if (input) {
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();

        const val = _normProf(input.value);
        if (!val) return;

        const actuales = _getProfesionalesUnicos();
        if (!actuales.includes(val)) {
          const ok = confirm("Este profesional no est√° en la lista.\n\n¬øDeseas agregarlo?");
          if (ok) agregarProfesionalDesdeCampo();
        }
      }
    });
  }
});
/**
 /* ======================================================
   üé§ VOZ POR CAMPO ‚Äì MODO TOGGLE (CLICK ON / CLICK OFF)
   ====================================================== */
(function () {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("‚ö†Ô∏è Tu navegador no soporta reconocimiento de voz (usa Chrome o Edge).");
    return;
  }

  let rec = null;
  let escuchando = false;
  let campoActivo = null;
  let botonActivo = null;

  const LANG = "es-CO";

  function norm(s) {
    return String(s || "")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .trim();
  }

  function dispatchInput(el) {
    el.dispatchEvent(new Event("input", { bubbles: true }));
    el.dispatchEvent(new Event("change", { bubbles: true }));
  }

  function parseFecha(txt) {
    txt = norm(txt);
    if (/^\d{4}-\d{2}-\d{2}$/.test(txt)) return txt;
    const m = txt.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (m) {
      return `${m[3]}-${m[2].padStart(2,"0")}-${m[1].padStart(2,"0")}`;
    }
    return null;
  }

  function escribir(el, texto) {
    if (!el || el.disabled || el.readOnly) return;

    if (el.type === "date") {
      el.value = parseFecha(texto) || texto;
    } else if (el.type === "number") {
      el.value = texto.replace(/[^\d]/g, "");
    } else if (el.type === "tel") {
      el.value = texto.replace(/[^\d+]/g, "");
    } else if (el.tagName === "SELECT") {
      const opt = [...el.options].find(o =>
        norm(o.textContent) === norm(texto) ||
        norm(o.value) === norm(texto)
      );
      if (opt) el.value = opt.value;
    } else {
      el.value = texto;
    }

    dispatchInput(el);
  }

  function setEstado(txt) {
    const e = document.getElementById("voz_estado");
    if (e) e.textContent = "Estado: " + txt;
  }

  function setBoton(b, on) {
    if (!b) return;
    b.classList.toggle("on", on);
  }

  function initRec() {
    const r = new SpeechRecognition();
    r.lang = LANG;
    r.continuous = true;
    r.interimResults = false;

    r.onstart = () => {
      escuchando = true;
      setEstado("escuchando");
      setBoton(botonActivo, true);
    };

    r.onend = () => {
      escuchando = false;
      setEstado("apagado");
      setBoton(botonActivo, false);
      campoActivo = null;
      botonActivo = null;
    };

    r.onerror = (e) => {
      console.warn("Voz error:", e);
      setEstado("error");
      setBoton(botonActivo, false);
    };

    r.onresult = (ev) => {
      const res = ev.results[ev.results.length - 1];
      const texto = res[0].transcript.trim();
      if (campoActivo) escribir(campoActivo, texto);
    };

    return r;
  }

  function toggleDictado(campo, boton) {
    if (!rec) rec = initRec();

    // üîÅ Si ya est√° grabando ESTE campo ‚Üí apagar
    if (escuchando && campoActivo === campo) {
      rec.stop();
      return;
    }

    // üîÅ Si estaba grabando otro campo ‚Üí cambiar
    if (escuchando) rec.stop();

    campoActivo = campo;
    botonActivo = boton;

    campo.focus();
    campo.scrollIntoView({ behavior: "smooth", block: "center" });

    try { rec.start(); } catch(e) {}
  }

  function wrapCampos() {
    const campos = document.querySelectorAll(".container input, .container textarea, .container select");

    campos.forEach(el => {
      if (el.type === "hidden" || el.type === "checkbox" || el.type === "radio") return;
      if (el.closest(".vwrap")) return;

      const wrap = document.createElement("div");
      wrap.className = "vwrap";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "vbtn";
      btn.textContent = "üé§";
      btn.title = "Dictar por voz (click para iniciar / detener)";

      btn.addEventListener("click", () => toggleDictado(el, btn));

      el.parentNode.insertBefore(wrap, el);
      wrap.appendChild(el);
      wrap.appendChild(btn);
    });

    setEstado("apagado");
  }

  document.addEventListener("DOMContentLoaded", wrapCampos);

  // Compatibilidad con botones viejos
  window.vozStart = () => alert("Usa el üé§ del campo que quieras dictar.");
  window.vozStop = () => rec && rec.stop();
  window.vozModo  = () => alert("El dictado ahora es por campo üé§.");

})();
  /* ======================================================
   üîé ODONTOGRAMA: DOBLE CLICK / DOBLE TAP => PANTALLA COMPLETA
   ====================================================== */
(function(){
  const wrapper = document.getElementById("odontograma-wrapper");
  if (!wrapper) return;

  let isFS = false;
  let exitBtn = null;

  function crearBotonSalir(){
    if (exitBtn) return;
    exitBtn = document.createElement("button");
    exitBtn.id = "btnExitOdonFS";
    exitBtn.type = "button";
    exitBtn.textContent = "Salir ‚úï";
    exitBtn.addEventListener("click", salirFullscreen);
    document.body.appendChild(exitBtn);
  }

  function quitarBotonSalir(){
    if (exitBtn) exitBtn.remove();
    exitBtn = null;
  }

  function entrarFullscreen(){
    if (isFS) return;
    isFS = true;
    wrapper.classList.add("fullscreen");
    crearBotonSalir();

    // Evita que el body se desplace por detr√°s
    document.documentElement.style.overflow = "hidden";
    document.body.style.overflow = "hidden";

    // Lleva al odontograma arriba
    wrapper.scrollTop = 0;
    wrapper.scrollLeft = 0;
  }

  function salirFullscreen(){
    if (!isFS) return;
    isFS = false;
    wrapper.classList.remove("fullscreen");
    quitarBotonSalir();

    document.documentElement.style.overflow = "";
    document.body.style.overflow = "";
  }

  function toggleFullscreen(){
    if (isFS) salirFullscreen();
    else entrarFullscreen();
  }

  // üñ±Ô∏è Doble click (desktop)
  wrapper.addEventListener("dblclick", (e) => {
    e.preventDefault();
    toggleFullscreen();
  });

  // üì± Doble tap (m√≥vil)
  let lastTap = 0;
  wrapper.addEventListener("touchend", (e) => {
    const now = Date.now();
    if (now - lastTap < 300) { // doble toque
      e.preventDefault();
      toggleFullscreen();
    }
    lastTap = now;
  }, { passive: false });

  // ‚å®Ô∏è ESC para salir
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") salirFullscreen();
  });
})();

</script>


</body>
</html>











