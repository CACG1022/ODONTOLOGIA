<!DOCTYPE html>
<html lang="es">
<head>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <meta charset="UTF-8" />
  <title>Historia Cl√≠nica Odontol√≥gica + Odontograma</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- üîê LOGIN CON SUPABASE -->
  <script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // ==============================
  // üîê CONFIG SUPABASE
  // ==============================
  const supabase = createClient(
    "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
  );

  window.supabase = supabase;

  window.APP_URLS = {
    LOGIN: "https://cacg1022.github.io/ODONTOLOGIA/login.html",
    HOME:  "https://cacg1022.github.io/ODONTOLOGIA/index.html",
  };

  const MODULO = "historia_clinica";

  async function verificarSesion() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      window.location.href = window.APP_URLS.LOGIN;
      return null;
    }
    return session;
  }

  async function validarPermisoModulo() {
    const session = await verificarSesion();
    if (!session) return;

    const { data: perfil, error: ePerfil } = await supabase
      .from("profiles")
      .select("role")
      .eq("id", session.user.id)
      .single();

    if (ePerfil || !perfil?.role) {
      alert("No se pudo obtener tu rol.");
      window.location.href = window.APP_URLS.HOME;
      return;
    }

    const rol = perfil.role;

    const { data: permiso, error: ePerm } = await supabase
      .from("modulos_permisos")
      .select("admin, doctor, auxiliar, paciente")
      .eq("modulo", MODULO)
      .single();

    if (ePerm || !permiso) {
      alert("M√≥dulo no configurado en permisos.");
      window.location.href = window.APP_URLS.HOME;
      return;
    }

    if (!permiso[rol]) {
      alert("‚õî No tienes permiso para acceder a Historia Cl√≠nica.");
      window.location.href = window.APP_URLS.HOME;
      return;
    }

    console.log("‚úÖ Acceso permitido a Historia Cl√≠nica para:", rol);
  }

  // ‚úÖ EJECUCI√ìN SEGURA (sin await directo)
  validarPermisoModulo();

  supabase.auth.onAuthStateChange((_event, session) => {
    if (!session) {
      window.location.href = window.APP_URLS.LOGIN;
    }
  });

    // ==============================
    // ‚úÖ DICTADO POR VOZ (Evoluciones: evo_detalle)
    // ==============================
    // (Se mantiene el c√≥digo para no desconfigurar nada, aunque ya no exista el textarea en la UI)
let _srEvo = null;
let _srEvoOn = false;

function _soportaDictado() {
  return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
}

function _appendEnTextarea(textarea, texto) {
  if (!textarea) return;

  const actual = textarea.value || "";
  const add = (texto || "").trim();
  if (!add) return;

  // Agregar sin reemplazar, con separador inteligente
  const sep = actual.trim().length ? (actual.endsWith("\n") ? "" : "\n") : "";
  textarea.value = actual + sep + add;

  // cursor al final
  textarea.focus();
  textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
}

function iniciarDictadoEvoDetalle() {
  const ta = document.getElementById("evo_detalle");
  const btn = document.getElementById("btnDictadoEvoDetalle");
  const hint = document.getElementById("dictadoHintEvo");

  if (!_soportaDictado()) {
    alert("‚ö†Ô∏è Tu navegador no soporta dictado por voz. Usa Chrome o Edge.");
    return;
  }

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  _srEvo = new SR();

  _srEvo.lang = "es-CO";         // puedes cambiar a "es-ES", "es-MX", etc.
  _srEvo.continuous = true;      // seguir escuchando
  _srEvo.interimResults = true;  // mostrar parciales (no los agregamos hasta que sean finales)

  let bufferFinal = "";

  _srEvo.onstart = () => {
    _srEvoOn = true;
    if (btn) btn.classList.add("on");
    if (hint) hint.style.display = "block";
  };

  _srEvo.onresult = (event) => {
    let textoFinal = "";

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const res = event.results[i];
      const t = (res[0]?.transcript || "").trim();
      if (!t) continue;

      if (res.isFinal) {
        textoFinal += (textoFinal ? " " : "") + t;
      }
    }

    if (textoFinal) {
      // lo vamos acumulando y lo insertamos de una vez por cada "final"
      bufferFinal += (bufferFinal ? " " : "") + textoFinal;

      // ‚úÖ agrega al textarea SIN borrar lo que ya existe
      _appendEnTextarea(ta, bufferFinal);
      bufferFinal = "";
    }
  };

  _srEvo.onerror = (e) => {
    console.warn("Dictado error:", e);
    // Errores t√≠picos: "not-allowed" (sin permiso), "no-speech"
    if (e?.error === "not-allowed" || e?.error === "service-not-allowed") {
      alert("‚ö†Ô∏è Permiso de micr√≥fono denegado. Habil√≠talo en el navegador.");
      detenerDictadoEvoDetalle();
    }
  };

  _srEvo.onend = () => {
    // Si estaba encendido y el navegador lo corta, intentamos reanudar
    // (√∫til cuando continuous=true pero Chrome a veces lo detiene)
    if (_srEvoOn) {
      try { _srEvo.start(); } catch (err) {}
      return;
    }
    if (btn) btn.classList.remove("on");
    if (hint) hint.style.display = "none";
  };

  try {
    _srEvo.start();
  } catch (e) {
    console.warn("No se pudo iniciar dictado:", e);
  }
}

function detenerDictadoEvoDetalle() {
  const btn = document.getElementById("btnDictadoEvoDetalle");
  const hint = document.getElementById("dictadoHintEvo");

  _srEvoOn = false;

  if (_srEvo) {
    try { _srEvo.onend = null; } catch(e) {}
    try { _srEvo.stop(); } catch(e) {}
    _srEvo = null;
  }

  if (btn) btn.classList.remove("on");
  if (hint) hint.style.display = "none";
}

function toggleDictadoEvoDetalle() {
  if (_srEvoOn) detenerDictadoEvoDetalle();
  else iniciarDictadoEvoDetalle();
}

// opcional: detener dictado si cambias de p√°gina o cierras
window.addEventListener("beforeunload", () => {
  try { detenerDictadoEvoDetalle(); } catch(e) {}
});
window.toggleDictadoEvoDetalle = toggleDictadoEvoDetalle;

function _fmt(val){
  if (val === null || val === undefined) return "";
  if (Array.isArray(val)) return val.join(", ");
  return String(val);
}

function _siNo(arr){
  const v = Array.isArray(arr) ? arr.join(", ") : String(arr || "");
  return v || "";
}

function _tableRow(k, v){
  return `<tr><td class="k">${escapeHtml(k)}</td><td>${escapeHtml(_fmt(v))}</td></tr>`;
}

// Odontograma a tabla (ya lo tienes como odontogramaCompleto en enviarAN8N)
function _odontogramaToHTML(odontogramaCompleto){
  let html = `
    <h3>Odontograma (FDI)</h3>
    <table class="t">
      <thead>
        <tr>
          <th>Diente</th><th>Mesial</th><th>Distal</th><th>Oclusal</th>
          <th>Vestibular</th><th>Lingual</th><th>Palatino</th>
        </tr>
      </thead><tbody>
  `;

  Object.entries(odontogramaCompleto || {}).forEach(([diente, r]) => {
    html += `
      <tr>
        <td>${escapeHtml(diente)}</td>
        <td>${escapeHtml((r.Mesial||"").toUpperCase())}</td>
        <td>${escapeHtml((r.Distal||"").toUpperCase())}</td>
        <td>${escapeHtml((r.Oclusal||"").toUpperCase())}</td>
        <td>${escapeHtml((r.Vestibular||"").toUpperCase())}</td>
        <td>${escapeHtml((r.Lingual||"").toUpperCase())}</td>
        <td>${escapeHtml((r.Palatino||"").toUpperCase())}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  return html;
}

function _evolucionesToHTML(evos){
  const lista = Array.isArray(evos) ? evos : [];
  if (!lista.length) return `<h3>Evoluciones</h3><div class="muted">Sin evoluciones registradas.</div>`;

  let html = `
    <h3>Evoluciones</h3>
    <table class="t">
      <thead>
        <tr>
          <th>Fecha</th><th>Hora</th><th>Profesional</th><th>Procedimiento</th><th>Detalle</th>
        </tr>
      </thead><tbody>
  `;

  lista.forEach(e => {
    const fecha = _soloFechaYYYYMMDD(e.fecha || e.evo_fecha || "");
    const hora  = _soloHoraHHMM(e.hora || e.evo_hora || "");
    html += `
      <tr>
        <td>${escapeHtml(fecha)}</td>
        <td>${escapeHtml(hora)}</td>
        <td>${escapeHtml(String(e.profesional || "").toUpperCase())}</td>
        <td>${escapeHtml(String(e.procedimiento || e.evo_tipo || "").toUpperCase())}</td>
        <td style="white-space:pre-wrap;">${escapeHtml(e.detalle || "")}</td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  return html;
} 

  </script>

  <style>
    :root{
      --ink:#19324d;
      --muted:#6b7a90;
      --bg:#f6f8fb;
      --card:#ffffff;
      --brand:#2a5d84;
      --gap:18px;
      --radius:14px;
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --line:#e7edf5;
      --input:#cbd5e1;
    }

    *{box-sizing:border-box}
    body{
      margin:0; padding:24px; font-family:system-ui,Segoe UI,Arial; color:var(--ink); background:var(--bg);
    }
    .container{ max-width:1100px; margin:0 auto; }
    h1{ margin:0 0 14px; font-size:28px; color:var(--brand); }
    h2{ font-size:18px; margin:0 0 14px; color:var(--brand); }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:var(--shadow);
      margin-bottom:22px;
    }
    .legend{ font-weight:700; margin-bottom:8px; color:var(--brand); }

    .grid{ display:grid; gap:var(--gap); }
    .g-2{ grid-template-columns:1fr 1fr; }
    .g-3{ grid-template-columns:repeat(3,1fr); }
    .g-4{ grid-template-columns:repeat(4,1fr); }
    .full{ grid-column:1 / -1; }

    .ctrl{ display:flex; flex-direction:column; gap:8px; }
    .ctrl label{ font-size:13px; color:var(--muted); }

    input[type="text"],input[type="email"],input[type="tel"],
    input[type="number"],input[type="date"],input[type="time"], textarea{
      width:100%; border:1px solid var(--input); border-radius:10px; padding:12px;
      font-size:15px; background:#fff;
    }
    select {
      width:100%;
      border:1px solid var(--input);
      border-radius:10px;
      padding:12px;
      font-size:15px;
      background:#fff;
      cursor:pointer;
    }

    textarea{ min-height:120px; resize:vertical; }
    .inline{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:4px 10px;
      border:1px solid var(--line); border-radius:999px; background:#fff;
    }

    .checks{
      display:grid; gap:10px 18px;
      grid-template-columns:repeat(2,minmax(220px,1fr));
      padding-top:10px;
    }
    .check{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px dashed var(--line); border-radius:10px; background:#fafcff;
    }

    .rowline{ height:1px; background:var(--line); margin:12px 0; }

    @media (max-width:980px){
      .g-4{ grid-template-columns:1fr 1fr; }
      .g-3{ grid-template-columns:1fr 1fr; }
    }
    @media (max-width:680px){
      .g-2,.g-3,.g-4{ grid-template-columns:1fr; }
      .checks{ grid-template-columns:1fr; }
    }

    .search-grid{ grid-template-columns: 1.2fr 1fr; align-items:end; }
    .btn{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      color:white;
      font-size:14px;
    }
    .btn-buscar{ background:#0D47A1; }
    .btn-agenda{ background:#009688; }
    .btn-salir{ background:#009688; }
    .btn-agendar{ background:#009688; }
    .btn-guardar{ background:#009688; }
    .btn-inicio{
      background:#E3E3E3;
      color:#009688;
      font-weight:700;
    }

    .tabla-evo{
      width:100%;
      border-collapse:collapse;
    }
    .tabla-evo th,.tabla-evo td{
      padding:10px;
      border:1px solid var(--line);
      vertical-align:top;
    }
    .tabla-evo thead tr{
      background:#eef6ff;
    }

    .tabla-docs{
      width:100%;
      border-collapse:collapse;
    }
    .tabla-docs th,.tabla-docs td{
      padding:10px;
      border:1px solid var(--line);
      vertical-align:top;
    }
    .tabla-docs thead tr{ background:#eef6ff; }

    /* ODONTOGRAMA (igual) */
    #odontograma-wrapper * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    #odontograma-wrapper { background: #f9f9f9; padding: 20px 0 40px; margin-top: 30px; border-radius: 14px; }
    #odontograma-wrapper h1 { text-align: center; color: #0D47A1; margin-bottom: 10px; }
    .odontograma { display: flex; flex-direction: column; align-items: center; gap: 40px; position: relative; z-index: 10; overflow-x: visible !important; width: max-content; margin: 0 auto; }
    .seccion { text-align: center; }
    .etiqueta { font-weight: bold; color: #D0D0D0; margin-bottom: 10px; }
    .fila { display: flex; flex-wrap: nowrap; justify-content: center; gap: var(--tooth-gap); min-width: max-content; }
    .contenedor-diente { display: flex; flex-direction: column; align-items: center; }
    .diente { position: relative; width: var(--tooth-size); height: var(--tooth-size); border-radius: 50%; border: 2px solid #ccc; background: white; overflow: hidden; }
    .cara { position: absolute; width: 100%; height: 100%; cursor: pointer; transition: background 0.2s; z-index: 1; }
    .cara::before,.cara::after { content: ""; position: absolute; width: 1px; height: 100%; background: gray; left: 50%; top: 0; z-index: 0; }
    .cara::before { transform: rotate(45deg); }
    .cara::after  { transform: rotate(-45deg); }
    .superior { clip-path: polygon(50% 50%, 0% 0%, 100% 0%); }
    .inferior { clip-path: polygon(50% 50%, 0% 100%, 100% 100%); }
    .izquierda { clip-path: polygon(50% 50%, 0% 0%, 0% 100%); }
    .derecha   { clip-path: polygon(50% 50%, 100% 0%, 100% 100%); }
    .centro { width: var(--center-size); height: var(--center-size); border-radius: 50%; border: 1.5px solid gray; background: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 5; cursor: pointer; }
    .numero { font-size: var(--num-size); color: #555; margin-top: 5px; }
    .popup { position: absolute; display: none; background: #fff; border: 1px solid #ccc; padding: 10px; z-index: 1000002; box-shadow: 0 4px 8px rgba(0,0,0,0.2); max-height: 250px; overflow-y: auto; }
    .popup div { margin: 4px 0; font-size: 13px; display: flex; align-items: center; gap: 6px; cursor: pointer; }
    .color-box { width: 12px; height: 12px; border-radius: 2px; display: inline-block; margin-right: 4px; }
    .leyenda { max-width: 1000px; margin: 60px auto 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .leyenda h2 { text-align: center; color: #0D47A1; margin-bottom: 16px; }
    .leyenda-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px 16px; font-size: 14px; }

    .vwrap{ position: relative; display: flex; align-items: center; gap: 10px; }
    .vwrap .vfield{ flex: 1; }
    .vbtn{ width: 44px; min-width: 44px; height: 44px; border-radius: 10px; border: 1px solid var(--line); background: #F5F5F5; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 18px; color: transparent; }
    .vbtn.on{ background: #0D47A1; color: #fff; border-color: #0D47A1; }

    #odontograma-wrapper.fullscreen{
      position: fixed; inset: 0; z-index: 99999; background: #f9f9f9;
      margin: 0 !important; border-radius: 0 !important; padding: 10px 10px 25px; overflow: auto;
    }
    #odontograma-wrapper.fullscreen .odontograma{ margin-left: auto !important; margin-right: auto !important; width: max-content; min-width: max-content; padding: 10px; }
    #btnExitOdonFS{
      position: fixed; top: 12px; right: 12px; z-index: 100000;
      border: none; border-radius: 12px; padding: 10px 14px; cursor: pointer;
      background: #0D47A1; color: #fff; font-weight: 700; box-shadow:0 8px 18px rgba(0,0,0,.18);
    }
    #odontograma-wrapper.fullscreen #odontograma-guias{ max-width: none !important; width: 1300px !important; margin: 5px auto 0 !important; }

    #odontograma-wrapper{ --tooth-size: 56px; --tooth-gap: 10px; --num-size: 11px; --center-size: 20px; }

    .extra-etiquetas{ margin-top: 25px; font-size: 15px; color: #D0D0D0; line-height: 1.1; font-weight: 600; text-align: center; }
    .extra-etiquetas .lingual{ margin-top: 5px; }

    .etiqueta-eje{ position: relative; display: inline-block; padding: 0 10px; }
    .linea-media{ position: absolute; left: 50%; transform: translateX(-50%); width: 3px; background: #E3E3E3; z-index: 999999; pointer-events: none; }
    .etiqueta-eje .linea-media{ top: 100%; height: 0px; }
    .eje-inferior .linea-media{ top: auto; bottom: 100%; height: 0px; }
    .linea-media.linea-cruce::after{
      content:""; position:absolute; left:50%; bottom:0; transform:translateX(-50%);
      width:1000px; height:2px; background:#E3E3E3; border-radius:2px;
    }
    .print-wrap{
      margin-top: 16px;
    }
  </style>
</head>

<body>
<div class="container">

  <!-- BUSCAR -->
  <section class="card">
    <div class="legend">Buscar historia cl√≠nica existente</div>

    <div class="grid g-2 search-grid">
      <div class="ctrl">
        <label for="buscar_cedula">Ingrese n√∫mero de identificaci√≥n</label>
        <input id="buscar_cedula" type="text" placeholder="Ej: 10229566001">
      </div>
      <div class="ctrl">
        <label>&nbsp;</label>
        <button type="button" onclick="buscarHistoria()" class="btn btn-buscar">Buscar</button>
      </div>

      <div class="ctrl">
        <button type="button" onclick="irInicio()" class="btn btn-inicio">IR A INICIO</button>
      </div>
      <div class="ctrl">
        <button type="button" onclick="cerrarSesion()" class="btn btn-salir">Cerrar sesi√≥n</button>
      </div>
      <div class="ctrl">
        <button type="button" onclick="irAgendamiento()" class="btn btn-agenda">VER AGENDA</button>
      </div>

      <div class="ctrl">
        <button type="button" onclick="enviarAN8N()" class="btn btn-guardar">GUARDAR Y ENVIAR</button>
      </div>
      <div class="ctrl">
        <button type="button" onclick="irAgendar()" class="btn btn-agendar">AGENDAR</button>
      </div>

      <div class="ctrl">
        <button type="button" onclick="irPlanTratamiento()" class="btn btn-agenda">PLAN DE TRATAMIENTO</button>
      </div>
    </div>

    <div class="ctrl print-wrap">
      <button type="button" onclick="imprimirHistoriaClinica()" class="btn btn-buscar">
        IMPRIMIR HISTORIA CL√çNICA
      </button>
    </div>

  </section>

  <h1>Historia Cl√≠nica Odontol√≥gica</h1>

  <!-- DATOS B√ÅSICOS -->
  <section class="card">
    <div class="legend">Datos b√°sicos del paciente</div>
    <div class="grid g-2">
      <div class="ctrl">
        <label for="paciente_nombre">*Nombres y apellidos</label>
        <input id="paciente_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_edad">*Edad</label>
        <input id="paciente_edad" type="number" min="0">
      </div>

      <div class="ctrl full">
        <label>*Identificaci√≥n</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="idtipo" value="CC"> C.C.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="CE"> C.E.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="TI"> T.I.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="RC"> R.C.</label>
          <label class="chip"><input type="checkbox" name="idtipo" value="Otro"> Otro</label>
          <span class="hint">Complemente con No. y lugar</span>
        </div>
      </div>

      <div class="ctrl">
        <label for="paciente_numdoc">*No.</label>
        <input
          id="paciente_numdoc"
          type="text"
          inputmode="numeric"
          pattern="[0-9]+"
          required
          oninput="this.value = this.value.replace(/[^0-9]/g, '')"
          placeholder="Solo n√∫meros">
      </div>

      <div class="ctrl">
        <label for="paciente_lugardoc">de</label>
        <input id="paciente_lugardoc" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_nacimiento">*Fecha de nacimiento</label>
        <input id="paciente_nacimiento" type="date">
      </div>

      <div class="ctrl">
        <label for="paciente_lugarnac">Lugar de nacimiento</label>
        <input id="paciente_lugarnac" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_direccion">Direcci√≥n de residencia</label>
        <input id="paciente_direccion" type="text">
      </div>

      <!-- ‚úÖ FIX: id sin espacios -->
      <div class="ctrl">
        <label for="Ciudad_de_Residencia">Ciudad de Residencia</label>
        <input id="Ciudad_de_Residencia" type="text">
      </div>

      <div class="ctrl">
        <label for="EPS_Paciente">EPS</label>
        <input id="EPS_Paciente" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_ocupacion">Ocupaci√≥n</label>
        <input id="paciente_ocupacion" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_tel">Tel√©fono</label>
        <input id="paciente_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="paciente_ciudad">Ciudad</label>
        <input id="paciente_ciudad" type="text">
      </div>

      <div class="ctrl">
        <label for="paciente_cel">Celular</label>
        <input id="paciente_cel" type="tel">
      </div>

      <div class="ctrl">
        <label for="paciente_email">Correo electr√≥nico</label>
        <input id="paciente_email" type="email">
      </div>

      <div class="ctrl">
        <label for="paciente_estadocivil">Estado civil</label>
        <input id="paciente_estadocivil" type="text">
      </div>

      <div class="ctrl">
        <label>Hijos</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="hijos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="hijos" value="No"> No</label>
        </div>
      </div>
    </div>
  </section>

  <!-- ==========================
       DATOS DEL ACUDIENTE
  ============================== -->
  <section class="card">
    <div class="legend">Datos del acudiente</div>

    <div class="grid g-2">
      <div class="ctrl">
        <label for="padre_nombre">Nombre del padre</label>
        <input id="padre_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="madre_nombre">Nombre de la madre</label>
        <input id="madre_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="padre_tel">Tel√©fono padre</label>
        <input id="padre_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="madre_tel">Tel√©fono madre</label>
        <input id="madre_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="padre_eps">E.P.S. padre</label>
        <input id="padre_eps" type="text">
      </div>

      <div class="ctrl">
        <label for="madre_eps">E.P.S. madre</label>
        <input id="madre_eps" type="text">
      </div>

      <div class="ctrl">
        <label for="padre_tipo">Beneficiario / Cotizante (padre)</label>
        <select id="padre_tipo" name="padre_tipo">
          <option value="">Seleccione</option>
          <option value="Beneficiario">Beneficiario</option>
          <option value="Cotizante">Cotizante</option>
        </select>
      </div>

      <div class="ctrl">
        <label for="madre_tipo">Beneficiario / Cotizante (madre)</label>
        <select id="madre_tipo" name="madre_tipo">
          <option value="">Seleccione</option>
          <option value="Beneficiario">Beneficiario</option>
          <option value="Cotizante">Cotizante</option>
        </select>
      </div>
    </div>
  </section>

  <!-- ==========================
       EMERGENCIA
  ============================== -->
  <section class="card">
    <div class="legend">En caso de emergencia avisar a</div>

    <div class="grid g-2">
      <div class="ctrl">
        <label for="emergencia_nombre">Nombres y apellidos</label>
        <input id="emergencia_nombre" type="text">
      </div>

      <div class="ctrl">
        <label for="emergencia_parentesco">Parentesco</label>
        <input id="emergencia_parentesco" type="text">
      </div>

      <div class="ctrl">
        <label for="emergencia_tel">Tel√©fono</label>
        <input id="emergencia_tel" type="tel">
      </div>

      <div class="ctrl">
        <label for="emergencia_cel">Celular</label>
        <input id="emergencia_cel" type="tel">
      </div>
    </div>
  </section>

  <!-- ==========================
       HISTORIA M√âDICA
  ============================== -->
  <section class="card">
    <div class="legend">Historia m√©dica</div>

    <div class="grid g-2">
      <div class="ctrl">
        <label>¬øEnfermedad grave actualmente o previa?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="grave" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="grave" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label for="grave_cual">¬øCu√°l?</label>
        <input id="grave_cual" type="text">
      </div>
    </div>

    <div class="ctrl">
      <label>Condiciones (marque las que apliquen)</label>

      <div class="checks">
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones card√≠acas">Alteraciones card√≠acas</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Asma">Asma</label>
        <label class="check"><input type="checkbox" name="condiciones" value="C√°ncer">C√°ncer</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones vasculares o circulatorias">Alteraciones vasculares o circulatorias</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones psicol√≥gicas o psiqui√°tricas">Alteraciones psicol√≥gicas o psiqui√°tricas</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Enfisema">Enfisema</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Artritis">Artritis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Diabetes">Diabetes</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hepatitis">Hepatitis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Desmayos o convulsiones">Desmayos o convulsiones</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hospitalizaciones">Hospitalizaciones</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hipotiroidismo">Hipotiroidismo</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Fiebre reum√°tica">Fiebre reum√°tica</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hipertiroidismos o hiperparatiroidismo">Hipertiroidismos o hiperparatiroidismo</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Lupus">Lupus</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Hipertensi√≥n">Hipertensi√≥n</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Leucemia">Leucemia</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Sinusitis">Sinusitis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Irradiaciones">Irradiaciones</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Problemas renales">Problemas renales</label>
        <label class="check"><input type="checkbox" name="condiciones" value="VIH (Sida)">VIH (Sida)</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Osteoporosis">Osteoporosis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Trauma">Trauma</label>

        <div class="check" style="display:block;">
          <div class="grid g-2">
            <label class="inline">
              <input type="checkbox" name="condiciones" value="Otra">
              Otra
            </label>
            <input id="otra_cual" type="text" name="otra_cual" placeholder="¬øCu√°l?">
          </div>
        </div>

        <label class="check"><input type="checkbox" name="condiciones" value="Tuberculosis">Tuberculosis</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones nutricionales">Alteraciones nutricionales</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Alteraciones del h√≠gado">Alteraciones del h√≠gado</label>
        <label class="check"><input type="checkbox" name="condiciones" value="Anemia">Anemia</label>
      </div>
    </div>

    <div class="rowline"></div>

    <div class="grid g-3">
      <div class="ctrl">
        <label>¬øProblemas de coagulaci√≥n?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="coagulacion" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="coagulacion" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øToma anticoagulantes?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="anticoagulantes" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="anticoagulantes" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øToma medicamentos?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="toma_medicamentos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="toma_medicamentos" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label for="medicamentos_cuales">¬øCu√°les?</label>
        <input id="medicamentos_cuales" type="text">
      </div>

      <div class="ctrl">
        <label for="med_dosis">Dosis y frecuencia</label>
        <input id="med_dosis" type="text">
      </div>

      <div class="ctrl">
        <label for="alergia_meds">Alergia a medicamentos</label>
        <input id="alergia_meds" type="text">
      </div>
    </div>

    <div class="rowline"></div>

    <div class="grid g-2">
      <div class="ctrl">
        <label>¬øToma bebidas alcoh√≥licas?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="alcohol" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="alcohol" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øFuma?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="fuma" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="fuma" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øConsume drogas psicoactivas?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="drogas" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="drogas" value="No"> No</label>
        </div>
      </div>
    </div>
  </section>

  <!-- ==========================
       S√ìLO MUJERES
  ============================== -->
  <section class="card">
    <div class="legend">S√≥lo para mujeres</div>

    <div class="grid g-3">
      <div class="ctrl">
        <label>¬øHa tenido embarazos y partos?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="embarazos_partos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="embarazos_partos" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label for="numero_hijos">No. de hijos</label>
        <input id="numero_hijos" type="number" min="0">
      </div>

      <div class="ctrl">
        <label>¬øActualmente est√° embarazada?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="embarazada" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="embarazada" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label for="tiempo_embarazo">Tiempo</label>
        <input id="tiempo_embarazo" type="text">
      </div>

      <div class="ctrl">
        <label>¬øToma anticonceptivos?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="anticonceptivos" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="anticonceptivos" value="No"> No</label>
        </div>
      </div>

      <div class="ctrl">
        <label>¬øHisterectom√≠a o menopausia?</label>
        <div class="inline">
          <label class="chip"><input type="checkbox" name="histerectomia_menopausia" value="Si"> S√≠</label>
          <label class="chip"><input type="checkbox" name="histerectomia_menopausia" value="No"> No</label>
        </div>
      </div>
    </div>
  </section>

  <!-- ==========================
       HISTORIA ODONTOL√ìGICA
  ============================== -->
  <section class="card">
    <div class="legend">Historia odontol√≥gica</div>

    <div class="grid g-2">
      <div class="ctrl full">
        <label for="motivo_consulta">Motivo de consulta odontol√≥gica</label>
        <input id="motivo_consulta" type="text">
      </div>

      <div class="ctrl">
        <label>¬øPresenta dolor en‚Ä¶?</label>
        <div class="inline">
          <label class="chip">boca <input type="checkbox" name="dolor[]" value="boca"></label>
          <label class="chip">cara <input type="checkbox" name="dolor[]" value="cara"></label>
          <label class="chip">cuello <input type="checkbox" name="dolor[]" value="cuello"></label>
        </div>
      </div>

      <div class="ctrl full">
        <label>Tratamientos recibidos</label>
        <div class="checks">
          <label class="check"><input type="checkbox" name="tratamientos" value="Ortodoncia"> Ortodoncia</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Periodoncia"> Periodoncia</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Endodoncia"> Endodoncia</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Cirug√≠a maxilofacial"> Cirug√≠a maxilofacial</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Implantes dentales"> Implantes dentales</label>
          <label class="check"><input type="checkbox" name="tratamientos" value="Restauraci√≥n oral"> Restauraci√≥n oral</label>
        </div>
      </div>

      <p class="hint full">Abajo est√° el odontograma para marcar preexistencias.</p>
    </div>
  </section>

  <!-- ‚úÖ EVOLUCIONES (AJUSTADO) -->
  <section class="card">
    <div class="legend">Evoluciones (procedimientos realizados)</div>

    <!-- ‚úÖ Se eliminan los campos Fecha/Hora/Profesional/Procedimiento/Detalle y los botones Agregar/Limpiar.
         ‚úÖ Se agrega un solo bot√≥n "Evoluciones" que abre una ventana modal y carga el paciente actual. -->
    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button type="button" onclick="abrirModalEvoluciones()" class="btn btn-agenda" style="max-width:260px;">
        Evoluciones
      </button>
    </div>

    <div class="rowline"></div>

    <div style="overflow:auto;">
      <table class="tabla-evo">
        <thead>
          <tr>
            <th>ID Evoluci√≥n</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Profesional</th>
            <th>Procedimiento</th>
            <th>Detalle</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla_evoluciones"></tbody>
      </table>
    </div>
  </section>

  <!-- ‚úÖ MODAL EVOLUCIONES (VENTANA MODAL) -->
  <div id="modalEvoluciones" style="
    display:none; position:fixed; inset:0; background:rgba(0,0,0,.45);
    z-index:1000006; padding:20px;">
    <div style="
      max-width:1100px; margin:0 auto; background:#fff; border-radius:14px;
      border:1px solid #e7edf5; box-shadow:0 10px 30px rgba(0,0,0,.2);
      overflow:hidden;
      max-height: calc(100vh - 40px);
      display:flex; flex-direction:column;
    ">
      <div style="
        display:flex; justify-content:space-between; align-items:center;
        padding:14px 16px; background:#eef6ff; border-bottom:1px solid #e7edf5; gap:16px;
      ">
        <div style="font-weight:800; color:#2a5d84; font-size:16px;">
          Evoluciones
        </div>

        <div style="display:flex; align-items:center; gap:12px;">
          <button type="button" onclick="cerrarModalEvoluciones()" style="
            border:none; background:#0D47A1; color:#fff; font-weight:700;
            border-radius:10px; padding:10px 12px; cursor:pointer;
          ">
            Cerrar ‚úï
          </button>
        </div>
      </div>

      <div style="padding:0; overflow:hidden; flex:1;">
        <iframe id="iframeEvoluciones" src="about:blank" style="
          width:100%; height:100%; border:none; display:block;
        "></iframe>
      </div>
    </div>
  </div>

  <!-- ODONTOGRAMA -->
  <div id="odontograma-wrapper">
    <h1>Odontograma Internacional FDI</h1>
    <div id="odontograma-guias" style="position:relative; width:100%; max-width:900px; margin:5px auto 0; height:20px;">
     <!-- <div style="position:absolute; top:70px; left:-130px; color:#D0D0D0; font-weight:bold;">Distal1</div>
      <div style="position:absolute; top:70px; right:-130px; color:#D0D0D0; font-weight:bold;">Distal2</div>
      <div style="position:absolute; top:230px; left:-130px; color:#D0D0D0; font-weight:bold;">Distal4</div>
      <div style="position:absolute; top:230px; right:-130px; color:#D0D0D0; font-weight:bold;">Distal3</div>-->
    </div>

    <div class="odontograma">
      <div class="seccion">
        <div class="etiqueta etiqueta-eje">
          Vestibular---------------------Maxilar superior--------------------Vestibular
          <span class="linea-media linea-cruce"></span>
        </div>
        <div class="fila" id="fila-superior"></div>
      </div>

      <div class="seccion">
        <div class="fila" id="fila-inferior"></div>
        <div class="etiqueta etiqueta-eje eje-inferior">
          Vestibular--------------------Maxilar inferior--------------------Vestibular
          <span class="linea-media"></span>
        </div>
      </div>
    </div>

    <div class="leyenda">
      <h2>Leyenda de Preexistencias</h2>
      <div class="leyenda-grid" id="grid-leyenda"></div>
    </div>

    <div style="text-align:center; margin-top:40px;">
      <button onclick="mostrarReporte()" style="padding:10px 20px; background:#0D47A1; color:white; border:none; border-radius:6px; cursor:pointer;">
        Generar reporte de preexistencias
      </button>

      <div style="text-align:center; margin-top:20px;">
        <button onclick="enviarAN8N()" style="padding:10px 20px; background:#009688; color:white; border:none; border-radius:6px; cursor:pointer;">
          Guardar y enviar
        </button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ DOCUMENTOS1 -->
  <section class="card" id="seccionDocumentos">
    <div class="legend">CONSENTIMIENTOS INFORMADOS</div>

    <div class="grid g-3">
      <div class="ctrl">
        <label>ID documento (autom√°tico)</label>
        <input id="doc_id" type="text" readonly>
      </div>

      <div class="ctrl">
        <label>Tipo de documento</label>
        <select id="doc_tipo">
          <option value="CONSENTIMIENTO">Consentimiento informado</option>
        </select>
      </div>

      <div class="ctrl">
        <label>Fecha</label>
        <input id="doc_fecha" type="date">
      </div>

      <div class="ctrl">
        <label>Procedimiento</label>
        <input id="doc_procedimiento" type="text" list="procedimientos_list_supabase" placeholder="Ej: / HIGIENE / RESINA...">
      </div>

      <div class="ctrl">
        <label>Profesional</label>
        <select id="doc_profesional">
        <option value="">Seleccione profesional...</option>
        </select>

      </div>

      <div class="ctrl">
        <label>Plantilla</label>
        <select id="doc_template">
          <option value="AUTO">Autom√°tica (seg√∫n procedimiento)</option>
          <option value="GENERICA">Gen√©rica</option>
        </select>
      </div>

      <div class="ctrl full">
        <label>Texto del documento (editable)</label>
        <textarea id="doc_texto" style="min-height:220px;"></textarea>
      </div>
    </div>

    <div class="rowline"></div>

    <div class="grid g-2">
      <div class="ctrl">
        <label>Firma paciente</label>
        <canvas id="doc_firmaPaciente" width="420" height="160" style="border:1px solid #cbd5e1; border-radius:10px; background:#fff;"></canvas>
        <div class="inline" style="margin-top:8px;">
          <button type="button" class="btn btn-buscar" style="width:auto;" onclick="limpiarFirmaDocumento('PAC')">Limpiar</button>
        </div>
      </div>

      <div class="ctrl">
        <label>Firma profesional</label>
        <canvas id="doc_firmaProfesional" width="420" height="160" style="border:1px solid #cbd5e1; border-radius:10px; background:#fff;"></canvas>
        <div class="inline" style="margin-top:8px;">
          <button type="button" class="btn btn-buscar" style="width:auto;" onclick="limpiarFirmaDocumento('PRO')">Limpiar</button>
        </div>
      </div>
    </div>

    <div class="rowline"></div>

    <div class="inline" style="justify-content:flex-end; gap:10px;">
  <button type="button" class="btn btn-buscar" style="width:auto;" onclick="abrirModalPlantillas()">Crear plantilla</button>
  <button type="button" class="btn btn-buscar" style="width:auto;" onclick="nuevoDocumento()">Nuevo documento</button>
  <button type="button" class="btn btn-agenda" style="width:auto;" onclick="guardarDocumentoSupabase()">Guardar documento</button>
</div>


    <div class="rowline"></div>

    <div style="overflow:auto;">
      <table class="tabla-docs">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Procedimiento</th>
            <th>Profesional</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla_documentos"></tbody>
      </table>
      <div id="docs_empty" style="margin-top:10px; color:#6b7a90; display:none;">
        Este paciente no tiene documentos registrados.
      </div>
    </div>
  </section>

  <!-- ‚úÖ MODAL VER DOCUMENTO -->
  <div id="modalVerDoc" style="
    display:none; position:fixed; inset:0; background:rgba(0,0,0,.45);
    z-index:1000003; padding:20px;">
    <div style="
  max-width:1000px; margin:0 auto; background:#fff; border-radius:14px;
  border:1px solid #e7edf5; box-shadow:0 10px 30px rgba(0,0,0,.2);
  overflow:hidden;
  max-height: calc(100vh - 40px);
  display:flex; flex-direction:column;
">

      <div style="
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 16px;
  background:#eef6ff;
  border-bottom:1px solid #e7edf5;
  gap:16px;
">
  <!-- IZQUIERDA: T√çTULO -->
  <div style="font-weight:800; color:#2a5d84; font-size:16px;">
    Vista del documento
  </div>

  <!-- DERECHA: LOGO + BOT√ìN -->
  <div style="display:flex; align-items:center; gap:12px;">
    <img
      src="https://static.wixstatic.com/media/63e6ec_3973b230e8aa49869f3127b467fb3e6e~mv2.png/v1/fill/w_426,h_426,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/LOGO%20LEIDI%20SILVA%202%20(1).png"
      alt="Logo Cl√≠nica"
      style="height:48px; object-fit:contain;"
    >

    <button type="button" onclick="cerrarModalVerDoc()" style="
      border:none;
      background:#0D47A1;
      color:#fff;
      font-weight:700;
      border-radius:10px;
      padding:10px 12px;
      cursor:pointer;
    ">
      Cerrar ‚úï
    </button>
  </div>
</div>

  
      <div style="padding:16px; overflow-y:auto; flex:1;">
        <div style="display:grid; gap:14px; grid-template-columns:1fr 1fr;">
          <div style="border:1px solid #e7edf5; border-radius:12px; padding:12px;">
            <div style="font-weight:700; color:#19324d; margin-bottom:8px;">Informaci√≥n</div>
            <div style="font-size:14px; color:#19324d; line-height:1.6;">
              <div><b>ID:</b> <span id="verDoc_id"></span></div>
              <div><b>Fecha:</b> <span id="verDoc_fecha"></span></div>
              <div><b>Tipo:</b> <span id="verDoc_tipo"></span></div>
              <div><b>Procedimiento:</b> <span id="verDoc_procedimiento"></span></div>
              <div><b>Profesional:</b> <span id="verDoc_profesional"></span></div>
            </div>
          </div>

          <div style="border:1px solid #e7edf5; border-radius:12px; padding:12px;">
            <div style="font-weight:700; color:#19324d; margin-bottom:8px;">Acciones</div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button type="button" onclick="imprimirDocumento()" style="
                border:none; background:#009688; color:#fff; font-weight:700; border-radius:10px;
                padding:10px 12px; cursor:pointer;">Imprimir</button>

              <button type="button" onclick="descargarHTMLDocumento()" style="
                border:none; background:#0D47A1; color:#fff; font-weight:700; border-radius:10px;
                padding:10px 12px; cursor:pointer;">Descargar (HTML)</button>
            </div>
            <div style="margin-top:10px; font-size:12px; color:#6b7a90;">
              (Imprimir sirve para guardar como PDF desde el navegador)
            </div>
          </div>
        </div>

        <div style="margin-top:14px; border:1px solid #e7edf5; border-radius:12px; overflow:hidden;">
          <div style="background:#fafcff; border-bottom:1px solid #e7edf5; padding:10px 12px; font-weight:700; color:#19324d;">
            Texto del documento
          </div>
          <pre id="verDoc_texto" style="
            margin:0; padding:14px; white-space:pre-wrap;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            font-size:14px; color:#19324d; min-height:160px;"></pre>
        </div>

        <div style="margin-top:14px; display:grid; gap:14px; grid-template-columns:1fr 1fr;">
          <div style="border:1px solid #e7edf5; border-radius:12px; padding:12px;">
            <div style="font-weight:700; color:#19324d; margin-bottom:8px;">Firma paciente</div>
            <img id="verDoc_firmaPaciente" alt="Firma paciente" style="
              width:100%; height:180px; object-fit:contain;
              border:1px solid #cbd5e1; border-radius:10px; background:#fff;">
          </div>

          <div style="border:1px solid #e7edf5; border-radius:12px; padding:12px;">
            <div style="font-weight:700; color:#19324d; margin-bottom:8px;">Firma profesional</div>
            <img id="verDoc_firmaProfesional" alt="Firma profesional" style="
              width:100%; height:180px; object-fit:contain;
              border:1px solid #cbd5e1; border-radius:10px; background:#fff;">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ MODAL PLANTILLAS -->
<div id="modalPlantillas" style="
  display:none; position:fixed; inset:0; background:rgba(0,0,0,.45);
  z-index:1000004; padding:20px;">
  <div style="max-width:1000px; margin:0 auto; background:#fff; border-radius:14px;
    border:1px solid #e7edf5; box-shadow:0 10px 30px rgba(0,0,0,.2); overflow:hidden;">

    <div style="display:flex; justify-content:space-between; align-items:center; padding:14px 16px;
      background:#eef6ff; border-bottom:1px solid #e7edf5;">
      <div style="font-weight:800; color:#2a5d84;">Plantillas de consentimientos informados</div>
      <button type="button" onclick="cerrarModalPlantillas()" style="
        border:none; background:#0D47A1; color:#fff; font-weight:700; border-radius:10px;
        padding:10px 12px; cursor:pointer;">Cerrar ‚úï</button>
    </div>

    <div style="padding:16px; display:grid; gap:14px; grid-template-columns: 1fr 1.2fr;">
      <!-- LISTADO -->
      <div style="border:1px solid #e7edf5; border-radius:12px; padding:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div style="font-weight:700; color:#19324d;">Mis plantillas</div>
          <button type="button" onclick="nuevaPlantillaUI()" style="
            border:none; background:#009688; color:#fff; font-weight:700; border-radius:10px;
            padding:8px 10px; cursor:pointer;">+ Nueva</button>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:10px;">
          <input id="tpl_buscar" type="text" placeholder="Buscar por nombre o procedimiento..." style="flex:1;">
          <button type="button" onclick="renderListaPlantillas()" style="
            border:none; background:#0D47A1; color:#fff; font-weight:700; border-radius:10px;
            padding:10px 12px; cursor:pointer;">Buscar</button>
        </div>

        <div style="max-height:420px; overflow:auto;">
          <table class="tabla-docs">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Procedimiento</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla_plantillas"></tbody>
          </table>
          <div id="tpl_empty" style="margin-top:10px; color:#6b7a90; display:none;">
            No hay plantillas creadas.
          </div>
        </div>
      </div>

      <!-- FORM -->
      <div style="border:1px solid #e7edf5; border-radius:12px; padding:12px;">
        <div style="font-weight:700; color:#19324d; margin-bottom:10px;">Editor de plantilla</div>

        <input id="tpl_id" type="text" readonly style="display:none;">

        <div class="ctrl">
          <label>Nombre de la plantilla</label>
          <input id="tpl_nombre" type="text" placeholder="Ej: Consentimiento Resina">
        </div>

        <div class="ctrl" style="margin-top:10px;">
          <label>Procedimiento asociado</label>
          <input id="tpl_procedimiento" type="text" list="procedimientos_list_supabase" placeholder="Ej: CACC / HIGIENE / RESINA o GENERICA">
          <div style="font-size:12px; color:#6b7a90; margin-top:6px;">
            Tip: si pones <b>GENERICA</b>, aparecer√° como plantilla general.
          </div>
        </div>

        <div class="ctrl" style="margin-top:10px;">
          <label>Contenido (puedes usar variables)</label>
          <textarea id="tpl_contenido" style="min-height:260px;" placeholder="Ej:
CONSENTIMIENTO INFORMADO
Paciente: {{PACIENTE}} - Identificaci√≥n: {{CEDULA}}
Procedimiento: {{PROCEDIMIENTO}}
Profesional: {{PROFESIONAL}}
Fecha: {{FECHA}}
..."></textarea>
          <div style="font-size:12px; color:#6b7a90; margin-top:6px;">
            Variables disponibles:
            <b>{{PACIENTE}}</b>, <b>{{CEDULA}}</b>, <b>{{PROCEDIMIENTO}}</b>, <b>{{PROFESIONAL}}</b>, <b>{{FECHA}}</b>
          </div>
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap;">
          <button type="button" onclick="probarPlantillaEnDocumento()" style="
            border:none; background:#0D47A1; color:#fff; font-weight:700; border-radius:10px;
            padding:10px 12px; cursor:pointer;">Probar en documento</button>

          <button type="button" onclick="guardarPlantillaSupabase()" style="
            border:none; background:#009688; color:#fff; font-weight:700; border-radius:10px;
            padding:10px 12px; cursor:pointer;">Guardar plantilla</button>

          <button type="button" onclick="eliminarPlantillaSupabase()" style="
            border:none; background:#e53935; color:#fff; font-weight:700; border-radius:10px;
            padding:10px 12px; cursor:pointer;">Eliminar</button>
        </div>
      </div>
    </div>
  </div>
</div>


</div>

<!-- üì§ FORMULARIO OCULTO PARA N8N -->
<form id="formN8N"
  action="https://ftth-n8n2.pzveh5.easypanel.host/webhook/62804cbf-8f21-453b-823e-e5c1b94f31c8"
  method="POST"
  style="display:none;">
  <input type="hidden" id="dataN8N" name="data">
  <input type="hidden" id="usuarioN8N" name="usuario_logueado">
</form>

<datalist id="procedimientos_list_supabase"></datalist>

<script>
  // ==============================
  // CERRAR SESI√ìN + AUTO CIERRE POR INACTIVIDAD (5 min)
  // ==============================
  const LOGIN_URL = window.APP_URLS?.LOGIN || "https://cacg1022.github.io/ODONTOLOGIA/login.html";
  const INACTIVIDAD_MS = 5 * 60 * 1000;

  async function cerrarSesion(motivo = "") {
    try {
      if (window.supabase?.auth?.signOut) {
        await window.supabase.auth.signOut();
      }
    } catch (e) { console.warn("Error cerrando sesi√≥n:", e); }

    try { localStorage.removeItem("usuario_logueado"); } catch(e) {}
    if (motivo) alert(motivo);
    window.location.href = LOGIN_URL;
  }

  let _timerInactividad = null;
  function _reiniciarTimerInactividad() {
    if (_timerInactividad) clearTimeout(_timerInactividad);
    _timerInactividad = setTimeout(() => {
      cerrarSesion("Tu sesi√≥n se cerr√≥ por inactividad (5 minutos).");
    }, INACTIVIDAD_MS);
  }
  ["click","mousemove","keydown","scroll","touchstart"].forEach(evt => {
    window.addEventListener(evt, _reiniciarTimerInactividad, { passive: true });
  });
  _reiniciarTimerInactividad();

  // LINKS
  const URL_AGENDAMIENTO = "https://calendar.google.com/calendar/u/0?cid=ZHJhbGVpZGlzaWx2YUBnbWFpbC5jb20";
  const URL_AGENDAR = "https://calendar.app.google/kbWJdv1f1TZd9bS36";
  const URL_PLAN_TRATAMIENTO = "https://cacg1022.github.io/ODONTOLOGIA/plandetratamiento";
  const URL_INICIO = "https://cacg1022.github.io/ODONTOLOGIA/index.html";
  const LOGO_CLINICA = "https://static.wixstatic.com/media/63e6ec_3973b230e8aa49869f3127b467fb3e6e~mv2.png/v1/fill/w_426,h_426,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/LOGO%20LEIDI%20SILVA%202%20(1).png";

  // ‚úÖ URL EVOLUCIONES (NUEVO)
  const URL_EVOLUCIONES = "https://cacg1022.github.io/ODONTOLOGIA/evoluciones.html";

  function irInicio() { window.location.href = URL_INICIO; }
  function irAgendamiento() { window.open(URL_AGENDAMIENTO, "_blank"); }
  function irAgendar() { window.open(URL_AGENDAR, "_blank"); }

  function irPlanTratamiento() {
    const cedula = (
      document.getElementById("paciente_numdoc")?.value ||
      document.getElementById("buscar_cedula")?.value ||
      ""
    ).trim();

    if (!cedula) {
      alert("‚ö†Ô∏è Primero ingresa o busca la c√©dula del paciente para abrir el plan de tratamiento.");
      return;
    }

    try { localStorage.setItem("cedula_paciente_plan", cedula); } catch(e) {}
    const url = URL_PLAN_TRATAMIENTO + (URL_PLAN_TRATAMIENTO.includes("?") ? "&" : "?") + "cedula=" + encodeURIComponent(cedula);
    window.open(url, "_blank");
  }

  // UTILIDADES
  function _uuidFallback() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }
  function uuid() {
    try { return (crypto && crypto.randomUUID) ? crypto.randomUUID() : _uuidFallback(); }
    catch(e){ return _uuidFallback(); }
  }
  function _hoyISO() { return new Date().toISOString().slice(0, 10); }
  function _horaHHMM() {
    const d = new Date();
    return String(d.getHours()).padStart(2, "0") + ":" + String(d.getMinutes()).padStart(2, "0");
  }
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ==============================
  // ‚úÖ MODAL EVOLUCIONES + CARGA AUTOM√ÅTICA DEL PACIENTE ACTUAL
  // ==============================
  function _getPacienteActual() {
    const paciente_nombre = (document.getElementById("paciente_nombre")?.value || "").trim();
    const cedula = (
      document.getElementById("paciente_numdoc")?.value ||
      document.getElementById("buscar_cedula")?.value ||
      ""
    ).trim();

    const paciente = {
      cedula_paciente: cedula,
      paciente_nombre,
      paciente_edad: (document.getElementById("paciente_edad")?.value || "").trim(),
      paciente_email: (document.getElementById("paciente_email")?.value || "").trim(),
      paciente_tel: (document.getElementById("paciente_tel")?.value || "").trim(),
      paciente_cel: (document.getElementById("paciente_cel")?.value || "").trim(),
      paciente_ciudad: (document.getElementById("paciente_ciudad")?.value || "").trim(),
      ts: new Date().toISOString()
    };

    return paciente;
  }

  function abrirModalEvoluciones() {
    const paciente = _getPacienteActual();
    if (!paciente.cedula_paciente) {
      alert("‚ö†Ô∏è Primero debes buscar o cargar el paciente (c√©dula).");
      return;
    }

    // ‚úÖ Guardar en localStorage para que evoluciones.html lo lea autom√°ticamente
    // (Evoluciones.html debe leer esta key si quieres autoload total)
    try {
      localStorage.setItem("paciente_actual_historia_clinica", JSON.stringify(paciente));
      // compat: tambi√©n guardo solo cedula
      localStorage.setItem("cedula_paciente_evoluciones", paciente.cedula_paciente);
    } catch(e) {}

    const modal = document.getElementById("modalEvoluciones");
    const iframe = document.getElementById("iframeEvoluciones");
    if (!modal || !iframe) return;

    // ‚úÖ abrir modal
    modal.style.display = "block";

    // ‚úÖ pasar cedula por query tambi√©n (por si lo quieres leer en evoluciones.html)
    const url = URL_EVOLUCIONES + (URL_EVOLUCIONES.includes("?") ? "&" : "?") +
      "cedula=" + encodeURIComponent(paciente.cedula_paciente) +
      "&from=historia_clinica";

    iframe.src = url;

    // ‚úÖ adem√°s enviar por postMessage (si evoluciones.html lo implementa)
    // cuando el iframe cargue
    iframe.onload = () => {
      try {
        iframe.contentWindow.postMessage(
          { type: "PACIENTE_ACTUAL", payload: paciente },
          "https://cacg1022.github.io"
        );
      } catch(e) {}
    };
  }

  function cerrarModalEvoluciones() {
    const modal = document.getElementById("modalEvoluciones");
    const iframe = document.getElementById("iframeEvoluciones");
    if (modal) modal.style.display = "none";
    if (iframe) iframe.src = "about:blank";
  }

  // ==============================
  // ‚úÖ PROCEDIMIENTOS DESDE SUPABASE
  // ==============================
  async function cargarProcedimientosDesdeSupabase() {
    const dl = document.getElementById("procedimientos_list_supabase");
    if (!dl) return;

    let tries = 0;
    while (!window.supabase && tries < 40) {
      await new Promise(r => setTimeout(r, 100));
      tries++;
    }
    if (!window.supabase) return;

    try {
      const { data, error } = await window.supabase
        .from("procedimientos_precios")
        .select("procedimiento, activo")
        .eq("activo", true)
        .order("procedimiento", { ascending: true });

      if (error) throw error;

      const items = (data || [])
        .map(x => String(x.procedimiento || "").trim())
        .filter(Boolean);

      dl.innerHTML = items.map(p => `<option value="${escapeHtml(p)}"></option>`).join("");
    } catch (e) {
      console.warn("‚ö†Ô∏è Error cargando procedimientos:", e);
    }
  }
  document.addEventListener("DOMContentLoaded", cargarProcedimientosDesdeSupabase);

  // ==============================
  // ‚úÖ PROFESIONALES DESDE SUPABASE

  // ==============================
  // ‚úÖ PROFESIONALES DESDE SUPABASE
  // ==============================
  async function cargarProfesionalesDesdeSupabase() {
    const sel = document.getElementById("doc_profesional");
    if (!sel) return;

    let tries = 0;
    while (!window.supabase && tries < 40) {
      await new Promise(r => setTimeout(r, 100));
      tries++;
    }
    if (!window.supabase) return;

    try {
      // Intenta primero tabla "profesionales" (recomendado)
      let data = null, error = null;

      const r1 = await window.supabase
        .from("profesionales")
        .select("nombre, activo")
        .eq("activo", true)
        .order("nombre", { ascending: true });

      data = r1.data; error = r1.error;

      // Fallback: si no existe esa tabla, usa "profiles" filtrando roles
      if (error) {
        const r2 = await window.supabase
          .from("profiles")
          .select("full_name, role, activo")
          .in("role", ["admin", "doctor", "auxiliar"])
          .eq("activo", true)
          .order("full_name", { ascending: true });

        data = (r2.data || []).map(x => ({ nombre: x.full_name || "", activo: true }));
        error = r2.error;
      }

      if (error) throw error;

      const items = (data || [])
        .map(x => String(x.nombre || "").trim())
        .filter(Boolean);

      const actual = sel.value || "";
      sel.innerHTML = `<option value="">Seleccione profesional...</option>` +
        items.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join("");

      // mantener selecci√≥n si ya hab√≠a
      if (actual && items.includes(actual)) sel.value = actual;

    } catch (e) {
      console.warn("‚ö†Ô∏è Error cargando profesionales:", e);
    }
  }
  document.addEventListener("DOMContentLoaded", cargarProfesionalesDesdeSupabase);

  // ==============================
  // ‚úÖ CAMPOS DOCUMENTO: defaults
  // ==============================
  function _setDocDefaults() {
    const id = document.getElementById("doc_id");
    const f  = document.getElementById("doc_fecha");
    if (id && !id.value) id.value = uuid();
    if (f && !f.value) f.value = _hoyISO();
  }
  document.addEventListener("DOMContentLoaded", _setDocDefaults);

  // ==============================
  // ‚úÖ FIRMAS EN CANVAS (DOCUMENTOS)
  // ==============================
  function _setupFirmaCanvas(canvasId){
    const c = document.getElementById(canvasId);
    if (!c) return null;
    const ctx = c.getContext("2d");
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#111827";

    let drawing = false;
    let last = null;

    function pos(e){
      const r = c.getBoundingClientRect();
      const isTouch = !!e.touches?.length;
      const clientX = isTouch ? e.touches[0].clientX : e.clientX;
      const clientY = isTouch ? e.touches[0].clientY : e.clientY;
      return { x: clientX - r.left, y: clientY - r.top };
    }

    function down(e){
      drawing = true;
      last = pos(e);
      e.preventDefault();
    }
    function move(e){
      if (!drawing) return;
      const p = pos(e);
      ctx.beginPath();
      ctx.moveTo(last.x, last.y);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      last = p;
      e.preventDefault();
    }
    function up(){
      drawing = false;
      last = null;
    }

    c.addEventListener("mousedown", down);
    c.addEventListener("mousemove", move);
    window.addEventListener("mouseup", up);

    c.addEventListener("touchstart", down, { passive:false });
    c.addEventListener("touchmove", move, { passive:false });
    window.addEventListener("touchend", up);

    return {
      canvas: c,
      clear: () => {
        ctx.clearRect(0,0,c.width,c.height);
      },
      toDataURL: () => c.toDataURL("image/png"),
      isBlank: () => {
        const tmp = document.createElement("canvas");
        tmp.width = c.width; tmp.height = c.height;
        return tmp.toDataURL() === c.toDataURL();
      }
    };
  }

  const _firmaDocPAC = _setupFirmaCanvas("doc_firmaPaciente");
  const _firmaDocPRO = _setupFirmaCanvas("doc_firmaProfesional");

  function limpiarFirmaDocumento(tipo){
    if (tipo === "PAC") _firmaDocPAC?.clear();
    if (tipo === "PRO") _firmaDocPRO?.clear();
  }

  // ==============================
  // ‚úÖ SUPABASE HELPERS (sesi√≥n / usuario)
  // ==============================
  async function _getSessionSafe(){
    try{
      const { data: { session } } = await window.supabase.auth.getSession();
      return session || null;
    }catch(e){ return null; }
  }

  async function _getUsuarioLogueado(){
    // 1) localStorage (si ya lo guardas)
    try{
      const u = localStorage.getItem("usuario_logueado");
      if (u) return u;
    }catch(e){}

    // 2) session email
    const session = await _getSessionSafe();
    const email = session?.user?.email || "";
    if (email) {
      try { localStorage.setItem("usuario_logueado", email); } catch(e){}
      return email;
    }
    return "";
  }

  // ==============================
  // ‚úÖ TABLAS SUPABASE (ajusta si tus nombres difieren)
  // ==============================
  const TBL_HISTORIA = "historia_clinica";                 // 1 fila por c√©dula
  const TBL_EVOS     = "evoluciones";                      // (si lo usas aqu√≠)
  const TBL_DOCS     = "documentos_consentimiento";        // documentos por c√©dula
  const TBL_TPLS     = "plantillas_consentimiento";        // plantillas por usuario

  // ==============================
  // ‚úÖ BUSCAR HISTORIA (por c√©dula)
  // ==============================
  async function buscarHistoria(){
    const cedula = (document.getElementById("buscar_cedula")?.value || "").trim();
    if (!cedula) { alert("Ingresa una identificaci√≥n para buscar."); return; }
    document.getElementById("paciente_numdoc").value = cedula;

    try{
      const { data, error } = await window.supabase
        .from(TBL_HISTORIA)
        .select("*")
        .eq("cedula_paciente", cedula)
        .maybeSingle();

      if (error) throw error;

      if (!data){
        alert("No existe historia cl√≠nica para esta c√©dula. Puedes crear una nueva.");
        // limpia pero deja c√©dula
        _limpiarFormularioManteniendoCedula(cedula);
        // igual carga docs (vac√≠o) por si acaso
        await cargarDocumentosPaciente(cedula);
        await cargarEvolucionesPaciente(cedula);
        return;
      }

      // ‚úÖ cargar campos (solo los que existan)
      _cargarHistoriaEnFormulario(data);

      // cargar docs/evoluciones
      await cargarDocumentosPaciente(cedula);
      await cargarEvolucionesPaciente(cedula);

      // si tienes odontograma guardado como json:
      if (data.odontograma_json) {
        try{
          const obj = (typeof data.odontograma_json === "string")
            ? JSON.parse(data.odontograma_json)
            : data.odontograma_json;
          window.odontogramaData = obj || {};
          // si tu odontograma ya tiene render, inv√≥calo:
          if (typeof window.aplicarOdontogramaGuardado === "function") {
            window.aplicarOdontogramaGuardado(window.odontogramaData);
          }
        }catch(e){}
      }

    }catch(e){
      console.error(e);
      alert("Error buscando historia cl√≠nica. Revisa consola.");
    }
  }
  window.buscarHistoria = buscarHistoria;

  function _limpiarFormularioManteniendoCedula(cedula){
    // B√°sicos
    const ids = [
      "paciente_nombre","paciente_edad","paciente_lugardoc","paciente_nacimiento","paciente_lugarnac",
      "paciente_direccion","Ciudad_de_Residencia","EPS_Paciente","paciente_ocupacion",
      "paciente_tel","paciente_ciudad","paciente_cel","paciente_email","paciente_estadocivil",
      "padre_nombre","madre_nombre","padre_tel","madre_tel","padre_eps","madre_eps","padre_tipo","madre_tipo",
      "emergencia_nombre","emergencia_parentesco","emergencia_tel","emergencia_cel",
      "grave_cual","otra_cual","medicamentos_cuales","med_dosis","alergia_meds",
      "numero_hijos","tiempo_embarazo","motivo_consulta"
    ];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });

    // c√©dula
    const nd = document.getElementById("paciente_numdoc");
    if (nd) nd.value = cedula || "";

    // checkboxes: desmarcar
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

    // firmas doc
    _firmaDocPAC?.clear();
    _firmaDocPRO?.clear();

    // tablas
    const te = document.getElementById("tabla_evoluciones"); if (te) te.innerHTML = "";
    const td = document.getElementById("tabla_documentos");  if (td) td.innerHTML = "";

    // reset doc id
    const doc_id = document.getElementById("doc_id");
    if (doc_id) doc_id.value = uuid();
    const doc_fecha = document.getElementById("doc_fecha");
    if (doc_fecha) doc_fecha.value = _hoyISO();

    // odontograma: reset si tienes funci√≥n
    if (typeof window.resetOdontograma === "function") window.resetOdontograma();
    window.odontogramaData = {};
  }

  function _cargarHistoriaEnFormulario(data){
    // Mapea campos conocidos. Ajusta nombres si tu tabla usa otros.
    const map = {
      paciente_nombre: "paciente_nombre",
      paciente_edad: "paciente_edad",
      paciente_numdoc: "cedula_paciente",
      paciente_lugardoc: "paciente_lugardoc",
      paciente_nacimiento: "paciente_nacimiento",
      paciente_lugarnac: "paciente_lugarnac",
      paciente_direccion: "paciente_direccion",
      Ciudad_de_Residencia: "Ciudad_de_Residencia",
      EPS_Paciente: "EPS_Paciente",
      paciente_ocupacion: "paciente_ocupacion",
      paciente_tel: "paciente_tel",
      paciente_ciudad: "paciente_ciudad",
      paciente_cel: "paciente_cel",
      paciente_email: "paciente_email",
      paciente_estadocivil: "paciente_estadocivil",

      padre_nombre:"padre_nombre",
      madre_nombre:"madre_nombre",
      padre_tel:"padre_tel",
      madre_tel:"madre_tel",
      padre_eps:"padre_eps",
      madre_eps:"madre_eps",
      padre_tipo:"padre_tipo",
      madre_tipo:"madre_tipo",

      emergencia_nombre:"emergencia_nombre",
      emergencia_parentesco:"emergencia_parentesco",
      emergencia_tel:"emergencia_tel",
      emergencia_cel:"emergencia_cel",

      grave_cual:"grave_cual",
      otra_cual:"otra_cual",
      medicamentos_cuales:"medicamentos_cuales",
      med_dosis:"med_dosis",
      alergia_meds:"alergia_meds",

      numero_hijos:"numero_hijos",
      tiempo_embarazo:"tiempo_embarazo",
      motivo_consulta:"motivo_consulta"
    };

    Object.entries(map).forEach(([inputId, key]) => {
      const el = document.getElementById(inputId);
      if (!el) return;
      const v = data?.[key];
      if (v === undefined || v === null) return;
      el.value = String(v);
    });

    // checkboxes: si guardas arrays en texto "a,b,c" o json
    const checksMap = [
      { name:"idtipo", key:"idtipo" },
      { name:"hijos", key:"hijos" },
      { name:"grave", key:"grave" },
      { name:"condiciones", key:"condiciones" },
      { name:"coagulacion", key:"coagulacion" },
      { name:"anticoagulantes", key:"anticoagulantes" },
      { name:"toma_medicamentos", key:"toma_medicamentos" },
      { name:"alcohol", key:"alcohol" },
      { name:"fuma", key:"fuma" },
      { name:"drogas", key:"drogas" },
      { name:"embarazos_partos", key:"embarazos_partos" },
      { name:"embarazada", key:"embarazada" },
      { name:"anticonceptivos", key:"anticonceptivos" },
      { name:"histerectomia_menopausia", key:"histerectomia_menopausia" },
      { name:"dolor[]", key:"dolor" },
      { name:"tratamientos", key:"tratamientos" }
    ];

    checksMap.forEach(({name, key}) => {
      const val = data?.[key];
      if (val === undefined || val === null) return;

      let arr = [];
      if (Array.isArray(val)) arr = val;
      else {
        // intenta JSON
        try{
          const j = JSON.parse(val);
          if (Array.isArray(j)) arr = j;
          else arr = String(val).split(",").map(s=>s.trim()).filter(Boolean);
        }catch(e){
          arr = String(val).split(",").map(s=>s.trim()).filter(Boolean);
        }
      }

      document.querySelectorAll(`input[type="checkbox"][name="${name}"]`).forEach(cb => {
        cb.checked = arr.includes(cb.value);
      });
    });
  }

  // ==============================
  // ‚úÖ DOCUMENTOS: CRUD
  // ==============================
  function nuevoDocumento(){
    const ced = (document.getElementById("paciente_numdoc")?.value || "").trim();
    if (!ced) { alert("Primero carga/busca el paciente (c√©dula)."); return; }

    document.getElementById("doc_id").value = uuid();
    document.getElementById("doc_tipo").value = "CONSENTIMIENTO";
    document.getElementById("doc_fecha").value = _hoyISO();
    document.getElementById("doc_procedimiento").value = "";
    document.getElementById("doc_template").value = "AUTO";
    document.getElementById("doc_texto").value = "";
    // profesional: no forzar
    _firmaDocPAC?.clear();
    _firmaDocPRO?.clear();

    // autogenerar texto si quieres
    _autocompletarTextoDocumento();
  }
  window.nuevoDocumento = nuevoDocumento;

  function _getDocForm(){
    const cedula = (document.getElementById("paciente_numdoc")?.value || "").trim();
    return {
      doc_id: (document.getElementById("doc_id")?.value || "").trim(),
      cedula_paciente: cedula,
      doc_tipo: (document.getElementById("doc_tipo")?.value || "").trim(),
      doc_fecha: (document.getElementById("doc_fecha")?.value || "").trim(),
      doc_procedimiento: (document.getElementById("doc_procedimiento")?.value || "").trim(),
      doc_profesional: (document.getElementById("doc_profesional")?.value || "").trim(),
      doc_template: (document.getElementById("doc_template")?.value || "").trim(),
      doc_texto: (document.getElementById("doc_texto")?.value || ""),
      firma_paciente: _firmaDocPAC?.toDataURL() || "",
      firma_profesional: _firmaDocPRO?.toDataURL() || ""
    };
  }

  function _validarDocForm(doc){
    if (!doc.cedula_paciente) return "Falta la c√©dula del paciente.";
    if (!doc.doc_id) return "Falta el ID del documento.";
    if (!doc.doc_fecha) return "Falta la fecha del documento.";
    if (!doc.doc_procedimiento) return "Falta el procedimiento.";
    if (!doc.doc_profesional) return "Falta el profesional.";
    if (!doc.doc_texto.trim()) return "El texto del documento est√° vac√≠o.";
    if (_firmaDocPAC?.isBlank()) return "Falta la firma del paciente.";
    if (_firmaDocPRO?.isBlank()) return "Falta la firma del profesional.";
    return "";
  }

  async function guardarDocumentoSupabase(){
    try{
      const doc = _getDocForm();
      const msg = _validarDocForm(doc);
      if (msg) { alert("‚ö†Ô∏è " + msg); return; }

      const session = await _getSessionSafe();
      const usuario = await _getUsuarioLogueado();

      const payload = {
        id: doc.doc_id,
        cedula_paciente: doc.cedula_paciente,
        tipo: doc.doc_tipo,
        fecha: doc.doc_fecha,
        procedimiento: doc.doc_procedimiento,
        profesional: doc.doc_profesional,
        template: doc.doc_template,
        texto: doc.doc_texto,
        firma_paciente: doc.firma_paciente,
        firma_profesional: doc.firma_profesional,
        creado_por: usuario || session?.user?.email || null,
        actualizado_en: new Date().toISOString()
      };

      // upsert por id
      const { error } = await window.supabase
        .from(TBL_DOCS)
        .upsert(payload, { onConflict: "id" });

      if (error) throw error;

      alert("‚úÖ Documento guardado.");
      await cargarDocumentosPaciente(doc.cedula_paciente);

    }catch(e){
      console.error(e);
      alert("Error guardando documento. Revisa consola.");
    }
  }
  window.guardarDocumentoSupabase = guardarDocumentoSupabase;

  async function cargarDocumentosPaciente(cedula){
    const tb = document.getElementById("tabla_documentos");
    const empty = document.getElementById("docs_empty");
    if (!tb) return;

    tb.innerHTML = "";
    if (empty) empty.style.display = "none";

    if (!cedula) return;

    try{
      const { data, error } = await window.supabase
        .from(TBL_DOCS)
        .select("id, fecha, tipo, procedimiento, profesional")
        .eq("cedula_paciente", cedula)
        .order("fecha", { ascending:false });

      if (error) throw error;

      const rows = data || [];
      if (!rows.length) {
        if (empty) empty.style.display = "block";
        return;
      }

      tb.innerHTML = rows.map(r => `
        <tr>
          <td>${escapeHtml(r.id)}</td>
          <td>${escapeHtml(r.fecha || "")}</td>
          <td>${escapeHtml(r.tipo || "")}</td>
          <td>${escapeHtml(r.procedimiento || "")}</td>
          <td>${escapeHtml(r.profesional || "")}</td>
          <td style="white-space:nowrap;">
            <button type="button" onclick="verDocumento('${escapeHtml(r.id)}')" class="btn btn-buscar" style="width:auto; padding:8px 10px;">Ver</button>
            <button type="button" onclick="cargarDocumentoEnEditor('${escapeHtml(r.id)}')" class="btn btn-agenda" style="width:auto; padding:8px 10px;">Editar</button>
            <button type="button" onclick="eliminarDocumento('${escapeHtml(r.id)}')" class="btn" style="width:auto; padding:8px 10px; background:#e53935;">Eliminar</button>
          </td>
        </tr>
      `).join("");

    }catch(e){
      console.error(e);
      alert("Error cargando documentos. Revisa consola.");
    }
  }

  async function cargarDocumentoEnEditor(id){
    try{
      const { data, error } = await window.supabase
        .from(TBL_DOCS)
        .select("*")
        .eq("id", id)
        .single();

      if (error) throw error;

      document.getElementById("doc_id").value = data.id || "";
      document.getElementById("doc_tipo").value = data.tipo || "CONSENTIMIENTO";
      document.getElementById("doc_fecha").value = data.fecha || _hoyISO();
      document.getElementById("doc_procedimiento").value = data.procedimiento || "";
      document.getElementById("doc_profesional").value = data.profesional || "";
      document.getElementById("doc_template").value = data.template || "AUTO";
      document.getElementById("doc_texto").value = data.texto || "";

      // firmas: re-dibujar desde dataURL
      _firmaDocPAC?.clear();
      _firmaDocPRO?.clear();
      if (data.firma_paciente) _drawDataURLToCanvas("doc_firmaPaciente", data.firma_paciente);
      if (data.firma_profesional) _drawDataURLToCanvas("doc_firmaProfesional", data.firma_profesional);

      window.scrollTo({ top: document.getElementById("seccionDocumentos").offsetTop - 10, behavior:"smooth" });

    }catch(e){
      console.error(e);
      alert("Error cargando documento en editor.");
    }
  }
  window.cargarDocumentoEnEditor = cargarDocumentoEnEditor;

  function _drawDataURLToCanvas(canvasId, dataURL){
    const c = document.getElementById(canvasId);
    if (!c || !dataURL) return;
    const ctx = c.getContext("2d");
    const img = new Image();
    img.onload = () => {
      ctx.clearRect(0,0,c.width,c.height);
      ctx.drawImage(img, 0, 0, c.width, c.height);
    };
    img.src = dataURL;
  }

  async function eliminarDocumento(id){
    if (!confirm("¬øSeguro que deseas eliminar este documento?")) return;
    try{
      const { error } = await window.supabase
        .from(TBL_DOCS)
        .delete()
        .eq("id", id);

      if (error) throw error;

      alert("‚úÖ Documento eliminado.");
      const cedula = (document.getElementById("paciente_numdoc")?.value || "").trim();
      await cargarDocumentosPaciente(cedula);

    }catch(e){
      console.error(e);
      alert("Error eliminando documento.");
    }
  }
  window.eliminarDocumento = eliminarDocumento;

  // ==============================
  // ‚úÖ MODAL VER DOCUMENTO
  // ==============================
  async function verDocumento(id){
    try{
      const { data, error } = await window.supabase
        .from(TBL_DOCS)
        .select("*")
        .eq("id", id)
        .single();

      if (error) throw error;

      document.getElementById("verDoc_id").textContent = data.id || "";
      document.getElementById("verDoc_fecha").textContent = data.fecha || "";
      document.getElementById("verDoc_tipo").textContent = data.tipo || "";
      document.getElementById("verDoc_procedimiento").textContent = data.procedimiento || "";
      document.getElementById("verDoc_profesional").textContent = data.profesional || "";
      document.getElementById("verDoc_texto").textContent = data.texto || "";

      const imgP = document.getElementById("verDoc_firmaPaciente");
      const imgR = document.getElementById("verDoc_firmaProfesional");
      if (imgP) imgP.src = data.firma_paciente || "";
      if (imgR) imgR.src = data.firma_profesional || "";

      // guarda ‚Äúdoc actual‚Äù para imprimir/descargar
      window._docActualVer = data;

      document.getElementById("modalVerDoc").style.display = "block";
    }catch(e){
      console.error(e);
      alert("Error abriendo documento.");
    }
  }
  window.verDocumento = verDocumento;

  function cerrarModalVerDoc(){
    document.getElementById("modalVerDoc").style.display = "none";
    window._docActualVer = null;
  }
  window.cerrarModalVerDoc = cerrarModalVerDoc;

  function _docHTMLImprimible(doc){
    const logo = LOGO_CLINICA || "";
    const paciente = (document.getElementById("paciente_nombre")?.value || "").trim();
    const cedula = (document.getElementById("paciente_numdoc")?.value || "").trim();

    return `
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Documento ${escapeHtml(doc?.id || "")}</title>
<style>
  body{ font-family:system-ui,Segoe UI,Arial; margin:24px; color:#111827; }
  .top{ display:flex; justify-content:space-between; align-items:center; gap:16px; }
  .logo{ height:64px; object-fit:contain; }
  h1{ margin:16px 0 8px; font-size:18px; }
  .meta{ font-size:14px; line-height:1.6; }
  .box{ border:1px solid #e5e7eb; border-radius:12px; padding:14px; margin-top:12px; }
  pre{ white-space:pre-wrap; font-family: ui-monospace, Menlo, Consolas, monospace; }
  .sigwrap{ display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:12px; }
  .sig img{ width:100%; height:160px; object-fit:contain; border:1px solid #e5e7eb; border-radius:12px; }
  .small{ font-size:12px; color:#6b7280; margin-top:10px; }
</style>
</head>
<body>
  <div class="top">
    <div>
      <div style="font-weight:800; font-size:18px;">Consentimiento informado</div>
      <div class="small">Generado desde Historia Cl√≠nica</div>
    </div>
    ${logo ? `<img class="logo" src="${logo}" alt="Logo">` : ``}
  </div>

  <h1>Informaci√≥n</h1>
  <div class="box meta">
    <div><b>ID:</b> ${escapeHtml(doc?.id || "")}</div>
    <div><b>Fecha:</b> ${escapeHtml(doc?.fecha || "")}</div>
    <div><b>Tipo:</b> ${escapeHtml(doc?.tipo || "")}</div>
    <div><b>Procedimiento:</b> ${escapeHtml(doc?.procedimiento || "")}</div>
    <div><b>Profesional:</b> ${escapeHtml(doc?.profesional || "")}</div>
    <div><b>Paciente:</b> ${escapeHtml(paciente)} (${escapeHtml(cedula)})</div>
  </div>

  <h1>Texto</h1>
  <div class="box">
    <pre>${escapeHtml(doc?.texto || "")}</pre>
  </div>

  <h1>Firmas</h1>
  <div class="sigwrap">
    <div class="sig">
      <div style="font-weight:700; margin-bottom:6px;">Firma paciente</div>
      <img src="${doc?.firma_paciente || ""}" alt="Firma paciente"/>
    </div>
    <div class="sig">
      <div style="font-weight:700; margin-bottom:6px;">Firma profesional</div>
      <img src="${doc?.firma_profesional || ""}" alt="Firma profesional"/>
    </div>
  </div>
</body>
</html>`;
  }

  function imprimirDocumento(){
    const doc = window._docActualVer;
    if (!doc) return;

    const w = window.open("", "_blank");
    w.document.open();
    w.document.write(_docHTMLImprimible(doc));
    w.document.close();
    w.focus();
    w.print();
  }
  window.imprimirDocumento = imprimirDocumento;

  function descargarHTMLDocumento(){
    const doc = window._docActualVer;
    if (!doc) return;

    const html = _docHTMLImprimible(doc);
    const blob = new Blob([html], { type:"text/html;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `documento_${(doc.id||"")}.html`;
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 1500);
  }
  window.descargarHTMLDocumento = descargarHTMLDocumento;

  // ==============================
  // ‚úÖ PLANTILLAS: MODAL + CRUD
  // ==============================
  function abrirModalPlantillas(){
    document.getElementById("modalPlantillas").style.display = "block";
    renderListaPlantillas();
  }
  window.abrirModalPlantillas = abrirModalPlantillas;

  function cerrarModalPlantillas(){
    document.getElementById("modalPlantillas").style.display = "none";
  }
  window.cerrarModalPlantillas = cerrarModalPlantillas;

  function nuevaPlantillaUI(){
    document.getElementById("tpl_id").value = "";
    document.getElementById("tpl_nombre").value = "";
    document.getElementById("tpl_procedimiento").value = "";
    document.getElementById("tpl_contenido").value = "";
  }
  window.nuevaPlantillaUI = nuevaPlantillaUI;

  async function renderListaPlantillas(){
    const tb = document.getElementById("tabla_plantillas");
    const empty = document.getElementById("tpl_empty");
    if (!tb) return;

    tb.innerHTML = "";
    if (empty) empty.style.display = "none";

    const q = (document.getElementById("tpl_buscar")?.value || "").trim().toLowerCase();
    const session = await _getSessionSafe();
    const usuario = (await _getUsuarioLogueado()) || session?.user?.email || "";

    try{
      const { data, error } = await window.supabase
        .from(TBL_TPLS)
        .select("id, nombre, procedimiento, creado_por")
        .eq("creado_por", usuario)
        .order("nombre", { ascending:true });

      if (error) throw error;

      let rows = data || [];
      if (q){
        rows = rows.filter(r =>
          String(r.nombre||"").toLowerCase().includes(q) ||
          String(r.procedimiento||"").toLowerCase().includes(q)
        );
      }

      if (!rows.length){
        if (empty) empty.style.display = "block";
        return;
      }

      tb.innerHTML = rows.map(r => `
        <tr>
          <td>${escapeHtml(r.nombre||"")}</td>
          <td>${escapeHtml(r.procedimiento||"")}</td>
          <td style="white-space:nowrap;">
            <button type="button" onclick="cargarPlantilla('${escapeHtml(r.id)}')" style="
              border:none; background:#0D47A1; color:#fff; font-weight:700; border-radius:10px;
              padding:8px 10px; cursor:pointer;">Editar</button>
            <button type="button" onclick="borrarPlantilla('${escapeHtml(r.id)}')" style="
              border:none; background:#e53935; color:#fff; font-weight:700; border-radius:10px;
              padding:8px 10px; cursor:pointer;">Eliminar</button>
          </td>
        </tr>
      `).join("");

    }catch(e){
      console.error(e);
      alert("Error cargando plantillas.");
    }
  }
  window.renderListaPlantillas = renderListaPlantillas;

  async function guardarPlantillaSupabase(){
    const session = await _getSessionSafe();
    const usuario = (await _getUsuarioLogueado()) || session?.user?.email || "";

    const id = (document.getElementById("tpl_id")?.value || "").trim() || uuid();
    const nombre = (document.getElementById("tpl_nombre")?.value || "").trim();
    const proc = (document.getElementById("tpl_procedimiento")?.value || "").trim();
    const cont = (document.getElementById("tpl_contenido")?.value || "");

    if (!nombre) { alert("Falta el nombre de la plantilla."); return; }
    if (!proc) { alert("Falta el procedimiento asociado."); return; }
    if (!cont.trim()) { alert("El contenido est√° vac√≠o."); return; }

    try{
      const payload = {
        id,
        nombre,
        procedimiento: proc,
        contenido: cont,
        creado_por: usuario,
        actualizado_en: new Date().toISOString()
      };

      const { error } = await window.supabase
        .from(TBL_TPLS)
        .upsert(payload, { onConflict:"id" });

      if (error) throw error;

      document.getElementById("tpl_id").value = id;
      alert("‚úÖ Plantilla guardada.");
      renderListaPlantillas();

    }catch(e){
      console.error(e);
      alert("Error guardando plantilla.");
    }
  }
  window.guardarPlantillaSupabase = guardarPlantillaSupabase;

  async function cargarPlantilla(id){
    try{
      const { data, error } = await window.supabase
        .from(TBL_TPLS)
        .select("*")
        .eq("id", id)
        .single();

      if (error) throw error;

      document.getElementById("tpl_id").value = data.id || "";
      document.getElementById("tpl_nombre").value = data.nombre || "";
      document.getElementById("tpl_procedimiento").value = data.procedimiento || "";
      document.getElementById("tpl_contenido").value = data.contenido || "";

    }catch(e){
      console.error(e);
      alert("Error cargando plantilla.");
    }
  }
  window.cargarPlantilla = cargarPlantilla;

  async function borrarPlantilla(id){
    if (!confirm("¬øSeguro que deseas eliminar esta plantilla?")) return;
    try{
      const { error } = await window.supabase
        .from(TBL_TPLS)
        .delete()
        .eq("id", id);

      if (error) throw error;

      alert("‚úÖ Plantilla eliminada.");
      renderListaPlantillas();
      nuevaPlantillaUI();

    }catch(e){
      console.error(e);
      alert("Error eliminando plantilla.");
    }
  }
  window.borrarPlantilla = borrarPlantilla;

  async function eliminarPlantillaSupabase(){
    const id = (document.getElementById("tpl_id")?.value || "").trim();
    if (!id) { alert("No hay plantilla cargada."); return; }
    return borrarPlantilla(id);
  }
  window.eliminarPlantillaSupabase = eliminarPlantillaSupabase;

  function _applyVars(template, vars){
    let out = String(template || "");
    Object.entries(vars || {}).forEach(([k,v]) => {
      out = out.replaceAll(`{{${k}}}`, String(v ?? ""));
    });
    return out;
  }

  async function probarPlantillaEnDocumento(){
    const tpl = (document.getElementById("tpl_contenido")?.value || "");
    if (!tpl.trim()) { alert("La plantilla est√° vac√≠a."); return; }

    const paciente = (document.getElementById("paciente_nombre")?.value || "").trim();
    const cedula = (document.getElementById("paciente_numdoc")?.value || "").trim();
    const proc = (document.getElementById("doc_procedimiento")?.value || "").trim() || (document.getElementById("tpl_procedimiento")?.value || "").trim();
    const prof = (document.getElementById("doc_profesional")?.value || "").trim();
    const fecha = (document.getElementById("doc_fecha")?.value || "").trim() || _hoyISO();

    const txt = _applyVars(tpl, {
      PACIENTE: paciente,
      CEDULA: cedula,
      PROCEDIMIENTO: proc,
      PROFESIONAL: prof,
      FECHA: fecha
    });

    document.getElementById("doc_texto").value = txt;
    document.getElementById("doc_procedimiento").value = proc;
    alert("‚úÖ Plantilla aplicada en el documento (editor).");
  }
  window.probarPlantillaEnDocumento = probarPlantillaEnDocumento;

  // ==============================
  // ‚úÖ AUTO PLANTILLA SEG√öN PROCEDIMIENTO (AUTO/GENERICA)
  // ==============================
  async function _autocompletarTextoDocumento(){
    const modo = (document.getElementById("doc_template")?.value || "AUTO").trim();
    const proc = (document.getElementById("doc_procedimiento")?.value || "").trim();
    const docText = document.getElementById("doc_texto");

    if (!docText) return;
    if (docText.value.trim()) return; // si ya escribi√≥, no sobrescribir

    // Si no hay procedimiento, no generar
    if (!proc) return;

    const session = await _getSessionSafe();
    const usuario = (await _getUsuarioLogueado()) || session?.user?.email || "";

    try{
      let rows = [];

      if (modo === "AUTO") {
        const r = await window.supabase
          .from(TBL_TPLS)
          .select("*")
          .eq("creado_por", usuario)
          .eq("procedimiento", proc)
          .order("actualizado_en", { ascending:false });

        if (r.error) throw r.error;
        rows = r.data || [];
      }

      // fallback: GENERICA o no encontr√≥ espec√≠fica
      if (!rows.length) {
        const r2 = await window.supabase
          .from(TBL_TPLS)
          .select("*")
          .eq("creado_por", usuario)
          .eq("procedimiento", "GENERICA")
          .order("actualizado_en", { ascending:false });

        if (r2.error) throw r2.error;
        rows = r2.data || [];
      }

      if (!rows.length) {
        // fallback final: texto base
        docText.value =
`CONSENTIMIENTO INFORMADO

Yo, {{PACIENTE}} identificado(a) con {{CEDULA}}, declaro que he recibido informaci√≥n clara sobre el procedimiento: {{PROCEDIMIENTO}}, sus beneficios, riesgos, alternativas y cuidados posteriores.

Profesional: {{PROFESIONAL}}
Fecha: {{FECHA}}

Acepto voluntariamente la realizaci√≥n del procedimiento.`;
      } else {
        docText.value = rows[0].contenido || "";
      }

      // reemplazar variables
      const paciente = (document.getElementById("paciente_nombre")?.value || "").trim();
      const cedula = (document.getElementById("paciente_numdoc")?.value || "").trim();
      const prof = (document.getElementById("doc_profesional")?.value || "").trim();
      const fecha = (document.getElementById("doc_fecha")?.value || "").trim() || _hoyISO();

      docText.value = _applyVars(docText.value, {
        PACIENTE: paciente,
        CEDULA: cedula,
        PROCEDIMIENTO: proc,
        PROFESIONAL: prof,
        FECHA: fecha
      });

    }catch(e){
      console.warn("No se pudo autocompletar documento:", e);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const p = document.getElementById("doc_procedimiento");
    const t = document.getElementById("doc_template");
    const f = document.getElementById("doc_fecha");
    const pr = document.getElementById("doc_profesional");
    [p,t,f,pr].forEach(el => el?.addEventListener("change", _autocompletarTextoDocumento));
    [p,pr].forEach(el => el?.addEventListener("blur", _autocompletarTextoDocumento));
  });

  // ==============================
  // ‚úÖ EVOLUCIONES: tabla en historia (solo listar)
  // ==============================
  function _soloFechaYYYYMMDD(s){
    if (!s) return "";
    try { return String(s).slice(0,10); } catch(e){ return ""; }
  }
  function _soloHoraHHMM(s){
    if (!s) return "";
    try { return String(s).slice(0,5); } catch(e){ return ""; }
  }

  async function cargarEvolucionesPaciente(cedula){
    const tb = document.getElementById("tabla_evoluciones");
    if (!tb) return;
    tb.innerHTML = "";
    if (!cedula) return;

    try{
      const { data, error } = await window.supabase
        .from(TBL_EVOS)
        .select("id, fecha, hora, profesional, procedimiento, detalle")
        .eq("cedula_paciente", cedula)
        .order("fecha", { ascending:false })
        .order("hora", { ascending:false });

      if (error) throw error;

      const rows = data || [];
      tb.innerHTML = rows.map(r => `
        <tr>
          <td>${escapeHtml(r.id || "")}</td>
          <td>${escapeHtml(_soloFechaYYYYMMDD(r.fecha || ""))}</td>
          <td>${escapeHtml(_soloHoraHHMM(r.hora || ""))}</td>
          <td>${escapeHtml(String(r.profesional||"").toUpperCase())}</td>
          <td>${escapeHtml(String(r.procedimiento||"").toUpperCase())}</td>
          <td style="white-space:pre-wrap;">${escapeHtml(r.detalle || "")}</td>
          <td style="white-space:nowrap;">
            <button type="button" class="btn btn-agenda" style="width:auto; padding:8px 10px;"
              onclick="abrirModalEvoluciones()">Abrir</button>
          </td>
        </tr>
      `).join("");

    }catch(e){
      console.error(e);
      // no alert aqu√≠ para no molestar
    }
  }

  // ==============================
  // ‚úÖ RECOLECTAR CHECKBOXES
  // ==============================
  function getCheckValues(name){
    return Array.from(document.querySelectorAll(`input[type="checkbox"][name="${name}"]:checked`))
      .map(cb => cb.value);
  }

  // ==============================
  // ‚úÖ ODONTOGRAMA: aqu√≠ asumo que ya tienes el JS del odontograma en otra parte.
  // Si no, d√©jame y te lo pego completo. Por ahora solo aseguro un objeto global:
  // ==============================
  window.odontogramaData = window.odontogramaData || {};

  // ==============================
  // ‚úÖ GUARDAR HISTORIA + ENVIAR A N8N
  // ==============================
  async function enviarAN8N(){
    const cedula = (document.getElementById("paciente_numdoc")?.value || "").trim();
    if (!cedula) { alert("‚ö†Ô∏è Falta la c√©dula del paciente."); return; }

    // ‚ö†Ô∏è IMPORTANTE:
    // odontogramaCompleto debe existir seg√∫n tu odontograma.
    // Aqu√≠ intento construirlo desde window.odontogramaData, si tu estructura ya es FDI -> caras.
    const odontogramaCompleto = window.odontogramaData || {};

    // payload historia
    const payloadHistoria = {
      // identificador
      cedula_paciente: cedula,

      // b√°sicos
      paciente_nombre: (document.getElementById("paciente_nombre")?.value || "").trim(),
      paciente_edad: (document.getElementById("paciente_edad")?.value || "").trim(),
      idtipo: getCheckValues("idtipo"),
      paciente_lugardoc: (document.getElementById("paciente_lugardoc")?.value || "").trim(),
      paciente_nacimiento: (document.getElementById("paciente_nacimiento")?.value || "").trim(),
      paciente_lugarnac: (document.getElementById("paciente_lugarnac")?.value || "").trim(),
      paciente_direccion: (document.getElementById("paciente_direccion")?.value || "").trim(),
      Ciudad_de_Residencia: (document.getElementById("Ciudad_de_Residencia")?.value || "").trim(),
      EPS_Paciente: (document.getElementById("EPS_Paciente")?.value || "").trim(),
      paciente_ocupacion: (document.getElementById("paciente_ocupacion")?.value || "").trim(),
      paciente_tel: (document.getElementById("paciente_tel")?.value || "").trim(),
      paciente_ciudad: (document.getElementById("paciente_ciudad")?.value || "").trim(),
      paciente_cel: (document.getElementById("paciente_cel")?.value || "").trim(),
      paciente_email: (document.getElementById("paciente_email")?.value || "").trim(),
      paciente_estadocivil: (document.getElementById("paciente_estadocivil")?.value || "").trim(),
      hijos: getCheckValues("hijos"),

      // acudiente
      padre_nombre: (document.getElementById("padre_nombre")?.value || "").trim(),
      madre_nombre: (document.getElementById("madre_nombre")?.value || "").trim(),
      padre_tel: (document.getElementById("padre_tel")?.value || "").trim(),
      madre_tel: (document.getElementById("madre_tel")?.value || "").trim(),
      padre_eps: (document.getElementById("padre_eps")?.value || "").trim(),
      madre_eps: (document.getElementById("madre_eps")?.value || "").trim(),
      padre_tipo: (document.getElementById("padre_tipo")?.value || "").trim(),
      madre_tipo: (document.getElementById("madre_tipo")?.value || "").trim(),

      // emergencia
      emergencia_nombre: (document.getElementById("emergencia_nombre")?.value || "").trim(),
      emergencia_parentesco: (document.getElementById("emergencia_parentesco")?.value || "").trim(),
      emergencia_tel: (document.getElementById("emergencia_tel")?.value || "").trim(),
      emergencia_cel: (document.getElementById("emergencia_cel")?.value || "").trim(),

      // historia m√©dica
      grave: getCheckValues("grave"),
      grave_cual: (document.getElementById("grave_cual")?.value || "").trim(),
      condiciones: getCheckValues("condiciones"),
      otra_cual: (document.getElementById("otra_cual")?.value || "").trim(),

      coagulacion: getCheckValues("coagulacion"),
      anticoagulantes: getCheckValues("anticoagulantes"),
      toma_medicicamentos: getCheckValues("toma_medicamentos"),
      medicamentos_cuales: (document.getElementById("medicamentos_cuales")?.value || "").trim(),
      med_dosis: (document.getElementById("med_dosis")?.value || "").trim(),
      alergia_meds: (document.getElementById("alergia_meds")?.value || "").trim(),

      alcohol: getCheckValues("alcohol"),
      fuma: getCheckValues("fuma"),
      drogas: getCheckValues("drogas"),

      // mujeres
      embarazos_partos: getCheckValues("embarazos_partos"),
      numero_hijos: (document.getElementById("numero_hijos")?.value || "").trim(),
      embarazada: getCheckValues("embarazada"),
      tiempo_embarazo: (document.getElementById("tiempo_embarazo")?.value || "").trim(),
      anticonceptivos: getCheckValues("anticonceptivos"),
      histerectomia_menopausia: getCheckValues("histerectomia_menopausia"),

      // odontol√≥gica
      motivo_consulta: (document.getElementById("motivo_consulta")?.value || "").trim(),
      dolor: getCheckValues('dolor[]'),
      tratamientos: getCheckValues("tratamientos"),

      // odontograma
      odontograma_json: odontogramaCompleto,

      actualizado_en: new Date().toISOString()
    };

    try{
      // ‚úÖ 1) Guardar/actualizar en Supabase
      const session = await _getSessionSafe();
      const usuario = await _getUsuarioLogueado();

      const row = {
        ...payloadHistoria,
        creado_por: usuario || session?.user?.email || null
      };

      const { error } = await window.supabase
        .from(TBL_HISTORIA)
        .upsert(row, { onConflict: "cedula_paciente" });

      if (error) throw error;

      // ‚úÖ 2) Preparar HTML ‚Äúbonito‚Äù para enviar/guardar (opcional)
      const evos = []; // si quieres incluirlas en el env√≠o: carga primero desde supabase
      const htmlResumen =
        `<div>
          <h2>Historia Cl√≠nica Odontol√≥gica</h2>
          <div><b>Paciente:</b> ${escapeHtml(row.paciente_nombre)} (${escapeHtml(row.cedula_paciente)})</div>
          <div><b>Edad:</b> ${escapeHtml(row.paciente_edad)}</div>
          <hr/>
          ${_odontogramaToHTML(odontogramaCompleto)}
          <hr/>
          ${_evolucionesToHTML(evos)}
        </div>`;

      // ‚úÖ 3) Enviar a N8N (tu form oculto)
      const usuario_logueado = usuario || session?.user?.email || "";

      const dataN8N = {
        historia: payloadHistoria,
        html_resumen: htmlResumen,
        usuario_logueado
      };

      document.getElementById("dataN8N").value = JSON.stringify(dataN8N);
      document.getElementById("usuarioN8N").value = usuario_logueado;

      document.getElementById("formN8N").submit();

      alert("‚úÖ Historia guardada y enviada.");

      // refrescar docs/evoluciones por si algo cambi√≥
      await cargarDocumentosPaciente(cedula);
      await cargarEvolucionesPaciente(cedula);

    }catch(e){
      console.error(e);
      alert("Error guardando/enviando. Revisa consola.");
    }
  }
  window.enviarAN8N = enviarAN8N;

  // ==============================
  // ‚úÖ IMPRIMIR HISTORIA CL√çNICA (con html2canvas)
  // ==============================
  async function imprimirHistoriaClinica(){
    const cedula = (document.getElementById("paciente_numdoc")?.value || "").trim();
    if (!cedula) { alert("‚ö†Ô∏è Primero carga/busca el paciente."); return; }

    // ‚úÖ arma un HTML imprimible con los datos actuales
    const paciente = (document.getElementById("paciente_nombre")?.value || "").trim();
    const edad = (document.getElementById("paciente_edad")?.value || "").trim();

    const odontogramaCompleto = window.odontogramaData || {};

    const html =
`<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Historia ${cedula}</title>
<style>
  body{ font-family:system-ui,Segoe UI,Arial; margin:24px; color:#111827; }
  .top{ display:flex; justify-content:space-between; align-items:center; gap:16px; }
  .logo{ height:64px; object-fit:contain; }
  h1{ margin:16px 0 8px; font-size:20px; }
  h2{ margin:16px 0 8px; font-size:16px; }
  .box{ border:1px solid #e5e7eb; border-radius:12px; padding:14px; margin-top:12px; }
  .muted{ color:#6b7280; }
  table.t{ width:100%; border-collapse:collapse; }
  table.t th, table.t td{ border:1px solid #e5e7eb; padding:8px; font-size:13px; }
  table.t thead tr{ background:#f3f4f6; }
  td.k{ width:260px; font-weight:700; }
</style>
</head>
<body>
  <div class="top">
    <div>
      <div style="font-weight:900; font-size:20px;">Historia Cl√≠nica Odontol√≥gica</div>
      <div class="muted">Generada desde el sistema</div>
    </div>
    ${LOGO_CLINICA ? `<img class="logo" src="${LOGO_CLINICA}" alt="Logo"/>` : ``}
  </div>

  <h1>Paciente</h1>
  <div class="box">
    <div><b>Nombre:</b> ${escapeHtml(paciente)}</div>
    <div><b>C√©dula:</b> ${escapeHtml(cedula)}</div>
    <div><b>Edad:</b> ${escapeHtml(edad)}</div>
  </div>

  <h2>Odontograma</h2>
  <div class="box">
    ${_odontogramaToHTML(odontogramaCompleto)}
  </div>

  <div class="muted" style="margin-top:16px;">
    (Usa ‚ÄúImprimir‚Äù y guarda como PDF desde el navegador.)
  </div>
</body>
</html>`;

    const w = window.open("", "_blank");
    w.document.open();
    w.document.write(html);
    w.document.close();
    w.focus();
    w.print();
  }
  window.imprimirHistoriaClinica = imprimirHistoriaClinica;

  // ==============================
  // ‚úÖ CERRAR MODALES CON ESC
  // ==============================
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      try { cerrarModalVerDoc(); } catch(err){}
      try { cerrarModalPlantillas(); } catch(err){}
      try { cerrarModalEvoluciones(); } catch(err){}
    }
  });

  // ==============================
  // ‚úÖ INIT: si viene ?cedula= en la URL
  // ==============================
  document.addEventListener("DOMContentLoaded", async () => {
    const u = new URL(location.href);
    const ced = (u.searchParams.get("cedula") || "").trim();
    if (ced){
      const bc = document.getElementById("buscar_cedula");
      if (bc) bc.value = ced;
      await buscarHistoria();
    }
  });

</script>

</body>
</html>





