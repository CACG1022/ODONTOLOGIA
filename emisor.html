<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Emisor DIAN · Configuración Empresa</title>

  <!-- Tipografía profesional -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsImJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
    );

    const LOGIN_URL = "login.html";
    const INDEX_URL = "index.html";

  async function verificarSesionYPermisos(){
  const { data: { session } } = await supabase.auth.getSession();

  if (!session) {
    window.location.href = LOGIN_URL;
    return;
  }

const { data: perfil, error } = await supabase
  .from("profiles")
  .select("role")
  .eq("id", session.user.id)
  .single();

if (error) {
  console.error("Error leyendo perfil:", error);
  alert("❌ No se pudo verificar el rol del usuario");
  window.location.href = INDEX_URL;
  return;
}

const rol = String(perfil?.role || "").toLowerCase();

if (rol !== "admin") {
  alert("⛔ Solo el administrador puede acceder a este módulo.");
  window.location.href = INDEX_URL;
  return;
}

console.log("✅ Acceso Emisor DIAN autorizado (rol admin)");

}



    verificarSesionYPermisos();

    let EMISOR_ID = null;

    async function cargarEmisor(){
      const { data } = await supabase
        .from("emisor_dian")
        .select("*")
        .limit(1)
        .maybeSingle();

      if(data){
        EMISOR_ID = data.id;
        Object.keys(data).forEach(k=>{
          const el = document.getElementById(k);
          if(el) el.value = data[k] ?? "";
        });
        activo.checked = !!data.activo;
      }
    }

    async function guardarEmisor(){
      const payload = {
        nit: nit.value,
        dv: dv.value,
        razon_social: razon_social.value,
        nombre_comercial: nombre_comercial.value,
        direccion: direccion.value,
        municipio: municipio.value,
        departamento: departamento.value,
        codigo_municipio: codigo_municipio.value,
        pais: pais.value,
        correo: correo.value,
        telefono: telefono.value,
        resolucion_numero: resolucion_numero.value,
        resolucion_fecha: resolucion_fecha.value || null,
        prefijo: prefijo.value,
        rango_desde: rango_desde.value ? parseInt(rango_desde.value) : null,
        rango_hasta: rango_hasta.value ? parseInt(rango_hasta.value) : null,
        ambiente: ambiente.value,
        activo: activo.checked
      };

      const res = EMISOR_ID
        ? await supabase.from("emisor_dian").update(payload).eq("id", EMISOR_ID)
        : await supabase.from("emisor_dian").insert([payload]);

      if(res.error){
        alert("❌ Error guardando información");
        console.error(res.error);
        return;
      }

      alert("✅ Emisor guardado correctamente");
      cargarEmisor();
    }

    window.onload = cargarEmisor;
    window.guardarEmisor = guardarEmisor;
  </script>

  <style>
    :root{
      --bg:#f4f6f9;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --brand:#2563eb;
      --radius:16px;
      --shadow:0 18px 40px rgba(15,23,42,.08);
      --font:"Inter",system-ui,Arial;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:var(--font);
      background:var(--bg);
      color:var(--text);
      padding:32px 16px;
    }

    .wrap{
      max-width:980px;
      margin:auto;
    }

    h1{
      text-align:center;
      font-size:26px;
      font-weight:900;
      margin-bottom:6px;
    }

    .subtitle{
      text-align:center;
      color:var(--muted);
      font-size:14px;
      margin-bottom:24px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:26px;
      border:1px solid var(--line);
    }

    .section{
      margin-bottom:28px;
    }

    .section h3{
      margin:0 0 14px;
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:18px 22px;
    }

    .full{ grid-column:1/-1; }

    label{
      font-size:12px;
      font-weight:700;
      color:var(--muted);
      margin-bottom:6px;
      display:block;
    }

    input, select{
      width:100%;
      padding:14px 14px;
      border-radius:12px;
      border:1.6px solid var(--line);
      font-size:14px;
      font-family:var(--font);
      outline:none;
      background:#fff;
    }

    input:focus, select:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 4px rgba(37,99,235,.12);
    }

    .checkline{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:10px;
      font-size:14px;
      font-weight:700;
    }

    .actions{
      display:flex;
      justify-content:flex-end;
      margin-top:10px;
    }

    button{
      padding:14px 26px;
      border:none;
      border-radius:14px;
      background:var(--brand);
      color:#fff;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(37,99,235,.35);
    }

    button:hover{
      filter:brightness(.96);
      transform:translateY(-1px);
    }

    @media(max-width:700px){
      .grid{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Emisor DIAN</h1>
    <div class="subtitle">
      Información fiscal y de facturación electrónica de la empresa
    </div>

    <div class="card">

      <div class="section">
        <h3>Identificación</h3>
        <div class="grid">
          <div><label>NIT</label><input id="nit"></div>
          <div><label>DV</label><input id="dv"></div>
          <div class="full"><label>Razón social</label><input id="razon_social"></div>
          <div class="full"><label>Nombre comercial</label><input id="nombre_comercial"></div>
        </div>
      </div>

      <div class="section">
        <h3>Ubicación</h3>
        <div class="grid">
          <div class="full"><label>Dirección</label><input id="direccion"></div>
          <div><label>Municipio</label><input id="municipio"></div>
          <div><label>Departamento</label><input id="departamento"></div>
          <div><label>Código municipio</label><input id="codigo_municipio"></div>
          <div><label>País</label><input id="pais" value="CO"></div>
        </div>
      </div>

      <div class="section">
        <h3>Contacto</h3>
        <div class="grid">
          <div><label>Correo</label><input id="correo" type="email"></div>
          <div><label>Teléfono</label><input id="telefono"></div>
        </div>
      </div>

      <div class="section">
        <h3>Resolución DIAN</h3>
        <div class="grid">
          <div><label>No. Resolución</label><input id="resolucion_numero"></div>
          <div><label>Fecha resolución</label><input id="resolucion_fecha" type="date"></div>
          <div><label>Prefijo</label><input id="prefijo"></div>
          <div><label>Rango desde</label><input id="rango_desde" type="number"></div>
          <div><label>Rango hasta</label><input id="rango_hasta" type="number"></div>
          <div>
            <label>Ambiente</label>
            <select id="ambiente">
              <option value="PRUEBAS">PRUEBAS</option>
              <option value="PRODUCCION">PRODUCCIÓN</option>
            </select>
          </div>
        </div>

        <div class="checkline">
          <input type="checkbox" id="activo">
          Emisor activo
        </div>
      </div>

      <div class="actions">
        <button onclick="guardarEmisor()">Guardar información</button>
      </div>

    </div>
  </div>
</body>
</html>

