<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Facturaci√≥n - Cl√≠nica Odontol√≥gica</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg: #f3f5f7;
      --card: #ffffff;
      --text: #1f2a37;
      --muted: #6b7280;
      --line: #e5e7eb;
      --brand: #1f6aa5;
      --brand2: #114a75;
      --danger: #b42318;
      --shadow: 0 10px 30px rgba(16,24,40,.08);
      --radius: 14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 18px;
    }
    .topbar{
      max-width: 1100px;
      margin: 0 auto 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand h1{ font-size: 16px; margin:0; }
    .meta{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    /* ‚úÖ Chip multi-l√≠nea para Usuario + Rol */
    .chip{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--muted);
      box-shadow: 0 3px 10px rgba(0,0,0,.03);
      white-space:nowrap;
      display:flex;
      flex-direction:column;
      gap:4px;
      line-height:1.2;
    }
    .chip b{ color: var(--text); }
    .chip .line{ display:flex; gap:6px; align-items:baseline; }
    .chip .line span{ color: var(--muted); }
    .chip .line small{ color: var(--muted); font-weight:700; }
    .container{
      max-width: 1100px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .header{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .header .title{ font-weight:800; font-size: 14px; }
    .section{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      background: #fff;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .ctrl label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin-bottom:6px;
      font-weight:700;
    }
    input, select{
      width:100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      font-size: 14px;
      background:#fff;
    }
    .row-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    .btn{
      border: 1px solid var(--line);
      background: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 800;
      color: var(--text);
    }
    .btn:hover{ filter: brightness(.98); }
    .btn.primary{
      background: var(--brand);
      color:#fff;
      border-color: var(--brand);
    }
    .btn.primary:hover{ background: var(--brand2); border-color: var(--brand2); }
    .btn.danger{ color: var(--danger); border-color:#f2c6c6; }
    .btn.small{ padding: 8px 10px; font-size: 12px; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    table{ width:100%; border-collapse: collapse; }
    th, td{
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      text-align:left;
      vertical-align: middle;
    }
    th{
      font-size: 12px;
      color: var(--muted);
      background: #fafafa;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    td input{ padding: 8px 10px; }
    td.actions{ width: 120px; white-space: nowrap; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .empty{ color: var(--muted); text-align:center; padding: 18px; }
    .totales{
      display:flex;
      justify-content:flex-end;
      padding: 12px 16px;
      gap: 18px;
      border-top: 1px solid var(--line);
      background:#fbfcfd;
      flex-wrap:wrap;
    }
    .totales .box{
      min-width: 260px;
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      padding: 12px;
    }
    .totales .box div{
      display:flex;
      justify-content:space-between;
      padding: 5px 0;
      font-size: 13px;
      gap: 10px;
      align-items:center;
    }
    .actions-bottom{
      padding: 12px 16px;
      border-top: 1px solid var(--line);
      background:#fff;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      flex-wrap:wrap;
    }
    .actions-bottom .left-note{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      flex: 1 1 380px;
    }
    .actions-bottom .btns{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .footer{
      padding: 12px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      color: var(--muted);
      font-size: 12px;
      border-top: 1px solid var(--line);
      background: #fff;
    }
    #toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      box-shadow: var(--shadow);
      font-weight: 800;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .15s ease, transform .15s ease;
      pointer-events: none;
      max-width: 340px;
      white-space: pre-wrap;
    }
    #toast.show{ opacity: 1; transform: translateY(0); }
    #toast[data-type="ok"]{ border-color: #b7e4c7; }
    #toast[data-type="err"]{ border-color: #f2c6c6; }
    #toast[data-type="warn"]{ border-color: #ffe7b3; }
    /* ‚úÖ MODAL FACTURAS */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal.show{ display:flex; }
    .modal-card{
      width: min(1100px, 100%);
      background:#fff;
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
      transition: all 0.2s ease;
    }
    .modal-head{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background:#fff;
    }
    .modal-head .title{ font-weight: 900; }
    .modal-body{
      padding: 12px 14px;
      background:#fff;
    }
    .modal-tools{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      margin-bottom: 10px;
    }
    .modal-tools .ctrl{ min-width: 200px; }
    .modal-table{
      max-height: 60vh;
      overflow:auto;
      border: 1px solid var(--line);
      border-radius: 12px;
    }
    /* ‚úÖ CSS PARA MAXIMIZAR MODAL */
    .modal.maximized{
      padding: 0 !important;
    }
    .modal.maximized .modal-card{
      width: 100vw !important;
      height: 100vh !important;
      max-width: none !important;
      border-radius: 0 !important;
      display: flex;
      flex-direction: column;
    }
    .modal.maximized .modal-body{
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modal.maximized .modal-table{
      flex: 1;
      max-height: none;
    }
    
    /* ‚úÖ resumen total facturado */
    .modal-summary{
      margin-top: 10px;
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .summary-chip{
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      background:#fff;
      box-shadow: 0 3px 10px rgba(0,0,0,.03);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .summary-chip b{ color: var(--text); }
    @media (max-width: 900px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px){
      .grid{ grid-template-columns: 1fr; }
      .actions-bottom{ justify-content:flex-start; }
      .actions-bottom .btns{ width:100%; justify-content:flex-start; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <h1>CL√çNICA ODONTOL√ìGICA ‚Äî Facturaci√≥n</h1>
    </div>
    <div class="meta">
      <div class="chip">
        <div class="line"><span>Usuario:</span> <b id="user-email">‚Äî</b></div>
        <div class="line"><small>Rol:</small> <b id="user-role">‚Äî</b></div>
      </div>
      <button class="btn danger" id="btn-logout" type="button">Cerrar sesi√≥n</button>
    </div>
  </div>
  <div class="container">
    <div class="header">
      <div class="title">Nueva factura</div>
      <div class="row-actions" style="margin-top:0;">
        <button class="btn" id="btn-back" type="button">‚¨Ö Volver</button>
        <button class="btn" id="btn-ver-facturas" type="button">üìÑ Ver facturas</button>
      </div>
    </div>
    <div class="section">
      <div class="grid">
        <div class="ctrl">
          <label>Fecha</label>
          <input id="fecha" type="date">
        </div>
        <div class="ctrl">
          <label>No. factura</label>
          <input id="numero_factura" type="text">
        </div>
        <div class="ctrl">
          <label>Tipo usuario</label>
          <select id="tipo_usuario">
            <option>Particular</option>
            <option>Contributivo</option>
            <option>Subsidiado</option>
          </select>
        </div>
        <div class="ctrl">
          <label>EPS (si aplica)</label>
          <input id="eps" type="text" placeholder="Opcional">
        </div>
      </div>
    </div>
    <div class="section">
      <div class="grid">
        <div class="ctrl">
          <label>C√©dula paciente</label>
          <input id="paciente_cedula" inputmode="numeric" placeholder="Solo n√∫meros">
          <div style="margin-top:6px; font-size:12px; color:var(--muted);" id="paciente-hint"></div>
        </div>
        <div class="ctrl">
          <label>Nombre paciente</label>
          <input id="paciente_nombre" type="text" placeholder="Nombres y apellidos">
        </div>
        <div class="ctrl">
          <label>Profesional</label>
          <select id="profesional"></select>
        </div>
        <div class="ctrl">
          <label>&nbsp;</label>
          <button class="btn" id="btn-buscar" type="button">üîé Autocompletar (si existe)</button>
        </div>
        <div class="ctrl" style="grid-column: span 2;">
          <label>Correo paciente</label>
          <input id="paciente_correo" type="email" placeholder="correo@ejemplo.com">
        </div>
      </div>
    </div>
    <div class="section">
      <div class="grid">
        <div class="ctrl">
          <label>M√©todo de pago</label>
          <select id="metodo_pago">
            <option value="Efectivo" selected>Efectivo</option>
            <option value="Transferencia">Transferencia</option>
            <option value="Tarjeta">Tarjeta</option>
            <option value="Nequi">Nequi</option>
            <option value="Daviplata">Daviplata</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        <div class="ctrl">
          <label>Estado de pago</label>
          <select id="pagada">
            <option value="si" selected>Pagada</option>
            <option value="no">Pendiente</option>
          </select>
        </div>
        <div class="ctrl" style="grid-column: span 2;">
          <label>Referencia / Comprobante (opcional)</label>
          <input id="referencia_pago" type="text" placeholder="Ej: #transferencia, voucher, √∫ltimo 4 d√≠gitos, etc.">
        </div>
        <div class="ctrl" style="grid-column: span 4;">
          <label>Observaci√≥n (opcional)</label>
          <input id="observacion" type="text" placeholder="Ej: referencia/nota/observaci√≥n...">
        </div>
      </div>
    </div>
    <div class="section">
      <div class="grid">
        <div class="ctrl" style="grid-column: span 2;">
          <label>Agregar procedimiento</label>
          <select id="sel-proc"></select>
        </div>
        <div class="ctrl">
          <label>Cantidad</label>
          <input id="cantidad" type="number" min="1" step="1" value="1">
        </div>
        <div class="ctrl">
          <label>&nbsp;</label>
          <button class="btn primary" id="btn-add" type="button">‚ûï Agregar</button>
        </div>
      </div>
      <div style="margin-top:12px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:140px;">CUPS</th>
              <th>Procedimiento</th>
              <th style="width:110px;">Cant</th>
              <th style="width:160px;">V/Unit</th>
              <th style="width:160px;">Total</th>
              <th style="width:120px;"></th>
            </tr>
          </thead>
          <tbody id="tbody-items"></tbody>
        </table>
      </div>
    </div>
    <div class="totales">
      <div class="box">
        <div><span>Subtotal</span><b>$ <span id="subtotal">0</span></b></div>
        <div>
          <span>¬øAplica IVA?</span>
          <b>
            <select id="iva_aplica" style="width:140px;">
              <option value="no">No</option>
              <option value="si" selected>S√≠</option>
            </select>
          </b>
        </div>
        <div style="align-items:flex-start;">
          <span>IVA</span>
          <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
            <div style="display:flex; gap:8px; align-items:center;">
              <span style="color:var(--muted); font-weight:700;">%</span>
              <input id="iva_porcentaje" type="number" min="0" step="0.01" value="19" style="width:140px; text-align:right;">
            </div>
            <div class="mono" style="color:var(--muted);">IVA: $ <span id="iva_valor">0</span></div>
          </div>
        </div>
        <div>
          <span>Copago</span>
          <b>$ <input id="copago" type="number" min="0" step="100" value="0" style="width:140px; text-align:right;"></b>
        </div>
        <div>
          <span>Cuota moderadora</span>
          <b>$ <input id="cuota_moderadora" type="number" min="0" step="100" value="0" style="width:140px; text-align:right;"></b>
        </div>
        <div style="border-top:1px solid var(--line); margin-top:6px; padding-top:8px;">
          <span>Total</span><b>$ <span id="total">0</span></b>
        </div>
      </div>
      <div class="box">
        <div class="mono" style="color:var(--muted);">
          Autocompletado de paciente se hace desde N8N (mismo webhook de Historia Cl√≠nica).
        </div>
      </div>
    </div>
    <div class="actions-bottom">
      <div class="left-note mono">
        Autocompletado de paciente se hace desde N8N (mismo webhook de Historia Cl√≠nica).
      </div>
      <div class="btns">
        <button class="btn primary" id="btn-guardar" type="button">üíæ Guardar factura</button>
        <button class="btn" id="btn-imprimir" type="button" disabled>üñ® Imprimir</button>
      </div>
    </div>
    <div class="footer">
      <div class="status" id="status"></div>
      <div>¬© <span id="year"></span></div>
    </div>
  </div>
  <div id="toast" data-type="ok"></div>
  <div class="modal" id="modal-facturas" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="title">Facturas generadas</div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" id="btn-maximize-facturas" type="button" title="Maximizar/Restaurar">‚õ∂</button>
          <button class="btn" id="btn-export-excel" type="button">‚¨á Excel</button>
          <button class="btn" id="btn-refresh-facturas" type="button">üîÑ Actualizar</button>
          <button class="btn danger" id="btn-cerrar-modal" type="button">‚úñ Cerrar</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="modal-tools">
          <div class="ctrl">
            <label>Buscar (N¬∞ factura o c√©dula)</label>
            <input id="buscar_facturas" type="text" placeholder="Ej: FAC-2026... o 123456789">
          </div>
          <div class="ctrl">
            <label>Fecha desde</label>
            <input id="fecha_desde" type="date">
          </div>
          <div class="ctrl">
            <label>Fecha hasta</label>
            <input id="fecha_hasta" type="date">
          </div>
          <div class="ctrl">
            <label>Estado Pago</label>
            <select id="filtro_estado_pago">
              <option value="">Todos</option>
              <option value="si">Pagada</option>
              <option value="no">Pendiente</option>
            </select>
          </div>
          <div class="ctrl">
            <label>Mostrar</label>
            <select id="limite_facturas">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
            </select>
          </div>
          <div class="ctrl">
            <label>&nbsp;</label>
            <button class="btn primary" id="btn-buscar-facturas" type="button">üîé Buscar</button>
          </div>
        </div>
        <div class="modal-table">
          <table>
            <thead>
              <tr>
                <th style="width:160px;">Fecha</th>
                <th style="width:220px;">N¬∞ Factura</th>
                <th>Paciente</th>
                <th style="width:160px;">C√©dula</th>
                <th style="width:140px;">Pago</th>
                <th style="width:160px;">Total</th>
                <th style="width:260px;">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody-facturas">
              <tr><td colspan="7" class="empty">Cargando...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="modal-summary">
          <div class="summary-chip">
            Total facturado (filtro): <b>$ <span id="total_facturado">0</span></b>
          </div>
          <div class="summary-chip">
            Cantidad: <b><span id="count_facturas">0</span></b>
          </div>
        </div>
        <div class="mono" style="margin-top:10px; color:var(--muted);">
          Tip: Puedes imprimir una factura desde ‚Äúüñ® Imprimir‚Äù en acciones.
        </div>
      </div>
    </div>
  </div>
   
  <div class="modal" id="modal-verfactura" aria-hidden="true">
    <div class="modal-card" style="max-width:1100px;">
      <div class="modal-head">
        <div class="title">Factura</div>
        <div class="modal-tools">
          <button class="btn" id="btn-imprimir-verfactura" type="button">üñ® Imprimir</button>
          <button class="btn danger" id="btn-cerrar-modal-verfactura" type="button">‚úñ Cerrar</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="vf-frame" style="border:1px solid var(--line); border-radius:12px; overflow:hidden;">
          <iframe id="vf_iframe" title="Factura" style="width:100%; height:80vh; border:0; background:#fff;" sandbox="allow-same-origin allow-scripts"></iframe>
        </div>
      </div>
    </div>
  </div>
  <div class="modal" id="modal-abonos" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="title">Abonos de la factura</div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" id="btn-refresh-abonos" type="button">üîÑ Actualizar</button>
          <button class="btn danger" id="btn-cerrar-modal-abonos" type="button">‚úñ Cerrar</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="modal-tools">
          <div class="ctrl" style="min-width:220px;">
            <label>Fecha</label>
            <input id="abono_fecha" type="date">
          </div>
          <div class="ctrl" style="min-width:220px;">
            <label>Monto</label>
            <input id="abono_monto" type="number" min="0" step="100" placeholder="0">
          </div>
          <div class="ctrl" style="min-width:220px;">
            <label>M√©todo</label>
            <select id="abono_metodo">
              <option value="Efectivo" selected>Efectivo</option>
              <option value="Transferencia">Transferencia</option>
              <option value="Tarjeta">Tarjeta</option>
              <option value="Nequi">Nequi</option>
              <option value="Daviplata">Daviplata</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
          <div class="ctrl" style="min-width:260px;">
            <label>Referencia (opcional)</label>
            <input id="abono_referencia" type="text" placeholder="Ej: #transferencia, voucher, etc.">
          </div>
          <div class="ctrl" style="flex:1 1 320px; min-width:260px;">
            <label>Observaci√≥n (opcional)</label>
            <input id="abono_observacion" type="text" placeholder="Nota del abono">
          </div>
          <div class="ctrl" style="min-width:220px;">
            <label>&nbsp;</label>
            <button class="btn primary" id="btn-agregar-abono" type="button">‚ûï Agregar abono</button>
          </div>
        </div>
        <div class="modal-table">
          <table>
            <thead>
              <tr>
                <th style="width:160px;">Fecha</th>
                <th style="width:160px;">Monto</th>
                <th style="width:180px;">M√©todo</th>
                <th>Referencia</th>
                <th>Observaci√≥n</th>
                <th style="width:120px;">Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="tbody-abonos">
              <tr><td colspan="6" class="empty">Selecciona una factura...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="modal-summary">
          <div class="summary-chip">
            Total factura: <b>$ <span id="abonos_total_factura">0</span></b>
          </div>
          <div class="summary-chip">
            Total abonado: <b>$ <span id="abonos_total_abonado">0</span></b>
          </div>
          <div class="summary-chip">
            Saldo: <b>$ <span id="abonos_saldo">0</span></b>
          </div>
        </div>
        <div class="mono" style="margin-top:10px; color:var(--muted);">
          Nota: Para guardar abonos en Supabase crea la tabla <b>abonos</b>. Si no existe, el sistema te mostrar√° un aviso.
        </div>
      </div>
    </div>
  </div>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const SUPABASE_URL = "https://dmcfrmpqlkrqbpjhrfyo.supabase.co".trim();
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE".trim();
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const LOGIN_URL = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
    const INDEX_URL = "https://cacg1022.github.io/ODONTOLOGIA/index.html";
    const LOGO_URL = "https://static.wixstatic.com/media/63e6ec_3973b230e8aa49869f3127b467fb3e6e~mv2.png/v1/fill/w_426,h_426,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/LOGO%20LEIDI%20SILVA%202%20(1).png";
    const N8N_BUSCAR_URL = "https://ftth-n8n2.pzveh5.easypanel.host/webhook/62804cbf-8f21-453b-823e-e5c1b94f31c8";
    const ALLOWED_ROLES = ["admin", "auxiliar"];
    const state = {
      session: null,
      role: null,
      procedimientos: [],
      profesionales: [],
      items: [],
      facturaGuardada: null,
      _debounce: null,
      _lastCedula: "",
      facturas: [],
      abonos: [],
      facturaAbonos: null
    };
    const $ = (id) => document.getElementById(id);
    function toast(msg, type="ok"){
      const el = $("toast");
      el.textContent = msg;
      el.dataset.type = type;
      el.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=> el.classList.remove("show"), 2600);
    }
    function setStatus(msg){
      const el = $("status");
      if (el) el.textContent = msg || "";
    }
    function setHint(msg){
      const el = $("paciente-hint");
      if (el) el.textContent = msg || "";
    }
    function money(n){
      const x = Number(n || 0);
      return x.toLocaleString("es-CO");
    }
    function num(v){
      const raw = String(v ?? "").trim();
      if (!raw) return 0;
      const n = Number(raw);
      return Number.isFinite(n) ? n : 0;
    }
    function hoyISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    // ‚úÖ NUEVO: validaci√≥n de fecha en formato YYYY-MM-DD (para prompts)
    function parseDateYYYYMMDD(s){
      const v = String(s || "").trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(v)) return null;
      const d = new Date(v + "T00:00:00.000Z");
      if (Number.isNaN(d.getTime())) return null;
      return v;
    }
    function toISODateTimeFromYYYYMMDD(v){
      return v ? (v + "T00:00:00.000Z") : null;
    }
    function generarNumeroFactura(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `FAC-${y}${m}${da}-${hh}${mi}${ss}`;
    }
    async function cargarRolActual(){
      const email = (state.session?.user?.email || "").trim().toLowerCase();
      const elRole = $("user-role");
      if (!email){
        state.role = "user";
        if (elRole) elRole.textContent = "user";
        return "user";
      }
      try{
        const { data, error } = await supabase
          .from("profiles")
          .select("role, created_at, email")
          .eq("email", email)
          .order("created_at", { ascending: false })
          .limit(1)
          .maybeSingle();
        if (error) throw error;
        const role = (data?.role || "").toString().trim().toLowerCase();
        const finalRole = role || "user";
        state.role = finalRole;
        if (elRole) elRole.textContent = finalRole;
        return finalRole;
      } catch(err){
        console.error("No se pudo leer rol en profiles:", err);
        state.role = "user";
        if (elRole) elRole.textContent = "user";
        return "user";
      }
    }
    function getModuloCandidates(mod){
  const base = String(mod || "").toLowerCase().trim();
  const withHtml = base.endsWith(".html") ? base : base + ".html";
  const undersc = base.replaceAll("-", "_");
  const underscHtml = undersc.endsWith(".html") ? undersc : undersc + ".html";
  return Array.from(new Set([base, withHtml, undersc, underscHtml]));
}
async function validarPermisoDesdeTabla(){
  const modulo = "facturacion";
  const role = (state.role || "user").toLowerCase().trim();
  const candidates = getModuloCandidates(modulo);
  try{
    const { data, error } = await supabase
      .from("modulos_permisos")
      .select("admin, doctor, auxiliar, paciente, modulo")
      .in("modulo", candidates);
    if (error) throw error;
    const permiso = data?.[0];
    if (!permiso || permiso[role] !== true){
      window.alert("‚õî No tienes permiso para acceder a este m√≥dulo.");
      window.location.href = INDEX_URL;
      return false;
    }
    return true;
  }catch(err){
    console.error("Error validando permisos:", err);
    window.alert("‚õî No se pudo validar permisos de acceso.");
    window.location.href = INDEX_URL;
    return false;
  }
}
    async function validarAccesoPorRol(){
  return await validarPermisoDesdeTabla();
}
    async function proteger(){
      const { data: { session } } = await supabase.auth.getSession();
      if(!session){
        window.location.href = LOGIN_URL;
        return false;
      }
      state.session = session;
      const email = (session.user?.email || "Usuario").toString();
      $("user-email").textContent = email;
      await cargarRolActual();
      const okRole = await validarAccesoPorRol();
      if (!okRole) return false;
      return true;
    }
    supabase.auth.onAuthStateChange((event, session) => {
      console.log("AUTH EVENT:", event, "SESSION:", !!session);
      if ((event === "SIGNED_OUT" || event === "USER_DELETED") && !session) {
        window.location.href = LOGIN_URL;
      }
      if ((event === "SIGNED_IN" || event === "TOKEN_REFRESHED") && session) {
        state.session = session;
        $("user-email").textContent = session.user?.email || "Usuario";
        cargarRolActual().then(()=> validarAccesoPorRol());
      }
    });
    async function cerrarSesion(){
      try { await supabase.auth.signOut(); } catch(e) {}
      window.location.href = LOGIN_URL;
    }
    async function cargarProcedimientos(){
      const { data, error } = await supabase
        .from("procedimientos_precios")
        .select("id, procedimiento, valor, codigo_cups, activo")
        .order("procedimiento", { ascending: true });
      if (error){
        console.error(error);
        toast("Error procedimientos:\n" + error.message, "err");
        state.procedimientos = [];
        renderProcedimientosSelect();
        return;
      }
      const rows = data || [];
      state.procedimientos = rows.filter(r => (r.activo === null || r.activo === undefined) ? true : r.activo === true);
      renderProcedimientosSelect();
    }
    async function cargarProfesionales(){
      const { data, error } = await supabase
        .from("profesionales")
        .select("id, cedula, nombre, activo")
        .order("nombre", { ascending: true });
      if (error){
        console.error(error);
        toast("Error profesionales:\n" + error.message, "err");
        state.profesionales = [];
        renderProfesionales();
        return;
      }
      const rows = data || [];
      state.profesionales = rows.filter(r => (r.activo === null || r.activo === undefined) ? true : r.activo === true);
      renderProfesionales();
    }
    function renderProcedimientosSelect(){
      const sel = $("sel-proc");
      sel.innerHTML = `<option value="">‚Äî Selecciona ‚Äî</option>`;
      for (const p of state.procedimientos){
        const label = `${p.procedimiento} ‚Äî $${money(p.valor || 0)}${p.codigo_cups ? ` (CUPS ${p.codigo_cups})` : ""}`;
        const opt = document.createElement("option");
        opt.value = String(p.id);
        opt.textContent = label;
        sel.appendChild(opt);
      }
    }
    function renderProfesionales(){
      const sel = $("profesional");
      sel.innerHTML = `<option value="">‚Äî Selecciona ‚Äî</option>`;
      for (const pr of state.profesionales){
        const ced = (pr.cedula ?? "").toString().trim();
        const nom = (pr.nombre ?? "").toString().trim();
        const opt = document.createElement("option");
        opt.value = ced ? `${ced}` : nom;
        opt.textContent = nom;
        sel.appendChild(opt);
      }
    }
    async function buscarPacienteEnHistoria(force = false){
      const cedula = ($("paciente_cedula").value || "")
        .trim()
        .replace(/[^\d]/g, "");
      $("paciente_cedula").value = cedula;
      if (cedula.length < 6){
        setHint("");
        return;
      }
      if (!force && state._lastCedula === cedula) return;
      state._lastCedula = cedula;
      setHint("Buscando paciente...");
      try{
        const url = `${N8N_BUSCAR_URL}?cedula=${encodeURIComponent(cedula)}`;
        const resp = await fetch(url, { method: "GET" });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data?.existe){
          setHint("No encontrado (puedes digitar el nombre).");
          return;
        }
        setHint("‚úÖ Paciente encontrado");
        if(data.nombre) $("paciente_nombre").value = data.nombre;
        if(data.correo) $("paciente_correo").value = data.correo;
        if(data.eps) $("eps").value = data.eps;
      } catch(e){
        setHint("No se pudo buscar (N8N error).");
      }
    }

    // Funciones de Items y Totales
    function addItem(){
      const procId = $("sel-proc").value;
      const cant = num($("cantidad").value);
      if(!procId || cant < 1) return toast("Selecciona procedimiento y cantidad", "warn");
      
      const proc = state.procedimientos.find(p => String(p.id) === procId);
      if(!proc) return;

      state.items.push({
        id: proc.id,
        procedimiento: proc.procedimiento,
        cups: proc.codigo_cups || "",
        valor_unitario: num(proc.valor),
        cantidad: cant,
        total: num(proc.valor) * cant
      });
      renderItems();
      $("cantidad").value = "1";
      $("sel-proc").value = "";
    }

    function removeItem(idx){
      state.items.splice(idx, 1);
      renderItems();
    }

    function renderItems(){
      const tbody = $("tbody-items");
      tbody.innerHTML = "";
      if(state.items.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="empty">No hay procedimientos agregados</td></tr>`;
        calcularTotales();
        return;
      }
      state.items.forEach((item, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.cups}</td>
          <td>${item.procedimiento}</td>
          <td>${item.cantidad}</td>
          <td>$${money(item.valor_unitario)}</td>
          <td>$${money(item.total)}</td>
          <td class="actions"><button class="btn danger small" onclick="window.removeItem(${idx})">Eliminar</button></td>
        `;
        tbody.appendChild(tr);
      });
      calcularTotales();
    }
    window.removeItem = removeItem;

    function calcularTotales(){
      const subtotal = state.items.reduce((acc, it) => acc + it.total, 0);
      const ivaAplica = $("iva_aplica").value === "si";
      const ivaPorc = ivaAplica ? num($("iva_porcentaje").value) : 0;
      const ivaVal = subtotal * (ivaPorc / 100);
      const copago = num($("copago").value);
      const moderadora = num($("cuota_moderadora").value);
      
      const total = subtotal + ivaVal - copago + moderadora;

      $("subtotal").textContent = money(subtotal);
      $("iva_valor").textContent = money(ivaVal);
      $("total").textContent = money(total);
    }

    // Guardar Factura
    async function guardarFactura(){
      if(state.items.length === 0) return toast("Agrega al menos un procedimiento", "warn");
      const cedula = $("paciente_cedula").value.trim();
      const nombre = $("paciente_nombre").value.trim();
      if(!cedula || !nombre) return toast("Faltan datos del paciente", "warn");

      const btn = $("btn-guardar");
      btn.disabled = true;
      btn.textContent = "Guardando...";

      const factura = {
        fecha: $("fecha").value,
        numero_factura: $("numero_factura").value,
        tipo_usuario: $("tipo_usuario").value,
        eps: $("eps").value,
        paciente_cedula: cedula,
        paciente_nombre: nombre,
        paciente_correo: $("paciente_correo").value,
        profesional: $("profesional").value,
        metodo_pago: $("metodo_pago").value,
        pagada: $("pagada").value,
        referencia_pago: $("referencia_pago").value,
        observacion: $("observacion").value,
        subtotal: num($("subtotal").textContent.replace(/\./g, "")),
        iva_porcentaje: $("iva_aplica").value === "si" ? num($("iva_porcentaje").value) : 0,
        iva_valor: num($("iva_valor").textContent.replace(/\./g, "")),
        copago: num($("copago").value),
        cuota_moderadora: num($("cuota_moderadora").value),
        total: num($("total").textContent.replace(/\./g, "")),
      };

      try {
        const { data: factData, error: factError } = await supabase
          .from("facturacion_facturas")
          .insert(factura)
          .select()
          .single();
        
        if(factError) throw factError;

        const itemsToInsert = state.items.map(it => ({
          factura_id: factData.id,
          procedimiento: it.procedimiento,
          cantidad: it.cantidad,
          valor_unitario: it.valor_unitario,
          total: it.total,
          codigo_cups: it.cups
        }));

        const { error: itemsError } = await supabase
          .from("facturacion_items")
          .insert(itemsToInsert);
        
        if(itemsError) throw itemsError;

        toast("Factura guardada correctamente", "ok");
        state.facturaGuardada = factData;
        $("btn-guardar").disabled = false; // Permitir guardar otra si se requiere
        $("btn-guardar").textContent = "üíæ Guardar factura";
        $("btn-imprimir").disabled = false;
        
        // Limpiar formulario b√°sico
        state.items = [];
        renderItems();
        $("numero_factura").value = generarNumeroFactura();

      } catch(err) {
        console.error(err);
        toast("Error guardando: " + err.message, "err");
        btn.disabled = false;
        btn.textContent = "üíæ Guardar factura";
      }
    }

    // Cargar Facturas en Modal
    async function cargarFacturas(){
      const tbody = $("tbody-facturas");
      tbody.innerHTML = `<tr><td colspan="7" class="empty">Cargando...</td></tr>`;
      
      let query = supabase
        .from("facturacion_facturas")
        .select("*", { count: "exact" })
        .order("created_at", { ascending: false });

      const buscar = ($("buscar_facturas").value || "").trim();
      if(buscar){
        // Filtro simple por cedula o numero factura
        query = query.or(`paciente_cedula.ilike.%${buscar}%,numero_factura.ilike.%${buscar}%`);
      }

      const fDesde = $("fecha_desde").value;
      const fHasta = $("fecha_hasta").value;
      if(fDesde) query = query.gte("fecha", fDesde);
      if(fHasta) query = query.lte("fecha", fHasta);

      // ‚úÖ FILTRO ESTADO DE PAGO INTEGRADO
      const estadoPago = $("filtro_estado_pago").value;
      if(estadoPago) {
        query = query.eq("pagada", estadoPago);
      }

      const limite = Number($("limite_facturas").value) || 50;
      query = query.limit(limite);

      const { data, count, error } = await query;

      if(error){
        tbody.innerHTML = `<tr><td colspan="7" class="empty">Error: ${error.message}</td></tr>`;
        return;
      }
      
      state.facturas = data || [];
      $("count_facturas").textContent = count || 0;
      
      const total = state.facturas.reduce((sum, f) => sum + (f.total || 0), 0);
      $("total_facturado").textContent = money(total);

      renderFacturas(state.facturas);
    }

    function renderFacturas(list){
      const tbody = $("tbody-facturas");
      tbody.innerHTML = "";
      if(!list.length){
        tbody.innerHTML = `<tr><td colspan="7" class="empty">No se encontraron facturas</td></tr>`;
        return;
      }
      list.forEach(f => {
        const tr = document.createElement("tr");
        const pagadaColor = f.pagada === "si" ? "green" : "#b42318";
        const pagadaTexto = f.pagada === "si" ? "Pagada" : "Pendiente";
        tr.innerHTML = `
          <td>${f.fecha}</td>
          <td>${f.numero_factura}</td>
          <td>${f.paciente_nombre}</td>
          <td>${f.paciente_cedula}</td>
          <td style="color:${pagadaColor}; font-weight:bold;">${pagadaTexto}</td>
          <td>$${money(f.total)}</td>
          <td class="actions">
             <div class="row-actions" style="margin:0; gap:5px;">
               <button class="btn small" onclick="window.verFactura('${f.id}')">üëÅ Ver</button>
               <button class="btn small" onclick="window.imprimirFactura('${f.id}')">üñ® Imprimir</button>
               <button class="btn small" onclick="window.abrirAbonos('${f.id}')">üí∞ Abonos</button>
             </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Ver Factura
    window.verFactura = function(id){
      // Aqu√≠ podr√≠as generar el HTML de la factura para visualizar
      // Por simplicidad, asumiremos que se abre el modal
      const f = state.facturas.find(x => x.id === id);
      if(!f) return;
      $("modal-verfactura").classList.add("show");
      // Cargar iframe con contenido simulado o generar PDF
      const frame = $("vf_iframe");
      frame.srcdoc = `
        <body style="font-family:Arial; padding:20px;">
           <h2 style="text-align:center;">Factura ${f.numero_factura}</h2>
           <p><b>Paciente:</b> ${f.paciente_nombre}</p>
           <p><b>Total:</b> $${money(f.total)}</p>
           <hr/>
           <p style="text-align:center; color:#666;">Vista previa...</p>
        </body>
      `;
    };
    
    window.imprimirFactura = function(id){
      // L√≥gica de impresi√≥n
      toast("Enviando a imprimir... (Simulado)", "ok");
    };

    // Abonos
    window.abrirAbonos = async function(id){
       const f = state.facturas.find(x => x.id === id);
       state.facturaAbonos = f;
       $("modal-abonos").classList.add("show");
       $("abonos_total_factura").textContent = money(f.total);
       $("abono_fecha").value = hoyISO();
       cargarAbonos(id);
    };

    async function cargarAbonos(facturaId){
      const tbody = $("tbody-abonos");
      tbody.innerHTML = `<tr><td colspan="6" class="empty">Cargando...</td></tr>`;
      
      const { data, error } = await supabase
        .from("facturacion_abonos") // Asumimos nombre tabla
        .select("*")
        .eq("factura_id", facturaId)
        .order("created_at", { ascending: false });

      if(error){
        // Si no existe tabla, mostrar aviso
        tbody.innerHTML = `<tr><td colspan="6" class="empty">No hay abonos o tabla no existe</td></tr>`;
        $("abonos_total_abonado").textContent = "0";
        $("abonos_saldo").textContent = money(state.facturaAbonos.total);
        return;
      }
      
      state.abonos = data || [];
      renderAbonos();
    }

    function renderAbonos(){
      const tbody = $("tbody-abonos");
      tbody.innerHTML = "";
      let totalAbonado = 0;
      state.abonos.forEach(a => {
        totalAbonado += Number(a.monto);
        const tr = document.createElement("tr");
        tr.innerHTML = `
           <td>${a.fecha}</td>
           <td>$${money(a.monto)}</td>
           <td>${a.metodo}</td>
           <td>${a.referencia || "-"}</td>
           <td>${a.observacion || "-"}</td>
           <td><button class="btn danger small">X</button></td>
        `;
        tbody.appendChild(tr);
      });
      
      if(!state.abonos.length) tbody.innerHTML = `<tr><td colspan="6" class="empty">Sin abonos registrados</td></tr>`;

      $("abonos_total_abonado").textContent = money(totalAbonado);
      const saldo = (state.facturaAbonos?.total || 0) - totalAbonado;
      $("abonos_saldo").textContent = money(saldo);
    }

    async function agregarAbono(){
       if(!state.facturaAbonos) return;
       const monto = num($("abono_monto").value);
       if(monto <= 0) return toast("Monto inv√°lido", "warn");
       
       const abono = {
         factura_id: state.facturaAbonos.id,
         fecha: $("abono_fecha").value,
         monto: monto,
         metodo: $("abono_metodo").value,
         referencia: $("abono_referencia").value,
         observacion: $("abono_observacion").value
       };

       const { error } = await supabase.from("facturacion_abonos").insert(abono);
       if(error) return toast("Error guardando abono: " + error.message, "err");
       
       toast("Abono agregado", "ok");
       $("abono_monto").value = "";
       $("abono_referencia").value = "";
       $("abono_observacion").value = "";
       cargarAbonos(state.facturaAbonos.id);
    }

    // Inicializaci√≥n y Eventos
    document.addEventListener("DOMContentLoaded", async () => {
      $("year").textContent = new Date().getFullYear();
      $("fecha").value = hoyISO();
      $("fecha_desde").value = hoyISO();
      $("fecha_hasta").value = hoyISO();
      $("numero_factura").value = generarNumeroFactura();

      if(await proteger()){
        cargarProcedimientos();
        cargarProfesionales();
      }

      // Listeners
      $("btn-logout").onclick = cerrarSesion;
      $("btn-back").onclick = () => window.location.href = INDEX_URL;
      
      $("paciente_cedula").onblur = () => buscarPacienteEnHistoria();
      $("btn-buscar").onclick = () => buscarPacienteEnHistoria(true);
      
      $("btn-add").onclick = addItem;
      $("iva_aplica").onchange = calcularTotales;
      $("iva_porcentaje").oninput = calcularTotales;
      $("copago").oninput = calcularTotales;
      $("cuota_moderadora").oninput = calcularTotales;
      
      $("btn-guardar").onclick = guardarFactura;

      // Modal Facturas
      $("btn-ver-facturas").onclick = () => {
        $("modal-facturas").classList.add("show");
        cargarFacturas();
      };
      $("btn-cerrar-modal").onclick = () => $("modal-facturas").classList.remove("show");
      
      // ‚úÖ NUEVO LISTENER: Bot√≥n Maximizar
      $("btn-maximize-facturas").onclick = () => {
        $("modal-facturas").classList.toggle("maximized");
      };

      $("btn-buscar-facturas").onclick = cargarFacturas;
      $("btn-refresh-facturas").onclick = cargarFacturas;
      // ‚úÖ NUEVO LISTENER: Filtro Estado cambia -> Recargar
      $("filtro_estado_pago").onchange = cargarFacturas;

      // Modal Abonos
      $("btn-cerrar-modal-abonos").onclick = () => $("modal-abonos").classList.remove("show");
      $("btn-agregar-abono").onclick = agregarAbono;

      // Modal Ver Factura
      $("btn-cerrar-modal-verfactura").onclick = () => $("modal-verfactura").classList.remove("show");

      // Exportar Excel
      $("btn-export-excel").onclick = () => {
         const wb = XLSX.utils.book_new();
         const ws = XLSX.utils.json_to_sheet(state.facturas);
         XLSX.utils.book_append_sheet(wb, ws, "Facturas");
         XLSX.writeFile(wb, "Reporte_Facturacion.xlsx");
      };
    });

  </script>
</body>
</html>





















