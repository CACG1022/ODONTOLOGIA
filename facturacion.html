<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Facturaci√≥n - Cl√≠nica Odontol√≥gica</title>
  <!-- ‚úÖ Librer√≠a para exportar Excel (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg: #f3f5f7;
      --card: #ffffff;
      --text: #1f2a37;
      --muted: #6b7280;
      --line: #e5e7eb;
      --brand: #1f6aa5;
      --brand2: #114a75;
      --danger: #b42318;
      --shadow: 0 10px 30px rgba(16,24,40,.08);
      --radius: 14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 18px;
    }
    .topbar{
      max-width: 1100px;
      margin: 0 auto 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand h1{ font-size: 16px; margin:0; }
    .meta{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    /* ‚úÖ Chip multi-l√≠nea para Usuario + Rol */
    .chip{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--muted);
      box-shadow: 0 3px 10px rgba(0,0,0,.03);
      white-space:nowrap;
      display:flex;
      flex-direction:column;
      gap:4px;
      line-height:1.2;
    }
    .chip b{ color: var(--text); }
    .chip .line{ display:flex; gap:6px; align-items:baseline; }
    .chip .line span{ color: var(--muted); }
    .chip .line small{ color: var(--muted); font-weight:700; }
    .container{
      max-width: 1100px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .header{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .header .title{ font-weight:800; font-size: 14px; }
    .section{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      background: #fff;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .ctrl label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin-bottom:6px;
      font-weight:700;
    }
    input, select{
      width:100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      font-size: 14px;
      background:#fff;
    }
    .row-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    .btn{
      border: 1px solid var(--line);
      background: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 800;
      color: var(--text);
    }
    .btn:hover{ filter: brightness(.98); }
    .btn.primary{
      background: var(--brand);
      color:#fff;
      border-color: var(--brand);
    }
    .btn.primary:hover{ background: var(--brand2); border-color: var(--brand2); }
    .btn.danger{ color: var(--danger); border-color:#f2c6c6; }
    .btn.small{ padding: 8px 10px; font-size: 12px; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    table{ width:100%; border-collapse: collapse; }
    th, td{
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      text-align:left;
      vertical-align: middle;
    }
    th{
      font-size: 12px;
      color: var(--muted);
      background: #fafafa;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    td input{ padding: 8px 10px; }
    td.actions{ width: 120px; white-space: nowrap; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .empty{ color: var(--muted); text-align:center; padding: 18px; }
    .totales{
      display:flex;
      justify-content:flex-end;
      padding: 12px 16px;
      gap: 18px;
      border-top: 1px solid var(--line);
      background:#fbfcfd;
      flex-wrap:wrap;
    }
    .totales .box{
      min-width: 260px;
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      padding: 12px;
    }
    .totales .box div{
      display:flex;
      justify-content:space-between;
      padding: 5px 0;
      font-size: 13px;
      gap: 10px;
      align-items:center;
    }
    .actions-bottom{
      padding: 12px 16px;
      border-top: 1px solid var(--line);
      background:#fff;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      flex-wrap:wrap;
    }
    .actions-bottom .left-note{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      flex: 1 1 380px;
    }
    .actions-bottom .btns{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .footer{
      padding: 12px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      color: var(--muted);
      font-size: 12px;
      border-top: 1px solid var(--line);
      background: #fff;
    }
    #toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      box-shadow: var(--shadow);
      font-weight: 800;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .15s ease, transform .15s ease;
      pointer-events: none;
      max-width: 340px;
      white-space: pre-wrap;
    }
    #toast.show{ opacity: 1; transform: translateY(0); }
    #toast[data-type="ok"]{ border-color: #b7e4c7; }
    #toast[data-type="err"]{ border-color: #f2c6c6; }
    #toast[data-type="warn"]{ border-color: #ffe7b3; }
    /* ‚úÖ MODAL FACTURAS */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal.show{ display:flex; }
    .modal-card{
      width: min(1100px, 100%);
      background:#fff;
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* ‚úÖ MAXIMIZAR MODAL (Facturas generadas) */
    .modal-card.maximized{
      width: calc(100vw - 36px);
      height: calc(100vh - 36px);
      display:flex;
      flex-direction:column;
    }
    .modal-card.maximized .modal-body{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    .modal-card.maximized .modal-table{
      flex:1;
      max-height: none;
      min-height: 0;
    }
    .modal-head{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background:#fff;
    }
    .modal-head .title{ font-weight: 900; }
    .modal-body{
      padding: 12px 14px;
      max-height: 540px;
      overflow-y: auto;
    }
    /* ‚úÖ Tabla con scroll en modal Facturas generadas */
    .modal-table{
      overflow-y: auto;
      max-height: 420px;
    }
    .modal-table table{ width:100%; border-collapse: collapse; }
    .modal-table th, .modal-table td{
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      text-align:left;
      font-size: 12px;
    }
    .modal-table th{
      background: #fafafa;
      color: var(--muted);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .modal-table td button{
      padding: 6px 10px;
      font-size: 11px;
      border:1px solid var(--line);
      background:#fff;
      border-radius: 6px;
      cursor:pointer;
    }
    .modal-table td button:hover{ background:#f9fafb; }
    .modal-foot{
      padding: 10px 14px;
      border-top: 1px solid var(--line);
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .modal-foot .btn{
      padding: 9px 12px;
      font-size: 13px;
      border: 1px solid var(--line);
      background:#fff;
      border-radius: 8px;
      cursor:pointer;
      font-weight:800;
    }
    .modal-foot .btn.primary{
      background: var(--brand);
      color:#fff;
      border-color: var(--brand);
    }

    /* ‚úÖ Hack para scroll en ventana modal maximizada */
    .modal-card.maximized .modal-table{
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .modal-card.maximized .modal-table>div{
      flex: 1;
      overflow-y: auto;
    }

  </style>
</head>
<body>

<!-- BARRA SUPERIOR: Logo + Usuario/Rol -->
<div class="topbar">
  <div class="brand">
    <h1>üíä Facturaci√≥n - Cl√≠nica Odontol√≥gica</h1>
  </div>
  <div class="meta">
    <!-- ‚úÖ Chip multi-l√≠nea: Usuario + Rol -->
    <div class="chip">
      <div class="line">
        <small>Usuario:</small>
        <b id="user_email">Cargando...</b>
      </div>
      <div class="line">
        <small>Rol:</small>
        <span id="user_role">...</span>
      </div>
    </div>
    <button class="btn danger" onclick="logout()">Cerrar sesi√≥n</button>
  </div>
</div>

<div class="container">

  <!-- ENCABEZADO -->
  <div class="header">
    <div class="title">üìã Crear nueva factura</div>
    <button class="btn" onclick="abrirModalFacturas()">üìÅ Ver facturas guardadas</button>
  </div>

  <!-- SECCI√ìN 1: Datos Factura -->
  <div class="section">
    <div class="grid">
      <div class="ctrl">
        <label>N¬∞ Factura</label>
        <input type="text" id="factura_numero" placeholder="F-001" />
      </div>
      <div class="ctrl">
        <label>Profesional</label>
        <select id="profesional">
          <option value="">Seleccione...</option>
        </select>
      </div>
      <div class="ctrl">
        <label>M√©todo de pago</label>
        <select id="metodo_pago">
          <option value="">Seleccione...</option>
          <option value="Efectivo">Efectivo</option>
          <option value="Tarjeta">Tarjeta</option>
          <option value="Transferencia">Transferencia</option>
        </select>
      </div>
      <div class="ctrl">
        <label>Estado pago</label>
        <select id="estado_pago">
          <option value="pendiente">Pendiente</option>
          <option value="pagado">Pagado</option>
          <option value="parcial">Parcial</option>
        </select>
      </div>
      <div class="ctrl">
        <label>Referencia</label>
        <input type="text" id="referencia" placeholder="Num. transacci√≥n" />
      </div>
      <div class="ctrl">
        <label>¬øAplica IVA?</label>
        <select id="aplica_iva" onchange="toggleIva()">
          <option value="no">No</option>
          <option value="si">S√≠</option>
        </select>
      </div>
      <div class="ctrl" id="wrap_iva_porc" style="display:none;">
        <label>IVA %</label>
        <input type="number" id="iva_porcentaje" placeholder="19" value="19" />
      </div>
    </div>
  </div>

  <!-- SECCI√ìN 2: Datos Paciente -->
  <div class="section">
    <div class="grid">
      <div class="ctrl">
        <label>C√©dula Paciente</label>
        <input type="text" id="paciente_cedula" placeholder="1234567890" />
      </div>
      <div class="ctrl">
        <label>Nombre Paciente</label>
        <input type="text" id="paciente_nombre" placeholder="" readonly />
      </div>
      <div class="ctrl">
        <label>Correo Paciente</label>
        <input type="text" id="paciente_correo" placeholder="" readonly />
      </div>
      <div class="ctrl">
        <label>Tipo Usuario</label>
        <input type="text" id="paciente_tipo_usuario" placeholder="" readonly />
      </div>
      <div class="ctrl">
        <label>EPS</label>
        <input type="text" id="paciente_eps" placeholder="" readonly />
      </div>
    </div>
    <div class="row-actions">
      <button class="btn primary" id="btn-buscar" onclick="buscarPaciente()">üîç Autocompletar datos</button>
    </div>
  </div>

  <!-- SECCI√ìN 3: Procedimientos -->
  <div class="section" style="padding:0; border:0;">
    <div style="max-height:420px; overflow-y:auto;">
      <table id="tabla-procedimientos">
        <thead>
          <tr>
            <th style="width:80px;">ID Proc</th>
            <th>Profesional</th>
            <th style="width:100px;">CUPS</th>
            <th>Procedimiento</th>
            <th style="width:100px;">Cant</th>
            <th style="width:130px;">Costo</th>
            <th style="width:130px;">Vr.Unit</th>
            <th style="width:130px;">Total</th>
            <th class="actions">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody-procedimientos">
          <!-- Filas din√°micas -->
        </tbody>
      </table>
    </div>
  </div>

  <div class="section">
    <button class="btn primary" onclick="agregarFila()">‚ûï Agregar procedimiento</button>
  </div>

  <!-- TOTALES -->
  <div class="totales">
    <div class="box">
      <div><span>Subtotal:</span> <b id="span_subtotal" class="mono">$ 0</b></div>
      <div id="row_iva" style="display:none;"><span>IVA:</span> <b id="span_iva" class="mono">$ 0</b></div>
      <div style="border-top:1px solid var(--line); margin-top:6px; padding-top:6px;">
        <span style="font-weight:800;">TOTAL:</span>
        <b id="span_total" style="font-size:16px;" class="mono">$ 0</b>
      </div>
    </div>
  </div>

  <!-- OBSERVACIONES -->
  <div class="section">
    <label style="font-size:12px; color:var(--muted); margin-bottom:6px; display:block; font-weight:700;">Observaciones</label>
    <textarea id="observacion" rows="3" style="width:100%; border:1px solid var(--line); border-radius:10px; padding:10px; font-size:14px;"></textarea>
  </div>

  <!-- ACCIONES FINALES -->
  <div class="actions-bottom">
    <div class="left-note">
      üí° <b>Tip:</b> Al guardar la factura se registra en Supabase y se genera un PDF visualizable.
    </div>
    <div class="btns">
      <button class="btn" onclick="limpiarFormulario()">üîÑ Limpiar</button>
      <button class="btn primary" onclick="guardarFactura()">üíæ Guardar factura</button>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <div>v2.8.1 - Facturaci√≥n avanzada con IVA, Facturas guardadas y Facturaci√≥n electr√≥nica.</div>
    <div class="mono">Supabase + SheetJS</div>
  </div>

</div>

<!-- TOAST -->
<div id="toast" data-type="ok"></div>

<!-- ‚úÖ MODAL: FACTURAS GENERADAS -->
<div class="modal" id="modal_facturas">
  <div class="modal-card" id="modal_facturas_card">
    <div class="modal-head">
      <div class="title">üìÅ Facturas guardadas</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn small" onclick="toggleMaximizarModal()">üî≤ Maximizar</button>
        <button class="btn small danger" onclick="cerrarModalFacturas()">‚úñ</button>
      </div>
    </div>
    <div class="modal-body" id="modal_facturas_body">
      <div class="modal-table" id="modal_facturas_table">
        <div>
          <table>
            <thead>
              <tr>
                <th>N¬∞ Factura</th>
                <th>Paciente</th>
                <th>Profesional</th>
                <th>Total</th>
                <th>M√©todo Pago</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody_facturas">
              <!-- Filas din√°micas -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" onclick="cerrarModalFacturas()">Cerrar</button>
    </div>
  </div>
</div>

<!-- ‚úÖ IFRAME VISTA PREVIA FACTURA -->
<div class="modal" id="modal_vista_factura">
  <div class="modal-card" style="width:min(900px,100%);">
    <div class="modal-head">
      <div class="title">üìÑ Vista previa factura</div>
      <button class="btn small danger" onclick="cerrarVistaFactura()">‚úñ</button>
    </div>
    <div class="modal-body" style="padding:0; max-height:none; height:70vh;">
      <iframe id="vf_iframe" style="width:100%; height:100%; border:0;"></iframe>
    </div>
    <div class="modal-foot">
      <button class="btn" onclick="descargarPDFFactura()">‚¨á Descargar PDF</button>
      <button class="btn primary" onclick="enviarFacturacionElectronica()">üì§ Enviar a Facturaci√≥n Electr√≥nica</button>
      <button class="btn" onclick="cerrarVistaFactura()">Cerrar</button>
    </div>
  </div>
</div>

<!-- ================== SCRIPTS ================== -->

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://rysitmepnybtzywxugwa.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5c2l0bWVwbnlidHp5d3h1Z3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ1NDY1NjIsImV4cCI6MjA1MDEyMjU2Mn0.bFXqXgR2gZv1nj4R5y3JEqxKndjnb5w8xOi5J0zt588";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let USER = null;
let ROLE = null;

// ========== AUTH & ROLES ==========
async function checkAuth() {
  const { data, error } = await sb.auth.getSession();
  if (error || !data?.session) {
    window.location.href = "login.html";
    return;
  }
  USER = data.session.user;
  document.getElementById("user_email").textContent = USER.email || "Sin email";
  await loadUserRole();
  await cargarProfesionales();
}

async function loadUserRole() {
  if (!USER) return;
  const { data, error } = await sb
    .from("users")
    .select("role")
    .eq("email", USER.email)
    .single();
  if (data) {
    ROLE = data.role || "user";
    document.getElementById("user_role").textContent = ROLE;
  } else {
    ROLE = "user";
    document.getElementById("user_role").textContent = "user";
  }
}

async function logout() {
  await sb.auth.signOut();
  window.location.href = "login.html";
}

// ========== CARGAR PROFESIONALES ==========
async function cargarProfesionales() {
  const sel = document.getElementById("profesional");
  const { data, error } = await sb.from("profesionales").select("*");
  if (error) {
    console.error("Error cargando profesionales:", error);
    return;
  }
  sel.innerHTML = '<option value="">Seleccione...</option>';
  (data || []).forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.nombre;
    opt.textContent = p.nombre;
    sel.appendChild(opt);
  });
}

// ========== BUSCAR PACIENTE ==========
async function buscarPaciente() {
  const cedula = document.getElementById("paciente_cedula").value.trim();
  if (!cedula) {
    showToast("Ingrese una c√©dula", "warn");
    return;
  }
  const { data, error } = await sb
    .from("pacientes")
    .select("*")
    .eq("cedula", cedula)
    .maybeSingle();
  if (error) {
    showToast("Error al buscar paciente: " + error.message, "err");
    return;
  }
  if (!data) {
    showToast("Paciente no encontrado", "warn");
    return;
  }
  document.getElementById("paciente_nombre").value = data.nombre || "";
  document.getElementById("paciente_correo").value = data.correo || "";
  document.getElementById("paciente_tipo_usuario").value = data.tipo_usuario || "";
  document.getElementById("paciente_eps").value = data.eps || "";
  showToast("‚úÖ Datos cargados", "ok");
}

// ========== TOGGLE IVA ==========
function toggleIva() {
  const aplicaIva = document.getElementById("aplica_iva").value;
  const wrap = document.getElementById("wrap_iva_porc");
  const rowIva = document.getElementById("row_iva");
  if (aplicaIva === "si") {
    wrap.style.display = "block";
    rowIva.style.display = "flex";
  } else {
    wrap.style.display = "none";
    rowIva.style.display = "none";
  }
  calcularTotales();
}

// ========== AGREGAR FILA PROCEDIMIENTO ==========
let filaId = 0;
function agregarFila() {
  filaId++;
  const tbody = document.getElementById("tbody-procedimientos");
  const tr = document.createElement("tr");
  tr.dataset.fila = filaId;
  tr.innerHTML = `
    <td><input type="number" class="id-proc" placeholder="ID" onchange="buscarCostoProcedimiento(this)" /></td>
    <td><input type="text" class="prof" placeholder="Ej: Dr. P√©rez" /></td>
    <td><input type="text" class="cups" placeholder="CUPS" /></td>
    <td><input type="text" class="proc" placeholder="Procedimiento" /></td>
    <td><input type="number" class="cant" value="1" min="1" onchange="calcularTotales()" /></td>
    <td><input type="number" class="costo" placeholder="Costo" readonly style="background:#f9fafb;" /></td>
    <td><input type="number" class="vr_unit" placeholder="Vr. unitario" onchange="calcularTotales()" /></td>
    <td><input type="number" class="total" placeholder="Total" readonly style="background:#f9fafb;" /></td>
    <td class="actions">
      <button class="btn danger small" onclick="eliminarFila(${filaId})">Quitar</button>
    </td>
  `;
  tbody.appendChild(tr);
}

// ========== NUEVA FUNCI√ìN: BUSCAR COSTO DEL PROCEDIMIENTO EN SUPABASE ==========
async function buscarCostoProcedimiento(inputElement) {
  const idProc = inputElement.value.trim();
  if (!idProc) return;
  
  const tr = inputElement.closest("tr");
  const inputCosto = tr.querySelector(".costo");
  
  try {
    const { data, error } = await sb
      .from("procedimientos_precios")
      .select("costo, procedimiento, codigo_cups, especialidad, profesional")
      .eq("id", idProc)
      .maybeSingle();
    
    if (error) {
      console.error("Error buscando procedimiento:", error);
      showToast("Error al buscar procedimiento", "err");
      return;
    }
    
    if (!data) {
      showToast("Procedimiento no encontrado con ID: " + idProc, "warn");
      inputCosto.value = "";
      return;
    }
    
    // Llenar el campo de costo
    inputCosto.value = data.costo || "";
    
    // Opcional: llenar otros campos si est√°n vac√≠os
    const inputProc = tr.querySelector(".proc");
    const inputCups = tr.querySelector(".cups");
    const inputProf = tr.querySelector(".prof");
    const inputVrUnit = tr.querySelector(".vr_unit");
    
    if (!inputProc.value && data.procedimiento) {
      inputProc.value = data.procedimiento;
    }
    if (!inputCups.value && data.codigo_cups) {
      inputCups.value = data.codigo_cups;
    }
    if (!inputProf.value && data.profesional) {
      inputProf.value = data.profesional;
    }
    if (!inputVrUnit.value && data.costo) {
      inputVrUnit.value = data.costo;
    }
    
    showToast("‚úÖ Costo cargado: $" + (data.costo || 0), "ok");
    calcularTotales();
  } catch (err) {
    console.error("Error en buscarCostoProcedimiento:", err);
    showToast("Error al buscar procedimiento", "err");
  }
}

// ========== ELIMINAR FILA ==========
function eliminarFila(id) {
  const tr = document.querySelector(`tr[data-fila="${id}"]`);
  if (tr) {
    tr.remove();
    calcularTotales();
  }
}

// ========== CALCULAR TOTALES ==========
function calcularTotales() {
  const filas = document.querySelectorAll("#tbody-procedimientos tr");
  let subtotal = 0;
  filas.forEach(tr => {
    const cant = parseFloat(tr.querySelector(".cant").value) || 0;
    const vr = parseFloat(tr.querySelector(".vr_unit").value) || 0;
    const tot = cant * vr;
    tr.querySelector(".total").value = tot;
    subtotal += tot;
  });

  const aplicaIva = document.getElementById("aplica_iva").value;
  let ivaVal = 0;
  if (aplicaIva === "si") {
    const ivaPorcentaje = parseFloat(document.getElementById("iva_porcentaje").value) || 0;
    ivaVal = (subtotal * ivaPorcentaje) / 100;
  }
  const total = subtotal + ivaVal;

  document.getElementById("span_subtotal").textContent = "$ " + subtotal.toLocaleString("es-CO");
  document.getElementById("span_iva").textContent = "$ " + ivaVal.toLocaleString("es-CO");
  document.getElementById("span_total").textContent = "$ " + total.toLocaleString("es-CO");
}

// ========== LIMPIAR FORMULARIO ==========
function limpiarFormulario() {
  document.getElementById("factura_numero").value = "";
  document.getElementById("profesional").value = "";
  document.getElementById("metodo_pago").value = "";
  document.getElementById("estado_pago").value = "pendiente";
  document.getElementById("referencia").value = "";
  document.getElementById("aplica_iva").value = "no";
  document.getElementById("iva_porcentaje").value = "19";
  document.getElementById("paciente_cedula").value = "";
  document.getElementById("paciente_nombre").value = "";
  document.getElementById("paciente_correo").value = "";
  document.getElementById("paciente_tipo_usuario").value = "";
  document.getElementById("paciente_eps").value = "";
  document.getElementById("observacion").value = "";
  document.getElementById("tbody-procedimientos").innerHTML = "";
  toggleIva();
  calcularTotales();
}

// ========== GUARDAR FACTURA ==========
async function guardarFactura() {
  const facturaNumero = document.getElementById("factura_numero").value.trim();
  const profesional = document.getElementById("profesional").value;
  const metodoPago = document.getElementById("metodo_pago").value;
  const estadoPago = document.getElementById("estado_pago").value;
  const referencia = document.getElementById("referencia").value.trim();
  const aplicaIva = document.getElementById("aplica_iva").value;
  const ivaPorcentaje = aplicaIva === "si" ? parseFloat(document.getElementById("iva_porcentaje").value) : 0;
  const observacion = document.getElementById("observacion").value.trim();

  const pacienteCedula = document.getElementById("paciente_cedula").value.trim();
  const pacienteNombre = document.getElementById("paciente_nombre").value.trim();
  const pacienteCorreo = document.getElementById("paciente_correo").value.trim();
  const pacienteTipoUsuario = document.getElementById("paciente_tipo_usuario").value.trim();
  const pacienteEps = document.getElementById("paciente_eps").value.trim();

  if (!facturaNumero) {
    showToast("Falta el n√∫mero de factura", "warn");
    return;
  }
  if (!profesional) {
    showToast("Falta seleccionar profesional", "warn");
    return;
  }
  if (!pacienteCedula || !pacienteNombre) {
    showToast("Falta informaci√≥n del paciente", "warn");
    return;
  }

  const filas = document.querySelectorAll("#tbody-procedimientos tr");
  if (filas.length === 0) {
    showToast("Agregue al menos un procedimiento", "warn");
    return;
  }

  const procedimientos = [];
  filas.forEach(tr => {
    const idProc = tr.querySelector(".id-proc").value.trim();
    const prof = tr.querySelector(".prof").value.trim();
    const cups = tr.querySelector(".cups").value.trim();
    const proc = tr.querySelector(".proc").value.trim();
    const cant = parseFloat(tr.querySelector(".cant").value) || 0;
    const costo = parseFloat(tr.querySelector(".costo").value) || 0;
    const vr = parseFloat(tr.querySelector(".vr_unit").value) || 0;
    const tot = parseFloat(tr.querySelector(".total").value) || 0;
    procedimientos.push({
      id_procedimiento: idProc || null,
      profesional: prof || null,
      cups: cups || null,
      procedimiento: proc || null,
      cantidad: cant,
      costo: costo,
      valor_unitario: vr,
      total: tot
    });
  });

  let subtotal = 0;
  procedimientos.forEach(p => { subtotal += p.total; });
  const ivaVal = aplicaIva === "si" ? (subtotal * ivaPorcentaje) / 100 : 0;
  const total = subtotal + ivaVal;

  const payload = {
    factura_numero: facturaNumero,
    profesional: profesional,
    metodo_pago: metodoPago,
    estado_pago: estadoPago,
    referencia: referencia,
    aplica_iva: aplicaIva,
    iva_porcentaje: ivaPorcentaje,
    observacion: observacion,
    paciente_cedula: pacienteCedula,
    paciente_nombre: pacienteNombre,
    paciente_correo: pacienteCorreo,
    paciente_tipo_usuario: pacienteTipoUsuario,
    paciente_eps: pacienteEps,
    procedimientos: procedimientos,
    subtotal: subtotal,
    iva: ivaVal,
    total: total,
    created_at: new Date().toISOString()
  };

  const { data, error } = await sb.from("facturas").insert([payload]).select();
  if (error) {
    showToast("Error al guardar factura: " + error.message, "err");
    return;
  }
  showToast("‚úÖ Factura guardada exitosamente", "ok");
  limpiarFormulario();
}

// ========== MODAL FACTURAS GUARDADAS ==========
async function abrirModalFacturas() {
  const modal = document.getElementById("modal_facturas");
  modal.classList.add("show");
  await cargarListaFacturas();
}

function cerrarModalFacturas() {
  const modal = document.getElementById("modal_facturas");
  modal.classList.remove("show");
  const card = document.getElementById("modal_facturas_card");
  card.classList.remove("maximized");
}

function toggleMaximizarModal() {
  const card = document.getElementById("modal_facturas_card");
  card.classList.toggle("maximized");
}

async function cargarListaFacturas() {
  const tbody = document.getElementById("tbody_facturas");
  tbody.innerHTML = "<tr><td colspan='7' class='empty'>Cargando...</td></tr>";
  const { data, error } = await sb.from("facturas").select("*").order("created_at", { ascending: false });
  if (error) {
    tbody.innerHTML = `<tr><td colspan='7' class='empty'>Error: ${error.message}</td></tr>`;
    return;
  }
  if (!data || data.length === 0) {
    tbody.innerHTML = "<tr><td colspan='7' class='empty'>No hay facturas guardadas</td></tr>";
    return;
  }
  tbody.innerHTML = "";
  data.forEach(f => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${f.factura_numero || "-"}</td>
      <td>${f.paciente_nombre || "-"}</td>
      <td>${f.profesional || "-"}</td>
      <td class="mono">$ ${(f.total || 0).toLocaleString("es-CO")}</td>
      <td>${f.metodo_pago || "-"}</td>
      <td>${f.estado_pago || "-"}</td>
      <td>
        <button onclick="verFactura('${f.id}')">üëÅ Ver</button>
        <button onclick="eliminarFactura('${f.id}')">üóë</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function verFactura(id) {
  const { data, error } = await sb.from("facturas").select("*").eq("id", id).single();
  if (error || !data) {
    showToast("Error al cargar factura", "err");
    return;
  }
  generarVistaFactura(data);
  cerrarModalFacturas();
}

async function eliminarFactura(id) {
  if (!confirm("¬øEliminar esta factura?")) return;
  const { error } = await sb.from("facturas").delete().eq("id", id);
  if (error) {
    showToast("Error al eliminar factura", "err");
    return;
  }
  showToast("‚úÖ Factura eliminada", "ok");
  await cargarListaFacturas();
}

// ========== VISTA PREVIA FACTURA ==========
function generarVistaFactura(factura) {
  const html = `
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Factura ${factura.factura_numero || ""}</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      color: #333;
    }
    h1{ text-align:center; margin-bottom:10px; }
    .kv{ display:flex; gap:10px; margin:6px 0; }
    .k{ font-weight:700; min-width:140px; }
    .v{ flex:1; }
    table{
      width:100%;
      border-collapse:collapse;
      margin:20px 0;
    }
    th, td{
      border:1px solid #ccc;
      padding:8px;
      text-align:left;
    }
    th{ background:#f3f5f7; }
    .totbox{
      margin-top:20px;
      border:1px solid #ccc;
      padding:12px;
      background:#fafafa;
    }
    .line{
      display:flex;
      justify-content:space-between;
      margin:6px 0;
    }
    .big{
      border-top:2px solid #333;
      margin-top:8px;
      padding-top:8px;
      font-size:18px;
      font-weight:900;
    }
  </style>
</head>
<body data-factura-id="${factura.id || ""}">
  <h1>üíä Factura ${factura.factura_numero || ""}</h1>
  <div class="kv"><div class="k">Paciente:</div><div class="v" data-paciente-nombre>${factura.paciente_nombre || "-"}</div></div>
  <div class="kv"><div class="k">C√©dula:</div><div class="v" data-paciente-cedula>${factura.paciente_cedula || "-"}</div></div>
  <div class="kv"><div class="k">Correo:</div><div class="v" data-paciente-correo>${factura.paciente_correo || "-"}</div></div>
  <div class="kv"><div class="k">Tipo Usuario:</div><div class="v">${factura.paciente_tipo_usuario || "-"}</div></div>
  <div class="kv"><div class="k">EPS:</div><div class="v">${factura.paciente_eps || "-"}</div></div>
  <div class="kv"><div class="k">Profesional:</div><div class="v">${factura.profesional || "-"}</div></div>
  <div class="kv"><div class="k">M√©todo de pago:</div><div class="v">${factura.metodo_pago || "-"}</div></div>
  <div class="kv"><div class="k">Estado de pago:</div><div class="v">${factura.estado_pago || "-"}</div></div>
  <div class="kv"><div class="k">Referencia:</div><div class="v">${factura.referencia || "-"}</div></div>
  <div class="kv"><div class="k">¬øAplica IVA?:</div><div class="v">${factura.aplica_iva || "no"}</div></div>
  ${factura.aplica_iva === "si" ? `<div class="kv"><div class="k">IVA %:</div><div class="v">${factura.iva_porcentaje || 0}</div></div>` : ""}
  ${factura.observacion ? `<div class="kv"><div class="k">Observaci√≥n:</div><div class="v">${factura.observacion}</div></div>` : ""}

  <h3>Procedimientos</h3>
  <table>
    <thead>
      <tr>
        <th>CUPS</th>
        <th>Procedimiento</th>
        <th>Cant</th>
        <th>Vr. Unit</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      ${(factura.procedimientos || []).map(p => `
        <tr>
          <td>${p.cups || "-"}</td>
          <td>${p.procedimiento || "-"}</td>
          <td>${p.cantidad || 0}</td>
          <td>$ ${(p.valor_unitario || 0).toLocaleString("es-CO")}</td>
          <td>$ ${(p.total || 0).toLocaleString("es-CO")}</td>
        </tr>
      `).join("")}
    </tbody>
  </table>

  <div class="totbox">
    <div class="line">Subtotal: <b>$ ${(factura.subtotal || 0).toLocaleString("es-CO")}</b></div>
    ${factura.aplica_iva === "si" ? `<div class="line">IVA: <b>$ ${(factura.iva || 0).toLocaleString("es-CO")}</b></div>` : ""}
    <div class="line big">TOTAL: <b>$ ${(factura.total || 0).toLocaleString("es-CO")}</b></div>
  </div>
</body>
</html>
  `;

  const iframe = document.getElementById("vf_iframe");
  iframe.srcdoc = html;
  const modal = document.getElementById("modal_vista_factura");
  modal.classList.add("show");
}

function cerrarVistaFactura() {
  const modal = document.getElementById("modal_vista_factura");
  modal.classList.remove("show");
}

function descargarPDFFactura() {
  const iframe = document.getElementById("vf_iframe");
  if (!iframe || !iframe.contentWindow) {
    showToast("No se puede descargar PDF", "err");
    return;
  }
  iframe.contentWindow.print();
}

// ========== TOAST ==========
function showToast(msg, type = "ok") {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.dataset.type = type;
  toast.classList.add("show");
  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}

// ========== INIT ==========
window.addEventListener("DOMContentLoaded", () => {
  checkAuth();
});
</script>




<!-- =========================================================
     NUEVA FUNCI√ìN: ENVIAR FACTURA A FACTURACI√ìN ELECTR√ìNICA
     Extrae TODOS los datos desde el iframe y los env√≠a a n8n
     ========================================================= -->
<script>
async function enviarFacturacionElectronica(){
  try{
    const iframe = document.getElementById("vf_iframe");
    if(!iframe || !iframe.contentDocument){
      alert("No se encontr√≥ factura visible");
      return;
    }
    const doc = iframe.contentDocument;

    // ‚úÖ N√∫mero de factura desde el t√≠tulo (ej: "Factura F-001")
    let facturaNumero = null;
    try{
      const t = (doc.title || "").trim();
      if(t.toLowerCase().startsWith("factura")){
        facturaNumero = t.replace(/^factura\s*/i, "").trim() || null;
      }
    }catch(_e){}

    // ‚úÖ Extraer paciente desde los divs .kv
    const paciente = {
      nombre: document.querySelector('[data-paciente-nombre]')?.textContent || null,
      cedula: document.querySelector('[data-paciente-cedula]')?.textContent || null,
      correo: document.querySelector('[data-paciente-correo]')?.textContent || null
    };

    const payload = {
      factura_visible: true,
      factura_numero: facturaNumero,
      paciente,
      fecha_envio: new Date().toISOString(),
      origen: "facturacion.html"
    };

    const form = document.createElement("form");
    form.method = "POST";
    form.action = "https://ftth-n8n2.pzveh5.easypanel.host/webhook-test/a98d155f-561d-470f-b353-e9baab31249b";
    form.target = "_blank";

    const input = document.createElement("input");
    input.type = "hidden";
    input.name = "payload";
    input.value = JSON.stringify(payload);

    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
  }catch(e){
    console.error("FE error:", e);
    alert("Error enviando a facturaci√≥n electr√≥nica");
  }
}
</script>



<!-- =========================================================
     FIX: AUTOCARGA DESDE ?paciente_cedula=XXXX (NO rompe nada)
     + OVERRIDE: FACTURACI√ìN ELECTR√ìNICA SIN PESTA√ëAS Y CON PAYLOAD COMPLETO
     ========================================================= -->
<script>
(function(){
  // --------- Helper: DOM ready ----------
  function onReady(fn){
    if(document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", fn, { once:true });
    }else{
      try{ fn(); }catch(e){ console.warn("onReady error:", e); }
    }
  }

  // --------- 1) Autocarga paciente por querystring ----------
  function autoCargarPacienteDesdeQuery(){
    try{
      var ced = new URLSearchParams(window.location.search).get("paciente_cedula");
      if(!ced) return;

      var input = document.getElementById("paciente_cedula");
      if(!input) return;

      // No interferir si el usuario ya escribi√≥ algo distinto
      var cedTrim = String(ced).trim();
      if(String(input.value || "").trim() !== cedTrim){
        input.value = cedTrim;
        input.dispatchEvent(new Event("input", { bubbles:true }));
      }

      // Fuerza el flujo existente (bot√≥n Autocompletar si existe)
      setTimeout(function(){
        var btn = document.getElementById("btn-buscar");
        if(btn && typeof btn.click === "function"){
          btn.click();
        }
      }, 250);
    }catch(e){
      console.warn("Autocarga paciente (query) error:", e);
    }
  }

  // --------- 2) Toast/Notificaci√≥n (usa #toast existente si est√°) ----------
  function showToastFE(msg, ok){
    try{
      var toast = document.getElementById("toast");
      if(!toast){
        // Fallback m√≠nimo sin tocar estilos globales
        alert(msg);
        return;
      }
      // No asumir estructura exacta: solo texto
      toast.textContent = msg;

      // Respetar clases existentes: a√±adimos y removemos de forma segura
      toast.classList.remove("show");
      toast.classList.remove("success");
      toast.classList.remove("error");
      toast.classList.add("show");
      toast.classList.add(ok ? "success" : "error");

      setTimeout(function(){
        toast.classList.remove("show");
      }, 3200);
    }catch(e){
      console.warn("Toast FE error:", e);
      alert(msg);
    }
  }

  // --------- 3) Extraer datos desde la factura visible (iframe vf_iframe) ----------
  function getFacturaVisibleData(){
    var iframe = document.getElementById("vf_iframe");
    if(!iframe || !iframe.contentDocument) return null;

    var doc = iframe.contentDocument;

    // 3.1 N√∫mero factura: preferir title "Factura <N¬∞>"
    var facturaNumero = null;
    try{
      var t = (doc.title || "").trim();
      if(t.toLowerCase().startsWith("factura")){
        facturaNumero = t.replace(/^factura\s*/i, "").trim() || null;
      }
    }catch(_e){}

    // 3.2 ID factura (si est√° en dataset)
    var facturaId = null;
    try{
      facturaId = doc.documentElement?.dataset?.facturaId || null;
    }catch(_e){}

    // 3.3 Key/Value blocks
    var kv = {};
    try{
      var kvEls = doc.querySelectorAll(".kv");
      kvEls.forEach(function(el){
        var k = (el.querySelector(".k")?.textContent || "").trim().toLowerCase();
        var v = (el.querySelector(".v")?.textContent || "").trim();
        if(k){
          kv[k] = v || null;
        }
      });
    }catch(_e){}

    // 3.4 Procedimientos (tabla)
    var procedimientos = [];
    try{
      var rows = doc.querySelectorAll("table tbody tr");
      rows.forEach(function(tr){
        var tds = tr.querySelectorAll("td");
        if(!tds || tds.length < 5) return;
        procedimientos.push({
          cups: (tds[0].textContent || "").trim() || null,
          procedimiento: (tds[1].textContent || "").trim() || null,
          cantidad: (tds[2].textContent || "").trim() || null,
          valor_unitario: (tds[3].textContent || "").trim() || null,
          total: (tds[4].textContent || "").trim() || null
        });
      });
    }catch(_e){}

    // 3.5 Totales (si est√° .totbox)
    var totales = {};
    try{
      var lines = doc.querySelectorAll(".totbox .line");
      lines.forEach(function(line){
        var label = (line.childNodes[0]?.textContent || "").trim().replace(/:$/, "").toLowerCase();
        var value = (line.querySelector("b")?.textContent || "").trim();
        if(label){
          totales[label] = value || null;
        }
      });
      // TOTAL grande (si existe)
      var totalBig = doc.querySelector(".totbox .big b")?.textContent?.trim();
      if(totalBig) totales["total"] = totalBig;
    }catch(_e){}

    // 3.6 Datos del paciente / factura
    var paciente = {
      nombre: kv["paciente"] || null,
      cedula: kv["c√©dula"] || kv["cedula"] || null,
      correo: kv["correo"] || null,
      tipo_usuario: kv["tipo usuario"] || null,
      eps: kv["eps"] || null
    };

    var factura = {
      id: facturaId,
      numero: facturaNumero,
      profesional: kv["profesional"] || null,
      metodo_pago: kv["m√©todo de pago"] || kv["metodo de pago"] || null,
      estado_pago: kv["estado de pago"] || null,
      referencia: kv["referencia"] || null,
      aplica_iva: kv["¬øaplica iva?"] || kv["aplica iva?"] || null,
      iva_porcentaje: kv["iva %"] || null,
      observacion: kv["observaci√≥n"] || kv["observacion"] || null,
      procedimientos: procedimientos,
      totales: totales
    };

    return { paciente: paciente, factura: factura };
  }

  // --------- 4) Env√≠o CORS-safe SIN pesta√±as (POST a iframe oculto) ----------
  function ensureHiddenIframe(){
    var existing = document.getElementById("n8n_fe_iframe");
    if(existing) return existing;

    var ifr = document.createElement("iframe");
    ifr.id = "n8n_fe_iframe";
    ifr.name = "n8n_fe_iframe";
    ifr.style.width = "0";
    ifr.style.height = "0";
    ifr.style.border = "0";
    ifr.style.position = "absolute";
    ifr.style.left = "-9999px";
    ifr.style.top = "-9999px";
    ifr.setAttribute("aria-hidden", "true");
    document.body.appendChild(ifr);
    return ifr;
  }

  // OVERRIDE: √∫ltima definici√≥n gana (sin tocar la existente)
  window.enviarFacturacionElectronica = function(){
    try{
      var data = getFacturaVisibleData();
      if(!data || !data.factura || (!data.factura.numero && !data.factura.id)){
        showToastFE("No se encontr√≥ una factura visible para enviar.", false);
        return;
      }

      var payload = {
        factura_visible: true,
        factura_id: data.factura.id || null,
        factura_numero: data.factura.numero || null,
        paciente: data.paciente || null,
        factura: data.factura || null,
        fecha_envio: new Date().toISOString(),
        origen: "facturacion.html"
      };

      // Crear POST FORM URLENCODED a iframe oculto (evita CORS y sin cambiar pesta√±a)
      ensureHiddenIframe();

      var form = document.createElement("form");
      form.method = "POST";
      form.action = "https://ftth-n8n2.pzveh5.easypanel.host/webhook/a98d155f-561d-470f-b353-e9baab31249b";
      form.target = "n8n_fe_iframe";

      var input = document.createElement("input");
      input.type = "hidden";
      input.name = "payload";
      input.value = JSON.stringify(payload);

      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
      document.body.removeChild(form);

      showToastFE("‚úÖ Enviado a n8n (Facturaci√≥n electr√≥nica).", true);
    }catch(e){
      console.error("FE error:", e);
      showToastFE("Error enviando a facturaci√≥n electr√≥nica.", false);
    }
  };

  onReady(function(){
    autoCargarPacienteDesdeQuery();
  });
})();
</script>








</body>
</html>







