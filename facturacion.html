<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Facturaci√≥n - Cl√≠nica Odontol√≥gica</title>

  <style>
    :root{
      --bg: #f3f5f7;
      --card: #ffffff;
      --text: #1f2a37;
      --muted: #6b7280;
      --line: #e5e7eb;
      --brand: #1f6aa5;
      --brand2: #114a75;
      --danger: #b42318;
      --shadow: 0 10px 30px rgba(16,24,40,.08);
      --radius: 14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 18px;
    }
    .topbar{
      max-width: 1100px;
      margin: 0 auto 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand h1{ font-size: 16px; margin:0; }
    .meta{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    .chip{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--muted);
      box-shadow: 0 3px 10px rgba(0,0,0,.03);
      white-space:nowrap;
    }
    .chip b{ color: var(--text); }

    .container{
      max-width: 1100px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .header{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .header .title{ font-weight:800; font-size: 14px; }

    .section{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      background: #fff;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .ctrl label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin-bottom:6px;
      font-weight:700;
    }
    input, select{
      width:100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      font-size: 14px;
      background:#fff;
    }

    .row-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }

    .btn{
      border: 1px solid var(--line);
      background: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 800;
      color: var(--text);
    }
    .btn:hover{ filter: brightness(.98); }
    .btn.primary{
      background: var(--brand);
      color:#fff;
      border-color: var(--brand);
    }
    .btn.primary:hover{ background: var(--brand2); border-color: var(--brand2); }
    .btn.danger{ color: var(--danger); border-color:#f2c6c6; }
    .btn.small{ padding: 8px 10px; font-size: 12px; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    table{ width:100%; border-collapse: collapse; }
    th, td{
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      text-align:left;
      vertical-align: middle;
    }
    th{
      font-size: 12px;
      color: var(--muted);
      background: #fafafa;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    td input{ padding: 8px 10px; }
    td.actions{ width: 120px; white-space: nowrap; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .empty{ color: var(--muted); text-align:center; padding: 18px; }

    .totales{
      display:flex;
      justify-content:flex-end;
      padding: 12px 16px;
      gap: 18px;
      border-top: 1px solid var(--line);
      background:#fbfcfd;
      flex-wrap:wrap;
    }
    .totales .box{
      min-width: 260px;
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      padding: 12px;
    }
    .totales .box div{
      display:flex;
      justify-content:space-between;
      padding: 5px 0;
      font-size: 13px;
      gap: 10px;
      align-items:center;
    }

    .footer{
      padding: 12px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      color: var(--muted);
      font-size: 12px;
      border-top: 1px solid var(--line);
      background: #fff;
    }

    #toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      box-shadow: var(--shadow);
      font-weight: 800;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .15s ease, transform .15s ease;
      pointer-events: none;
      max-width: 340px;
      white-space: pre-wrap;
    }
    #toast.show{ opacity: 1; transform: translateY(0); }
    #toast[data-type="ok"]{ border-color: #b7e4c7; }
    #toast[data-type="err"]{ border-color: #f2c6c6; }
    #toast[data-type="warn"]{ border-color: #ffe7b3; }

    /* ‚úÖ MODAL FACTURAS */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal.show{ display:flex; }
    .modal-card{
      width: min(1100px, 100%);
      background:#fff;
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background:#fff;
    }
    .modal-head .title{ font-weight: 900; }
    .modal-body{
      padding: 12px 14px;
      background:#fff;
    }
    .modal-tools{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      margin-bottom: 10px;
    }
    .modal-tools .ctrl{ min-width: 220px; }
    .modal-table{
      max-height: 60vh;
      overflow:auto;
      border: 1px solid var(--line);
      border-radius: 12px;
    }

    @media (max-width: 900px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px){
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <h1>CL√çNICA ODONTOL√ìGICA ‚Äî Facturaci√≥n</h1>
    </div>
    <div class="meta">
      <div class="chip">Usuario: <b id="user-email">‚Äî</b></div>
      <button class="btn danger" id="btn-logout" type="button">Cerrar sesi√≥n</button>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="title">Nueva factura</div>
      <div class="row-actions" style="margin-top:0;">
        <button class="btn" id="btn-back" type="button">‚¨Ö Volver</button>
        <!-- ‚úÖ NUEVO: Ver facturas -->
        <button class="btn" id="btn-ver-facturas" type="button">üìÑ Ver facturas</button>
      </div>
    </div>

    <div class="section">
      <div class="grid">
        <div class="ctrl">
          <label>Fecha</label>
          <input id="fecha" type="date">
        </div>
        <div class="ctrl">
          <label>No. factura</label>
          <input id="numero_factura" type="text">
        </div>
        <div class="ctrl">
          <label>Tipo usuario</label>
          <select id="tipo_usuario">
            <option>Particular</option>
            <option>Contributivo</option>
            <option>Subsidiado</option>
          </select>
        </div>
        <div class="ctrl">
          <label>EPS (si aplica)</label>
          <input id="eps" type="text" placeholder="Opcional">
        </div>
      </div>
    </div>

    <div class="section">
      <div class="grid">
        <div class="ctrl">
          <label>C√©dula paciente</label>
          <input id="paciente_cedula" inputmode="numeric" placeholder="Solo n√∫meros">
          <div style="margin-top:6px; font-size:12px; color:var(--muted);" id="paciente-hint"></div>
        </div>
        <div class="ctrl">
          <label>Nombre paciente</label>
          <input id="paciente_nombre" type="text" placeholder="Nombres y apellidos">
        </div>
        <div class="ctrl">
          <label>Profesional</label>
          <select id="profesional"></select>
        </div>
        <div class="ctrl">
          <label>&nbsp;</label>
          <button class="btn" id="btn-buscar" type="button">üîé Autocompletar (si existe)</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="grid">
        <div class="ctrl" style="grid-column: span 2;">
          <label>Agregar procedimiento</label>
          <select id="sel-proc"></select>
        </div>
        <div class="ctrl">
          <label>Cantidad</label>
          <input id="cantidad" type="number" min="1" step="1" value="1">
        </div>
        <div class="ctrl">
          <label>&nbsp;</label>
          <button class="btn primary" id="btn-add" type="button">‚ûï Agregar</button>
        </div>
      </div>

      <div style="margin-top:12px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:140px;">CUPS</th>
              <th>Procedimiento</th>
              <th style="width:110px;">Cant</th>
              <th style="width:160px;">V/Unit</th>
              <th style="width:160px;">Total</th>
              <th style="width:120px;"></th>
            </tr>
          </thead>
          <tbody id="tbody-items"></tbody>
        </table>
      </div>
    </div>

    <div class="totales">
      <div class="box">
        <div><span>Subtotal</span><b>$ <span id="subtotal">0</span></b></div>

        <!-- ‚úÖ NUEVO: IVA -->
        <div style="align-items:flex-start;">
          <span>IVA</span>
          <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
            <div style="display:flex; gap:8px; align-items:center;">
              <span style="color:var(--muted); font-weight:700;">%</span>
              <input id="iva_porcentaje" type="number" min="0" step="0.01" value="19" style="width:140px; text-align:right;">
            </div>
            <div class="mono" style="color:var(--muted);">IVA: $ <span id="iva_valor">0</span></div>
          </div>
        </div>

        <div>
          <span>Copago</span>
          <b>$ <input id="copago" type="number" min="0" step="100" value="0" style="width:140px; text-align:right;"></b>
        </div>
        <div>
          <span>Cuota moderadora</span>
          <b>$ <input id="cuota_moderadora" type="number" min="0" step="100" value="0" style="width:140px; text-align:right;"></b>
        </div>

        <div style="border-top:1px solid var(--line); margin-top:6px; padding-top:8px;">
          <span>Total</span><b>$ <span id="total">0</span></b>
        </div>
      </div>

      <div class="box">
        <div style="gap:10px; flex-wrap:wrap;">
          <button class="btn primary" id="btn-guardar" type="button">üíæ Guardar factura</button>
          <button class="btn" id="btn-imprimir" type="button" disabled>üñ® Imprimir</button>
        </div>
        <div class="mono" style="margin-top:10px; color:var(--muted);">
          Autocompletado de paciente se hace desde N8N (mismo webhook de Historia Cl√≠nica).
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="status" id="status"></div>
      <div>¬© <span id="year"></span></div>
    </div>
  </div>

  <div id="toast" data-type="ok"></div>

  <!-- ‚úÖ MODAL: Ver facturas generadas -->
  <div class="modal" id="modal-facturas" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="title">Facturas generadas</div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" id="btn-refresh-facturas" type="button">üîÑ Actualizar</button>
          <button class="btn danger" id="btn-cerrar-modal" type="button">‚úñ Cerrar</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="modal-tools">
          <div class="ctrl">
            <label>Buscar (N¬∞ factura o c√©dula)</label>
            <input id="buscar_facturas" type="text" placeholder="Ej: FAC-2026... o 123456789">
          </div>
          <div class="ctrl">
            <label>Mostrar</label>
            <select id="limite_facturas">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
            </select>
          </div>
          <div class="ctrl">
            <label>&nbsp;</label>
            <button class="btn primary" id="btn-buscar-facturas" type="button">üîé Buscar</button>
          </div>
        </div>

        <div class="modal-table">
          <table>
            <thead>
              <tr>
                <th style="width:160px;">Fecha</th>
                <th style="width:220px;">N¬∞ Factura</th>
                <th>Paciente</th>
                <th style="width:160px;">C√©dula</th>
                <th style="width:160px;">Total</th>
                <th style="width:220px;">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody-facturas">
              <tr><td colspan="6" class="empty">Cargando...</td></tr>
            </tbody>
          </table>
        </div>

        <div class="mono" style="margin-top:10px; color:var(--muted);">
          Tip: Puedes imprimir una factura desde ‚Äúüñ® Imprimir‚Äù en acciones.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = "https://dmcfrmpqlkrqbpjhrfyo.supabase.co".trim();
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE".trim();

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const LOGIN_URL = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
    const INDEX_URL = "https://cacg1022.github.io/ODONTOLOGIA/index.html";

    // ‚úÖ MISMO WEBHOOK QUE USA TU HISTORIA CL√çNICA
    const N8N_BUSCAR_URL = "https://ftth-n8n2.pzveh5.easypanel.host/webhook/62804cbf-8f21-453b-823e-e5c1b94f31c8";

    const state = {
      session: null,
      procedimientos: [],
      profesionales: [],
      items: [],
      facturaGuardada: null,
      _debounce: null,
      _lastCedula: "",
      facturas: []
    };

    const $ = (id) => document.getElementById(id);

    function toast(msg, type="ok"){
      const el = $("toast");
      el.textContent = msg;
      el.dataset.type = type;
      el.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=> el.classList.remove("show"), 2200);
    }

    function setStatus(msg){
      const el = $("status");
      if (el) el.textContent = msg || "";
    }

    function setHint(msg){
      const el = $("paciente-hint");
      if (el) el.textContent = msg || "";
    }

    function money(n){
      const x = Number(n || 0);
      return x.toLocaleString("es-CO");
    }

    function num(v){
      const raw = String(v ?? "").trim();
      if (!raw) return 0;
      const n = Number(raw);
      return Number.isFinite(n) ? n : 0;
    }

    function hoyISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function generarNumeroFactura(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `FAC-${y}${m}${da}-${hh}${mi}${ss}`;
    }

    async function proteger(){
      const { data: { session } } = await supabase.auth.getSession();
      if(!session){
        window.location.href = LOGIN_URL;
        return false;
      }
      state.session = session;
      $("user-email").textContent = session.user?.email || "Usuario";
      return true;
    }

    supabase.auth.onAuthStateChange((_event, session) => {
      if (!session) window.location.href = LOGIN_URL;
    });

    async function cerrarSesion(){
      try { await supabase.auth.signOut(); } catch(e) {}
      window.location.href = LOGIN_URL;
    }

    async function cargarProcedimientos(){
      const { data, error } = await supabase
        .from("procedimientos_precios")
        .select("id, procedimiento, valor, codigo_cups, activo")
        .order("procedimiento", { ascending: true });

      if (error){
        console.error(error);
        toast("Error procedimientos:\n" + error.message, "err");
        state.procedimientos = [];
        renderProcedimientosSelect();
        return;
      }

      const rows = data || [];
      state.procedimientos = rows.filter(r => (r.activo === null || r.activo === undefined) ? true : r.activo === true);
      renderProcedimientosSelect();
    }

    async function cargarProfesionales(){
      const { data, error } = await supabase
        .from("profesionales")
        .select("id, cedula, nombre, activo")
        .order("nombre", { ascending: true });

      if (error){
        console.error(error);
        toast("Error profesionales:\n" + error.message, "err");
        state.profesionales = [];
        renderProfesionales();
        return;
      }

      const rows = data || [];
      state.profesionales = rows.filter(r => (r.activo === null || r.activo === undefined) ? true : r.activo === true);
      renderProfesionales();
    }

    function renderProcedimientosSelect(){
      const sel = $("sel-proc");
      sel.innerHTML = `<option value="">‚Äî Selecciona ‚Äî</option>`;
      for (const p of state.procedimientos){
        const label = `${p.procedimiento} ‚Äî $${money(p.valor || 0)}${p.codigo_cups ? ` (CUPS ${p.codigo_cups})` : ""}`;
        const opt = document.createElement("option");
        opt.value = String(p.id);
        opt.textContent = label;
        sel.appendChild(opt);
      }
    }

    function renderProfesionales(){
      const sel = $("profesional");
      sel.innerHTML = `<option value="">‚Äî Selecciona ‚Äî</option>`;
      for (const pr of state.profesionales){
        const ced = (pr.cedula ?? "").toString().trim();
        const nom = (pr.nombre ?? "").toString().trim();

        const opt = document.createElement("option");
        // ‚úÖ guardamos "cedula nombre" (como en tu HC)
        opt.value = `${ced} ${nom}`.trim();
        opt.textContent = `${nom}${ced ? ` (${ced})` : ""}`.trim();
        sel.appendChild(opt);
      }
    }

    // ‚úÖ AUTOCOMPLETAR PACIENTE DESDE N8N (igual que Historia Cl√≠nica)
    async function buscarPacienteEnHistoria(){
      const cedula = ($("paciente_cedula").value || "")
        .trim()
        .replace(/[^\d]/g, "");

      $("paciente_cedula").value = cedula;

      if (cedula.length < 6){
        setHint("");
        return;
      }

      if (state._lastCedula === cedula) return;
      state._lastCedula = cedula;

      setHint("Buscando paciente...");

      try{
        const url = `${N8N_BUSCAR_URL}?cedula=${encodeURIComponent(cedula)}`;
        const resp = await fetch(url, { method: "GET" });

        if (!resp.ok) throw new Error("HTTP " + resp.status);

        const data = await resp.json();

        if (!data?.existe){
          setHint("No encontrado (puedes digitar el nombre).");
          return;
        }

        const h = data.historia || {};
        const nombre = (h["Nombre y apellido"] || "").trim();
        const epsHC  = (h["EPS_Paciente"] || "").trim();

        if (nombre){
          $("paciente_nombre").value = nombre;

          // opcional: llenar EPS si viene
          if ($("eps") && epsHC) $("eps").value = epsHC;

          setHint("‚úÖ Encontrado");
        } else {
          setHint("Encontrado, pero sin nombre en historia.");
        }

      } catch(err){
        console.error("Error buscando en N8N:", err);
        setHint("Error consultando (mira Console F12).");
      }
    }

    // Debounce para no hacer consultas por cada tecla
    function onCedulaInput(){
      clearTimeout(state._debounce);
      state._debounce = setTimeout(buscarPacienteEnHistoria, 350);
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function agregarProcedimiento(){
      const procId = ($("sel-proc").value || "").trim();
      if (!procId){
        toast("Selecciona un procedimiento", "warn");
        return;
      }

      const p = state.procedimientos.find(x => String(x.id) === String(procId));
      if (!p){
        toast("Procedimiento no encontrado", "err");
        return;
      }

      const cantidad = Math.max(1, parseInt($("cantidad").value || "1", 10) || 1);
      const valorU = Math.max(0, num(p.valor || 0));

      const item = {
        id_local: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        codigo_cups: p.codigo_cups || "",
        descripcion: p.procedimiento || "",
        cantidad,
        valor_unitario: valorU,
        valor_total: valorU * cantidad
      };

      state.items.push(item);
      renderItems();
      recalcularTotales();

      $("sel-proc").value = "";
      $("cantidad").value = "1";
      toast("Agregado ‚úÖ", "ok");
    }

    function eliminarItem(id_local){
      state.items = state.items.filter(x => x.id_local !== id_local);
      renderItems();
      recalcularTotales();
    }

    function renderItems(){
      const tbody = $("tbody-items");
      tbody.innerHTML = "";

      if (state.items.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="empty">A√∫n no has agregado procedimientos.</td></tr>`;
        return;
      }

      for (const it of state.items){
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td class="mono">${escapeHtml(it.codigo_cups || "‚Äî")}</td>
          <td>${escapeHtml(it.descripcion || "")}</td>
          <td><input type="number" min="1" step="1" value="${it.cantidad}" data-k="cantidad"></td>
          <td><input type="number" min="0" step="100" value="${it.valor_unitario}" data-k="valor_unitario"></td>
          <td class="mono">$ ${money(it.valor_total)}</td>
          <td class="actions"><button class="btn danger small" type="button">Quitar</button></td>
        `;

        tr.querySelectorAll("input").forEach(inp => {
          inp.addEventListener("input", () => {
            const k = inp.dataset.k;
            const v = num(inp.value);
            if (k === "cantidad") it.cantidad = Math.max(1, parseInt(String(v), 10) || 1);
            if (k === "valor_unitario") it.valor_unitario = Math.max(0, v);
            it.valor_total = it.cantidad * it.valor_unitario;
            renderItems();
            recalcularTotales();
          });
        });

        tr.querySelector("button").addEventListener("click", () => eliminarItem(it.id_local));
        tbody.appendChild(tr);
      }
    }

    function calcularTotalesObj(){
      const subtotal = state.items.reduce((a,b)=> a + (Number(b.valor_total)||0), 0);
      const iva_pct = Math.max(0, num($("iva_porcentaje")?.value));
      const iva_valor = Math.max(0, subtotal * (iva_pct / 100));
      const copago = Math.max(0, num($("copago").value));
      const cuota = Math.max(0, num($("cuota_moderadora").value));

      // ‚úÖ Total = subtotal + IVA - copago - cuota
      const total = Math.max(0, (subtotal + iva_valor) - copago - cuota);

      return { subtotal, iva_pct, iva_valor, copago, cuota_moderadora: cuota, total };
    }

    function recalcularTotales(){
      const t = calcularTotalesObj();
      $("subtotal").textContent = money(t.subtotal);
      $("iva_valor").textContent = money(t.iva_valor);
      $("total").textContent = money(t.total);
    }

    function formatFechaHuman(iso){
      if (!iso) return "‚Äî";
      // intenta manejar 'YYYY-MM-DD' o timestamp
      try{
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())){
          // probablemente 'YYYY-MM-DD'
          const [y,m,dd] = String(iso).split("-");
          if (y && m && dd) return `${dd}/${m}/${y}`;
          return String(iso);
        }
        return d.toLocaleDateString("es-CO", { year:"numeric", month:"2-digit", day:"2-digit" });
      } catch(e){
        return String(iso);
      }
    }

    function buildInvoiceHTML({ fac, detalle, totals }){
      const rows = (detalle || []).map(it => `
        <tr>
          <td style="padding:10px;border-bottom:1px solid #e5e7eb;font-family:ui-monospace,monospace;font-size:12px;">${escapeHtml(it.codigo_cups || "‚Äî")}</td>
          <td style="padding:10px;border-bottom:1px solid #e5e7eb;">${escapeHtml(it.descripcion || "")}</td>
          <td style="padding:10px;border-bottom:1px solid #e5e7eb;text-align:right;">${Number(it.cantidad||0)}</td>
          <td style="padding:10px;border-bottom:1px solid #e5e7eb;text-align:right;">$ ${money(it.valor_unitario || 0)}</td>
          <td style="padding:10px;border-bottom:1px solid #e5e7eb;text-align:right;font-family:ui-monospace,monospace;font-size:12px;">$ ${money(it.valor_total || 0)}</td>
        </tr>
      `).join("");

      const eps = fac?.eps ? escapeHtml(fac.eps) : "‚Äî";
      const tipo = fac?.tipo_usuario ? escapeHtml(fac.tipo_usuario) : "‚Äî";
      const profesional = fac?.profesional ? escapeHtml(fac.profesional) : "‚Äî";

      return `
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Factura ${escapeHtml(fac?.numero_factura || "")}</title>
<style>
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial, sans-serif;color:#111827;background:#fff}
  .wrap{padding:22px}
  .head{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;border-bottom:2px solid #e5e7eb;padding-bottom:12px;margin-bottom:14px}
  .h1{font-weight:900;font-size:16px;margin:0}
  .muted{color:#6b7280;font-size:12px;line-height:1.35}
  .box{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:12px}
  .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  .kv{font-size:12px;color:#6b7280}
  .kv b{display:block;color:#111827;font-size:13px;margin-top:4px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th{background:#f9fafb;color:#6b7280;font-size:12px;text-align:left;padding:10px;border-bottom:1px solid #e5e7eb}
  .tot{display:flex;justify-content:flex-end;margin-top:12px}
  .totbox{min-width:320px;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
  .line{display:flex;justify-content:space-between;padding:6px 0;font-size:13px}
  .line b{font-family:ui-monospace,monospace;font-size:12px}
  .grand{border-top:1px solid #e5e7eb;margin-top:8px;padding-top:10px;font-weight:900}
  @media print{
    .no-print{display:none !important}
    body{background:#fff}
    .wrap{padding:0}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="head">
      <div>
        <p class="h1">CL√çNICA ODONTOL√ìGICA ‚Äî FACTURA</p>
        <div class="muted">
          N¬∞ Factura: <b style="color:#111827">${escapeHtml(fac?.numero_factura || "‚Äî")}</b><br/>
          Fecha: <b style="color:#111827">${escapeHtml(formatFechaHuman(fac?.fecha))}</b>
        </div>
      </div>
      <div class="muted" style="text-align:right">
        Impreso: <b style="color:#111827">${new Date().toLocaleString("es-CO")}</b><br/>
        Usuario: <b style="color:#111827">${escapeHtml(state.session?.user?.email || "‚Äî")}</b>
      </div>
    </div>

    <div class="box">
      <div class="grid">
        <div class="kv">Paciente<b>${escapeHtml(fac?.paciente_nombre || "‚Äî")}</b></div>
        <div class="kv">C√©dula<b>${escapeHtml(fac?.paciente_cedula || "‚Äî")}</b></div>
        <div class="kv">Profesional<b>${profesional}</b></div>
        <div class="kv">Tipo usuario<b>${tipo}</b></div>
        <div class="kv">EPS<b>${eps}</b></div>
        <div class="kv">Observaci√≥n<b>‚Äî</b></div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:140px;">CUPS</th>
            <th>Procedimiento</th>
            <th style="width:80px;text-align:right;">Cant</th>
            <th style="width:140px;text-align:right;">V/Unit</th>
            <th style="width:160px;text-align:right;">Total</th>
          </tr>
        </thead>
        <tbody>
          ${rows || `<tr><td colspan="5" style="padding:14px;color:#6b7280;text-align:center;">Sin detalle</td></tr>`}
        </tbody>
      </table>

      <div class="tot">
        <div class="totbox">
          <div class="line"><span>Subtotal</span><b>$ ${money(totals.subtotal)}</b></div>
          <div class="line"><span>IVA (${Number(totals.iva_pct||0)}%)</span><b>$ ${money(totals.iva_valor)}</b></div>
          <div class="line"><span>Copago</span><b>$ ${money(totals.copago)}</b></div>
          <div class="line"><span>Cuota moderadora</span><b>$ ${money(totals.cuota_moderadora)}</b></div>
          <div class="line grand"><span>TOTAL</span><b>$ ${money(totals.total)}</b></div>
        </div>
      </div>
    </div>

    <div class="muted" style="margin-top:12px">
      Este documento es una representaci√≥n de factura generada por el sistema.
    </div>

    <div class="no-print" style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
      <button onclick="window.print()" style="border:1px solid #e5e7eb;background:#1f6aa5;color:#fff;padding:10px 12px;border-radius:10px;font-weight:800;cursor:pointer;">üñ® Imprimir</button>
      <button onclick="window.close()" style="border:1px solid #e5e7eb;background:#fff;padding:10px 12px;border-radius:10px;font-weight:800;cursor:pointer;">Cerrar</button>
    </div>
  </div>
</body>
</html>`;
    }

    async function guardarFactura(){
      const fecha = ($("fecha").value || "").trim() || hoyISO();
      const paciente_cedula = ($("paciente_cedula").value || "").trim();
      const paciente_nombre = ($("paciente_nombre").value || "").trim();
      const profesional = ($("profesional").value || "").trim();

      if (!paciente_cedula || !paciente_nombre){
        toast("Paciente: c√©dula y nombre son obligatorios", "err");
        return;
      }
      if (!profesional){
        toast("Selecciona el profesional", "err");
        return;
      }
      if (state.items.length === 0){
        toast("Agrega al menos 1 procedimiento", "err");
        return;
      }

      const numero_factura = ($("numero_factura").value || "").trim() || generarNumeroFactura();
      $("numero_factura").value = numero_factura;

      const eps = ($("eps").value || "").trim() || null;
      const tipo_usuario = ($("tipo_usuario").value || "Particular").trim();

      const totals = calcularTotalesObj();

      setStatus("Guardando factura...");

      try{
        // ‚úÖ Intento 1: guardando IVA si existen columnas (si no, reintenta sin IVA)
        const payloadConIVA = {
          fecha,
          paciente_cedula,
          paciente_nombre,
          tipo_usuario,
          eps,
          numero_factura,
          valor_total: totals.total,
          copago: totals.copago,
          cuota_moderadora: totals.cuota_moderadora,
          profesional,

          // Campos opcionales (solo si existen en tu tabla)
          subtotal: totals.subtotal,
          iva_porcentaje: totals.iva_pct,
          iva_valor: totals.iva_valor
        };

        let fac = null;

        const { data: fac1, error: e1 } = await supabase
          .from("facturas")
          .insert([payloadConIVA])
          .select("*")
          .single();

        if (e1){
          const msg = String(e1.message || "").toLowerCase();
          const isColumnMissing =
            msg.includes("column") && (msg.includes("does not exist") || msg.includes("not exist"));

          if (!isColumnMissing) throw e1;

          // ‚úÖ Reintento SIN los campos IVA (para no romper si no has creado columnas)
          const payloadSinIVA = {
            fecha,
            paciente_cedula,
            paciente_nombre,
            tipo_usuario,
            eps,
            numero_factura,
            valor_total: totals.total,
            copago: totals.copago,
            cuota_moderadora: totals.cuota_moderadora,
            profesional
          };

          const { data: fac2, error: e1b } = await supabase
            .from("facturas")
            .insert([payloadSinIVA])
            .select("*")
            .single();

          if (e1b) throw e1b;
          fac = fac2;
        } else {
          fac = fac1;
        }

        const detalle = state.items.map(it => ({
          factura_id: fac.id,
          codigo_cups: it.codigo_cups || null,
          descripcion: it.descripcion || "",
          cantidad: it.cantidad || 1,
          valor_unitario: it.valor_unitario || 0,
          valor_total: it.valor_total || 0
        }));

        const { error: e2 } = await supabase
          .from("factura_detalle")
          .insert(detalle);

        if (e2) throw e2;

        state.facturaGuardada = fac;
        $("btn-imprimir").disabled = false;
        setStatus("");
        toast("Factura guardada ‚úÖ", "ok");

      } catch(err){
        console.error(err);
        setStatus("");
        toast("No se pudo guardar:\n" + (err?.message || "Error"), "err");
      }
    }

    async function imprimirFacturaGuardada(){
      if (!state.facturaGuardada){
        toast("Primero guarda la factura", "warn");
        return;
      }

      try{
        setStatus("Preparando impresi√≥n...");

        // ‚úÖ trae detalle real desde DB para asegurar que imprime lo guardado
        const { data: det, error } = await supabase
          .from("factura_detalle")
          .select("codigo_cups, descripcion, cantidad, valor_unitario, valor_total")
          .eq("factura_id", state.facturaGuardada.id)
          .order("id", { ascending: true });

        if (error) throw error;

        // Totales usando lo que hay en pantalla (IVA, copago, cuota) + items actuales
        // (Si quieres forzar a lo guardado, necesitar√≠as columnas de IVA/subtotal en facturas)
        const totals = calcularTotalesObj();

        const html = buildInvoiceHTML({
          fac: state.facturaGuardada,
          detalle: det || [],
          totals
        });

        const w = window.open("", "_blank", "width=900,height=700");
        if (!w){
          setStatus("");
          toast("Bloqueo de popups: habilita ventanas emergentes para imprimir.", "warn");
          return;
        }
        w.document.open();
        w.document.write(html);
        w.document.close();

        // imprimir cuando cargue
        w.onload = () => {
          try { w.focus(); w.print(); } catch(e) {}
        };

        setStatus("");
      } catch(err){
        console.error(err);
        setStatus("");
        toast("No se pudo imprimir:\n" + (err?.message || "Error"), "err");
      }
    }

    /* ‚úÖ MODAL: VER FACTURAS */
    function openModal(){
      $("modal-facturas").classList.add("show");
      $("modal-facturas").setAttribute("aria-hidden", "false");
    }
    function closeModal(){
      $("modal-facturas").classList.remove("show");
      $("modal-facturas").setAttribute("aria-hidden", "true");
    }

    function renderFacturasTabla(rows){
      const tbody = $("tbody-facturas");
      tbody.innerHTML = "";

      if (!rows || rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="6" class="empty">No hay facturas para mostrar.</td></tr>`;
        return;
      }

      for (const f of rows){
        const tr = document.createElement("tr");

        const fecha = formatFechaHuman(f.fecha);
        const numf = f.numero_factura || "‚Äî";
        const nom = f.paciente_nombre || "‚Äî";
        const ced = f.paciente_cedula || "‚Äî";
        const total = money(f.valor_total || 0);

        tr.innerHTML = `
          <td class="mono">${escapeHtml(fecha)}</td>
          <td class="mono">${escapeHtml(numf)}</td>
          <td>${escapeHtml(nom)}</td>
          <td class="mono">${escapeHtml(ced)}</td>
          <td class="mono">$ ${escapeHtml(total)}</td>
          <td style="white-space:nowrap;">
            <button class="btn small" data-act="cargar">‚Ü© Cargar</button>
            <button class="btn small primary" data-act="imprimir">üñ® Imprimir</button>
          </td>
        `;

        tr.querySelector('[data-act="cargar"]').addEventListener("click", async () => {
          await cargarFacturaEnFormulario(f.id);
          closeModal();
        });

        tr.querySelector('[data-act="imprimir"]').addEventListener("click", async () => {
          await imprimirFacturaPorId(f.id);
        });

        tbody.appendChild(tr);
      }
    }

    async function listarFacturas(){
      const limit = parseInt($("limite_facturas").value || "50", 10) || 50;
      const q = ($("buscar_facturas").value || "").trim();

      try{
        $("tbody-facturas").innerHTML = `<tr><td colspan="6" class="empty">Cargando...</td></tr>`;

        let query = supabase
          .from("facturas")
          .select("id, fecha, numero_factura, paciente_nombre, paciente_cedula, valor_total, copago, cuota_moderadora, tipo_usuario, eps, profesional")
          .order("fecha", { ascending: false })
          .limit(limit);

        // Si hay b√∫squeda, filtramos por numero_factura o cedula (sin OR avanzado para evitar l√≠os)
        // Intentamos primero por numero_factura; si no hay, intentamos por cedula.
        if (q){
          // si parece n√∫mero, busca por c√©dula exacta o parcial
          const isNum = /^[0-9]+$/.test(q);
          if (isNum){
            query = query.ilike("paciente_cedula", `%${q}%`);
          } else {
            query = query.ilike("numero_factura", `%${q}%`);
          }
        }

        const { data, error } = await query;
        if (error) throw error;

        state.facturas = data || [];
        renderFacturasTabla(state.facturas);

      } catch(err){
        console.error(err);
        renderFacturasTabla([]);
        toast("No se pudieron cargar facturas:\n" + (err?.message || "Error"), "err");
      }
    }

    async function cargarFacturaEnFormulario(facturaId){
      try{
        setStatus("Cargando factura...");
        const { data: fac, error: e1 } = await supabase
          .from("facturas")
          .select("*")
          .eq("id", facturaId)
          .single();

        if (e1) throw e1;

        const { data: det, error: e2 } = await supabase
          .from("factura_detalle")
          .select("codigo_cups, descripcion, cantidad, valor_unitario, valor_total")
          .eq("factura_id", facturaId)
          .order("id", { ascending: true });

        if (e2) throw e2;

        // llena cabecera
        $("fecha").value = (fac.fecha && String(fac.fecha).includes("T")) ? String(fac.fecha).slice(0,10) : (fac.fecha || hoyISO());
        $("numero_factura").value = fac.numero_factura || "";
        $("tipo_usuario").value = fac.tipo_usuario || "Particular";
        $("eps").value = fac.eps || "";
        $("paciente_cedula").value = fac.paciente_cedula || "";
        $("paciente_nombre").value = fac.paciente_nombre || "";
        $("profesional").value = fac.profesional || "";

        // detalle
        state.items = (det || []).map(it => ({
          id_local: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
          codigo_cups: it.codigo_cups || "",
          descripcion: it.descripcion || "",
          cantidad: Number(it.cantidad || 1),
          valor_unitario: Number(it.valor_unitario || 0),
          valor_total: Number(it.valor_total || 0)
        }));

        // IVA: si existe en DB lo usamos, si no, dejamos lo del input actual
        if ($("iva_porcentaje")){
          const ivaPctDB = fac.iva_porcentaje ?? fac.iva_pct ?? null;
          if (ivaPctDB !== null && ivaPctDB !== undefined && String(ivaPctDB).trim() !== ""){
            $("iva_porcentaje").value = Number(ivaPctDB) || 0;
          }
        }

        $("copago").value = Number(fac.copago || 0);
        $("cuota_moderadora").value = Number(fac.cuota_moderadora || 0);

        state.facturaGuardada = fac;
        $("btn-imprimir").disabled = false;

        renderItems();
        recalcularTotales();
        setStatus("");
        toast("Factura cargada ‚úÖ", "ok");
      } catch(err){
        console.error(err);
        setStatus("");
        toast("No se pudo cargar:\n" + (err?.message || "Error"), "err");
      }
    }

    async function imprimirFacturaPorId(facturaId){
      try{
        setStatus("Preparando impresi√≥n...");
        const { data: fac, error: e1 } = await supabase
          .from("facturas")
          .select("*")
          .eq("id", facturaId)
          .single();

        if (e1) throw e1;

        const { data: det, error: e2 } = await supabase
          .from("factura_detalle")
          .select("codigo_cups, descripcion, cantidad, valor_unitario, valor_total")
          .eq("factura_id", facturaId)
          .order("id", { ascending: true });

        if (e2) throw e2;

        // Totales:
        // - Si tu tabla facturas tiene subtotal/iva_valor/iva_porcentaje, los usamos.
        // - Si no, recalculamos desde el detalle + IVA% (si existe) y restamos copago/cuota.
        const subtotal = (fac.subtotal !== undefined && fac.subtotal !== null)
          ? Number(fac.subtotal || 0)
          : (det || []).reduce((a,b)=> a + (Number(b.valor_total)||0), 0);

        const iva_pct = (fac.iva_porcentaje !== undefined && fac.iva_porcentaje !== null)
          ? Number(fac.iva_porcentaje || 0)
          : ((fac.iva_pct !== undefined && fac.iva_pct !== null) ? Number(fac.iva_pct || 0) : 0);

        const iva_valor = (fac.iva_valor !== undefined && fac.iva_valor !== null)
          ? Number(fac.iva_valor || 0)
          : Math.max(0, subtotal * (Math.max(0, iva_pct) / 100));

        const copago = Number(fac.copago || 0);
        const cuota = Number(fac.cuota_moderadora || 0);
        const total = (fac.valor_total !== undefined && fac.valor_total !== null)
          ? Number(fac.valor_total || 0)
          : Math.max(0, (subtotal + iva_valor) - copago - cuota);

        const html = buildInvoiceHTML({
          fac,
          detalle: det || [],
          totals: { subtotal, iva_pct, iva_valor, copago, cuota_moderadora: cuota, total }
        });

        const w = window.open("", "_blank", "width=900,height=700");
        if (!w){
          setStatus("");
          toast("Bloqueo de popups: habilita ventanas emergentes para imprimir.", "warn");
          return;
        }
        w.document.open();
        w.document.write(html);
        w.document.close();
        w.onload = () => {
          try { w.focus(); w.print(); } catch(e) {}
        };

        setStatus("");
      } catch(err){
        console.error(err);
        setStatus("");
        toast("No se pudo imprimir:\n" + (err?.message || "Error"), "err");
      }
    }

    async function init(){
      $("year").textContent = new Date().getFullYear();
      $("fecha").value = hoyISO();
      $("numero_factura").value = generarNumeroFactura();

      $("btn-back").addEventListener("click", ()=> window.location.href = INDEX_URL);
      $("btn-buscar").addEventListener("click", buscarPacienteEnHistoria);
      $("btn-add").addEventListener("click", agregarProcedimiento);

      $("copago").addEventListener("input", recalcularTotales);
      $("cuota_moderadora").addEventListener("input", recalcularTotales);

      // ‚úÖ NUEVO: IVA recalcula
      $("iva_porcentaje").addEventListener("input", recalcularTotales);

      $("btn-guardar").addEventListener("click", guardarFactura);

      // ‚úÖ FIX: imprimir real (abre ventana con factura y manda a imprimir)
      $("btn-imprimir").addEventListener("click", imprimirFacturaGuardada);

      $("btn-logout").addEventListener("click", cerrarSesion);

      // ‚úÖ Autocompletar al escribir
      $("paciente_cedula").addEventListener("input", onCedulaInput);

      // ‚úÖ Modal facturas
      $("btn-ver-facturas").addEventListener("click", async () => {
        openModal();
        await listarFacturas();
      });
      $("btn-cerrar-modal").addEventListener("click", closeModal);
      $("modal-facturas").addEventListener("click", (e) => {
        if (e.target === $("modal-facturas")) closeModal();
      });
      $("btn-refresh-facturas").addEventListener("click", listarFacturas);
      $("btn-buscar-facturas").addEventListener("click", listarFacturas);
      $("limite_facturas").addEventListener("change", listarFacturas);
      $("buscar_facturas").addEventListener("keydown", (e) => {
        if (e.key === "Enter") listarFacturas();
      });

      const ok = await proteger();
      if (!ok) return;

      await cargarProfesionales();
      await cargarProcedimientos();
      renderItems();
      recalcularTotales();
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>


