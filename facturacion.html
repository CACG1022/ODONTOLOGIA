<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Facturaci√≥n - Cl√≠nica Odontol√≥gica</title>
  <!-- ‚úÖ Librer√≠a para exportar Excel (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg: #f3f5f7;
      --card: #ffffff;
      --text: #1f2a37;
      --muted: #6b7280;
      --line: #e5e7eb;
      --brand: #1f6aa5;
      --brand2: #114a75;
      --danger: #b42318;
      --shadow: 0 10px 30px rgba(16,24,40,.08);
      --radius: 14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 18px;
    }
    .topbar{
      max-width: 1100px;
      margin: 0 auto 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand h1{ font-size: 16px; margin:0; }
    .meta{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    /* ‚úÖ Chip multi-l√≠nea para Usuario + Rol */
    .chip{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--muted);
      box-shadow: 0 3px 10px rgba(0,0,0,.03);
      white-space:nowrap;
      display:flex;
      flex-direction:column;
      gap:4px;
      line-height:1.2;
    }
    .chip b{ color: var(--text); }
    .chip .line{ display:flex; gap:6px; align-items:baseline; }
    .chip .line span{ color: var(--muted); }
    .chip .line small{ color: var(--muted); font-weight:700; }
    .container{
      max-width: 1100px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .header{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .header .title{ font-weight:800; font-size: 14px; }
    .section{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      background: #fff;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .ctrl label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin-bottom:6px;
      font-weight:700;
    }
    input, select{
      width:100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      font-size: 14px;
      background:#fff;
    }
    .row-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }
    .btn{
      border: 1px solid var(--line);
      background: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 800;
      color: var(--text);
    }
    .btn:hover{ filter: brightness(.98); }
    .btn.primary{
      background: var(--brand);
      color:#fff;
      border-color: var(--brand);
    }
    .btn.primary:hover{ background: var(--brand2); border-color: var(--brand2); }
    .btn.danger{ color: var(--danger); border-color:#f2c6c6; }
    .btn.small{ padding: 8px 10px; font-size: 12px; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    table{ width:100%; border-collapse: collapse; }
    th, td{
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      text-align:left;
      vertical-align: middle;
    }
    th{
      font-size: 12px;
      color: var(--muted);
      background: #fafafa;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    td input{ padding: 8px 10px; }
    td.actions{ width: 120px; white-space: nowrap; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .empty{ color: var(--muted); text-align:center; padding: 18px; }
    .totales{
      display:flex;
      justify-content:flex-end;
      padding: 12px 16px;
      gap: 18px;
      border-top: 1px solid var(--line);
      background:#fbfcfd;
      flex-wrap:wrap;
    }
    .totales .box{
      min-width: 260px;
      border:1px solid var(--line);
      border-radius: 12px;
      background:#fff;
      padding: 12px;
    }
    .totales .box div{
      display:flex;
      justify-content:space-between;
      padding: 5px 0;
      font-size: 13px;
      gap: 10px;
      align-items:center;
    }
    .actions-bottom{
      padding: 12px 16px;
      border-top: 1px solid var(--line);
      background:#fff;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      flex-wrap:wrap;
    }
    .actions-bottom .left-note{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      flex: 1 1 380px;
    }
    .actions-bottom .btns{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .footer{
      padding: 12px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      color: var(--muted);
      font-size: 12px;
      border-top: 1px solid var(--line);
      background: #fff;
    }
    #toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      box-shadow: var(--shadow);
      font-weight: 800;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .15s ease, transform .15s ease;
      pointer-events: none;
      max-width: 340px;
      white-space: pre-wrap;
    }
    #toast.show{ opacity: 1; transform: translateY(0); }
    #toast[data-type="ok"]{ border-color: #b7e4c7; }
    #toast[data-type="err"]{ border-color: #f2c6c6; }
    #toast[data-type="warn"]{ border-color: #ffe7b3; }
    /* ‚úÖ MODAL FACTURAS */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal.show{ display:flex; }
    .modal-card{
      width: min(1100px, 100%);
      background:#fff;
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* ‚úÖ MAXIMIZAR MODAL (Facturas generadas) */
    .modal-card.maximized{
      width: calc(100vw - 36px);
      height: calc(100vh - 36px);
      display:flex;
      flex-direction:column;
    }
    .modal-card.maximized .modal-body{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    .modal-card.maximized .modal-table{
      flex:1;
      max-height: none;
      min-height: 0;
    }
    .modal-head{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      background:#fff;
    }
    .modal-head .title{ font-weight: 900; }
    .modal-body{
      padding: 12px 14px;
      background:#fff;
    }
    .modal-tools{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      margin-bottom: 10px;
    }
    .modal-tools .ctrl{ min-width: 220px; }
    .modal-table{
      max-height: 60vh;
      overflow:auto;
      border: 1px solid var(--line);
      border-radius: 12px;
    }
    /* ‚úÖ resumen total facturado */
    .modal-summary{
      margin-top: 10px;
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .summary-chip{
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      background:#fff;
      box-shadow: 0 3px 10px rgba(0,0,0,.03);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .summary-chip b{ color: var(--text); }
    @media (max-width: 900px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px){
      .grid{ grid-template-columns: 1fr; }
      .actions-bottom{ justify-content:flex-start; }
      .actions-bottom .btns{ width:100%; justify-content:flex-start; }
    }
  
  .oculto{display:none!important;}

  /* ================================
   COMPACTAR FILAS DE PROCEDIMIENTOS
   ================================ */

/* Reducir padding de filas */
table td {
  padding: 8px 12px;   /* antes ~12px 16px */
  vertical-align: middle;
}

/* Encabezados un poco m√°s compactos */
table th {
  padding: 8px 12px;
}

/* Inputs dentro de la tabla */
table td input {
  padding: 6px 8px;
  height: 34px;
  font-size: 13px;
}

/* Bot√≥n quitar m√°s compacto */
table td .btn.small,
table td button {
  padding: 6px 10px;
  font-size: 12px;
}

/* Texto del procedimiento */
table td:nth-child(2) {
  line-height: 1.2;
}

/* Columna de totales */
table td.mono {
  font-size: 13px;
}

</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <h1>CL√çNICA ODONTOL√ìGICA ‚Äî Facturaci√≥n6</h1>
    </div>
    <div class="meta">
      <div class="chip">
        <div class="line"><span>Usuario:</span> <b id="user-email">‚Äî</b></div>
        <div class="line"><small>Rol:</small> <b id="user-role">‚Äî</b></div>
      </div>
      <button class="btn danger" id="btn-logout" type="button">Cerrar sesi√≥n</button>
    </div>
  </div>
  <div class="container">
    <div class="header">
      <div class="title">Nueva factura</div>
      <div class="row-actions" style="margin-top:0;">
        <button class="btn" id="btn-back" type="button">‚¨Ö Volver</button>
        <button class="btn" id="btn-ver-facturas" type="button">üìÑ Ver facturas</button>
      </div>
    </div>
    <div class="section">
      <div class="grid">
        <div class="ctrl">
          <label>Fecha</label>
          <input id="fecha" type="date">
        </div>
        <div class="ctrl">
          <label>No. factura</label>
          <input id="numero_factura" type="text">
        </div>
        <div class="ctrl">
          <label>Tipo usuario</label>
          <select id="tipo_usuario">
            <option>Particular</option>
            <option>Contributivo</option>
            <option>Subsidiado</option>
          </select>
        </div>
        <div class="ctrl">
          <label>EPS (si aplica)</label>
          <input id="eps" type="text" placeholder="Opcional">
        </div>
      </div>
    </div>
    <div class="section">
      <div class="grid">
        <div class="ctrl">
          <label>C√©dula paciente</label>
          <input id="paciente_cedula" inputmode="numeric" placeholder="Solo n√∫meros">
          <div style="margin-top:6px; font-size:12px; color:var(--muted);" id="paciente-hint"></div>
        </div>
        <div class="ctrl">
          <label>Nombre paciente</label>
          <input id="paciente_nombre" type="text" placeholder="Nombres y apellidos">
        </div>
        <div class="ctrl">
          <label>Profesional</label>
          <select id="profesional"></select>
        </div>
        <div class="ctrl">
          <label>&nbsp;</label>
          <button class="btn" id="btn-buscar" type="button">üîé Autocompletar (si existe)</button>
        </div>
        <div class="ctrl" style="grid-column: span 2;">
          <label>Correo paciente</label>
          <input id="paciente_correo" type="email" placeholder="correo@ejemplo.com">
        </div>
      </div>
    </div>
    <div class="section">
      <div class="grid">
        <div class="ctrl">
          <label>M√©todo de pago</label>
          <select id="metodo_pago">
            <option value="Efectivo" selected>Efectivo</option>
            <option value="Transferencia">Transferencia</option>
            <option value="Tarjeta">Tarjeta</option>
            <option value="Nequi">Nequi</option>
            <option value="Daviplata">Daviplata</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        <div class="ctrl oculto">
          <label>Estado de pago</label>
          <select id="pagada">
            <option value="si" selected>Pagada</option>
            <option value="no">Pendiente</option>
          </select>
        </div>
        <div class="ctrl oculto" style="grid-column: span 2;">
          <label>Referencia / Comprobante (opcional)</label>
          <input id="referencia_pago" type="text" placeholder="Ej: #transferencia, voucher, √∫ltimo 4 d√≠gitos, etc.">
        </div>
        <div class="ctrl" style="grid-column: span 4;">
          <label>Observaci√≥n (opcional)</label>
          <input id="observacion" type="text" placeholder="Ej: referencia/nota/observaci√≥n...">
        </div>
      </div>
    </div>
    <div class="section">
      <div class="grid">
        <div class="ctrl" style="grid-column: span 2; position:relative;">
          <label>Agregar procedimiento</label>
          <input id="sel-proc-input" type="text" placeholder="Escribe para buscar procedimiento..." autocomplete="off"/>
          <select id="sel-proc" class="oculto"></select>
          <div id="proc-dropdown" style="position:absolute; top:72px; left:0; right:0; z-index:20; background:#fff; border:1px solid var(--line); border-radius:10px; max-height:260px; overflow:auto; display:none;"></div>
        </div>
        <div class="ctrl">
          <label>Cantidad</label>
          <input id="cantidad" type="number" min="1" step="1" value="1">
        </div>
        <div class="ctrl">
          <label>&nbsp;</label>
          <button class="btn primary" id="btn-add" type="button">‚ûï Agregar</button>
        </div>
      </div>
      <div style="margin-top:12px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:180px;">Profesional</th>
              <th style="width:140px;">CUPS</th>
              <th>Procedimiento</th>
              <th style="width:110px;">Cant</th>
              <th style="width:160px;">V/Unit</th>
              <th style="width:160px;">Total</th>
              <th style="width:120px;"></th>
            </tr>
          </thead>
          <tbody id="tbody-items"></tbody>
        </table>
      </div>
    </div>
    <div class="totales">
      <div class="box">
        <div><span>Subtotal</span><b>$ <span id="subtotal">0</span></b></div>
        <div style="align-items:flex-start;">
          <span>Descuento</span>
          <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
            <div style="display:flex; gap:8px; align-items:center;">
              <span style="color:var(--muted); font-weight:700;">%</span>
              <input id="descuento_pct" type="number" min="0" max="100" step="0.01" value="0" style="width:140px; text-align:right;">
            </div>
            <div class="mono" style="color:var(--muted);">Desc: $ <span id="descuento_valor">0</span></div>
          </div>
        </div>
        <div>
          <span>¬øAplica IVA?</span>
          <b>
            <select id="iva_aplica" style="width:140px;">
              <option value="no">No</option>
              <option value="si" selected>S√≠</option>
            </select>
          </b>
        </div>
        <div style="align-items:flex-start;">
          <span>IVA</span>
          <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
            <div style="display:flex; gap:8px; align-items:center;">
              <span style="color:var(--muted); font-weight:700;">%</span>
              <input id="iva_porcentaje" type="number" min="0" step="0.01" value="19" style="width:140px; text-align:right;">
            </div>
            <div class="mono" style="color:var(--muted);">IVA: $ <span id="iva_valor">0</span></div>
          </div>
        </div>
        <div>
          <span>Copago</span>
          <b>$ <input id="copago" type="number" min="0" step="100" value="0" style="width:140px; text-align:right;"></b>
        </div>
        <div>
          <span>Cuota moderadora</span>
          <b>$ <input id="cuota_moderadora" type="number" min="0" step="100" value="0" style="width:140px; text-align:right;"></b>
        </div>
        <div style="border-top:1px solid var(--line); margin-top:6px; padding-top:8px;">
          <span>Total</span><b>$ <span id="total">0</span></b>
        </div>
      </div>
  
    </div>
    <div class="actions-bottom">
      <div class="btns">
        <button class="btn primary" id="btn-guardar" type="button">üíæ Guardar factura</button>
        <button class="btn" id="btn-imprimir" type="button" disabled>üñ® Imprimir</button>
        <button type="button" id="btn-cargar-plan" style=" background:#0ea5e9; color:#fff; font-weight:800;
        padding:10px 14px;
        border-radius:10px;
        border:none;
        cursor:pointer;
        box-shadow:0 6px 14px rgba(0,0,0,.18);
        margin-bottom:10px;
  "
>
  üì• Cargar plan de tratamiento
</button>
      </div>
    </div>


    

    
    <div class="footer">
      <div class="status" id="status"></div>
      <div>¬© <span id="year"></span></div>
    </div>
  </div>
  <div id="toast" data-type="ok"></div>
  <div class="modal" id="modal-facturas" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="title">Facturas generadas</div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" id="btn-export-excel" type="button">‚¨á Excel</button>
          <button class="btn" id="btn-refresh-facturas" type="button">üîÑ Actualizar</button>
          <button class="btn" id="btn-max-modal-facturas" type="button" title="Maximizar">‚õ∂</button>
          <button class="btn danger" id="btn-cerrar-modal" type="button">‚úñ Cerrar</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="modal-tools">
          <div class="ctrl">
            <label>Buscar (N¬∞ factura o c√©dula)</label>
            <input id="buscar_facturas" type="text" placeholder="Ej: FAC-2026... o 123456789">
          </div>
          <div class="ctrl">
            <label>Fecha desde</label>
            <input id="fecha_desde" type="date">
          </div>
          <div class="ctrl">
            <label>Fecha hasta</label>
            <input id="fecha_hasta" type="date">
          </div>
          <div class="ctrl">
            <label>Estado</label>
            <select id="estado_facturas">
              <option value="todos" selected>Todos</option>
              <option value="pagada">Pagada</option>
              <option value="pendiente">Pendiente</option>
            </select>
          </div>
          <div class="ctrl">
            <label>Mostrar</label>
            <select id="limite_facturas">
              <option value="25">25</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
            </select>
          </div>
          <div class="ctrl">
            <label>&nbsp;</label>
            <button class="btn primary" id="btn-buscar-facturas" type="button">üîé Buscar</button>
          </div>
        </div>
        <div class="modal-table">
          <table>
            <thead>
              <tr>
                <th style="width:160px;">Fecha</th>
                <th style="width:220px;">N¬∞ Factura</th>
                <th>Paciente</th>
                <th style="width:160px;">C√©dula</th>
                <th style="width:140px;">Pago</th>
                <th style="width:160px;">Total</th>
                <th style="width:170px;">Saldo pendiente</th>
                <th style="width:260px;">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody-facturas">
              <tr><td colspan="8" class="empty">Cargando...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="modal-summary">
          <div class="summary-chip">
            Total facturado (filtro): <b>$ <span id="total_facturado">0</span></b>
          </div>
          <div class="summary-chip">
            Cantidad: <b><span id="count_facturas">0</span></b>
          </div>
        </div>
        <div class="mono" style="margin-top:10px; color:var(--muted);">
          Tip: Puedes imprimir una factura desde ‚Äúüñ® Imprimir‚Äù en acciones.
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal" id="modal-verfactura" aria-hidden="true">
    <div class="modal-card" style="max-width:1100px;">
      <div class="modal-head">
        <div class="title">Factura</div>
        <div class="modal-tools">
          <button class="btn" id="btn-imprimir-verfactura" type="button">üñ® Imprimir</button>
          <button class="btn primary" id="btn-fe-electronica" type="button" onclick="enviarFacturacionElectronica()">‚ö° Facturaci√≥n electr√≥nica</button>
          <button class="btn danger" id="btn-cerrar-modal-verfactura" type="button">‚úñ Cerrar</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="vf-frame" style="border:1px solid var(--line); border-radius:12px; overflow:hidden;">
          <iframe id="vf_iframe" title="Factura" style="width:100%; height:80vh; border:0; background:#fff;" sandbox="allow-same-origin allow-scripts"></iframe>
        </div>
      </div>
    </div>
  </div>
  <div class="modal" id="modal-abonos" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div class="title">Abonos de la factura</div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" id="btn-refresh-abonos" type="button">üîÑ Actualizar</button>
          <button class="btn danger" id="btn-cerrar-modal-abonos" type="button">‚úñ Cerrar</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="modal-tools">
          <div class="ctrl" style="min-width:220px;">
            <label>Fecha</label>
            <input id="abono_fecha" type="date">
          </div>
          <div class="ctrl" style="min-width:220px;">
            <label>Monto</label>
            <input id="abono_monto" type="number" min="0" step="100" placeholder="0">
          </div>
          <div class="ctrl" style="min-width:220px;">
            <label>M√©todo</label>
            <select id="abono_metodo">
              <option value="Efectivo" selected>Efectivo</option>
              <option value="Transferencia">Transferencia</option>
              <option value="Tarjeta">Tarjeta</option>
              <option value="Nequi">Nequi</option>
              <option value="Daviplata">Daviplata</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
          <div class="ctrl" style="min-width:260px;">
            <label>Referencia (opcional)</label>
            <input id="abono_referencia" type="text" placeholder="Ej: #transferencia, voucher, etc.">
          </div>
          <div class="ctrl" style="flex:1 1 320px; min-width:260px;">
            <label>Observaci√≥n (opcional)</label>
            <input id="abono_observacion" type="text" placeholder="Nota del abono">
          </div>
          <div class="ctrl" style="min-width:220px;">
            <label>&nbsp;</label>
            <button class="btn primary" id="btn-agregar-abono" type="button">‚ûï Agregar abono</button>
          </div>
        </div>
        <div class="modal-table">
          <table>
            <thead>
              <tr>
                <th style="width:160px;">Fecha</th>
                <th style="width:160px;">Monto</th>
                <th style="width:180px;">M√©todo</th>
                <th>Referencia</th>
                <th>Observaci√≥n</th>
                <th style="width:120px;">Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="tbody-abonos">
              <tr><td colspan="7" class="empty">Selecciona una factura...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="modal-summary">
          <div class="summary-chip">
            Total factura: <b>$ <span id="abonos_total_factura">0</span></b>
          </div>
          <div class="summary-chip">
            Total abonado: <b>$ <span id="abonos_total_abonado">0</span></b>
          </div>
          <div class="summary-chip">
            Saldo: <b>$ <span id="abonos_saldo">0</span></b>
          </div>
        </div>
        <div class="mono" style="margin-top:10px; color:var(--muted);">
          Nota: Para guardar abonos en Supabase crea la tabla <b>abonos</b>. Si no existe, el sistema te mostrar√° un aviso.
        </div>
      </div>
    </div>
  </div>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const SUPABASE_URL = "https://dmcfrmpqlkrqbpjhrfyo.supabase.co".trim();
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE".trim();
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const LOGIN_URL = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
    const INDEX_URL = "https://cacg1022.github.io/ODONTOLOGIA/index.html";
    const LOGO_URL = "https://static.wixstatic.com/media/63e6ec_3973b230e8aa49869f3127b467fb3e6e~mv2.png/v1/fill/w_426,h_426,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/LOGO%20LEIDI%20SILVA%202%20(1).png";
    const N8N_BUSCAR_URL = "https://ftth-n8n2.pzveh5.easypanel.host/webhook/62804cbf-8f21-453b-823e-e5c1b94f31c8";
    const ALLOWED_ROLES = ["admin", "auxiliar"];
    const state = {
      session: null,
      role: null,
      procedimientos: [],
      profesionales: [],
      items: [],
      facturaGuardada: null,
      _debounce: null,
      _lastCedula: "",
      facturas: [],
      abonos: [],
      facturaAbonos: null
    };
    const $ = (id) => document.getElementById(id);
    function toast(msg, type="ok"){
      const el = $("toast");
      el.textContent = msg;
      el.dataset.type = type;
      el.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=> el.classList.remove("show"), 2600);
    }
    function setStatus(msg){
      const el = $("status");
      if (el) el.textContent = msg || "";
    }
    function setHint(msg){
      const el = $("paciente-hint");
      if (el) el.textContent = msg || "";
    }
    function money(n){
      const x = Number(n || 0);
      return x.toLocaleString("es-CO");
    }
    function num(v){
      const raw = String(v ?? "").trim();
      if (!raw) return 0;
      const n = Number(raw);
      return Number.isFinite(n) ? n : 0;
    }
    function hoyISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    // ‚úÖ NUEVO: validaci√≥n de fecha en formato YYYY-MM-DD (para prompts)
    function parseDateYYYYMMDD(s){
      const v = String(s || "").trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(v)) return null;
      const d = new Date(v + "T00:00:00.000Z");
      if (Number.isNaN(d.getTime())) return null;
      return v;
    }
    function toISODateTimeFromYYYYMMDD(v){
      return v ? (v + "T00:00:00.000Z") : null;
    }
    function generarNumeroFactura(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `FAC-${y}${m}${da}-${hh}${mi}${ss}`;
    }
    async function cargarRolActual(){
      const email = (state.session?.user?.email || "").trim().toLowerCase();
      const elRole = $("user-role");
      if (!email){
        state.role = "user";
        if (elRole) elRole.textContent = "user";
        return "user";
      }
      try{
        const { data, error } = await supabase
          .from("profiles")
          .select("role, created_at, email")
          .eq("email", email)
          .order("created_at", { ascending: false })
          .limit(1)
          .maybeSingle();
        if (error) throw error;
        const role = (data?.role || "").toString().trim().toLowerCase();
        const finalRole = role || "user";
        state.role = finalRole;
        if (elRole) elRole.textContent = finalRole;
        return finalRole;
      } catch(err){
        console.error("No se pudo leer rol en profiles:", err);
        state.role = "user";
        if (elRole) elRole.textContent = "user";
        return "user";
      }
    }
    function getModuloCandidates(mod){
  const base = String(mod || "").toLowerCase().trim();
  const withHtml = base.endsWith(".html") ? base : base + ".html";
  const undersc = base.replaceAll("-", "_");
  const underscHtml = undersc.endsWith(".html") ? undersc : undersc + ".html";
  return Array.from(new Set([base, withHtml, undersc, underscHtml]));
}
async function validarPermisoDesdeTabla(){
  const modulo = "facturacion";
  const role = (state.role || "user").toLowerCase().trim();
  const candidates = getModuloCandidates(modulo);
  try{
    const { data, error } = await supabase
      .from("modulos_permisos")
      .select("admin, doctor, auxiliar, paciente, modulo")
      .in("modulo", candidates);
    if (error) throw error;
    const permiso = data?.[0];
    if (!permiso || permiso[role] !== true){
      window.alert("‚õî No tienes permiso para acceder a este m√≥dulo.");
      window.location.href = INDEX_URL;
      return false;
    }
    return true;
  }catch(err){
    console.error("Error validando permisos:", err);
    window.alert("‚õî No se pudo validar permisos de acceso.");
    window.location.href = INDEX_URL;
    return false;
  }
}
    async function validarAccesoPorRol(){
  return await validarPermisoDesdeTabla();
}
    async function proteger(){
      const { data: { session } } = await supabase.auth.getSession();
      if(!session){
        window.location.href = LOGIN_URL;
        return false;
      }
      state.session = session;
      const email = (session.user?.email || "Usuario").toString();
      $("user-email").textContent = email;
      await cargarRolActual();
      const okRole = await validarAccesoPorRol();
      if (!okRole) return false;
      return true;
    }
    supabase.auth.onAuthStateChange((event, session) => {
      console.log("AUTH EVENT:", event, "SESSION:", !!session);
      if ((event === "SIGNED_OUT" || event === "USER_DELETED") && !session) {
        window.location.href = LOGIN_URL;
      }
      if ((event === "SIGNED_IN" || event === "TOKEN_REFRESHED") && session) {
        state.session = session;
        $("user-email").textContent = session.user?.email || "Usuario";
        cargarRolActual().then(()=> validarAccesoPorRol());
      }
    });
    async function cerrarSesion(){
      try { await supabase.auth.signOut(); } catch(e) {}
      window.location.href = LOGIN_URL;
    }
    async function cargarProcedimientos(){
      const { data, error } = await supabase
        .from("procedimientos_precios")
        .select("id, procedimiento, valor, codigo_cups, profesional, activo")
        .order("procedimiento", { ascending: true });
      if (error){
        console.error(error);
        toast("Error procedimientos:\n" + error.message, "err");
        state.procedimientos = [];
        renderProcedimientosSelect();
        return;
      }
      const rows = data || [];
      state.procedimientos = rows.filter(r => (r.activo === null || r.activo === undefined) ? true : r.activo === true);
      renderProcedimientosSelect();
    }
    async function cargarProfesionales(){
      const { data, error } = await supabase
        .from("profesionales")
        .select("id, cedula, nombre, activo")
        .order("nombre", { ascending: true });
      if (error){
        console.error(error);
        toast("Error profesionales:\n" + error.message, "err");
        state.profesionales = [];
        renderProfesionales();
        return;
      }
      const rows = data || [];
      state.profesionales = rows.filter(r => (r.activo === null || r.activo === undefined) ? true : r.activo === true);
      renderProfesionales();
    }
    function renderProcedimientosSelect(filtro = ""){
      const sel = $("sel-proc");
      const drop = $("proc-dropdown");
      const f = filtro.toLowerCase();
      sel.innerHTML = `<option value="">‚Äî Selecciona ‚Äî</option>`;
      drop.innerHTML = "";
      let count = 0;
      for (const p of state.procedimientos){
        const label = `${p.procedimiento} ‚Äî $${money(p.valor || 0)}${p.codigo_cups ? ` (CUPS ${p.codigo_cups})` : ""}`;
        if (f && !label.toLowerCase().includes(f)) continue;
        const opt = document.createElement("option");
        opt.value = String(p.id);
        opt.textContent = label;
        sel.appendChild(opt);

        const div = document.createElement("div");
        div.textContent = label;
        div.style.padding = "10px 12px";
        div.style.cursor = "pointer";
        div.addEventListener("mouseenter", () => div.style.background = "#f3f5f7");
        div.addEventListener("mouseleave", () => div.style.background = "#fff");
        div.addEventListener("click", () => {
          $("sel-proc-input").value = label;
          sel.value = opt.value;
          drop.style.display = "none";
        });
        drop.appendChild(div);
        count++;
      }
    
const input = document.getElementById("sel-proc-input");
const isFocused = document.activeElement === input;

// ‚úÖ Mostrar si hay foco (click) o si hay texto escrito
if ((isFocused || filtro) && count > 0) {
  drop.style.display = "block";
} else {
  drop.style.display = "none";
}


    }
    function renderProfesionales(){
      const sel = $("profesional");
      sel.innerHTML = `<option value="">‚Äî Selecciona ‚Äî</option>`;
      for (const pr of state.profesionales){
  const nom = String(pr.nombre || "").trim();
  const opt = document.createElement("option");
  opt.value = nom;               // ‚úÖ value = NOMBRE
  opt.textContent = nom;         // ‚úÖ texto = NOMBRE
  selectProfesional.appendChild(opt);
}

    }
    async function buscarPacienteEnHistoria(force = false){
      const cedula = ($("paciente_cedula").value || "")
        .trim()
        .replace(/[^\d]/g, "");
      $("paciente_cedula").value = cedula;
      if (cedula.length < 6){
        setHint("");
        return;
      }
      if (!force && state._lastCedula === cedula) return;
      state._lastCedula = cedula;
      setHint("Buscando paciente...");
      try{
        const url = `${N8N_BUSCAR_URL}?cedula=${encodeURIComponent(cedula)}`;
        const resp = await fetch(url, { method: "GET" });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (!data?.existe){
          setHint("No encontrado (puedes digitar el nombre).");
          return;
        }
        const h = data.historia || {};
        const nombre = (h["Nombre y apellido"] || "").trim();
        const epsHC  = (h["EPS_Paciente"] || "").trim();
        const correo =
          (h["paciente_email"] || h["CORREO"] || h["Email"] || h["E-mail"] || h["Correo electr√≥nico"] || h["Correo electronico"] || "").toString().trim();
        if (nombre){
          $("paciente_nombre").value = nombre;
          if ($("eps") && epsHC) $("eps").value = epsHC;
          if ($("paciente_correo") && correo) $("paciente_correo").value = correo;
          setHint("‚úÖ Encontrado");
        } else {
          if ($("paciente_correo") && correo) $("paciente_correo").value = correo;
          setHint("Encontrado, pero sin nombre en historia.");
        }
      } catch(err){
        console.error("Error buscando en N8N:", err);
        setHint("Error consultando (mira Console F12).");
      }
    }
    function onCedulaInput(){
      clearTimeout(state._debounce);
      state._debounce = setTimeout(()=> buscarPacienteEnHistoria(false), 350);
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function agregarProcedimiento(){
      const procId = ($("sel-proc").value || "").trim();
      if (!procId){
        toast("Selecciona un procedimiento", "warn");
        return;
      }
      const p = state.procedimientos.find(x => String(x.id) === String(procId));
      if (!p){
        toast("Procedimiento no encontrado", "err");
        return;
      }
      const cantidad = Math.max(1, parseInt($("cantidad").value || "1", 10) || 1);
      const valorU = Math.max(0, num(p.valor || 0));
      const item = {
  id_local: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
  procedimiento_id: p.id,              // ‚úÖ CLAVE
  codigo_cups: p.codigo_cups || "",
  descripcion: p.procedimiento || "",
  cantidad,
  valor_unitario: valorU,
  valor_total: valorU * cantidad
};

      state.items.push(item);
      renderItems();
      recalcularTotales();
      $("sel-proc").value = "";
      $("cantidad").value = "1";
      toast("Agregado ‚úÖ", "ok");
    }
    function eliminarItem(id_local){
      state.items = state.items.filter(x => x.id_local !== id_local);
      renderItems();
      recalcularTotales();
    }
    function renderItems(){
  const tbody = $("tbody-items");
  tbody.innerHTML = "";

  if (state.items.length === 0){
    tbody.innerHTML = `<tr><td colspan="7" class="empty">A√∫n no has agregado procedimientos.</td></tr>`;
    return;
  }

  for (const it of state.items){
    const tr = document.createElement("tr");

    const selectProfesional = document.createElement("select");
    selectProfesional.innerHTML = `<option value="">‚Äî Selecciona ‚Äî</option>`;

    for (const pr of state.profesionales){
      const ced = String(pr.cedula || "").trim();
      const opt = document.createElement("option");
      opt.value = ced;
      opt.textContent = pr.nombre;
      selectProfesional.appendChild(opt);
    }

    // valor inicial
    const valorInicial = normalizeProfesionalValue(
  it.profesional || obtenerProfesionalRawDeItem(it) || ""
);

selectProfesional.value = valorInicial;
it.profesional = valorInicial; // deja consistente el state


    selectProfesional.value = valorInicial;

    selectProfesional.addEventListener("change", () => {
  it.profesional = (selectProfesional.value || "").trim(); // ‚úÖ nombre
});


    tr.innerHTML = `
      <td></td>
      <td class="mono">${escapeHtml(it.codigo_cups || "‚Äî")}</td>
      <td>${escapeHtml(it.descripcion || "")}</td>
      <td><input type="number" min="1" step="1" value="${it.cantidad}" data-k="cantidad"></td>
      <td><input type="number" min="0" step="100" value="${it.valor_unitario}" data-k="valor_unitario"></td>
      <td class="mono">$ ${money(it.valor_total)}</td>
      <td class="actions"><button class="btn danger small" type="button">Quitar</button></td>
    `;

    tr.children[0].appendChild(selectProfesional);

    tr.querySelectorAll("input").forEach(inp => {
      inp.addEventListener("input", () => {
        const k = inp.dataset.k;
        const v = num(inp.value);
        if (k === "cantidad") it.cantidad = Math.max(1, parseInt(v) || 1);
        if (k === "valor_unitario") it.valor_unitario = Math.max(0, v);
        it.valor_total = it.cantidad * it.valor_unitario;
        renderItems();
        recalcularTotales();
      });
    });

    tr.querySelector("button").addEventListener("click", () => eliminarItem(it.id_local));
    tbody.appendChild(tr);
  }
}

    function ivaAplica(){
      return (String($("iva_aplica")?.value || "si").toLowerCase() === "si");
    }
    function syncIVAUI(){
      const aplica = ivaAplica();
      const inp = $("iva_porcentaje");
      if (inp){
        inp.disabled = !aplica;
        inp.style.opacity = aplica ? "1" : ".6";
      }
      recalcularTotales();
    }
    function calcularTotalesObj(){
      const subtotal = state.items.reduce((a,b)=> a + (Number(b.valor_total)||0), 0);
      const aplica = ivaAplica();
      const iva_pct = aplica ? Math.max(0, num($("iva_porcentaje")?.value)) : 0;
      const iva_valor = aplica ? Math.max(0, subtotal * (iva_pct / 100)) : 0;
      const descuento_pct = Math.min(100, Math.max(0, num($("descuento_pct")?.value)));
      const descuento_valor = Math.max(0, subtotal * (descuento_pct / 100));
      const copago = Math.max(0, num($("copago").value));
      const cuota = Math.max(0, num($("cuota_moderadora").value));
      const total = Math.max(0, (subtotal - descuento_valor + iva_valor) - copago - cuota);
      return { subtotal, descuento_pct, descuento_valor, iva_aplica: aplica, iva_pct, iva_valor, copago, cuota_moderadora: cuota, total };
    }
    function recalcularTotales(){
      const t = calcularTotalesObj();
      $("subtotal").textContent = money(t.subtotal);
      $("iva_valor").textContent = money(t.iva_valor);
      if ($("descuento_valor")) $("descuento_valor").textContent = money(t.descuento_valor);
      $("total").textContent = money(t.total);
    }
    function formatFechaHuman(iso){
  if (!iso) return "‚Äî";

  // ‚úÖ Caso 1: viene como DATE (YYYY-MM-DD) desde Supabase
  if (/^\d{4}-\d{2}-\d{2}$/.test(iso)){
    const [y, m, d] = iso.split("-");
    return `${d}/${m}/${y}`;
  }

  // ‚úÖ Caso 2: viene como timestamp (created_at, fecha_pago, etc.)
  try{
    const d = new Date(iso);
    if (!Number.isNaN(d.getTime())){
      return d.toLocaleDateString("es-CO", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      });
    }
  } catch (e){}

  return String(iso);
}

    function resolveProfesionalLabel(v){
      const raw = String(v ?? "").trim();
      if (!raw) return "‚Äî";
      const onlyDigits = /^[0-9]+$/.test(raw);
      if (onlyDigits){
        const pr = (state.profesionales || []).find(x => String(x.cedula ?? "").trim() === raw);
        if (pr && pr.nombre) return String(pr.nombre).trim();
      }
      return raw;
    }

    function normalizeProfesionalValue(v){
  const raw = String(v ?? "").trim();
  if (!raw) return "";
  // Si ya es c√©dula (solo n√∫meros), perfecto
  if (/^\d+$/.test(raw)) return raw;

  // Si viene como nombre, buscar su c√©dula en state.profesionales
  const pr = (state.profesionales || []).find(x =>
    String(x.nombre || "").trim().toLowerCase() === raw.toLowerCase()
  );
  if (pr && pr.cedula) return String(pr.cedula).trim();

  // fallback (si no encontr√≥ match)
  return raw;
}


    function obtenerProfesionalDeItem(it){
  // 1. Si el item ya trae profesional, usarlo
  if (it.profesional) {
    return resolveProfesionalLabel(it.profesional);
  }

  // 2. Buscar el procedimiento original cargado desde Supabase
  const p = state.procedimientos.find(
    x => String(x.id) === String(it.procedimiento_id)
  );

  if (p && p.profesional) {
    return resolveProfesionalLabel(p.profesional);
  }

  return "‚Äî";
}

    function obtenerProfesionalRawDeItem(it){
  // 1. Si el item ya trae profesional crudo
  if (it.profesional) return it.profesional;

  // 2. Buscarlo desde procedimientos_precios
  const p = state.procedimientos.find(
    x => String(x.id) === String(it.procedimiento_id)
  );

  if (p && p.profesional) return p.profesional;

  return null;
}


    function pagoLabel(pagada){
      if (pagada === true) return "Pagada";
      if (pagada === false) return "Pendiente";
      return "‚Äî";
    }
    function buildInvoiceHTML({ fac, detalle, totals, abonos }){
      const rows = (detalle || []).map(it => `
        <tr>
          <td class="mono">${escapeHtml(it.codigo_cups || "‚Äî")}</td>
          <td>${escapeHtml(it.descripcion || "")}</td>
          <td class="tr">${Number(it.cantidad||0)}</td>
          <td class="tr">$ ${money(it.valor_unitario || 0)}</td>
          <td class="tr mono">$ ${money(it.valor_total || 0)}</td>
        </tr>
      `).join("");
      const abRows = (abonos || []).map(a => `
        <tr>
          <td class="mono">${escapeHtml(formatFechaHuman(a.fecha))}</td>
          <td class="tr mono">$ ${money(a.monto || 0)}</td>
          <td>${escapeHtml(a.metodo_pago || "‚Äî")}</td>
          <td class="mono">${escapeHtml(a.referencia || "‚Äî")}</td>
        </tr>
      `).join("");
      const totalAbonado = (abonos || []).reduce((acc, a) => acc + Number(a.monto || 0), 0);
      const saldoPendiente = Math.max(0, Number(totals?.total || 0) - totalAbonado);
            // ‚úÖ Estado de pago (editable): solo PENDIENTE / PAGADA (se guarda en la misma columna booleana 'pagada')
      // La fuente de verdad es fac.pagada (bool). Si no existe, se infiere: saldoPendiente === 0 -> PAGADA, si no -> PENDIENTE.
      const pagadaBoolDB = (typeof fac?.pagada === "boolean") ? fac.pagada : null;
      const estadoFinal = (pagadaBoolDB === null)
        ? (saldoPendiente === 0 ? "PAGADA" : "PENDIENTE")
        : (pagadaBoolDB ? "PAGADA" : "PENDIENTE");
      const eps = fac?.eps ? escapeHtml(fac.eps) : "‚Äî";
      const tipo = fac?.tipo_usuario ? escapeHtml(fac.tipo_usuario) : "‚Äî";
      const profesional = escapeHtml(resolveProfesionalLabel(fac?.profesional));
      const mp = fac?.metodo_pago ? escapeHtml(fac.metodo_pago) : "‚Äî";
      const obs = fac?.observacion ? escapeHtml(fac.observacion) : "‚Äî";
      const correoPac = fac?.paciente_correo ? escapeHtml(fac.paciente_correo) : "‚Äî";
      const pagadaTxt = pagoLabel(fac?.pagada);
      const refPago = fac?.referencia_pago ? escapeHtml(fac.referencia_pago) : "‚Äî";
      return `
<!DOCTYPE html>
<html lang="es" data-factura-id="${escapeHtml(fac?.id || "")}" data-estado="${escapeHtml(estadoFinal)}" data-saldo="${String(saldoPendiente)}">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Factura ${escapeHtml(fac?.numero_factura || "")}</title>
<style>
  :root{ --line:#e5e7eb; --muted:#6b7280; --text:#111827; --brand:#1f6aa5; }
  *{ box-sizing:border-box; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  html, body{ height:100%; }
  body{ margin:0; font-family: Arial, sans-serif; color: var(--text); background:#fff; }
  @page { size: A4; margin: 10mm; }
  .page{ max-width: 210mm; margin: 0 auto; padding: 0; }
  .sheet{ background:#fff; border: 1px solid var(--line); border-radius: 12px; overflow: hidden; }
  .pad{ padding: 14px 14px; }
  .head{
    display:flex; justify-content:space-between; gap:12px; align-items:flex-start;
    border-bottom: 2px solid var(--line); padding: 14px 14px;
  }
  .brandbox{ display:flex; gap:12px; align-items:flex-start; }
  .logo{
    width: 58px; height: 58px; border-radius: 12px; border: 1px solid var(--line);
    object-fit: contain; background:#fff; padding: 6px;
  }
  .h1{ font-weight:900; font-size:16px; margin:0; letter-spacing:.2px; }
  .muted{ color: var(--muted); font-size:12px; line-height:1.35; }
  .right{ text-align:right; }
  .grid{
    display:grid;
    grid-template-columns: repeat(4, minmax(0,1fr));
    gap: 10px;
    margin-top: 10px;
  }
  .kv{ border:1px solid var(--line); border-radius: 12px; padding: 10px; min-height: 54px; }
  .kv .k{ font-size: 11.5px; color: var(--muted); font-weight: 700; }
  .kv .v{ margin-top: 4px; font-size: 12.5px; font-weight: 800; word-break: break-word; }
  table{ width:100%; border-collapse: collapse; margin-top: 12px; }
  thead th{
    background: #f9fafb; color: var(--muted); font-size: 12px; text-align:left;
    padding: 10px; border-bottom: 1px solid var(--line);
  }
  tbody td{ padding: 10px; border-bottom: 1px solid var(--line); font-size: 12.5px; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
  .tr{ text-align:right; }
  .bottom{ display:flex; gap: 12px; justify-content:space-between; align-items:flex-start; margin-top: 12px; flex-wrap: wrap; }
  .note{ flex: 1 1 320px; border: 1px solid var(--line); border-radius: 12px; padding: 10px; min-height: 72px; }
  .note .k{ font-size: 11.5px; color: var(--muted); font-weight: 700; }
  .note .v{ margin-top: 4px; font-size: 12.5px; font-weight: 800; }
  .totbox{ flex: 0 0 320px; border:1px solid var(--line); border-radius: 12px; padding: 10px; }
  .line{ display:flex; justify-content:space-between; padding: 6px 0; font-size: 13px; border-bottom: 1px dashed rgba(17,24,39,.10); }
  .line:last-child{ border-bottom:none; }
  .grand{ margin-top: 8px; padding-top: 10px; border-top: 1px solid var(--line); font-weight: 900; }
  .foot{
    padding: 10px 14px; border-top: 1px solid var(--line);
    display:flex; justify-content:space-between; gap: 10px; align-items:center;
    color: var(--muted); font-size: 11.5px;
  }
  .no-print{ display:flex; gap:10px; flex-wrap:wrap; }
  .btnp{ border:1px solid var(--line); background:#fff; padding:10px 12px; border-radius:10px; font-weight:800; cursor:pointer; }
  .btnp.primary{ background: var(--brand); border-color: var(--brand); color:#fff; }
  @media print{
    body{ background:#fff; }
    .page{ max-width: none; margin:0; }
    .sheet{ border-radius: 0; border: 1px solid var(--line); }
    .no-print{ display:none !important; }
  }
  .section-title{ font-weight:800; font-size:13px; margin: 2px 0 8px; }
  .mini-totals{ margin-top:10px; border-top:1px dashed var(--line); padding-top:10px; }
</style>
</head>
<body>
  <div class="page">
    <div class="sheet">
      <div class="head">
        <div class="brandbox">
          <img class="logo" src="${escapeHtml(LOGO_URL)}" alt="Logo"/>
          <div>
            <p class="h1">CL√çNICA ODONTOL√ìGICA ‚Äî FACTURA</p>
            <div class="muted">
              N¬∞ Factura: <b style="color:var(--text)">${escapeHtml(fac?.numero_factura || "‚Äî")}</b><br/>
              Fecha: <b style="color:var(--text)">${escapeHtml(formatFechaHuman(fac?.fecha))}</b>
            </div>
          </div>
        </div>
        <div class="muted right">
          Impreso: <b style="color:var(--text)">${new Date().toLocaleString("es-CO")}</b><br/>
          Usuario: <b style="color:var(--text)">${escapeHtml(state.session?.user?.email || "‚Äî")}</b>
        </div>
      </div>
      <div class="pad">
        <div class="grid">
          <div class="kv"><div class="k">Paciente</div><div class="v">${escapeHtml(fac?.paciente_nombre || "‚Äî")}</div></div>
          <div class="kv"><div class="k">C√©dula</div><div class="v">${escapeHtml(fac?.paciente_cedula || "‚Äî")}</div></div>
          <div class="kv"><div class="k">Correo</div><div class="v">${correoPac}</div></div>
          <div class="kv"><div class="k">Profesional</div><div class="v">${profesional}</div></div>
          <div class="kv"><div class="k">Tipo usuario</div><div class="v">${tipo}</div></div>
          <div class="kv"><div class="k">EPS</div><div class="v">${eps}</div></div>
          <div class="kv"><div class="k">M√©todo de pago</div><div class="v">${mp}</div></div>
          <div class="kv"><div class="k">Estado de pago</div><div class="v">
              <select id="estado_factura_sel" style="width:100%; border:1px solid var(--line); border-radius:10px; padding:8px 10px; font-weight:700;">
                <option value="PENDIENTE">PENDIENTE</option>
                <option value="PAGADA">PAGADA</option>
              </select>
            </div></div>
          <div class="kv" style="grid-column: span 2;"><div class="k">Referencia</div><div class="v">${refPago}</div></div>
          <div class="kv"><div class="k">¬øAplica IVA?</div><div class="v">${totals.iva_aplica ? "S√≠" : "No"}</div></div>
          <div class="kv"><div class="k">IVA %</div><div class="v">${totals.iva_aplica ? String(Number(totals.iva_pct||0)) : "0"}</div></div>
        </div>
        <table>
          <thead>
            <tr>
             
              <th style="width:140px;">CUPS</th>
              <th>Procedimiento</th>
              <th style="width:80px;text-align:right;">Cant</th>
              <th style="width:140px;text-align:right;">V/Unit</th>
              <th style="width:160px;text-align:right;">Total</th>
            </tr>
          </thead>
          <tbody>
            ${rows || `<tr><td colspan="5" class="muted" style="padding:14px;text-align:center;">Sin detalle</td></tr>`}
          </tbody>
        </table>
        <div class="bottom">
          <div class="note">
            <div class="k">Observaci√≥n</div>
            <div class="v">${obs}</div>
          </div>
          <div class="totbox">
            <div class="line"><span>Subtotal</span><b class="mono">$ ${money(totals.subtotal)}</b></div>
            <div class="line"><span>Descuento (${Number(totals.descuento_pct||0)}%)</span><b class="mono">- $ ${money(totals.descuento_valor||0)}</b></div>
            <div class="line"><span>IVA (${Number(totals.iva_pct||0)}%)</span><b class="mono">$ ${money(totals.iva_valor)}</b></div>
            <div class="line"><span>Copago</span><b class="mono">$ ${money(totals.copago)}</b></div>
            <div class="line"><span>Cuota moderadora</span><b class="mono">$ ${money(totals.cuota_moderadora)}</b></div>
            <div class="line grand"><span>TOTAL</span><b class="mono">$ ${money(totals.total)}</b></div>
          </div>
        </div>
      </div>
      <div class="pad">
        <div class="section-title">Abonos</div>
        <div class="box">
          <table class="table">
            <thead>
              <tr>
                <th style="width:110px;">Fecha</th>
                <th style="width:140px;" class="tr">Monto</th>
                <th style="width:170px;">M√©todo</th>
                <th>Referencia</th>
              </tr>
            </thead>
            <tbody>
              ${abRows || `<tr><td colspan="4" class="muted">‚Äî Sin abonos registrados ‚Äî</td></tr>`}
            </tbody>
          </table>
          <div class="mini-totals">
            <div class="line"><span>Total abonado</span><b class="mono">$ ${money(totalAbonado)}</b></div>
            <div class="line grand"><span>Saldo pendiente</span><b class="mono">$ ${money(saldoPendiente)}</b></div>
          </div>
        </div>
      </div>
      <div class="foot">
        <div>Este documento es una representaci√≥n de factura generada por el sistema.</div>
        <div class="no-print">
          <button class="btnp primary" onclick="window.print()">üñ® Imprimir</button>
          <button class="btnp" onclick="window.close()">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
<script>
(function(){
  const root = document.documentElement;
  const facturaId = root.dataset.facturaId || "";
  const estadoInicial = (root.dataset.estado || "PENDIENTE").toUpperCase();
  let saldo = Number(root.dataset.saldo || 0);
  const sel = document.getElementById("estado_factura_sel");
  if (!sel) return;
  // Inicializar
  sel.value = estadoInicial;
  const optPagada = Array.from(sel.options).find(o => o.value === "PAGADA");
  if (optPagada) optPagada.disabled = saldo > 0;
  sel.addEventListener("change", () => {
    const estado = (sel.value || "PENDIENTE").toUpperCase();
    if (estado === "PAGADA" && saldo > 0){
      alert("No puedes marcar como PAGADA si el saldo pendiente es mayor a 0.");
      sel.value = root.dataset.estado || estadoInicial;
      return;
    }
    root.dataset.estado = estado;
    window.parent.postMessage({ type: "estado_factura_change", factura_id: facturaId, estado }, "*");
  });
  // Permite que el padre actualice estado/saldo din√°micamente (por ejemplo tras agregar abonos)
  window.addEventListener("message", (e) => {
    const d = e.data || {};
    if (d.type !== "estado_factura_set") return;
    if (d.factura_id && String(d.factura_id) !== String(facturaId)) return;
    if (typeof d.saldo !== "undefined"){
      saldo = Number(d.saldo || 0);
      root.dataset.saldo = String(saldo);
      if (optPagada) optPagada.disabled = saldo > 0;
    }
    if (d.estado){
      const est = String(d.estado).toUpperCase();
      root.dataset.estado = est;
      sel.value = est;
    }
  });
})();
<\/script>
</body>
</html>`;
    }
    async function guardarFactura(){
      const fecha = ($("fecha").value || "").trim() || hoyISO();
      const paciente_cedula = ($("paciente_cedula").value || "").trim();
      const paciente_nombre = ($("paciente_nombre").value || "").trim();
      const paciente_correo = ($("paciente_correo")?.value || "").trim() || null;
      const profesional = ($("profesional").value || "").trim();
      if (!paciente_cedula || !paciente_nombre){
        toast("Paciente: c√©dula y nombre son obligatorios", "err");
        return;
      }
      if (!profesional){
        toast("Selecciona el profesional", "err");
        return;
      }
      if (state.items.length === 0){
        toast("Agrega al menos 1 procedimiento", "err");
        return;
      }
      const numero_factura = ($("numero_factura").value || "").trim() || generarNumeroFactura();
      $("numero_factura").value = numero_factura;
      const eps = ($("eps").value || "").trim() || null;
      const tipo_usuario = ($("tipo_usuario").value || "Particular").trim();
      const metodo_pago = ($("metodo_pago")?.value || "Efectivo").trim();
      const observacion = ($("observacion")?.value || "").trim() || null;
      const pagada = (String($("pagada")?.value || "si").toLowerCase() === "si");
      const referencia_pago = ($("referencia_pago")?.value || "").trim() || null;
      const fecha_pago = pagada ? new Date().toISOString() : null;
      const totals = calcularTotalesObj();
      setStatus("Guardando factura...");
      try{
        const payloadConExtras = {
          fecha,
          paciente_cedula,
          paciente_nombre,
          paciente_correo,
          tipo_usuario,
          eps,
          numero_factura,
          valor_total: totals.total,
          copago: totals.copago,
          cuota_moderadora: totals.cuota_moderadora,
          profesional,
          descuento_pct: totals.descuento_pct,
          descuento_valor: totals.descuento_valor,
          subtotal: totals.subtotal,
          iva_aplica: totals.iva_aplica,
          iva_porcentaje: totals.iva_pct,
          iva_valor: totals.iva_valor,
          metodo_pago,
          observacion,
          pagada,
          fecha_pago,
          referencia_pago,
          saldo_pendiente: pagada ? 0 : Number(totals.total || 0)
        };
        let fac = null;
        const { data: fac1, error: e1 } = await supabase
          .from("facturas")
          .insert([payloadConExtras])
          .select("*")
          .single();
        if (e1){
          const msg = String(e1.message || "").toLowerCase();
          const isColumnMissing =
            msg.includes("column") && (msg.includes("does not exist") || msg.includes("not exist"));
          if (!isColumnMissing) throw e1;
          const payloadBase = {
            fecha,
            paciente_cedula,
            paciente_nombre,
            tipo_usuario,
            eps,
            numero_factura,
            subtotal: totals.subtotal,
            descuento_pct: totals.descuento_pct,
            descuento_valor: totals.descuento_valor,
            copago: totals.copago,
            cuota_moderadora: totals.cuota_moderadora,
            valor_total: totals.total,
            saldo_pendiente: pagada ? 0 : Number(totals.total || 0),
            profesional
          };
          const { data: fac2, error: e1b } = await supabase
            .from("facturas")
            .insert([payloadBase])
            .select("*")
            .single();
          if (e1b) throw e1b;
          fac = fac2;
          fac.metodo_pago = metodo_pago;
          fac.observacion = observacion;
          fac.paciente_correo = paciente_correo;
          fac.iva_aplica = totals.iva_aplica;
          fac.iva_porcentaje = totals.iva_pct;
          fac.iva_valor = totals.iva_valor;
          fac.subtotal = totals.subtotal;
          fac.pagada = pagada;
          fac.fecha_pago = fecha_pago;
          fac.referencia_pago = referencia_pago;
        } else {
          fac = fac1;
        }
        const detalle = state.items.map(it => ({
  factura_id: fac.id,
  procedimiento_id: it.procedimiento_id, // ‚úÖ CLAVE
  codigo_cups: it.codigo_cups || null,
  descripcion: it.descripcion || "",
  cantidad: it.cantidad || 1,
  valor_unitario: it.valor_unitario || 0,
  valor_total: it.valor_total || 0,
  profesional: normalizeProfesionalValue(it.profesional || obtenerProfesionalRawDeItem(it) || null)

}));


        const { error: e2 } = await supabase
          .from("factura_detalle")
          .insert(detalle);
        if (e2) throw e2;
        state.facturaGuardada = fac;
        $("btn-imprimir").disabled = false;
        if ($("btn-abonos")) $("btn-abonos").disabled = false;
        if ($("btn-abonos")) $("btn-abonos").disabled = false;
        setStatus("");
        toast("Factura guardada ‚úÖ", "ok");
      } catch(err){
        console.error(err);
        setStatus("");
        toast("No se pudo guardar:\n" + (err?.message || "Error"), "err");
      }
    }
    async function imprimirFacturaGuardada(){
      if (!state.facturaGuardada){
        toast("Primero guarda la factura", "warn");
        return;
      }
      try{
        setStatus("Preparando impresi√≥n...");
        const { data: det, error } = await supabase
          .from("factura_detalle")
          .select("procedimiento_id, codigo_cups, descripcion, cantidad, valor_unitario, valor_total")
          .eq("factura_id", state.facturaGuardada.id)
          .order("id", { ascending: true });
        if (error) throw error;
        // 2) Abonos (si existe tabla)
        let abonos = [];
        try{
          const { data: ab, error: ea } = await supabase
            .from("abonos")
            .select("id, fecha, monto, metodo_pago, referencia, observacion, created_at")
            .eq("factura_id", state.facturaGuardada.id)
            .order("fecha", { ascending: true });
          if (!ea) abonos = ab || [];
          else console.warn("Tabla abonos no disponible:", ea?.message || ea);
        }catch(e){
          console.warn("No se pudieron cargar abonos:", e?.message || e);
        }
        const totals = calcularTotalesObj();
        state.facturaGuardada.metodo_pago = ($("metodo_pago")?.value || "Efectivo").trim();
        state.facturaGuardada.observacion = ($("observacion")?.value || "").trim() || null;
        state.facturaGuardada.paciente_correo = ($("paciente_correo")?.value || "").trim() || null;
        state.facturaGuardada.pagada = (String($("pagada")?.value || "si").toLowerCase() === "si");
        state.facturaGuardada.referencia_pago = ($("referencia_pago")?.value || "").trim() || null;
        const html = buildInvoiceHTML({
          fac: state.facturaGuardada,
          detalle: det || [],
          totals,
          abonos
        });
        const w = window.open("", "_blank", "width=900,height=700");
        if (!w){
          setStatus("");
          toast("Bloqueo de popups: habilita ventanas emergentes para imprimir.", "warn");
          return;
        }
        w.document.open();
        w.document.write(html);
        w.document.close();
        w.onload = () => {
          try { w.focus(); w.print(); } catch(e) {}
        };
        setStatus("");
      } catch(err){
        console.error(err);
        setStatus("");
        toast("No se pudo imprimir:\n" + (err?.message || "Error"), "err");
      }
    }
    function openModal(){
      $("modal-facturas").classList.add("show");
      $("modal-facturas").setAttribute("aria-hidden", "false");
    }
    function closeModal(){
      $("modal-facturas").classList.remove("show");
      $("modal-facturas").setAttribute("aria-hidden", "true");
    }
    function openModalVerFactura(){
      $("modal-verfactura").classList.add("show");
      $("modal-verfactura").setAttribute("aria-hidden", "false");
    }
    function closeModalVerFactura(){
      $("modal-verfactura").classList.remove("show");
      $("modal-verfactura").setAttribute("aria-hidden", "true");
    }
    function renderVerFacturaDetalle(rows){
      const tbody = $("tbody-vf-detalle");
      tbody.innerHTML = "";
      if (!rows || rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="5" class="empty">No hay detalle para esta factura.</td></tr>`;
        return;
      }
      for (const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${escapeHtml(r.codigo_cups || "‚Äî")}</td>
          <td>${escapeHtml(r.descripcion || "‚Äî")}</td>
          <td class="mono">${escapeHtml(String(r.cantidad ?? 0))}</td>
          <td class="mono">$ ${escapeHtml(moneyNumber(r.valor_unitario ?? 0))}</td>
          <td class="mono">$ ${escapeHtml(moneyNumber(r.valor_total ?? 0))}</td>
        `;
        tbody.appendChild(tr);
      }
    }
    function renderVerFacturaAbonos(rows){
      const tbody = $("tbody-vf-abonos");
      tbody.innerHTML = "";
      if (!rows || rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="5" class="empty">A√∫n no hay abonos para esta factura.</td></tr>`;
        return;
      }
      for (const a of rows){
        const tr = document.createElement("tr");
        const fecha = formatFechaHuman(a.fecha || a.created_at);
        tr.innerHTML = `
          <td class="mono">${escapeHtml(fecha)}</td>
          <td class="mono">$ ${escapeHtml(moneyNumber(a.monto || 0))}</td>
          <td>${escapeHtml(a.metodo_pago || "‚Äî")}</td>
          <td class="mono">${escapeHtml(a.referencia || "‚Äî")}</td>
          <td>${escapeHtml(a.observacion || "‚Äî")}</td>
        `;
        tbody.appendChild(tr);
      }
    }
    // Helper para imprimir montos sin el "$ " duplicado en tablas
    function moneyNumber(n){
      // money() ya existe y devuelve formato con separador; aqu√≠ lo reutilizamos y quitamos el "$ " si aplica
      const s = money(n);
      return String(s).replace(/^\$\s*/,"");
    }
    async function abrirVerFactura(facturaId){
      try{
        state.facturaVer = facturaId;
        setStatus("Cargando factura...");
        // 1) Cabecera factura
        const { data: f, error: ef } = await supabase
          .from("facturas")
          .select("*")
          .eq("id", facturaId)
          .single();
        if (ef) throw ef;
        // 2) Detalle
        const { data: det, error: ed } = await supabase
          .from("factura_detalle")
          .select("procedimiento_id, codigo_cups, descripcion, cantidad, valor_unitario, valor_total")
          .eq("factura_id", facturaId);
        if (ed) throw ed;
        // 3) Abonos
        const { data: ab, error: ea } = await supabase
          .from("abonos")
          .select("id, fecha, monto, metodo_pago, referencia, observacion, created_at")
          .eq("factura_id", facturaId)
          .order("fecha", { ascending: true });
        // Si la tabla no existe, mostramos igual la factura y dejamos abonos vac√≠os
        if (ea){
          console.warn("Tabla abonos no disponible:", ea?.message || ea);
        }
        // Renderizar factura con el mismo formato de impresi√≥n (incluye abonos y saldo)
        const subtotal = Number(f.subtotal ?? 0);
        const iva_valor = Number(f.iva_valor ?? f.iva ?? 0);
        const aplicaRaw = (f.iva_aplica ?? f.aplica_iva ?? f.aplicaIVA ?? "S√≠");
        const iva_aplica = (typeof aplicaRaw === "boolean")
          ? aplicaRaw
          : String(aplicaRaw).toLowerCase().startsWith("s");
        const iva_pct = Number(f.iva_pct ?? f.iva_porcentaje ?? 0) || (iva_aplica ? 19 : 0);
        const copago = Number(f.copago ?? 0);
        const cuota = Number(f.cuota_moderadora ?? 0);
        const total = (f.valor_total !== undefined && f.valor_total !== null)
          ? Number(f.valor_total || 0)
          : (f.total !== undefined && f.total !== null)
            ? Number(f.total || 0)
            : Math.max(0, (subtotal + iva_valor) - copago - cuota);
        const htmlDoc = buildInvoiceHTML({
          fac: f,
          detalle: det || [],
          totals: {
            subtotal,
            descuento_pct: Number(f.descuento_pct||0),
            descuento_valor: Number(f.descuento_valor||0),
            iva_aplica,
            iva_pct,
            iva_valor,
            copago,
            cuota_moderadora: cuota,
            total
          },
          abonos: (ab || [])
        });
        const frame = $("vf_iframe");
        if (frame) frame.srcdoc = htmlDoc;
        openModalVerFactura();
        setStatus("");
      } catch(err){
        console.error(err);
        setStatus("");
        toast("No se pudo abrir la factura:\n" + (err?.message || "Error"), "err");
      }
    }
    // ‚úÖ Estado de factura (solo PENDIENTE / PAGADA)
    async function setEstadoFactura({ facturaId, estado, saldoPendiente = null, silent = false }){
      if (!facturaId) return;
      const est = String(estado || "PENDIENTE").toUpperCase();
      const pagadaBool = (est === "PAGADA");
      // Validaci√≥n: no permitir PAGADA si saldo > 0
      if (pagadaBool && saldoPendiente !== null && Number(saldoPendiente) > 0){
        if (!silent) toast("No puedes marcar como PAGADA si el saldo pendiente es mayor a 0.", "warn");
        return;
      }
      try{
        // Intentamos guardar en columna opcional estado_pago si existe, y tambi√©n el boolean pagada.
        let { error } = await supabase
          .from("facturas")
          .update((() => { const u = { pagada: pagadaBool, estado_pago: est }; if (pagadaBool) u.saldo_pendiente = 0; else if (saldoPendiente !== null) u.saldo_pendiente = Number(saldoPendiente); return u; })())
          .eq("id", facturaId);
        // Si la columna estado_pago no existe, reintentamos solo con pagada.
        if (error){
          const msg = String(error.message || "").toLowerCase();
          const missingCol = msg.includes("column") && msg.includes("estado_pago");
          if (missingCol){
            const r2 = await supabase
              .from("facturas")
              .update((() => { const u = { pagada: pagadaBool }; if (pagadaBool) u.saldo_pendiente = 0; else if (saldoPendiente !== null) u.saldo_pendiente = Number(saldoPendiente); return u; })())
              .eq("id", facturaId);
            error = r2.error;
          }
        }
        if (error) throw error;
        // Si est√° abierta la vista de factura, sincronizamos el select dentro del iframe
        if (state.facturaVer && String(state.facturaVer) === String(facturaId)){
          const frame = $("vf_iframe");
          if (frame && frame.contentWindow){
            frame.contentWindow.postMessage({ type: "estado_factura_set", factura_id: facturaId, estado: est, saldo: saldoPendiente }, "*");
          }
        }
        // Refrescar listado si est√° abierto (para ver cambios de "Pagada"/"Pendiente" en la tabla)
        // Nota: en la tabla principal solo existe pagada (bool) en el dataset actual.
        if (typeof renderFacturasModal === "function"){
          // no-op: renderFacturasModal se llama desde cargarFacturas()
        }
      } catch(err){
        console.error(err);
        if (!silent) toast("No se pudo actualizar el estado:\n" + (err?.message || "Error"), "err");
      }
    }
    // Escuchar cambios de estado desde el iframe de "Ver factura"
    window.addEventListener("message", async (e) => {
      const d = e.data || {};
      if (d.type !== "estado_factura_change") return;
      const facturaId = d.factura_id;
      const estado = d.estado;
      // Para validar saldo, tomamos el que venga del iframe si est√° disponible en el DOM del iframe
      let saldo = null;
      try{
        const frame = $("vf_iframe");
        if (frame && frame.contentDocument){
          const ds = frame.contentDocument.documentElement?.dataset?.saldo;
          if (ds !== undefined) saldo = Number(ds);
        }
      } catch(_){}
      await setEstadoFactura({ facturaId, estado, saldoPendiente: saldo });
    });
    /* ‚úÖ SUPABASE (Recomendado): crear tabla 'abonos'
      - id (bigint, identity) PK
      - factura_id (bigint) FK -> facturas.id (ON DELETE CASCADE)
      - fecha (date) NOT NULL
      - monto (numeric) NOT NULL
      - metodo_pago (text) NULL
      - referencia (text) NULL
      - observacion (text) NULL
      - created_at (timestamptz) default now()
    */
    function openModalAbonos(){
      $("modal-abonos").classList.add("show");
      $("modal-abonos").setAttribute("aria-hidden", "false");
    }
    function closeModalAbonos(){
      $("modal-abonos").classList.remove("show");
      $("modal-abonos").setAttribute("aria-hidden", "true");
    }
    function updateResumenAbonos({ totalFactura = 0, totalAbonado = 0 }){
      $("abonos_total_factura").textContent = money(totalFactura);
      $("abonos_total_abonado").textContent = money(totalAbonado);
      const saldo = Math.max(0, Number(totalFactura || 0) - Number(totalAbonado || 0));
      $("abonos_saldo").textContent = money(saldo);
    }
    async function abrirAbonosFactura(facturaId){
      state.facturaAbonos = facturaId;
      // Defaults en UI
      if ($("abono_fecha")) $("abono_fecha").value = hoyISO();
      if ($("abono_monto")) $("abono_monto").value = "";
      if ($("abono_metodo")) $("abono_metodo").value = "Efectivo";
      if ($("abono_referencia")) $("abono_referencia").value = "";
      if ($("abono_observacion")) $("abono_observacion").value = "";
      openModalAbonos();
      await listarAbonos();
    }
    function renderAbonosTabla(rows){
      const tbody = $("tbody-abonos");
      tbody.innerHTML = "";
      if (!rows || rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="7" class="empty">A√∫n no hay abonos para esta factura.</td></tr>`;
        return;
      }
      for (const a of rows){
        const tr = document.createElement("tr");
        const fecha = formatFechaHuman(a.fecha || a.created_at);
        const monto = money(a.monto || 0);
        const metodo = a.metodo_pago || "‚Äî";
        const ref = a.referencia || "‚Äî";
        const obs = a.observacion || "‚Äî";
        tr.innerHTML = `
          <td class="mono">${escapeHtml(fecha)}</td>
          <td class="mono">$ ${escapeHtml(monto)}</td>
          <td class="mono">${escapeHtml(metodo)}</td>
          <td class="mono">${escapeHtml(ref)}</td>
          <td>${escapeHtml(obs)}</td>
          <td style="white-space:nowrap;">
            <button class="btn danger small" data-act="del">Eliminar</button>
          </td>
        `;
        tr.querySelector('[data-act="del"]').addEventListener("click", async () => {
          const ok = window.confirm("¬øEliminar este abono?");
          if (!ok) return;
          await eliminarAbono(a.id);
        });
        tbody.appendChild(tr);
      }
    }
    async function listarAbonos(){
      const facturaId = state.facturaAbonos;
      if (!facturaId){
        renderAbonosTabla([]);
        updateResumenAbonos({ totalFactura: 0, totalAbonado: 0 });
        return;
      }
      try{
        setStatus("Cargando abonos...");
        const { data: fac, error: ef } = await supabase
          .from("facturas")
          .select("id, valor_total")
          .eq("id", facturaId)
          .single();
        if (ef) throw ef;
        const { data, error } = await supabase
          .from("abonos")
          .select("id, factura_id, fecha, monto, metodo_pago, referencia, observacion, created_at")
          .eq("factura_id", facturaId)
          .order("fecha", { ascending: true });
        if (error){
          const msg = String(error.message || "").toLowerCase();
          const missingTable =
            msg.includes("relation") && msg.includes("does not exist");
          setStatus("");
          if (missingTable){
            toast("Falta la tabla 'abonos' en Supabase.\nCrea la tabla para usar abonos.", "warn");
            $("tbody-abonos").innerHTML = `<tr><td colspan="7" class="empty">Falta la tabla 'abonos' en Supabase.</td></tr>`;
            updateResumenAbonos({ totalFactura: Number(fac?.valor_total || 0), totalAbonado: 0 });
            return;
          }
          throw error;
        }
        state.abonos = data || [];
        renderAbonosTabla(state.abonos);
        const totalAbonado = (state.abonos || []).reduce((acc, x) => acc + (Number(x.monto) || 0), 0);
        updateResumenAbonos({ totalFactura: Number(fac?.valor_total || 0), totalAbonado });
        // ‚úÖ Auto-actualizar estado: si saldo llega a 0 -> PAGADA. Si no, PENDIENTE.
        const totalFacturaNum = Number(fac?.valor_total || 0);
        const saldoPendiente = Math.max(0, totalFacturaNum - Number(totalAbonado || 0));
        const estadoAuto = (saldoPendiente === 0) ? "PAGADA" : "PENDIENTE";
        await setEstadoFactura({ facturaId, estado: estadoAuto, saldoPendiente, silent: true });
        setStatus("");
      } catch(err){
        console.error(err);
        setStatus("");
        toast("No se pudieron cargar abonos:\n" + (err?.message || "Error"), "err");
        renderAbonosTabla([]);
      }
    }
    async function agregarAbono(){
      const facturaId = state.facturaAbonos;
      if (!facturaId){
        toast("Primero selecciona una factura.", "warn");
        return;
      }
      const fecha = ($("abono_fecha")?.value || "").trim() || hoyISO();
      const monto = Math.max(0, num($("abono_monto")?.value));
      const metodo_pago = ($("abono_metodo")?.value || "Efectivo").trim();
      const referencia = ($("abono_referencia")?.value || "").trim() || null;
      const observacion = ($("abono_observacion")?.value || "").trim() || null;
      if (!monto || monto <= 0){
        toast("El monto del abono debe ser mayor a 0.", "warn");
        return;
      }
      setStatus("Guardando abono...");
      try{
        const payload = {
          factura_id: facturaId,
          fecha,
          monto,
          metodo_pago,
          referencia,
          observacion
        };
        const { error } = await supabase
          .from("abonos")
          .insert([payload]);
        if (error){
          const msg = String(error.message || "").toLowerCase();
          const missingTable =
            msg.includes("relation") && msg.includes("does not exist");
          setStatus("");
          if (missingTable){
            toast("Falta la tabla 'abonos' en Supabase.\nCrea la tabla para usar abonos.", "warn");
            return;
          }
          throw error;
        }
        setStatus("");
        toast("Abono guardado ‚úÖ", "ok");
        if ($("abono_monto")) $("abono_monto").value = "";
        if ($("abono_referencia")) $("abono_referencia").value = "";
        if ($("abono_observacion")) $("abono_observacion").value = "";
        await listarAbonos();
      } catch(err){
        console.error(err);
        setStatus("");
        toast("No se pudo guardar abono:\n" + (err?.message || "Error"), "err");
      }
    }
    async function eliminarAbono(abonoId){
      if (!abonoId) return;
      try{
        setStatus("Eliminando abono...");
        const { error } = await supabase
          .from("abonos")
          .delete()
          .eq("id", abonoId);
        if (error) throw error;
        setStatus("");
        toast("Abono eliminado ‚úÖ", "ok");
        await listarAbonos();
      } catch(err){
        console.error(err);
        setStatus("");
        toast("No se pudo eliminar abono:\n" + (err?.message || "Error"), "err");
      }
    }
    function updateResumenFacturas(rows){
      const total = (rows || []).reduce((acc, f) => acc + (Number(f.valor_total) || 0), 0);
      $("total_facturado").textContent = money(total);
      $("count_facturas").textContent = String((rows || []).length);
    }
    // ‚úÖ CORREGIDO COMPLETO:
    // - Columna "Pago" = ESTADO
    // - Bot√≥n = ACCI√ìN
    // - Si m√©todo != Efectivo, pide referencia + fecha pago al marcar Pagada
    async function togglePagadaFactura(f){
      try{
        const actual = (f.pagada === true);
        const nuevo = !actual;
        let metodo = (f.metodo_pago || "").toString().trim();
        // Si no vino en listado, intentamos leerlo
        if (!metodo){
          const { data: facDB, error: e0 } = await supabase
            .from("facturas")
            .select("id, metodo_pago, referencia_pago")
            .eq("id", f.id)
            .single();
          if (!e0){
            metodo = (facDB?.metodo_pago || "").toString().trim();
            if (!f.referencia_pago && facDB?.referencia_pago) f.referencia_pago = facDB.referencia_pago;
          }
        }

        // ‚úÖ Calcular saldo pendiente (si existe la tabla de abonos). Si no existe, lo dejamos como null.
        const totalFacturaNum = Number(f.valor_total || 0);
        let saldoPendienteCalc = null;
        try{
          const { data: abs, error: eab } = await supabase
            .from("abonos")
            .select("monto")
            .eq("factura_id", f.id);
          if (eab){
            const msg = String(eab.message || "").toLowerCase();
            const missingTable = msg.includes("relation") && msg.includes("does not exist");
            if (!missingTable) throw eab;
          } else {
            const totalAb = (abs || []).reduce((acc, x) => acc + (Number(x.monto) || 0), 0);
            saldoPendienteCalc = Math.max(0, totalFacturaNum - totalAb);
          }
        } catch(errAb){
          // Si falla por otra raz√≥n, no bloqueamos el flujo; solo no calculamos saldo.
          console.warn("No se pudo calcular saldo pendiente desde abonos:", errAb);
        }
        // Si intentan marcar PAGADA pero hay saldo pendiente calculado, no permitirlo.
        if (nuevo === true && saldoPendienteCalc !== null && Number(saldoPendienteCalc) > 0){
          toast("No puedes marcar como PAGADA si el saldo pendiente es mayor a 0.", "warn");
          setStatus("");
          return;
        }
        const saldoPendienteToSave = (nuevo === true) ? 0 : (saldoPendienteCalc !== null ? Number(saldoPendienteCalc) : totalFacturaNum);
        let referencia = null;
        let fechaPagoYYYYMMDD = null;
        if (nuevo === true){
          const isEfectivo = metodo.toLowerCase() === "efectivo";
          if (!isEfectivo){
            referencia = window.prompt("Ingresa la referencia / comprobante de pago:", f.referencia_pago || "");
            if (referencia === null) return;
            referencia = referencia.trim();
            if (!referencia){
              toast("La referencia de pago es obligatoria para este m√©todo.", "warn");
              return;
            }
            const fp = window.prompt("Ingresa la fecha de pago (YYYY-MM-DD):", hoyISO());
            if (fp === null) return;
            fechaPagoYYYYMMDD = parseDateYYYYMMDD(fp);
            if (!fechaPagoYYYYMMDD){
              toast("Fecha inv√°lida. Usa formato YYYY-MM-DD.", "warn");
              return;
            }
          } else {
            fechaPagoYYYYMMDD = hoyISO();
            referencia = null; // efectivo: opcional
          }
        }
        setStatus("Actualizando pago...");
        const payload = {
          pagada: nuevo,
          saldo_pendiente: saldoPendienteToSave,
          fecha_pago: nuevo ? toISODateTimeFromYYYYMMDD(fechaPagoYYYYMMDD || hoyISO()) : null,
          referencia_pago: nuevo ? (referencia || null) : null
        };
        const { error } = await supabase
          .from("facturas")
          .update(payload)
          .eq("id", f.id);
        if (error){
          const msg = String(error.message || "").toLowerCase();
          const isColumnMissing =
            msg.includes("column") && (msg.includes("does not exist") || msg.includes("not exist"));
          setStatus("");
          if (isColumnMissing){
            toast("En Supabase faltan columnas: pagada / saldo_pendiente / fecha_pago / referencia_pago en 'facturas'.", "warn");
            return;
          }
          throw error;
        }
        setStatus("");
        toast(nuevo ? "Marcada como Pagada ‚úÖ" : "Marcada como Pendiente ‚ö†Ô∏è", "ok");
        await listarFacturas();
      } catch(err){
        console.error(err);
        setStatus("");
        toast("No se pudo actualizar pago:\n" + (err?.message || "Error"), "err");
      }
    }
    function renderFacturasTabla(rows){
      const tbody = $("tbody-facturas");
      tbody.innerHTML = "";
      if (!rows || rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="8" class="empty">No hay facturas para mostrar.</td></tr>`;
        updateResumenFacturas([]);
        return;
      }
      for (const f of rows){
        const tr = document.createElement("tr");
        const fecha = formatFechaHuman(f.fecha);
        const numf = f.numero_factura || "‚Äî";
        const nom = f.paciente_nombre || "‚Äî";
        const ced = f.paciente_cedula || "‚Äî";
        const total = money(f.valor_total || 0);
        const saldoPendRaw = (f.saldo_pendiente != null) ? Number(f.saldo_pendiente) : null;
        const saldoPendCalc = (saldoPendRaw == null) ? ((f.pagada === true) ? 0 : Number(f.valor_total || 0)) : saldoPendRaw;
        const saldoPend = money(saldoPendCalc || 0);
        const estadoPago = pagoLabel(f.pagada);
        const btnAccionPagoText = (f.pagada === true) ? "‚Üò Marcar pendiente" : "‚úÖ Marcar pagada";
        tr.innerHTML = `
          <td class="mono">${escapeHtml(fecha)}</td>
          <td class="mono">${escapeHtml(numf)}</td>
          <td>${escapeHtml(nom)}</td>
          <td class="mono">${escapeHtml(ced)}</td>
          <td class="mono">${escapeHtml(estadoPago)}</td>
          <td class="mono">$ ${escapeHtml(total)}</td>
          <td class="mono">$ ${escapeHtml(saldoPend)}</td>
          <td style="white-space:nowrap;">
            <button class="btn small" data-act="cargar">‚Ü© Cargar</button>
            <button class="btn small primary" data-act="imprimir">üñ® Imprimir</button>
            <button class="btn small" data-act="toggle">${escapeHtml(btnAccionPagoText)}</button>
            <button class="btn small" data-act="verfactura">üëÅ Ver factura</button>
            <button class="btn small" data-act="abonos">üí∞ Abonos</button>
          </td>
        `;
        tr.querySelector('[data-act="cargar"]').addEventListener("click", async () => {
          await cargarFacturaEnFormulario(f.id);
          closeModal();
        });
        tr.querySelector('[data-act="imprimir"]').addEventListener("click", async () => {
          await imprimirFacturaPorId(f.id);
        });
        tr.querySelector('[data-act="toggle"]').addEventListener("click", async () => {
          await togglePagadaFactura(f);
        });
                tr.querySelector('[data-act="verfactura"]').addEventListener("click", async () => {
          await abrirVerFactura(f.id);
        });
tr.querySelector('[data-act="abonos"]').addEventListener("click", async () => {
          await abrirAbonosFactura(f.id);
        });
        tbody.appendChild(tr);
      }
      updateResumenFacturas(rows);
    }
    function dateStartISO(d){ return d ? `${d}T00:00:00.000` : null; }
    function dateEndISO(d){ return d ? `${d}T23:59:59.999` : null; }
    async function listarFacturas(){
      const limit = parseInt($("limite_facturas").value || "50", 10) || 50;
      const q = ($("buscar_facturas").value || "").trim();
      const desde = ($("fecha_desde")?.value || "").trim();
      const hasta = ($("fecha_hasta")?.value || "").trim();
      const estado = ($("estado_facturas")?.value || "todos").trim();
      try{
        $("tbody-facturas").innerHTML = `<tr><td colspan="8" class="empty">Cargando...</td></tr>`;
        let query = supabase
          .from("facturas")
          .select("id, fecha, numero_factura, paciente_nombre, paciente_cedula, paciente_correo, valor_total, copago, cuota_moderadora, tipo_usuario, eps, profesional, metodo_pago, observacion, iva_aplica, iva_porcentaje, iva_valor, subtotal, pagada, saldo_pendiente, fecha_pago, referencia_pago")
          .order("fecha", { ascending: false })
          .limit(limit);
        if (desde){
          query = query.gte("fecha", dateStartISO(desde));
        }
        if (hasta){
          query = query.lte("fecha", dateEndISO(hasta));
        }
        if (estado === "pagada"){
          query = query.eq("pagada", true);
        } else if (estado === "pendiente"){
          // Incluye false y null (por compatibilidad con registros antiguos)
          query = query.or("pagada.eq.false,pagada.is.null");
        }
        if (q){
          const isNum = /^[0-9]+$/.test(q);
          if (isNum){
            query = query.ilike("paciente_cedula", `%${q}%`);
          } else {
            query = query.ilike("numero_factura", `%${q}%`);
          }
        }
        const { data, error } = await query;
        if (error) throw error;
        state.facturas = data || [];
        renderFacturasTabla(state.facturas);
      } catch(err){
        console.error(err);
        renderFacturasTabla([]);
        toast("No se pudieron cargar facturas:\n" + (err?.message || "Error"), "err");
      }
    }
    async function cargarFacturaEnFormulario(facturaId){
      try{
        setStatus("Cargando factura...");
        const { data: fac, error: e1 } = await supabase
          .from("facturas")
          .select("*")
          .eq("id", facturaId)
          .single();
        if (e1) throw e1;
        const { data: det, error: e2 } = await supabase
          .from("factura_detalle")
          .select("procedimiento_id, codigo_cups, descripcion, cantidad, valor_unitario, valor_total, profesional")
          .eq("factura_id", facturaId)
          .order("id", { ascending: true });
        if (e2) throw e2;
        $("fecha").value = (fac.fecha && String(fac.fecha).includes("T")) ? String(fac.fecha).slice(0,10) : (fac.fecha || hoyISO());
        $("numero_factura").value = fac.numero_factura || "";
        $("tipo_usuario").value = fac.tipo_usuario || "Particular";
        $("eps").value = fac.eps || "";
        $("paciente_cedula").value = fac.paciente_cedula || "";
        $("paciente_nombre").value = fac.paciente_nombre || "";
        $("profesional").value = fac.profesional || "";
        if ($("paciente_correo")) $("paciente_correo").value = fac.paciente_correo || "";
        if ($("metodo_pago") && fac.metodo_pago) $("metodo_pago").value = fac.metodo_pago;
        if ($("observacion")) $("observacion").value = fac.observacion || "";
        if ($("pagada")){
          $("pagada").value = (fac.pagada === false) ? "no" : "si";
        }
        if ($("referencia_pago")){
          $("referencia_pago").value = fac.referencia_pago || "";
        }
        if ($("iva_aplica")){
          if (fac.iva_aplica === true) $("iva_aplica").value = "si";
          if (fac.iva_aplica === false) $("iva_aplica").value = "no";
        }
        if ($("iva_porcentaje")){
          const ivaPctDB = fac.iva_porcentaje ?? fac.iva_pct ?? null;
          if (ivaPctDB !== null && ivaPctDB !== undefined && String(ivaPctDB).trim() !== ""){
            $("iva_porcentaje").value = Number(ivaPctDB) || 0;
          }
        }
        state.items = (det || []).map(it => ({
  id_local: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
  procedimiento_id: it.procedimiento_id,
  codigo_cups: it.codigo_cups || "",
  descripcion: it.descripcion || "",
  cantidad: Number(it.cantidad || 1),
  valor_unitario: Number(it.valor_unitario || 0),
  valor_total: Number(it.valor_total || 0),

  // ‚úÖ CLAVE: rehidratar profesional por procedimiento
  profesional: (it.profesional || "").toString().trim()
}));

        $("copago").value = Number(fac.copago || 0);
        $("cuota_moderadora").value = Number(fac.cuota_moderadora || 0);
        state.facturaGuardada = fac;
        $("btn-imprimir").disabled = false;
        renderItems();
        syncIVAUI();
        setStatus("");
        toast("Factura cargada ‚úÖ", "ok");
      } catch(err){
        console.error(err);
        setStatus("");
        toast("No se pudo cargar:\n" + (err?.message || "Error"), "err");
      }
    }
    async function imprimirFacturaPorId(facturaId){
      try{
        setStatus("Preparando impresi√≥n...");
        const { data: fac, error: e1 } = await supabase
          .from("facturas")
          .select("*")
          .eq("id", facturaId)
          .single();
        if (e1) throw e1;
        const { data: det, error: e2 } = await supabase
          .from("factura_detalle")
          .select("procedimiento_id, codigo_cups, descripcion, cantidad, valor_unitario, valor_total")
          .eq("factura_id", facturaId)
          .order("id", { ascending: true });
        if (e2) throw e2;
        // Abonos (si existe tabla)
        let abonos = [];
        try{
          const { data: ab, error: ea } = await supabase
            .from("abonos")
            .select("id, fecha, monto, metodo_pago, referencia, observacion, created_at")
            .eq("factura_id", facturaId)
            .order("fecha", { ascending: true });
          if (!ea) abonos = ab || [];
          else console.warn("Tabla abonos no disponible:", ea?.message || ea);
        }catch(e){
          console.warn("No se pudieron cargar abonos:", e?.message || e);
        }
        const subtotal = (fac.subtotal !== undefined && fac.subtotal !== null)
          ? Number(fac.subtotal || 0)
          : (det || []).reduce((a,b)=> a + (Number(b.valor_total)||0), 0);
        const aplica = (fac.iva_aplica === true);
        const iva_pct = (fac.iva_porcentaje !== undefined && fac.iva_porcentaje !== null)
          ? Number(fac.iva_porcentaje || 0)
          : ((fac.iva_pct !== undefined && fac.iva_pct !== null) ? Number(fac.iva_pct || 0) : 0);
        const iva_valor = (fac.iva_valor !== undefined && fac.iva_valor !== null)
          ? Number(fac.iva_valor || 0)
          : (aplica ? Math.max(0, subtotal * (Math.max(0, iva_pct) / 100)) : 0);
        const copago = Number(fac.copago || 0);
        const cuota = Number(fac.cuota_moderadora || 0);
        const total = (fac.valor_total !== undefined && fac.valor_total !== null)
          ? Number(fac.valor_total || 0)
          : Math.max(0, (subtotal + iva_valor) - copago - cuota);
        const html = buildInvoiceHTML({
          fac,
          detalle: det || [],
          totals: { subtotal, iva_aplica: aplica, iva_pct: (aplica ? iva_pct : 0), iva_valor, copago, cuota_moderadora: cuota, total },
          abonos
        });
        const w = window.open("", "_blank", "width=900,height=700");
        if (!w){
          setStatus("");
          toast("Bloqueo de popups: habilita ventanas emergentes para imprimir.", "warn");
          return;
        }
        w.document.open();
        w.document.write(html);
        w.document.close();
        w.onload = () => {
          try { w.focus(); w.print(); } catch(e) {}
        };
        setStatus("");
      } catch(err){
        console.error(err);
        setStatus("");
        toast("No se pudo imprimir:\n" + (err?.message || "Error"), "err");
      }
    }
    function exportarExcel(){
      try{
        const rows = state.facturas || [];
        if (!rows.length){
          toast("No hay facturas para exportar con ese filtro.", "warn");
          return;
        }
        const desde = ($("fecha_desde")?.value || "").trim();
        const hasta = ($("fecha_hasta")?.value || "").trim();
      const estado = ($("estado_facturas")?.value || "todos").trim();
        const q = ($("buscar_facturas")?.value || "").trim();
        const data = rows.map(f => ({
          "Fecha": formatFechaHuman(f.fecha),
          "N¬∞ Factura": f.numero_factura || "",
          "Paciente": f.paciente_nombre || "",
          "C√©dula": f.paciente_cedula || "",
          "Correo": f.paciente_correo || "",
          "Tipo usuario": f.tipo_usuario || "",
          "EPS": f.eps || "",
          "Profesional (valor guardado)": f.profesional || "",
          "Pagada": (f.pagada === true) ? "S√≠" : (f.pagada === false ? "No" : ""),
          "Referencia pago": f.referencia_pago || "",
          "Total": Number(f.valor_total || 0),
          "Copago": Number(f.copago || 0),
          "Cuota moderadora": Number(f.cuota_moderadora || 0),
        }));
        const totalFacturado = rows.reduce((acc, f) => acc + (Number(f.valor_total) || 0), 0);
        const ws = XLSX.utils.json_to_sheet(data);
        const lastRow = data.length + 2;
        XLSX.utils.sheet_add_aoa(ws, [
          [],
          ["TOTAL FACTURADO", totalFacturado]
        ], { origin: `A${lastRow}` });
        const ws2 = XLSX.utils.aoa_to_sheet([
          ["Reporte de Facturas"],
          ["Generado:", new Date().toLocaleString("es-CO")],
          ["Filtro b√∫squeda (N¬∞ factura o c√©dula):", q || "(vac√≠o)"],
          ["Fecha desde:", desde || "(vac√≠o)"],
          ["Fecha hasta:", hasta || "(vac√≠o)"],
          ["Cantidad:", rows.length],
          ["Total facturado:", totalFacturado]
        ]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Facturas");
        XLSX.utils.book_append_sheet(wb, ws2, "Filtros");
        const slugDesde = desde || "NA";
        const slugHasta = hasta || "NA";
        const filename = `reporte_facturas_${slugDesde}_a_${slugHasta}.xlsx`;
        XLSX.writeFile(wb, filename);
        toast("Excel descargado ‚úÖ", "ok");
      } catch(err){
        console.error(err);
        toast("No se pudo exportar Excel:\n" + (err?.message || "Error"), "err");
      }
    }
    async function init(){
      try{
        $("year").textContent = new Date().getFullYear();
        $("fecha").value = hoyISO();
        if ($("abono_fecha")) $("abono_fecha").value = hoyISO();
        $("numero_factura").value = generarNumeroFactura();
        if ($("pagada")) $("pagada").value = "si";
        if ($("referencia_pago")) $("referencia_pago").value = "";
        $("btn-back").addEventListener("click", ()=> window.location.href = INDEX_URL);
        $("btn-buscar").addEventListener("click", ()=> buscarPacienteEnHistoria(true));
        $("btn-add").addEventListener("click", agregarProcedimiento);
        if ($("sel-proc-input")){
          $("sel-proc-input").addEventListener("input", (e) => {
            renderProcedimientosSelect(e.target.value || "");
          });
          $("sel-proc-input").addEventListener("focus", (e) => {
            renderProcedimientosSelect(e.target.value || "");
          });
          document.addEventListener("click", (ev) => {
            if (!ev.target.closest("#proc-dropdown") && !ev.target.closest("#sel-proc-input")){
              const d = $("proc-dropdown");
              if (d) d.style.display = "none";
            }
          });
        }
        $("copago").addEventListener("input", recalcularTotales);
        $("cuota_moderadora").addEventListener("input", recalcularTotales);
        if ($("descuento_pct")) $("descuento_pct").addEventListener("input", recalcularTotales);
        $("iva_porcentaje").addEventListener("input", recalcularTotales);
        $("iva_aplica").addEventListener("change", syncIVAUI);
        $("btn-guardar").addEventListener("click", guardarFactura);
        $("btn-imprimir").addEventListener("click", imprimirFacturaGuardada);
        if ($("btn-abonos")) {
          $("btn-abonos").addEventListener("click", async () => {
            if (!state.facturaGuardada?.id){
              toast("Primero guarda la factura", "warn");
              return;
            }
            await abrirAbonosFactura(state.facturaGuardada.id);
          });
        }
        $("btn-logout").addEventListener("click", cerrarSesion);
        $("paciente_cedula").addEventListener("input", onCedulaInput);
        $("btn-ver-facturas").addEventListener("click", async () => {
          const ced = ($("paciente_cedula").value || "").trim().replace(/[^\d]/g, "");
          $("buscar_facturas").value = ced || "";
          openModal();
          await listarFacturas();
        });
        $("btn-cerrar-modal").addEventListener("click", closeModal);
        $("modal-facturas").addEventListener("click", (e) => {
          if (e.target === $("modal-facturas")) closeModal();
        });
        // ‚úÖ Ver factura
        $("btn-cerrar-modal-verfactura").addEventListener("click", closeModalVerFactura);
        $("modal-verfactura").addEventListener("click", (e) => {
          if (e.target === $("modal-verfactura")) closeModalVerFactura();
        });
        $("btn-imprimir-verfactura").addEventListener("click", async () => {
          if (!state.facturaVer){
            toast("No hay una factura seleccionada", "warn");
            return;
          }
          await imprimirFacturaPorId(state.facturaVer);
        });
        // ‚úÖ Abonos
        $("btn-cerrar-modal-abonos").addEventListener("click", closeModalAbonos);
        $("modal-abonos").addEventListener("click", (e) => {
          if (e.target === $("modal-abonos")) closeModalAbonos();
        });
        $("btn-refresh-abonos").addEventListener("click", listarAbonos);
        $("btn-agregar-abono").addEventListener("click", agregarAbono);
        $("btn-refresh-facturas").addEventListener("click", listarFacturas);
        // ‚úÖ Maximizar / restaurar modal "Facturas generadas"
        if ($("btn-max-modal-facturas")){
          $("btn-max-modal-facturas").addEventListener("click", () => {
            const card = document.querySelector("#modal-facturas .modal-card");
            if (!card) return;
            const isMax = card.classList.toggle("maximized");
            $("btn-max-modal-facturas").textContent = isMax ? "üóó" : "‚õ∂";
            $("btn-max-modal-facturas").title = isMax ? "Restaurar" : "Maximizar";
          });
        }
        $("btn-buscar-facturas").addEventListener("click", listarFacturas);
        $("limite_facturas").addEventListener("change", listarFacturas);
        $("fecha_desde").addEventListener("change", listarFacturas);
        $("fecha_hasta").addEventListener("change", listarFacturas);
        if ($("estado_facturas")) $("estado_facturas").addEventListener("change", listarFacturas);
        $("buscar_facturas").addEventListener("keydown", (e) => {
          if (e.key === "Enter") listarFacturas();
        });
        $("btn-export-excel").addEventListener("click", exportarExcel);
        const ok = await proteger();
        if (!ok) return;
        await cargarProfesionales();
        await cargarProcedimientos();
        renderItems();
        syncIVAUI();
        recalcularTotales();
      } catch (err){
        console.error("INIT ERROR:", err);
        toast("Error inicializando:\n" + (err?.message || err), "err");
      }
      // ‚úÖ Asegurar dropdown cerrado al cargar la p√°gina
const procDrop = document.getElementById("proc-dropdown");
if (procDrop) procDrop.style.display = "none";

    }
    // ‚úÖ ARRANQUE ROBUSTO (esto evita el ‚Äúning√∫n bot√≥n funciona‚Äù)
    if (document.readyState === "loading"){
      window.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
 /* =====================================================
   ‚úÖ AUTO-B√öSQUEDA FACTURACI√ìN DESDE URL
   (?paciente_cedula=)
   ===================================================== */
(function () {
  const params = new URLSearchParams(window.location.search);
  const cedula = params.get("paciente_cedula");

  if (!cedula) return;

  // Esperar a que TODO est√© inicializado
  window.addEventListener("DOMContentLoaded", () => {
    const input = document.getElementById("paciente_cedula");
    if (!input) {
      console.warn("‚ùå Input paciente_cedula no encontrado");
      return;
    }

    // Setear la c√©dula
    input.value = cedula;

    // ‚è≥ Esperar a que Supabase + listeners est√©n listos
    setTimeout(() => {
      if (typeof buscarPacienteEnHistoria === "function") {
        buscarPacienteEnHistoria(true); // ‚Üê ESTA ES LA CLAVE
      } else {
        console.error("‚ùå buscarPacienteEnHistoria no existe");
      }
    }, 600);
  });
})();

   async function cargarPlanDesdeSupabase() {
  // 1Ô∏è‚É£ Obtener c√©dula desde la URL o input
  const params = new URLSearchParams(window.location.search);
  const cedula =
    params.get("cedula") ||
    document.getElementById("paciente_cedula")?.value;

  if (!cedula) {
    alert("No se encontr√≥ la c√©dula del paciente");
    return;
  }

  // 2Ô∏è‚É£ Consultar tabla temporal
  const { data, error } = await supabase
    .from("facturacion_temporal")
    .select("*")
    .eq("cedula", cedula);

  if (error) {
    console.error(error);
    alert("Error consultando plan de tratamiento");
    return;
  }

  if (!data || !data.length) {
    alert("No hay procedimientos pendientes por cargar");
    return;
  }

  console.log("üì¶ Plan recibido desde Supabase:", data);

  // 3Ô∏è‚É£ Insertar en state.items
  data.forEach(it => {
  state.items.push({
  id_local: crypto.randomUUID(),
  procedimiento_id: it.procedimiento_id,
  codigo_cups: it.codigo_cups,
  descripcion: it.procedimiento,
  cantidad: Number(it.cantidad || 1),
  valor_unitario: Number(it.valor_unitario || 0),
  valor_total: Number(it.valor_total || 0)
});

  });

  // 4Ô∏è‚É£ Renderizar
  renderItems();
  recalcularTotales();

  // 5Ô∏è‚É£ (OPCIONAL PERO RECOMENDADO) limpiar tabla temporal
  await supabase
    .from("facturacion_temporal")
    .delete()
    .eq("cedula", cedula);

  console.log("‚úÖ Plan cargado y tabla temporal limpiada");
}
 // ===============================
// üì• BOT√ìN CARGAR PLAN DE TRATAMIENTO
// ===============================
document
  .getElementById("btn-cargar-plan")
  ?.addEventListener("click", cargarPlanDesdeSupabase);

  </script>
</body>
</html>










<!-- =========================================================
     FACTURACI√ìN ELECTR√ìNICA (CORS SAFE - FORM POST)
     NO modifica ni interfiere con l√≥gica existente
     ========================================================= -->
<script>

function enviarFacturacionElectronica(){
  try{
    // ‚ö†Ô∏è NO se requiere seleccionar factura:
    // se env√≠a la factura que est√° visible en el modal

    const facturaNumeroEl = document.querySelector('[data-factura-numero], #factura-numero, .factura-numero');
    const facturaNumero = facturaNumeroEl ? facturaNumeroEl.textContent.trim() : null;

    const paciente = {
      nombre: document.querySelector('[data-paciente-nombre]')?.textContent || null,
      cedula: document.querySelector('[data-paciente-cedula]')?.textContent || null,
      correo: document.querySelector('[data-paciente-correo]')?.textContent || null
    };

    const payload = {
      factura_visible: true,
      factura_numero: facturaNumero,
      paciente,
      fecha_envio: new Date().toISOString(),
      origen: "facturacion.html"
    };

    const form = document.createElement("form");
    form.method = "POST";
    form.action = "https://ftth-n8n2.pzveh5.easypanel.host/webhook-test/a98d155f-561d-470f-b353-e9baab31249b";
    form.target = "_blank";

    const input = document.createElement("input");
    input.type = "hidden";
    input.name = "payload";
    input.value = JSON.stringify(payload);

    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
  }catch(e){
    console.error("FE error:", e);
    alert("Error enviando a facturaci√≥n electr√≥nica");
  }
}
</script>



<!-- =========================================================
     FIX: AUTOCARGA DESDE ?paciente_cedula=XXXX (NO rompe nada)
     + OVERRIDE: FACTURACI√ìN ELECTR√ìNICA SIN PESTA√ëAS Y CON PAYLOAD COMPLETO
     ========================================================= -->
<script>
(function(){
  // --------- Helper: DOM ready ----------
  function onReady(fn){
    if(document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", fn, { once:true });
    }else{
      try{ fn(); }catch(e){ console.warn("onReady error:", e); }
    }
  }

  // --------- 1) Autocarga paciente por querystring ----------
  function autoCargarPacienteDesdeQuery(){
    try{
      var ced = new URLSearchParams(window.location.search).get("paciente_cedula");
      if(!ced) return;

      var input = document.getElementById("paciente_cedula");
      if(!input) return;

      // No interferir si el usuario ya escribi√≥ algo distinto
      var cedTrim = String(ced).trim();
      if(String(input.value || "").trim() !== cedTrim){
        input.value = cedTrim;
        input.dispatchEvent(new Event("input", { bubbles:true }));
      }

      // Fuerza el flujo existente (bot√≥n Autocompletar si existe)
      setTimeout(function(){
        var btn = document.getElementById("btn-buscar");
        if(btn && typeof btn.click === "function"){
          btn.click();
        }
      }, 250);
    }catch(e){
      console.warn("Autocarga paciente (query) error:", e);
    }
  }

  // --------- 2) Toast/Notificaci√≥n (usa #toast existente si est√°) ----------
  function showToastFE(msg, ok){
    try{
      var toast = document.getElementById("toast");
      if(!toast){
        // Fallback m√≠nimo sin tocar estilos globales
        alert(msg);
        return;
      }
      // No asumir estructura exacta: solo texto
      toast.textContent = msg;

      // Respetar clases existentes: a√±adimos y removemos de forma segura
      toast.classList.remove("show");
      toast.classList.remove("success");
      toast.classList.remove("error");
      toast.classList.add("show");
      toast.classList.add(ok ? "success" : "error");

      setTimeout(function(){
        toast.classList.remove("show");
      }, 3200);
    }catch(e){
      console.warn("Toast FE error:", e);
      alert(msg);
    }
  }

  // --------- 3) Extraer datos desde la factura visible (iframe vf_iframe) ----------
  function getFacturaVisibleData(){
    var iframe = document.getElementById("vf_iframe");
    if(!iframe || !iframe.contentDocument) return null;

    var doc = iframe.contentDocument;

    // 3.1 N√∫mero factura: preferir title "Factura <N¬∞>"
    var facturaNumero = null;
    try{
      var t = (doc.title || "").trim();
      if(t.toLowerCase().startsWith("factura")){
        facturaNumero = t.replace(/^factura\s*/i, "").trim() || null;
      }
    }catch(_e){}

    // 3.2 ID factura (si est√° en dataset)
    var facturaId = null;
    try{
      facturaId = doc.documentElement?.dataset?.facturaId || null;
    }catch(_e){}

    // 3.3 Key/Value blocks
    var kv = {};
    try{
      var kvEls = doc.querySelectorAll(".kv");
      kvEls.forEach(function(el){
        var k = (el.querySelector(".k")?.textContent || "").trim().toLowerCase();
        var v = (el.querySelector(".v")?.textContent || "").trim();
        if(k){
          kv[k] = v || null;
        }
      });
    }catch(_e){}

    // 3.4 Procedimientos (tabla)
    var procedimientos = [];
    try{
      var rows = doc.querySelectorAll("table tbody tr");
      rows.forEach(function(tr){
        var tds = tr.querySelectorAll("td");
        if(!tds || tds.length < 5) return;
        procedimientos.push({
          cups: (tds[0].textContent || "").trim() || null,
          procedimiento: (tds[1].textContent || "").trim() || null,
          cantidad: (tds[2].textContent || "").trim() || null,
          valor_unitario: (tds[3].textContent || "").trim() || null,
          total: (tds[4].textContent || "").trim() || null
        });
      });
    }catch(_e){}

    // 3.5 Totales (si est√° .totbox)
    var totales = {};
    try{
      var lines = doc.querySelectorAll(".totbox .line");
      lines.forEach(function(line){
        var label = (line.childNodes[0]?.textContent || "").trim().replace(/:$/, "").toLowerCase();
        var value = (line.querySelector("b")?.textContent || "").trim();
        if(label){
          totales[label] = value || null;
        }
      });
      // TOTAL grande (si existe)
      var totalBig = doc.querySelector(".totbox .big b")?.textContent?.trim();
      if(totalBig) totales["total"] = totalBig;
    }catch(_e){}

    // 3.6 Datos del paciente / factura
    var paciente = {
      nombre: kv["paciente"] || null,
      cedula: kv["c√©dula"] || kv["cedula"] || null,
      correo: kv["correo"] || null,
      tipo_usuario: kv["tipo usuario"] || null,
      eps: kv["eps"] || null
    };

    var factura = {
      id: facturaId,
      numero: facturaNumero,
      profesional: kv["profesional"] || null,
      metodo_pago: kv["m√©todo de pago"] || kv["metodo de pago"] || null,
      estado_pago: kv["estado de pago"] || null,
      referencia: kv["referencia"] || null,
      aplica_iva: kv["¬øaplica iva?"] || kv["aplica iva?"] || null,
      iva_porcentaje: kv["iva %"] || null,
      observacion: kv["observaci√≥n"] || kv["observacion"] || null,
      procedimientos: procedimientos,
      totales: totales
    };

    return { paciente: paciente, factura: factura };
  }

  // --------- 4) Env√≠o CORS-safe SIN pesta√±as (POST a iframe oculto) ----------
  function ensureHiddenIframe(){
    var existing = document.getElementById("n8n_fe_iframe");
    if(existing) return existing;

    var ifr = document.createElement("iframe");
    ifr.id = "n8n_fe_iframe";
    ifr.name = "n8n_fe_iframe";
    ifr.style.width = "0";
    ifr.style.height = "0";
    ifr.style.border = "0";
    ifr.style.position = "absolute";
    ifr.style.left = "-9999px";
    ifr.style.top = "-9999px";
    ifr.setAttribute("aria-hidden", "true");
    document.body.appendChild(ifr);
    return ifr;
  }

  // OVERRIDE: √∫ltima definici√≥n gana (sin tocar la existente)
  window.enviarFacturacionElectronica = function(){
    try{
      var data = getFacturaVisibleData();
      if(!data || !data.factura || (!data.factura.numero && !data.factura.id)){
        showToastFE("No se encontr√≥ una factura visible para enviar.", false);
        return;
      }

      var payload = {
        factura_visible: true,
        factura_id: data.factura.id || null,
        factura_numero: data.factura.numero || null,
        paciente: data.paciente || null,
        factura: data.factura || null,
        fecha_envio: new Date().toISOString(),
        origen: "facturacion.html"
      };

      // Crear POST FORM URLENCODED a iframe oculto (evita CORS y sin cambiar pesta√±a)
      ensureHiddenIframe();

      var form = document.createElement("form");
      form.method = "POST";
      form.action = "https://ftth-n8n2.pzveh5.easypanel.host/webhook/a98d155f-561d-470f-b353-e9baab31249b";
      form.target = "n8n_fe_iframe";

      var input = document.createElement("input");
      input.type = "hidden";
      input.name = "payload";
      input.value = JSON.stringify(payload);

      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
      document.body.removeChild(form);

      showToastFE("‚úÖ Enviado a n8n (Facturaci√≥n electr√≥nica).", true);
    }catch(e){
      console.error("FE error:", e);
      showToastFE("Error enviando a facturaci√≥n electr√≥nica.", false);
    }
  };

  onReady(function(){
    autoCargarPacienteDesdeQuery();
  });
})();
</script>







