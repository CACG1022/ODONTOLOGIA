<!DOCTYPE html>
<html lang="es"> 
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Facturaci√≥n - Cl√≠nica Odontol√≥gica</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg: #f3f5f7;
      --card: #ffffff;
      --text: #1f2a37;
      --muted: #6b7280;
      --line: #e5e7eb;
      --brand: #1f6aa5;
      --brand2: #114a75;
      --danger: #b42318;
      --shadow: 0 10px 30px rgba(16,24,40,.08);
      --radius: 14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 18px;
    }
    .topbar{
      max-width: 1100px;
      margin: 0 auto 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    .topbar h2{ margin:0; font-size:1.4rem; color:var(--brand); }
    
    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      max-width: 1100px;
      margin: 0 auto 20px;
    }

    /* Grid cabecera */
    .header-grid{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .form-group label{
      display:block; 
      font-size:0.85rem; 
      color:var(--muted); 
      margin-bottom:4px;
    }
    .form-input{
      width:100%;
      padding: 9px 12px;
      border:1px solid var(--line);
      border-radius:6px;
      font-size:0.95rem;
      transition: all 0.2s;
    }
    .form-input:focus{
      outline:none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(31,106,165,0.1);
    }

    /* Tabla Items */
    .table-container{
      overflow-x: auto;
      margin-bottom: 20px;
      border: 1px solid var(--line);
      border-radius: 8px;
    }
    table{
      width: 100%;
      border-collapse: collapse;
      min-width: 900px; 
    }
    th{
      background: #f9fafb;
      color: var(--muted);
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
      padding: 10px 8px;
      text-align: left;
      border-bottom: 1px solid var(--line);
    }
    td{
      padding: 8px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
    }
    tr:last-child td{ border-bottom:none; }
    
    /* Inputs en tabla */
    td .form-input{
      padding: 6px;
      font-size: 0.9rem;
    }
    
    .btn{
      cursor: pointer;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.9rem;
      transition: opacity 0.2s;
      display: inline-flex; 
      align-items: center; 
      gap: 6px;
    }
    .btn:hover{ opacity:0.9; }
    .btn-primary{ background:var(--brand); color:#fff; }
    .btn-secondary{ background:#fff; border:1px solid var(--line); color:var(--text); }
    .btn-danger{ background:var(--danger); color:#fff; padding:6px 10px; font-size:0.8rem; }
    .btn-success{ background: #10b981; color: #fff; }

    .totals-area{
      display:flex; 
      justify-content:flex-end;
      margin-top:10px;
    }
    .totals-box{
      width: 250px;
      background: #f8fafc;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid var(--line);
    }
    .t-row{ display:flex; justify-content:space-between; margin-bottom:8px; font-size:0.9rem; }
    .t-row.big{ font-weight:bold; font-size:1.1rem; color:var(--brand); margin-top:8px; border-top:1px solid var(--line); padding-top:8px;}

    /* Autocompletar Tratamiento */
    .autocomplete-wrapper { position: relative; }
    .suggestions-list {
      position: absolute;
      top: 100%; left: 0; right: 0;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 0 0 6px 6px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      box-shadow: var(--shadow);
      display: none;
    }
    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .suggestion-item:hover { background: #f0fdf4; }

    /* Toast */
    #toast-fe {
      visibility: hidden;
      min-width: 250px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 12px;
      position: fixed;
      z-index: 9999;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      font-size: 0.95rem;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    #toast-fe.show {
      visibility: visible;
      animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }
    @keyframes fadein { from{bottom:0; opacity:0;} to{bottom:30px; opacity:1;} }
    @keyframes fadeout { from{bottom:30px; opacity:1;} to{bottom:0; opacity:0;} }
    
    /* Botones flotantes */
    .floating-actions {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
    }
    .fab {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--brand);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      cursor: pointer;
      border: none;
      font-size: 1.2rem;
      transition: transform 0.2s;
    }
    .fab:hover { transform: scale(1.1); }
    .fab.green { background: #10b981; }
    .fab.orange { background: #f59e0b; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="topbar">
  <h2>üßæ Facturaci√≥n</h2>
  <div>
    <button class="btn btn-secondary" onclick="nuevoPaciente()">Limpiar / Nuevo</button>
    <button class="btn btn-primary" onclick="guardarFactura()">üíæ Guardar Factura</button>
  </div>
</div>

<div class="card">
  <div class="header-grid">
    <div class="form-group">
      <label>Nro. Factura (Auto)</label>
      <input type="text" id="facturaNumero" class="form-input" placeholder="(Pendiente)" readonly style="background:#f9fafb;">
    </div>
    <div class="form-group">
      <label>Fecha Emisi√≥n</label>
      <input type="date" id="fechaEmision" class="form-input">
    </div>
    <div class="form-group">
      <label>Paciente (Nombre)</label>
      <input type="text" id="pacienteNombre" class="form-input" placeholder="Buscar o escribir...">
    </div>
    <div class="form-group">
      <label>DNI / Documento</label>
      <input type="text" id="pacienteDoc" class="form-input" placeholder="Documento">
    </div>
  </div>

  <hr style="border:0; border-top:1px solid var(--line); margin: 20px 0;">

  <div class="table-container">
    <table id="itemsTable">
      <thead>
        <tr>
          <th style="width:25%">Tratamiento</th>
          <th style="width:70px">Diente</th>
          <th style="width:70px">Caras</th>
          <th style="width:100px">Precio</th>
          <th style="width:60px">Cant.</th>
          <th style="width:70px">Desc%</th>
          <th style="width:100px">Total</th>
          <th style="width:80px">ID</th>
          <th style="width:100px">Costo</th>
          <th style="width:15%">Profesional</th>
          <th style="width:50px"></th>
        </tr>
      </thead>
      <tbody id="itemsBody">
        </tbody>
    </table>
  </div>

  <button class="btn btn-secondary" onclick="agregarFila()">+ Agregar √çtem</button>

  <div class="totals-area">
    <div class="totals-box">
      <div class="t-row">
        <span>Subtotal:</span>
        <span id="lblSubtotal">$0.00</span>
      </div>
      <div class="t-row">
        <span>Descuento Global:</span>
        <span id="lblDescGlobal">$0.00</span>
      </div>
      <div class="t-row big">
        <span>TOTAL:</span>
        <span id="lblTotal">$0.00</span>
      </div>
    </div>
  </div>
</div>

<div id="toast-fe">Mensaje...</div>

<div class="floating-actions">
  <button class="fab green" title="Exportar Excel" onclick="exportarExcel()">
    üìä
  </button>
  <button class="fab orange" title="Enviar Factura Electr√≥nica" onclick="enviarFacturaElectronica()">
    üì®
  </button>
</div>

<iframe name="n8n_fe_iframe" id="n8n_fe_iframe" style="display:none;"></iframe>

<script>
  // 1) CONFIGURACI√ìN SUPABASE
  // REEMPLAZA CON TUS CREDENCIALES REALES
  const SB_URL = "YOUR_SUPABASE_URL"; 
  const SB_KEY = "YOUR_SUPABASE_ANON_KEY";
  const supabase = createClient(SB_URL, SB_KEY);

  // Estado global
  let items = []; // { tratamiento, diente, caras, precio, cantidad, descuento, total, profesional, id_procedimiento, costo }
  let tratamientosList = []; // Se carga de DB
  let currentFacturaId = null;

  // Al iniciar
  document.addEventListener('DOMContentLoaded', async () => {
    // Fecha hoy
    document.getElementById('fechaEmision').valueAsDate = new Date();
    // Cargar cat√°logo
    await loadTratamientos();
    // Iniciar con 1 fila
    agregarFila();
  });

  // --- L√ìGICA DE DATOS ---

  async function loadTratamientos(){
    try {
      // ‚úÖ MODIFICADO: Se agregan 'id' y 'costo' a la selecci√≥n
      const { data, error } = await supabase
        .from('procedimientos_precios')
        .select('id, nombre, precio, costo') 
        .order('nombre');
      
      if(error) throw error;
      tratamientosList = data || [];
      console.log("Tratamientos cargados:", tratamientosList.length);
    } catch (err) {
      console.error("Error loading tratamientos:", err);
      showToastFE("Error cargando tratamientos");
    }
  }

  function agregarFila(){
    items.push({
      tratamiento: "",
      diente: "",
      caras: "",
      precio: 0,
      cantidad: 1,
      descuento: 0,
      total: 0,
      profesional: "",
      // Campos nuevos inicializados
      id_procedimiento: "",
      costo: 0
    });
    renderItems();
  }

  function eliminarFila(index){
    if(items.length > 1){
      items.splice(index, 1);
      renderItems();
    } else {
      // Si es la √∫ltima, solo limpiar
      items[0] = { 
        tratamiento: "", diente: "", caras: "", 
        precio: 0, cantidad: 1, descuento: 0, total: 0, profesional: "",
        id_procedimiento: "", costo: 0
      };
      renderItems();
    }
  }

  function updateItem(index, field, value){
    const it = items[index];

    if(field === 'tratamiento'){
      it.tratamiento = value;
      // Buscar precio, ID y Costo en lista
      const found = tratamientosList.find(t => t.nombre === value);
      if(found){
        it.precio = found.precio || 0;
        // ‚úÖ ASIGNACI√ìN DE ID Y COSTO BASADO EN LA B√öSQUEDA
        it.id_procedimiento = found.id;
        it.costo = found.costo || 0;
      }
    } 
    else if(field === 'precio') it.precio = parseFloat(value) || 0;
    else if(field === 'cantidad') it.cantidad = parseFloat(value) || 1;
    else if(field === 'descuento') it.descuento = parseFloat(value) || 0;
    else if(field === 'diente') it.diente = value;
    else if(field === 'caras') it.caras = value;
    else if(field === 'profesional') it.profesional = value;
    // Campos readonly (id, costo) no se actualizan manualmente usualmente, 
    // pero si quisieras, podr√≠as agregar los else if aqu√≠.

    // Recalcular total fila
    // Total = (Precio * Cant) - ( (Precio*Cant) * (Desc/100) )
    const base = it.precio * it.cantidad;
    const descVal = base * (it.descuento / 100);
    it.total = base - descVal;

    renderItems(); 
  }

  // Renderizar tabla
  function renderItems(){
    const tbody = document.getElementById('itemsBody');
    tbody.innerHTML = "";
    
    let sumTotal = 0;

    items.forEach((item, idx) => {
      sumTotal += item.total;
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div class="autocomplete-wrapper">
            <input type="text" class="form-input" 
              value="${item.tratamiento}" 
              oninput="onTratamientoInput(this, ${idx})"
              placeholder="Buscar tratamiento...">
            <div class="suggestions-list" id="sugg-${idx}"></div>
          </div>
        </td>
        <td><input type="text" class="form-input" value="${item.diente}" onchange="updateItem(${idx}, 'diente', this.value)"></td>
        <td><input type="text" class="form-input" value="${item.caras}" onchange="updateItem(${idx}, 'caras', this.value)"></td>
        <td><input type="number" class="form-input" value="${item.precio}" onchange="updateItem(${idx}, 'precio', this.value)"></td>
        <td><input type="number" class="form-input" value="${item.cantidad}" onchange="updateItem(${idx}, 'cantidad', this.value)"></td>
        <td><input type="number" class="form-input" value="${item.descuento}" onchange="updateItem(${idx}, 'descuento', this.value)"></td>
        <td>
          <input type="text" class="form-input" readonly 
            value="${item.total.toLocaleString('es-CO', {style:'currency', currency:'COP'})}" 
            style="background:#f3f5f7; font-weight:bold;">
        </td>
        
        <td>
           <input type="text" class="form-input" readonly 
             value="${item.id_procedimiento || ''}" 
             style="background:#eee; font-size: 0.85rem; text-align:center;">
        </td>
        <td>
           <input type="text" class="form-input" readonly 
             value="${item.costo ? item.costo.toLocaleString('es-CO', {style:'currency', currency:'COP'}) : '$0'}" 
             style="background:#eee; font-size: 0.85rem;">
        </td>
        <td><input type="text" class="form-input" value="${item.profesional}" onchange="updateItem(${idx}, 'profesional', this.value)"></td>
        <td style="text-align:center;">
          <button class="btn btn-danger" onclick="eliminarFila(${idx})">√ó</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // Actualizar Totales Globales
    document.getElementById('lblSubtotal').innerText = sumTotal.toLocaleString('es-CO', {style:'currency', currency:'COP'});
    document.getElementById('lblTotal').innerText = sumTotal.toLocaleString('es-CO', {style:'currency', currency:'COP'});
  }

  // Autocomplete L√≥gica
  function onTratamientoInput(input, idx){
    const val = input.value.toLowerCase();
    const listDiv = document.getElementById(`sugg-${idx}`);
    if(!val){
      listDiv.style.display = 'none';
      return;
    }
    // Filtrar
    const matches = tratamientosList.filter(t => t.nombre.toLowerCase().includes(val));
    
    if(matches.length === 0){
      listDiv.style.display = 'none';
      return;
    }

    listDiv.innerHTML = "";
    matches.forEach(m => {
      const div = document.createElement('div');
      div.className = 'suggestion-item';
      div.innerText = `${m.nombre} - $${m.precio}`;
      div.onclick = () => {
        updateItem(idx, 'tratamiento', m.nombre);
        listDiv.style.display = 'none';
      };
      listDiv.appendChild(div);
    });
    listDiv.style.display = 'block';
  }

  // Cerrar sugerencias al clic fuera
  document.addEventListener('click', (e) => {
    if(!e.target.closest('.autocomplete-wrapper')){
      document.querySelectorAll('.suggestions-list').forEach(el => el.style.display='none');
    }
  });

  // --- GUARDADO / GESTI√ìN ---

  function nuevoPaciente(){
    if(confirm("¬øLimpiar formulario?")){
      document.getElementById('pacienteNombre').value = "";
      document.getElementById('pacienteDoc').value = "";
      document.getElementById('facturaNumero').value = "";
      currentFacturaId = null;
      items = [];
      agregarFila();
    }
  }

  async function guardarFactura(){
    const pacNombre = document.getElementById('pacienteNombre').value;
    const pacDoc = document.getElementById('pacienteDoc').value;
    const fecha = document.getElementById('fechaEmision').value;

    if(!pacNombre){ showToastFE("Falta nombre paciente", false); return; }

    const totalFactura = items.reduce((acc, i) => acc + i.total, 0);

    const payload = {
      paciente_nombre: pacNombre,
      paciente_doc: pacDoc,
      fecha_emision: fecha,
      items: items, // Incluye id_procedimiento y costo
      total: totalFactura
    };

    showToastFE("Guardando...", true);

    try {
      // Ejemplo: Insertar en tabla 'facturas'
      // Ajusta seg√∫n tu esquema real
      const { data, error } = await supabase
        .from('facturas')
        .insert([payload])
        .select();

      if(error) throw error;
      
      const nueva = data[0];
      currentFacturaId = nueva.id;
      document.getElementById('facturaNumero').value = nueva.id; // O numero si tienes secuencia
      
      showToastFE("‚úÖ Factura Guardada");

    } catch (e) {
      console.error(e);
      showToastFE("Error guardando: " + e.message, false);
    }
  }

  // --- UTILIDADES EXTRAS ---

  function showToastFE(msg, success=true){
    const t = document.getElementById('toast-fe');
    t.innerText = msg;
    t.style.backgroundColor = success ? '#333' : '#b42318';
    t.className = "show";
    setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
  }

  // 1. Exportar a Excel
  window.exportarExcel = function(){
    if(items.length === 0){ showToastFE("Nada que exportar", false); return; }
    
    // Mapear datos limpios para Excel, incluyendo los nuevos campos
    const datosExcel = items.map(i => ({
      Tratamiento: i.tratamiento,
      Diente: i.diente,
      Caras: i.caras,
      PrecioUnit: i.precio,
      Cantidad: i.cantidad,
      Descuento: i.descuento,
      Total: i.total,
      ID_Procedimiento: i.id_procedimiento, // Nuevo en Excel
      Costo_Interno: i.costo,               // Nuevo en Excel
      Profesional: i.profesional
    }));

    const ws = XLSX.utils.json_to_sheet(datosExcel);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Factura");
    
    const name = "Factura_" + (document.getElementById('pacienteNombre').value || "SinNombre") + ".xlsx";
    XLSX.writeFile(wb, name);
    showToastFE("Excel descargado");
  };

  // 2. Enviar Factura Electr√≥nica (Webhook n8n)
  window.enviarFacturaElectronica = function(){
    try{
      var data = getFacturaVisibleData();
      if(!data || !data.factura || (!data.factura.numero && !data.factura.id)){
        // Intentamos usar los datos en pantalla si no se ha guardado aun
        // Ojo: idealmente primero se guarda
        if(!currentFacturaId){
             showToastFE("Primero guarda la factura", false);
             return;
        }
      }

      var payload = {
        factura_visible: true,
        factura_id: currentFacturaId,
        factura_numero: document.getElementById('facturaNumero').value,
        paciente: document.getElementById('pacienteNombre').value,
        items: items, // Enviamos items con ID y Costo
        fecha_envio: new Date().toISOString(),
        origen: "facturacion.html"
      };

      // Crear POST FORM URLENCODED a iframe oculto (evita CORS y sin cambiar pesta√±a)
      ensureHiddenIframe();

      var form = document.createElement("form");
      form.method = "POST";
      form.action = "https://ftth-n8n2.pzveh5.easypanel.host/webhook/a98d155f-561d-470f-b353-e9baab31249b";
      form.target = "n8n_fe_iframe";

      var input = document.createElement("input");
      input.type = "hidden";
      input.name = "payload";
      input.value = JSON.stringify(payload);

      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
      document.body.removeChild(form);

      showToastFE("‚úÖ Enviando a DIAN/Correo...");
    }catch(e){
      console.error(e);
      showToastFE("Error al enviar", false);
    }
  };

  function getFacturaVisibleData(){
    // Helper simple
    return {
      factura: { id: currentFacturaId, numero: document.getElementById('facturaNumero').value },
      paciente: document.getElementById('pacienteNombre').value
    };
  }

  function ensureHiddenIframe(){
    if(!document.getElementById('n8n_fe_iframe')){
      var ifr = document.createElement('iframe');
      ifr.name = 'n8n_fe_iframe';
      ifr.id = 'n8n_fe_iframe';
      ifr.style.display = 'none';
      document.body.appendChild(ifr);
    }
  }

  // Helper para crear cliente supabase si no existe global
  // (En un entorno real, @supabase/supabase-js expone createClient)
</script>
</body>
</html>









