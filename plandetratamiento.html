<!DOCTYPE html>
<html lang="es">
<head>
  <!-- ‚úÖ Fuente tipo la de tu imagen -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    window.supabase = createClient(
      'https://dmcfrmpqlkrqbpjhrfyo.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE'
    );

    // ‚úÖ URLs
const LOGIN_URL = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
const INDEX_URL = "https://cacg1022.github.io/ODONTOLOGIA/index.html";

// ‚úÖ Nombre del m√≥dulo (aj√∫stalo al nombre real con el que lo guardas en permisos.html)
const MODULO_ACTUAL = "plandetratamiento";

// ‚úÖ Normaliza posibles nombres de m√≥dulo (con/sin .html, con guiones/underscores)
function getModuloCandidates(mod){
  const base = String(mod || "").toLowerCase().trim();
  const withHtml = base.endsWith(".html") ? base : base + ".html";
  const undersc = base.replaceAll("-", "_");
  const underscHtml = undersc.endsWith(".html") ? undersc : undersc + ".html";
  return Array.from(new Set([base, withHtml, undersc, underscHtml]));
}

// ‚úÖ Leer rol desde profiles (igual que facturaci√≥n)
async function cargarRolActual(session){
  const email = (session?.user?.email || "").trim().toLowerCase();
  if (!email) return "user";

  try{
    const { data, error } = await window.supabase
      .from("profiles")
      .select("role, created_at, email")
      .eq("email", email)
      .order("created_at", { ascending: false })
      .limit(1)
      .maybeSingle();

    if (error) throw error;

    const role = (data?.role || "").toString().trim().toLowerCase();
    return role || "user";
  } catch (err){
    console.error("No se pudo leer rol en profiles:", err);
    return "user";
  }
}

// ‚úÖ Validar permiso desde modulos_permisos (igual que permisos.html)
async function validarPermisoModulo(role){
  const r = (role || "user").toLowerCase().trim();
  const candidates = getModuloCandidates(MODULO_ACTUAL);

  try{
    const { data, error } = await window.supabase
      .from("modulos_permisos")
      .select("admin, doctor, auxiliar, paciente, modulo")
      .in("modulo", candidates);

    if (error) throw error;

    const permiso = data?.[0] || null;
    const ok = !!(permiso && permiso[r] === true);

    if (!ok){
      window.alert("‚õî No tienes permiso para acceder a este m√≥dulo.");
      window.location.href = INDEX_URL;
      return false;
    }
    return true;
  } catch(err){
    console.error("Error validando permisos:", err);
    window.alert("‚õî No se pudo validar permisos de acceso.");
    window.location.href = INDEX_URL;
    return false;
  }
}

// üîí Verificar sesi√≥n activa + permisos (REEMPLAZA tu verificarSesion por este)
async function verificarSesion() {
  const { data: { session } } = await window.supabase.auth.getSession();

  if (!session) {
    console.warn("üö´ No hay sesi√≥n activa, redirigiendo al login...");
    window.location.href = LOGIN_URL;
    return;
  }

  console.log("‚úÖ Usuario autenticado:", session.user.email);

  // ‚úÖ 1) cargar rol
  const role = await cargarRolActual(session);
  console.log("üë§ Rol:", role);

  // ‚úÖ 2) validar permiso del m√≥dulo
  await validarPermisoModulo(role);
}

verificarSesion();

async function mostrarUsuarioYRol() {
  try {
    const { data: { session } } = await window.supabase.auth.getSession();
    if (!session) return;

    // Email
    const email = session.user.email || "";
    const emailEl = document.getElementById("user-email");
    if (emailEl) emailEl.textContent = email;

    // Leer rol desde profiles
    const { data, error } = await window.supabase
      .from("profiles")
      .select("role")
      .eq("id", session.user.id)
      .single();

    let roleRaw = data?.role || "paciente";

    // Mostrar EXACTO como en panel futurista
    const roleEl = document.getElementById("user-role");
    if (roleEl) roleEl.textContent = `Rol: ${roleRaw}`;

  } catch (e) {
    console.warn("No se pudo cargar usuario/rol:", e);
  }
}


// Ejecutar al cargar
mostrarUsuarioYRol();


window.supabase.auth.onAuthStateChange((_event, session) => {
  if (!session) {
    console.warn("‚ö†Ô∏è Sesi√≥n expirada o cerrada, redirigiendo...");
    window.location.href = LOGIN_URL;
  } else {
    // ‚úÖ Si vuelve sesi√≥n (refresh/login), revalidar permisos
    cargarRolActual(session).then(role => validarPermisoModulo(role));
  }
});


    
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cotizaci√≥n Odontol√≥gica - Dra. Leidi Silva</title>

  <style>
   
    
    :root{
      --tooth-size: clamp(28px, 5.5vw, 40px);
      --gap: 6px;

      /* base */
      --brand: #2a5d84;
      --ink: #1e4a66;

      /* botones top */
      --topbtn: #009688;
      --topbtn-hover: #00796b;

      /* ‚úÖ look ‚Äúform‚Äù como tu imagen */
      --page-bg: #f4f7fb;
      --card-bg: #ffffff;
      --field-bg: #ffffff;
      --field-border: #d6e3f3;
      --field-border-2: #bcd4f4;
      --label: #5b6b7c;
      --title: #1f4e72;

      --radius: 14px;
      --shadow: 0 10px 30px rgba(16, 24, 40, .08);
      --font: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      font-family: var(--font);
      margin: 0;
      padding: 1em;
      background: var(--page-bg);
      color: #0f172a;
    }

    /* ‚úÖ Barra superior NORMAL (NO fija, NO sticky) */
    .topbar{
      position: relative;
      background: #e5e7eb;
      border-bottom: 1px solid #152B61;
      padding: 12px 0;
    }

    .topbar-inner{
      max-width: 960px;
      margin: 0 auto;
      padding: 0 1em;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .topbar-title{
      font-weight: 900;
      color: var(--title);
      white-space: nowrap;
      font-size: 30px;
      line-height: 1.1;
      letter-spacing: -0.02em;
    }
    .topbar-actions{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap: wrap;  
    }

    .btn-top{
      background: var(--topbtn) !important;
      color: #fff !important;
      padding: 0.62em 1.2em;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 800;
      font-family: var(--font);
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
    }
    .btn-top:hover{
      background: var(--topbtn-hover) !important;
      transform: translateY(-1px);
    }

    h2{
      text-align: center;
      color: var(--title);
      font-size: 1.55em;
      margin: 8px 0 16px;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    form{
      background: var(--card-bg);
      padding: 18px;
      max-width: 960px;
      margin: auto;
      border-radius: 18px;
      box-shadow: var(--shadow);
      border: 1px solid #e6eef8;
    }

    label{
      font-weight: 600;
      margin-top: 14px;
      display: block;
      color: var(--label);
      font-size: 13px;
      letter-spacing: .2px;
    }

    input[type="text"],
    input[type="number"],
    input[type="email"],
    select,
    textarea{
      width: 100%;
      background: var(--field-bg);
      padding: 14px 14px;
      margin-top: 8px;
      margin-bottom: 10px;
      border: 1.6px solid var(--field-border);
      border-radius: 14px;
      font-size: 15px;
      font-family: var(--font);
      color: #0f172a;
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease, transform .06s ease;
    }

    input::placeholder, textarea::placeholder{
      color: #9aa8b7;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="email"]:focus,
    select:focus,
    textarea:focus{
      border-color: var(--field-border-2);
      box-shadow: 0 0 0 4px rgba(59,130,246,.14);
    }

    /* ‚úÖ select con altura consistente (si lo usas visible) */
    select{
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, #7b8da1 50%),
        linear-gradient(135deg, #7b8da1 50%, transparent 50%),
        linear-gradient(to right, transparent, transparent);
      background-position:
        calc(100% - 20px) calc(1.2em),
        calc(100% - 15px) calc(1.2em),
        calc(100% - 2.5em) 0.6em;
      background-size:
        5px 5px,
        5px 5px,
        1px 1.8em;
      background-repeat: no-repeat;
    }

    .datetime{
      margin-bottom: 10px;
      color: #334155;
      font-weight: 600;
      font-size: 13px;
    }

    .checkbox-group{
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .checkbox-group label{
      font-weight: 500;
      color: #223;
      display:flex;
      align-items:center;
      gap:8px;
      background:#f6f9ff;
      border:1px solid #e1eaf7;
      padding: 10px 12px;
      border-radius: 12px;
    }
    .checkbox-group input[type="checkbox"]{
      width: 16px; height: 16px;
      accent-color: var(--topbtn);
    }

    canvas{
      border: 1.6px solid var(--field-border);
      border-radius: 14px;
      width: 100%;
      height: 120px;
      margin: 10px 0 14px;
      background:#fff;
    }

    .totales{
      background: #f6f9ff;
      border: 1px solid #e1eaf7;
      border-radius: 14px;
      padding: 14px;
      margin-top: 14px;
    }
    .totales span{
      display: block;
      margin-bottom: 8px;
      color:#0f172a;
      font-weight: 600;
    }

    button{
      padding: 0.95em;
      border: none;
      color: #fff;
      border-radius: 14px;
      width: 100%;
      cursor: pointer;
      margin-top: 10px;
      font-family: var(--font);
      font-weight: 800;
      letter-spacing: .2px;
      box-shadow: 0 10px 22px rgba(16,24,40,.10);
      transition: transform .06s ease, opacity .15s ease;
    }
    button:hover{ opacity: .96; transform: translateY(-1px); }

    button[type="submit"]{ background: #16a34a; }
    button[type="button"]{ background: var(--brand); }

    .link-btn{
      background: var(--brand);
      color:#fff;
      border:none;
      border-radius:50%;
      width:26px;
      height:26px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
    }

    #cedula-hint{
      display:block;
      min-height:1.2em;
      font-size:.9em;
      color:#64748b;
      margin-top: -4px;
      margin-bottom: 6px;
    }

    .odontograma-wrap{
      margin-top: 16px;
      border:1px solid #e1eaf7;
      border-radius: 16px;
      padding: 14px;
      background:#fcfdff;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .row-title{
      text-align:center;
      font-weight:800;
      color: var(--title);
      margin: 6px 0 6px;
      letter-spacing:-.01em;
    }
    .side-labels{
      display:flex;
      justify-content:space-between;
      color: #425466;
      font-weight:700;
      margin:4px 0 6px;
      font-size: 12px;
    }

    .teeth-row{
      position: relative;
      display: grid;
      grid-template-columns: repeat(8, var(--tooth-size)) 2px repeat(8, var(--tooth-size));
      justify-content: center;
      column-gap: var(--gap);
      padding: 6px 0;
      margin-bottom: 6px;
      min-width: calc(16 * var(--tooth-size) + 15 * var(--gap) + 2px);
    }
    .teeth-row::after{
      content:"";
      position:absolute;
      left:calc(50% - 1px);
      top:2px; bottom:2px;
      width:2px;
      background:#cfd6dc;
      border-radius:2px;
    }
    .tooth{
      position: relative;
      width: var(--tooth-size);
      aspect-ratio: 1/1.12;
      border-radius: 10px;
      border:1px solid var(--ink);
      background: var(--ink);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, box-shadow .1s ease;
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
    }
    .tooth:hover{ transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,.16); }
    .tooth svg{ width: calc(var(--tooth-size) * .44); height: calc(var(--tooth-size) * .44); opacity:.9; }
    .tooth svg path{ fill:#e6f2fa; stroke:#bdd7ea; }
    .tooth-num{ position: absolute; top:3px; left:4px; font-size: clamp(9px, 2.2vw, 11px); font-weight:800; text-shadow:0 1px 2px rgba(0,0,0,.35); }
    .tooth-badge{ position: absolute; right:4px; bottom:3px; font-size: clamp(8px, 2vw, 10px); background:#eef6ff; color: var(--ink); padding:1px 4px; border-radius:999px; display:none; }
    .tooth.has-procs .tooth-badge{ display:inline-block; }

    .odontograma-summary{ margin-top: 8px; border-top: 1px dashed #e3e8ee; padding-top: 6px; }
    .summary-list{ margin:0; padding-left: 18px; color:#334155; }
    .summary-list li{ margin: 4px 0; }

    /* ==========================
       ‚úÖ MODAL (procedimientos)
       ========================== */
    .panel-backdrop{ position:fixed; inset:0; background:rgba(15,23,42,.35); display:none; align-items:center; justify-content:center; padding:18px; z-index: 999; }
    .panel{ width: 560px; max-width: 95vw; background:#fff; border-radius:16px; padding: 16px; box-shadow:0 20px 50px rgba(0,0,0,.22); border:1px solid #e6eef8; }
    .panel header{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .panel h3{ margin:0; color: var(--title); font-weight:900; letter-spacing:-.01em; }
    .panel .procs{ display:grid; gap:8px; margin-top:12px; max-height: 52vh; overflow:auto; padding-right: 6px; }

    .proc-toolbar{ margin-top:10px; display:flex; gap:10px; align-items:center; }
    .proc-search{ flex:1; margin:0; }
    .proc-toolbar small{ color:#64748b; font-weight:600; }

    /* ‚úÖ AQU√ç: filas m√°s bajitas */
    .proc-row{
      display:grid;
      grid-template-columns: 1fr 24px 120px;
      gap: 6px 10px;
      align-items:center;
      padding: 6px 10px;              /* ‚¨ÖÔ∏è antes 10px 10px */
      border:1px solid #e6eef8;
      border-radius:12px;             /* un poco menor */
      background:#fbfdff;
    }
    .proc-row:hover{ background:#f4f9ff; }

    /* el label dentro del row (m√°s compacto) */
    .proc-row > label{
      margin:0;
      font-weight:700;
      font-size: 12px;               /* ‚¨ÖÔ∏è m√°s peque√±o */
      line-height: 1.15;             /* ‚¨ÖÔ∏è menos alto */
      color:#334155;
      letter-spacing: .2px;
    }

    /* input precio m√°s bajito */
    .panel .price{
      width:100%;
      border:1.6px solid var(--field-border);
      border-radius:12px;
      padding:8px 10px;              /* ‚¨ÖÔ∏è antes 10px 10px */
      font-size: 13px;               /* ‚¨ÖÔ∏è m√°s peque√±o */
      margin:0;
    }

    /* checkbox/radio un pel√≠n m√°s compacto */
    .proc-check{
      width: 16px;
      height: 16px;
      accent-color: var(--topbtn);
      margin: 0 auto;
    }

    .panel footer{ display:flex; gap:10px; margin-top:14px; }
    .btn-secondary{ background:#94a3b8; }
    .btn-primary{ background: var(--brand); }

    /* ‚úÖ Campo "Procedimiento principal" con el mismo look y abre el modal */
    .picker{
      position: relative;
    }
    .picker input{
      cursor: pointer;
      padding-right: 44px;
    }
    .picker .picker-icon{
      position:absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color:#64748b;
      font-weight: 900;
      pointer-events:none;
    }

    @media (max-width: 480px){
      .panel{ width: 95vw; }
      .proc-row{ grid-template-columns: 1fr 22px 110px; }
    }

/* ===== Usuario / Rol (MISMO LOOK PANEL FUTURISTA) ===== */
.mini-meta{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  justify-content:flex-end;
}

#user-email{
  font-weight: 900;
  color: #0f172a;
  font-size: 13px;
  white-space: nowrap;
}

#user-role{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(0,150,136,.35);
  background: rgba(0,150,136,.12);
  color: #0f172a;
  font-weight: 900;
  font-size: 12px;
  letter-spacing:.04em;
  white-space:nowrap;
}

#user-role::before{
  content:"";
  width:8px;
  height:8px;
  border-radius:999px;
  background:#009688;
  box-shadow: 0 0 0 4px rgba(0,150,136,.25);
}


      
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="topbar-title">Plan de tratamiento</div>
    
    <div class="mini-meta">
    <span id="user-email"></span>
    <span id="user-role">Rol: ...</span>
    </div>
      
      <div class="topbar-actions">
        <button type="button" class="btn-top"
          onclick="window.location.href='https://cacg1022.github.io/ODONTOLOGIA/index.html'">
          Inicio
        </button>

        <button type="button" class="btn-top"
          onclick="window.location.href='https://cacg1022.github.io/ODONTOLOGIA/historia-clinica.html'">
          Historia Cl√≠nica
        </button>


        <!-- ‚úÖ BOT√ìN IMPRIMIR PDF (AGREGADO - NO MODIFICA LO EXISTENTE) 
        <button type="button" class="btn-top" onclick="imprimirPDF()">
          Imprimir PDF
        </button>-->

      </div>
    </div>
  </div>

  <form id="cotizacion-form" method="POST" action="https://ftth-n8n2.pzveh5.easypanel.host/webhook/dff23e62-359c-439e-a141-950e7542c6c2">
    <div class="datetime">
      <strong>Fecha y hora:</strong> <span id="fecha-hora"></span>
      <input type="hidden" name="fecha" id="input-fecha" />
    </div>

    <label for="nombre">Nombre del paciente:</label>
    <input type="text" id="nombre" name="nombre" required />

    <label for="cedula">N√∫mero de c√©dula:</label>
    <input type="number" id="cedula" name="cedula" required />
    <small id="cedula-hint"></small>

    <label for="celular">N√∫mero de celular:</label>
    <input type="text" id="celular" name="celular" required />

    <label for="correo">Correo electr√≥nico:</label>
    <input type="email" id="correo" name="correo" required />

    <!-- ‚úÖ Procedimiento principal usando el MISMO modal -->
    <label for="procedimiento_display">Procedimiento principal:</label>
    <div class="picker">
      <input
        type="text"
        id="procedimiento_display"
        placeholder="Selecciona procedimiento..."
        readonly
      />
      <span class="picker-icon">‚ñæ</span>
    </div>

    <!-- ‚úÖ mantenemos el select (oculto) para NO romper tu l√≥gica/calcularTotal/loadFromWebhook -->
    <select id="procedimiento" name="procedimiento_raw" style="display:none;">
      <option value="No aplica|0">No aplica</option>
      <!-- se rellena desde Supabase -->
    </select>

    <label>Procedimientos adicionales:</label>
    <div class="checkbox-group">
      <label>
        <input type="checkbox" name="adicionales_raw[]" value="Radiograf√≠a Panor√°mica|50000">
        Radiograf√≠a Panor√°mica - $50,000
        <button type="button" class="link-btn" title="Ver modelo 3D (doble clic)"
          ondblclick="window.open('https://human.biodigital.com/widget/?be=2W7q&background.colors=255,255,255,1,51,64,77,1&initial.hand-hint=true&ui-info=true&ui-fullscreen=true&ui-center=false&ui-dissect=true&ui-zoom=true&ui-help=true&ui-tools-display=primary&uaid=3bH1u','_blank')">üîó</button>
      </label>
      <label><input type="checkbox" name="adicionales_raw[]" value="Exodoncia Simple|120000"> Exodoncia Simple - $120,000</label>
      <label><input type="checkbox" name="adicionales_raw[]" value="Provisional Acr√≠lico|100000"> Provisional Acr√≠lico - $100,000</label>
      <label><input type="checkbox" name="adicionales_raw[]" value="Mantenimiento Brackets|80000"> Mantenimiento Brackets - $80,000</label>
    </div>

    <label>Odontograma (seleccione dientes y asigne procedimientos):</label>
    <div class="odontograma-wrap">
      <div class="row-title">Maxilar superior</div>
      <div class="side-labels"><span>derecha</span><span>izquierda</span></div>
      <div class="teeth-row" id="row-sup"></div>

      <div class="row-title" style="margin-top:8px;">Maxilar inferior</div>
      <div class="side-labels"><span>derecha</span><span>izquierda</span></div>
      <div class="teeth-row" id="row-inf"></div>

      <div class="odontograma-summary">
        <strong>Resumen por diente:</strong>
        <ul class="summary-list" id="summary-list"></ul>
        <div><strong>Procedimiento principal:</strong> <span id="resumen-proc-principal">No aplica</span></div>
      </div>

      <input type="hidden" name="odontograma_json" id="odontograma-json">
      <input type="hidden" name="odontograma_resumen" id="odontograma-resumen">
    </div>

    <input type="hidden" name="procedimiento">
    <input type="hidden" name="adicionales[]">

    <label for="descuento">Descuento:</label>
    <select id="descuento" name="descuento">
      <option value="0">Sin descuento</option>
      <option value="5">5%</option>
      <option value="10">10%</option>
      <option value="20">20%</option>
      <option value="30">30%</option>
    </select>
    <!-- ‚úÖ Campo Abono (AGREGADO) -->
    <label for="abono">Abono:</label>
    <input
      type="number"
      id="abono"
      name="abono_valor"
      value="0"
      min="0"
      step="100"
      inputmode="numeric"
      style="max-width:220px; text-align:left; padding:8px 10px; height:38px;"
    />


    <div class="totales">
      <span><strong>Subtotal:</strong> $<span id="subtotal">0</span></span>
      <span><strong>Descuento:</strong> $<span id="valor-descuento">0</span></span>
      <span><strong>Total a pagar:</strong> $<span id="total">0</span></span>
    </div>

    <input type="hidden" id="input-subtotal" name="subtotal_real">
    <input type="hidden" id="input-descuento" name="descuento_valor">
    <input type="hidden" id="input-total" name="total_real">

    <label for="observaciones">Observaciones:</label>
    <textarea id="observaciones" name="observaciones" rows="4"></textarea>

    <label for="firma">Firma del profesional:</label>
    <canvas id="firma"></canvas>
    <input type="hidden" name="firma" id="firmaInput" />

    <button type="button" onclick="limpiarFirma()">Limpiar Firma</button>
    <button type="button" id="btn-guardar" style="background:#2a5d84;">Guardar</button>
    <!-- <button type="submit">Enviar a paciente</button>-->
  </form>

  <!-- Modal odontograma / y tambi√©n para Procedimiento principal -->
  <div class="panel-backdrop" id="panel-backdrop" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="panel-title">
      <header>
        <h3 id="panel-title">Procedimientos diente <span id="panel-tooth"></span></h3>
        <button type="button" class="btn-secondary" id="btn-close">Cerrar</button>
      </header>

      <div class="proc-toolbar">
        <input id="proc-search" class="proc-search" type="text" placeholder="Buscar procedimiento..." />
        <small id="proc-count"></small>
      </div>

      <div class="procs" id="procs-container"></div>

      <footer>
        <button type="button" class="btn-secondary" id="btn-clear">Limpiar</button>
        <button type="button" class="btn-primary" id="btn-save">Guardar</button>
      </footer>
    </div>
  </div>

  <script>
    /* ==========================
       Fecha/Hora
       ========================== */
    const now = new Date();
    document.getElementById("fecha-hora").textContent = now.toLocaleDateString('es-CO') + " - " + now.toLocaleTimeString('es-CO');
    document.getElementById("input-fecha").value = now.toLocaleDateString('es-CO') + " " + now.toLocaleTimeString('es-CO');

    const procedimiento = document.getElementById("procedimiento");
    const procedimientoDisplay = document.getElementById("procedimiento_display");
    const adicionales = document.querySelectorAll(".checkbox-group input[type='checkbox']");
    const descuentoSel = document.getElementById("descuento");
    const parseMoney = v => parseInt(String(v ?? '').replace(/[^\d]/g,''), 10) || 0;

    /* ==========================
       ‚úÖ Cat√°logo desde Supabase
       ========================== */
    let PROC_CATALOGO = [];
    let PROC_READY = false;

    function fillProcedimientoSelectFromCatalog(){
      // Mantener "No aplica"
      procedimiento.innerHTML = `<option value="No aplica|0">No aplica</option>`;

      (PROC_CATALOGO || []).forEach(p=>{
        const price = Number.isFinite(p.price) ? p.price : 0;
        const opt = document.createElement("option");
        opt.value = `${p.label}|${price}`;
        opt.textContent = `${p.label} - $${price.toLocaleString('es-CO')}`;
        procedimiento.appendChild(opt);
      });

      // Si no hay nada seleccionado, mostrar "No aplica"
      if(!procedimiento.value) procedimiento.value = "No aplica|0";
      syncProcedimientoDisplay();
    }

    function syncProcedimientoDisplay(){
      const val = procedimiento.value || "No aplica|0";
      const [name, price] = val.split("|");
      if(val === "No aplica|0"){
        procedimientoDisplay.value = "No aplica";
      }else{
        const p = parseMoney(price);
        procedimientoDisplay.value = `${name} - $${p.toLocaleString('es-CO')}`;
      }
    }

    async function cargarCatalogoDesdeSupabase() {
      try {
        const { data, error } = await window.supabase
          .from("procedimientos_precios")
          .select("id, procedimiento, valor, activo, profesional")
          .eq("activo", true)
          .order("procedimiento", { ascending: true });

        if (error) throw error;

        PROC_CATALOGO = (data || []).map(row => ({
          key: String(row.id),
          label: String(row.procedimiento),
          price: row.valor == null ? null : Number(row.valor),
          profesional: row.profesional || null // ‚úÖ NUEVO
        }));

        PROC_READY = true;

        // ‚úÖ Usar el mismo cat√°logo para "Procedimiento principal" (select oculto)
        fillProcedimientoSelectFromCatalog();
      } catch (e) {
        console.warn("No se pudo cargar procedimientos desde Supabase:", e?.message || e);
        PROC_CATALOGO = [];
        PROC_READY = false;

        // aun as√≠, que el display no quede vac√≠o
        syncProcedimientoDisplay();
      }
    }

    /* ========= ODONTOGRAMA ========= */
    const selectedTeeth = {};

    const summaryList = document.getElementById('summary-list');
    const resumenProcPrincipal = document.getElementById('resumen-proc-principal');
    const odontoJson = document.getElementById('odontograma-json');
    const odontoResumen = document.getElementById('odontograma-resumen');

    function toothSVG(){
      return `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2c3.5 0 6 2.6 6 6.1 0 3.4-1.5 4.9-2.5 10-.3 1.6-2 1.9-2.9.6l-1-1.5-1 1.5c-.9 1.3-2.6 1-2.9-.6-1-5.1-2.5-6.6-2.5-10C5.2 4.6 8.5 2 12 2z"/></svg>`;
    }
    function crearBoton(num){
      const b = document.createElement('button');
      b.type='button'; b.className='tooth'; b.dataset.tooth=String(num);
      b.innerHTML = `<span class="tooth-num">${num}</span>${toothSVG()}<span class="tooth-badge">+ Proc.</span>`;
      b.addEventListener('click', ()=>openPanelTooth(num));
      return b;
    }

    function renderOdontograma(){
      const sup = document.getElementById('row-sup');
      const inf = document.getElementById('row-inf');
      sup.innerHTML = ''; inf.innerHTML = '';

      const supIzq = [18,17,16,15,14,13,12,11];
      const supDer = [21,22,23,24,25,26,27,28];
      const infIzq = [48,47,46,45,44,43,42,41];
      const infDer = [31,32,33,34,35,36,37,38];

      supIzq.forEach(n=> sup.appendChild(crearBoton(n)));
      const spacerSup = document.createElement('div'); spacerSup.style.width = '2px'; sup.appendChild(spacerSup);
      supDer.forEach(n=> sup.appendChild(crearBoton(n)));

      infIzq.forEach(n=> inf.appendChild(crearBoton(n)));
      const spacerInf = document.createElement('div'); spacerInf.style.width = '2px'; inf.appendChild(spacerInf);
      infDer.forEach(n=> inf.appendChild(crearBoton(n)));

      refreshBadges();
    }

    function refreshBadges(){
      document.querySelectorAll('.tooth').forEach(btn=>{
        const n = btn.dataset.tooth;
        btn.classList.toggle('has-procs', Array.isArray(selectedTeeth[n]) && selectedTeeth[n].length>0);
      });

      const items = Object.entries(selectedTeeth)
        .filter(([_,arr])=>arr && arr.length)
        .map(([tooth, arr])=>({ tooth, arr, total: arr.reduce((s,p)=>s+(p.price||0),0) }));

      summaryList.innerHTML = items.length
        ? items.map(it =>
            it.arr.map(p =>
              `<li>Diente ${it.tooth}: ${p.label} ‚Äî <strong>$${(p.price||0).toLocaleString('es-CO')}</strong></li>`
            ).join('')
          ).join('')
        : '<li>Sin procedimientos asignados.</li>';

      let lines = [];
      if(items.length){
        items.forEach(it=>{
          const procsText = it.arr.map(p=>`${p.label}`).join(', ');
          lines.push(`‚Ä¢ Diente ${it.tooth}: ${procsText} ‚Äî $${it.total.toLocaleString('es-CO')}`);
        });
      } else {
        lines.push('‚Ä¢ Sin procedimientos asignados.');
      }
      odontoResumen.value = (() => {
      // üîÅ Enviar a n8n EXACTAMENTE como se muestra en pantalla (1 l√≠nea = 1 procedimiento)
      let lines = [];
      if(items.length){
        items.forEach(it=>{
          it.arr.forEach(p=>{
            lines.push(`Diente ${it.tooth}: ${p.label} ‚Äî $${(p.price||0).toLocaleString('es-CO')}`);
          });
        });
      } else {
        lines.push('Sin procedimientos asignados.');
      }
      return lines.join('\n');
    })();

      const subt = items.reduce((s,it)=>s+it.total,0);
      const [ppName, ppPrice] = (procedimiento.value || "No aplica|0").split("|");
      if(ppName && ppName !== "No aplica"){
        resumenProcPrincipal.textContent = `${ppName} - $${parseMoney(ppPrice).toLocaleString('es-CO')}`;
      } else {
        resumenProcPrincipal.textContent = "No aplica";
      }
      odontoJson.value = JSON.stringify(selectedTeeth);

      calcularTotal();
    }

    /* ==========================
       Modal + buscador
       ========================== */
    const backdrop = document.getElementById('panel-backdrop');
    const procsContainer = document.getElementById('procs-container');
    const lblTooth = document.getElementById('panel-tooth');
    const panelTitle = document.getElementById('panel-title');
    const btnSave = document.getElementById('btn-save');
    const btnClear = document.getElementById('btn-clear');
    const btnClose = document.getElementById('btn-close');
    const procSearch = document.getElementById('proc-search');
    const procCount = document.getElementById('proc-count');

    let currentTooth = null;
    let panelMode = "tooth"; // "tooth" | "principal"
    let tempSelections = []; // üîß mantiene selecci√≥n mientras el modal est√° abierto

    function renderProcRows(filterText = ""){
      const q = String(filterText || "").trim().toLowerCase();
      const base = PROC_CATALOGO || [];
      const list = q ? base.filter(p => String(p.label).toLowerCase().includes(q)) : base;

      procCount.textContent = `${list.length} items`;
      procsContainer.innerHTML = "";

      if(!PROC_READY){
        const msg = document.createElement("div");
        msg.style.padding = "10px";
        msg.style.color = "#a33";
        msg.innerHTML = "‚ö†Ô∏è No se pudo cargar el cat√°logo desde Supabase. Revisa RLS/Policies o conexi√≥n.";
        procsContainer.appendChild(msg);
        return;
      }

      if(!list.length){
        const empty = document.createElement("div");
        empty.style.padding = "10px";
        empty.style.color = "#667";
        empty.textContent = "No hay resultados para la b√∫squeda.";
        procsContainer.appendChild(empty);
        return;
      }

      const selectedPrincipal = (procedimiento.value || "No aplica|0").split("|")[0];

      list.forEach(proc=>{
        const row = document.createElement('div');
        row.className='proc-row';
        row.dataset.key = proc.key;
        row.dataset.label = proc.label;

        const name = document.createElement('label');
        name.textContent = proc.label;

        const profesional = document.createElement("div");
profesional.textContent = proc.profesional
  ? `Profesional: ${proc.profesional}`
  : "Profesional: ‚Äî";

profesional.style.fontSize = "11px";
profesional.style.fontWeight = "600";
profesional.style.color = "#64748b";
profesional.style.marginTop = "2px";


        const check = document.createElement('input');
        check.className='proc-check';

        // ‚úÖ Si es modo "principal" usamos RADIO (una sola selecci√≥n)
        if(panelMode === "principal"){
          check.type = "radio";
          check.name = "principal_pick";
        }else{
          check.type = 'checkbox';
        }

        const price = document.createElement('input');
        price.type='number';
        price.className='price';
        price.min='0';
        price.step='1000';
        price.placeholder = proc.price == null ? "Sin precio" : "";
        price.value = proc.price == null ? "" : String(proc.price);

        if(panelMode === "principal"){
          // Para principal: el precio no se edita aqu√≠ (lo toma del cat√°logo)
          price.disabled = true;
          price.style.opacity = "1";
          price.style.background = "#fff";
        }

        if(panelMode === "principal"){
          if(String(proc.label).trim().toLowerCase() === String(selectedPrincipal).trim().toLowerCase()){
            check.checked = true;
          }
          // click en toda la fila selecciona
          row.addEventListener("click", (e)=>{
            if(e.target.tagName.toLowerCase() === "input") return;
            check.checked = true;
          });
        }else{
          const baseArr = tempSelections.length ? tempSelections : (selectedTeeth[currentTooth]||[]);
          const existing = baseArr.find(p=>String(p.key)===String(proc.key));
          if(existing){
            check.checked = true;
            price.value = existing.price != null ? String(existing.price) : (proc.price == null ? "" : String(proc.price));
          }

          // ‚úÖ al marcar / desmarcar
          check.addEventListener("change", ()=>{
            const priceVal = parseMoney(price.value);
            if(check.checked){
              tempSelections = tempSelections.filter(p=>p.key!==proc.key);
              tempSelections.push({ key: proc.key, label: proc.label, price: priceVal||0 });
            }else{
              tempSelections = tempSelections.filter(p=>p.key!==proc.key);
            }
            if(check.checked && !parseMoney(price.value)){
              price.focus();
            }
          });

          // ‚úÖ FIX REAL: al EDITAR el precio, actualizar tempSelections
          price.addEventListener("input", ()=>{
            if(!check.checked) return;
            const priceVal = parseMoney(price.value);
            const idx = tempSelections.findIndex(p=>p.key===proc.key);
            if(idx >= 0){
              tempSelections[idx].price = priceVal;
            }else{
              tempSelections.push({ key: proc.key, label: proc.label, price: priceVal });
            }
          });
        }

        const nameWrap = document.createElement("div");
nameWrap.appendChild(name);
nameWrap.appendChild(profesional);

row.appendChild(nameWrap);

        row.appendChild(check);
        row.appendChild(price);
        procsContainer.appendChild(row);
      });
    }

    async function openPanelTooth(toothNumber){
      tempSelections = [...(selectedTeeth[String(toothNumber)]||[])];
      panelMode = "tooth";
      currentTooth = String(toothNumber);
      panelTitle.childNodes[0].nodeValue = "Procedimientos diente ";
      lblTooth.textContent = currentTooth;

      if(!PROC_READY){
        await cargarCatalogoDesdeSupabase();
      }

      procSearch.value = "";
      renderProcRows("");
      backdrop.style.display='flex';
      procSearch.focus();
    }

    async function openPanelPrincipal(){
      panelMode = "principal";
      currentTooth = null;
      panelTitle.childNodes[0].nodeValue = "Procedimiento principal";
      lblTooth.textContent = "";

      if(!PROC_READY){
        await cargarCatalogoDesdeSupabase();
      }

      procSearch.value = "";
      renderProcRows("");
      backdrop.style.display='flex';
      procSearch.focus();
    }

    function closePanel(){
      backdrop.style.display='none';
      currentTooth=null;
      panelMode="tooth";
    }

    btnClose.addEventListener('click', closePanel);
    backdrop.addEventListener('click', e=>{ if(e.target===backdrop) closePanel(); });
    procSearch.addEventListener("input", (e)=> renderProcRows(e.target.value));

    btnSave.addEventListener('click', ()=>{
      if(panelMode === "principal"){
        const picked = procsContainer.querySelector('input[type="radio"][name="principal_pick"]:checked');
        if(!picked){
          procedimiento.value = "No aplica|0";
          syncProcedimientoDisplay();
          calcularTotal();
          closePanel();
          return;
        }
        const row = picked.closest(".proc-row");
        const label = row.dataset.label;
        const priceEl = row.querySelector(".price");
        const price = parseMoney(priceEl.value);

        procedimiento.value = `${label}|${price}`;
        syncProcedimientoDisplay();
        calcularTotal();
        closePanel();
        return;
      }

      // modo tooth (igual que ten√≠as)
      if(!currentTooth) return;

      const rows = procsContainer.querySelectorAll('.proc-row');
      const next = [...tempSelections];

      rows.forEach(row=>{
        const check = row.querySelector('.proc-check');
        const priceEl = row.querySelector('.price');
        if(!check.checked) return;

        const price = parseMoney(priceEl.value);
        if(price <= 0) return;

        next.push({ key: row.dataset.key, label: row.dataset.label, price });
      });

      // üîí evitar procedimientos duplicados por diente
      const uniqueMap = new Map();
      next.forEach(p => {
        if(!uniqueMap.has(p.key)){
          uniqueMap.set(p.key, p);
        }
      });
      const unique = Array.from(uniqueMap.values());

      if(unique.length) selectedTeeth[currentTooth]=unique;
      else delete selectedTeeth[currentTooth];
      tempSelections = [];

      refreshBadges();
      closePanel();
    });

    btnClear.addEventListener('click', ()=>{
      if(panelMode === "principal"){
        procedimiento.value = "No aplica|0";
        syncProcedimientoDisplay();
        calcularTotal();
        closePanel();
        return;
      }

      if(!currentTooth) return;
      delete selectedTeeth[currentTooth];
      refreshBadges();
      closePanel();
    });

    // ‚úÖ Abrir modal al tocar el campo de procedimiento principal
    procedimientoDisplay.addEventListener("click", openPanelPrincipal);

    function odontogramaSubtotal(){
      return Object.values(selectedTeeth).reduce((acc, arr)=> acc + arr.reduce((s,p)=>s+(p.price||0),0), 0);
    }

    function calcularTotal(){
      let subtotal = 0;

      const [nProc, pProc] = (procedimiento.value || "No aplica|0").split("|");
      if (procedimiento.value !== "No aplica|0") {
        subtotal += parseMoney(pProc);
        document.querySelector('input[name="procedimiento"]').value =
          `${nProc} - $${parseMoney(pProc).toLocaleString('es-CO')}`;
      } else {
        document.querySelector('input[name="procedimiento"]').value = "No aplica";
      }

      const adics = [];
      adicionales.forEach(cb=>{
        if(cb.checked){
          const [nA, pA] = cb.value.split("|");
          adics.push(`${nA} - $${parseMoney(pA).toLocaleString('es-CO')}`);
          subtotal += parseMoney(pA);
        }
      });
      document.querySelector('input[name="adicionales[]"]').value = adics.join("<br>");

      subtotal += odontogramaSubtotal();

      const porc = parseInt(descuentoSel.value,10) || 0;
      const vDesc = Math.round(subtotal * (porc/100));
      const total = subtotal - vDesc;

      document.getElementById('subtotal').textContent = subtotal.toLocaleString('es-CO');
      document.getElementById('valor-descuento').textContent = vDesc.toLocaleString('es-CO');
      document.getElementById('total').textContent = total.toLocaleString('es-CO');

      document.getElementById('input-subtotal').value = subtotal;
      document.getElementById('input-descuento').value = vDesc;
      document.getElementById('input-total').value = total;
    }

    window.addEventListener('load', async ()=>{
      await cargarCatalogoDesdeSupabase();
      renderOdontograma();
      syncProcedimientoDisplay();
      calcularTotal();
    });

    // si el select cambia por c√≥digo, mantenemos el display sincronizado
    procedimiento.addEventListener('change', ()=>{
      syncProcedimientoDisplay();
      calcularTotal();
    });
    descuentoSel.addEventListener('change', () => {
  if (typeof window.calcularTotal === "function") {
    window.calcularTotal(); // versi√≥n envuelta
  }
});

    adicionales.forEach(cb=> cb.addEventListener('change', calcularTotal));

    /* ===== Firma ===== */
    const canvas = document.getElementById('firma');
    const ctx = canvas.getContext('2d');
    let dibujando=false;

    function getCoords(e){
      if(e.touches && e.touches.length){
        const r=canvas.getBoundingClientRect();
        return {x:e.touches[0].clientX-r.left, y:e.touches[0].clientY-r.top};
      }
      return {x:e.offsetX, y:e.offsetY};
    }

    canvas.addEventListener('mousedown', e=>{ dibujando=true; const {x,y}=getCoords(e); ctx.beginPath(); ctx.moveTo(x,y); });
    canvas.addEventListener('mousemove', e=>{ if(!dibujando) return; const {x,y}=getCoords(e); ctx.lineTo(x,y); ctx.stroke(); });
    ['mouseup','mouseleave'].forEach(ev=> canvas.addEventListener(ev, ()=> dibujando=false ));
    canvas.addEventListener('touchstart', e=>{ e.preventDefault(); dibujando=true; const {x,y}=getCoords(e); ctx.beginPath(); ctx.moveTo(x,y); });
    canvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(!dibujando) return; const {x,y}=getCoords(e); ctx.lineTo(x,y); ctx.stroke(); });
    canvas.addEventListener('touchend', ()=> dibujando=false );

    function limpiarFirma(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
    window.limpiarFirma = limpiarFirma;

    document.getElementById('cotizacion-form').addEventListener('submit', ()=>{
      document.getElementById('firmaInput').value = canvas.toDataURL();
    });

    /* ==========================
       Guardar silencioso
       ========================== */
    const WEBHOOK_GUARDAR = "https://ftth-n8n2.pzveh5.easypanel.host/webhook/248f724f-7598-4fba-831c-433662969810";
    const btnGuardar = document.getElementById("btn-guardar");
    const form = document.getElementById("cotizacion-form");

    btnGuardar.addEventListener("click", async () => {
      try {
        calcularTotal();
        document.getElementById('firmaInput').value = canvas.toDataURL();

        const fd = new FormData(form);
        const resp = await fetch(WEBHOOK_GUARDAR, { method: "POST", body: fd });

        if (!resp.ok) throw new Error("HTTP " + resp.status);
        alert("Guardado ‚úÖ");
      } catch (e) {
        console.error(e);
        alert("No se pudo guardar. Intenta de nuevo.");
      }
    });

    /* ====== CARGA POR C√âDULA (n8n) ====== */
    const cedulaInput = document.getElementById('cedula');
    const hint = document.getElementById('cedula-hint');

    function setHintHTML(html, color="#666"){ hint.innerHTML = html||""; hint.style.color = color; }
    function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
    function parseNicePair(str){
      if(!str) return null;
      const m = String(str).match(/^\s*(.*?)\s*-\s*\$\s*([\d\., ]+)\s*$/);
      if(!m) return { name: String(str).trim(), price: null };
      const name = m[1].trim();
      const price = parseInt(m[2].replace(/[^\d]/g,''), 10) || 0;
      return { name, price };
    }
    function markAdicional(nombre, precio){
      let raw = null;
      if(nombre && Number.isFinite(precio) && precio>0) raw = `${nombre}|${precio}`;
      if(raw){
        const m1 = Array.from(adicionales).find(cb => cb.value === raw);
        if(m1){ m1.checked = true; return true; }
      }
      const m2 = Array.from(adicionales).find(cb => cb.value.split('|')[0].trim().toLowerCase() === String(nombre||'').trim().toLowerCase());
      if(m2){ m2.checked = true; return true; }
      return false;
    }
    function selectProcedimiento(nombre, precio){
      if(!nombre) return false;
      const raw = (Number.isFinite(precio) && precio>0) ? `${nombre}|${precio}` : null;
      if(raw){
        const o1 = Array.from(procedimiento.options).find(o => o.value === raw);
        if(o1){ procedimiento.value = o1.value; return true; }
      }
      const o2 = Array.from(procedimiento.options).find(o => o.value.split('|')[0].trim().toLowerCase() === nombre.trim().toLowerCase());
      if(o2){ procedimiento.value = o2.value; return true; }
      return false;
    }

    function loadFromWebhook(data){
      if(!data || !data.encontrado){ setHintHTML("‚úîÔ∏è Paciente nuevo.", "#1e8449"); return; }

      if (data.nombre)  document.getElementById('nombre').value  = data.nombre;
      if (data.correo)  document.getElementById('correo').value  = data.correo;
      if (data.celular) document.getElementById('celular').value = data.celular;
      if (typeof data.observaciones === "string") document.getElementById('observaciones').value = data.observaciones;
      if (typeof data.Firma === "string" && data.Firma.startsWith("data:image")) {
  const canvas = document.getElementById("firma");
  const inputFirma = document.getElementById("firmaInput");

  if (canvas) {
    const ctx = canvas.getContext("2d");

    // Limpiar canvas previo
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const img = new Image();
    img.onload = function () {
      // Ajustar canvas al tama√±o visual
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;

      // Configurar estilo de trazo
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "#000";

      // Dibujar firma
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      // ‚úÖ Guardar tambi√©n en el input oculto (clave para PDF)
      if (inputFirma) {
        inputFirma.value = data.Firma;
      }
    };
    img.src = data.Firma;
  }
}

      

      let pn=null, pp=null;
      if (data.procedimientoRaw){ const [n,p] = String(data.procedimientoRaw).split('|'); pn=n; pp=parseInt(p,10)||null; }
      else if(data.procedimiento){ const pr = parseNicePair(data.procedimiento); if(pr){ pn=pr.name; pp=pr.price; } }
      if(pn) selectProcedimiento(pn, pp);

      // ‚úÖ sincronizar display del procedimiento principal
      syncProcedimientoDisplay();

      adicionales.forEach(cb=> cb.checked=false);
      if (Array.isArray(data.adicionalesRaw)){
        data.adicionalesRaw.forEach(s=>{ const [n,p] = String(s).split('|'); markAdicional(n, parseInt(p,10)||null); });
      } else if (typeof data.adicionales === 'string'){
        data.adicionales.split(/\n|,/).map(s=>s.trim()).filter(Boolean).forEach(item=>{
          const pr = parseNicePair(item); if(pr) markAdicional(pr.name, pr.price);
        });
      }

      if (typeof data.descuento === "number"){
        const op = Array.from(descuentoSel.options).find(o => parseInt(o.value,10) === data.descuento);
        if(op) descuentoSel.value = String(data.descuento);
      }

      const odoStr = data.odontogramaJSON || data.odontograma;
      if (odoStr){
        try{
          const parsed = JSON.parse(odoStr);
          Object.keys(selectedTeeth).forEach(k=> delete selectedTeeth[k]);
          Object.assign(selectedTeeth, parsed);
          refreshBadges();
        }catch(e){ console.warn("odontograma inv√°lido:", e); }
      }

      const fecha = data.fecha ? ` el ${escapeHtml(data.fecha)}` : "";
      const nombre = data.nombre ? ` (${escapeHtml(data.nombre)})` : "";
      setHintHTML(`‚ö†Ô∏è Paciente ya valorado${fecha}${nombre}.`, "#c0392b");

     // ==========================
// ‚úÖ CARGAR ABONO DESDE N8N
// ==========================
if (data.abono_valor !== undefined && data.abono_valor !== null) {
  const abonoInput = document.getElementById("abono");
  if (abonoInput) {
    abonoInput.value = Number(data.abono_valor) || 0;
  }
}

      
      calcularTotal();

    // Forzar recalculo visual con abono
setTimeout(() => {
  if (typeof window.calcularTotal === "function") {
    window.calcularTotal();
  }
}, 0);

    }

    let lastQuery = "";
    document.getElementById('cedula').addEventListener('blur', ()=>{
      const ced = cedulaInput.value.trim();
      if(!ced || ced===lastQuery) return; lastQuery=ced;
      setHintHTML("Buscando historial del paciente...");
      fetch("https://ftth-n8n2.pzveh5.easypanel.host/webhook/db28876e-aa9c-4015-a0b0-8f6411989681?cedula="+encodeURIComponent(ced))
        .then(r=>{ if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); })
        .then(loadFromWebhook)
        .catch(()=> setHintHTML("No fue posible verificar. Intenta de nuevo.", "#c0392b"));
    });

    function initCedulaFromQuery() {
      try {
        const params = new URLSearchParams(window.location.search);
        const cedula = (params.get("cedula") || "").trim();
        if (!cedula) return;

        const cedulaInput = document.getElementById("cedula");
        if (!cedulaInput) return;

        cedulaInput.value = cedula;
        cedulaInput.dispatchEvent(new Event("blur", { bubbles: true }));
      } catch (e) {
        console.warn("No se pudo inicializar la c√©dula desde la URL:", e);
      }
    }
    document.addEventListener("DOMContentLoaded", initCedulaFromQuery);
  
    /* ======================================================
       üîÅ AUTOLLENADO DESDE HISTORIA CL√çNICA (LOCALSTORAGE)
       ====================================================== */
    document.addEventListener("DOMContentLoaded", () => {
  let paciente = null;

  try {
    paciente = JSON.parse(
      localStorage.getItem("paciente_plan_tratamiento") || "null"
    );
  } catch (e) {
    console.warn("Paciente inv√°lido en localStorage");
  }

  // üö´ Si no hay paciente, no hacemos nada
  if (!paciente) return;

  // ‚úÖ AUTOCOMPLETAR
  const nombre  = document.getElementById("nombre");
  const cedula  = document.getElementById("cedula");
  const celular = document.getElementById("celular");
  const correo  = document.getElementById("correo");

  if (nombre)  nombre.value  = paciente.nombre  || "";
  if (cedula)  cedula.value  = paciente.cedula  || "";
  if (celular) celular.value = paciente.celular || "";
  if (correo)  correo.value  = paciente.email   || "";

  // üßπüî• CLAVE: BORRAR DESPU√âS DE USAR
  localStorage.removeItem("paciente_plan_tratamiento");
});


  </script>

<!-- BOT√ìN ACTUALIZACI√ìN DE PRECIOS (AGREGADO) -->
<div style="position:fixed;bottom:20px;right:20px;z-index:9999;">
  <button
    onclick="window.location.href='actualizacion-precios.html'"
    style="
      padding:12px 16px;
      border-radius:10px;
      border:none;
      background:#2563eb;
      color:#fff;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.18);
    ">
    üí≤ Actualizaci√≥n de precios
  </button>
</div>


<!-- ================= MODAL ACTUALIZACI√ìN DE PRECIOS ================= -->
<style>
  #modal-precios{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:10000;
  }
  #modal-precios.show{ display:flex; }
  #modal-precios .modal-card{
    width:95vw;
    height:95vh;
    background:#fff;
    border-radius:14px;
    box-shadow:0 20px 40px rgba(0,0,0,.25);
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  #modal-precios .modal-head{
    padding:10px 14px;
    background:#f8fafc;
    border-bottom:1px solid #e5e7eb;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-weight:700;
  }
  #modal-precios iframe{
    flex:1;
    width:100%;
    border:none;
  }
  #modal-precios button{
    border:none;
    background:#dc2626;
    color:#fff;
    padding:6px 12px;
    border-radius:8px;
    cursor:pointer;
    font-weight:700;
  }
</style>

<div id="modal-precios">
  <div class="modal-card">
    <div class="modal-head">
      <span>Actualizaci√≥n de precios</span>
      <button onclick="cerrarModalPrecios()">‚úñ Cerrar</button>
    </div>
    <iframe src="actualizacion-precios.html"></iframe>
  </div>
</div>

<script>
  function abrirModalPrecios(){
    document.getElementById("modal-precios").classList.add("show");
  }
  function cerrarModalPrecios(){
    document.getElementById("modal-precios").classList.remove("show");
  }
function obtenerResumenParaFacturacion() {
  const resumen = {};

  Object.values(selectedTeeth).forEach(arr => {
    arr.forEach(p => {
      const nombre = String(p.label).trim();
      const procId = p.key; // ‚úÖ ESTE ES EL procedimiento_id REAL
      const precioReal = Number(p.price || 0);

      if (!resumen[nombre]) {
        resumen[nombre] = {
          procedimiento: nombre,
          procedimiento_id: procId, // ‚úÖ GUARDADO
          cantidad: 0,
          valor_total: 0,
          profesional: null // ‚úÖ NUEVO
        };
      }

      resumen[nombre].cantidad += 1;
      resumen[nombre].valor_total += precioReal;

      if (!resumen[nombre].profesional) {
        const found = (PROC_CATALOGO || []).find(p => String(p.key) === String(procId));
        resumen[nombre].profesional = found?.profesional || null;
      }
    });
  });

  return Object.values(resumen).map(r => ({
    procedimiento: r.procedimiento,
    procedimiento_id: r.procedimiento_id, // ‚úÖ
    cantidad: r.cantidad,
    valor_unitario:
      r.cantidad > 0 ? Math.round(r.valor_total / r.cantidad) : 0,
    valor_total: r.valor_total
  }));
}




async function obtenerProfesionalPorProcedimientoId(procedimientoId){
  try{
    const { data, error } = await window.supabase
      .from("procedimientos_precios")
      .select("profesional")
      .eq("id", procedimientoId)
      .single();
    if(error) throw error;
    return data?.profesional || null;
  }catch(e){
    console.error("Error obteniendo profesional:", e);
    return null;
  }
}


async function ejecutarFacturacion() {
  const cedula = document.getElementById("cedula")?.value?.trim();
  if (!cedula) {
    alert("Debe ingresar la c√©dula del paciente");
    return;
  }

  const items = obtenerResumenParaFacturacion();
  if (!items.length) {
    alert("No hay procedimientos para facturar");
    return;
  }

  await window.supabase
    .from("facturacion_temporal")
    .delete()
    .eq("cedula", cedula);

  const payload = [];
  for (const it of items){
    const profesional = await obtenerProfesionalPorProcedimientoId(it.procedimiento_id);
    payload.push({
      cedula,
      procedimiento: it.procedimiento,
      procedimiento_id: it.procedimiento_id, // ‚úÖ AHORA S√ç
      cantidad: it.cantidad,
      valor_unitario: it.valor_unitario,
      valor_total: it.valor_total,
      profesional // ‚úÖ PROFESIONAL REAL DESDE SUPABASE
    });
  }

  const { error } = await window.supabase
    .from("facturacion_temporal")
    .insert(payload);

  if (error) {
    console.error(error);
    alert("Error enviando a facturaci√≥n");
    return;
  }

  window.location.href =
    `facturacion.html?paciente_cedula=${encodeURIComponent(cedula)}`;
}


  
</script>


<!-- BOT√ìN ACTUALIZACI√ìN DE PRECIOS (MODAL) -->
<div style="position:fixed;bottom:20px;right:20px;z-index:9999;">
  <button
    onclick="abrirModalPrecios()"
    style="
      padding:12px 16px;
      border-radius:10px;
      border:none;
      background:#2563eb;
      color:#fff;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.18);
    ">
    üí≤ Actualizaci√≥n de precios
  </button>
</div>


<!-- ================= FIX DESFASE FIRMA CANVAS (NO MODIFICA LOGICA EXISTENTE) ================= -->
<script>
(function(){
  function ajustarCanvasFirma(canvas){
    if(!canvas) return;

    const rect = canvas.getBoundingClientRect();
    if(rect.width === 0 || rect.height === 0) return;

    // Ajustar tama√±o REAL al tama√±o visual
    canvas.width  = rect.width;
    canvas.height = rect.height;

    const ctx = canvas.getContext("2d");
    if(ctx){
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "#000";
    }
  }

  function ajustarTodos(){
    document.querySelectorAll("canvas.firma-canvas").forEach(c => {
      ajustarCanvasFirma(c);
    });
  }

  // Al cargar DOM
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", ajustarTodos);
  } else {
    ajustarTodos();
  }

  // Al redimensionar ventana (responsive / m√≥vil)
  window.addEventListener("resize", () => {
    setTimeout(ajustarTodos, 100);
  });

  // Exponer por si alg√∫n modal lo necesita manualmente
  window.__ajustarCanvasFirma = ajustarCanvasFirma;
})();
</script>


<!-- ================= FIX DEFINITIVO DESFASE FIRMA (ESCALA + COORDENADAS) ================= -->
<script>
(function(){
  function fixCanvas(canvas){
    if(!canvas) return;
    const ctx = canvas.getContext("2d");
    if(!ctx) return;

    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;

    // Ajuste REAL = visual * DPR
    canvas.width  = Math.round(rect.width * dpr);
    canvas.height = Math.round(rect.height * dpr);

    // Escalar contexto
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.strokeStyle = "#000";

    // Normalizador universal de eventos
    canvas.__getPoint = function(evt){
      const r = canvas.getBoundingClientRect();
      let x, y;
      if(evt.touches && evt.touches[0]){
        x = evt.touches[0].clientX - r.left;
        y = evt.touches[0].clientY - r.top;
      } else {
        x = evt.clientX - r.left;
        y = evt.clientY - r.top;
      }
      return { x, y };
    };
  }

  function aplicar(){
    document.querySelectorAll("canvas.firma-canvas, canvas").forEach(c => {
      fixCanvas(c);
    });
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", aplicar);
  } else {
    aplicar();
  }

  window.addEventListener("resize", ()=> setTimeout(aplicar,150));

})();
</script>


<script>
/* ==========================
   ‚úÖ ABONO (AGREGADO)
   - Recalcula "Total a pagar" restando el abono
   - Env√≠a el valor a n8n como "abono_valor"
   - Mantiene subtotal y descuento iguales
   - SIN modificar funciones existentes (se envuelve calcularTotal)
   ========================== */
(function(){
  function num(v){
    return Number(String(v ?? "").replace(/[^\d]/g,"")) || 0;
  }
  function clamp0(n){ return n < 0 ? 0 : n; }

  function aplicarAbonoPostCalculo(){
    const abonoInput = document.getElementById("abono");
    const totalSpan  = document.getElementById("total");
    const inputTotal = document.getElementById("input-total");
    if(!abonoInput || !totalSpan || !inputTotal) return;

    const abono = num(abonoInput.value);
    const totalBase = num(inputTotal.value);

    const totalFinal = clamp0(totalBase - abono);

    // UI
    totalSpan.textContent = totalFinal.toLocaleString("es-CO");

    // Hidden (lo que llega a n8n)
    inputTotal.value = String(totalFinal);

    // (opcional √∫til) exponer en window para depuraci√≥n
    window.__ABONO_VALOR = abono;
    window.__TOTAL_A_PAGAR = totalFinal;
  }

  // ‚úÖ Envolver calcularTotal SIN editar su cuerpo
  if(typeof window.calcularTotal === "function" && !window.__CALCULO_ABONO_ENVUELTO){
    const _calcularTotal = window.calcularTotal;
    window.calcularTotal = function(){
      _calcularTotal.apply(this, arguments);
      aplicarAbonoPostCalculo();
    };
    window.__CALCULO_ABONO_ENVUELTO = true;
  }

  // ‚úÖ Recalcular al digitar abono
  document.addEventListener("DOMContentLoaded", ()=>{
    const abonoInput = document.getElementById("abono");
    if(abonoInput){
      abonoInput.addEventListener("input", ()=> {
        if(typeof window.calcularTotal === "function") window.calcularTotal();
        else aplicarAbonoPostCalculo();
      });
    }
    // Forzar 1 vez al cargar
    setTimeout(()=> {
      if(typeof window.calcularTotal === "function") window.calcularTotal();
      else aplicarAbonoPostCalculo();
    }, 0);
  });
})();
</script>


<!-- ==========================
     ‚úÖ MODAL / NODAL DE IMPRESI√ìN PDF (AGREGADO)
     - NO afecta el dise√±o normal
     - Arma un documento independiente para imprimir
     ========================== -->
<style>
  /* Solo UI del modal (no toca estilos existentes) */
  #modal-impresion-pdf{
    position: fixed;
    inset: 0;
    background: rgba(2,6,23,.65);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 16px;
    z-index: 20000;
  }
  #modal-impresion-pdf.show{ display: flex; }

  #modal-impresion-pdf .card{
    width: 96vw;
    height: 96vh;
    max-width: 980px;
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 20px 60px rgba(0,0,0,.35);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    border: 1px solid #e5e7eb;
  }
  #modal-impresion-pdf .head{
    padding: 10px 14px;
    background: #f8fafc;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    font-weight: 800;
    color: #0f172a;
    font-family: var(--font);
  }
  #modal-impresion-pdf .head small{
    font-weight: 700;
    color: #64748b;
  }
  
  #modal-impresion-pdf iframe{
    flex: 1;
    width: 100%;
    border: none;
    background: #fff;
  }
</style>

<style>
/* =========================================================
   FIX DEFINITIVO COLORES BOTONES MODAL IMPRESI√ìN PDF
   NO rompe nada existente
   ========================================================= */
/* ===============================
   FIX DEFINITIVO BOTONES MODAL PDF
   =============================== */

#modal-impresion-pdf .head button{
  background: #1CD4BB !important;
  color: #fff !important;

  height: 36px;                 /* üî• MISMA ALTURA REAL */
  padding: 0 14px;              /* horizontal solamente */

  border-radius: 10px;
  font-weight: 800;
  font-size: 13px;
  line-height: 1;

  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;

  white-space: nowrap;          /* üî• CLAVE: NO SALTO DE L√çNEA */
  flex-wrap: nowrap;

  border: none;
  cursor: pointer;
  box-shadow: 0 6px 14px rgba(0,0,0,.18);
}

#modal-impresion-pdf .head button:hover{
  background: #16bfb0 !important;
  transform: translateY(-1px);
}

/* ‚ùå Cerrar */
#modal-impresion-pdf .head button:last-child{
  background: #dc2626 !important;
}
#modal-impresion-pdf .head button:last-child:hover{
  background: #991b1b !important;
}

</style>

  
<div id="modal-impresion-pdf" aria-hidden="true">
  <div class="card" role="dialog" aria-modal="true" aria-label="Impresi√≥n PDF">
    <div class="head">
      <div>
        Vista de impresi√≥n <small>(solo para PDF)</small>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button type="button" onclick="imprimirDesdeModal()">üñ®Ô∏è Imprimir</button>
       <button type="button" onclick="enviarPDFaN8n()">üì§ Enviar a paciente</button>
       <button type="button" onclick="cerrarModalImpresionPDF()">‚úñ Cerrar</button>

      </div>
    </div>
    <iframe id="frame-impresion-pdf" title="Documento para imprimir"></iframe>
  </div>
</div>

<script>
/* ==========================
   ‚úÖ IMPRESI√ìN PDF EN NODAL (AGREGADO)
   Requisitos:
   - NO incluir odontograma (gr√°fico)
   - NO incluir alerta "‚ö†Ô∏è Paciente ya valorado..."
   - NO incluir "Procedimientos adicionales"
   - Mostrar info paciente compacta (sin inputs visibles)
   - Incluir logo y encabezado azul #143F80 con texto blanco
   ========================== */
(function(){
  const LOGO_URL = "https://static.wixstatic.com/media/63e6ec_9054e2ab657a462c96582969b5dbbf4d~mv2.png/v1/fill/w_480,h_303,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/LOGO%204%20RECORTADO.png";

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll("\"","&quot;")
      .replaceAll("'","&#039;");
  }

  function getText(id){
    const el = document.getElementById(id);
    return (el && el.textContent ? el.textContent : "").trim();
  }
  function getVal(id){
    const el = document.getElementById(id);
    return (el && "value" in el ? el.value : "").trim();
  }

  function abrirModalImpresionPDF(){
    const modal = document.getElementById("modal-impresion-pdf");
    if(modal){
      modal.classList.add("show");
      modal.setAttribute("aria-hidden","false");
    }
  }

  function cerrarModalImpresionPDF(){
    const modal = document.getElementById("modal-impresion-pdf");
    if(modal){
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden","true");
    }
    const iframe = document.getElementById("frame-impresion-pdf");
    if(iframe){
      try{ iframe.src = "about:blank"; }catch(e){}
    }
  }

  window.cerrarModalImpresionPDF = cerrarModalImpresionPDF;

  function construirDocumentoParaImprimir(){
    const firmaBase64 = document.getElementById("firmaInput")?.value || "";

    // Mantener c√°lculos actuales (sin tocar l√≥gica)
    try{
      if(typeof window.calcularTotal === "function"){ window.calcularTotal(); }
    }catch(e){}

    const fechaHora = esc(getText("fecha-hora"));
    const nombre = esc(getVal("nombre"));
    const cedula = esc(getVal("cedula"));
    const celular = esc(getVal("celular"));
    const correo = esc(getVal("correo"));

    const resumenList = document.getElementById("summary-list");
    const resumenItems = resumenList ? resumenList.innerHTML : "";

    const procPrincipal = esc((document.getElementById("resumen-proc-principal")?.textContent || "").trim());

    const subtotal = esc(getText("subtotal"));
    const descuento = esc(getText("valor-descuento"));
    const total = esc(getText("total"));
    const abono = esc(getVal("abono"));
    const observaciones = esc(getVal("observaciones"));

    const doc = `
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Plan de tratamiento</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>

  html, body {
    margin: 0;
    padding: 0;
   }

    :root{
      --blue:#143F80;
      --ink:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;
      --font: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{ box-sizing:border-box; }
    body{
      font-family: var(--font);
      margin:0;
      color: var(--ink);
    }

.page {
  border: 1px solid #d1d5db;
  border-radius: 6px;
  padding: 16px;
  background: white;
}

    /* Encabezado (franja azul) */
   .header{
  background: var(--blue);
  padding: 48px 20px;
  color:#fff;

  /* üî• CLAVE VISUAL */
  margin: -18px -20px 16px -20px;

  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
}

    .header .title{
      font-weight: 900;
      font-size: 26px;
      line-height: 1.15;
      margin: 0;
      padding-right: 170px;
      text-align:center;
    }
    .header img{
      position:absolute;
      top: 12px;
      right: 18px;
      width: 145px;
      height: auto;
    }


    /* Bloque de datos compacto (sin inputs) */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 18px;
      margin-top: 10px;
      padding: 12px 12px;
      border:1px solid var(--line);
      border-radius: 12px;
    }
    .item{
      font-size: 12.5px;
      line-height: 1.25;
      color: var(--ink);
    }
    .item .lbl{
      font-weight: 800;
      color: var(--muted);
      margin-right: 6px;
    }
    .item.full{ grid-column: 1 / -1; }

    .section{
      margin-top: 14px;
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
    }
    .section h3{
      margin: 0 0 8px;
      font-size: 14px;
      font-weight: 900;
      color: var(--ink);
    }
    ul{
      margin: 0;
      padding-left: 18px;
      font-size: 12.5px;
      color: var(--ink);
    }
    li{ margin: 4px 0; }

    .totales{
      margin-top: 14px;
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      display:block;
      font-size: 13px;
    }
    .totales .row{
      display:flex;
      justify-content:flex-start;
      gap: 10px;
      padding: 4px 0;
      border-bottom: 1px dashed #eef2f7;
    }
    .totales .row:last-child{ border-bottom:none; }
    .totales .k{ font-weight: 900; }
    .totales .v{ font-weight: 800; }

    .obs{
      margin-top: 14px;
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      font-size: 12.5px;
      white-space: pre-wrap;
      min-height: 54px;
    }

    @page { margin: 14mm; }

    /* Mantener fondos en impresi√≥n */
    @media print{
      .header{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }

  </style>
</head>
<body>
  <div class="header">
    <img src="${LOGO_URL}" alt="Logo">
    <h1 class="title">PLAN DE TRATAMIENTO<br></h1>
  </div>

  <div class="page">
    <div class="grid">
      <div class="item full"><span class="lbl">Fecha y hora:</span>${fechaHora}</div>
      <div class="item"><span class="lbl">Paciente:</span>${nombre}</div>
      <div class="item"><span class="lbl">C√©dula:</span>${cedula}</div>
      <div class="item"><span class="lbl">Celular:</span>${celular}</div>
      <div class="item"><span class="lbl">Correo:</span>${correo}</div>
      <div class="item full"><span class="lbl">Procedimiento principal:</span>${procPrincipal || "No aplica"}</div>
    </div>

    <div class="section">
      <h3>Resumen por diente</h3>
      <ul>${resumenItems || "<li>Sin procedimientos asignados.</li>"}</ul>
    </div>

    <div class="totales">
      <div class="row"><span class="k">Subtotal</span><span class="v">$ ${subtotal || "0"}</span></div>
      <div class="row"><span class="k">Descuento</span><span class="v">$ ${descuento || "0"}</span></div>
      <div class="row"><span class="k">Abono</span><span class="v">$ ${abono || "0"}</span></div>
      <div class="row"><span class="k">Total a pagar</span><span class="v">$ ${total || "0"}</span></div>
    </div>

    <div class="section">
      <h3>Observaciones</h3>
      <div class="obs">${observaciones || ""}</div>
    </div>
  
    <div class="section">
  <h3>Firma del profesional</h3>

  ${
    firmaBase64
      ? `<img src="${firmaBase64}" style="max-width:220px;max-height:90px;display:block;margin-bottom:6px;">`
      : `<div class="obs" style="min-height:70px;"></div>`
  }

  <div style="margin-top:6px;font-size:12px;font-weight:700;">
  </div>
</div>


  </div>
  
</body>
</html>
    `;
    return doc;
  }

  // ‚úÖ Funci√≥n pedida por el bot√≥n
  window.imprimirPDF = function(){
    abrirModalImpresionPDF();

    const iframe = document.getElementById("frame-impresion-pdf");
    if(!iframe) return;

    const docHTML = construirDocumentoParaImprimir();

    const writeAndPrint = () => {
      try{
        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(docHTML);
        doc.close();

        // esperar fuentes / im√°genes
        setTimeout(()=>{
          try{
            iframe.contentWindow.focus();
            // iframe.contentWindow.print(); // impresi√≥n autom√°tica desactivada
          }catch(e){}
        }, 350);
      }catch(e){
        console.error("No se pudo preparar impresi√≥n:", e);
      }
    };

    // Para asegurar que contentWindow est√° listo
    if(iframe.contentWindow){
      writeAndPrint();
    }else{
      setTimeout(writeAndPrint, 50);
    }

    // Cerrar modal despu√©s de imprimir (cuando sea posible)
    try{
      iframe.contentWindow.onafterprint = () => {
        cerrarModalImpresionPDF();
      };
    }catch(e){}
  };
})();
</script>
<!-- ================= BOT√ìN IMPRIMIR PDF (FLOTANTE) ================= -->
<div style="position:fixed;bottom:80px;right:20px;z-index:9999;">
  <button
    onclick="imprimirPDF()"
    style="
      padding:12px 16px;
      border-radius:10px;
      border:none;
      background:#059669; /* verde elegante */
      color:#fff;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      gap:8px;
    ">
    üñ®Ô∏è Imprimir PDF
  </button>
</div>

<!-- ================= BOT√ìN FACTURACI√ìN (FLOTANTE) ================= -->
<div style="position:fixed;bottom:140px;right:20px;z-index:9999;">
  <button
    type="button"
    onclick="ejecutarFacturacion()"
    style="
      padding:12px 16px;
      border-radius:10px;
      border:none;
      background:#16a34a;
      color:#fff;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      gap:8px;
      width:auto;
    "
  >
    üí≥ Facturaci√≥n
  </button>
</div>

  
<!-- =========================
     ‚úÖ CAMPO FIJO NOMBRE DEL PROFESIONAL (FIX DEFINITIVO)
     - Se renderiza SIEMPRE debajo de la firma
     - Muestra placeholder aunque Supabase falle
     - Luego reemplaza por el nombre real si existe
     ========================= -->
<script>
(function(){
  function crearCampo(){
    const canvas = document.getElementById("firma");
    if(!canvas) return null;

    // Evitar duplicados
    if(document.getElementById("campo-profesional-firma")) return;

    const wrap = document.createElement("div");
    wrap.id = "campo-profesional-firma";
    wrap.style.marginTop = "8px";

    const label = document.createElement("div");
    label.textContent = "Nombre del profesional:";
    label.style.fontWeight = "700";
    label.style.fontSize = "12px";
    label.style.color = "#475569";
    label.style.marginBottom = "2px";

    const value = document.createElement("div");
    value.id = "nombre-profesional-firma";
    value.textContent = "‚Äî";
    value.style.fontWeight = "900";
    value.style.fontSize = "13px";
    value.style.color = "#0f172a";

    wrap.appendChild(label);
    wrap.appendChild(value);

    canvas.insertAdjacentElement("afterend", wrap);
    return value;
  }

  async function cargarNombre(){
    try{
      if(!window.supabase) return;

      const valueEl = crearCampo();
      if(!valueEl) return;

      const { data: { session } } = await window.supabase.auth.getSession();
      if(!session?.user?.email){
        valueEl.textContent = "No autenticado";
        return;
      }

      const email = String(session.user.email).trim();

      const { data, error } = await window.supabase
        .from("profesionales")
        .select("nombre")
        .ilike("correo", email)
        .limit(1)
        .maybeSingle();

      if(error){
        console.warn("RLS o error leyendo profesionales:", error);
        valueEl.textContent = "Profesional no registrado";
        return;
      }

      if(data?.nombre){
        valueEl.textContent = data.nombre;
        window.NOMBRE_PROFESIONAL = data.nombre;
      }else{
        valueEl.textContent = "Profesional no registrado";
      }
    }catch(e){
      console.warn("Error cargando nombre profesional:", e);
    }
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", cargarNombre);
  }else{
    cargarNombre();
  }
})();
</script>


<!-- =========================
     ‚úÖ ENVIAR NOMBRE DEL PROFESIONAL A N8N (AGREGADO)
     - NO modifica submit ni bot√≥n Guardar
     - Usa FormData existente
     - Campo enviado: profesional_nombre
     ========================= -->
<script>
(function(){
  function ensureHiddenInput(){
    const form = document.getElementById("cotizacion-form");
    if(!form) return null;

    let input = document.getElementById("input-profesional-nombre");
    if(input) return input;

    input = document.createElement("input");
    input.type = "hidden";
    input.name = "profesional_nombre";
    input.id = "input-profesional-nombre";
    input.value = "";

    form.appendChild(input);
    return input;
  }

  function syncNombreProfesional(){
    const input = ensureHiddenInput();
    if(!input) return;

    // Prioridad 1: variable global
    if(window.NOMBRE_PROFESIONAL){
      input.value = String(window.NOMBRE_PROFESIONAL);
      return;
    }

    // Prioridad 2: texto visible bajo firma
    const el = document.getElementById("nombre-profesional-firma");
    if(el && el.textContent && el.textContent.trim() && el.textContent.trim() !== "‚Äî"){
      input.value = el.textContent.trim();
      return;
    }

    input.value = "";
  }

  // Sincronizar al cargar
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", syncNombreProfesional);
  }else{
    syncNombreProfesional();
  }

  // Sincronizar antes de guardar / enviar
  document.addEventListener("click", (e)=>{
    const t = e.target;
    if(!t) return;

    if(
      t.id === "btn-guardar" ||
      (t.tagName === "BUTTON" && t.type === "submit")
    ){
      syncNombreProfesional();
    }
  });

})();
</script>


<!-- =========================
     ‚úÖ INSERTAR NOMBRE DEL PROFESIONAL EN EL PDF (AGREGADO)
     - NO modifica el constructor original del PDF
     - Inyecta el nombre justo antes de imprimir
     ========================= -->
<script>
(function(){
  if(typeof window.imprimirPDF !== "function") return;

  const _imprimirPDF = window.imprimirPDF;

  window.imprimirPDF = function(){
    // Ejecutar l√≥gica original
    _imprimirPDF.apply(this, arguments);

    // Inyectar nombre en el iframe antes de imprimir
    setTimeout(()=>{
      try{
        const iframe = document.getElementById("frame-impresion-pdf");
        if(!iframe || !iframe.contentDocument) return;

        const doc = iframe.contentDocument;
        const nombre = window.NOMBRE_PROFESIONAL || "";

        if(!nombre) return;

        // Buscar el bloque de firma
        const sections = Array.from(doc.querySelectorAll("h3"));
        const firmaTitle = sections.find(h => h.textContent.toLowerCase().includes("firma"));

        if(firmaTitle){
          const cont = firmaTitle.parentElement;
          if(cont && !cont.querySelector(".nombre-profesional-pdf")){
            const div = doc.createElement("div");
            div.className = "nombre-profesional-pdf";
            div.style.fontSize = "12px";
            div.style.fontWeight = "700";
            div.style.marginTop = "6px";
            div.textContent = nombre;
            cont.appendChild(div);
          }
        }
      }catch(e){
        console.warn("No se pudo insertar nombre profesional en PDF:", e);
      }
    }, 200);
  };
})();
</script>

</body>
</html>











<script>
window.imprimirDesdeModal = function(){
  const iframe = document.getElementById("frame-impresion-pdf");
  if(iframe && iframe.contentWindow){
    iframe.contentWindow.focus();
    iframe.contentWindow.print();
  }
};
</script>

<!-- =========================
     üîé DEBUG BOT√ìN ENVIAR N8N (AGREGADO)
     - Garantiza feedback visual
     - Reenv√≠a a la funci√≥n real
     ========================= -->
<script>
(function(){
  const __origEnviar = window.enviarPDFaN8n;
  window.enviarPDFaN8n = async function(){
    alert("Enviando PDF a n8n...");
    console.log("üì§ Click Enviar a n8n");
    if(typeof __origEnviar === "function"){
      return __origEnviar.apply(this, arguments);
    } else {
      alert("Funci√≥n enviarPDFaN8n no encontrada");
      console.error("enviarPDFaN8n no definida");
    }
  };
})();
</script>

<!-- =========================
     ‚úÖ FUNCI√ìN GLOBAL DEFINITIVA enviarPDFaN8n
     - Accesible desde cualquier bot√≥n / modal
     - No depende de m√≥dulos
     ========================= -->
<script>
window.enviarPDFaN8n = async function(){
  try{
    const iframe = document.getElementById("frame-impresion-pdf");
    if(!iframe || !iframe.contentWindow){
      alert("Primero debes generar el PDF.");
      return;
    }

    // Esperar contenido real
    let html = "";
    for(let i=0;i<10;i++){
      html = iframe.contentWindow.document.documentElement.outerHTML || "";
      if(html.length > 2000) break;
      await new Promise(r=>setTimeout(r,300));
    }

    if(html.length < 2000){
      alert("El PDF a√∫n no est√° listo.");
      return;
    }

    const base64 = btoa(unescape(encodeURIComponent(html)));

    const resp = await fetch(
      "https://ftth-n8n2.pzveh5.easypanel.host/webhook/bda46f0e-a348-4be9-b9f9-cc194c6541cd",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          pdf_base64: base64,
          paciente: document.getElementById("nombre")?.value || "",
          cedula: document.getElementById("cedula")?.value || "",
          celular: document.getElementById("celular")?.value || "",
          correo:document.getElementById("correo")?.value || "",
          profesional: window.NOMBRE_PROFESIONAL || "",
          fecha: document.getElementById("fecha-hora")?.textContent || ""
        })
      }
    );

    if(!resp.ok) throw new Error("HTTP " + resp.status);

    alert("PDF enviado correctamente a n8n ‚úÖ");
  }catch(e){
    console.error(e);
    alert("Error enviando PDF a n8n");
  }
};
</script>




<!-- =========================
     ‚úÖ BOT√ìN FACTURACI√ìN (FLOTANTE - AGREGADO SIN MODIFICAR LO EXISTENTE)
     - Ubicado M√ÅS ARRIBA que Imprimir PDF
     - No reemplaza ni elimina el bot√≥n existente
     ========================= -->


</div>




