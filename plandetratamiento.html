<!DOCTYPE html>
<html lang="es">
<head>
  <!-- ‚úÖ Fuente tipo la de tu imagen -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    window.supabase = createClient(
      'https://dmcfrmpqlkrqbpjhrfyo.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE'
    );

    // üîí Verificar sesi√≥n activa
    async function verificarSesion() {
      const { data: { session } } = await window.supabase.auth.getSession();
      if (!session) {
        console.warn("üö´ No hay sesi√≥n activa, redirigiendo al login...");
        window.location.href = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
      } else {
        console.log("‚úÖ Usuario autenticado:", session.user.email);
      }
    }

    verificarSesion();

    window.supabase.auth.onAuthStateChange((_event, session) => {
      if (!session) {
        console.warn("‚ö†Ô∏è Sesi√≥n expirada o cerrada, redirigiendo...");
        window.location.href = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
      }
    });
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cotizaci√≥n Odontol√≥gica - Dra. Leidi Silva</title>

  <style>
    :root{
      --tooth-size: clamp(28px, 5.5vw, 40px);
      --gap: 6px;

      /* base */
      --brand: #2a5d84;
      --ink: #1e4a66;

      /* botones top */
      --topbtn: #009688;
      --topbtn-hover: #00796b;

      /* ‚úÖ look ‚Äúform‚Äù como tu imagen */
      --page-bg: #f4f7fb;
      --card-bg: #ffffff;
      --field-bg: #ffffff;
      --field-border: #d6e3f3;     /* azul suave */
      --field-border-2: #bcd4f4;   /* foco */
      --label: #5b6b7c;            /* gris azulado */
      --title: #1f4e72;

      --radius: 14px;
      --shadow: 0 10px 30px rgba(16, 24, 40, .08);
      --font: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      font-family: var(--font);
      margin: 0;
      padding: 1em;
      background: var(--page-bg);
      padding-top: 78px; /* espacio para barra fija */
      color: #0f172a;
    }

    /* ‚úÖ Barra superior fija */
    .topbar{
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 2000;
      background: #e5e7eb;          /* gris */
      border-bottom: 1px solid #d6dde6;
      padding: 12px 0;
    }
    .topbar-inner{
      max-width: 960px;
      margin: 0 auto;
      padding: 0 1em;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .topbar-title{
      font-weight: 900;
      color: var(--title);
      white-space: nowrap;
      font-size: 30px;
      line-height: 1.1;
      letter-spacing: -0.02em;
    }
    .topbar-actions{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap: wrap;
    }

    .btn-top{
      background: var(--topbtn) !important;
      color: #fff !important;
      padding: 0.62em 1.2em;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 800;
      font-family: var(--font);
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
    }
    .btn-top:hover{
      background: var(--topbtn-hover) !important;
      transform: translateY(-1px);
    }

    h2{
      text-align: center;
      color: var(--title);
      font-size: 1.55em;
      margin: 8px 0 16px;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    form{
      background: var(--card-bg);
      padding: 18px;
      max-width: 960px;
      margin: auto;
      border-radius: 18px;
      box-shadow: var(--shadow);
      border: 1px solid #e6eef8;
    }

    /* ‚úÖ labels tipo la imagen */
    label{
      font-weight: 600;
      margin-top: 14px;
      display: block;
      color: var(--label);
      font-size: 13px;
      letter-spacing: .2px;
    }

    /* ‚úÖ inputs como la imagen */
    input[type="text"],
    input[type="number"],
    input[type="email"],
    select,
    textarea{
      width: 100%;
      background: var(--field-bg);
      padding: 14px 14px;
      margin-top: 8px;
      margin-bottom: 10px;
      border: 1.6px solid var(--field-border);
      border-radius: 14px;
      font-size: 15px;
      font-family: var(--font);
      color: #0f172a;
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease, transform .06s ease;
    }

    input::placeholder, textarea::placeholder{
      color: #9aa8b7;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="email"]:focus,
    select:focus,
    textarea:focus{
      border-color: var(--field-border-2);
      box-shadow: 0 0 0 4px rgba(59,130,246,.14);
    }

    /* ‚úÖ select con altura consistente */
    select{
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, #7b8da1 50%),
        linear-gradient(135deg, #7b8da1 50%, transparent 50%),
        linear-gradient(to right, transparent, transparent);
      background-position:
        calc(100% - 20px) calc(1.2em),
        calc(100% - 15px) calc(1.2em),
        calc(100% - 2.5em) 0.6em;
      background-size:
        5px 5px,
        5px 5px,
        1px 1.8em;
      background-repeat: no-repeat;
    }

    .datetime{
      margin-bottom: 10px;
      color: #334155;
      font-weight: 600;
      font-size: 13px;
    }

    .checkbox-group{
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .checkbox-group label{
      font-weight: 500;
      color: #223;
      display:flex;
      align-items:center;
      gap:8px;
      background:#f6f9ff;
      border:1px solid #e1eaf7;
      padding: 10px 12px;
      border-radius: 12px;
    }
    .checkbox-group input[type="checkbox"]{
      width: 16px; height: 16px;
      accent-color: var(--topbtn);
    }

    canvas{
      border: 1.6px solid var(--field-border);
      border-radius: 14px;
      width: 100%;
      height: 120px;
      margin: 10px 0 14px;
      background:#fff;
    }

    .totales{
      background: #f6f9ff;
      border: 1px solid #e1eaf7;
      border-radius: 14px;
      padding: 14px;
      margin-top: 14px;
    }
    .totales span{
      display: block;
      margin-bottom: 8px;
      color:#0f172a;
      font-weight: 600;
    }

    /* ‚úÖ Botones de abajo */
    button{
      padding: 0.95em;
      border: none;
      color: #fff;
      border-radius: 14px;
      width: 100%;
      cursor: pointer;
      margin-top: 10px;
      font-family: var(--font);
      font-weight: 800;
      letter-spacing: .2px;
      box-shadow: 0 10px 22px rgba(16,24,40,.10);
      transition: transform .06s ease, opacity .15s ease;
    }
    button:hover{ opacity: .96; transform: translateY(-1px); }

    button[type="submit"]{ background: #16a34a; } /* enviar */
    button[type="button"]{ background: var(--brand); } /* gen√©ricos */

    .link-btn{
      background: var(--brand);
      color:#fff;
      border:none;
      border-radius:50%;
      width:26px;
      height:26px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
    }

    #cedula-hint{
      display:block;
      min-height:1.2em;
      font-size:.9em;
      color:#64748b;
      margin-top: -4px;
      margin-bottom: 6px;
    }

    /* odontograma (lo dej√© igual, solo armonic√© un poquito) */
    .odontograma-wrap{
      margin-top: 16px;
      border:1px solid #e1eaf7;
      border-radius: 16px;
      padding: 14px;
      background:#fcfdff;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .row-title{
      text-align:center;
      font-weight:800;
      color: var(--title);
      margin: 6px 0 6px;
      letter-spacing:-.01em;
    }
    .side-labels{
      display:flex;
      justify-content:space-between;
      color: #425466;
      font-weight:700;
      margin:4px 0 6px;
      font-size: 12px;
    }

    .teeth-row{
      position: relative;
      display: grid;
      grid-template-columns: repeat(8, var(--tooth-size)) 2px repeat(8, var(--tooth-size));
      justify-content: center;
      column-gap: var(--gap);
      padding: 6px 0;
      margin-bottom: 6px;
      min-width: calc(16 * var(--tooth-size) + 15 * var(--gap) + 2px);
    }
    .teeth-row::after{
      content:"";
      position:absolute;
      left:calc(50% - 1px);
      top:2px; bottom:2px;
      width:2px;
      background:#cfd6dc;
      border-radius:2px;
    }
    .tooth{
      position: relative;
      width: var(--tooth-size);
      aspect-ratio: 1/1.12;
      border-radius: 10px;
      border:1px solid var(--ink);
      background: var(--ink);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, box-shadow .1s ease;
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
    }
    .tooth:hover{ transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,.16); }
    .tooth svg{ width: calc(var(--tooth-size) * .44); height: calc(var(--tooth-size) * .44); opacity:.9; }
    .tooth svg path{ fill:#e6f2fa; stroke:#bdd7ea; }
    .tooth-num{ position: absolute; top:3px; left:4px; font-size: clamp(9px, 2.2vw, 11px); font-weight:800; text-shadow:0 1px 2px rgba(0,0,0,.35); }
    .tooth-badge{ position: absolute; right:4px; bottom:3px; font-size: clamp(8px, 2vw, 10px); background:#eef6ff; color: var(--ink); padding:1px 4px; border-radius:999px; display:none; }
    .tooth.has-procs .tooth-badge{ display:inline-block; }

    .odontograma-summary{ margin-top: 8px; border-top: 1px dashed #e3e8ee; padding-top: 6px; }
    .summary-list{ margin:0; padding-left: 18px; color:#334155; }
    .summary-list li{ margin: 4px 0; }

    /* modal */
    .panel-backdrop{ position:fixed; inset:0; background:rgba(15,23,42,.35); display:none; align-items:center; justify-content:center; padding:18px; z-index: 999; }
    .panel{ width: 560px; max-width: 95vw; background:#fff; border-radius:16px; padding: 16px; box-shadow:0 20px 50px rgba(0,0,0,.22); border:1px solid #e6eef8; }
    .panel header{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .panel h3{ margin:0; color: var(--title); font-weight:900; letter-spacing:-.01em; }
    .panel .procs{ display:grid; gap:8px; margin-top:12px; max-height: 52vh; overflow:auto; padding-right: 6px; }

    .proc-toolbar{ margin-top:10px; display:flex; gap:10px; align-items:center; }
    .proc-search{ flex:1; margin:0; }
    .proc-toolbar small{ color:#64748b; font-weight:600; }

    .proc-row{ display:grid; grid-template-columns: 1fr 24px 120px; gap: 8px 10px; align-items:center; padding: 10px 10px; border:1px solid #e6eef8; border-radius:14px; background:#fbfdff; }
    .proc-row:hover{ background:#f4f9ff; }
    .panel .price{ width:100%; border:1.6px solid var(--field-border); border-radius:12px; padding:10px 10px; }

    .panel footer{ display:flex; gap:10px; margin-top:14px; }
    .btn-secondary{ background:#94a3b8; }
    .btn-primary{ background: var(--brand); }

    @media (max-width: 480px){
      body{ padding-top: 92px; }
      .topbar-title{ font-size: 24px; }
      .proc-row{ grid-template-columns: 1fr 20px 105px; }
      .panel{ width: 95vw; }
    }
  </style>
</head>

<body>
  <!-- ‚úÖ Barra fija arriba -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="topbar-title">Plan de tratamiento</div>
      <div class="topbar-actions">
        <button type="button" class="btn-top"
          onclick="window.location.href='https://cacg1022.github.io/ODONTOLOGIA/index.html'">
          Inicio
        </button>

        <button type="button" class="btn-top"
          onclick="window.location.href='https://cacg1022.github.io/ODONTOLOGIA/historia-clinica.html'">
          Historia Cl√≠nica
        </button>
      </div>
    </div>
  </div>

  <h2>Doctora Leidi Silva Oropeza<br>Especialista en Rehabilitaci√≥n Oral</h2>

  <form id="cotizacion-form" method="POST" action="https://ftth-n8n2.pzveh5.easypanel.host/webhook/dff23e62-359c-439e-a141-950e7542c6c2">
    <div class="datetime">
      <strong>Fecha y hora:</strong> <span id="fecha-hora"></span>
      <input type="hidden" name="fecha" id="input-fecha" />
    </div>

    <label for="nombre">Nombre del paciente:</label>
    <input type="text" id="nombre" name="nombre" required />

    <label for="cedula">N√∫mero de c√©dula:</label>
    <input type="number" id="cedula" name="cedula" required />
    <small id="cedula-hint"></small>

    <label for="celular">N√∫mero de celular:</label>
    <input type="text" id="celular" name="celular" required />

    <label for="correo">Correo electr√≥nico:</label>
    <input type="email" id="correo" name="correo" required />

    <label for="procedimiento">Procedimiento principal:</label>
    <select id="procedimiento" name="procedimiento_raw">
      <option value="No aplica|0">No aplica</option>
      <option value="Profilaxis (Limpieza)|70000">Profilaxis (Limpieza) - $70,000</option>
      <option value="Resina Dental|150000">Resina Dental - $150,000</option>
      <option value="Blanqueamiento Dental|300000">Blanqueamiento Dental - $300,000</option>
      <option value="Endodoncia|350000">Endodoncia (1 ra√≠z) - $350,000</option>
      <option value="Corona|800000">Corona Metal-Porcelana - $800,000</option>
      <option value="Protesis Flexible inferior|990000">Protesis Flexible inferior - $990,000</option>
    </select>

    <label>Procedimientos adicionales:</label>
    <div class="checkbox-group">
      <label>
        <input type="checkbox" name="adicionales_raw[]" value="Radiograf√≠a Panor√°mica|50000">
        Radiograf√≠a Panor√°mica - $50,000
        <button type="button" class="link-btn" title="Ver modelo 3D (doble clic)"
          ondblclick="window.open('https://human.biodigital.com/widget/?be=2W7q&background.colors=255,255,255,1,51,64,77,1&initial.hand-hint=true&ui-info=true&ui-fullscreen=true&ui-center=false&ui-dissect=true&ui-zoom=true&ui-help=true&ui-tools-display=primary&uaid=3bH1u','_blank')">üîó</button>
      </label>
      <label><input type="checkbox" name="adicionales_raw[]" value="Exodoncia Simple|120000"> Exodoncia Simple - $120,000</label>
      <label><input type="checkbox" name="adicionales_raw[]" value="Provisional Acr√≠lico|100000"> Provisional Acr√≠lico - $100,000</label>
      <label><input type="checkbox" name="adicionales_raw[]" value="Mantenimiento Brackets|80000"> Mantenimiento Brackets - $80,000</label>
    </div>

    <label>Odontograma (seleccione dientes y asigne procedimientos):</label>
    <div class="odontograma-wrap">
      <div class="row-title">Maxilar superior</div>
      <div class="side-labels"><span>derecha</span><span>izquierda</span></div>
      <div class="teeth-row" id="row-sup"></div>

      <div class="row-title" style="margin-top:8px;">Maxilar inferior</div>
      <div class="side-labels"><span>derecha</span><span>izquierda</span></div>
      <div class="teeth-row" id="row-inf"></div>

      <div class="odontograma-summary">
        <strong>Resumen por diente:</strong>
        <ul class="summary-list" id="summary-list"></ul>
        <div><strong>Subtotal odontograma:</strong> $<span id="odonto-subtotal">0</span></div>
      </div>

      <input type="hidden" name="odontograma_json" id="odontograma-json">
      <input type="hidden" name="odontograma_resumen" id="odontograma-resumen">
    </div>

    <input type="hidden" name="procedimiento">
    <input type="hidden" name="adicionales[]">

    <label for="descuento">Descuento:</label>
    <select id="descuento" name="descuento">
      <option value="0">Sin descuento</option>
      <option value="5">5%</option>
      <option value="10">10%</option>
      <option value="20">20%</option>
      <option value="30">30%</option>
    </select>

    <div class="totales">
      <span><strong>Subtotal:</strong> $<span id="subtotal">0</span></span>
      <span><strong>Descuento:</strong> $<span id="valor-descuento">0</span></span>
      <span><strong>Total a pagar:</strong> $<span id="total">0</span></span>
    </div>

    <input type="hidden" id="input-subtotal" name="subtotal_real">
    <input type="hidden" id="input-descuento" name="descuento_valor">
    <input type="hidden" id="input-total" name="total_real">

    <label for="observaciones">Observaciones:</label>
    <textarea id="observaciones" name="observaciones" rows="4"></textarea>

    <label for="firma">Firma del paciente:</label>
    <canvas id="firma"></canvas>
    <input type="hidden" name="firma" id="firmaInput" />

    <button type="button" onclick="limpiarFirma()">Limpiar Firma</button>
    <button type="button" id="btn-guardar" style="background:#2a5d84;">Guardar</button>
    <button type="submit">Enviar a paciente</button>
  </form>

  <!-- Modal odontograma -->
  <div class="panel-backdrop" id="panel-backdrop" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="panel-title">
      <header>
        <h3 id="panel-title">Procedimientos diente <span id="panel-tooth"></span></h3>
        <button type="button" class="btn-secondary" id="btn-close">Cerrar</button>
      </header>

      <div class="proc-toolbar">
        <input id="proc-search" class="proc-search" type="text" placeholder="Buscar procedimiento..." />
        <small id="proc-count"></small>
      </div>

      <div class="procs" id="procs-container"></div>

      <footer>
        <button type="button" class="btn-secondary" id="btn-clear">Limpiar</button>
        <button type="button" class="btn-primary" id="btn-save">Guardar</button>
      </footer>
    </div>
  </div>

  <script>
    /* ==========================
       Fecha/Hora
       ========================== */
    const now = new Date();
    document.getElementById("fecha-hora").textContent = now.toLocaleDateString('es-CO') + " - " + now.toLocaleTimeString('es-CO');
    document.getElementById("input-fecha").value = now.toLocaleDateString('es-CO') + " " + now.toLocaleTimeString('es-CO');

    const procedimiento = document.getElementById("procedimiento");
    const adicionales = document.querySelectorAll(".checkbox-group input[type='checkbox']");
    const descuentoSel = document.getElementById("descuento");
    const parseMoney = v => parseInt(String(v ?? '').replace(/[^\d]/g,''), 10) || 0;

    /* ==========================
       ‚úÖ Cat√°logo desde Supabase
       ========================== */
    let PROC_CATALOGO = [];
    let PROC_READY = false;

    async function cargarCatalogoDesdeSupabase() {
      try {
        const { data, error } = await window.supabase
          .from("procedimientos_precios")
          .select("id, procedimiento, valor, activo")
          .eq("activo", true)
          .order("procedimiento", { ascending: true });

        if (error) throw error;

        PROC_CATALOGO = (data || []).map(row => ({
          key: String(row.id),
          label: String(row.procedimiento),
          price: row.valor == null ? null : Number(row.valor)
        }));

        PROC_READY = true;
      } catch (e) {
        console.warn("No se pudo cargar procedimientos desde Supabase:", e?.message || e);
        PROC_CATALOGO = [];
        PROC_READY = false;
      }
    }

    /* ========= ODONTOGRAMA ========= */
    const selectedTeeth = {};

    const summaryList = document.getElementById('summary-list');
    const odontoSubtotalEl = document.getElementById('odonto-subtotal');
    const odontoJson = document.getElementById('odontograma-json');
    const odontoResumen = document.getElementById('odontograma-resumen');

    function toothSVG(){
      return `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2c3.5 0 6 2.6 6 6.1 0 3.4-1.5 4.9-2.5 10-.3 1.6-2 1.9-2.9.6l-1-1.5-1 1.5c-.9 1.3-2.6 1-2.9-.6-1-5.1-2.5-6.6-2.5-10C5.2 4.6 8.5 2 12 2z"/></svg>`;
    }
    function crearBoton(num){
      const b = document.createElement('button');
      b.type='button'; b.className='tooth'; b.dataset.tooth=String(num);
      b.innerHTML = `<span class="tooth-num">${num}</span>${toothSVG()}<span class="tooth-badge">+ Proc.</span>`;
      b.addEventListener('click', ()=>openPanel(num));
      return b;
    }

    function renderOdontograma(){
      const sup = document.getElementById('row-sup');
      const inf = document.getElementById('row-inf');
      sup.innerHTML = ''; inf.innerHTML = '';

      const supIzq = [18,17,16,15,14,13,12,11];
      const supDer = [21,22,23,24,25,26,27,28];
      const infIzq = [48,47,46,45,44,43,42,41];
      const infDer = [31,32,33,34,35,36,37,38];

      supIzq.forEach(n=> sup.appendChild(crearBoton(n)));
      const spacerSup = document.createElement('div'); spacerSup.style.width = '2px'; sup.appendChild(spacerSup);
      supDer.forEach(n=> sup.appendChild(crearBoton(n)));

      infIzq.forEach(n=> inf.appendChild(crearBoton(n)));
      const spacerInf = document.createElement('div'); spacerInf.style.width = '2px'; inf.appendChild(spacerInf);
      infDer.forEach(n=> inf.appendChild(crearBoton(n)));

      refreshBadges();
    }

    function refreshBadges(){
      document.querySelectorAll('.tooth').forEach(btn=>{
        const n = btn.dataset.tooth;
        btn.classList.toggle('has-procs', Array.isArray(selectedTeeth[n]) && selectedTeeth[n].length>0);
      });

      const items = Object.entries(selectedTeeth)
        .filter(([_,arr])=>arr && arr.length)
        .map(([tooth, arr])=>({ tooth, arr, total: arr.reduce((s,p)=>s+(p.price||0),0) }));

      summaryList.innerHTML = items.length
        ? items.map(it => `<li>Diente ${it.tooth}: ${it.arr.map(p=>`${p.label} ($${(p.price||0).toLocaleString('es-CO')})`).join(', ')} ‚Äî <strong>$${it.total.toLocaleString('es-CO')}</strong></li>`).join('')
        : '<li>Sin procedimientos asignados.</li>';

      let lines = [];
      if(items.length){
        items.forEach(it=>{
          const procsText = it.arr.map(p=>`${p.label} ($${(p.price||0).toLocaleString('es-CO')})`).join(', ');
          lines.push(`‚Ä¢ Diente ${it.tooth}: ${procsText} ‚Äî $${it.total.toLocaleString('es-CO')}`);
        });
      } else {
        lines.push('‚Ä¢ Sin procedimientos asignados.');
      }
      odontoResumen.value = lines.join('\n');

      const subt = items.reduce((s,it)=>s+it.total,0);
      odontoSubtotalEl.textContent = subt.toLocaleString('es-CO');
      odontoJson.value = JSON.stringify(selectedTeeth);

      calcularTotal();
    }

    /* ==========================
       Modal + buscador
       ========================== */
    const backdrop = document.getElementById('panel-backdrop');
    const procsContainer = document.getElementById('procs-container');
    const lblTooth = document.getElementById('panel-tooth');
    const btnSave = document.getElementById('btn-save');
    const btnClear = document.getElementById('btn-clear');
    const btnClose = document.getElementById('btn-close');
    const procSearch = document.getElementById('proc-search');
    const procCount = document.getElementById('proc-count');

    let currentTooth = null;

    function renderProcRows(filterText = ""){
      const q = String(filterText || "").trim().toLowerCase();
      const base = PROC_CATALOGO || [];
      const list = q ? base.filter(p => String(p.label).toLowerCase().includes(q)) : base;
      procCount.textContent = `${list.length} items`;
      procsContainer.innerHTML = "";

      if(!PROC_READY){
        const msg = document.createElement("div");
        msg.style.padding = "10px";
        msg.style.color = "#a33";
        msg.innerHTML = "‚ö†Ô∏è No se pudo cargar el cat√°logo desde Supabase. Revisa RLS/Policies o conexi√≥n.";
        procsContainer.appendChild(msg);
        return;
      }

      if(!list.length){
        const empty = document.createElement("div");
        empty.style.padding = "10px";
        empty.style.color = "#667";
        empty.textContent = "No hay resultados para la b√∫squeda.";
        procsContainer.appendChild(empty);
        return;
      }

      list.forEach(proc=>{
        const row = document.createElement('div');
        row.className='proc-row';
        row.dataset.key = proc.key;
        row.dataset.label = proc.label;

        const name = document.createElement('label');
        name.textContent = proc.label;

        const check = document.createElement('input');
        check.type='checkbox';
        check.className='proc-check';

        const price = document.createElement('input');
        price.type='number';
        price.className='price';
        price.min='0';
        price.step='1000';
        price.placeholder = proc.price == null ? "Sin precio" : "";
        price.value = proc.price == null ? "" : String(proc.price);

        const existing = (selectedTeeth[currentTooth]||[]).find(p=>String(p.key)===String(proc.key));
        if(existing){
          check.checked = true;
          price.value = existing.price != null ? String(existing.price) : (proc.price == null ? "" : String(proc.price));
        }

        check.addEventListener("change", ()=>{
          if(check.checked && !parseMoney(price.value)){
            price.focus();
          }
        });

        row.appendChild(name);
        row.appendChild(check);
        row.appendChild(price);
        procsContainer.appendChild(row);
      });
    }

    async function openPanel(toothNumber){
      currentTooth = String(toothNumber);
      lblTooth.textContent = currentTooth;

      if(!PROC_READY){
        await cargarCatalogoDesdeSupabase();
      }

      procSearch.value = "";
      renderProcRows("");
      backdrop.style.display='flex';
      procSearch.focus();
    }

    function closePanel(){
      backdrop.style.display='none';
      currentTooth=null;
    }

    btnClose.addEventListener('click', closePanel);
    backdrop.addEventListener('click', e=>{ if(e.target===backdrop) closePanel(); });

    procSearch.addEventListener("input", (e)=> renderProcRows(e.target.value));

    btnSave.addEventListener('click', ()=>{
      if(!currentTooth) return;

      const rows = procsContainer.querySelectorAll('.proc-row');
      const next = [];

      rows.forEach(row=>{
        const check = row.querySelector('.proc-check');
        const priceEl = row.querySelector('.price');
        if(!check.checked) return;

        const price = parseMoney(priceEl.value);
        if(price <= 0) return;

        next.push({ key: row.dataset.key, label: row.dataset.label, price });
      });

      if(next.length) selectedTeeth[currentTooth]=next;
      else delete selectedTeeth[currentTooth];

      refreshBadges();
      closePanel();
    });

    btnClear.addEventListener('click', ()=>{
      if(!currentTooth) return;
      delete selectedTeeth[currentTooth];
      refreshBadges();
      closePanel();
    });

    function odontogramaSubtotal(){
      return Object.values(selectedTeeth).reduce((acc, arr)=> acc + arr.reduce((s,p)=>s+(p.price||0),0), 0);
    }

    function calcularTotal(){
      let subtotal = 0;

      const [nProc, pProc] = procedimiento.value.split("|");
      if (procedimiento.value !== "No aplica|0") {
        subtotal += parseMoney(pProc);
        document.querySelector('input[name="procedimiento"]').value = `${nProc} - $${parseMoney(pProc).toLocaleString('es-CO')}`;
      } else {
        document.querySelector('input[name="procedimiento"]').value = "No aplica";
      }

      const adics = [];
      adicionales.forEach(cb=>{
        if(cb.checked){
          const [nA, pA] = cb.value.split("|");
          adics.push(`${nA} - $${parseMoney(pA).toLocaleString('es-CO')}`);
          subtotal += parseMoney(pA);
        }
      });
      document.querySelector('input[name="adicionales[]"]').value = adics.join("<br>");

      subtotal += odontogramaSubtotal();

      const porc = parseInt(descuentoSel.value,10) || 0;
      const vDesc = Math.round(subtotal * (porc/100));
      const total = subtotal - vDesc;

      document.getElementById('subtotal').textContent = subtotal.toLocaleString('es-CO');
      document.getElementById('valor-descuento').textContent = vDesc.toLocaleString('es-CO');
      document.getElementById('total').textContent = total.toLocaleString('es-CO');

      document.getElementById('input-subtotal').value = subtotal;
      document.getElementById('input-descuento').value = vDesc;
      document.getElementById('input-total').value = total;
    }

    window.addEventListener('load', async ()=>{
      await cargarCatalogoDesdeSupabase();
      renderOdontograma();
      calcularTotal();
    });

    procedimiento.addEventListener('change', calcularTotal);
    descuentoSel.addEventListener('change', calcularTotal);
    adicionales.forEach(cb=> cb.addEventListener('change', calcularTotal));

    /* ===== Firma ===== */
    const canvas = document.getElementById('firma');
    const ctx = canvas.getContext('2d');
    let dibujando=false;

    function getCoords(e){
      if(e.touches && e.touches.length){
        const r=canvas.getBoundingClientRect();
        return {x:e.touches[0].clientX-r.left, y:e.touches[0].clientY-r.top};
      }
      return {x:e.offsetX, y:e.offsetY};
    }

    canvas.addEventListener('mousedown', e=>{ dibujando=true; const {x,y}=getCoords(e); ctx.beginPath(); ctx.moveTo(x,y); });
    canvas.addEventListener('mousemove', e=>{ if(!dibujando) return; const {x,y}=getCoords(e); ctx.lineTo(x,y); ctx.stroke(); });
    ['mouseup','mouseleave'].forEach(ev=> canvas.addEventListener(ev, ()=> dibujando=false ));
    canvas.addEventListener('touchstart', e=>{ e.preventDefault(); dibujando=true; const {x,y}=getCoords(e); ctx.beginPath(); ctx.moveTo(x,y); });
    canvas.addEventListener('touchmove', e=>{ e.preventDefault(); if(!dibujando) return; const {x,y}=getCoords(e); ctx.lineTo(x,y); ctx.stroke(); });
    canvas.addEventListener('touchend', ()=> dibujando=false );

    function limpiarFirma(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
    window.limpiarFirma = limpiarFirma;

    document.getElementById('cotizacion-form').addEventListener('submit', ()=>{
      document.getElementById('firmaInput').value = canvas.toDataURL();
    });

    /* ==========================
       Guardar silencioso
       ========================== */
    const WEBHOOK_GUARDAR = "https://ftth-n8n2.pzveh5.easypanel.host/webhook/248f724f-7598-4fba-831c-433662969810";
    const btnGuardar = document.getElementById("btn-guardar");
    const form = document.getElementById("cotizacion-form");

    btnGuardar.addEventListener("click", async () => {
      try {
        calcularTotal();
        document.getElementById('firmaInput').value = canvas.toDataURL();

        const fd = new FormData(form);
        const resp = await fetch(WEBHOOK_GUARDAR, { method: "POST", body: fd });

        if (!resp.ok) throw new Error("HTTP " + resp.status);
        alert("Guardado ‚úÖ");
      } catch (e) {
        console.error(e);
        alert("No se pudo guardar. Intenta de nuevo.");
      }
    });

    /* ====== CARGA POR C√âDULA (n8n) ====== */
    const cedulaInput = document.getElementById('cedula');
    const hint = document.getElementById('cedula-hint');

    function setHintHTML(html, color="#666"){ hint.innerHTML = html||""; hint.style.color = color; }
    function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
    function parseNicePair(str){
      if(!str) return null;
      const m = String(str).match(/^\s*(.*?)\s*-\s*\$\s*([\d\., ]+)\s*$/);
      if(!m) return { name: String(str).trim(), price: null };
      const name = m[1].trim();
      const price = parseInt(m[2].replace(/[^\d]/g,''), 10) || 0;
      return { name, price };
    }
    function markAdicional(nombre, precio){
      let raw = null;
      if(nombre && Number.isFinite(precio) && precio>0) raw = `${nombre}|${precio}`;
      if(raw){
        const m1 = Array.from(adicionales).find(cb => cb.value === raw);
        if(m1){ m1.checked = true; return true; }
      }
      const m2 = Array.from(adicionales).find(cb => cb.value.split('|')[0].trim().toLowerCase() === String(nombre||'').trim().toLowerCase());
      if(m2){ m2.checked = true; return true; }
      return false;
    }
    function selectProcedimiento(nombre, precio){
      if(!nombre) return false;
      const raw = (Number.isFinite(precio) && precio>0) ? `${nombre}|${precio}` : null;
      if(raw){
        const o1 = Array.from(procedimiento.options).find(o => o.value === raw);
        if(o1){ procedimiento.value = o1.value; return true; }
      }
      const o2 = Array.from(procedimiento.options).find(o => o.value.split('|')[0].trim().toLowerCase() === nombre.trim().toLowerCase());
      if(o2){ procedimiento.value = o2.value; return true; }
      return false;
    }

    function loadFromWebhook(data){
      if(!data || !data.encontrado){ setHintHTML("‚úîÔ∏è Paciente nuevo.", "#1e8449"); return; }

      if (data.nombre)  document.getElementById('nombre').value  = data.nombre;
      if (data.correo)  document.getElementById('correo').value  = data.correo;
      if (data.celular) document.getElementById('celular').value = data.celular;
      if (typeof data.observaciones === "string") document.getElementById('observaciones').value = data.observaciones;

      let pn=null, pp=null;
      if (data.procedimientoRaw){ const [n,p] = String(data.procedimientoRaw).split('|'); pn=n; pp=parseInt(p,10)||null; }
      else if(data.procedimiento){ const pr = parseNicePair(data.procedimiento); if(pr){ pn=pr.name; pp=pr.price; } }
      if(pn) selectProcedimiento(pn, pp);

      adicionales.forEach(cb=> cb.checked=false);
      if (Array.isArray(data.adicionalesRaw)){
        data.adicionalesRaw.forEach(s=>{ const [n,p] = String(s).split('|'); markAdicional(n, parseInt(p,10)||null); });
      } else if (typeof data.adicionales === 'string'){
        data.adicionales.split(/\n|,/).map(s=>s.trim()).filter(Boolean).forEach(item=>{
          const pr = parseNicePair(item); if(pr) markAdicional(pr.name, pr.price);
        });
      }

      if (typeof data.descuento === "number"){
        const op = Array.from(descuentoSel.options).find(o => parseInt(o.value,10) === data.descuento);
        if(op) descuentoSel.value = String(data.descuento);
      }

      const odoStr = data.odontogramaJSON || data.odontograma;
      if (odoStr){
        try{
          const parsed = JSON.parse(odoStr);
          Object.keys(selectedTeeth).forEach(k=> delete selectedTeeth[k]);
          Object.assign(selectedTeeth, parsed);
          refreshBadges();
        }catch(e){ console.warn("odontograma inv√°lido:", e); }
      }

      const fecha = data.fecha ? ` el ${escapeHtml(data.fecha)}` : "";
      const nombre = data.nombre ? ` (${escapeHtml(data.nombre)})` : "";
      setHintHTML(`‚ö†Ô∏è Paciente ya valorado${fecha}${nombre}.`, "#c0392b");

      calcularTotal();
    }

    let lastQuery = "";
    document.getElementById('cedula').addEventListener('blur', ()=>{
      const ced = cedulaInput.value.trim();
      if(!ced || ced===lastQuery) return; lastQuery=ced;
      setHintHTML("Buscando historial del paciente...");
      fetch("https://ftth-n8n2.pzveh5.easypanel.host/webhook/db28876e-aa9c-4015-a0b0-8f6411989681?cedula="+encodeURIComponent(ced))
        .then(r=>{ if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); })
        .then(loadFromWebhook)
        .catch(()=> setHintHTML("No fue posible verificar. Intenta de nuevo.", "#c0392b"));
    });

    function initCedulaFromQuery() {
      try {
        const params = new URLSearchParams(window.location.search);
        const cedula = (params.get("cedula") || "").trim();
        if (!cedula) return;

        const cedulaInput = document.getElementById("cedula");
        if (!cedulaInput) return;

        cedulaInput.value = cedula;
        cedulaInput.dispatchEvent(new Event("blur", { bubbles: true }));
      } catch (e) {
        console.warn("No se pudo inicializar la c√©dula desde la URL:", e);
      }
    }
    document.addEventListener("DOMContentLoaded", initCedulaFromQuery);
  </script>
</body>
</html>


