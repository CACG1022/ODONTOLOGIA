<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pendientes por evolucionar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    window.supabase = createClient(
      "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
    );
  </script>

  <style>
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:#f6f8fb;
      margin:0;
      padding:24px;
    }
    h1{ color:#1f3a5f; }

    .top{
      display:flex;
      gap:16px;
      align-items:center;
      margin-bottom:18px;
      flex-wrap:wrap;
    }

    .kpi{
      background:#fff;
      border-radius:14px;
      padding:14px 18px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
      min-width:180px;
    }
    .kpi b{ font-size:26px; display:block; }

    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    th,td{
      padding:10px 12px;
      border-bottom:1px solid #e5eaf0;
      font-size:14px;
    }
    th{
      background:#f0f4fa;
      text-align:left;
      font-weight:700;
    }

    tr.hoy{ background:#e9fbff; }
    tr.warn{ background:#fff3cd; }
    tr.danger{ background:#fde2e2; }

    select{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
    }
  </style>
</head>

<body>

<h1>ðŸš¨ Pendientes por evolucionar</h1>

<div class="top">
  <label>
    Ver Ãºltimos
    <select id="dias">
      <option value="7">7 dÃ­as</option>
      <option value="14">14 dÃ­as</option>
      <option value="30">30 dÃ­as</option>
    </select>
  </label>

  <div class="kpi">
    Pendientes hoy
    <b id="kHoy">0</b>
  </div>

  <div class="kpi">
    Pendientes histÃ³ricos
    <b id="kHist">0</b>
  </div>
</div>

<table>
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Hora</th>
      <th>Paciente</th>
      <th>Documento</th>
      <th>Profesional</th>
      <th>Atraso</th>
    </tr>
  </thead>
  <tbody id="tbody">
    <tr><td colspan="6">Cargando...</td></tr>
  </tbody>
</table>

<script type="module">
const tbody = document.getElementById("tbody");
const kHoy = document.getElementById("kHoy");
const kHist = document.getElementById("kHist");
const selDias = document.getElementById("dias");

function hoyISO(){
  return new Date().toISOString().slice(0,10);
}

function diffDias(fecha){
  const h = new Date(hoyISO());
  const f = new Date(fecha);
  return Math.floor((h - f) / 86400000);
}

function esCitaAtendida(estado){
  return String(estado || "").trim().toLowerCase() === "atendida";
}

async function cargar(){
  tbody.innerHTML = `<tr><td colspan="6">Cargando...</td></tr>`;

  const dias = Number(selDias.value);
  const desde = new Date();
  desde.setDate(desde.getDate() - dias);
  const desdeISO = desde.toISOString().slice(0,10);

  const { data: citas, error } = await supabase
    .from("citas")
    .select(`
      inicio,
      estado,
      nombre_paciente,
      documento_paciente,
      nombre_profesional
    `)
    .gte("inicio", desdeISO);

  if(error){
    tbody.innerHTML = `<tr><td colspan="6">Error cargando citas</td></tr>`;
    return;
  }

  const { data: evols } = await supabase
    .from("EVOLUCIONES")
    .select("paciente_numdoc, evo_fecha");

  const mapaEvo = new Set(
    (evols || []).map(e => `${e.paciente_numdoc}-${e.evo_fecha}`)
  );

  tbody.innerHTML = "";
  let hoy = 0, hist = 0;

  citas.forEach(c => {
    if(!esCitaAtendida(c.estado)) return;

    const fechaCita = c.inicio.slice(0,10);
    const key = `${c.documento_paciente}-${fechaCita}`;

    if(mapaEvo.has(key)) return;

    const atraso = diffDias(fechaCita);
    if(atraso === 0) hoy++; else hist++;

    let cls = "hoy";
    let txt = "HOY";
    if(atraso === 1){ cls="warn"; txt="1 dÃ­a"; }
    if(atraso >= 2){ cls="danger"; txt=`${atraso} dÃ­as`; }

    const tr = document.createElement("tr");
    tr.className = cls;
    tr.innerHTML = `
      <td>${fechaCita}</td>
      <td>${c.inicio.slice(11,16)}</td>
      <td>${c.nombre_paciente}</td>
      <td>${c.documento_paciente}</td>
      <td>${c.nombre_profesional}</td>
      <td>${txt}</td>
    `;
    tbody.appendChild(tr);
  });

  if(!tbody.children.length){
    tbody.innerHTML = `<tr><td colspan="6">Sin pendientes ðŸŽ‰</td></tr>`;
  }

  kHoy.textContent = hoy;
  kHist.textContent = hist;
}

selDias.addEventListener("change", cargar);
cargar();
</script>

</body>
</html>



