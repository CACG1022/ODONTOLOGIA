<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pendientes por evolucionar</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
);

/* =========================
   UTILIDADES
========================= */
function soloFecha(ts) {
  return ts.split("T")[0];
}

function diffDias(fecha) {
  const hoy = new Date().toISOString().slice(0,10);
  return Math.floor((new Date(hoy) - new Date(fecha)) / 86400000);
}

/* =========================
   CARGA
========================= */
async function cargarPendientes(dias = 7) {

  const hoy = new Date().toISOString().slice(0,10);
  const desde = new Date(Date.now() - dias*86400000).toISOString().slice(0,10);

  // 1Ô∏è‚É£ SOLO citas atendidas en rango
  const { data: citas, error: ec } = await supabase
    .from("citas_atendidas_public")
    .select("inicio,nombre_paciente,documento_paciente,nombre_profesional")
    .gte("inicio", desde)
    .lte("inicio", hoy + "T23:59:59");

  if (ec) return mostrarError();

  // 2Ô∏è‚É£ evoluciones
  const { data: evols, error: ee } = await supabase
    .from("EVOLUCIONES")
    .select("paciente_numdoc,evo_fecha");

  if (ee) return mostrarError();

  // 3Ô∏è‚É£ √≠ndice paciente + fecha
  const index = new Set(
    evols.map(e =>
      `${String(e.paciente_numdoc)}|${String(e.evo_fecha)}`
    )
  );

  const pendientes = [];

  citas.forEach(c => {
    const fechaCita = soloFecha(c.inicio);
    const key = `${String(c.documento_paciente)}|${fechaCita}`;

    if (!index.has(key)) {
      pendientes.push({
        fecha: fechaCita,
        hora: c.inicio.slice(11,16),
        paciente: c.nombre_paciente,
        documento: c.documento_paciente,
        profesional: c.nombre_profesional,
        atraso: diffDias(fechaCita)
      });
    }
  });

  render(pendientes);
}

/* =========================
   RENDER
========================= */
function render(lista) {
  const tbody = document.querySelector("tbody");
  tbody.innerHTML = "";

  let hoy = 0, historicos = 0;

  lista.forEach(p => {
    let clase = "", label = "";

    if (p.atraso === 0) {
      clase = "hoy"; label = "HOY"; hoy++;
    } else if (p.atraso === 1) {
      clase = "amarillo"; label = "1 d√≠a"; historicos++;
    } else {
      clase = "rojo"; label = `${p.atraso} d√≠as`; historicos++;
    }

    tbody.insertAdjacentHTML("beforeend", `
      <tr class="${clase}">
        <td>${p.fecha}</td>
        <td>${p.hora}</td>
        <td>${p.paciente}</td>
        <td>${p.documento}</td>
        <td>${p.profesional}</td>
        <td>${label}</td>
      </tr>
    `);
  });

  document.getElementById("hoy").textContent = hoy;
  document.getElementById("historicos").textContent = historicos;
}

function mostrarError() {
  document.querySelector("tbody").innerHTML =
    `<tr><td colspan="6">Error cargando datos</td></tr>`;
}

window.onload = () => cargarPendientes(7);
</script>

<style>
body { font-family: system-ui; background:#f6f8fb; padding:20px; }
.cards { display:flex; gap:12px; margin-bottom:14px; }
.card { background:#fff; padding:12px 18px; border-radius:12px; }
table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; }
th,td { padding:10px; border-bottom:1px solid #eee; }
tr.hoy { background:#e6f7ff; }
tr.amarillo { background:#fff4cc; }
tr.rojo { background:#ffe4e4; }
</style>
</head>

<body>
<h1>üö® Pendientes por evolucionar</h1>

<div class="cards">
  <div class="card">Pendientes hoy: <b id="hoy">0</b></div>
  <div class="card">Pendientes hist√≥ricos: <b id="historicos">0</b></div>
</div>

<table>
<thead>
<tr>
  <th>Fecha</th>
  <th>Hora</th>
  <th>Paciente</th>
  <th>Documento</th>
  <th>Profesional</th>
  <th>Atraso</th>
</tr>
</thead>
<tbody></tbody>
</table>
</body>
</html>
