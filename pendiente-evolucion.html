<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pendientes por evolucionar</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
);

/* =========================
   UTILIDADES DE FECHA
========================= */

// üëâ convierte timestamp a YYYY-MM-DD SIN timezone
function fechaLocalYYYYMMDD(ts) {
  return String(ts).split("T")[0];
}

// diferencia en d√≠as (solo fecha)
function diffDias(fecha) {
  const hoy = new Date().toISOString().slice(0,10);
  const f1 = new Date(hoy);
  const f2 = new Date(fecha);
  return Math.floor((f1 - f2) / 86400000);
}

/* =========================
   CARGA PRINCIPAL
========================= */

async function cargarPendientes(dias = 7) {
  const hoy = new Date().toISOString().slice(0,10);
  const desde = new Date(Date.now() - dias*86400000).toISOString().slice(0,10);

  // 1Ô∏è‚É£ citas atendidas
  const { data: citas, error: ec } = await supabase
    .from("citas")
    .select("inicio,nombre_paciente,documento_paciente,nombre_profesional,estado")
    .eq("estado","atendida")
    .gte("inicio", desde)
    .lte("inicio", hoy+"T23:59:59");

  if (ec) return mostrarError();

  // 2Ô∏è‚É£ evoluciones
  const { data: evols, error: ee } = await supabase
    .from("EVOLUCIONES")
    .select("paciente_numdoc,evo_fecha");

  if (ee) return mostrarError();

  // 3Ô∏è‚É£ indexar evoluciones por paciente+fecha
  const map = new Set(
    evols.map(e => `${e.paciente_numdoc}|${e.evo_fecha}`)
  );

  let pendientes = [];

  citas.forEach(c => {
    const fechaCita = fechaLocalYYYYMMDD(c.inicio);
    const key = `${c.documento_paciente}|${fechaCita}`;

    if (!map.has(key)) {
      pendientes.push({
        fecha: fechaCita,
        hora: c.inicio.slice(11,16),
        paciente: c.nombre_paciente,
        documento: c.documento_paciente,
        profesional: c.nombre_profesional,
        atraso: diffDias(fechaCita)
      });
    }
  });

  render(pendientes);
}

/* =========================
   RENDER
========================= */

function render(lista) {
  const tbody = document.querySelector("tbody");
  tbody.innerHTML = "";

  let hoy = 0, historicos = 0;

  lista.forEach(p => {
    let clase = "";
    let label = "";

    if (p.atraso === 0) {
      clase = "hoy"; label = "HOY"; hoy++;
    } else if (p.atraso === 1) {
      clase = "amarillo"; label = "1 d√≠a"; historicos++;
    } else {
      clase = "rojo"; label = `${p.atraso} d√≠as`; historicos++;
    }

    const tr = document.createElement("tr");
    tr.className = clase;
    tr.innerHTML = `
      <td>${p.fecha}</td>
      <td>${p.hora}</td>
      <td>${p.paciente}</td>
      <td>${p.documento}</td>
      <td>${p.profesional}</td>
      <td>${label}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("hoy").textContent = hoy;
  document.getElementById("historicos").textContent = historicos;
}

function mostrarError() {
  document.querySelector("tbody").innerHTML =
    `<tr><td colspan="6">Error cargando citas</td></tr>`;
}

window.onload = () => cargarPendientes(7);
</script>

<style>
body { font-family: system-ui; background:#f6f8fb; padding:20px; }
h1 { margin-bottom:10px; }
.cards { display:flex; gap:12px; margin-bottom:14px; }
.card { background:#fff; padding:12px 18px; border-radius:12px; }
table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; }
th,td { padding:10px; border-bottom:1px solid #eee; }
tr.hoy { background:#e6f7ff; }
tr.amarillo { background:#fff4cc; }
tr.rojo { background:#ffe4e4; }
</style>
</head>

<body>
<h1>üö® Pendientes por evolucionar</h1>

<div class="cards">
  <div class="card">Pendientes hoy: <b id="hoy">0</b></div>
  <div class="card">Pendientes hist√≥ricos: <b id="historicos">0</b></div>
</div>

<table>
<thead>
<tr>
  <th>Fecha</th>
  <th>Hora</th>
  <th>Paciente</th>
  <th>Documento</th>
  <th>Profesional</th>
  <th>Atraso</th>
</tr>
</thead>
<tbody></tbody>
</table>
</body>
</html>



