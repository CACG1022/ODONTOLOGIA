<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cotizaci√≥n Odontol√≥gica - Dra. Leidi Silva</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1em;
      background-color: #f9f9f9;
    }
    h2 {
      text-align: center;
      color: #2a5d84;
      font-size: 1.5em;
      margin-bottom: 1em;
    }
    form {
      background-color: #fff;
      padding: 1em;
      max-width: 600px;
      margin: auto;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label {
      font-weight: bold;
      margin-top: 1em;
      display: block;
      font-size: 1em;
    }
    input[type="text"], input[type="number"], input[type="email"], select, textarea {
      width: 100%;
      padding: 0.8em;
      margin-top: 0.4em;
      margin-bottom: 0.5em;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 0.5em;
      margin-bottom: 1em;
    }
    .checkbox-group label {
      font-weight: normal;
      font-size: 0.95em;
    }
    canvas {
      border: 1px solid #ccc;
      margin-top: 1em;
      margin-bottom: 1.5em;
      display: block;
      width: 100%;
      height: 120px;
    }
    .totales {
      font-size: 1em;
      margin-top: 1em;
    }
    .totales span {
      display: block;
      margin-bottom: 0.5em;
    }
    .datetime {
      margin-bottom: 1em;
      font-size: 0.95em;
      color: #333;
    }
    button {
      padding: 0.8em;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      margin-top: 1em;
      width: 100%;
    }
    button[type="submit"] { background-color: #28a745; }
    button[type="button"] { background-color: #2a5d84; }
    button:hover { opacity: 0.9; }

    @media (min-width: 600px) {
      .checkbox-group { flex-direction: row; flex-wrap: wrap; gap: 1em; }
    }

    /* Bot√≥n peque√±o para el enlace BioDigital */
    .link-btn {
      background-color: #2a5d84;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: 6px;
    }
    .link-btn:hover { background-color: #1f4664; }

    /* Mensaje de verificaci√≥n de c√©dula */
    #cedula-hint {
      display: block;
      margin-top: 4px;
      font-size: 0.9em;
      color: #666;
      min-height: 1.2em; /* evita saltos al aparecer */
    }
    #cedula-hint small { font-size: 0.9em; }
  </style>
</head>
<body>

  <h2>Doctora Leidi Silva Oropeza<br>Especialista en Rehabilitaci√≥n Oral</h2>

  <form id="cotizacion-form" method="POST" action="https://ftth-n8n2.pzveh5.easypanel.host/webhook/dff23e62-359c-439e-a141-950e7542c6c2">
    <div class="datetime">
      <strong>Fecha y hora:</strong> <span id="fecha-hora"></span>
      <input type="hidden" name="fecha" id="input-fecha" />
    </div>

    <label for="nombre">Nombre del paciente:</label>
    <input type="text" id="nombre" name="nombre" required />

    <label for="cedula">N√∫mero de c√©dula:</label>
    <input type="number" id="cedula" name="cedula" required />
    <small id="cedula-hint"></small>

    <label for="celular">N√∫mero de celular:</label>
    <input type="text" id="celular" name="celular" required />

    <label for="correo">Correo electr√≥nico:</label>
    <input type="email" id="correo" name="correo" required />

    <label for="procedimiento">Procedimiento principal:</label>
    <select id="procedimiento" name="procedimiento_raw">
      <option value="Profilaxis (Limpieza)|70000">Profilaxis (Limpieza) - $70,000</option>
      <option value="Resina Dental|150000">Resina Dental - $150,000</option>
      <option value="Blanqueamiento Dental|300000">Blanqueamiento Dental - $300,000</option>
      <option value="Endodoncia|350000">Endodoncia (1 ra√≠z) - $350,000</option>
      <option value="Corona|800000">Corona Metal-Porcelana - $800,000</option>
    </select>

    <label>Procedimientos adicionales:</label>
    <div class="checkbox-group">
      <label style="display:flex; align-items:center; gap:5px;">
        <input type="checkbox" name="adicionales_raw[]" value="Radiograf√≠a Panor√°mica|50000" />
        Radiograf√≠a Panor√°mica - $50,000
        <button type="button" class="link-btn"
          title="Ver modelo 3D (doble clic)"
          ondblclick="window.open('https://human.biodigital.com/widget/?be=2W7q&background.colors=255,255,255,1,51,64,77,1&initial.hand-hint=true&ui-info=true&ui-fullscreen=true&ui-center=false&ui-dissect=true&ui-zoom=true&ui-help=true&ui-tools-display=primary&uaid=3bH1u','_blank')">
          üîó
        </button>
      </label>

      <label><input type="checkbox" name="adicionales_raw[]" value="Exodoncia Simple|120000" /> Exodoncia Simple - $120,000</label>
      <label><input type="checkbox" name="adicionales_raw[]" value="Provisional Acr√≠lico|100000" /> Provisional Acr√≠lico - $100,000</label>
      <label><input type="checkbox" name="adicionales_raw[]" value="Mantenimiento Brackets|80000" /> Mantenimiento Brackets - $80,000</label>
    </div>

    <input type="hidden" name="procedimiento" />
    <input type="hidden" name="adicionales[]" />

    <label for="descuento">Descuento:</label>
    <select id="descuento" name="descuento">
      <option value="0">Sin descuento</option>
      <option value="5">5%</option>
      <option value="10">10%</option>
      <option value="20">20%</option>
      <option value="30">30%</option>
    </select>

    <div class="totales">
      <span><strong>Subtotal:</strong> $<span id="subtotal">0</span></span>
      <span><strong>Descuento:</strong> $<span id="valor-descuento">0</span></span>
      <span><strong>Total a pagar:</strong> $<span id="total">0</span></span>
    </div>

    <input type="hidden" name="subtotal_real" id="input-subtotal" />
    <input type="hidden" name="descuento_valor" id="input-descuento" />
    <input type="hidden" name="total_real" id="input-total" />

    <label for="observaciones">Observaciones:</label>
    <textarea id="observaciones" name="observaciones" rows="4"></textarea>

    <label for="firma">Firma del paciente:</label>
    <canvas id="firma"></canvas>
    <input type="hidden" name="firma" id="firmaInput" />
    <button type="button" onclick="limpiarFirma()">Limpiar Firma</button>
    <button type="submit">Enviar</button>
  </form>

  <script>
    /* Fecha/Hora */
    const fechaHora = new Date();
    const fechaStr = fechaHora.toLocaleDateString('es-CO');
    const horaStr = fechaHora.toLocaleTimeString('es-CO');
    document.getElementById("fecha-hora").textContent = `${fechaStr} - ${horaStr}`;
    document.getElementById("input-fecha").value = `${fechaStr} ${horaStr}`;

    const procedimiento = document.getElementById("procedimiento");
    const adicionales = document.querySelectorAll(".checkbox-group input[type='checkbox']");
    const descuento = document.getElementById("descuento");

    function calcularTotal() {
      let subtotal = 0;

      const [nombreProc, precioProc] = procedimiento.value.split("|");
      subtotal += parseInt(precioProc);
      document.querySelector('input[name="procedimiento"]').value =
        `${nombreProc} - $${parseInt(precioProc).toLocaleString()}`;

      let adicionalesSeleccionados = [];
      adicionales.forEach(cb => {
        if (cb.checked) {
          const [nombreAdic, precioAdic] = cb.value.split("|");
          adicionalesSeleccionados.push(`${nombreAdic} - $${parseInt(precioAdic).toLocaleString()}`);
          subtotal += parseInt(precioAdic);
        }
      });
      document.querySelector('input[name="adicionales[]"]').value = adicionalesSeleccionados.join("<br>");

      const porcentajeDescuento = parseInt(descuento.value);
      const valorDescuento = Math.round(subtotal * (porcentajeDescuento / 100));
      const total = subtotal - valorDescuento;

      document.getElementById("subtotal").textContent = subtotal.toLocaleString();
      document.getElementById("valor-descuento").textContent = valorDescuento.toLocaleString();
      document.getElementById("total").textContent = total.toLocaleString();

      document.getElementById("input-subtotal").value = subtotal;
      document.getElementById("input-descuento").value = valorDescuento;
      document.getElementById("input-total").value = total;
    }

    window.addEventListener("load", calcularTotal);
    procedimiento.addEventListener("change", calcularTotal);
    descuento.addEventListener("change", calcularTotal);
    adicionales.forEach(cb => cb.addEventListener("change", calcularTotal));

    /* Firma */
    const canvas = document.getElementById("firma");
    const ctx = canvas.getContext("2d");
    let dibujando = false;

    function getCoords(e) {
      if (e.touches && e.touches.length > 0) {
        const rect = canvas.getBoundingClientRect();
        return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
      } else {
        return { x: e.offsetX, y: e.offsetY };
      }
    }

    canvas.addEventListener("mousedown", e => {
      dibujando = true;
      const { x, y } = getCoords(e);
      ctx.beginPath();
      ctx.moveTo(x, y);
    });
    canvas.addEventListener("mousemove", e => {
      if (dibujando) {
        const { x, y } = getCoords(e);
        ctx.lineTo(x, y);
        ctx.stroke();
      }
    });
    canvas.addEventListener("mouseup", () => dibujando = false);
    canvas.addEventListener("mouseleave", () => dibujando = false);
    canvas.addEventListener("touchstart", e => {
      e.preventDefault();
      dibujando = true;
      const { x, y } = getCoords(e);
      ctx.beginPath();
      ctx.moveTo(x, y);
    });
    canvas.addEventListener("touchmove", e => {
      e.preventDefault();
      if (dibujando) {
        const { x, y } = getCoords(e);
        ctx.lineTo(x, y);
        ctx.stroke();
      }
    });
    canvas.addEventListener("touchend", () => dibujando = false);

    function limpiarFirma() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    document.getElementById("cotizacion-form").addEventListener("submit", function () {
      const firmaDataURL = canvas.toDataURL();
      document.getElementById("firmaInput").value = firmaDataURL;
    });

    /* ---- Verificaci√≥n de c√©dula contra n8n (con HTML en el hint) ---- */
    const cedulaInput = document.getElementById("cedula");
    const hint = document.getElementById("cedula-hint");
    const nombreInput = document.getElementById("nombre"); // autocompleta si viene

    // Sanitiza para evitar inyecci√≥n de HTML
    function escapeHtml(str) {
      return String(str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    function setHintHTML(html, color = "#666") {
      hint.innerHTML = html || "";
      hint.style.color = color;
    }

    let lastQuery = "";

    cedulaInput.addEventListener("blur", function () {
      const cedula = this.value.trim();
      if (!cedula || cedula === lastQuery) return;
      lastQuery = cedula;

      setHintHTML("Verificando historial del paciente...");

      fetch("https://ftth-n8n2.pzveh5.easypanel.host/webhook/62804cbf-8f21-453b-823e-e5c1b94f31c8?cedula=" + encodeURIComponent(cedula))
        .then(res => {
          if (!res.ok) throw new Error("HTTP " + res.status);
          return res.json();
        })
        .then(data => {
          if (data && data.encontrado) {
            const fecha = data.fecha ? ` el ${escapeHtml(data.fecha)}` : "";
            const nombre = data.nombre ? ` (${escapeHtml(data.nombre)})` : "";
            const proc = data.procedimiento ? escapeHtml(data.procedimiento) : "‚Äî";
            const adic = data.adicionales ? escapeHtml(data.adicionales).replace(/\n/g, "<br>") : "‚Äî";

            // >>> AUTORELLENAR NOMBRE, CORREO Y CELULAR <<<
            if (data.nombre)  document.getElementById("nombre").value  = data.nombre;
            if (data.correo)  document.getElementById("correo").value  = data.correo;
            if (data.celular) document.getElementById("celular").value = data.celular;
            if (data.celular) document.getElementById("observaciones").value = data.observaciones;
            setHintHTML(
              `‚ö†Ô∏è Paciente ya valorado${fecha}${nombre}.<br>
               <small><strong>Proc. principal:</strong> ${proc}<br>
               <strong>Adicionales:</strong><br>${adic}</small>`,
              "#c0392b"
            );
          } else {
            setHintHTML("‚úîÔ∏è Paciente nuevo.", "#1e8449");
          }
        })
        .catch(err => {
          console.error("Error verificando paciente:", err);
          setHintHTML("No fue posible verificar. Intenta de nuevo.", "#c0392b");
        });
    });
  </script>
</body>
</html>


