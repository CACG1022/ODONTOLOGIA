
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DENTOVA Â· Panel Futurista</title>

<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // âœ… Supabase
    const supabase = createClient(
      "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
    );

    const LOGIN_URL = "https://cacg1022.github.io/ODONTOLOGIA/login.html";

    // âœ… LINKS
    const URLS = {
      agendamiento: "https://calendar.google.com/calendar/u/0?cid=ZHJhbGVpZGlzaWx2YUBnbWFpbC5jb20",
      agendar: "https://cacg1022.github.io/ODONTOLOGIA/agendamientos.html",
      plan: "https://cacg1022.github.io/ODONTOLOGIA/plandetratamiento.html",
      historia: "https://cacg1022.github.io/ODONTOLOGIA/historia-clinica.html",
      hoy: "#",
      rips: "#",
      registro: "https://cacg1022.github.io/ODONTOLOGIA/registro.html",
      usuarios: "https://cacg1022.github.io/ODONTOLOGIA/admin-roles.html",
      precios: "https://cacg1022.github.io/ODONTOLOGIA/actualizacion-precios.html",
      profesionales: "https://cacg1022.github.io/ODONTOLOGIA/profesionales-admin.html",

      // âœ… NUEVO: FacturaciÃ³n (solo admin)
      facturacion: "https://cacg1022.github.io/ODONTOLOGIA/facturacion.html",
      reporte_pacientes: "https://cacg1022.github.io/ODONTOLOGIA/reporte-pacientes.html",
      reporte_ventas: "https://cacg1022.github.io/ODONTOLOGIA/reportes.html",

    };
    


    // âœ… Admin por email
    const ADMIN_EMAIL = "Camilo-1000@hotmail.com".toLowerCase();

    function setDisabled(el, disabled, reason = "No autorizado") {
      if (!el) return;

      if (disabled) {
        el.classList.add("disabled");
        el.setAttribute("aria-disabled", "true");
        el.dataset.disabledReason = reason;

        // Evita acumular listeners si se re-ejecuta
        el.onclick = (e) => {
          e.preventDefault();
          alert("ðŸš« Acceso restringido: " + reason);
        };
      } else {
        el.classList.remove("disabled");
        el.removeAttribute("aria-disabled");
        delete el.dataset.disabledReason;

        // si estaba bloqueado, quitamos el onclick de bloqueo
        if (el.onclick) el.onclick = null;
      }
    }

    function wireNav(id, url, mode="open") {
      const el = document.getElementById(id);
      if (!el) return;

      // Evita duplicar listeners
      el.addEventListener("click", (e) => {
        e.preventDefault();

        if (el.classList.contains("disabled")) return;

        if (!url || url === "#") {
          alert("âš ï¸ Esta opciÃ³n aÃºn no tiene URL asignada.");
          return;
        }
        if (mode === "href") window.location.href = url;
        else window.open(url, "_blank");
      }, { passive: false });
    }

    // âœ… Lee rol desde profiles
    async function cargarRolDesdeProfiles(userId) {
      try {
        const { data, error } = await supabase
          .from("profiles")
          .select("role")
          .eq("id", userId)
          .single();

        if (error) {
          console.warn("No se pudo leer profiles.role:", error.message);
          return null;
        }
        return data?.role || null;
      } catch (e) {
        console.warn("Error leyendo role:", e);
        return null;
      }
    }

    async function verificarSesionYPermisos() {
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        window.location.href = LOGIN_URL;
        return;
      }

      const email = (session.user?.email || "").toLowerCase();

      // âœ… Mostrar email
      const u = document.getElementById("user-email");
      if (u) u.textContent = session.user?.email || "Usuario autenticado";

      // âœ… Cargar rol y mostrarlo
      const role = await cargarRolDesdeProfiles(session.user.id);
      const roleEl = document.getElementById("user-role");
      if (roleEl) roleEl.textContent = role ? `Rol: ${role}` : "Rol: (sin rol)";

      // âœ… Permisos admin
      const isAdmin = (email === ADMIN_EMAIL) || (String(role || "").toLowerCase() === "admin");

      // âœ… Activar/Desactivar botones restringidos (SOLO ADMIN)
      setDisabled(document.getElementById("go-registro"), !isAdmin, "Solo administrador");
      setDisabled(document.getElementById("go-rips"), !isAdmin, "Solo administrador");
      setDisabled(document.getElementById("go-usuarios"), !isAdmin, "Solo administrador");
      setDisabled(document.getElementById("go-precios"), !isAdmin, "Solo administrador");
      setDisabled(document.getElementById("go-profesionales"), !isAdmin, "Solo administrador");
      setDisabled(document.getElementById("go-reporte-ventas"), !isAdmin, "Solo administrador");


      // âœ… NUEVO: FacturaciÃ³n (SOLO ADMIN)
      setDisabled(document.getElementById("go-facturacion"), !isAdmin, "Solo administrador");

      // âœ… NavegaciÃ³n
      wireNav("go-agendar", URLS.agendar, "open");
      wireNav("go-agendamiento", URLS.agendamiento, "open");
      wireNav("go-historia", URLS.historia, "href");
      wireNav("go-plan", URLS.plan, "href");
      wireNav("go-hoy", URLS.hoy, "href");
      wireNav("go-rips", URLS.rips, "href");
      wireNav("go-registro", URLS.registro, "href");
      wireNav("go-usuarios", URLS.usuarios, "href");
      wireNav("go-precios", URLS.precios, "href");
      wireNav("go-profesionales", URLS.profesionales, "href");

      // âœ… NUEVO: FacturaciÃ³n (redirige dentro del sitio)
      wireNav("go-facturacion", URLS.facturacion, "href");
      wireNav("go-reporte-pacientes", URLS.reporte_pacientes, "href");
      wireNav("go-reporte-ventas", URLS.reporte_ventas, "href");

      // Fecha
      const t = document.getElementById("today");
      if (t) {
        t.textContent = new Date().toLocaleDateString("es-CO", {
          year:"numeric", month:"long", day:"2-digit"
        });
      }

      const y = document.getElementById("year");
      if (y) y.textContent = new Date().getFullYear();
    }

    verificarSesionYPermisos();

    // Si se expira/cierra, vuelve al login
    supabase.auth.onAuthStateChange((_event, session) => {
      if (!session) window.location.href = LOGIN_URL;
    });

    // Logout
    window.cerrarSesion = async () => {
      try { await supabase.auth.signOut(); } catch(e) {}
      try { localStorage.removeItem("usuario_logueado"); } catch(e) {}
      window.location.href = LOGIN_URL;
    };
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#041722; --bg1:#072738;
      --neon:#20f0d0; --neon2:#66ffb5;
      --glass:rgba(255,255,255,.08);
      --glass2:rgba(255,255,255,.04);
      --border:rgba(255,255,255,.22);
      --text:#fff; --muted:rgba(255,255,255,.7);
      --radius:22px;
      --shadow:0 30px 80px rgba(0,0,0,.6);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,sans-serif;color:var(--text);
      background:
        radial-gradient(900px 520px at 20% 15%, rgba(32,240,208,.25), transparent 60%),
        radial-gradient(780px 520px at 85% 80%, rgba(102,255,181,.18), transparent 62%),
        linear-gradient(150deg,var(--bg0),var(--bg1));
      padding:28px;
    }
    .topbar{
      display:flex;justify-content:space-between;align-items:center;
      background:linear-gradient(180deg,var(--glass),var(--glass2));
      border:1px solid var(--border);border-radius:18px;
      padding:14px 18px;box-shadow:var(--shadow);
    }
    .brand{font-weight:900;letter-spacing:.04em}
    .actions button{
      margin-left:8px;padding:10px 14px;border-radius:14px;
      border:1px solid var(--border);background:rgba(0,0,0,.2);
      color:#fff;font-weight:800;cursor:pointer;
    }
    .actions .primary{background:linear-gradient(135deg,var(--neon),var(--neon2));color:#003333}
    .hero{
      margin-top:24px;padding:28px;border-radius:26px;
      background:linear-gradient(180deg,var(--glass),var(--glass2));
      border:1px solid var(--border);box-shadow:var(--shadow);
      display:grid;grid-template-columns:1.3fr .7fr;gap:20px;
    }
    h1{font-size:48px;margin:0;font-weight:900}
    h1 span{color:var(--neon)}
    .cta button{margin-right:10px}
    .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .kpi{background:rgba(0,0,0,.25);border:1px solid var(--border);border-radius:16px;padding:14px}
    .modules{margin-top:24px;display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .card{padding:18px;border-radius:18px;
      background:linear-gradient(180deg,var(--glass),var(--glass2));
      border:1px solid var(--border);cursor:pointer;
      display:flex;justify-content:space-between;align-items:center;
    }
    .card:hover{border-color:var(--neon)}
    .card.disabled{opacity:.45;cursor:not-allowed}
    @media(max-width:900px){.hero{grid-template-columns:1fr}.modules{grid-template-columns:1fr 1fr}}
    @media(max-width:560px){.modules{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">ðŸ¦· DENTOVA Â· Panel Futurista</div>
    <div class="actions">
      <span id="user-email"></span>
      <button onclick="cerrarSesion()">Cerrar sesiÃ³n</button>
    </div>
  </div>

  <section class="hero">
    <div>
      <h1>DISEÃ‘O <span>FUTURISTA</span><br/>PARA TU SOFTWARE</h1>
      <p>Panel premium con glassmorphism y mÃ³dulos inteligentes.</p>
      <div class="cta">
        <button class="primary">Empezar ahora</button>
      </div>
    </div>
    <div class="kpis">
      <div class="kpi">Citas hoy<br><b>12</b></div>
      <div class="kpi">Pacientes<br><b>3.421</b></div>
      <div class="kpi">Facturas<br><b>$8.9M</b></div>
      <div class="kpi">Alertas<br><b>2</b></div>
    </div>
  </section>

  <section class="modules">
    <div class="card" id="go-historia">Historia ClÃ­nica â†’</div>
    <div class="card" id="go-agendar">Agendamientos â†’</div>
    <div class="card" id="go-facturacion">FacturaciÃ³n â†’</div>
    <div class="card" id="go-plan">Plan de Tratamiento â†’</div>
    <div class="card" id="go-reporte-ventas">Reportes â†’</div>
    <div class="card" id="go-usuarios">AdministraciÃ³n â†’</div>
  </section>
</body>
</html>








