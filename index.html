<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inicio - Cl√≠nica Dra. Leidi Silva</title>

  <!-- ===================== SUPABASE + L√ìGICA ===================== -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ‚úÖ Supabase
    const supabase = createClient(
      "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
    );

    const LOGIN_URL = "https://cacg1022.github.io/ODONTOLOGIA/login.html";

    // ‚úÖ URLs
    const URLS = {
      gestiondepermisos: "https://cacg1022.github.io/ODONTOLOGIA/permisos.html",
      agendar: "https://cacg1022.github.io/ODONTOLOGIA/agendamientos.html",
      plan: "https://cacg1022.github.io/ODONTOLOGIA/plandetratamiento.html",
      historia: "https://cacg1022.github.io/ODONTOLOGIA/historia-clinica.html",
      hoy: "#",
      rips: "#",
      registro: "https://cacg1022.github.io/ODONTOLOGIA/registro.html",
      usuarios: "https://cacg1022.github.io/ODONTOLOGIA/admin-roles.html",
      precios: "https://cacg1022.github.io/ODONTOLOGIA/actualizacion-precios.html",
      profesionales: "https://cacg1022.github.io/ODONTOLOGIA/profesionales-admin.html",
      facturacion: "https://cacg1022.github.io/ODONTOLOGIA/facturacion.html",
      reporte_pacientes: "https://cacg1022.github.io/ODONTOLOGIA/reporte-pacientes.html",
      reporte_ventas: "https://cacg1022.github.io/ODONTOLOGIA/reportes.html"
    };

    // ‚úÖ Admin
    const ADMIN_EMAIL = "camilo-1000@hotmail.com";

    function setDisabled(el, disabled, reason = "No autorizado") {
      if (!el) return;

      if (disabled) {
        el.classList.add("disabled");
        el.setAttribute("aria-disabled", "true");
        el.onclick = (e) => {
          e.preventDefault();
          alert("üö´ Acceso restringido: " + reason);
        };
      } else {
        el.classList.remove("disabled");
        el.removeAttribute("aria-disabled");
        el.onclick = null;
      }
    }

    function wireNav(id, url, mode = "open") {
      const el = document.getElementById(id);
      if (!el) return;

      el.addEventListener("click", (e) => {
        e.preventDefault();
        if (el.classList.contains("disabled")) return;
        if (!url || url === "#") {
          alert("‚ö†Ô∏è Esta opci√≥n a√∫n no tiene URL asignada.");
          return;
        }
        mode === "href"
          ? (window.location.href = url)
          : window.open(url, "_blank");
      });
    }

    async function cargarRolDesdeProfiles(userId) {
      const { data, error } = await supabase
        .from("profiles")
        .select("role")
        .eq("id", userId)
        .single();

      if (error) return null;
      return data?.role ?? null;
    }

    async function verificarSesionYPermisos() {
      const {
        data: { session }
      } = await supabase.auth.getSession();

      if (!session) {
        window.location.href = LOGIN_URL;
        return;
      }

      const email = session.user.email.toLowerCase();

      document.getElementById("user-email").textContent = session.user.email;

      const role = await cargarRolDesdeProfiles(session.user.id);
      document.getElementById("user-role").textContent =
        role ? `Rol: ${role}` : "Rol: (sin rol)";

      const isAdmin = email === ADMIN_EMAIL || role === "admin";

      // Navegaci√≥n
      wireNav("go-agendar", URLS.agendar);
      wireNav("go-gestiondepermisos", URLS.gestiondepermisos);
      wireNav("go-historia", URLS.historia, "href");
      wireNav("go-plan", URLS.plan, "href");
      wireNav("go-hoy", URLS.hoy, "href");
      wireNav("go-rips", URLS.rips, "href");
      wireNav("go-registro", URLS.registro, "href");
      wireNav("go-usuarios", URLS.usuarios, "href");
      wireNav("go-precios", URLS.precios, "href");
      wireNav("go-profesionales", URLS.profesionales, "href");
      wireNav("go-facturacion", URLS.facturacion, "href");
      wireNav("go-reporte-pacientes", URLS.reporte_pacientes, "href");
      wireNav("go-reporte-ventas", URLS.reporte_ventas, "href");

      // Fecha
      document.getElementById("today").textContent =
        new Date().toLocaleDateString("es-CO", {
          year: "numeric",
          month: "long",
          day: "2-digit"
        });

      document.getElementById("year").textContent =
        new Date().getFullYear();
    }

    verificarSesionYPermisos();

    supabase.auth.onAuthStateChange((_e, session) => {
      if (!session) window.location.href = LOGIN_URL;
    });

    window.cerrarSesion = async () => {
      await supabase.auth.signOut();
      localStorage.removeItem("usuario_logueado");
      window.location.href = LOGIN_URL;
    };
  </script>

  <!-- ===================== ESTILOS ===================== -->
  <style>
    /* (Tus estilos est√°n correctos, no se modificaron) */
    /* --- Se mantienen exactamente igual --- */
  </style>
</head>

<body>
  <!-- ===================== CONTENIDO ===================== -->
  <!-- (HTML del dashboard intacto, solo ordenado visualmente) -->
</body>
</html>






