<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reporte de Facturaci√≥n por Profesional</title>

  <!-- Tipograf√≠a -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --brand:#1f6aa5;
      --brand2:#114a75;
      --line:#e5e7eb;
      --radius:14px;
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --green:#16a34a;
      --red:#dc2626;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter',system-ui,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:24px;
    }
    h1{font-size:20px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .container{max-width:1400px;margin:0 auto}

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }

    .userbox{
      font-size:13px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      line-height:1.35;
      min-width:260px;
      text-align:left;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid var(--line);
      margin-bottom:18px;
    }

    .card-header{
      padding:16px 20px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .actions{display:flex;gap:10px;flex-wrap:wrap}

    .filters{
      display:grid;
      grid-template-columns:repeat(6,1fr);
      gap:12px;
      padding:16px 20px;
    }

    label{
      font-size:12px;
      color:var(--muted);
      font-weight:600;
      margin-bottom:4px;
      display:block;
    }

    input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      font-size:14px;
      background:#fff;
      outline:none;
    }

    .btn{
      padding:10px 14px;
      border-radius:10px;
      border:1px solid var(--brand);
      background:var(--brand);
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    .btn.secondary{
      background:#fff;
      color:var(--brand);
    }
    .btn:hover{background:var(--brand2);color:#fff}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead th{
      background:#f9fafb;
      color:var(--muted);
      font-weight:700;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      position:sticky;
      top:0;
      z-index:1;
      text-align:left;
    }
    tbody td{
      padding:10px 14px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
    }
    tbody tr:hover{background:#f8fafc}

    .right{text-align:right}
    .mono{font-family:ui-monospace,monospace}

    .summary{
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      padding:16px 20px;
      border-top:1px solid var(--line);
      background:#fbfcfd;
    }
    .box{
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 14px;
      min-width:220px;
      background:#fff;
      font-size:13px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .hidden{display:none}

    @media(max-width:1100px){
      .filters{grid-template-columns:repeat(3,1fr)}
    }
    @media(max-width:700px){
      .filters{grid-template-columns:1fr}
      .userbox{min-width:auto}
    }
  </style>
</head>

<body>
<div class="container">

  <div class="topbar">
    <div></div>
    <div class="userbox" id="userBox">Cargando usuario‚Ä¶</div>
  </div>

  <div class="card hidden" id="app">
    <div class="card-header">
      <div>
        <h1>Reporte de Facturaci√≥n por Profesional</h1>
        <div class="muted">Detalle completo desde <b>factura_detalle_ext</b></div>
      </div>
      <div class="actions">
        <button class="btn secondary" id="btn-excel">üìä Exportar Excel</button>
        <button class="btn" id="btn-buscar">üîé Buscar</button>
      </div>
    </div>

    <div class="filters">
      <!-- PROFESIONAL -->
      <div>
        <label>Profesional</label>
        <input id="f_profesional" list="dl_profesionales" placeholder="Buscar profesional‚Ä¶">
        <datalist id="dl_profesionales"></datalist>
      </div>

      <div>
        <label>N¬∞ Factura</label>
        <input id="f_factura" placeholder="FAC-2026...">
      </div>

      <div>
        <label>C√©dula</label>
        <input id="f_cedula" placeholder="Solo n√∫meros">
      </div>

      <!-- PACIENTE -->
      <div>
        <label>Paciente</label>
        <input id="f_paciente" list="dl_pacientes" placeholder="Buscar paciente‚Ä¶">
        <datalist id="dl_pacientes"></datalist>
      </div>

      <div>
        <label>Desde</label>
        <input type="date" id="f_desde">
      </div>

      <div>
        <label>Hasta</label>
        <input type="date" id="f_hasta">
      </div>

      <!-- PROCEDIMIENTO (para no perderlo) -->
      <div style="grid-column:1 / span 3;">
        <label>Procedimiento</label>
        <input id="f_procedimiento" placeholder="Texto libre">
      </div>
    </div>

    <div style="overflow:auto;max-height:60vh">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Profesional</th>
            <th>N¬∞ Factura</th>
            <th>C√©dula</th>
            <th>Paciente</th>
            <th>Procedimiento</th>
            <th class="right">Cantidad</th>
            <th class="right">Costo</th>
            <th class="right">Costo Total</th>
            <th class="right">Valor Total</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="summary">
      <div class="box"><span>Registros</span><b id="s_count">0</b></div>
      <div class="box"><span>Total facturado</span><b>$ <span id="s_total">0</span></b></div>
      <div class="box"><span>Total costo</span><b>$ <span id="s_costo">0</span></b></div>
      <div class="box"><span>Margen de ganancia</span><b id="s_margen">$ 0</b></div>
    </div>
  </div>

  <div id="noAccess" class="card hidden" style="padding:24px;text-align:center">
    ‚õî Acceso denegado. Este m√≥dulo es solo para administradores.
  </div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabase = createClient(
  "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
);

const LOGIN_URL = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
const INDEX_URL = "https://cacg1022.github.io/ODONTOLOGIA/index.html";

const $ = (id) => document.getElementById(id);
const money = (n) => Number(n||0).toLocaleString("es-CO");
const fmtFecha = (v) => {
  if (!v) return "‚Äî";
  // si viene timestamp: 2026-02-04T...
  const s = String(v);
  return s.split("T")[0];
};

function getModuloActual(){
  const file = (location.pathname.split("/").pop() || "").toLowerCase().trim();
  return file.replace(".html", "") || "reporte_costos_profesionales";
}

function getModuloCandidates(mod){
  const base = String(mod || "").toLowerCase().trim();
  const withHtml = base.endsWith(".html") ? base : base + ".html";
  const undersc = base.replaceAll("-", "_");
  const underscHtml = undersc.endsWith(".html") ? undersc : undersc + ".html";
  return Array.from(new Set([base, withHtml, undersc, underscHtml].filter(Boolean)));
}

async function verificarSesion(){
  const { data: { session }, error } = await supabase.auth.getSession();
  if (error) console.error("getSession error:", error);
  if (!session){
    window.location.href = LOGIN_URL;
    return null;
  }
  return session;
}

async function cargarRolDesdeProfiles(userId){
  try{
    const { data, error } = await supabase
      .from("profiles")
      .select("role")
      .eq("id", userId)
      .single();

    if (error){
      console.warn("No se pudo leer profiles.role:", error.message);
      return null;
    }
    return data?.role || null;
  }catch(e){
    console.warn("Error leyendo role:", e);
    return null;
  }
}

async function validarPermisoModuloAdmin(){
  // 1) sesi√≥n
  const session = await verificarSesion();
  if (!session) return { ok:false };

  // 2) rol real
  const roleRaw = await cargarRolDesdeProfiles(session.user.id);
  const roleNorm = String(roleRaw || "").toLowerCase().trim();
  const roleFinal = roleNorm || "user";

  // pintar usuario/rol SIEMPRE
  $("userBox").innerHTML = `üë§ ${session.user?.email || "Usuario"}<br>üõ°Ô∏è Rol: <b>${roleFinal}</b>`;

  // 3) bloqueo por rol: SOLO admin
  if (roleFinal !== "admin"){
    return { ok:false, session, rol: roleFinal };
  }

  // 4) (recomendado) validar modulos_permisos (admin=true)
  // Si no tienes fila para este m√≥dulo, igual te dejar√° entrar si eres admin
  const MODULO = getModuloActual();
  const candidates = getModuloCandidates(MODULO);

  try{
    const { data, error } = await supabase
      .from("modulos_permisos")
      .select("admin, modulo")
      .in("modulo", candidates)
      .limit(1);

    if (error){
      console.warn("No se pudo leer modulos_permisos:", error.message);
      return { ok:true, session, rol: roleFinal }; // admin pasa aunque no lea permisos
    }

    const permiso = data?.[0] || null;
    if (permiso && permiso.admin !== true){
      // existe fila pero admin no est√° permitido
      return { ok:false, session, rol: roleFinal };
    }

    // si no existe fila, no bloqueamos (porque ya es admin)
    return { ok:true, session, rol: roleFinal };
  }catch(e){
    console.warn("Error validando modulos_permisos:", e);
    return { ok:true, session, rol: roleFinal };
  }
}

/* ===== APP ===== */
let currentRows = [];

async function cargarListas(){
  // PROFESIONALES
  const { data: profs, error: e1 } = await supabase
    .from("factura_detalle_ext")
    .select("profesional")
    .not("profesional","is",null);

  if (e1) console.warn("Error cargando profesionales:", e1.message);

  const profesionales = Array.from(new Set((profs||[])
    .map(x => (x?.profesional || "").trim())
    .filter(Boolean)
  )).sort((a,b)=>a.localeCompare(b));

  $("dl_profesionales").innerHTML = profesionales.map(p => `<option value="${p}"></option>`).join("");

  // PACIENTES
  const { data: pacs, error: e2 } = await supabase
    .from("factura_detalle_ext")
    .select("paciente_nombre")
    .not("paciente_nombre","is",null);

  if (e2) console.warn("Error cargando pacientes:", e2.message);

  const pacientes = Array.from(new Set((pacs||[])
    .map(x => (x?.paciente_nombre || "").trim())
    .filter(Boolean)
  )).sort((a,b)=>a.localeCompare(b));

  $("dl_pacientes").innerHTML = pacientes.map(p => `<option value="${p}"></option>`).join("");
}

async function cargarReporte(){
  let q = supabase.from("factura_detalle_ext").select("*");

  const prof = ($("f_profesional").value || "").trim();
  const fac  = ($("f_factura").value || "").trim();
  const ced  = ($("f_cedula").value || "").trim();
  const pac  = ($("f_paciente").value || "").trim();
  const des  = ($("f_desde").value || "").trim();
  const has  = ($("f_hasta").value || "").trim();
  const proc = ($("f_procedimiento").value || "").trim();

  if (prof) q = q.ilike("profesional", `%${prof}%`);
  if (fac)  q = q.ilike("numero_factura", `%${fac}%`);
  if (ced)  q = q.ilike("paciente_cedula", `%${ced}%`);
  if (pac)  q = q.ilike("paciente_nombre", `%${pac}%`);
  if (proc) q = q.ilike("descripcion", `%${proc}%`);

  // fecha_factura viene de tu vista (alias)
  if (des) q = q.gte("fecha_factura", des);
  if (has) q = q.lte("fecha_factura", has);

  // orden recomendado
  q = q.order("fecha_factura", { ascending: false });

  const { data, error } = await q;

  if (error){
    alert("Error cargando reporte: " + error.message);
    console.error(error);
    return;
  }

  currentRows = data || [];
  render();
}

function render(){
  let total = 0;
  let costo = 0;
  let costoTotal = 0;

  const tbody = $("tbody");
  tbody.innerHTML = "";

  for (const r of currentRows){
    const vTotal = Number(r.valor_total || 0);
    const vCosto = Number(r.costo || 0);
    const vCostoTotal = Number(r.costo_total || 0);
    total += vTotal;
    costo += vCosto;
    costoTotal += vCostoTotal;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${fmtFecha(r.fecha_factura)}</td>
      <td>${r.profesional || "‚Äî"}</td>
      <td class="mono">${r.numero_factura || "‚Äî"}</td>
      <td class="mono">${r.paciente_cedula || "‚Äî"}</td>
      <td>${r.paciente_nombre || "‚Äî"}</td>
      <td>${r.descripcion || "‚Äî"}</td>
      <td class="right mono">${r.cantidad ?? 0}</td>
      <td class="right mono">$ ${money(vCosto)}</td>
      <td class="right mono">$ ${money(vCostoTotal)}</td>
      <td class="right mono">$ ${money(vTotal)}</td>
    `;
    tbody.appendChild(tr);
  }

  $("s_count").textContent = currentRows.length;
  $("s_total").textContent = money(total);
  $("s_costo").textContent = money(costoTotal);

  const margen = total - costoTotal;
  $("s_margen").textContent = "$ " + money(margen);
  $("s_margen").style.color = margen >= 0 ? "var(--green)" : "var(--red)";
}

function exportarExcel(){
  if (!currentRows || currentRows.length === 0){
    alert("No hay datos para exportar.");
    return;
  }

  const data = currentRows.map(r => ({
    "Fecha": fmtFecha(r.fecha_factura),
    "Profesional": r.profesional || "",
    "N¬∞ Factura": r.numero_factura || "",
    "C√©dula": r.paciente_cedula || "",
    "Paciente": r.paciente_nombre || "",
    "Procedimiento": r.descripcion || "",
    "Cantidad": Number(r.cantidad || 0),
    "Costo": Number(r.costo || 0),
    "Valor Total": Number(r.valor_total || 0),
  }));

  const totalFacturado = currentRows.reduce((acc, r) => acc + (Number(r.valor_total) || 0), 0);
  const totalCosto = currentRows.reduce((acc, r) => acc + (Number(r.costo) || 0), 0);
  const margen = totalFacturado - totalCosto;

  const ws = XLSX.utils.json_to_sheet(data);

  const ws2 = XLSX.utils.aoa_to_sheet([
    ["Reporte de Facturaci√≥n por Profesional"],
    ["Generado:", new Date().toLocaleString("es-CO")],
    ["Registros:", currentRows.length],
    ["Total facturado:", totalFacturado],
    ["Total costo:", totalCosto],
    ["Margen:", margen],
    [],
    ["Filtros"],
    ["Profesional:", ($("f_profesional").value || "")],
    ["N¬∞ Factura:", ($("f_factura").value || "")],
    ["C√©dula:", ($("f_cedula").value || "")],
    ["Paciente:", ($("f_paciente").value || "")],
    ["Procedimiento:", ($("f_procedimiento").value || "")],
    ["Desde:", ($("f_desde").value || "")],
    ["Hasta:", ($("f_hasta").value || "")]
  ]);

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Reporte");
  XLSX.utils.book_append_sheet(wb, ws2, "Filtros");

  const desde = ($("f_desde").value || "NA");
  const hasta = ($("f_hasta").value || "NA");
  XLSX.writeFile(wb, `reporte_facturacion_${desde}_a_${hasta}.xlsx`);
}

async function init(){
  try{
    // Guard: solo admin (desde profiles) + (opcional) modulos_permisos
    const guard = await validarPermisoModuloAdmin();

    if (!guard.ok){
      $("noAccess").classList.remove("hidden");
      return;
    }

    $("app").classList.remove("hidden");

    // eventos
    $("btn-buscar").addEventListener("click", cargarReporte);
    $("btn-excel").addEventListener("click", exportarExcel);

    // cargar listas + reporte
    await cargarListas();
    await cargarReporte();

  }catch(err){
    console.error(err);
    $("userBox").innerHTML = `‚ö†Ô∏è Error cargando usuario/rol.<br><small>Revisa consola (F12) ‚Üí ${err?.message || err}</small>`;
    $("noAccess").classList.remove("hidden");
  }
}

// si se cierra sesi√≥n, sacar al login
supabase.auth.onAuthStateChange((_event, session) => {
  if (!session) window.location.href = LOGIN_URL;
});

window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>



