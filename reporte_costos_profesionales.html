<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reporte de Facturaci√≥n por Profesional</title>

  <!-- Tipograf√≠a -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --brand:#1f6aa5;
      --brand2:#114a75;
      --line:#e5e7eb;
      --radius:14px;
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --green:#16a34a;
      --red:#dc2626;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter',system-ui,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:24px;
    }
    h1{font-size:20px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .container{max-width:1400px;margin:0 auto}

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }

    .userbox{
      font-size:13px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 12px;
      box-shadow:var(--shadow);
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid var(--line);
      margin-bottom:18px;
    }

    .card-header{
      padding:16px 20px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .actions{display:flex;gap:10px}

    .filters{
      display:grid;
      grid-template-columns:repeat(6,1fr);
      gap:12px;
      padding:16px 20px;
    }

    label{
      font-size:12px;
      color:var(--muted);
      font-weight:600;
      margin-bottom:4px;
      display:block;
    }

    input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      font-size:14px;
      background:#fff;
    }

    .btn{
      padding:10px 14px;
      border-radius:10px;
      border:1px solid var(--brand);
      background:var(--brand);
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    .btn.secondary{
      background:#fff;
      color:var(--brand);
    }
    .btn:hover{background:var(--brand2);color:#fff}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead th{
      background:#f9fafb;
      color:var(--muted);
      font-weight:700;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }
    tbody td{
      padding:10px 14px;
      border-bottom:1px solid var(--line);
    }

    .right{text-align:right}
    .mono{font-family:ui-monospace,monospace}

    .summary{
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      padding:16px 20px;
      border-top:1px solid var(--line);
      background:#fbfcfd;
    }
    .box{
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 14px;
      min-width:220px;
      background:#fff;
      font-size:13px;
      display:flex;
      justify-content:space-between;
    }

    .hidden{display:none}
  </style>
</head>

<body>
<div class="container">

  <div class="topbar">
    <div></div>
    <div class="userbox" id="userBox">Cargando usuario‚Ä¶</div>
  </div>

  <div class="card hidden" id="app">
    <div class="card-header">
      <div>
        <h1>Reporte de Facturaci√≥n por Profesional</h1>
        <div class="muted">Detalle completo desde <b>factura_detalle_ext</b></div>
      </div>
      <div class="actions">
        <button class="btn secondary" id="btn-excel">üìä Exportar Excel</button>
        <button class="btn" id="btn-buscar">üîé Buscar</button>
      </div>
    </div>

    <div class="filters">
      <div><label>Profesional</label><input id="f_profesional"></div>
      <div><label>N¬∞ Factura</label><input id="f_factura"></div>
      <div><label>C√©dula</label><input id="f_cedula"></div>
      <div><label>Paciente</label><input id="f_paciente"></div>
      <div><label>Desde</label><input type="date" id="f_desde"></div>
      <div><label>Hasta</label><input type="date" id="f_hasta"></div>
    </div>

    <div style="overflow:auto;max-height:60vh">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Profesional</th>
            <th>Factura</th>
            <th>C√©dula</th>
            <th>Paciente</th>
            <th>Procedimiento</th>
            <th class="right">Cantidad</th>
            <th class="right">Costo</th>
            <th class="right">Valor</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="summary">
      <div class="box"><span>Registros</span><b id="s_count">0</b></div>
      <div class="box"><span>Total facturado</span><b>$ <span id="s_total">0</span></b></div>
      <div class="box"><span>Total costo</span><b>$ <span id="s_costo">0</span></b></div>
      <div class="box"><span>Margen</span><b id="s_margen">$ 0</b></div>
    </div>
  </div>

  <div id="noAccess" class="card hidden" style="padding:24px;text-align:center">
    ‚õî Acceso denegado. Este m√≥dulo es solo para administradores.
  </div>

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabase = createClient(
  "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
);

const $ = id => document.getElementById(id);
const money = n => Number(n||0).toLocaleString("es-CO");
let currentRows = [];

/* ===== AUTH + ROL ROBUSTO ===== */
const { data:{ user } } = await supabase.auth.getUser();

if (!user) {
  $("noAccess").classList.remove("hidden");
  $("userBox").textContent = "No autenticado";
  throw new Error("No autenticado");
}

let role = null;

/* Intentar desde profiles */
try {
  const { data: perfil, error } = await supabase
    .from("profiles")
    .select("rol")
    .eq("id", user.id)
    .single();

  if (!error && perfil?.rol) {
    role = perfil.rol;
  }
} catch (e) {
  console.warn("No se pudo leer profiles");
}

/* Fallback admins */
const ADMIN_EMAILS = [
  "fernav07@hotmail.com"
];

if (!role && ADMIN_EMAILS.includes(user.email)) {
  role = "admin";
}

$("userBox").innerHTML = `
  üë§ ${user.email}<br>
  üõ°Ô∏è Rol: <b>${role || "usuario"}</b>
`;

if (role !== "admin") {
  $("noAccess").classList.remove("hidden");
  throw new Error("Acceso denegado");
}

$("app").classList.remove("hidden");

/* ===== DATA ===== */
async function cargarReporte(){
  let q = supabase.from("factura_detalle_ext").select("*");

  if ($("f_profesional").value) q = q.ilike("profesional", `%${$("f_profesional").value}%`);
  if ($("f_factura").value) q = q.ilike("numero_factura", `%${$("f_factura").value}%`);
  if ($("f_cedula").value) q = q.ilike("paciente_cedula", `%${$("f_cedula").value}%`);
  if ($("f_paciente").value) q = q.ilike("paciente_nombre", `%${$("f_paciente").value}%`);
  if ($("f_desde").value) q = q.gte("fecha_factura", $("f_desde").value);
  if ($("f_hasta").value) q = q.lte("fecha_factura", $("f_hasta").value);

  const { data } = await q;
  currentRows = data || [];
  render();
}

function render(){
  let total=0, costo=0;
  $("tbody").innerHTML = "";

  currentRows.forEach(r=>{
    total += r.valor_total || 0;
    costo += r.costo || 0;

    $("tbody").innerHTML += `
      <tr>
        <td>${r.fecha_factura}</td>
        <td>${r.profesional}</td>
        <td>${r.numero_factura}</td>
        <td>${r.paciente_cedula}</td>
        <td>${r.paciente_nombre}</td>
        <td>${r.descripcion}</td>
        <td class="right">${r.cantidad}</td>
        <td class="right">$ ${money(r.costo)}</td>
        <td class="right">$ ${money(r.valor_total)}</td>
      </tr>`;
  });

  $("s_count").textContent = currentRows.length;
  $("s_total").textContent = money(total);
  $("s_costo").textContent = money(costo);

  const margen = total - costo;
  $("s_margen").textContent = "$ " + money(margen);
  $("s_margen").style.color = margen >= 0 ? "var(--green)" : "var(--red)";
}

$("btn-buscar").onclick = cargarReporte;

$("btn-excel").onclick = ()=>{
  const ws = XLSX.utils.json_to_sheet(currentRows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Reporte");
  XLSX.writeFile(wb, "reporte_facturacion.xlsx");
};

await cargarReporte();
</script>
</body>
</html>


