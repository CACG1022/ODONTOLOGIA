<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reporte de FacturaciÃ³n por Profesional</title>

  <!-- TipografÃ­a -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --brand:#1f6aa5;
      --brand2:#114a75;
      --line:#e5e7eb;
      --radius:14px;
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --green:#16a34a;
      --red:#dc2626;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter',system-ui,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:24px;
    }
    h1{font-size:20px;margin:0 0 6px}
    .muted{color:var(--muted);font-size:13px}
    .container{max-width:1400px;margin:0 auto}

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid var(--line);
      margin-bottom:18px;
    }

    .card-header{
      padding:16px 20px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .filters{
      display:grid;
      grid-template-columns:repeat(6,1fr);
      gap:12px;
      padding:16px 20px;
    }

    .filters label{
      font-size:12px;
      color:var(--muted);
      font-weight:600;
      margin-bottom:4px;
      display:block;
    }

    input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      font-size:14px;
      outline:none;
      background:#fff;
    }

    .btn{
      padding:10px 14px;
      border-radius:10px;
      border:1px solid var(--brand);
      background:var(--brand);
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    .btn:hover{background:var(--brand2)}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead th{
      background:#f9fafb;
      color:var(--muted);
      font-weight:700;
      text-align:left;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      position:sticky;
      top:0;
    }
    tbody td{
      padding:10px 14px;
      border-bottom:1px solid var(--line);
    }
    tbody tr:hover{background:#f8fafc}

    .mono{font-family:ui-monospace,monospace}
    .right{text-align:right}

    .summary{
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      padding:16px 20px;
      border-top:1px solid var(--line);
      background:#fbfcfd;
    }
    .summary .box{
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 14px;
      min-width:220px;
      background:#fff;
    }
    .summary .box div{
      display:flex;
      justify-content:space-between;
      font-size:13px;
      padding:4px 0;
    }

    @media(max-width:1200px){
      .filters{grid-template-columns:repeat(3,1fr)}
    }
    @media(max-width:700px){
      .filters{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
<div class="container">

  <div class="card">
    <div class="card-header">
      <div>
        <h1>Reporte de FacturaciÃ³n por Profesional</h1>
        <div class="muted">Detalle completo desde <b>factura_detalle_ext</b></div>
      </div>
      <button class="btn" id="btn-buscar">ðŸ”Ž Buscar</button>
    </div>

    <div class="filters">
      <div>
        <label>Profesional</label>
        <input id="f_profesional" list="lista_profesionales" placeholder="Buscar profesional..." />
        <datalist id="lista_profesionales"></datalist>
      </div>

      <div>
        <label>NÂ° Factura</label>
        <input id="f_factura" placeholder="FAC-2026..." />
      </div>

      <div>
        <label>CÃ©dula paciente</label>
        <input id="f_cedula" placeholder="Solo nÃºmeros" />
      </div>

      <div>
        <label>Paciente</label>
        <input id="f_paciente" list="lista_pacientes" placeholder="Buscar paciente..." />
        <datalist id="lista_pacientes"></datalist>
      </div>

      <div>
        <label>Desde</label>
        <input type="date" id="f_desde" />
      </div>

      <div>
        <label>Hasta</label>
        <input type="date" id="f_hasta" />
      </div>

      <div>
        <label>Procedimiento</label>
        <input id="f_procedimiento" placeholder="Texto libre" />
      </div>
    </div>

    <div style="overflow:auto; max-height:65vh;">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Profesional</th>
            <th>NÂ° Factura</th>
            <th>CÃ©dula</th>
            <th>Paciente</th>
            <th>Procedimiento</th>
            <th class="right">Cantidad</th>
            <th class="right">Costo</th>
            <th class="right">Valor Total</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="summary">
      <div class="box"><div><span>Registros</span><b id="s_count">0</b></div></div>
      <div class="box"><div><span>Total facturado</span><b>$ <span id="s_total">0</span></b></div></div>
      <div class="box"><div><span>Total costo</span><b>$ <span id="s_costo">0</span></b></div></div>
      <div class="box">
        <div>
          <span>Margen de ganancia</span>
          <b id="s_margen">$ 0</b>
        </div>
      </div>
    </div>
  </div>

</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const supabase = createClient(
    "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
  );

  const $ = id => document.getElementById(id);
  const money = n => Number(n||0).toLocaleString("es-CO");

  async function cargarListas(){
    const { data: profs } = await supabase
      .from("factura_detalle_ext")
      .select("profesional")
      .not("profesional", "is", null);

    $("lista_profesionales").innerHTML =
      [...new Set((profs||[]).map(p=>p.profesional))]
        .map(p=>`<option value="${p}"></option>`).join("");

    const { data: pacs } = await supabase
      .from("factura_detalle_ext")
      .select("paciente_nombre");

    $("lista_pacientes").innerHTML =
      [...new Set((pacs||[]).map(p=>p.paciente_nombre))]
        .map(p=>`<option value="${p}"></option>`).join("");
  }

  async function cargarReporte(){
    let q = supabase.from("factura_detalle_ext").select("*");

    if ($("f_profesional").value)
      q = q.ilike("profesional", `%${$("f_profesional").value}%`);

    if ($("f_factura").value)
      q = q.ilike("numero_factura", `%${$("f_factura").value}%`);

    if ($("f_cedula").value)
      q = q.ilike("paciente_cedula", `%${$("f_cedula").value}%`);

    if ($("f_paciente").value)
      q = q.ilike("paciente_nombre", `%${$("f_paciente").value}%`);

    if ($("f_procedimiento").value)
      q = q.ilike("descripcion", `%${$("f_procedimiento").value}%`);

    if ($("f_desde").value)
      q = q.gte("fecha_factura", $("f_desde").value);

    if ($("f_hasta").value)
      q = q.lte("fecha_factura", $("f_hasta").value);

    const { data, error } = await q;
    if (error) return alert(error.message);

    renderTabla(data||[]);
  }

  function renderTabla(rows){
    const tbody = $("tbody");
    tbody.innerHTML = "";

    let total = 0;
    let costo = 0;

    rows.forEach(r=>{
      total += Number(r.valor_total||0);
      costo += Number(r.costo||0);

      tbody.innerHTML += `
        <tr>
          <td class="mono">${r.fecha_factura||"â€”"}</td>
          <td>${r.profesional||"â€”"}</td>
          <td class="mono">${r.numero_factura||"â€”"}</td>
          <td class="mono">${r.paciente_cedula||"â€”"}</td>
          <td>${r.paciente_nombre||"â€”"}</td>
          <td>${r.descripcion||"â€”"}</td>
          <td class="right mono">${r.cantidad||0}</td>
          <td class="right mono">$ ${money(r.costo)}</td>
          <td class="right mono">$ ${money(r.valor_total)}</td>
        </tr>
      `;
    });

    const margen = total - costo;
    const margenEl = $("s_margen");

    margenEl.textContent = `$ ${money(margen)}`;
    margenEl.style.color = margen >= 0 ? "var(--green)" : "var(--red)";

    $("s_count").textContent = rows.length;
    $("s_total").textContent = money(total);
    $("s_costo").textContent = money(costo);
  }

  $("btn-buscar").addEventListener("click", cargarReporte);

  await cargarListas();
  await cargarReporte();
</script>
</body>
</html>

