<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reporte de Facturaci√≥n por Profesional</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f4f6f8;
      --card:#ffffff;
      --line:#e5e7eb;
      --text:#1f2937;
      --muted:#6b7280;
      --brand:#1f6aa5;
      --green:#16a34a;
      --red:#dc2626;
      --radius:14px;
      --shadow:0 10px 25px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;padding:24px;font-family:Inter;background:var(--bg)}
    .container{max-width:1400px;margin:auto}

    .topbar{
      display:flex;justify-content:flex-end;margin-bottom:16px
    }
    .userbox{
      background:#fff;border:1px solid var(--line);
      border-radius:12px;padding:8px 12px;
      box-shadow:var(--shadow);font-size:13px
    }

    .card{
      background:var(--card);border-radius:var(--radius);
      box-shadow:var(--shadow);border:1px solid var(--line)
    }

    .hidden{display:none}

    .filters{
      display:grid;grid-template-columns:repeat(6,1fr);
      gap:12px;padding:16px
    }
    label{font-size:12px;color:var(--muted);font-weight:600}
    input{
      width:100%;padding:10px;border-radius:10px;
      border:1px solid var(--line)
    }

    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid var(--line)}
    th{background:#f9fafb;color:var(--muted)}

    .summary{display:flex;gap:16px;padding:16px}
    .box{
      background:#fff;border:1px solid var(--line);
      border-radius:12px;padding:12px;min-width:220px;
      display:flex;justify-content:space-between
    }

    .btn{
      padding:10px 14px;border-radius:10px;
      border:1px solid var(--brand);
      background:var(--brand);color:#fff;font-weight:700;
      cursor:pointer
    }
    .btn.secondary{background:#fff;color:var(--brand)}
  </style>
</head>

<body>
<div class="container">

  <div class="topbar">
    <div class="userbox" id="userBox">Cargando usuario‚Ä¶</div>
  </div>

  <div id="noAccess" class="card hidden" style="padding:24px;text-align:center">
    ‚õî Acceso denegado. Este m√≥dulo es solo para administradores.
  </div>

  <div class="card hidden" id="app">

    <div style="padding:16px;display:flex;justify-content:space-between">
      <div>
        <h3>Reporte de Facturaci√≥n por Profesional</h3>
        <small class="muted">Vista: factura_detalle_ext</small>
      </div>
      <div>
        <button class="btn secondary" id="btn-excel">üìä Excel</button>
        <button class="btn" id="btn-buscar">üîé Buscar</button>
      </div>
    </div>

    <div class="filters">
      <div>
        <label>Profesional</label>
        <input id="f_profesional" list="dl_profesionales">
        <datalist id="dl_profesionales"></datalist>
      </div>

      <div>
        <label>Factura</label>
        <input id="f_factura">
      </div>

      <div>
        <label>C√©dula</label>
        <input id="f_cedula">
      </div>

      <div>
        <label>Paciente</label>
        <input id="f_paciente" list="dl_pacientes">
        <datalist id="dl_pacientes"></datalist>
      </div>

      <div>
        <label>Desde</label>
        <input type="date" id="f_desde">
      </div>

      <div>
        <label>Hasta</label>
        <input type="date" id="f_hasta">
      </div>
    </div>

    <div style="max-height:60vh;overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Fecha</th><th>Profesional</th><th>Factura</th>
            <th>C√©dula</th><th>Paciente</th><th>Procedimiento</th>
            <th>Cant</th><th>Costo</th><th>Valor</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="summary">
      <div class="box"><span>Registros</span><b id="s_count">0</b></div>
      <div class="box"><span>Total facturado</span><b>$ <span id="s_total">0</span></b></div>
      <div class="box"><span>Total costo</span><b>$ <span id="s_costo">0</span></b></div>
      <div class="box"><span>Margen</span><b id="s_margen">$ 0</b></div>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabase = createClient(
  "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
  "TU_ANON_KEY"
);

const $ = id => document.getElementById(id);
const money = n => Number(n||0).toLocaleString("es-CO");
let rows = [];

/* üîê AUTH + ROL REAL */
const { data:{ session } } = await supabase.auth.getSession();
if (!session) location.href = "login.html";

const { data: profile } = await supabase
  .from("profiles")
  .select("role")
  .eq("id", session.user.id)
  .single();

const role = (profile?.role || "").toLowerCase();

$("userBox").innerHTML = `üë§ ${session.user.email}<br>üõ°Ô∏è Rol: <b>${role}</b>`;

if (role !== "admin"){
  $("noAccess").classList.remove("hidden");
  throw new Error("No admin");
}

$("app").classList.remove("hidden");

/* üìã LISTAS */
async function cargarListas(){
  const { data: p } = await supabase.from("factura_detalle_ext").select("profesional").not("profesional","is",null);
  [...new Set(p.map(x=>x.profesional))].forEach(v=>dl_profesionales.innerHTML+=`<option value="${v}">`);

  const { data: pa } = await supabase.from("factura_detalle_ext").select("paciente_nombre");
  [...new Set(pa.map(x=>x.paciente_nombre))].forEach(v=>dl_pacientes.innerHTML+=`<option value="${v}">`);
}

/* üìä DATA */
async function cargarReporte(){
  let q = supabase.from("factura_detalle_ext").select("*");
  if (f_profesional.value) q=q.ilike("profesional",`%${f_profesional.value}%`);
  if (f_factura.value) q=q.ilike("numero_factura",`%${f_factura.value}%`);
  if (f_cedula.value) q=q.ilike("paciente_cedula",`%${f_cedula.value}%`);
  if (f_paciente.value) q=q.ilike("paciente_nombre",`%${f_paciente.value}%`);
  if (f_desde.value) q=q.gte("fecha_factura",f_desde.value);
  if (f_hasta.value) q=q.lte("fecha_factura",f_hasta.value);

  const { data } = await q;
  rows = data || [];
  render();
}

function render(){
  tbody.innerHTML="";
  let total=0,costo=0;
  rows.forEach(r=>{
    total+=r.valor_total||0;
    costo+=r.costo||0;
    tbody.innerHTML+=`
      <tr>
        <td>${r.fecha_factura}</td>
        <td>${r.profesional}</td>
        <td>${r.numero_factura}</td>
        <td>${r.paciente_cedula}</td>
        <td>${r.paciente_nombre}</td>
        <td>${r.descripcion}</td>
        <td>${r.cantidad}</td>
        <td>$ ${money(r.costo)}</td>
        <td>$ ${money(r.valor_total)}</td>
      </tr>`;
  });

  s_count.textContent=rows.length;
  s_total.textContent=money(total);
  s_costo.textContent=money(costo);

  const m = total-costo;
  s_margen.textContent="$ "+money(m);
  s_margen.style.color = m>=0?"var(--green)":"var(--red)";
}

btn-buscar.onclick=cargarReporte;
btn-excel.onclick=()=>{
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(rows),"Reporte");
  XLSX.writeFile(wb,"reporte_facturacion.xlsx");
};

await cargarListas();
await cargarReporte();
</script>
</body>
</html>



