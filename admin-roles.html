<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Administrar Roles - Cl√≠nica2</title>
  <style>
    body{
      font-family: Arial, sans-serif;
      background:#eef3ff;
      margin:0;
      padding:24px;
    }
    .card{
      max-width: 980px;
      margin: 0 auto;
      background:#fff;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      padding:18px;
    }
    h2{ margin:0 0 12px; }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom:12px;
    }
    input{
      padding:10px;
      border:1px solid #ccc;
      border-radius:8px;
      min-width:260px;
      flex:1;
    }
    button{
      padding:10px 12px;
      border:none;
      border-radius:8px;
      background:#2c52ff;
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    button:hover{ background:#1a38cc; }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
    }
    th, td{
      border-bottom:1px solid #eee;
      padding:10px;
      text-align:left;
      font-size:14px;
    }
    th{ background:#fafafa; }
    select{
      padding:8px;
      border:1px solid #ccc;
      border-radius:8px;
    }
    .muted{ color:#6b7280; font-size:12px; }
    .msg{ margin-top:10px; color:#b91c1c; white-space:pre-line; }
    .ok{ color:#047857; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Administrar usuarios y roles</h2>
    <div class="muted">Acceso controlado por permisos (modulos_permisos).</div>

    <div class="row" style="margin-top:12px;">
      <input id="q" placeholder="Buscar por email (opcional)..." />
      <button id="btn-refresh">Actualizar lista</button>
      <button id="btn-logout" style="background:#111827;">Cerrar sesi√≥n</button>
    </div>

    <div id="status" class="msg"></div>

    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>Rol</th>
          <th>Creado</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // =========================
    // ‚úÖ DEBUG GLOBAL (si algo falla, lo ver√°s en pantalla)
    // =========================
    function showFatal(msg){
      const status = document.getElementById("status");
      if (status){
        status.textContent = msg;
        status.className = "msg";
      }
      console.error(msg);
      alert(msg);
    }

    window.addEventListener("error", (e) => {
      const m = e?.message || "Error JS";
      showFatal("‚ùå Error JS:\n" + m + "\n\nRevisa consola (F12).");
    });

    window.addEventListener("unhandledrejection", (e) => {
      const m = (e?.reason && (e.reason.message || JSON.stringify(e.reason))) || "Promise error";
      showFatal("‚ùå Error (Promise):\n" + m + "\n\nRevisa consola (F12).");
    });

    // =========================
    // ‚úÖ SUPABASE
    // =========================
    const supabaseUrl = "https://dmcfrmpqlkrqbpjhrfyo.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE";
    const supabase = createClient(supabaseUrl, supabaseKey);

    // ‚úÖ URLs (GitHub Pages)
    const LOGIN_URL = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
    const INDEX_URL = "https://cacg1022.github.io/ODONTOLOGIA/index.html";

    // ‚úÖ Nombre del m√≥dulo (debe existir en modulos_permisos.modulo)
    // admin-roles.html -> admin-roles
    const MODULO = (location.pathname.split("/").pop() || "")
      .toLowerCase()
      .trim()
      .replace(".html", "");

    const tbody = document.getElementById("tbody");
    const status = document.getElementById("status");

    function setStatus(msg, ok=false){
      status.textContent = msg || "";
      status.className = "msg" + (ok ? " ok" : "");
    }

    async function verificarSesion() {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error) console.error("getSession error:", error);
      if (!session){
        window.location.href = LOGIN_URL;
        return null;
      }
      return session;
    }

    function getModuloCandidates(mod){
      const base = String(mod || "").toLowerCase().trim();
      const withHtml = base.endsWith(".html") ? base : (base + ".html");
      const undersc = base.replaceAll("-", "_");
      const underscHtml = undersc.endsWith(".html") ? undersc : (undersc + ".html");
      return Array.from(new Set([base, withHtml, undersc, underscHtml].filter(Boolean)));
    }

    /**
     * ‚úÖ Guard principal: SOLO usa la tabla modulos_permisos (como permisos.html)
     * - Lee el rol desde profiles.role
     * - Busca el m√≥dulo por candidatos (admin-roles / admin-roles.html / admin_roles / admin_roles.html)
     * - Si no est√° permitido, redirige al index
     */
    async function validarPermisoModulo(){
      const session = await verificarSesion();
      if (!session) return { ok:false };

      // rol desde profiles
      const { data: perfil, error: ePerfil } = await supabase
        .from("profiles")
        .select("role")
        .eq("id", session.user.id)
        .single();

      if (ePerfil || !perfil?.role){
        alert("No se pudo obtener tu rol (profiles).");
        window.location.href = INDEX_URL;
        return { ok:false };
      }

      const rol = String(perfil.role).toLowerCase().trim();
      const candidates = getModuloCandidates(MODULO);

      console.log("üîé MODULO:", MODULO, "candidates:", candidates, "rol:", rol);

      const { data: permisos, error: ePerm } = await supabase
        .from("modulos_permisos")
        .select("admin, doctor, auxiliar, paciente, modulo")
        .in("modulo", candidates);

      if (ePerm){
        console.error("‚ùå Error modulos_permisos:", ePerm);
        alert("Error leyendo permisos del m√≥dulo: " + (ePerm.message || "Error"));
        window.location.href = INDEX_URL;
        return { ok:false };
      }

      const permiso = (permisos || [])[0] || null;

      if (!permiso){
        alert("M√≥dulo no configurado en permisos.");
        window.location.href = INDEX_URL;
        return { ok:false };
      }

      if (!permiso[rol]){
        alert("‚õî No tienes permiso para acceder a este m√≥dulo.");
        window.location.href = INDEX_URL;
        return { ok:false };
      }

      return { ok:true, session, rol, permiso };
    }

    function roleSelect(current){
      const roles = ["user","doctor","auxiliar","admin"];
      return `
        <select class="role">
          ${roles.map(r => `<option value="${r}" ${r===current?"selected":""}>${r}</option>`).join("")}
        </select>
      `;
    }

    function fmtDate(v){
      if(!v) return "";
      try { return new Date(v).toLocaleString("es-CO"); } catch { return v; }
    }

    async function loadProfiles(){
      setStatus("Cargando usuarios...");
      tbody.innerHTML = "";

      const q = (document.getElementById("q").value || "").trim().toLowerCase();

      let query = supabase
        .from("profiles")
        .select("id,email,role,created_at")
        .order("created_at", { ascending: false })
        .limit(200);

      if (q) query = query.ilike("email", `%${q}%`);

      const { data, error } = await query;

      console.log("üì¶ profiles -> data:", data, "error:", error);

      if (error){
        setStatus(
          "Error cargando perfiles:\n" +
          (error.message || "") +
          (error.details ? ("\n\nDetalles:\n" + error.details) : "") +
          (error.hint ? ("\n\nHint:\n" + error.hint) : "") +
          (error.code ? ("\n\nCode: " + error.code) : "")
        );
        return;
      }

      if (!data || data.length === 0){
        setStatus(
          "No hay usuarios para mostrar.\n" +
          "Si esperabas ver usuarios, revisa RLS/policies de SELECT en profiles.",
          false
        );
        return;
      }

      for (const p of data){
        const tr = document.createElement("tr");
        tr.dataset.id = p.id;

        tr.innerHTML = `
          <td>${p.email || ""}</td>
          <td>${roleSelect((p.role || "user").toLowerCase())}</td>
          <td>${fmtDate(p.created_at)}</td>
          <td><button class="save">Guardar</button></td>
        `;

        tr.querySelector(".save").addEventListener("click", async () => {
          const newRole = tr.querySelector(".role").value;

          setStatus("Actualizando rol...");
          const { error: uerr } = await supabase
            .from("profiles")
            .update({ role: newRole })
            .eq("id", p.id);

          if (uerr){
            setStatus("No se pudo actualizar:\n" + (uerr.message || "Error"));
            return;
          }

          setStatus("‚úÖ Rol actualizado para " + (p.email || ""), true);
        });

        tbody.appendChild(tr);
      }

      setStatus("Usuarios cargados: " + data.length, true);
    }

    async function cerrarSesion(){
      try { await supabase.auth.signOut(); } catch(e){}
      window.location.href = LOGIN_URL;
    }

    async function init(){
      setStatus("Inicializando...");

      // ‚úÖ bind botones SIEMPRE (para que nunca ‚Äúqueden muertos‚Äù)
      document.getElementById("btn-refresh").addEventListener("click", loadProfiles);
      document.getElementById("btn-logout").addEventListener("click", cerrarSesion);

      // ‚úÖ √öNICO guard: permisos por rol (modulos_permisos)
      const guard = await validarPermisoModulo();
      if (!guard.ok) return;

      // ‚úÖ cargar
      await loadProfiles();
    }

    // ‚úÖ Garantiza que el DOM exista antes de correr todo
    window.addEventListener("DOMContentLoaded", () => {
      try { init(); }
      catch (e){
        console.error(e);
        showFatal("‚ùå Fall√≥ init:\n" + (e?.message || "Error") + "\n\nRevisa consola (F12).");
      }
    });
  </script>
</body>
</html>


