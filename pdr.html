<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Google Maps + KML/KMZ + Formulario</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial; }
    #map { height: 100%; width: 100%; }

    /* Panel flotante del formulario */
    #panel {
      position: absolute;
      left: 12px;
      top: 12px;
      z-index: 10;
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
      width: 320px;
      max-width: calc(100% - 24px);
    }
    #panel h3 { margin: 0 0 10px; font-size: 16px; }
    #panel label { display:block; font-size: 12px; margin-top: 8px; }
    #panel input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    #panel .row { display:flex; gap:8px; }
    #panel .row > div { flex:1; }

    #panel .btns { display:flex; gap:8px; margin-top: 10px; }
    button {
      padding: 10px;
      border: 0;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    #saveBtn { background: #1a73e8; color: #fff; flex: 1; }
    #cancelBtn { background: #f1f3f4; flex: 1; }

    /* Barra inferior */
    #bottomBar {
      position: absolute;
      left: 12px;
      bottom: 12px;
      z-index: 10;
      background: rgba(255,255,255,.92);
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
      width: 520px;
      max-width: calc(100% - 24px);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    #kmlUrl { flex: 1; min-width: 220px; }
    .hint { font-size: 12px; color: #5f6368; margin-top: 6px; }
    .small { font-size: 12px; color: #5f6368; }
    .pill {
      background: #f1f3f4;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <!-- Formulario -->
  <div id="panel" style="display:none;">
    <h3>Nuevo registro</h3>

    <label>ID</label>
    <input id="idField" type="text" readonly />

    <label>Nombre</label>
    <input id="nameField" type="text" placeholder="Ej: Camilo" />

    <div class="row">
      <div>
        <label>Fecha</label>
        <input id="dateField" type="date" />
      </div>
      <div>
        <label>Hora</label>
        <input id="timeField" type="time" />
      </div>
    </div>

    <div class="btns">
      <button id="saveBtn" type="button">Guardar</button>
      <button id="cancelBtn" type="button">Cancelar</button>
    </div>

    <div class="hint" id="coordHint"></div>
  </div>

  <!-- Barra inferior para capa -->
  <div id="bottomBar">
    <div class="pill">Capa recomendada: KML en GitHub Pages</div>

    <input id="kmlUrl" type="text"
      placeholder="Pega URL directa a .kml o .kmz (mejor .kml)"
      value="https://cacg1022.github.io/ODONTOLOGIA/data/capa.kml" />

    <button id="loadKmlBtn" type="button">Cargar URL</button>
    <button id="loadDefaultBtn" type="button">Cargar capa del repo</button>
    <button id="clearKmlBtn" type="button">Quitar capa</button>

    <div class="small">
      Sube tu archivo al repo en <b>ODONTOLOGIA/data/</b> y cambia <b>capa.kml</b> por tu nombre real.
    </div>
  </div>

  <div id="map"></div>

  <script>
    let map;
    let kmlLayer = null;

    // Para el punto tocado
    let pendingLatLng = null;
    let tempMarker = null;

    // Contador simple para IDs
    let nextId = 1;

    // Guardamos registros en memoria (luego puedes enviarlos a Supabase)
    const registros = [];

    // ⭐ Cambia aquí si tu archivo tiene otro nombre:
    const DEFAULT_LAYER_URL = "https://cacg1022.github.io/ODONTOLOGIA/data/capa.kml";

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 4.7110, lng: -74.0721 }, // Bogotá
        zoom: 12,
        mapTypeId: "roadmap"
      });

      // Click/touch en el mapa
      map.addListener("click", (e) => {
        pendingLatLng = e.latLng;

        // Marcador temporal
        if (tempMarker) tempMarker.setMap(null);
        tempMarker = new google.maps.Marker({
          position: pendingLatLng,
          map,
          title: "Nuevo punto"
        });

        // Form
        document.getElementById("idField").value = generarId();
        document.getElementById("nameField").value = "";

        const now = new Date();
        document.getElementById("dateField").value = now.toISOString().slice(0,10);
        document.getElementById("timeField").value = now.toTimeString().slice(0,5);

        document.getElementById("coordHint").textContent =
          `Coordenadas: ${pendingLatLng.lat().toFixed(6)}, ${pendingLatLng.lng().toFixed(6)}`;

        mostrarPanel(true);
      });

      // Botones capa
      document.getElementById("loadKmlBtn").addEventListener("click", () => {
        const url = document.getElementById("kmlUrl").value.trim();
        if (!url) return alert("Pega una URL directa a .kml o .kmz");
        cargarKmlKmz(url);
      });

      document.getElementById("loadDefaultBtn").addEventListener("click", () => {
        document.getElementById("kmlUrl").value = DEFAULT_LAYER_URL;
        cargarKmlKmz(DEFAULT_LAYER_URL);
      });

      document.getElementById("clearKmlBtn").addEventListener("click", () => {
        if (kmlLayer) kmlLayer.setMap(null);
        kmlLayer = null;
        alert("Capa removida.");
      });

      // Guardar registro
      document.getElementById("saveBtn").addEventListener("click", () => {
        if (!pendingLatLng) return;

        const id = document.getElementById("idField").value.trim();
        const nombre = document.getElementById("nameField").value.trim();
        const fecha = document.getElementById("dateField").value;
        const hora = document.getElementById("timeField").value;

        if (!nombre) return alert("Por favor escribe un nombre.");

        const registro = {
          id, nombre, fecha, hora,
          lat: pendingLatLng.lat(),
          lng: pendingLatLng.lng()
        };
        registros.push(registro);

        // Marcador definitivo
        const marker = new google.maps.Marker({
          position: pendingLatLng,
          map,
          title: `${id} - ${nombre}`
        });

        const info = new google.maps.InfoWindow({
          content: `
            <div style="font-family:system-ui,Arial; font-size:14px;">
              <b>ID:</b> ${escapeHtml(id)}<br/>
              <b>Nombre:</b> ${escapeHtml(nombre)}<br/>
              <b>Fecha:</b> ${escapeHtml(fecha)}<br/>
              <b>Hora:</b> ${escapeHtml(hora)}<br/>
              <b>Lat/Lng:</b> ${registro.lat.toFixed(6)}, ${registro.lng.toFixed(6)}
            </div>
          `
        });

        marker.addListener("click", () => info.open({ anchor: marker, map }));

        // Limpiar
        if (tempMarker) tempMarker.setMap(null);
        tempMarker = null;
        pendingLatLng = null;
        mostrarPanel(false);

        console.log("Registros:", registros);
      });

      // Cancelar
      document.getElementById("cancelBtn").addEventListener("click", () => {
        if (tempMarker) tempMarker.setMap(null);
        tempMarker = null;
        pendingLatLng = null;
        mostrarPanel(false);
      });

      // (Opcional) intenta cargar la capa por defecto al iniciar:
      // cargarKmlKmz(DEFAULT_LAYER_URL);
    }

    function cargarKmlKmz(url) {
      // Quitar capa anterior
      if (kmlLayer) kmlLayer.setMap(null);

      // Crea capa KML/KMZ
      kmlLayer = new google.maps.KmlLayer({
        url,
        map,
        preserveViewport: false
      });

      // Diagnóstico
      kmlLayer.addListener("status_changed", () => {
        const status = kmlLayer.getStatus();
        console.log("KML/KMZ status:", status, "URL:", url);

        if (status !== "OK") {
          let tip = "";
          if (status === "FETCH_ERROR") {
            tip = "El archivo no es accesible directo (Drive suele fallar). Sube el .kml a GitHub Pages o usa URL directa.";
          } else if (status === "INVALID_DOCUMENT") {
            tip = "El archivo parece corrupto o no es KML/KMZ válido. Prueba convertir KMZ → KML.";
          } else if (status === "DOCUMENT_NOT_FOUND") {
            tip = "La URL no existe (404). Revisa el nombre y la ruta.";
          } else {
            tip = "Revisa permisos y que sea URL directa al archivo.";
          }

          alert("No se pudo cargar el KML/KMZ.\nEstado: " + status + "\n\n" + tip);
        }
      });
    }

    function mostrarPanel(show) {
      document.getElementById("panel").style.display = show ? "block" : "none";
    }

    function generarId() {
      const id = "P-" + String(nextId).padStart(4, "0");
      nextId += 1;
      return id;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }
  </script>

  <!-- Carga Google Maps JS API (REEMPLAZA por tu key si cambiaste) -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDiwSBJ3zp6ysMWJqwVmxunpawTOsYYATw&callback=initMap"
    async defer></script>
</body>
</html>

