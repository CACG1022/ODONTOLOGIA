<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Google Maps + GeoJSON + Formulario</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial; }
    #map { height: 100%; width: 100%; }

    /* Panel flotante del formulario */
    #panel {
      position: absolute;
      left: 12px;
      top: 12px;
      z-index: 10;
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
      width: 320px;
      max-width: calc(100% - 24px);
      display: none;
    }
    #panel h3 { margin: 0 0 10px; font-size: 16px; }
    #panel label { display:block; font-size: 12px; margin-top: 8px; }
    #panel input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    #panel .row { display:flex; gap:8px; }
    #panel .row > div { flex:1; }

    #panel .btns { display:flex; gap:8px; margin-top: 10px; }
    button {
      padding: 10px;
      border: 0;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    #saveBtn { background: #1a73e8; color: #fff; flex: 1; }
    #cancelBtn { background: #f1f3f4; flex: 1; }

    /* Barra inferior */
    #bottomBar {
      position: absolute;
      left: 12px;
      bottom: 12px;
      z-index: 10;
      background: rgba(255,255,255,.92);
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
      width: 640px;
      max-width: calc(100% - 24px);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    #geoUrl { flex: 1; min-width: 260px; }
    .hint { font-size: 12px; color: #5f6368; margin-top: 6px; }
    .small { font-size: 12px; color: #5f6368; }
    .pill {
      background: #f1f3f4;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <!-- Formulario -->
  <div id="panel">
    <h3>Nuevo registro</h3>

    <label>ID</label>
    <input id="idField" type="text" readonly />

    <label>Nombre</label>
    <input id="nameField" type="text" placeholder="Ej: Camilo" />

    <div class="row">
      <div>
        <label>Fecha</label>
        <input id="dateField" type="date" />
      </div>
      <div>
        <label>Hora</label>
        <input id="timeField" type="time" />
      </div>
    </div>

    <div class="btns">
      <button id="saveBtn" type="button">Guardar</button>
      <button id="cancelBtn" type="button">Cancelar</button>
    </div>

    <div class="hint" id="coordHint"></div>
  </div>

  <!-- Barra inferior -->
  <div id="bottomBar">
    <div class="pill">Cartografía (GeoJSON)</div>

    <input id="geoUrl" type="text"
      value="https://storage.googleapis.com/gpkg-json-camilo/cartografia2.geojson"
      placeholder="URL pública directa a .geojson" />

    <button id="loadGeoBtn" type="button">Cargar GeoJSON</button>
    <button id="clearGeoBtn" type="button">Quitar GeoJSON</button>

    <div class="small">
      Tip: Si el GeoJSON es pesado, puede tardar unos segundos en dibujar.
    </div>
  </div>

  <div id="map"></div>

  <script>
    let map;

    // Punto tocado
    let pendingLatLng = null;
    let tempMarker = null;

    // IDs
    let nextId = 1;

    // Registros en memoria
    const registros = [];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 4.7110, lng: -74.0721 }, // Bogotá
        zoom: 11,
        mapTypeId: "roadmap"
      });

      // Estilo de la cartografía (GeoJSON)
      map.data.setStyle({
        fillColor: "#1a73e8",
        fillOpacity: 0.20,
        strokeColor: "#1a73e8",
        strokeWeight: 2
      });

      // Click/touch en el mapa -> abrir formulario
      map.addListener("click", (e) => {
        pendingLatLng = e.latLng;

        if (tempMarker) tempMarker.setMap(null);
        tempMarker = new google.maps.Marker({
          position: pendingLatLng,
          map,
          title: "Nuevo punto"
        });

        document.getElementById("idField").value = generarId();
        document.getElementById("nameField").value = "";

        const now = new Date();
        document.getElementById("dateField").value = now.toISOString().slice(0, 10);
        document.getElementById("timeField").value = now.toTimeString().slice(0, 5);

        document.getElementById("coordHint").textContent =
          `Coordenadas: ${pendingLatLng.lat().toFixed(6)}, ${pendingLatLng.lng().toFixed(6)}`;

        mostrarPanel(true);
      });

      // Botón cargar GeoJSON (SIN fetch -> evita CORS)
      document.getElementById("loadGeoBtn").addEventListener("click", () => {
        const url = document.getElementById("geoUrl").value.trim();
        if (!url) return alert("Pega una URL pública directa a .geojson");
        cargarGeoJson(url);
      });

      // Botón quitar GeoJSON
      document.getElementById("clearGeoBtn").addEventListener("click", () => {
        map.data.forEach((f) => map.data.remove(f));
        alert("GeoJSON removido.");
      });

      // Guardar registro
      document.getElementById("saveBtn").addEventListener("click", () => {
        if (!pendingLatLng) return;

        const id = document.getElementById("idField").value.trim();
        const nombre = document.getElementById("nameField").value.trim();
        const fecha = document.getElementById("dateField").value;
        const hora = document.getElementById("timeField").value;

        if (!nombre) return alert("Por favor escribe un nombre.");

        const registro = {
          id, nombre, fecha, hora,
          lat: pendingLatLng.lat(),
          lng: pendingLatLng.lng()
        };
        registros.push(registro);

        const marker = new google.maps.Marker({
          position: pendingLatLng,
          map,
          title: `${id} - ${nombre}`
        });

        const info = new google.maps.InfoWindow({
          content: `
            <div style="font-family:system-ui,Arial; font-size:14px;">
              <b>ID:</b> ${escapeHtml(id)}<br/>
              <b>Nombre:</b> ${escapeHtml(nombre)}<br/>
              <b>Fecha:</b> ${escapeHtml(fecha)}<br/>
              <b>Hora:</b> ${escapeHtml(hora)}<br/>
              <b>Lat/Lng:</b> ${registro.lat.toFixed(6)}, ${registro.lng.toFixed(6)}
            </div>
          `
        });

        marker.addListener("click", () => info.open({ anchor: marker, map }));

        if (tempMarker) tempMarker.setMap(null);
        tempMarker = null;
        pendingLatLng = null;
        mostrarPanel(false);

        console.log("Registros:", registros);
      });

      // Cancelar registro
      document.getElementById("cancelBtn").addEventListener("click", () => {
        if (tempMarker) tempMarker.setMap(null);
        tempMarker = null;
        pendingLatLng = null;
        mostrarPanel(false);
      });

      // (Opcional) cargar automáticamente al iniciar:
      // cargarGeoJson(document.getElementById("geoUrl").value.trim());
    }

    function cargarGeoJson(url) {
      // Eliminar lo anterior
      map.data.forEach((f) => map.data.remove(f));

      // Cargar GeoJSON
      map.data.loadGeoJson(url, null, (features) => {
        if (!features) {
          alert("No se pudo cargar el GeoJSON (sin detalles). Revisa que la URL sea directa.");
          return;
        }

        console.log("GeoJSON cargado. Features:", features.length);

        if (features.length === 0) {
          alert("El GeoJSON cargó pero no se encontraron features.");
          return;
        }

        // Ajustar vista al GeoJSON
        const bounds = new google.maps.LatLngBounds();
        map.data.forEach((feature) => {
          expandirBounds(feature.getGeometry(), bounds);
        });

        if (!bounds.isEmpty()) {
          map.fitBounds(bounds);
        } else {
          alert("GeoJSON cargado, pero no se pudo calcular bounds.");
        }
      });

      // Si la URL está mal o no es accesible, Google Maps puede fallar silenciosamente.
      // Por eso mira la consola (F12) si no ves nada.
    }

    function expandirBounds(geometry, bounds) {
      if (!geometry) return;

      const type = geometry.getType();

      if (type === "Point") {
        bounds.extend(geometry.get());
        return;
      }

      // Para LineString, Polygon, MultiPolygon, etc.
      geometry.getArray().forEach((g) => {
        if (g.getType) {
          expandirBounds(g, bounds);
        } else {
          // LatLng
          bounds.extend(g);
        }
      });
    }

    function mostrarPanel(show) {
      document.getElementById("panel").style.display = show ? "block" : "none";
    }

    function generarId() {
      const id = "P-" + String(nextId).padStart(4, "0");
      nextId += 1;
      return id;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }
  </script>

  <!-- Google Maps JS API -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY_AQUI&callback=initMap"
    async defer></script>
</body>
</html>

