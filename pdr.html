<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Google Maps + GeoJSON + Formulario</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, Arial; }
    #map { height: 100%; width: 100%; }

    /* Panel flotante del formulario */
    #panel {
      position: absolute;
      left: 12px;
      top: 12px;
      z-index: 10;
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
      width: 320px;
      max-width: calc(100% - 24px);
      display: none;
    }
    #panel h3 { margin: 0 0 10px; font-size: 16px; }
    #panel label { display:block; font-size: 12px; margin-top: 8px; }
    #panel input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
    #panel .row { display:flex; gap:8px; }
    #panel .row > div { flex:1; }

    #panel .btns { display:flex; gap:8px; margin-top: 10px; }
    button {
      padding: 10px;
      border: 0;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    #saveBtn { background: #1a73e8; color: #fff; flex: 1; }
    #cancelBtn { background: #f1f3f4; flex: 1; }

    /* Barra inferior */
    #bottomBar {
      position: absolute;
      left: 12px;
      bottom: 12px;
      z-index: 10;
      background: rgba(255,255,255,.92);
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
      width: 560px;
      max-width: calc(100% - 24px);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    #geoUrl { flex: 1; min-width: 260px; }
    .hint { font-size: 12px; color: #5f6368; margin-top: 6px; }
    .small { font-size: 12px; color: #5f6368; }
    .pill {
      background: #f1f3f4;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <!-- Formulario -->
  <div id="panel">
    <h3>Nuevo registro</h3>

    <label>ID</label>
    <input id="idField" type="text" readonly />

    <label>Nombre</label>
    <input id="nameField" type="text" placeholder="Ej: Camilo" />

    <div class="row">
      <div>
        <label>Fecha</label>
        <input id="dateField" type="date" />
      </div>
      <div>
        <label>Hora</label>
        <input id="timeField" type="time" />
      </div>
    </div>

    <div class="btns">
      <button id="saveBtn" type="button">Guardar</button>
      <button id="cancelBtn" type="button">Cancelar</button>
    </div>

    <div class="hint" id="coordHint"></div>
  </div>

  <!-- Barra inferior -->
  <div id="bottomBar">
    <div class="pill">Cartografía: GeoJSON en Google Cloud Storage</div>

    <input id="geoUrl" type="text"
      value="https://storage.googleapis.com/gpkg-json-camilo/cartografia2.geojson"
      placeholder="URL pública directa a .geojson" />

    <button id="loadGeoBtn" type="button">Cargar GeoJSON</button>
    <button id="clearGeoBtn" type="button">Quitar GeoJSON</button>

    <div class="small">
      Tip: Si el GeoJSON es pesado, puede tardar unos segundos en dibujar.
    </div>
  </div>

  <div id="map"></div>

  <script>
    let map;

    // Para el punto tocado
    let pendingLatLng = null;
    let tempMarker = null;

    // Contador IDs
    let nextId = 1;

    // Guardamos registros en memoria (luego puedes enviarlos a Supabase)
    const registros = [];

    // Estado GeoJSON cargado
    let geoLoaded = false;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 4.7110, lng: -74.0721 }, // Bogotá
        zoom: 11,
        mapTypeId: "roadmap"
      });

      // Estilo del GeoJSON (cuando esté cargado)
      map.data.setStyle({
        fillColor: "#1a73e8",
        fillOpacity: 0.20,
        strokeColor: "#1a73e8",
        strokeWeight: 2
      });

      // Click en el mapa -> abrir formulario
      map.addListener("click", (e) => {
        pendingLatLng = e.latLng;

        // Marcador temporal
        if (tempMarker) tempMarker.setMap(null);
        tempMarker = new google.maps.Marker({
          position: pendingLatLng,
          map,
          title: "Nuevo punto"
        });

        // Form
        document.getElementById("idField").value = generarId();
        document.getElementById("nameField").value = "";

        const now = new Date();
        document.getElementById("dateField").value = now.toISOString().slice(0, 10);
        document.getElementById("timeField").value = now.toTimeString().slice(0, 5);

        document.getElementById("coordHint").textContent =
          `Coordenadas: ${pendingLatLng.lat().toFixed(6)}, ${pendingLatLng.lng().toFixed(6)}`;

        mostrarPanel(true);
      });

      // Click en una geometría del GeoJSON (opcional)
      map.data.addListener("click", (event) => {
        // Evita “doble click” si justo diste click al mapa
        // (Google dispara eventos separados. Si quieres, puedes refinar esto.)
        const latLng = event.latLng;
        const props = event.feature ? event.feature.toGeoJson : null;

        const iw = new google.maps.InfoWindow({
          position: latLng,
          content: `
            <div style="font-family:system-ui,Arial; font-size:14px;">
              <b>Cartografía</b><br/>
              Lat: ${latLng.lat().toFixed(6)}<br/>
              Lng: ${latLng.lng().toFixed(6)}
            </div>
          `
        });
        iw.open(map);
      });

      // Botón cargar GeoJSON
      document.getElementById("loadGeoBtn").addEventListener("click", async () => {
        const url = document.getElementById("geoUrl").value.trim();
        if (!url) return alert("Pega una URL pública directa a .geojson");

        await cargarGeoJson(url);
      });

      // Botón quitar GeoJSON
      document.getElementById("clearGeoBtn").addEventListener("click", () => {
        map.data.forEach((f) => map.data.remove(f));
        geoLoaded = false;
        alert("GeoJSON removido.");
      });

      // Guardar registro
      document.getElementById("saveBtn").addEventListener("click", () => {
        if (!pendingLatLng) return;

        const id = document.getElementById("idField").value.trim();
        const nombre = document.getElementById("nameField").value.trim();
        const fecha = document.getElementById("dateField").value;
        const hora = document.getElementById("timeField").value;

        if (!nombre) return alert("Por favor escribe un nombre.");

        const registro = {
          id, nombre, fecha, hora,
          lat: pendingLatLng.lat(),
          lng: pendingLatLng.lng()
        };
        registros.push(registro);

        // Marcador definitivo
        const marker = new google.maps.Marker({
          position: pendingLatLng,
          map,
          title: `${id} - ${nombre}`
        });

        const info = new google.maps.InfoWindow({
          content: `
            <div style="font-family:system-ui,Arial; font-size:14px;">
              <b>ID:</b> ${escapeHtml(id)}<br/>
              <b>Nombre:</b> ${escapeHtml(nombre)}<br/>
              <b>Fecha:</b> ${escapeHtml(fecha)}<br/>
              <b>Hora:</b> ${escapeHtml(hora)}<br/>
              <b>Lat/Lng:</b> ${registro.lat.toFixed(6)}, ${registro.lng.toFixed(6)}
            </div>
          `
        });

        marker.addListener("click", () => info.open({ anchor: marker, map }));

        // Limpiar
        if (tempMarker) tempMarker.setMap(null);
        tempMarker = null;
        pendingLatLng = null;
        mostrarPanel(false);

        console.log("Registros:", registros);
      });

      // Cancelar registro
      document.getElementById("cancelBtn").addEventListener("click", () => {
        if (tempMarker) tempMarker.setMap(null);
        tempMarker = null;
        pendingLatLng = null;
        mostrarPanel(false);
      });

      // (Opcional) Cargar automáticamente el GeoJSON al iniciar:
      // cargarGeoJson(document.getElementById("geoUrl").value.trim());
    }

    async function cargarGeoJson(url) {
      // Quitar lo anterior si ya había algo
      map.data.forEach((f) => map.data.remove(f));
      geoLoaded = false;

      // Validación rápida: intentar descargar antes (para mostrar error claro)
      try {
        const resp = await fetch(url, { method: "GET" });
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
      } catch (err) {
        console.error("No se pudo descargar el GeoJSON:", err);
        alert("No se pudo descargar el GeoJSON.\n" +
              "Asegúrate de que la URL sea pública y directa.\n\n" +
              "Detalle: " + err.message);
        return;
      }

      // Cargar GeoJSON en Google Maps Data Layer
      map.data.loadGeoJson(url, null, (features) => {
        geoLoaded = true;
        console.log("GeoJSON cargado. Features:", features.length);

        if (!features || features.length === 0) {
          alert("El GeoJSON cargó, pero no se encontraron features.");
          return;
        }

        // Ajustar vista a la cartografía (bounds)
        const bounds = new google.maps.LatLngBounds();
        map.data.forEach((feature) => {
          processGeometry(feature.getGeometry(), bounds.extend, bounds);
        });
        if (!bounds.isEmpty()) map.fitBounds(bounds);
      });
    }

    // Recorrer geometrías para calcular bounds
    function processGeometry(geometry, callback, thisArg) {
      if (!geometry) return;
      if (geometry instanceof google.maps.LatLng) {
        callback.call(thisArg, geometry);
      } else if (geometry.getType) {
        const type = geometry.getType();
        if (type === "Point") {
          callback.call(thisArg, geometry.get());
        } else {
          geometry.getArray().forEach((g) => processGeometry(g, callback, thisArg));
        }
      }
    }

    function mostrarPanel(show) {
      document.getElementById("panel").style.display = show ? "block" : "none";
    }

    function generarId() {
      const id = "P-" + String(nextId).padStart(4, "0");
      nextId += 1;
      return id;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }
  </script>

  <!-- Google Maps JS API -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDiwSBJ3zp6ysMWJqwVmxunpawTOsYYATw&callback=initMap"
    async defer></script>
</body>
</html>
