<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Laboratorio</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
);

const $ = id => document.getElementById(id);

document.addEventListener("DOMContentLoaded", async () => {
  $("fecha_envio").value = new Date().toISOString().split("T")[0];
  initFirma($("firmaRecoge"));
  initFirma($("firmaEntrega"));
  await cargarProveedores();
  await cargarRegistros();
});

/* ========== FIRMAS ========== */
function initFirma(canvas){
  const ctx = canvas.getContext("2d");
  let draw = false;
  const pos = e => {
    const r = canvas.getBoundingClientRect();
    return {
      x:(e.touches?e.touches[0].clientX:e.clientX)-r.left,
      y:(e.touches?e.touches[0].clientY:e.clientY)-r.top
    };
  };
  canvas.onmousedown=e=>{draw=true;const p=pos(e);ctx.beginPath();ctx.moveTo(p.x,p.y)};
  canvas.onmousemove=e=>{if(!draw)return;const p=pos(e);ctx.lineTo(p.x,p.y);ctx.stroke()};
  canvas.onmouseup=()=>draw=false;
  canvas.ontouchstart=e=>canvas.onmousedown(e);
  canvas.ontouchmove=e=>canvas.onmousemove(e);
  canvas.ontouchend=()=>draw=false;
}

window.limpiarFirma = id => {
  const c=$(id);
  c.getContext("2d").clearRect(0,0,c.width,c.height);
};

/* ========== PROVEEDORES ========== */
async function cargarProveedores(){
  const { data } = await supabase
    .from("proveedores")
    .select("id,nombre,telefono")
    .eq("activo",true)
    .order("nombre");

  $("proveedor").innerHTML = "<option value=''>Seleccione proveedor</option>";
  $("filtroProveedor").innerHTML = "<option value=''>Todos los proveedores</option>";

  data.forEach(p=>{
    const o=document.createElement("option");
    o.value=p.id;
    o.textContent=p.nombre;
    o.dataset.tel=p.telefono||"";
    $("proveedor").appendChild(o);
    $("filtroProveedor").appendChild(o.cloneNode(true));
  });

  $("proveedor").onchange=()=>{
    const o=$("proveedor").selectedOptions[0];
    $("telefono_proveedor").value=o?.dataset.tel||"";
  };
}

/* ========== GUARDAR ========== */
$("formLaboratorio").addEventListener("submit", async e=>{
  e.preventDefault();

  await supabase.from("laboratorios").insert([{
    fecha_envio: $("fecha_envio").value,
    fecha_entrega: $("fecha_entrega").value||null,
    estado: $("estado").value,
    nombre_trabajo: $("nombre_trabajo").value,
    proveedor_id: $("proveedor").value,
    nombre_paciente: $("nombre_paciente").value,
    cedula_paciente: $("cedula_paciente").value,
    costo: Number($("costo").value),
    firma_recoge: $("firmaRecoge").toDataURL(),
    nombre_recoge: $("nombre_recoge").value,
    firma_entrega: $("firmaEntrega").toDataURL(),
    nombre_entrega: $("nombre_entrega").value
  }]);

  e.target.reset();
  $("fecha_envio").value = new Date().toISOString().split("T")[0];
  await cargarRegistros();
});

/* ========== LISTADO ========== */
async function cargarRegistros(){
  let q = supabase
    .from("laboratorios")
    .select(`
      fecha_envio,
      nombre_paciente,
      cedula_paciente,
      estado,
      costo,
      proveedores ( nombre )
    `)
    .order("created_at",{ascending:false});

  if($("fEstado").value) q=q.eq("estado",$("fEstado").value);
  if($("fPaciente").value) q=q.ilike("nombre_paciente","%"+$("fPaciente").value+"%");
  if($("fCedula").value) q=q.ilike("cedula_paciente","%"+$("fCedula").value+"%");
  if($("filtroProveedor").value) q=q.eq("proveedor_id",$("filtroProveedor").value);

  const { data } = await q;
  const tb=$("tbody");
  tb.innerHTML="";

  data.forEach(r=>{
    tb.innerHTML+=`
      <tr>
        <td>${r.fecha_envio||""}</td>
        <td>${r.nombre_paciente}</td>
        <td>${r.cedula_paciente}</td>
        <td>${r.proveedores?.nombre||""}</td>
        <td>${r.estado}</td>
        <td>$ ${Number(r.costo||0).toLocaleString("es-CO")}</td>
      </tr>`;
  });
}

["fEstado","fPaciente","fCedula","filtroProveedor"]
.forEach(id=>$(id).oninput=cargarRegistros);
</script>

<style>
body{
  background:#f3f6fb;
  font-family:system-ui,Segoe UI,Arial;
  padding:24px;
}

h1{
  text-align:center;
  color:#1f4e72;
  margin-bottom:18px;
}

.card{
  max-width:980px;
  margin:auto;
  background:#fff;
  border-radius:16px;
  border:1px solid #dbe7f5;
  padding:24px;
  margin-bottom:24px;
}

.form-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px 20px;
}

.form-grid.full{
  grid-template-columns:1fr;
}

label{
  font-size:12px;
  font-weight:600;
  color:#475569;
  margin-bottom:4px;
  display:block;
}

input,select{
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1.5px solid #cfe0ff;
  font-size:14px;
}

input:focus,select:focus{
  outline:none;
  border-color:#5aa9ff;
}

canvas{
  width:100%;
  height:120px;
  border:1.5px dashed #cfe0ff;
  border-radius:12px;
}

.btn-row{
  display:flex;
  justify-content:flex-end;
  margin-top:16px;
}

.btn-save{
  background:#009688;
  color:#fff;
  padding:10px 22px;
  border:none;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
}

.btn-clear{
  margin-top:6px;
  background:#64748b;
  color:#fff;
  padding:6px 14px;
  border:none;
  border-radius:10px;
  font-size:12px;
  cursor:pointer;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
}

th,td{
  padding:10px;
  font-size:13px;
  border-bottom:1px solid #e5eefb;
}

th{
  background:#f4f8ff;
  text-align:left;
}
</style>
</head>

<body>

<h1>Laboratorio</h1>

<div class="card">
<form id="formLaboratorio">

<div class="form-grid">
  <div>
    <label>Fecha de envío</label>
    <input type="date" id="fecha_envio">
  </div>
  <div>
    <label>Fecha de entrega</label>
    <input type="date" id="fecha_entrega">
  </div>

  <div>
    <label>Estado</label>
    <select id="estado">
      <option>Pendiente de enviar</option>
      <option>Enviado</option>
      <option>En laboratorio</option>
      <option>Entregado</option>
    </select>
  </div>

  <div>
    <label>Costo (COP)</label>
    <input id="costo" type="number">
  </div>

  <div>
    <label>Nombre del trabajo</label>
    <input id="nombre_trabajo">
  </div>

  <div>
    <label>Proveedor</label>
    <select id="proveedor"></select>
  </div>

  <div>
    <label>Teléfono proveedor</label>
    <input id="telefono_proveedor" readonly>
  </div>

  <div>
    <label>Nombre del paciente</label>
    <input id="nombre_paciente">
  </div>

  <div>
    <label>Cédula del paciente</label>
    <input id="cedula_paciente">
  </div>
</div>

<div class="form-grid full" style="margin-top:18px">
  <label>Firma de quien recoge</label>
  <canvas id="firmaRecoge"></canvas>
  <input id="nombre_recoge" placeholder="Nombre de quien recoge">
  <button type="button" class="btn-clear" onclick="limpiarFirma('firmaRecoge')">Limpiar</button>

  <label style="margin-top:14px">Firma de quien recibe la entrega</label>
  <canvas id="firmaEntrega"></canvas>
  <input id="nombre_entrega" placeholder="Nombre de quien recibe la entrega">
  <button type="button" class="btn-clear" onclick="limpiarFirma('firmaEntrega')">Limpiar</button>
</div>

<div class="btn-row">
  <button class="btn-save" type="submit">Guardar</button>
</div>

</form>
</div>

<div class="card">
<h2>Registros</h2>

<div class="form-grid" style="margin-bottom:12px">
  <div>
    <label>Estado</label>
    <select id="fEstado">
      <option value="">Todos</option>
      <option>Pendiente de enviar</option>
      <option>Enviado</option>
      <option>En laboratorio</option>
      <option>Entregado</option>
    </select>
  </div>
  <div>
    <label>Paciente</label>
    <input id="fPaciente">
  </div>
  <div>
    <label>Cédula</label>
    <input id="fCedula">
  </div>
  <div>
    <label>Proveedor</label>
    <select id="filtroProveedor"></select>
  </div>
</div>

<table>
<thead>
<tr>
  <th>Fecha</th>
  <th>Paciente</th>
  <th>Cédula</th>
  <th>Proveedor</th>
  <th>Estado</th>
  <th>Costo</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</body>
</html>

