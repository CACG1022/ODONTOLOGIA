<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Módulo Laboratorio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
    );

    const $ = id => document.getElementById(id);

    document.addEventListener("DOMContentLoaded", async () => {
      $("fecha_envio").value = new Date().toISOString().split("T")[0];
      initFirma($("firmaRecoge"));
      initFirma($("firmaEntrega"));
      await cargarProveedores();
      await cargarRegistros();
    });

    function initFirma(canvas){
      const ctx = canvas.getContext("2d");
      let draw = false;
      const pos = e => {
        const r = canvas.getBoundingClientRect();
        return {
          x:(e.touches?e.touches[0].clientX:e.clientX)-r.left,
          y:(e.touches?e.touches[0].clientY:e.clientY)-r.top
        };
      };
      canvas.onmousedown=e=>{draw=true;const p=pos(e);ctx.beginPath();ctx.moveTo(p.x,p.y)};
      canvas.onmousemove=e=>{if(!draw)return;const p=pos(e);ctx.lineTo(p.x,p.y);ctx.stroke()};
      canvas.onmouseup=()=>draw=false;
      canvas.ontouchstart=e=>canvas.onmousedown(e);
      canvas.ontouchmove=e=>canvas.onmousemove(e);
      canvas.ontouchend=()=>draw=false;
    }

    window.limpiarFirma = id => {
      const c=$(id); c.getContext("2d").clearRect(0,0,c.width,c.height);
    };

    async function cargarProveedores(){
      const { data } = await supabase
        .from("proveedores")
        .select("id,nombre,telefono")
        .eq("activo",true)
        .order("nombre");

      $("proveedor").innerHTML = "<option value=''>Seleccione...</option>";
      $("filtroProveedor").innerHTML = "<option value=''>Todos</option>";

      data.forEach(p=>{
        const o=document.createElement("option");
        o.value=p.id; o.textContent=p.nombre; o.dataset.tel=p.telefono||"";
        $("proveedor").appendChild(o);

        const f=o.cloneNode(true);
        $("filtroProveedor").appendChild(f);
      });

      $("proveedor").onchange=()=>{
        const o=$("proveedor").selectedOptions[0];
        $("telefono_proveedor").value=o?.dataset.tel||"";
      };
    }

    $("formLaboratorio").onsubmit = async e => {
      e.preventDefault();
      await supabase.from("laboratorios").insert([{
        fecha_envio: $("fecha_envio").value,
        fecha_entrega: $("fecha_entrega").value||null,
        estado: $("estado").value,
        nombre_trabajo: $("nombre_trabajo").value,
        proveedor_id: $("proveedor").value,
        nombre_paciente: $("nombre_paciente").value,
        cedula_paciente: $("cedula_paciente").value,
        costo: Number($("costo").value),
        firma_recoge: $("firmaRecoge").toDataURL(),
        nombre_recoge: $("nombre_recoge").value,
        firma_entrega: $("firmaEntrega").toDataURL(),
        nombre_entrega: $("nombre_entrega").value
      }]);
      alert("Registro guardado");
      e.target.reset();
      await cargarRegistros();
    };

    async function cargarRegistros(){
      let q = supabase
        .from("laboratorios")
        .select(`
          id, fecha_envio, fecha_entrega, estado,
          nombre_paciente, cedula_paciente, costo,
          proveedores ( nombre )
        `)
        .order("created_at",{ascending:false});

      if($("fEstado").value) q=q.eq("estado",$("fEstado").value);
      if($("fPaciente").value) q=q.ilike("nombre_paciente","%"+$("fPaciente").value+"%");
      if($("fCedula").value) q=q.ilike("cedula_paciente","%"+$("fCedula").value+"%");
      if($("filtroProveedor").value) q=q.eq("proveedor_id",$("filtroProveedor").value);

      const { data } = await q;
      const tb=$("tbody");
      tb.innerHTML="";
      data.forEach(r=>{
        tb.innerHTML+=`
          <tr>
            <td>${r.fecha_envio||""}</td>
            <td>${r.nombre_paciente}</td>
            <td>${r.cedula_paciente}</td>
            <td>${r.proveedores?.nombre||""}</td>
            <td>${r.estado}</td>
            <td>$${Number(r.costo||0).toLocaleString("es-CO")}</td>
          </tr>`;
      });
    }

    ["fEstado","fPaciente","fCedula","filtroProveedor"].forEach(id=>{
      $(id).oninput=cargarRegistros;
    });
  </script>

  <style>
    body{font-family:system-ui;background:#f4f7fb;padding:20px}
    h1,h2{text-align:center}
    .card{background:#fff;padding:20px;border-radius:12px;margin-bottom:20px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:repeat(3,1fr)}
    label{font-size:13px;font-weight:600}
    input,select{padding:10px;border-radius:8px;border:1px solid #ccc}
    canvas{border:1px dashed #aaa;height:120px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:8px;font-size:13px}
    th{background:#eef}
    button{padding:10px 14px;border:none;border-radius:8px;background:#009688;color:white}
  </style>
</head>

<body>

<h1>Módulo Laboratorio</h1>

<div class="card">
<form id="formLaboratorio">
<div class="grid g3">
<input type="date" id="fecha_envio"><input type="date" id="fecha_entrega">
<select id="estado">
<option>Pendiente de enviar</option><option>Enviado</option><option>En laboratorio</option><option>Entregado</option>
</select>
</div>

<div class="grid g2">
<input id="nombre_trabajo" placeholder="Trabajo">
<input id="costo" type="number" placeholder="Costo">
</div>

<div class="grid g2">
<select id="proveedor"></select>
<input id="telefono_proveedor" readonly placeholder="Teléfono proveedor">
</div>

<div class="grid g2">
<input id="nombre_paciente" placeholder="Paciente">
<input id="cedula_paciente" placeholder="Cédula">
</div>

<label>Firma recoge</label>
<canvas id="firmaRecoge"></canvas>
<input id="nombre_recoge" placeholder="Nombre recoge">

<label>Firma entrega</label>
<canvas id="firmaEntrega"></canvas>
<input id="nombre_entrega" placeholder="Nombre entrega">

<button type="submit">Guardar</button>
</form>
</div>

<div class="card">
<h2>Registros</h2>

<div class="grid g3">
<select id="fEstado"><option value="">Todos</option><option>Pendiente de enviar</option><option>Enviado</option><option>En laboratorio</option><option>Entregado</option></select>
<input id="fPaciente" placeholder="Filtrar paciente">
<input id="fCedula" placeholder="Filtrar cédula">
<select id="filtroProveedor"></select>
</div>

<table>
<thead>
<tr><th>Fecha</th><th>Paciente</th><th>Cédula</th><th>Proveedor</th><th>Estado</th><th>Costo</th></tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

</body>
</html>

