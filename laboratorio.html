<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>M√≥dulo Laboratorio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

 <script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
);

const proveedor = document.getElementById("proveedor");
const telefonoProveedor = document.getElementById("telefono_proveedor");

/* ===============================
   FECHA ACTUAL
================================ */
document.getElementById("fecha_envio").value =
  new Date().toISOString().split("T")[0];

/* ===============================
   CANVAS (MISMO TUYO)
================================ */
function initFirma(canvas){
  const ctx = canvas.getContext("2d");

  // üîß FIX CLAVE: sincronizar tama√±o real con CSS
  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect();
    canvas.width  = rect.width;
    canvas.height = rect.height;
  }

  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  let drawing = false;

  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    return {
      x: (e.touches ? e.touches[0].clientX : e.clientX) - rect.left,
      y: (e.touches ? e.touches[0].clientY : e.clientY) - rect.top
    };
  }

  function start(e){
    drawing = true;
    const p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
    e.preventDefault();
  }

  function move(e){
    if(!drawing) return;
    const p = getPos(e);
    ctx.lineTo(p.x, p.y);
    ctx.strokeStyle = "#0f172a";
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.stroke();
    e.preventDefault();
  }

  function end(){
    drawing = false;
  }

  canvas.addEventListener("mousedown", start);
  canvas.addEventListener("mousemove", move);
  canvas.addEventListener("mouseup", end);
  canvas.addEventListener("mouseleave", end);

  canvas.addEventListener("touchstart", start);
  canvas.addEventListener("touchmove", move);
  canvas.addEventListener("touchend", end);
}


initFirma(document.getElementById("firmaRecoge"));
initFirma(document.getElementById("firmaEntrega"));

window.limpiarFirma = id=>{
  const c=document.getElementById(id);
  c.getContext("2d").clearRect(0,0,c.width,c.height);
};

/* ===============================
   CARGAR PROVEEDORES (FIX REAL)
================================ */
async function cargarProveedores(){
  const { data, error } = await supabase
    .from("proveedores")
    .select("id,nombre,telefono")
    .eq("activo", true)
    .order("nombre");

  if(error){
    console.error("Error proveedores:", error);
    alert("Error cargando proveedores. Revisa consola.");
    return;
  }

  proveedor.innerHTML = "<option value=''>Seleccione...</option>";

  data.forEach(p=>{
    const opt=document.createElement("option");
    opt.value=p.id;
    opt.textContent=p.nombre;
    opt.dataset.tel=p.telefono || "";
    proveedor.appendChild(opt);
  });
}

proveedor.addEventListener("change",()=>{
  const o=proveedor.selectedOptions[0];
  telefonoProveedor.value=o?.dataset.tel||"";
});

await cargarProveedores();
</script>


  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --border:#d6e3f3;
      --label:#475569;
      --title:#1f4e72;
      --btn:#009688;
      --btn2:#64748b;
      --radius:14px;
      --shadow:0 10px 30px rgba(16,24,40,.08);
      --font: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
 
    body{
      margin:0;
      padding:24px;
      font-family:var(--font);
      background:var(--bg);
      color:#0f172a;
    }

    h1{
      margin:0 0 16px;
      color:var(--title);
      font-size:28px;
      font-weight:900;
      text-align:center;
    }

    .card{
      max-width:900px;
      margin:auto;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      margin-bottom:24px;
    }

    .grid{
      display:grid;
      gap:16px;
    }

    .g-2{ grid-template-columns:1fr 1fr; }
    .g-3{ grid-template-columns:repeat(3,1fr); }

    @media(max-width:800px){
      .g-2,.g-3{ grid-template-columns:1fr; }
    }

    label{
      font-size:13px;
      font-weight:600;
      color:var(--label);
      display:block;
      margin-bottom:6px;
    }

    input, select{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1.5px solid var(--border);
      font-size:15px;
      outline:none;
    }

    input:focus, select:focus{
      border-color:#94a3b8;
    }

    canvas{
      width:100%;
      height:140px;
      border:1.5px dashed var(--border);
      border-radius:12px;
      background:#fff;
      cursor:crosshair;
    }

    .firma-box{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:#f8fafc;
    }

    .firma-actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top:8px;
    }

    button{
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
      font-family:var(--font);
    }

    .btn-main{ background:var(--btn); color:#fff; }
    .btn-clear{ background:var(--btn2); color:#fff; }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
    }

    th,td{
      padding:10px;
      border-bottom:1px solid var(--border);
      font-size:13px;
      text-align:left;
    }

    th{
      background:#f4f7fb;
    }
  </style>
</head>

<body>

<h1>Laboratorio</h1>

<!-- ================= FORMULARIO ================= -->
<div class="card">
<form id="formLaboratorio">

  <div class="grid g-3">
    <div>
      <label>Fecha de env√≠o</label>
      <input type="date" id="fecha_envio" required />
    </div>
    <div>
      <label>Fecha de entrega</label>
      <input type="date" id="fecha_entrega" />
    </div>
    <div>
      <label>Estado</label>
      <select id="estado" required>
        <option>Pendiente de enviar</option>
        <option>Enviado</option>
        <option>En laboratorio</option>
        <option>Entregado</option>
      </select>
    </div>
  </div>

  <div class="grid g-2">
    <div>
      <label>Nombre del trabajo</label>
      <input id="nombre_trabajo" required />
    </div>
    <div>
      <label>Costo (COP)</label>
      <input id="costo" type="number" min="0" required />
    </div>
  </div>

  <div class="grid g-2">
    <div>
      <label>Proveedor</label>
      <select id="proveedor" required></select>
    </div>
    <div>
      <label>Tel√©fono proveedor</label>
      <input id="telefono_proveedor" readonly />
    </div>
  </div>

  <div class="grid g-2">
    <div>
      <label>Nombre del paciente</label>
      <input id="nombre_paciente" required />
    </div>
    <div>
      <label>C√©dula del paciente</label>
      <input id="cedula_paciente" required />
    </div>
  </div>

  <div class="firma-box">
    <label>Firma de quien recoge</label>
    <canvas id="firmaRecoge"></canvas>
    <input id="nombre_recoge" placeholder="Nombre de quien recoge" />
    <div class="firma-actions">
      <button type="button" class="btn-clear" onclick="limpiarFirma('firmaRecoge')">Limpiar</button>
    </div>
  </div>

  <div class="firma-box">
    <label>Firma de quien recibe la entrega</label>
    <canvas id="firmaEntrega"></canvas>
    <input id="nombre_entrega" placeholder="Nombre de quien recibe la entrega" />
    <div class="firma-actions">
      <button type="button" class="btn-clear" onclick="limpiarFirma('firmaEntrega')">Limpiar</button>
    </div>
  </div>

  <div class="firma-actions" style="margin-top:16px">
    <button type="submit" class="btn-main">Guardar</button>
  </div>

</form>
</div>

<!-- ================= LISTADO ================= -->
<div class="card">
  <h2 style="margin-top:0">Registros</h2>

  <div class="grid g-3">
    <select id="fEstado">
      <option value="">Todos los estados</option>
      <option>Pendiente de enviar</option>
      <option>Enviado</option>
      <option>En laboratorio</option>
      <option>Entregado</option>
    </select>
    <input id="fPaciente" placeholder="Paciente" />
    <input id="fCedula" placeholder="C√©dula" />
    <select id="fProveedor"></select>
  </div>

  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Paciente</th>
        <th>C√©dula</th>
        <th>Proveedor</th>
        <th>Estado</th>
        <th>Costo</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
  fecha_envio.value = new Date().toISOString().split("T")[0];

  function initFirma(canvas){
    const ctx = canvas.getContext("2d");
    let drawing=false;

    function pos(e){
      const r=canvas.getBoundingClientRect();
      return {x:(e.touches?e.touches[0].clientX:e.clientX)-r.left,y:(e.touches?e.touches[0].clientY:e.clientY)-r.top};
    }

    function start(e){drawing=true;const p=pos(e);ctx.beginPath();ctx.moveTo(p.x,p.y);e.preventDefault();}
    function move(e){if(!drawing)return;const p=pos(e);ctx.lineTo(p.x,p.y);ctx.strokeStyle="#0f172a";ctx.lineWidth=2;ctx.lineCap="round";ctx.stroke();e.preventDefault();}
    function end(){drawing=false;}

    canvas.addEventListener("mousedown",start);
    canvas.addEventListener("mousemove",move);
    canvas.addEventListener("mouseup",end);
    canvas.addEventListener("mouseleave",end);
    canvas.addEventListener("touchstart",start);
    canvas.addEventListener("touchmove",move);
    canvas.addEventListener("touchend",end);
  }

  function limpiarFirma(id){
    const c=document.getElementById(id);
    c.getContext("2d").clearRect(0,0,c.width,c.height);
  }

  initFirma(firmaRecoge);
  initFirma(firmaEntrega);

  async function cargarProveedores(){
    const { data } = await supabase.from("proveedores").select("id,nombre,telefono").eq("activo",true).order("nombre");

    proveedor.innerHTML="<option value=''>Seleccione...</option>";
    fProveedor.innerHTML="<option value=''>Todos los proveedores</option>";

    data.forEach(p=>{
      const o=document.createElement("option");
      o.value=p.id;
      o.textContent=p.nombre;
      o.dataset.tel=p.telefono||"";
      proveedor.appendChild(o);
      fProveedor.appendChild(o.cloneNode(true));
    });

    proveedor.onchange=()=>{
      const o=proveedor.selectedOptions[0];
      telefono_proveedor.value=o?.dataset.tel||"";
    };
  }

  async function cargarRegistros(){
    let q=supabase.from("laboratorios").select(`fecha_envio,nombre_paciente,cedula_paciente,estado,costo,proveedores(nombre)`).order("created_at",{ascending:false});
    if(fEstado.value) q=q.eq("estado",fEstado.value);
    if(fPaciente.value) q=q.ilike("nombre_paciente","%"+fPaciente.value+"%");
    if(fCedula.value) q=q.ilike("cedula_paciente","%"+fCedula.value+"%");
    if(fProveedor.value) q=q.eq("proveedor_id",fProveedor.value);

    const { data } = await q;
    tbody.innerHTML="";
    data.forEach(r=>{
      tbody.innerHTML+=`<tr>
        <td>${r.fecha_envio||""}</td>
        <td>${r.nombre_paciente}</td>
        <td>${r.cedula_paciente}</td>
        <td>${r.proveedores?.nombre||""}</td>
        <td>${r.estado}</td>
        <td>$ ${Number(r.costo||0).toLocaleString("es-CO")}</td>
      </tr>`;
    });
  }

  formLaboratorio.addEventListener("submit",async e=>{
    e.preventDefault();
    await supabase.from("laboratorios").insert([{
      fecha_envio:fecha_envio.value,
      fecha_entrega:fecha_entrega.value||null,
      estado:estado.value,
      nombre_trabajo:nombre_trabajo.value,
      proveedor_id:proveedor.value,
      nombre_paciente:nombre_paciente.value,
      cedula_paciente:cedula_paciente.value,
      costo:Number(costo.value),
      firma_recoge:firmaRecoge.toDataURL(),
      nombre_recoge:nombre_recoge.value,
      firma_entrega:firmaEntrega.toDataURL(),
      nombre_entrega:nombre_entrega.value
    }]);
    e.target.reset();
    fecha_envio.value=new Date().toISOString().split("T")[0];
    await cargarRegistros();
  });

  ["fEstado","fPaciente","fCedula","fProveedor"].forEach(i=>document.getElementById(i).addEventListener("input",cargarRegistros));

  cargarProveedores();
  cargarRegistros();
</script>

</body>
</html>



