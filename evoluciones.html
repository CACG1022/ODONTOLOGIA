<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Evoluciones - Buscar por C√©dula Paciente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Dictado por voz (SpeechRecognition) -->
  <script>
    // ==============================
    // ‚úÖ DICTADO POR VOZ (Evoluciones: evo_detalle)
    // ==============================
    let _srEvo = null;
    let _srEvoOn = false;

    function _soportaDictado() {
      return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
    }

    function _appendEnTextarea(textarea, texto) {
      if (!textarea) return;
      const actual = textarea.value || "";
      const add = (texto || "").trim();
      if (!add) return;

      const sep = actual.trim().length ? (actual.endsWith("\n") ? "" : "\n") : "";
      textarea.value = actual + sep + add;

      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
    }

    function iniciarDictadoEvoDetalle() {
      const ta = document.getElementById("evo_detalle");
      const btn = document.getElementById("btnDictadoEvoDetalle");
      const hint = document.getElementById("dictadoHintEvo");

      if (!_soportaDictado()) {
        alert("‚ö†Ô∏è Tu navegador no soporta dictado por voz. Usa Chrome o Edge.");
        return;
      }

      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      _srEvo = new SR();

      _srEvo.lang = "es-CO";
      _srEvo.continuous = true;
      _srEvo.interimResults = true;

      let bufferFinal = "";

      _srEvo.onstart = () => {
        _srEvoOn = true;
        if (btn) btn.classList.add("on");
        if (hint) hint.style.display = "block";
      };

      _srEvo.onresult = (event) => {
        let textoFinal = "";
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const res = event.results[i];
          const t = (res[0]?.transcript || "").trim();
          if (!t) continue;
          if (res.isFinal) textoFinal += (textoFinal ? " " : "") + t;
        }

        if (textoFinal) {
          bufferFinal += (bufferFinal ? " " : "") + textoFinal;
          _appendEnTextarea(ta, bufferFinal);
          bufferFinal = "";
        }
      };

      _srEvo.onerror = (e) => {
        console.warn("Dictado error:", e);
        if (e?.error === "not-allowed" || e?.error === "service-not-allowed") {
          alert("‚ö†Ô∏è Permiso de micr√≥fono denegado. Habil√≠talo en el navegador.");
          detenerDictadoEvoDetalle();
        }
      };

      _srEvo.onend = () => {
        if (_srEvoOn) {
          try { _srEvo.start(); } catch (err) {}
          return;
        }
        if (btn) btn.classList.remove("on");
        if (hint) hint.style.display = "none";
      };

      try { _srEvo.start(); } catch (e) { console.warn("No se pudo iniciar dictado:", e); }
    }

    function detenerDictadoEvoDetalle() {
      const btn = document.getElementById("btnDictadoEvoDetalle");
      const hint = document.getElementById("dictadoHintEvo");

      _srEvoOn = false;

      if (_srEvo) {
        try { _srEvo.onend = null; } catch(e) {}
        try { _srEvo.stop(); } catch(e) {}
        _srEvo = null;
      }

      if (btn) btn.classList.remove("on");
      if (hint) hint.style.display = "none";
    }

    function toggleDictadoEvoDetalle() {
      if (_srEvoOn) detenerDictadoEvoDetalle();
      else iniciarDictadoEvoDetalle();
    }

    window.addEventListener("beforeunload", () => {
      try { detenerDictadoEvoDetalle(); } catch(e) {}
    });
    window.toggleDictadoEvoDetalle = toggleDictadoEvoDetalle;
  </script>

  <!-- Supabase -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ==============================
    // üîê CONFIG SUPABASE (IGUAL A TU C√ìDIGO)
    // ==============================
    const supabase = createClient(
      "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
    );
    window.supabase = supabase;

    // ==============================
    // ‚úÖ CONFIG: NOMBRE DE TABLA EN SUPABASE
    // ==============================
    // Aseg√∫rate de que exista esta tabla y tenga columnas:
    // id, fecha, hora, profesional, procedimiento, detalle, cedula_paciente, usuario, ts (o created_at)
    const EVOLUCIONES_TABLE = "evoluciones";

    // ==============================
    // ‚úÖ UTILIDADES
    // ==============================
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function _uuidFallback() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function uuid() {
      try { return (crypto && crypto.randomUUID) ? crypto.randomUUID() : _uuidFallback(); }
      catch(e){ return _uuidFallback(); }
    }

    function _hoyISO() { return new Date().toISOString().slice(0, 10); }

    function _horaHHMM() {
      const d = new Date();
      return String(d.getHours()).padStart(2, "0") + ":" + String(d.getMinutes()).padStart(2, "0");
    }

    function _soloFechaYYYYMMDD(valor) {
      if (!valor) return "";
      if (typeof valor === "string" && valor.includes("T")) return valor.split("T")[0];
      return String(valor);
    }

    function _soloHoraHHMM(valor) {
      if (!valor) return "";
      const s = String(valor);
      if (/^\d{2}:\d{2}:\d{2}/.test(s)) return s.slice(0,5);
      return s;
    }

    function _normalizarCedula(v){
      return String(v || "").trim().replace(/[^0-9]/g, "");
    }

    // ==============================
    // ‚úÖ CARGAR PROCEDIMIENTOS (datalist)
    // ==============================
    async function cargarProcedimientosDesdeSupabase() {
      const dl = document.getElementById("procedimientos_list_supabase");
      if (!dl) return;

      try {
        const { data, error } = await window.supabase
          .from("procedimientos_precios")
          .select("procedimiento, activo")
          .eq("activo", true)
          .order("procedimiento", { ascending: true });

        if (error) throw error;

        const items = (data || [])
          .map(x => String(x.procedimiento || "").trim())
          .filter(Boolean);

        dl.innerHTML = items.map(p => `<option value="${escapeHtml(p)}"></option>`).join("");
      } catch (e) {
        console.warn("‚ö†Ô∏è Error cargando procedimientos:", e);
      }
    }

    // ==============================
    // ‚úÖ CARGAR PROFESIONALES (select)
    // ==============================
    async function cargarProfesionalesDesdeSupabase() {
      const sel = document.getElementById("evo_profesional");
      if (!sel) return;

      const placeholder = `<option value="">Seleccione profesional...</option>`;
      sel.innerHTML = placeholder;

      try {
        const { data, error } = await window.supabase
          .from("profesionales")
          .select("id, nombre, cedula, activo")
          .eq("activo", true)
          .order("nombre", { ascending: true });

        if (error) throw error;

        const options = (data || []).map(p => {
          const nombre = (p.nombre || "").trim();
          const cedula = (p.cedula || "").trim();
          const valor = `${cedula} ${nombre}`.trim();
          const label = nombre || valor;
          return `<option value="${escapeHtml(valor)}">${escapeHtml(label)}</option>`;
        }).join("");

        sel.innerHTML = placeholder + options;
      } catch (e) {
        console.warn("‚ö†Ô∏è Error cargando profesionales:", e);
      }
    }

    // ==============================
    // ‚úÖ EVOLUCIONES (BUSCAR POR C√âDULA PACIENTE)
    // ==============================
    let evoluciones = [];
    let _cedulaPacienteActiva = "";

    function setCedulaPacienteUI(ced){
      const c = _normalizarCedula(ced);
      _cedulaPacienteActiva = c;

      const inputBuscar = document.getElementById("buscar_cedula_paciente");
      const inputForm   = document.getElementById("evo_cedula_paciente");

      if (inputBuscar && inputBuscar.value !== c) inputBuscar.value = c;
      if (inputForm && inputForm.value !== c) inputForm.value = c;
    }

    function limpiarEvolucionForm() {
      const c = document.getElementById("evo_cedula_paciente");
      const f = document.getElementById("evo_fecha");
      const h = document.getElementById("evo_hora");
      const p = document.getElementById("evo_profesional");
      const t = document.getElementById("evo_tipo");
      const d = document.getElementById("evo_detalle");

      if (c) c.value = _cedulaPacienteActiva || "";
      if (f) f.value = _hoyISO();
      if (h) h.value = _horaHHMM();
      if (p) p.value = "";
      if (t) t.value = "";
      if (d) d.value = "";
    }

    function renderEvoluciones() {
      const tbody = document.getElementById("tabla_evoluciones");
      const empty = document.getElementById("evo_empty");
      if (!tbody) return;

      tbody.innerHTML = "";

      if (!evoluciones.length){
        if (empty) empty.style.display = "block";
        return;
      }
      if (empty) empty.style.display = "none";

      evoluciones.forEach((evo) => {
        const tr = document.createElement("tr");

        const idEvo = evo.id ?? "";
        const fecha = _soloFechaYYYYMMDD(evo.fecha);
        const hora  = _soloHoraHHMM(evo.hora);
        const profesional = evo.profesional ?? "";
        const procedimiento = evo.procedimiento ?? "";
        const detalle = evo.detalle ?? "";
        const cedula = evo.cedula_paciente ?? "";

        tr.innerHTML = `
          <td style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;">
            ${escapeHtml(idEvo)}
          </td>
          <td>${escapeHtml(cedula)}</td>
          <td>${escapeHtml(fecha)}</td>
          <td>${escapeHtml(hora)}</td>
          <td>${escapeHtml(String(profesional).toUpperCase())}</td>
          <td>${escapeHtml(String(procedimiento).toUpperCase())}</td>
          <td style="white-space:pre-wrap;">${escapeHtml(detalle)}</td>
          <td>
            <button type="button" class="btn btn-buscar" style="padding:8px 10px; width:auto;"
              onclick="eliminarEvolucionSupabase('${escapeHtml(idEvo)}')">
              Eliminar
            </button>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    function normalizarEvoRow(x){
      return {
        id: x.id ?? x.id_evolucion ?? x["id-evolucion"] ?? "",
        fecha: _soloFechaYYYYMMDD(x.fecha ?? x.evo_fecha ?? x.ts ?? x.created_at ?? ""),
        hora: _soloHoraHHMM(x.hora ?? x.evo_hora ?? ""),
        profesional: x.profesional ?? x.evo_profesional ?? "",
        procedimiento: x.procedimiento ?? x.evo_tipo ?? "",
        detalle: x.detalle ?? x.evo_detalle ?? "",
        cedula_paciente: x.cedula_paciente ?? "",
        usuario: x.usuario ?? "",
        ts: x.ts ?? x.created_at ?? null
      };
    }

    async function cargarEvolucionesPacienteDesdeSupabase(cedula){
      const c = _normalizarCedula(cedula);
      if (!c) {
        evoluciones = [];
        renderEvoluciones();
        return;
      }

      setCedulaPacienteUI(c);

      try{
        const { data, error } = await window.supabase
          .from(EVOLUCIONES_TABLE)
          .select("*")
          .eq("cedula_paciente", c)
          .order("ts", { ascending: false });

        if (error) {
          // fallback: si no existe "ts", intenta por created_at
          const { data: data2, error: error2 } = await window.supabase
            .from(EVOLUCIONES_TABLE)
            .select("*")
            .eq("cedula_paciente", c)
            .order("created_at", { ascending: false });

          if (error2) throw error2;
          evoluciones = (data2 || []).map(normalizarEvoRow);
          renderEvoluciones();
          return;
        }

        evoluciones = (data || []).map(normalizarEvoRow);
        renderEvoluciones();
      }catch(e){
        console.warn("‚ùå Error cargando evoluciones:", e);
        alert("‚ùå No se pudieron cargar evoluciones. Revisa consola.\n\n" + (e?.message || JSON.stringify(e)));
        evoluciones = [];
        renderEvoluciones();
      }
    }

    async function agregarEvolucion() {
      const cedula = _normalizarCedula(document.getElementById("evo_cedula_paciente")?.value);
      const fecha = (document.getElementById("evo_fecha")?.value || _hoyISO()).trim();
      const hora = (document.getElementById("evo_hora")?.value || _horaHHMM()).trim();
      const profesional = (document.getElementById("evo_profesional")?.value || "").trim();
      const tipo = (document.getElementById("evo_tipo")?.value || "").trim();
      const detalle = (document.getElementById("evo_detalle")?.value || "").trim();

      if (!cedula) { alert("‚ö†Ô∏è Debes ingresar la c√©dula del paciente."); return; }
      if (!profesional) { alert("‚ö†Ô∏è Debes seleccionar el profesional."); return; }
      if (!tipo) { alert("‚ö†Ô∏è Debes ingresar el procedimiento."); return; }

      const usuario = localStorage.getItem("usuario_logueado") || "desconocido";

      const item = {
        id: uuid(),
        fecha,
        hora,
        profesional,
        procedimiento: tipo,
        detalle,
        cedula_paciente: cedula,
        usuario,
        ts: new Date().toISOString()
      };

      try{
        const { error } = await window.supabase
          .from(EVOLUCIONES_TABLE)
          .insert(item);

        if (error) throw error;

        setCedulaPacienteUI(cedula);
        await cargarEvolucionesPacienteDesdeSupabase(cedula);
        limpiarEvolucionForm();
        alert("‚úÖ Evoluci√≥n guardada.");
      }catch(e){
        console.warn("‚ùå Error guardando evoluci√≥n:", e);
        alert("‚ùå No se pudo guardar la evoluci√≥n.\n\n" + (e?.message || JSON.stringify(e)));
      }
    }

    async function eliminarEvolucionSupabase(id){
      if (!id) return;
      const ok = confirm("¬øEliminar esta evoluci√≥n?");
      if (!ok) return;

      try{
        const { error } = await window.supabase
          .from(EVOLUCIONES_TABLE)
          .delete()
          .eq("id", id);

        if (error) throw error;

        await cargarEvolucionesPacienteDesdeSupabase(_cedulaPacienteActiva);
        alert("‚úÖ Evoluci√≥n eliminada.");
      }catch(e){
        console.warn("‚ùå Error eliminando evoluci√≥n:", e);
        alert("‚ùå No se pudo eliminar.\n\n" + (e?.message || JSON.stringify(e)));
      }
    }

    async function buscarEvolucionesPorCedula(){
      const cedula = _normalizarCedula(document.getElementById("buscar_cedula_paciente")?.value);
      if (!cedula) { alert("‚ö†Ô∏è Ingresa la c√©dula del paciente."); return; }
      await cargarEvolucionesPacienteDesdeSupabase(cedula);
      limpiarEvolucionForm();
    }

    function ponerHoraFechaAuto(){
      const f = document.getElementById("evo_fecha");
      const h = document.getElementById("evo_hora");
      if (f) f.value = _hoyISO();
      if (h) h.value = _horaHHMM();
    }

    // Exponer a window (para onclick)
    window.buscarEvolucionesPorCedula = buscarEvolucionesPorCedula;
    window.agregarEvolucion = agregarEvolucion;
    window.limpiarEvolucionForm = limpiarEvolucionForm;
    window.eliminarEvolucionSupabase = eliminarEvolucionSupabase;

    // Init
    document.addEventListener("DOMContentLoaded", async () => {
      ponerHoraFechaAuto();
      await cargarProcedimientosDesdeSupabase();
      await cargarProfesionalesDesdeSupabase();
      limpiarEvolucionForm();
    });
  </script>

  <style>
    :root{
      --ink:#19324d;
      --muted:#6b7a90;
      --bg:#f6f8fb;
      --card:#ffffff;
      --brand:#2a5d84;
      --gap:18px;
      --radius:14px;
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --line:#e7edf5;
      --input:#cbd5e1;
    }

    *{box-sizing:border-box}
    body{
      margin:0; padding:24px; font-family:system-ui,Segoe UI,Arial; color:var(--ink); background:var(--bg);
    }
    .container{ max-width:1100px; margin:0 auto; }
    h1{ margin:0 0 14px; font-size:28px; color:var(--brand); }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:var(--shadow);
      margin-bottom:22px;
    }
    .legend{ font-weight:800; margin-bottom:8px; color:var(--brand); }

    .grid{ display:grid; gap:var(--gap); }
    .g-2{ grid-template-columns:1fr 1fr; }
    .g-3{ grid-template-columns:repeat(3,1fr); }
    .full{ grid-column:1 / -1; }

    .ctrl{ display:flex; flex-direction:column; gap:8px; }
    .ctrl label{ font-size:13px; color:var(--muted); }

    input[type="text"],input[type="number"],input[type="date"],input[type="time"], textarea, select{
      width:100%; border:1px solid var(--input); border-radius:10px; padding:12px;
      font-size:15px; background:#fff;
    }
    textarea{ min-height:120px; resize:vertical; }

    .inline{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

    .btn{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      color:white;
      font-size:14px;
      font-weight:700;
    }
    .btn-buscar{ background:#0D47A1; }
    .btn-agenda{ background:#009688; }

    .rowline{ height:1px; background:var(--line); margin:12px 0; }

    .tabla-evo{
      width:100%;
      border-collapse:collapse;
    }
    .tabla-evo th,.tabla-evo td{
      padding:10px;
      border:1px solid var(--line);
      vertical-align:top;
    }
    .tabla-evo thead tr{
      background:#eef6ff;
    }

    .vwrap{ position: relative; display: flex; align-items: center; gap: 10px; }
    .vwrap .vfield{ flex: 1; }
    .vbtn{
      width: 44px; min-width: 44px; height: 44px; border-radius: 10px;
      border: 1px solid var(--line); background: #F5F5F5; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center; font-size: 18px;
      color: transparent;
    }
    .vbtn.on{ background: #0D47A1; color: #fff; border-color: #0D47A1; }

    .muted{ color:var(--muted); font-size:13px; }

    @media (max-width:980px){
      .g-3{ grid-template-columns:1fr 1fr; }
    }
    @media (max-width:680px){
      .g-2,.g-3{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Evoluciones (procedimientos realizados)</h1>

    <!-- ‚úÖ BUSCAR POR C√âDULA PACIENTE (NUEVO) -->
    <section class="card">
      <div class="legend">Buscar evoluciones por c√©dula del paciente</div>

      <div class="grid g-2" style="align-items:end;">
        <div class="ctrl">
          <label for="buscar_cedula_paciente">C√©dula paciente</label>
          <input
            id="buscar_cedula_paciente"
            type="text"
            inputmode="numeric"
            pattern="[0-9]+"
            placeholder="Ej: 10229566001"
            oninput="this.value = this.value.replace(/[^0-9]/g, '')"
          />
        </div>

        <div class="ctrl">
          <label>&nbsp;</label>
          <button type="button" class="btn btn-buscar" onclick="buscarEvolucionesPorCedula()">
            Buscar evoluciones
          </button>
        </div>
      </div>

      <div class="muted" style="margin-top:10px;">
        ‚úÖ Tip: al buscar por c√©dula, esa misma c√©dula queda lista para agregar nuevas evoluciones al mismo paciente.
      </div>
    </section>

    <!-- ‚úÖ FORMULARIO EVOLUCI√ìN -->
    <section class="card">
      <div class="legend">Nueva evoluci√≥n</div>

      <div class="grid g-3">
        <!-- ‚úÖ NUEVO CAMPO: C√âDULA PACIENTE -->
        <div class="ctrl">
          <label for="evo_cedula_paciente">C√©dula paciente</label>
          <input
            id="evo_cedula_paciente"
            type="text"
            inputmode="numeric"
            pattern="[0-9]+"
            placeholder="Ej: 10229566001"
            oninput="this.value = this.value.replace(/[^0-9]/g, '')"
          />
        </div>

        <div class="ctrl">
          <label for="evo_fecha">Fecha</label>
          <input id="evo_fecha" type="date">
        </div>

        <div class="ctrl">
          <label for="evo_hora">Hora</label>
          <input id="evo_hora" type="time" readonly>
        </div>

        <div class="ctrl">
          <label for="evo_profesional">Profesional</label>
          <select id="evo_profesional">
            <option value="">Seleccione profesional...</option>
          </select>
        </div>

        <div class="ctrl">
          <label for="evo_tipo">Procedimiento</label>
          <input
            id="evo_tipo"
            type="text"
            list="procedimientos_list_supabase"
            placeholder="Buscar o escribir procedimiento..."
            autocomplete="off"
          />
        </div>

        <div class="ctrl full">
          <label for="evo_detalle">Detalle / Observaciones</label>

          <div class="vwrap">
            <div class="vfield">
              <textarea id="evo_detalle" placeholder="Descripci√≥n del procedimiento, piezas intervenidas, materiales, etc."></textarea>
            </div>

            <button
              id="btnDictadoEvoDetalle"
              type="button"
              class="vbtn"
              title="Dictar por voz"
              aria-label="Dictar por voz"
              onclick="toggleDictadoEvoDetalle()"
            >üé§</button>
          </div>

          <div id="dictadoHintEvo" style="font-size:12px; color:#6b7a90; margin-top:6px; display:none;">
            üéôÔ∏è Dictando... habla normal. (Se agregar√° al final del texto)
          </div>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <button type="button" onclick="agregarEvolucion()" class="btn btn-agenda" style="max-width:260px;">
          Agregar evoluci√≥n
        </button>
        <button type="button" onclick="limpiarEvolucionForm()" class="btn btn-buscar" style="max-width:260px;">
          Limpiar
        </button>
      </div>

      <datalist id="procedimientos_list_supabase"></datalist>
    </section>

    <!-- ‚úÖ TABLA EVOLUCIONES -->
    <section class="card">
      <div class="legend">Evoluciones encontradas</div>

      <div id="evo_empty" class="muted" style="display:block; margin-bottom:10px;">
        Sin evoluciones para mostrar. Busca por c√©dula para cargar.
      </div>

      <div style="overflow:auto;">
        <table class="tabla-evo">
          <thead>
            <tr>
              <th>ID Evoluci√≥n</th>
              <th>C√©dula paciente</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Profesional</th>
              <th>Procedimiento</th>
              <th>Detalle</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla_evoluciones"></tbody>
        </table>
      </div>
    </section>
  </div>
</body>
</html>



