<!-- evoluciones.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Evoluciones - Historia Cl√≠nica Odontol√≥gica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- üîê SUPABASE + LOGIN (igual l√≥gica del original) -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
    );

    window.supabase = supabase;

    window.APP_URLS = {
      LOGIN: "https://cacg1022.github.io/ODONTOLOGIA/login.html",
      HOME:  "https://cacg1022.github.io/ODONTOLOGIA/index.html",
    };

    const MODULO = "historia_clinica";

    async function verificarSesion() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = window.APP_URLS.LOGIN;
        return null;
      }
      return session;
    }

    async function validarPermisoModulo() {
      const session = await verificarSesion();
      if (!session) return;

      const { data: perfil, error: ePerfil } = await supabase
        .from("profiles")
        .select("role")
        .eq("id", session.user.id)
        .single();

      if (ePerfil || !perfil?.role) {
        alert("No se pudo obtener tu rol.");
        window.location.href = window.APP_URLS.HOME;
        return;
      }

      const rol = perfil.role;

      const { data: permiso, error: ePerm } = await supabase
        .from("modulos_permisos")
        .select("admin, doctor, auxiliar, paciente")
        .eq("modulo", MODULO)
        .single();

      if (ePerm || !permiso) {
        alert("M√≥dulo no configurado en permisos.");
        window.location.href = window.APP_URLS.HOME;
        return;
      }

      if (!permiso[rol]) {
        alert("‚õî No tienes permiso para acceder a Evoluciones.");
        window.location.href = window.APP_URLS.HOME;
        return;
      }

      console.log("‚úÖ Acceso permitido a Evoluciones para:", rol);
    }

    validarPermisoModulo();

    supabase.auth.onAuthStateChange((_event, session) => {
      if (!session) window.location.href = window.APP_URLS.LOGIN;
    });

    // ==============================
    // ‚úÖ DICTADO POR VOZ (Evoluciones: evo_detalle) - IGUAL AL ORIGINAL
    // ==============================
    let _srEvo = null;
    let _srEvoOn = false;

    function _soportaDictado() {
      return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
    }

    function _appendEnTextarea(textarea, texto) {
      if (!textarea) return;

      const actual = textarea.value || "";
      const add = (texto || "").trim();
      if (!add) return;

      const sep = actual.trim().length ? (actual.endsWith("\n") ? "" : "\n") : "";
      textarea.value = actual + sep + add;

      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
    }

    function iniciarDictadoEvoDetalle() {
      const ta = document.getElementById("evo_detalle");
      const btn = document.getElementById("btnDictadoEvoDetalle");
      const hint = document.getElementById("dictadoHintEvo");

      if (!_soportaDictado()) {
        alert("‚ö†Ô∏è Tu navegador no soporta dictado por voz. Usa Chrome o Edge.");
        return;
      }

      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      _srEvo = new SR();

      _srEvo.lang = "es-CO";
      _srEvo.continuous = true;
      _srEvo.interimResults = true;

      let bufferFinal = "";

      _srEvo.onstart = () => {
        _srEvoOn = true;
        if (btn) btn.classList.add("on");
        if (hint) hint.style.display = "block";
      };

      _srEvo.onresult = (event) => {
        let textoFinal = "";

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const res = event.results[i];
          const t = (res[0]?.transcript || "").trim();
          if (!t) continue;

          if (res.isFinal) {
            textoFinal += (textoFinal ? " " : "") + t;
          }
        }

        if (textoFinal) {
          bufferFinal += (bufferFinal ? " " : "") + textoFinal;
          _appendEnTextarea(ta, bufferFinal);
          bufferFinal = "";
        }
      };

      _srEvo.onerror = (e) => {
        console.warn("Dictado error:", e);
        if (e?.error === "not-allowed" || e?.error === "service-not-allowed") {
          alert("‚ö†Ô∏è Permiso de micr√≥fono denegado. Habil√≠talo en el navegador.");
          detenerDictadoEvoDetalle();
        }
      };

      _srEvo.onend = () => {
        if (_srEvoOn) {
          try { _srEvo.start(); } catch (err) {}
          return;
        }
        if (btn) btn.classList.remove("on");
        if (hint) hint.style.display = "none";
      };

      try { _srEvo.start(); } catch (e) { console.warn("No se pudo iniciar dictado:", e); }
    }

    function detenerDictadoEvoDetalle() {
      const btn = document.getElementById("btnDictadoEvoDetalle");
      const hint = document.getElementById("dictadoHintEvo");

      _srEvoOn = false;

      if (_srEvo) {
        try { _srEvo.onend = null; } catch(e) {}
        try { _srEvo.stop(); } catch(e) {}
        _srEvo = null;
      }

      if (btn) btn.classList.remove("on");
      if (hint) hint.style.display = "none";
    }

    function toggleDictadoEvoDetalle() {
      if (_srEvoOn) detenerDictadoEvoDetalle();
      else iniciarDictadoEvoDetalle();
    }

    window.addEventListener("beforeunload", () => {
      try { detenerDictadoEvoDetalle(); } catch(e) {}
    });

    window.toggleDictadoEvoDetalle = toggleDictadoEvoDetalle;
  </script>

  <style>
    :root{
      --ink:#19324d;
      --muted:#6b7a90;
      --bg:#f6f8fb;
      --card:#ffffff;
      --brand:#2a5d84;
      --gap:18px;
      --radius:14px;
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --line:#e7edf5;
      --input:#cbd5e1;
    }
    *{box-sizing:border-box}
    body{ margin:0; padding:24px; font-family:system-ui,Segoe UI,Arial; color:var(--ink); background:var(--bg); }
    .container{ max-width:1100px; margin:0 auto; }
    h1{ margin:0 0 14px; font-size:28px; color:var(--brand); }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:var(--shadow);
      margin-bottom:22px;
    }
    .legend{ font-weight:700; margin-bottom:8px; color:var(--brand); }

    .grid{ display:grid; gap:var(--gap); }
    .g-2{ grid-template-columns:1fr 1fr; }
    .g-3{ grid-template-columns:repeat(3,1fr); }
    .full{ grid-column:1 / -1; }

    .ctrl{ display:flex; flex-direction:column; gap:8px; }
    .ctrl label{ font-size:13px; color:var(--muted); }

    input[type="text"], input[type="date"], input[type="time"], textarea{
      width:100%; border:1px solid var(--input); border-radius:10px; padding:12px;
      font-size:15px; background:#fff;
    }
    select{
      width:100%;
      border:1px solid var(--input);
      border-radius:10px;
      padding:12px;
      font-size:15px;
      background:#fff;
      cursor:pointer;
    }
    textarea{ min-height:120px; resize:vertical; }

    .inline{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .rowline{ height:1px; background:var(--line); margin:12px 0; }

    @media (max-width:980px){ .g-3{ grid-template-columns:1fr 1fr; } }
    @media (max-width:680px){ .g-2,.g-3{ grid-template-columns:1fr; } }

    .btn{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      color:white;
      font-size:14px;
    }
    .btn-buscar{ background:#0D47A1; }
    .btn-agenda{ background:#009688; }
    .btn-inicio{ background:#E3E3E3; color:#009688; font-weight:700; }
    .btn-salir{ background:#009688; }

    .tabla-evo{ width:100%; border-collapse:collapse; }
    .tabla-evo th,.tabla-evo td{ padding:10px; border:1px solid var(--line); vertical-align:top; }
    .tabla-evo thead tr{ background:#eef6ff; }

    /* Dictado */
    .vwrap{ position: relative; display: flex; align-items: center; gap: 10px; }
    .vwrap .vfield{ flex: 1; }
    .vbtn{
      width: 44px; min-width: 44px; height: 44px; border-radius: 10px;
      border: 1px solid var(--line); background: #F5F5F5; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 18px; color: transparent;
    }
    .vbtn.on{ background: #0D47A1; color: #fff; border-color: #0D47A1; }

    /* ‚úÖ Firmas */
    .firma-box{
      border:1px solid var(--input);
      border-radius:12px;
      background:#fff;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .firma-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .btn-mini{
      width:auto;
      padding:10px 12px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-size:13px;
      color:#fff;
      background:#0D47A1;
    }
    canvas.firma-canvas{
      width:100%;
      height:180px; /* visual */
      border:1px dashed var(--line);
      border-radius:10px;
      touch-action:none; /* importante para mobile */
      background:#fff;
    }
    .firma-hint{ font-size:12px; color:var(--muted); }
  </style>
</head>

<body>
<div class="container">

  <section class="card">
    <div class="legend">Buscar evoluciones por c√©dula del paciente</div>

    <div class="grid g-2" style="align-items:end;">
      <div class="ctrl">
        <label for="cedula_paciente">C√©dula paciente</label>
        <input id="cedula_paciente" type="text" placeholder="Ej: 10229566001"
          inputmode="numeric" pattern="[0-9]+"
          oninput="this.value = this.value.replace(/[^0-9]/g, '')">
      </div>
      <div class="ctrl">
        <label>&nbsp;</label>
        <button type="button" class="btn btn-buscar" onclick="buscarEvolucionesPorCedula()">
          Buscar evoluciones
        </button>
      </div>

      <div class="ctrl">
        <button type="button" class="btn btn-inicio" onclick="irInicio()">IR A INICIO</button>
      </div>
      <div class="ctrl">
        <button type="button" class="btn btn-salir" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
      </div>
    </div>

    <div style="margin-top:10px; font-size:12px; color:#6b7a90;">
      Nota: Esto consulta evoluciones desde el mismo webhook de N8N que usa tu historia cl√≠nica.
    </div>
  </section>

  <h1>Evoluciones (procedimientos realizados)</h1>

  <section class="card">
    <div class="legend">Registro de evoluci√≥n</div>

    <div class="grid g-3">
      <div class="ctrl">
        <label for="evo_fecha">Fecha</label>
        <input id="evo_fecha" type="date" disabled>
      </div>

      <div class="ctrl">
        <label for="evo_hora">Hora</label>
        <input id="evo_hora" type="time" readonly>
      </div>

      <div class="ctrl">
        <label for="evo_profesional">Profesional</label>
        <select id="evo_profesional">
          <option value="">Seleccione profesional...</option>
        </select>
      </div>

      <div class="ctrl">
        <label for="evo_tipo">Procedimiento</label>
        <input id="evo_tipo" type="text" list="procedimientos_list_supabase"
          placeholder="Buscar o escribir procedimiento..." autocomplete="off" />
      </div>

      <div class="ctrl full">
        <label for="evo_detalle">Detalle / Observaciones</label>
        <div class="vwrap">
          <div class="vfield">
            <textarea id="evo_detalle" placeholder="Descripci√≥n del procedimiento, piezas intervenidas, materiales, etc."></textarea>
          </div>
          <button
            id="btnDictadoEvoDetalle"
            type="button"
            class="vbtn"
            title="Dictar por voz"
            aria-label="Dictar por voz"
            onclick="toggleDictadoEvoDetalle()"
          >üé§</button>
        </div>
        <div id="dictadoHintEvo" style="font-size:12px; color:#6b7a90; margin-top:6px; display:none;">
          üéôÔ∏è Dictando... habla normal. (Se agregar√° al final del texto)
        </div>
      </div>

      <!-- ‚úÖ NUEVOS CAMPOS: FIRMAS -->
      <div class="ctrl full">
        <label>Firma del paciente</label>
        <div class="firma-box">
          <canvas id="firma_paciente" class="firma-canvas"></canvas>
          <div class="firma-actions">
            <span class="firma-hint">Dibuja con el mouse o con el dedo.</span>
            <button type="button" class="btn-mini" onclick="limpiarFirma('firma_paciente')">Limpiar firma</button>
          </div>
        </div>
      </div>

      <div class="ctrl full">
        <label>Firma del profesional</label>
        <div class="firma-box">
          <canvas id="firma_profesional" class="firma-canvas"></canvas>
          <div class="firma-actions">
            <span class="firma-hint">Dibuja con el mouse o con el dedo.</span>
            <button type="button" class="btn-mini" onclick="limpiarFirma('firma_profesional')">Limpiar firma</button>
          </div>
        </div>
      </div>

    </div>

    <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
      <button type="button" onclick="agregarEvolucion()" class="btn btn-agenda" style="max-width:260px;">Agregar evoluci√≥n</button>
      <button type="button" onclick="limpiarEvolucionForm()" class="btn btn-buscar" style="max-width:260px;">Limpiar</button>
    </div>

    <div class="rowline"></div>

    <div style="overflow:auto;">
      <table class="tabla-evo">
        <thead>
          <tr>
            <th>ID Evoluci√≥n</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Profesional</th>
            <th>Procedimiento</th>
            <th>Detalle</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla_evoluciones"></tbody>
      </table>
    </div>
  </section>

</div>

<datalist id="procedimientos_list_supabase"></datalist>

<script>
  // ==============================
  // CONFIG (urls originales)
  // ==============================
  const LOGIN_URL = window.APP_URLS?.LOGIN || "https://cacg1022.github.io/ODONTOLOGIA/login.html";
  const URL_INICIO = "https://cacg1022.github.io/ODONTOLOGIA/index.html";

  const WEBHOOK_BUSCAR_HISTORIA =
    "https://ftth-n8n2.pzveh5.easypanel.host/webhook/62804cbf-8f21-453b-823e-e5c1b94f31c8";

  const WEBHOOK_GUARDAR_EVOLUCION =
    "https://ftth-n8n2.pzveh5.easypanel.host/webhook/569051e4-4bdf-44e9-b0d3-34694d6077e9";

  function irInicio(){ window.location.href = URL_INICIO; }

  async function cerrarSesion(motivo = "") {
    try {
      if (window.supabase?.auth?.signOut) await window.supabase.auth.signOut();
    } catch (e) { console.warn("Error cerrando sesi√≥n:", e); }

    try { localStorage.removeItem("usuario_logueado"); } catch(e) {}
    if (motivo) alert(motivo);
    window.location.href = LOGIN_URL;
  }

  // ==============================
  // UTILIDADES
  // ==============================
  function _uuidFallback() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }
  function uuid() {
    try { return (crypto && crypto.randomUUID) ? crypto.randomUUID() : _uuidFallback(); }
    catch(e){ return _uuidFallback(); }
  }
  function _hoyISO() { return new Date().toISOString().slice(0, 10); }
  function _horaHHMM() {
    const d = new Date();
    return String(d.getHours()).padStart(2, "0") + ":" + String(d.getMinutes()).padStart(2, "0");
  }
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function _soloFechaYYYYMMDD(valor) {
    if (!valor) return "";
    if (typeof valor === "string" && valor.includes("T")) return valor.split("T")[0];
    return String(valor);
  }
  function _soloHoraHHMM(valor) {
    if (!valor) return "";
    const s = String(valor);
    if (/^\d{2}:\d{2}:\d{2}/.test(s)) return s.slice(0,5);
    return s;
  }

  // ==============================
  // ‚úÖ FIRMA EN CANVAS (mouse + touch)
  // ==============================
  const firmas = {
    firma_paciente: { canvas: null, ctx: null, drawing: false, hasInk: false },
    firma_profesional: { canvas: null, ctx: null, drawing: false, hasInk: false }
  };

  function _resizeCanvasToCSS(canvas) {
    // Ajusta resoluci√≥n real al tama√±o CSS para evitar firmas pixeladas
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    const w = Math.max(1, Math.round(rect.width * dpr));
    const h = Math.max(1, Math.round(rect.height * dpr));
    if (canvas.width !== w || canvas.height !== h) {
      canvas.width = w;
      canvas.height = h;
    }
  }

  function _initFirma(id) {
    const canvas = document.getElementById(id);
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    firmas[id].canvas = canvas;
    firmas[id].ctx = ctx;

    function setup() {
      _resizeCanvasToCSS(canvas);
      // Fondo blanco (para que el PNG no sea transparente)
      ctx.save();
      ctx.setTransform(1,0,0,1,0,0);
      ctx.globalCompositeOperation = "source-over";
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.restore();

      ctx.lineWidth = 3;
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = "#111";
    }

    setup();

    let lastX = 0, lastY = 0;

    function getPos(evt) {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;

      let clientX, clientY;

      if (evt.touches && evt.touches.length) {
        clientX = evt.touches[0].clientX;
        clientY = evt.touches[0].clientY;
      } else {
        clientX = evt.clientX;
        clientY = evt.clientY;
      }

      const x = (clientX - rect.left) * dpr;
      const y = (clientY - rect.top) * dpr;
      return { x, y };
    }

    function start(evt) {
      evt.preventDefault();
      firmas[id].drawing = true;
      const p = getPos(evt);
      lastX = p.x; lastY = p.y;
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
    }

    function move(evt) {
      if (!firmas[id].drawing) return;
      evt.preventDefault();
      const p = getPos(evt);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      lastX = p.x; lastY = p.y;
      firmas[id].hasInk = true;
    }

    function end(evt) {
      if (!firmas[id].drawing) return;
      evt.preventDefault();
      firmas[id].drawing = false;
      ctx.closePath();
    }

    // Mouse
    canvas.addEventListener("mousedown", start);
    canvas.addEventListener("mousemove", move);
    window.addEventListener("mouseup", end);

    // Touch
    canvas.addEventListener("touchstart", start, { passive: false });
    canvas.addEventListener("touchmove", move, { passive: false });
    canvas.addEventListener("touchend", end, { passive: false });
    canvas.addEventListener("touchcancel", end, { passive: false });

    // Reajuste al cambiar tama√±o
    window.addEventListener("resize", () => {
      // Guardar imagen actual
      const dataUrl = canvas.toDataURL("image/png");
      setup();
      // Reponer imagen (si existe)
      const img = new Image();
      img.onload = () => { ctx.drawImage(img, 0, 0, canvas.width, canvas.height); };
      img.src = dataUrl;
    });
  }

  function limpiarFirma(id) {
    const f = firmas[id];
    if (!f?.canvas || !f?.ctx) return;
    _resizeCanvasToCSS(f.canvas);
    f.ctx.save();
    f.ctx.setTransform(1,0,0,1,0,0);
    f.ctx.globalCompositeOperation = "source-over";
    f.ctx.fillStyle = "#ffffff";
    f.ctx.fillRect(0,0,f.canvas.width,f.canvas.height);
    f.ctx.restore();
    f.hasInk = false;
  }

  function obtenerFirmaBase64(id) {
    const f = firmas[id];
    if (!f?.canvas) return "";
    // Si no se dibuj√≥ nada, retornamos vac√≠o
    if (!f.hasInk) return "";
    return f.canvas.toDataURL("image/png"); // base64 PNG
  }

  // ==============================
  // ‚úÖ PROCEDIMIENTOS DESDE SUPABASE
  // ==============================
  async function cargarProcedimientosDesdeSupabase() {
    const dl = document.getElementById("procedimientos_list_supabase");
    if (!dl) return;

    let tries = 0;
    while (!window.supabase && tries < 40) {
      await new Promise(r => setTimeout(r, 100));
      tries++;
    }
    if (!window.supabase) return;

    try {
      const { data, error } = await window.supabase
        .from("procedimientos_precios")
        .select("procedimiento, activo")
        .eq("activo", true)
        .order("procedimiento", { ascending: true });

      if (error) throw error;

      const items = (data || [])
        .map(x => String(x.procedimiento || "").trim())
        .filter(Boolean);

      dl.innerHTML = items.map(p => `<option value="${escapeHtml(p)}"></option>`).join("");
    } catch (e) {
      console.warn("‚ö†Ô∏è Error cargando procedimientos:", e);
    }
  }

  // ==============================
  // ‚úÖ PROFESIONALES DESDE SUPABASE
  // ==============================
  async function cargarProfesionalesDesdeSupabase() {
    let tries = 0;
    while (!window.supabase && tries < 40) {
      await new Promise(r => setTimeout(r, 100));
      tries++;
    }
    if (!window.supabase) return;

    const selEvo = document.getElementById("evo_profesional");
    if (!selEvo) return;

    const placeholder = `<option value="">Seleccione profesional...</option>`;
    selEvo.innerHTML = placeholder;

    try {
      const { data, error } = await window.supabase
        .from("profesionales")
        .select("id, nombre, cedula, activo")
        .eq("activo", true)
        .order("nombre", { ascending: true });

      if (error) throw error;

      const options = (data || []).map(p => {
        const nombre = (p.nombre || "").trim();
        const cedula = (p.cedula || "").trim();
        const valor = `${cedula} ${nombre}`.trim(); // value: "CEDULA NOMBRE"
        const label = nombre; // label: SOLO nombre
        return `<option value="${escapeHtml(valor)}">${escapeHtml(label)}</option>`;
      }).join("");

      selEvo.innerHTML = placeholder + options;

    } catch (e) {
      console.warn("‚ö†Ô∏è Error cargando profesionales:", e);
    }
  }

  // ==============================
  // ‚úÖ EVOLUCIONES
  // ==============================
  let evoluciones = [];
  let _cedulaActual = "";

  function limpiarEvolucionForm() {
    const f = document.getElementById("evo_fecha");
    const h = document.getElementById("evo_hora");
    const p = document.getElementById("evo_profesional");
    const t = document.getElementById("evo_tipo");
    const d = document.getElementById("evo_detalle");

    if (f) f.value = _hoyISO();
    if (h) h.value = _horaHHMM();
    if (p) p.value = "";
    if (t) t.value = "";
    if (d) d.value = "";

    // ‚úÖ limpiar firmas
    limpiarFirma("firma_paciente");
    limpiarFirma("firma_profesional");
  }

  function generarEvolucionId() { return uuid(); }

  function normalizarEvolucionesDeWebhook(data) {
    let raw = data?.evoluciones;

    if (raw && !Array.isArray(raw) && typeof raw === "object" && Array.isArray(raw.evoluciones)) {
      raw = raw.evoluciones;
    }
    if (typeof raw === "string") {
      try { raw = JSON.parse(raw); } catch(e) { raw = []; }
    }
    if (!Array.isArray(raw)) raw = [];

    return raw.map((e) => ({
      id: e.id_evolucion ?? e["id-evolucion"] ?? e.id ?? generarEvolucionId(),
      fecha: _soloFechaYYYYMMDD(e.fecha ?? e.evo_fecha),
      hora: _soloHoraHHMM(e.hora ?? e.evo_hora),
      profesional: e.profesional ?? e.evo_profesional ?? "",
      procedimiento: e.procedimiento ?? e.evo_tipo ?? "",
      detalle: e.detalle ?? e.evo_detalle ?? "",
      firma_paciente: e.firma_paciente ?? "",
      firma_profesional: e.firma_profesional ?? "",
      created_at: e.created_at ?? null,
      ts: e.ts ?? e.created_at ?? new Date().toISOString()
    }));
  }

  function renderEvoluciones() {
    const tbody = document.getElementById("tabla_evoluciones");
    if (!tbody) return;

    tbody.innerHTML = "";

    evoluciones.forEach((evo, idx) => {
      const idEvo = evo.id_evolucion ?? evo["id-evolucion"] ?? evo.id ?? "";
      const fecha = _soloFechaYYYYMMDD(evo.fecha ?? evo.evo_fecha);
      const hora  = _soloHoraHHMM(evo.hora ?? evo.evo_hora);
      const profesional = evo.profesional ?? evo.evo_profesional ?? "";
      const procedimiento = evo.procedimiento ?? evo.evo_tipo ?? "";
      const detalle = evo.detalle ?? evo.evo_detalle ?? "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;">
          ${escapeHtml(idEvo)}
        </td>
        <td>${escapeHtml(fecha)}</td>
        <td>${escapeHtml(hora)}</td>
        <td>${escapeHtml(String(profesional).toUpperCase())}</td>
        <td>${escapeHtml(String(procedimiento).toUpperCase())}</td>
        <td style="white-space:pre-wrap;">${escapeHtml(detalle)}</td>
        <td style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" class="btn btn-buscar" style="padding:8px 10px; width:auto;" onclick="eliminarEvolucion(${idx})">
            Eliminar
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function eliminarEvolucion(idx) {
    evoluciones.splice(idx, 1);
    renderEvoluciones();
  }

  async function agregarEvolucion() {
    const fecha = (document.getElementById("evo_fecha").value || _hoyISO()).trim();
    const hora = (document.getElementById("evo_hora").value || _horaHHMM()).trim();
    const profesional = (document.getElementById("evo_profesional").value || "").trim();
    const tipo = (document.getElementById("evo_tipo").value || "").trim();
    const detalle = (document.getElementById("evo_detalle").value || "").trim();

    const firmaPaciente = obtenerFirmaBase64("firma_paciente");
    const firmaProfesional = obtenerFirmaBase64("firma_profesional");

    if (!profesional) { alert("‚ö†Ô∏è Debes ingresar el nombre del profesional."); return; }
    if (!tipo) { alert("‚ö†Ô∏è Debes ingresar el procedimiento."); return; }

    // ‚úÖ valida firmas (si no quieres obligatorio, borra estas 2 l√≠neas)
    if (!firmaPaciente) { alert("‚ö†Ô∏è Falta la firma del paciente."); return; }
    if (!firmaProfesional) { alert("‚ö†Ô∏è Falta la firma del profesional."); return; }

    const cedula = (_cedulaActual || document.getElementById("cedula_paciente")?.value || "").trim();
    if (!cedula) { alert("‚ö†Ô∏è Primero debes buscar/ingresar la c√©dula del paciente."); return; }

    const usuario = localStorage.getItem("usuario_logueado") || "desconocido";

    // ‚úÖ item incluye firmas
    const item = {
      id: generarEvolucionId(),
      fecha,
      hora,
      profesional,
      procedimiento: tipo,
      detalle,
      firma_paciente: firmaPaciente,
      firma_profesional: firmaProfesional,
      cedula_paciente: cedula,
      usuario,
      ts: new Date().toISOString()
    };

    evoluciones.unshift(item);
    renderEvoluciones();
    limpiarEvolucionForm();

    try {
      const payload = {
        evento: "agregar_evolucion",
        cedula: cedula,
        evolucion: item,
        fecha_envio: new Date().toISOString(),
        usuario_logueado: usuario
      };

      const resp = await fetch(WEBHOOK_GUARDAR_EVOLUCION, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) throw new Error("HTTP " + resp.status);
    } catch (err) {
      console.warn("‚ö†Ô∏è Evoluci√≥n guardada pero NO enviada:", err);
      alert("‚ö†Ô∏è Evoluci√≥n guardada, pero no se pudo enviar a n8n.");
    }
  }

  async function buscarEvolucionesPorCedula() {
    const cedula = (document.getElementById("cedula_paciente")?.value || "").trim();
    if (!cedula) { alert("Ingrese una c√©dula"); return; }

    _cedulaActual = cedula;
    evoluciones = [];
    renderEvoluciones();

    const url = WEBHOOK_BUSCAR_HISTORIA + "?cedula=" + encodeURIComponent(cedula);

    try {
      const resp = await fetch(url);
      const data = await resp.json();

      if (!data?.existe) {
        evoluciones = [];
        renderEvoluciones();
        alert("No existe historia cl√≠nica para este paciente (o no hay evoluciones).");
        return;
      }

      evoluciones = normalizarEvolucionesDeWebhook(data);
      renderEvoluciones();
      alert("Evoluciones cargadas con √©xito");
    } catch (err) {
      console.error(err);
      alert("Error consultando N8N");
    }
  }

  // ==============================
  // INIT
  // ==============================
  document.addEventListener("DOMContentLoaded", async () => {
    limpiarEvolucionForm();
    await cargarProcedimientosDesdeSupabase();
    await cargarProfesionalesDesdeSupabase();

    // ‚úÖ iniciar firmas
    _initFirma("firma_paciente");
    _initFirma("firma_profesional");
  });

  // Exponer
  window.cerrarSesion = cerrarSesion;
  window.irInicio = irInicio;

  window.buscarEvolucionesPorCedula = buscarEvolucionesPorCedula;
  window.agregarEvolucion = agregarEvolucion;
  window.eliminarEvolucion = eliminarEvolucion;
  window.limpiarEvolucionForm = limpiarEvolucionForm;

  window.limpiarFirma = limpiarFirma;
</script>
</body>
</html>



