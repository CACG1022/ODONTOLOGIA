<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Secci√≥n Evoluciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --ink:#19324d;
      --muted:#6b7a90;
      --bg:#f6f8fb;
      --card:#ffffff;
      --brand:#2a5d84;
      --gap:18px;
      --radius:14px;
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --line:#e7edf5;
      --input:#cbd5e1;
    }

    *{box-sizing:border-box}
    body{
      margin:0; padding:24px; font-family:system-ui,Segoe UI,Arial; color:var(--ink); background:var(--bg);
    }
    .container{ max-width:1100px; margin:0 auto; }
    h1{ margin:0 0 14px; font-size:28px; color:var(--brand); }
    h2{ font-size:18px; margin:0 0 14px; color:var(--brand); }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:22px;
      box-shadow:var(--shadow);
      margin-bottom:22px;
    }
    .legend{ font-weight:700; margin-bottom:8px; color:var(--brand); }

    .grid{ display:grid; gap:var(--gap); }
    .g-2{ grid-template-columns:1fr 1fr; }
    .g-3{ grid-template-columns:repeat(3,1fr); }
    .g-4{ grid-template-columns:repeat(4,1fr); }
    .full{ grid-column:1 / -1; }

    .ctrl{ display:flex; flex-direction:column; gap:8px; }
    .ctrl label{ font-size:13px; color:var(--muted); }

    input[type="text"],input[type="email"],input[type="tel"],
    input[type="number"],input[type="date"],input[type="time"], textarea{
      width:100%; border:1px solid var(--input); border-radius:10px; padding:12px;
      font-size:15px; background:#fff;
    }
    select {
      width:100%;
      border:1px solid var(--input);
      border-radius:10px;
      padding:12px;
      font-size:15px;
      background:#fff;
      cursor:pointer;
    }

    textarea{ min-height:120px; resize:vertical; }
    .inline{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:4px 10px;
      border:1px solid var(--line); border-radius:999px; background:#fff;
    }

    .checks{
      display:grid; gap:10px 18px;
      grid-template-columns:repeat(2,minmax(220px,1fr));
      padding-top:10px;
    }
    .check{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px dashed var(--line); border-radius:10px; background:#fafcff;
    }

    .rowline{ height:1px; background:var(--line); margin:12px 0; }

    @media (max-width:980px){
      .g-4{ grid-template-columns:1fr 1fr; }
      .g-3{ grid-template-columns:1fr 1fr; }
    }
    @media (max-width:680px){
      .g-2,.g-3,.g-4{ grid-template-columns:1fr; }
      .checks{ grid-template-columns:1fr; }
    }

    .btn{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      color:white;
      font-size:14px;
    }
    .btn-buscar{ background:#0D47A1; }
    .btn-agenda{ background:#009688; }

    .tabla-evo{
      width:100%;
      border-collapse:collapse;
    }
    .tabla-evo th,.tabla-evo td{
      padding:10px;
      border:1px solid var(--line);
      vertical-align:top;
    }
    .tabla-evo thead tr{
      background:#eef6ff;
    }

    .vwrap{ position: relative; display: flex; align-items: center; gap: 10px; }
    .vwrap .vfield{ flex: 1; }
    .vbtn{ width: 44px; min-width: 44px; height: 44px; border-radius: 10px; border: 1px solid var(--line); background: #F5F5F5; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 18px; color: transparent; }
    .vbtn.on{ background: #0D47A1; color: #fff; border-color: #0D47A1; }
  </style>

  <script>
    // ==============================
    // ‚úÖ DICTADO POR VOZ (Evoluciones: evo_detalle)
    // ==============================
    let _srEvo = null;
    let _srEvoOn = false;

    function _soportaDictado() {
      return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
    }

    function _appendEnTextarea(textarea, texto) {
      if (!textarea) return;

      const actual = textarea.value || "";
      const add = (texto || "").trim();
      if (!add) return;

      // Agregar sin reemplazar, con separador inteligente
      const sep = actual.trim().length ? (actual.endsWith("\n") ? "" : "\n") : "";
      textarea.value = actual + sep + add;

      // cursor al final
      textarea.focus();
      textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
    }

    function iniciarDictadoEvoDetalle() {
      const ta = document.getElementById("evo_detalle");
      const btn = document.getElementById("btnDictadoEvoDetalle");
      const hint = document.getElementById("dictadoHintEvo");

      if (!_soportaDictado()) {
        alert("‚ö†Ô∏è Tu navegador no soporta dictado por voz. Usa Chrome o Edge.");
        return;
      }

      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      _srEvo = new SR();

      _srEvo.lang = "es-CO";         // puedes cambiar a "es-ES", "es-MX", etc.
      _srEvo.continuous = true;      // seguir escuchando
      _srEvo.interimResults = true;  // mostrar parciales (no los agregamos hasta que sean finales)

      let bufferFinal = "";

      _srEvo.onstart = () => {
        _srEvoOn = true;
        if (btn) btn.classList.add("on");
        if (hint) hint.style.display = "block";
      };

      _srEvo.onresult = (event) => {
        let textoFinal = "";

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const res = event.results[i];
          const t = (res[0]?.transcript || "").trim();
          if (!t) continue;

          if (res.isFinal) {
            textoFinal += (textoFinal ? " " : "") + t;
          }
        }

        if (textoFinal) {
          // lo vamos acumulando y lo insertamos de una vez por cada "final"
          bufferFinal += (bufferFinal ? " " : "") + textoFinal;

          // ‚úÖ agrega al textarea SIN borrar lo que ya existe
          _appendEnTextarea(ta, bufferFinal);
          bufferFinal = "";
        }
      };

      _srEvo.onerror = (e) => {
        console.warn("Dictado error:", e);
        // Errores t√≠picos: "not-allowed" (sin permiso), "no-speech"
        if (e?.error === "not-allowed" || e?.error === "service-not-allowed") {
          alert("‚ö†Ô∏è Permiso de micr√≥fono denegado. Habil√≠talo en el navegador.");
          detenerDictadoEvoDetalle();
        }
      };

      _srEvo.onend = () => {
        // Si estaba encendido y el navegador lo corta, intentamos reanudar
        // (√∫til cuando continuous=true pero Chrome a veces lo detiene)
        if (_srEvoOn) {
          try { _srEvo.start(); } catch (err) {}
          return;
        }
        if (btn) btn.classList.remove("on");
        if (hint) hint.style.display = "none";
      };

      try {
        _srEvo.start();
      } catch (e) {
        console.warn("No se pudo iniciar dictado:", e);
      }
    }

    function detenerDictadoEvoDetalle() {
      const btn = document.getElementById("btnDictadoEvoDetalle");
      const hint = document.getElementById("dictadoHintEvo");

      _srEvoOn = false;

      if (_srEvo) {
        try { _srEvo.onend = null; } catch(e) {}
        try { _srEvo.stop(); } catch(e) {}
        _srEvo = null;
      }

      if (btn) btn.classList.remove("on");
      if (hint) hint.style.display = "none";
    }

    function toggleDictadoEvoDetalle() {
      if (_srEvoOn) detenerDictadoEvoDetalle();
      else iniciarDictadoEvoDetalle();
    }

    // opcional: detener dictado si cambias de p√°gina o cierras
    window.addEventListener("beforeunload", () => {
      try { detenerDictadoEvoDetalle(); } catch(e) {}
    });
    window.toggleDictadoEvoDetalle = toggleDictadoEvoDetalle;

    // ==============================
    // ‚úÖ EVOLUCIONES
    // ==============================
    let evoluciones = [];

    function _uuidFallback() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    function uuid() {
      try { return (crypto && crypto.randomUUID) ? crypto.randomUUID() : _uuidFallback(); }
      catch(e){ return _uuidFallback(); }
    }

    function _hoyISO() { return new Date().toISOString().slice(0, 10); }
    function _horaHHMM() {
      const d = new Date();
      return String(d.getHours()).padStart(2, "0") + ":" + String(d.getMinutes()).padStart(2, "0");
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function limpiarEvolucionForm() {
      const f = document.getElementById("evo_fecha");
      const h = document.getElementById("evo_hora");
      const p = document.getElementById("evo_profesional");
      const t = document.getElementById("evo_tipo");
      const d = document.getElementById("evo_detalle");

      if (f) f.value = _hoyISO();
      if (h) h.value = _horaHHMM();
      if (p) p.value = "";
      if (t) t.value = "";
      if (d) d.value = "";
    }

    function generarEvolucionId() { return uuid(); }

    async function agregarEvolucion() {
      const fecha = (document.getElementById("evo_fecha").value || _hoyISO()).trim();
      const hora = (document.getElementById("evo_hora").value || _horaHHMM()).trim();
      const profesional = document.getElementById("evo_profesional").value.trim();
      const tipo = document.getElementById("evo_tipo").value.trim();
      const detalle = document.getElementById("evo_detalle").value.trim();

      if (!profesional) { alert("‚ö†Ô∏è Debes ingresar el nombre del profesional."); return; }
      if (!tipo) { alert("‚ö†Ô∏è Debes ingresar el procedimiento."); return; }

      const usuario = localStorage.getItem("usuario_logueado") || "desconocido";
      const cedula = (
        document.getElementById("paciente_numdoc")?.value ||
        document.getElementById("buscar_cedula")?.value ||
        ""
      ).trim();

      if (!cedula) {
        alert("‚ö†Ô∏è Primero debes tener la c√©dula del paciente.");
        return;
      }

      const item = {
        id: generarEvolucionId(),
        fecha,
        hora,
        profesional,
        procedimiento: tipo,
        detalle,
        cedula_paciente: cedula,
        usuario,
        ts: new Date().toISOString()
      };

      evoluciones.unshift(item);
      renderEvoluciones();
      limpiarEvolucionForm();

      try {
        const url = "https://ftth-n8n2.pzveh5.easypanel.host/webhook/569051e4-4bdf-44e9-b0d3-34694d6077e9";
        const payload = {
          evento: "agregar_evolucion",
          cedula: cedula,
          evolucion: item,
          fecha_envio: new Date().toISOString(),
          usuario_logueado: usuario
        };

        const resp = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) throw new Error("HTTP " + resp.status);
      } catch (err) {
        console.warn("‚ö†Ô∏è Evoluci√≥n guardada pero NO enviada:", err);
        alert("‚ö†Ô∏è Evoluci√≥n guardada, pero no se pudo enviar a n8n.");
      }
    }

    function eliminarEvolucion(idx) {
      evoluciones.splice(idx, 1);
      renderEvoluciones();
    }

    function _soloFechaYYYYMMDD(valor) {
      if (!valor) return "";
      if (typeof valor === "string" && valor.includes("T")) return valor.split("T")[0];
      return String(valor);
    }
    function _soloHoraHHMM(valor) {
      if (!valor) return "";
      const s = String(valor);
      if (/^\d{2}:\d{2}:\d{2}/.test(s)) return s.slice(0,5);
      return s;
    }

    function renderEvoluciones() {
      const tbody = document.getElementById("tabla_evoluciones");
      if (!tbody) return;

      tbody.innerHTML = "";

      evoluciones.forEach((evo, idx) => {
        const tr = document.createElement("tr");

        const idEvo = evo.id_evolucion ?? evo["id-evolucion"] ?? evo.id ?? "";
        const fecha = _soloFechaYYYYMMDD(evo.fecha ?? evo.evo_fecha);
        const hora  = _soloHoraHHMM(evo.hora ?? evo.evo_hora);
        const profesional = evo.profesional ?? evo.evo_profesional ?? "";
        const procedimiento = evo.procedimiento ?? evo.evo_tipo ?? "";
        const detalle = evo.detalle ?? evo.evo_detalle ?? "";

        tr.innerHTML = `
          <td style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;">
            ${escapeHtml(idEvo)}
          </td>
          <td>${escapeHtml(fecha)}</td>
          <td>${escapeHtml(hora)}</td>
          <td>${escapeHtml(String(profesional).toUpperCase())}</td>
          <td>${escapeHtml(String(procedimiento).toUpperCase())}</td>
          <td style="white-space:pre-wrap;">${escapeHtml(detalle)}</td>
          <td style="display:flex; gap:8px; flex-wrap:wrap;">
            <button type="button" class="btn btn-buscar" style="padding:8px 10px; width:auto;" onclick="eliminarEvolucion(${idx})">
              Eliminar
            </button>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    // Exponer funciones usadas en HTML
    window.agregarEvolucion = agregarEvolucion;
    window.eliminarEvolucion = eliminarEvolucion;
    window.limpiarEvolucionForm = limpiarEvolucionForm;

    document.addEventListener("DOMContentLoaded", () => {
      limpiarEvolucionForm();
    });
  </script>
</head>

<body>
  <div class="container">

    <!-- ‚úÖ EVOLUCIONES -->
    <section class="card">
      <div class="legend">Evoluciones (procedimientos realizados)</div>

      <div class="grid g-3">
        <div class="ctrl">
          <label for="evo_fecha">Fecha</label>
          <input id="evo_fecha" type="date" disabled>
        </div>

        <div class="ctrl">
          <label for="evo_hora">Hora</label>
          <input id="evo_hora" type="time" readonly>
        </div>

        <div class="ctrl">
          <label for="evo_profesional">Profesional</label>
          <div class="inline" style="gap:10px;">
            <select id="evo_profesional">
              <option value="">Seleccione profesional...</option>
            </select>
          </div>
        </div>

        <div class="ctrl">
          <label for="evo_tipo">Procedimiento</label>
          <div class="inline" style="gap:10px;">
            <input id="evo_tipo" type="text" list="procedimientos_list_supabase" placeholder="Buscar o escribir procedimiento..." autocomplete="off" style="flex:1;" />
          </div>
        </div>

        <div class="ctrl full">
          <label for="evo_detalle">Detalle / Observaciones</label>

          <div class="vwrap">
            <div class="vfield">
              <textarea id="evo_detalle" placeholder="Descripci√≥n del procedimiento, piezas intervenidas, materiales, etc."></textarea>
            </div>

            <button
              id="btnDictadoEvoDetalle"
              type="button"
              class="vbtn"
              title="Dictar por voz"
              aria-label="Dictar por voz"
              onclick="toggleDictadoEvoDetalle()"
            >üé§</button>
          </div>

          <div id="dictadoHintEvo" style="font-size:12px; color:#6b7a90; margin-top:6px; display:none;">
            üéôÔ∏è Dictando... habla normal. (Se agregar√° al final del texto)
          </div>
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <button type="button" onclick="agregarEvolucion()" class="btn btn-agenda" style="max-width:260px;">Agregar evoluci√≥n</button>
        <button type="button" onclick="limpiarEvolucionForm()" class="btn btn-buscar" style="max-width:260px;">Limpiar</button>
      </div>

      <div class="rowline"></div>

      <div style="overflow:auto;">
        <table class="tabla-evo">
          <thead>
            <tr>
              <th>ID Evoluci√≥n</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Profesional</th>
              <th>Procedimiento</th>
              <th>Detalle</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla_evoluciones"></tbody>
        </table>
      </div>
    </section>

  </div>

  <!-- (Se mantiene tal cual lo ten√≠as: el datalist sigue referenciado por evo_tipo) -->
  <datalist id="procedimientos_list_supabase"></datalist>
</body>
</html>
