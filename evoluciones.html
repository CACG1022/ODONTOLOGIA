<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Evoluciones</title>

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --primary:#2563eb;
      --danger:#ef4444;
      --ok:#16a34a;
      --shadow: 0 10px 30px rgba(2,6,23,.08);
      --radius:16px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background:var(--bg);
      color:var(--text);
    }

    .container{
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 16px 40px;
    }

    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }

    .title{
      font-size: 22px;
      font-weight: 800;
      letter-spacing: -0.02em;
      margin:0;
    }

    .subtitle{
      margin:4px 0 0;
      color:var(--muted);
      font-size: 13px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      margin-top:14px;
    }

    .legend{
      font-weight:800;
      font-size:14px;
      margin-bottom:12px;
    }

    .grid{
      display:grid;
      gap:12px;
    }
    .g-2{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .g-3{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .full{ grid-column: 1 / -1; }

    @media (max-width: 900px){
      .g-3{ grid-template-columns: 1fr; }
      .g-2{ grid-template-columns: 1fr; }
    }

    .ctrl{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }

    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      background:#fff;
      outline:none;
    }
    textarea{ min-height: 110px; resize: vertical; }

    input:focus, select:focus, textarea:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    .row-actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .btn{
      border:1px solid transparent;
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition: .15s;
      user-select:none;
    }

    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }

    .btn-primary{ background: var(--primary); color:#fff; }
    .btn-ghost{ background:#fff; border-color: var(--line); color:var(--text); }
    .btn-danger{ background: var(--danger); color:#fff; }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 8px 10px;
      background:#fff;
      color:var(--muted);
      font-size: 12px;
      font-weight: 700;
    }

    .status{
      display:none;
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      font-size: 13px;
      color: var(--muted);
      background:#fff;
    }
    .status.ok{ border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.08); color: #166534; }
    .status.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.08); color: #7f1d1d; }

    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid var(--line);
      background:#fff;
    }

    thead th{
      text-align:left;
      font-size: 12px;
      color: var(--muted);
      padding: 10px 12px;
      border-bottom:1px solid var(--line);
      background: #f8fafc;
      font-weight: 900;
    }

    tbody td{
      padding: 10px 12px;
      border-bottom:1px solid var(--line);
      vertical-align: top;
      font-size: 13px;
      color: var(--text);
    }

    tbody tr:last-child td{ border-bottom:0; }

    .empty{
      padding: 14px;
      color: var(--muted);
      font-size: 13px;
    }

    .small{
      font-size:12px;
      color: var(--muted);
      margin-top:6px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 class="title">Evoluciones</h1>
        <p class="subtitle">Busca el paciente por cédula y registra evoluciones (profesional y procedimiento como listas desplegables).</p>
      </div>
      <div class="pill" id="pillPaciente">Paciente: <span id="pillCedula">—</span></div>
    </div>

    <!-- ✅ BUSCAR PACIENTE POR CÉDULA -->
    <section class="card">
      <div class="legend">Buscar paciente</div>

      <div class="grid g-3">
        <div class="ctrl">
          <label for="cedula_paciente_input">Cédula del paciente</label>
          <input id="cedula_paciente_input" type="text" placeholder="Digite la cédula..." autocomplete="off" />
          <div class="small">La cédula se guarda para que “Agregar evolución” quede asociada a este paciente.</div>
        </div>

        <div class="ctrl" style="justify-content:flex-end;">
          <label>&nbsp;</label>
          <button type="button" class="btn btn-primary" onclick="buscarPacientePorCedula()">
            Buscar
          </button>
        </div>

        <div class="ctrl full">
          <div id="paciente_info_box" style="display:none; padding:12px; border:1px solid var(--line); border-radius:12px; background:#fff;">
            <div style="font-weight:900; margin-bottom:6px;">Información del paciente</div>
            <div id="paciente_info_text" style="color:var(--muted);"></div>
          </div>
        </div>
      </div>

      <div id="statusBuscar" class="status"></div>
    </section>

    <!-- ✅ AGREGAR EVOLUCIÓN -->
    <section class="card">
      <div class="legend">Agregar evolución</div>

      <div class="grid g-3">
        <div class="ctrl">
          <label for="evo_fecha">Fecha</label>
          <input id="evo_fecha" type="date" />
        </div>

        <div class="ctrl">
          <label for="evo_hora">Hora</label>
          <input id="evo_hora" type="time" />
        </div>

        <div class="ctrl">
          <label for="evo_profesional">Profesional</label>
          <select id="evo_profesional">
            <option value="">Cargando profesionales...</option>
          </select>
          <div class="small">Si no ves la lista, revisa que la tabla <b>profesionales</b> tenga datos.</div>
        </div>

        <div class="ctrl">
          <label for="evo_procedimiento">Procedimiento</label>
          <select id="evo_procedimiento">
            <option value="">Cargando procedimientos...</option>
          </select>
          <div class="small">Si no ves la lista, revisa que la tabla <b>procedimientos</b> tenga datos.</div>
        </div>

        <div class="ctrl full">
          <label for="evo_detalle">Detalle</label>
          <textarea id="evo_detalle" placeholder="Escriba aquí la evolución..."></textarea>
        </div>

        <div class="ctrl full">
          <div class="row-actions">
            <button type="button" class="btn btn-ghost" onclick="limpiarFormulario()">Limpiar</button>
            <button type="button" class="btn btn-primary" onclick="agregarEvolucion()">Agregar evolución</button>
          </div>
        </div>
      </div>

      <div id="statusEvo" class="status"></div>
    </section>

    <!-- ✅ LISTADO -->
    <section class="card">
      <div class="legend">Listado de evoluciones</div>
      <div id="tablaWrap"></div>
    </section>
  </div>

  <!-- ✅ Supabase + App -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // =========================================================
    // ✅ CONFIGURACIÓN SUPABASE (PON TUS DATOS)
    // =========================================================
    const SUPABASE_URL = "TU_SUPABASE_URL";
    const SUPABASE_ANON_KEY = "TU_SUPABASE_ANON_KEY";

    // Exponer cliente global (para funciones llamadas desde HTML)
    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =========================================================
    // ✅ ESTADO
    // =========================================================
    let evoluciones = [];
    let profesionales = [];
    let procedimientos = [];

    // =========================================================
    // ✅ HELPERS
    // =========================================================
    function setStatus(id, msg, type = "ok") {
      const el = document.getElementById(id);
      if (!el) return;
      el.className = "status " + (type === "bad" ? "bad" : "ok");
      el.style.display = "block";
      el.textContent = msg;
    }

    function clearStatus(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = "none";
      el.textContent = "";
      el.className = "status";
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function setPacientePill(cedula) {
      const pill = document.getElementById("pillCedula");
      if (pill) pill.textContent = cedula || "—";
    }

    // =========================================================
    // ✅ CARGA DE LISTAS DESPLEGABLES (igualito: SELECT)
    // =========================================================
    async function cargarProfesionalesDesdeSupabase() {
      const sel = document.getElementById("evo_profesional");
      if (!sel) return;

      try {
        // Ajusta columnas si tu tabla tiene otro nombre:
        // esperamos: profesionales(id, nombre) o (id, nombre_completo)
        const { data, error } = await window.supabase
          .from("profesionales")
          .select("*")
          .order("nombre", { ascending: true });

        if (error) throw error;

        profesionales = data || [];

        sel.innerHTML = "";
        sel.appendChild(new Option("Seleccione...", ""));

        for (const p of profesionales) {
          const nombre = (p.nombre || p.nombre_completo || p.nombres || "").trim();
          const value = nombre || (p.id ?? "");
          sel.appendChild(new Option(nombre || String(value), value));
        }

        // Si quedó vacío
        if (profesionales.length === 0) {
          sel.innerHTML = "";
          sel.appendChild(new Option("No hay profesionales", ""));
        }
      } catch (e) {
        console.warn("Error cargando profesionales:", e);
        sel.innerHTML = "";
        sel.appendChild(new Option("Error cargando profesionales", ""));
      }
    }

    async function cargarProcedimientosDesdeSupabase() {
      const sel = document.getElementById("evo_procedimiento");
      if (!sel) return;

      try {
        // Ajusta columnas si tu tabla tiene otro nombre:
        // esperamos: procedimientos(id, nombre) o (id, procedimiento)
        const { data, error } = await window.supabase
          .from("procedimientos")
          .select("*")
          .order("nombre", { ascending: true });

        if (error) throw error;

        procedimientos = data || [];

        sel.innerHTML = "";
        sel.appendChild(new Option("Seleccione...", ""));

        for (const pr of procedimientos) {
          const nombre = (pr.nombre || pr.procedimiento || pr.descripcion || "").trim();
          const value = nombre || (pr.id ?? "");
          sel.appendChild(new Option(nombre || String(value), value));
        }

        if (procedimientos.length === 0) {
          sel.innerHTML = "";
          sel.appendChild(new Option("No hay procedimientos", ""));
        }
      } catch (e) {
        console.warn("Error cargando procedimientos:", e);
        sel.innerHTML = "";
        sel.appendChild(new Option("Error cargando procedimientos", ""));
      }
    }

    // =========================================================
    // ✅ PACIENTE POR CÉDULA + EVOLUCIONES
    // =========================================================
    async function buscarPacientePorCedula() {
      clearStatus("statusBuscar");

      const input = document.getElementById("cedula_paciente_input");
      const cedula = (input?.value || "").trim();

      if (!cedula) {
        setStatus("statusBuscar", "⚠️ Digita la cédula del paciente.", "bad");
        return;
      }

      // Guardar para que todo quede amarrado al paciente
      localStorage.setItem("cedula_paciente", cedula);
      setPacientePill(cedula);

      // UI paciente
      const box = document.getElementById("paciente_info_box");
      const text = document.getElementById("paciente_info_text");
      if (box) box.style.display = "none";
      if (text) text.innerHTML = "";

      // 1) Buscar paciente
      try {
        const { data, error } = await window.supabase
          .from("pacientes")
          .select("*")
          .eq("cedula", cedula)
          .maybeSingle();

        if (error) throw error;

        if (!data) {
          if (box) box.style.display = "block";
          if (text) text.innerHTML = `No se encontró paciente con cédula: <b>${escapeHtml(cedula)}</b>`;
          evoluciones = [];
          renderEvoluciones();
          setStatus("statusBuscar", "No se encontró el paciente. (Puedes revisar la tabla pacientes).", "bad");
          return;
        }

        const nombre = (data.nombre || data.nombres || "").trim();
        const apellidos = (data.apellidos || "").trim();
        const telefono = (data.telefono || data.celular || "").trim();
        const correo = (data.correo || data.email || "").trim();

        const nombreCompleto = `${nombre} ${apellidos}`.trim() || "(Sin nombre)";
        const partes = [
          `<b>Nombre:</b> ${escapeHtml(nombreCompleto)}`,
          `<b>Cédula:</b> ${escapeHtml(cedula)}`,
          telefono ? `<b>Tel:</b> ${escapeHtml(telefono)}` : "",
          correo ? `<b>Email:</b> ${escapeHtml(correo)}` : ""
        ].filter(Boolean);

        if (box) box.style.display = "block";
        if (text) text.innerHTML = partes.join(" &nbsp; | &nbsp; ");

        setStatus("statusBuscar", "✅ Paciente cargado correctamente.", "ok");
      } catch (e) {
        console.warn("Error buscando paciente:", e);
        setStatus("statusBuscar", "⚠️ No se pudo traer la información del paciente.", "bad");
        return;
      }

      // 2) Cargar evoluciones del paciente
      await cargarEvolucionesDePaciente(cedula);
    }

    async function cargarEvolucionesDePaciente(cedula) {
      try {
        const { data, error } = await window.supabase
          .from("evoluciones")
          .select("*")
          .eq("cedula_paciente", cedula)
          .order("fecha", { ascending: false })
          .order("hora", { ascending: false });

        if (error) throw error;

        evoluciones = (data || []).map(row => ({
          id: row.id ?? "",
          fecha: row.fecha ?? "",
          hora: row.hora ?? "",
          profesional: row.profesional ?? "",
          procedimiento: row.procedimiento ?? "",
          detalle: row.detalle ?? ""
        }));

        renderEvoluciones();
      } catch (e) {
        console.warn("Error cargando evoluciones:", e);
        evoluciones = [];
        renderEvoluciones();
      }
    }

    // =========================================================
    // ✅ AGREGAR EVOLUCIÓN (INSERT SUPABASE)
    // =========================================================
    async function agregarEvolucion() {
      clearStatus("statusEvo");

      const cedula = (localStorage.getItem("cedula_paciente") || "").trim();
      if (!cedula) {
        setStatus("statusEvo", "⚠️ Primero busca el paciente por cédula.", "bad");
        return;
      }

      const fecha = document.getElementById("evo_fecha")?.value || "";
      const hora = document.getElementById("evo_hora")?.value || "";
      const profesional = document.getElementById("evo_profesional")?.value || "";
      const procedimiento = document.getElementById("evo_procedimiento")?.value || "";
      const detalle = document.getElementById("evo_detalle")?.value?.trim() || "";

      if (!fecha || !hora || !profesional || !procedimiento || !detalle) {
        setStatus("statusEvo", "⚠️ Completa todos los campos antes de agregar la evolución.", "bad");
        return;
      }

      try {
        const payload = {
          cedula_paciente: cedula,
          fecha,
          hora,
          profesional,
          procedimiento,
          detalle
        };

        const { data, error } = await window.supabase
          .from("evoluciones")
          .insert(payload)
          .select("*")
          .single();

        if (error) throw error;

        // Refrescar listado (para quedar idéntico y ordenado)
        await cargarEvolucionesDePaciente(cedula);

        // Limpiar detalle
        document.getElementById("evo_detalle").value = "";

        setStatus("statusEvo", "✅ Evolución agregada correctamente.", "ok");
      } catch (e) {
        console.warn("Error agregando evolución:", e);
        setStatus("statusEvo", "⚠️ No se pudo agregar la evolución. Revisa Supabase (tabla evoluciones) y RLS.", "bad");
      }
    }

    // =========================================================
    // ✅ RENDER TABLA
    // =========================================================
    function renderEvoluciones() {
      const wrap = document.getElementById("tablaWrap");
      if (!wrap) return;

      if (!evoluciones || evoluciones.length === 0) {
        wrap.innerHTML = `<div class="empty">No hay evoluciones para mostrar.</div>`;
        return;
      }

      const rows = evoluciones.map(ev => `
        <tr>
          <td>${escapeHtml(ev.fecha)}</td>
          <td>${escapeHtml(ev.hora)}</td>
          <td>${escapeHtml(ev.profesional)}</td>
          <td>${escapeHtml(ev.procedimiento)}</td>
          <td>${escapeHtml(ev.detalle)}</td>
        </tr>
      `).join("");

      wrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th style="width:110px;">Fecha</th>
              <th style="width:90px;">Hora</th>
              <th style="width:170px;">Profesional</th>
              <th style="width:170px;">Procedimiento</th>
              <th>Detalle</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    // =========================================================
    // ✅ LIMPIAR FORMULARIO
    // =========================================================
    function limpiarFormulario() {
      clearStatus("statusEvo");
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const min = String(d.getMinutes()).padStart(2, "0");

      const fechaEl = document.getElementById("evo_fecha");
      const horaEl = document.getElementById("evo_hora");
      const profEl = document.getElementById("evo_profesional");
      const procEl = document.getElementById("evo_procedimiento");
      const detEl = document.getElementById("evo_detalle");

      if (fechaEl) fechaEl.value = `${yyyy}-${mm}-${dd}`;
      if (horaEl) horaEl.value = `${hh}:${min}`;
      if (profEl) profEl.value = "";
      if (procEl) procEl.value = "";
      if (detEl) detEl.value = "";
    }

    // =========================================================
    // ✅ INIT
    // =========================================================
    async function init() {
      // Set defaults fecha/hora
      limpiarFormulario();

      // Cargar listas desplegables (clave para que funcionen)
      await cargarProfesionalesDesdeSupabase();
      await cargarProcedimientosDesdeSupabase();

      // Cargar paciente guardado (si existe)
      const cedulaGuardada = (localStorage.getItem("cedula_paciente") || "").trim();
      if (cedulaGuardada) {
        document.getElementById("cedula_paciente_input").value = cedulaGuardada;
        setPacientePill(cedulaGuardada);
        await cargarEvolucionesDePaciente(cedulaGuardada);
      } else {
        setPacientePill("");
        renderEvoluciones();
      }
    }

    // Exponer funciones al HTML
    window.buscarPacientePorCedula = buscarPacientePorCedula;
    window.agregarEvolucion = agregarEvolucion;
    window.limpiarFormulario = limpiarFormulario;

    init();
  </script>
</body>
</html>


