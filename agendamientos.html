<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agendamiento Avanzado - Cl√≠nica Odontol√≥gica</title>

  <!-- ‚úÖ FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ‚úÖ Supabase (tus credenciales)
    const supabase = createClient(
      "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
    );

    const LOGIN_URL = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
    const HOME_URL  = "https://cacg1022.github.io/ODONTOLOGIA/index.html";

    // ‚úÖ Tablas en espa√±ol
    const TABLA_CITAS = "citas";
    const TABLA_PROFESIONALES = "profesionales";

    // ‚úÖ Lista de especialidades del procedimiento
    const ESPECIALIDADES = [
      "Odontologia General",
      "Rehabilitacion Oral",
      "Endodoncia",
      "Periodoncia",
      "Ortodoncia",
      "Cirugia",
      "Odontopediatr√≠a"
    ];

    // =========================
    // Helpers UI
    // =========================
    const $ = (id) => document.getElementById(id);

    function toast(msg, type="info"){
      const el = $("toast");
      if(!el) return alert(msg);
      el.textContent = msg;
      el.className = "toast show " + type;
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(()=> el.className = "toast", 2600);
    }

    function setLoading(isLoading){
      const b = $("loading");
      if(!b) return;
      b.style.display = isLoading ? "flex" : "none";
    }

    function toLocalInputValue(dateObj){
      const pad = (n)=> String(n).padStart(2,"0");
      const y = dateObj.getFullYear();
      const m = pad(dateObj.getMonth()+1);
      const d = pad(dateObj.getDate());
      const hh = pad(dateObj.getHours());
      const mm = pad(dateObj.getMinutes());
      return `${y}-${m}-${d}T${hh}:${mm}`;
    }

    function toISOFromLocalInput(val){
      const d = new Date(val);
      if (isNaN(d.getTime())) return null;
      return d.toISOString();
    }

    function normalizeText(t){ return (t || "").trim(); }

    function colorPorEstado(estado){
      const s = String(estado || "").toLowerCase();
      if (s === "confirmada") return "#2563eb";
      if (s === "atendida") return "#16a34a";
      if (s === "cancelada") return "#ef4444";
      return "#f59e0b"; // programada
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function pad2(n){ return String(n).padStart(2,"0"); }

    function formatHoraLocal(dateObj){
      return `${pad2(dateObj.getHours())}:${pad2(dateObj.getMinutes())}`;
    }

    function duracionMinutos(startISO, endISO){
      const s = new Date(startISO);
      const e = new Date(endISO);
      const ms = e - s;
      return Math.max(0, Math.round(ms / 60000));
    }

    function formatoDuracion(mins){
      if (mins < 60) return `${mins} min`;
      const h = Math.floor(mins/60);
      const m = mins % 60;
      return m === 0 ? `${h} h` : `${h} h ${m} min`;
    }

    // =========================
    // Auth + Roles
    // =========================
    async function cargarRolDesdeProfiles(userId){
      try {
        const { data, error } = await supabase
          .from("profiles")
          .select("role")
          .eq("id", userId)
          .single();

        if (error) return null;
        return data?.role || null;
      } catch {
        return null;
      }
    }

    async function verificarSesionYPermisos(){
      const { data: { session } } = await supabase.auth.getSession();
      if (!session){
        window.location.href = LOGIN_URL;
        return { ok:false };
      }

      $("user-email").textContent = session.user?.email || "Usuario autenticado";

      const role = await cargarRolDesdeProfiles(session.user.id);
      $("user-role").textContent = role ? `Rol: ${role}` : "Rol: (sin rol)";

      const r = String(role || "").toLowerCase().trim();
      const allowed = (r === "admin" || r === "auxiliar");

      if (!allowed){
        $("blocked").style.display = "block";
        $("app").style.display = "none";
        return { ok:false, session, role };
      }

      $("blocked").style.display = "none";
      $("app").style.display = "grid";

      return { ok:true, session, role };
    }

    supabase.auth.onAuthStateChange((_event, session) => {
      if (!session) window.location.href = LOGIN_URL;
    });

    window.cerrarSesion = async () => {
      try { await supabase.auth.signOut(); } catch(e) {}
      try { localStorage.removeItem("usuario_logueado"); } catch(e) {}
      window.location.href = LOGIN_URL;
    };

    // =========================
    // Profesionales (cargar select)
    // =========================
    let profesionalesCache = []; // [{id, nombre, activo, especialidad, profesion}]
    async function cargarProfesionales(){
      const { data, error } = await supabase
        .from(TABLA_PROFESIONALES)
        .select("id, nombre, activo, profesion, especialidad")
        .order("nombre", { ascending: true });

      if (error) throw new Error(error.message);

      profesionalesCache = (data || []).filter(p => p.activo === true);

      // llenar select del modal
      const sel = $("profesional_id");
      sel.innerHTML = `<option value="">-- Selecciona --</option>` +
        profesionalesCache.map(p => `<option value="${p.id}">${escapeHtml(p.nombre)}</option>`).join("");

      // llenar filtro por profesional
      const filt = $("filterProfessional");
      filt.innerHTML = `<option value="">Todos</option>` +
        profesionalesCache.map(p => `<option value="${p.id}">${escapeHtml(p.nombre)}</option>`).join("");
    }

    function getNombreProfesionalPorId(id){
      return profesionalesCache.find(p => p.id === id)?.nombre || "";
    }

    // =========================
    // Especialidades (cargar select)
    // =========================
    function cargarEspecialidades(){
      const sel = $("especialidad");
      sel.innerHTML =
        `<option value="">-- Selecciona --</option>` +
        ESPECIALIDADES.map(e => `<option value="${escapeHtml(e)}">${escapeHtml(e)}</option>`).join("");

      const filt = $("filterEspecialidad");
      filt.innerHTML =
        `<option value="todos">Todas</option>` +
        ESPECIALIDADES.map(e => `<option value="${escapeHtml(e)}">${escapeHtml(e)}</option>`).join("");
    }

    // =========================
    // T√≠tulo autom√°tico (formato solicitado)
    // 1) Rango de hora, Duraci√≥n
    // 2) Nombre del Paciente, C√©dula
    // 3) Especialidad
    // =========================
    function construirTituloAutomatico({ inicioISO, finISO, nombrePaciente, cedulaPaciente, especialidad }){
      const s = new Date(inicioISO);
      const e = new Date(finISO);
      const rango = `${formatHoraLocal(s)} - ${formatHoraLocal(e)}`;
      const mins = duracionMinutos(inicioISO, finISO);
      const dur = formatoDuracion(mins);

      const np = normalizeText(nombrePaciente) || "Paciente";
      const cc = normalizeText(cedulaPaciente) || "Sin c√©dula";
      const esp = normalizeText(especialidad) || "Sin especialidad";

      // FullCalendar dibuja el title como una l√≠nea; soporta saltos de l√≠nea en lista,
      // y en timeGrid a veces se recorta. Igual lo ponemos como pidi√≥.
      return `${rango}, ${dur}\n${np}, ${cc}\n${esp}`;
    }

    // =========================
    // CRUD Supabase (citas)
    // =========================
    function rowToEvent(row){
      const start = new Date(row.inicio);
      const end   = new Date(row.fin);

      const estado = row.estado || "programada";

      // Si por alguna raz√≥n titulo est√° vac√≠o, lo regeneramos con el formato requerido
      const titulo = normalizeText(row.titulo)
        ? row.titulo
        : construirTituloAutomatico({
            inicioISO: row.inicio,
            finISO: row.fin,
            nombrePaciente: row.nombre_paciente,
            cedulaPaciente: row.documento_paciente,
            especialidad: row.especialidad
          });

      return {
        id: row.id,
        title: titulo,
        start: row.inicio,
        end: row.fin,
        backgroundColor: colorPorEstado(estado),
        borderColor: colorPorEstado(estado),
        extendedProps: {
          nombre_paciente: row.nombre_paciente || "",
          documento_paciente: row.documento_paciente || "",
          telefono_paciente: row.telefono_paciente || "",
          profesional_id: row.profesional_id || "",
          nombre_profesional: row.nombre_profesional || "",
          especialidad: row.especialidad || "",
          estado: estado,
          notas: row.notas || "",
          inicio_local: toLocalInputValue(start),
          fin_local: toLocalInputValue(end),
        }
      };
    }

    async function fetchCitas(rangeStartISO, rangeEndISO, profesionalIdFiltro, estadoFiltro, especialidadFiltro){
      let q = supabase
        .from(TABLA_CITAS)
        .select("*")
        .gte("inicio", rangeStartISO)
        .lt("inicio", rangeEndISO)
        .order("inicio", { ascending: true });

      if (profesionalIdFiltro) q = q.eq("profesional_id", profesionalIdFiltro);

      if (estadoFiltro && estadoFiltro !== "todos") {
        q = q.eq("estado", estadoFiltro);
      }

      if (especialidadFiltro && especialidadFiltro !== "todos") {
        q = q.eq("especialidad", especialidadFiltro);
      }

      const { data, error } = await q;
      if (error) throw new Error(error.message);
      return data || [];
    }

    async function crearCita(row){
      const { data, error } = await supabase
        .from(TABLA_CITAS)
        .insert(row)
        .select("*")
        .single();

      if (error) throw new Error(error.message);
      return data;
    }

    async function actualizarCita(id, row){
      const { data, error } = await supabase
        .from(TABLA_CITAS)
        .update(row)
        .eq("id", id)
        .select("*")
        .single();

      if (error) throw new Error(error.message);
      return data;
    }

    async function eliminarCita(id){
      const { error } = await supabase
        .from(TABLA_CITAS)
        .delete()
        .eq("id", id);

      if (error) throw new Error(error.message);
      return true;
    }

    // =========================
    // Modal
    // =========================
    function openModal(mode, payload){
      $("modal").classList.add("open");
      $("modal").setAttribute("aria-hidden","false");
      $("modalTitle").textContent = mode === "edit" ? "Editar cita" : "Nueva cita";

      $("citaId").value = payload?.id || "";

      // En este flujo el t√≠tulo es autom√°tico. Igual dejamos un input visible SOLO lectura
      // para que el usuario vea c√≥mo va quedando.
      $("titulo").value = payload?.titulo || "";

      $("nombre_paciente").value = payload?.nombre_paciente || "";
      $("documento_paciente").value = payload?.documento_paciente || "";
      $("telefono_paciente").value = payload?.telefono_paciente || "";
      $("profesional_id").value = payload?.profesional_id || "";
      $("especialidad").value = payload?.especialidad || "";
      $("estado").value = payload?.estado || "programada";
      $("notas").value = payload?.notas || "";
      $("inicio").value = payload?.inicio_local || "";
      $("fin").value = payload?.fin_local || "";

      // Si viene sin t√≠tulo, lo calculamos
      if (!normalizeText($("titulo").value) && payload?.inicio_local && payload?.fin_local){
        const inicioISO = toISOFromLocalInput(payload.inicio_local);
        const finISO = toISOFromLocalInput(payload.fin_local);
        if (inicioISO && finISO){
          $("titulo").value = construirTituloAutomatico({
            inicioISO,
            finISO,
            nombrePaciente: $("nombre_paciente").value,
            cedulaPaciente: $("documento_paciente").value,
            especialidad: $("especialidad").value
          });
        }
      }

      $("btnDelete").style.display = mode === "edit" ? "inline-flex" : "none";
      $("btnSave").textContent = mode === "edit" ? "Guardar cambios" : "Crear cita";
    }

    function closeModal(){
      $("modal").classList.remove("open");
      $("modal").setAttribute("aria-hidden","true");
    }

    function actualizarPreviewTitulo(){
      const inicioLocal = $("inicio").value;
      const finLocal = $("fin").value;
      if (!inicioLocal || !finLocal) return;

      const inicioISO = toISOFromLocalInput(inicioLocal);
      const finISO = toISOFromLocalInput(finLocal);
      if (!inicioISO || !finISO) return;

      $("titulo").value = construirTituloAutomatico({
        inicioISO,
        finISO,
        nombrePaciente: $("nombre_paciente").value,
        cedulaPaciente: $("documento_paciente").value,
        especialidad: $("especialidad").value
      });
    }

    // =========================
    // FullCalendar
    // =========================
    let calendar;
    let currentSession = null;

    function getFilters(){
      return {
        profesional_id: $("filterProfessional").value || "",
        estado: $("filterStatus").value || "todos",
        especialidad: $("filterEspecialidad").value || "todos"
      };
    }

    async function reloadCalendarEvents(){
      if (!calendar) return;
      setLoading(true);
      try{
        const view = calendar.view;
        const rangeStart = view.activeStart.toISOString();
        const rangeEnd   = view.activeEnd.toISOString();

        const { profesional_id, estado, especialidad } = getFilters();

        const rows = await fetchCitas(rangeStart, rangeEnd, profesional_id, estado, especialidad);
        const events = rows.map(rowToEvent);

        calendar.removeAllEvents();
        events.forEach(e => calendar.addEvent(e));

        $("rangeLabel").textContent = view.title || new Date().toLocaleDateString("es-CO");
      } catch(e){
        console.error(e);
        toast("Error cargando agenda: " + e.message, "error");
      } finally {
        setLoading(false);
      }
    }

    async function initCalendar(){
      calendar = new FullCalendar.Calendar($("calendar"), {
        locale: "es",
        timeZone: "local",
        initialView: "timeGridWeek",
        nowIndicator: true,
        selectable: true,
        editable: true,
        eventResizableFromStart: true,
        dayMaxEvents: true,
        allDaySlot: false,
        slotMinTime: "07:00:00",
        slotMaxTime: "20:00:00",
        slotDuration: "00:15:00",
        headerToolbar: false,

        select: (info) => {
          openModal("create", {
            inicio_local: toLocalInputValue(info.start),
            fin_local: toLocalInputValue(info.end),
            estado: "programada"
          });
        },

        dateClick: (info) => {
          const start = info.date;
          const end = new Date(start.getTime() + 30*60*1000);
          openModal("create", {
            inicio_local: toLocalInputValue(start),
            fin_local: toLocalInputValue(end),
            estado: "programada"
          });
        },

        eventClick: (info) => {
          const ev = info.event;
          openModal("edit", {
            id: ev.id,
            titulo: ev.title,
            nombre_paciente: ev.extendedProps.nombre_paciente,
            documento_paciente: ev.extendedProps.documento_paciente,
            telefono_paciente: ev.extendedProps.telefono_paciente,
            profesional_id: ev.extendedProps.profesional_id,
            especialidad: ev.extendedProps.especialidad,
            estado: ev.extendedProps.estado,
            notas: ev.extendedProps.notas,
            inicio_local: ev.extendedProps.inicio_local || toLocalInputValue(ev.start),
            fin_local: ev.extendedProps.fin_local || toLocalInputValue(ev.end),
          });
        },

        eventDrop: async (info) => {
          try{
            setLoading(true);
            const id = info.event.id;

            const inicioISO = info.event.start.toISOString();
            const finISO = info.event.end.toISOString();

            // Recalcular t√≠tulo autom√°tico con los props existentes
            const nuevoTitulo = construirTituloAutomatico({
              inicioISO,
              finISO,
              nombrePaciente: info.event.extendedProps.nombre_paciente,
              cedulaPaciente: info.event.extendedProps.documento_paciente,
              especialidad: info.event.extendedProps.especialidad
            });

            const row = {
              inicio: inicioISO,
              fin: finISO,
              titulo: nuevoTitulo
            };

            await actualizarCita(id, row);

            info.event.setProp("title", nuevoTitulo);
            info.event.setExtendedProp("inicio_local", toLocalInputValue(info.event.start));
            info.event.setExtendedProp("fin_local", toLocalInputValue(info.event.end));

            toast("Cita reprogramada.", "ok");
          } catch(e){
            console.error(e);
            info.revert();
            toast("Error al mover: " + e.message, "error");
          } finally {
            setLoading(false);
          }
        },

        eventResize: async (info) => {
          try{
            setLoading(true);
            const id = info.event.id;

            const inicioISO = info.event.start.toISOString();
            const finISO = info.event.end.toISOString();

            const nuevoTitulo = construirTituloAutomatico({
              inicioISO,
              finISO,
              nombrePaciente: info.event.extendedProps.nombre_paciente,
              cedulaPaciente: info.event.extendedProps.documento_paciente,
              especialidad: info.event.extendedProps.especialidad
            });

            const row = {
              inicio: inicioISO,
              fin: finISO,
              titulo: nuevoTitulo
            };

            await actualizarCita(id, row);

            info.event.setProp("title", nuevoTitulo);
            info.event.setExtendedProp("inicio_local", toLocalInputValue(info.event.start));
            info.event.setExtendedProp("fin_local", toLocalInputValue(info.event.end));

            toast("Duraci√≥n actualizada.", "ok");
          } catch(e){
            console.error(e);
            info.revert();
            toast("Error al redimensionar: " + e.message, "error");
          } finally {
            setLoading(false);
          }
        },

        datesSet: async () => {
          await reloadCalendarEvents();
        }
      });

      calendar.render();
      await reloadCalendarEvents();
    }

    // =========================
    // UI
    // =========================
    function wireButtons(){
      $("btnDay").addEventListener("click", ()=> calendar.changeView("timeGridDay"));
      $("btnWeek").addEventListener("click", ()=> calendar.changeView("timeGridWeek"));
      $("btnMonth").addEventListener("click", ()=> calendar.changeView("dayGridMonth"));
      $("btnToday").addEventListener("click", ()=> calendar.today());
      $("btnPrev").addEventListener("click", ()=> calendar.prev());
      $("btnNext").addEventListener("click", ()=> calendar.next());
      $("btnHome").addEventListener("click", ()=> window.location.href = HOME_URL);

      $("filterProfessional").addEventListener("change", ()=> reloadCalendarEvents());
      $("filterStatus").addEventListener("change", ()=> reloadCalendarEvents());
      $("filterEspecialidad").addEventListener("change", ()=> reloadCalendarEvents());

      $("btnNew").addEventListener("click", () => {
        const start = new Date();
        start.setSeconds(0,0);
        const m = start.getMinutes();
        const rounded = Math.ceil(m/15)*15;
        start.setMinutes(rounded);
        const end = new Date(start.getTime() + 30*60*1000);

        openModal("create", {
          inicio_local: toLocalInputValue(start),
          fin_local: toLocalInputValue(end),
          estado: "programada"
        });
      });

      $("btnClose").addEventListener("click", closeModal);
      $("modalBackdrop").addEventListener("click", closeModal);
      window.addEventListener("keydown", (e)=> { if (e.key === "Escape") closeModal(); });

      $("btnSave").addEventListener("click", onSave);
      $("btnDelete").addEventListener("click", onDelete);

      // Recalcular t√≠tulo en vivo
      ["nombre_paciente","documento_paciente","especialidad","inicio","fin"].forEach(id=>{
        $(id).addEventListener("input", actualizarPreviewTitulo);
        $(id).addEventListener("change", actualizarPreviewTitulo);
      });
    }

    async function onSave(){
      try{
        setLoading(true);

        const id = $("citaId").value.trim();

        const profesionalId = $("profesional_id").value;
        const especialidad = $("especialidad").value;

        const inicioLocal = $("inicio").value;
        const finLocal = $("fin").value;

        if (!profesionalId){
          toast("Selecciona un profesional.", "warn");
          return;
        }

        if (!especialidad){
          toast("Selecciona la especialidad del procedimiento.", "warn");
          return;
        }

        if (!inicioLocal || !finLocal){
          toast("Selecciona inicio y fin.", "warn");
          return;
        }

        const inicioISO = toISOFromLocalInput(inicioLocal);
        const finISO = toISOFromLocalInput(finLocal);

        if (!inicioISO || !finISO){
          toast("Fecha/hora inv√°lida.", "warn");
          return;
        }

        const inicioD = new Date(inicioISO);
        const finD = new Date(finISO);
        if (finD <= inicioD){
          toast("La hora final debe ser mayor que la inicial.", "warn");
          return;
        }

        // T√≠tulo autom√°tico requerido (siempre)
        const tituloAuto = construirTituloAutomatico({
          inicioISO,
          finISO,
          nombrePaciente: $("nombre_paciente").value,
          cedulaPaciente: $("documento_paciente").value,
          especialidad: especialidad
        });

        $("titulo").value = tituloAuto;

        const row = {
          usuario_id: currentSession.user.id,
          profesional_id: profesionalId,

          nombre_paciente: normalizeText($("nombre_paciente").value),
          documento_paciente: normalizeText($("documento_paciente").value),
          telefono_paciente: normalizeText($("telefono_paciente").value),

          especialidad: normalizeText(especialidad),

          titulo: tituloAuto,

          estado: $("estado").value || "programada",
          notas: normalizeText($("notas").value),

          inicio: inicioISO,
          fin: finISO,

          // cache (el trigger lo llena, lo enviamos tambi√©n)
          nombre_profesional: getNombreProfesionalPorId(profesionalId)
        };

        if (id){
          await actualizarCita(id, row);
          toast("Cita actualizada.", "ok");
        } else {
          await crearCita(row);
          toast("Cita creada.", "ok");
        }

        closeModal();
        await reloadCalendarEvents();

      } catch(e){
        console.error(e);
        toast("Error guardando: " + e.message, "error");
      } finally {
        setLoading(false);
      }
    }

    async function onDelete(){
      const id = $("citaId").value.trim();
      if (!id) return;

      const ok = confirm("¬øEliminar esta cita definitivamente?");
      if (!ok) return;

      try{
        setLoading(true);
        await eliminarCita(id);
        closeModal();
        toast("Cita eliminada.", "ok");
        await reloadCalendarEvents();
      } catch(e){
        console.error(e);
        toast("Error eliminando: " + e.message, "error");
      } finally {
        setLoading(false);
      }
    }

    // =========================
    // Init
    // =========================
    (async function main(){
      const res = await verificarSesionYPermisos();
      if (!res.ok) return;

      currentSession = res.session;

      $("today").textContent = new Date().toLocaleDateString("es-CO", {
        year:"numeric", month:"long", day:"2-digit"
      });

      wireButtons();
      cargarEspecialidades();
      await cargarProfesionales();
      await initCalendar();
    })();
  </script>

  <style>
    :root{
      --bg: #f5f7fb;
      --surface: #ffffff;
      --surface-2: #fbfcff;
      --border: rgba(15, 23, 42, 0.10);
      --text: #0f172a;
      --muted: #64748b;
      --accent: #2563eb;
      --accent-2: #1d4ed8;
      --shadow: 0 20px 45px rgba(15,23,42,.10);
      --shadow-2: 0 10px 20px rgba(15,23,42,.08);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 500px at 25% 15%, rgba(37, 99, 235, .08), transparent 55%),
        radial-gradient(700px 420px at 85% 75%, rgba(2, 132, 199, .07), transparent 60%),
        linear-gradient(180deg, #ffffff, var(--bg));
      padding: 22px 14px;
    }

    .shell{
      width: min(1200px, 100%);
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .topbar{
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-2);
      border-radius: var(--radius);
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap: 3px;
    }

    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
    }

    .brand .sub{
      font-size: 12.5px;
      color: var(--muted);
    }

    .userbox{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 2px;
      font-size: 12.5px;
      color: var(--muted);
    }

    .userbox strong{ color: var(--text); font-weight: 700; }

    .actions{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn{
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 650;
      font-size: 13px;
      box-shadow: 0 6px 14px rgba(15,23,42,.06);
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }

    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(37,99,235,.35);
      background: #fff;
    }

    .btn.primary{
      background: var(--accent);
      border-color: rgba(37,99,235,.4);
      color:#fff;
    }
    .btn.primary:hover{ background: var(--accent-2); }

    .btn.danger{
      background: rgba(239,68,68,.08);
      border-color: rgba(239,68,68,.25);
      color: #991b1b;
    }

    .btn.link{
      background: transparent;
      box-shadow: none;
    }

    .grid{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 14px;
      align-items: start;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .userbox{ align-items:flex-start; }
      .actions{ justify-content:flex-start; }
    }

    .panel{
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-2);
      border-radius: var(--radius);
      padding: 14px;
    }

    .panel h2{
      margin:0 0 10px 0;
      font-size: 14px;
      letter-spacing: .2px;
    }

    .muted{
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.45;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin-top: 10px;
    }

    label{
      font-size: 12.5px;
      color: var(--muted);
      font-weight: 650;
    }

    input, select, textarea{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 11px;
      font-size: 13.5px;
      outline: none;
      background: #fff;
      color: var(--text);
    }

    textarea{ min-height: 86px; resize: vertical; }

    .toolbarRow{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content: space-between;
      margin-top: 10px;
    }

    .toolbarLeft, .toolbarRight{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .range{
      font-size: 13px;
      color: var(--muted);
      font-weight: 650;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface-2);
    }

    .calendarWrap{
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 12px;
      overflow:hidden;
    }

    #calendar{
      background: #fff;
      border-radius: 12px;
      padding: 6px;
    }

    .modal{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 50;
    }
    .modal.open{ display:flex; }

    .backdrop{
      position:absolute;
      inset:0;
      background: rgba(2,6,23,.55);
    }

    .modalCard{
      position: relative;
      width: min(820px, 100%);
      background: var(--surface);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 18px;
      box-shadow: 0 30px 90px rgba(0,0,0,.35);
      padding: 14px;
      z-index: 2;
    }

    .modalHead{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 6px 4px 10px 4px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }

    .modalHead h3{
      margin:0;
      font-size: 15px;
      letter-spacing: .2px;
    }

    .modalGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 780px){
      .modalGrid{ grid-template-columns: 1fr; }
    }

    .modalFoot{
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .loading{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(4px);
      z-index: 60;
    }
    .spinner{
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: 4px solid rgba(37,99,235,.20);
      border-top-color: rgba(37,99,235,.95);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #0f172a;
      color: #fff;
      font-weight: 650;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease;
      z-index: 70;
      max-width: min(720px, 92vw);
      text-align:center;
      white-space: pre-line; /* para que el toast soporte saltos de l√≠nea */
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }
    .toast.ok{ background: rgba(22,163,74,.95); }
    .toast.warn{ background: rgba(245,158,11,.95); color:#111827; }
    .toast.error{ background: rgba(239,68,68,.95); }

    .blocked{
      display:none;
      background: rgba(239,68,68,.08);
      border: 1px solid rgba(239,68,68,.20);
      border-radius: var(--radius);
      padding: 16px;
      color: #991b1b;
      box-shadow: var(--shadow-2);
    }
    .blocked strong{ color:#7f1d1d; }

    /* Preview del t√≠tulo en el modal */
    .previewTitulo{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 11px;
      background: var(--surface-2);
      font-size: 13px;
      color: var(--text);
      white-space: pre-line;
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div class="shell">

    <div class="topbar">
      <div class="brand">
        <h1>Agendamiento Avanzado</h1>
        <div class="sub">Hoy: <span id="today"></span> ¬∑ Arrastra para mover ¬∑ Estira para cambiar duraci√≥n</div>
      </div>

      <div class="actions">
        <button class="btn link" id="btnHome" type="button">üè† Inicio</button>
        <button class="btn" id="btnNew" type="button">‚ûï Nueva cita</button>
        <button class="btn danger" onclick="cerrarSesion()" type="button">Cerrar sesi√≥n</button>
        <div class="userbox">
          <div><strong id="user-email">usuario</strong></div>
          <div id="user-role">Rol: ...</div>
        </div>
      </div>
    </div>

    <div id="blocked" class="blocked">
      <strong>Acceso restringido.</strong> Esta p√°gina solo puede ser usada por roles <b>admin</b> y <b>auxiliar</b>.
    </div>

    <div id="app" class="grid" style="display:none;">
      <!-- Sidebar -->
      <div class="panel">
        <h2>Filtros</h2>
        <div class="muted">Filtra por profesional, estado y especialidad.</div>

        <div class="field">
          <label for="filterProfessional">Profesional</label>
          <select id="filterProfessional">
            <option value="">Cargando...</option>
          </select>
        </div>

        <div class="field">
          <label for="filterStatus">Estado</label>
          <select id="filterStatus">
            <option value="todos">Todos</option>
            <option value="programada">Programada</option>
            <option value="confirmada">Confirmada</option>
            <option value="atendida">Atendida</option>
            <option value="cancelada">Cancelada</option>
          </select>
        </div>

        <div class="field">
          <label for="filterEspecialidad">Especialidad</label>
          <select id="filterEspecialidad">
            <option value="todos">Cargando...</option>
          </select>
        </div>

        <div class="toolbarRow">
          <div class="toolbarLeft">
            <div class="range" id="rangeLabel">Agenda</div>
          </div>
          <div class="toolbarRight">
            <button class="btn" id="btnPrev" type="button">‚óÄ</button>
            <button class="btn" id="btnToday" type="button">Hoy</button>
            <button class="btn" id="btnNext" type="button">‚ñ∂</button>
          </div>
        </div>

        <div class="toolbarRow">
          <div class="toolbarLeft">
            <button class="btn" id="btnDay" type="button">D√≠a</button>
            <button class="btn" id="btnWeek" type="button">Semana</button>
            <button class="btn" id="btnMonth" type="button">Mes</button>
          </div>
        </div>

        <div class="field">
          <div class="muted">
            <b>Formato del t√≠tulo (autom√°tico):</b><br/>
            ‚Ä¢ Rango de hora, Duraci√≥n<br/>
            ‚Ä¢ Nombre del paciente, C√©dula<br/>
            ‚Ä¢ Especialidad
          </div>
        </div>
      </div>

      <!-- Calendar -->
      <div class="calendarWrap">
        <div id="calendar"></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div id="modalBackdrop" class="backdrop"></div>

    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHead">
        <h3 id="modalTitle">Nueva cita</h3>
        <button class="btn" id="btnClose" type="button">‚úï</button>
      </div>

      <input type="hidden" id="citaId" />

      <div class="modalGrid">
        <div class="field">
          <label for="nombre_paciente">Paciente (Nombre)</label>
          <input id="nombre_paciente" type="text" placeholder="Nombre del paciente" />
        </div>

        <div class="field">
          <label for="documento_paciente">C√©dula / Documento</label>
          <input id="documento_paciente" type="text" placeholder="CC / TI / CE" />
        </div>

        <div class="field">
          <label for="telefono_paciente">Tel√©fono</label>
          <input id="telefono_paciente" type="text" placeholder="Tel√©fono del paciente" />
        </div>

        <div class="field">
          <label for="profesional_id">Profesional</label>
          <select id="profesional_id">
            <option value="">Cargando...</option>
          </select>
        </div>

        <div class="field">
          <label for="especialidad">Especialidad del procedimiento</label>
          <select id="especialidad">
            <option value="">Cargando...</option>
          </select>
        </div>

        <div class="field">
          <label for="estado">Estado</label>
          <select id="estado">
            <option value="programada">Programada</option>
            <option value="confirmada">Confirmada</option>
            <option value="atendida">Atendida</option>
            <option value="cancelada">Cancelada</option>
          </select>
        </div>

        <div class="field">
          <label for="inicio">Inicio</label>
          <input id="inicio" type="datetime-local" />
        </div>

        <div class="field">
          <label for="fin">Fin</label>
          <input id="fin" type="datetime-local" />
        </div>

        <div class="field" style="grid-column: 1 / -1;">
          <label>T√≠tulo (autom√°tico)</label>
          <div id="titulo_preview" class="previewTitulo"></div>
          <!-- input oculto para guardar -->
          <input id="titulo" type="hidden" />
        </div>

        <div class="field" style="grid-column: 1 / -1;">
          <label for="notas">Notas</label>
          <textarea id="notas" placeholder="Observaciones, motivo, procedimientos, etc."></textarea>
        </div>
      </div>

      <div class="modalFoot">
        <button class="btn danger" id="btnDelete" type="button" style="display:none;">Eliminar</button>
        <button class="btn" type="button" onclick="document.getElementById('modal').classList.remove('open')">Cancelar</button>
        <button class="btn primary" id="btnSave" type="button">Crear cita</button>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading" class="loading" aria-hidden="true">
    <div class="spinner" aria-label="Cargando"></div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">Listo</div>

  <script>
    // Este script NO toca Supabase; solo UI r√°pida para el preview del t√≠tulo
    // (El c√°lculo real est√° en el module script de arriba)
  </script>
</body>
</html>

