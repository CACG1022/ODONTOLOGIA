<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agendamiento Avanzado - Cl√≠nica Odontol√≥gica</title>

  <!-- ‚úÖ FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <!-- üîê GUARD / PERMISOS POR MODULO (SUPABASE) + APP -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ==============================
    // ‚úÖ CONFIG SUPABASE (MISMA CONFIG QUE YA TEN√çAS)
    // ==============================
    const supabase = createClient(
      "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
    );

    // Hacerlo global para que el resto del JS lo use
    window.supabase = supabase;

    // ==============================
    // ‚úÖ URLs DE TU APP (MISMAS QUE YA TEN√çAS)
    // ==============================
    window.APP_URLS = {
      LOGIN: "https://cacg1022.github.io/ODONTOLOGIA/login.html",
      HOME:  "https://cacg1022.github.io/ODONTOLOGIA/index.html",
    };

    // ==============================
    // ‚úÖ CAMBIA ESTO EN CADA MODULO
    // (debe coincidir EXACTO con modulos_permisos.modulo)
    // ==============================
    const MODULO = "agendamientos";
    // Ejemplos:
    // const MODULO = "facturacion";
    // const MODULO = "historia_clinica";
    // const MODULO = "plan_tratamiento";
    // const MODULO = "reportes";

    async function verificarSesion() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = window.APP_URLS.LOGIN;
        return null;
      }
      return session;
    }

    async function validarPermisoModulo() {
      const session = await verificarSesion();
      if (!session) return { ok:false };

      // 1) Leer rol desde profiles
      const { data: perfil, error: ePerfil } = await supabase
        .from("profiles")
        .select("role")
        .eq("id", session.user.id)
        .single();

      if (ePerfil || !perfil?.role) {
        alert("No se pudo obtener tu rol.");
        window.location.href = window.APP_URLS.HOME;
        return { ok:false };
      }

      const rol = String(perfil.role).toLowerCase().trim(); // admin/doctor/auxiliar/paciente

      // 2) Leer permisos del m√≥dulo
      const { data: permiso, error: ePerm } = await supabase
        .from("modulos_permisos")
        .select("admin, doctor, auxiliar, paciente, modulo")
        .eq("modulo", MODULO)
        .maybeSingle();

      if (ePerm) {
        console.error("‚ùå Error leyendo modulos_permisos:", ePerm);
        alert("Error leyendo permisos del m√≥dulo: " + (ePerm.message || ePerm));
        window.location.href = window.APP_URLS.HOME;
        return { ok:false };
      }

      if (!permiso) {
        console.warn("‚ö†Ô∏è No existe fila en modulos_permisos para modulo =", MODULO);
        alert("M√≥dulo no configurado en permisos.");
        window.location.href = window.APP_URLS.HOME;
        return { ok:false };
      }

      // 3) Validar permiso
      if (!permiso[rol]) {
        alert("‚õî No tienes permiso para acceder a este m√≥dulo.");
        window.location.href = window.APP_URLS.HOME;
        return { ok:false };
      }

      console.log("‚úÖ Acceso permitido a:", MODULO, "Rol:", rol);
      return { ok:true, session, rol };
    }

    // ‚úÖ Si se cierra sesi√≥n, sacarlo
    supabase.auth.onAuthStateChange((_event, session) => {
      if (!session) window.location.href = window.APP_URLS.LOGIN;
    });

    // =========================================
    // ‚úÖ AQUI EMPIEZA TU CODIGO DE AGENDA (SIN OMITIR)
    //    (MISMAS CONFIGS, SOLO QUITAMOS EL DOBLE createClient)
    // =========================================

    const LOGIN_URL = window.APP_URLS.LOGIN;
    const HOME_URL  = window.APP_URLS.HOME;

    // ‚úÖ Tablas en espa√±ol
    const TABLA_CITAS = "citas";
    const TABLA_PROFESIONALES = "profesionales";

    // ‚úÖ HISTORIAS CL√çNICAS (AJUSTABLE SI TU TABLA/CAMPOS SE LLAMAN DISTINTO)
    const TABLA_HISTORIAS = "HISTORIAS CLINICAS";
    const HIST_COL_DOCUMENTO = "Numero de Identificacion";
    const HIST_COL_NOMBRE = "Nombre y apellido";
    const HIST_COL_TELEFONO = "paciente_cel";
    const HIST_COL_CORREO = "paciente_email";

    // ‚úÖ Lista de especialidades del procedimiento
    const ESPECIALIDADES = [
      "Odontologia General",
      "Rehabilitacion Oral",
      "Endodoncia",
      "Periodoncia",
      "Ortodoncia",
      "Cirugia",
      "Odontopediatr√≠a"
    ];

    // =========================
    // Helpers UI
    // =========================
    const $ = (id) => document.getElementById(id);

    function toast(msg, type="info"){
      const el = $("toast");
      if(!el) return alert(msg);
      el.textContent = msg;
      el.className = "toast show " + type;
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(()=> el.className = "toast", 2600);
    }

    function setLoading(isLoading){
      const b = $("loading");
      if(!b) return;
      b.style.display = isLoading ? "flex" : "none";
    }

    function toLocalInputValue(dateObj){
      const pad = (n)=> String(n).padStart(2,"0");
      const y = dateObj.getFullYear();
      const m = pad(dateObj.getMonth()+1);
      const d = pad(dateObj.getDate());
      const hh = pad(dateObj.getHours());
      const mm = pad(dateObj.getMinutes());
      return `${y}-${m}-${d}T${hh}:${mm}`;
    }

    // ‚úÖ Mantener para c√°lculos/t√≠tulo (usa UTC)
    function toISOFromLocalInput(val){
      const d = new Date(val);
      if (isNaN(d.getTime())) return null;
      return d.toISOString();
    }

    // ‚úÖ NUEVO: guardar en DB como hora local (Colombia) sin zona
    function toDbLocalTimestamp(val){
      // "2026-01-07T16:00" -> "2026-01-07 16:00:00"
      if (!val) return null;
      return String(val).replace("T"," ") + ":00";
    }

    // ‚úÖ NUEVO: Date -> "YYYY-MM-DD HH:mm:ss" en hora local
    function toDbFromDate(dateObj){
      if (!dateObj || !(dateObj instanceof Date) || isNaN(dateObj.getTime())) return null;
      const pad = (n)=> String(n).padStart(2,"0");
      const y = dateObj.getFullYear();
      const m = pad(dateObj.getMonth()+1);
      const d = pad(dateObj.getDate());
      const hh = pad(dateObj.getHours());
      const mm = pad(dateObj.getMinutes());
      const ss = pad(dateObj.getSeconds());
      return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
    }

    // ‚úÖ NUEVO: DB "YYYY-MM-DD HH:mm:ss" -> input datetime-local "YYYY-MM-DDTHH:mm"
    function dbTimestampToDatetimeLocal(ts){
      if (!ts) return "";
      const s = String(ts);
      // acepta "YYYY-MM-DD HH:mm:ss" o "YYYY-MM-DDTHH:mm:ss"
      return s.replace(" ", "T").slice(0,16);
    }

    function normalizeText(t){ return (t || "").trim(); }

    function colorPorEstado(estado){
      const s = String(estado || "").toLowerCase();
      if (s === "confirmada") return "#2563eb";
      if (s === "atendida") return "#16a34a";
      if (s === "cancelada") return "#ef4444";
      return "#f59e0b"; // programada
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function pad2(n){ return String(n).padStart(2,"0"); }
    function formatHoraLocal(dateObj){
      return `${pad2(dateObj.getHours())}:${pad2(dateObj.getMinutes())}`;
    }

    function duracionMinutos(startISO, endISO){
      const s = new Date(startISO);
      const e = new Date(endISO);
      const ms = e - s;
      return Math.max(0, Math.round(ms / 60000));
    }

    function formatoDuracion(mins){
      if (mins < 60) return `${mins} min`;
      const h = Math.floor(mins/60);
      const m = mins % 60;
      return m === 0 ? `${h} h` : `${h} h ${m} min`;
    }

    // =========================
    // Auth + Roles (TU LOGICA ORIGINAL)
    // =========================
    async function cargarRolDesdeProfiles(userId){
      try {
        const { data, error } = await supabase
          .from("profiles")
          .select("role")
          .eq("id", userId)
          .single();

        if (error) return null;
        return data?.role || null;
      } catch {
        return null;
      }
    }

    async function verificarSesionYPermisos(){
      const { data: { session } } = await supabase.auth.getSession();
      if (!session){
        window.location.href = LOGIN_URL;
        return { ok:false };
      }

      $("user-email").textContent = session.user?.email || "Usuario autenticado";

      const role = await cargarRolDesdeProfiles(session.user.id);
      $("user-role").textContent = role ? `Rol: ${role}` : "Rol: (sin rol)";

      const r = String(role || "").toLowerCase().trim();
      const allowed = (r === "admin" || r === "auxiliar"|| r === "doctor");

      if (!allowed){
        $("blocked").style.display = "block";
        $("app").style.display = "none";
        return { ok:false, session, role };
      }

      $("blocked").style.display = "none";
      $("app").style.display = "grid";

      return { ok:true, session, role };
    }

    supabase.auth.onAuthStateChange((_event, session) => {
      if (!session) window.location.href = LOGIN_URL;
    });

    window.cerrarSesion = async () => {
      try { await supabase.auth.signOut(); } catch(e) {}
      try { localStorage.removeItem("usuario_logueado"); } catch(e) {}
      window.location.href = LOGIN_URL;
    };

    // =========================
    // Profesionales (cargar select)
    // =========================
    let profesionalesCache = [];
    async function cargarProfesionales(){
      const { data, error } = await supabase
        .from(TABLA_PROFESIONALES)
        .select("id, nombre, activo, profesion, especialidad")
        .order("nombre", { ascending: true });

      if (error) throw new Error(error.message);

      profesionalesCache = (data || []).filter(p => p.activo === true);

      const sel = $("profesional_id");
      sel.innerHTML = `<option value="">-- Selecciona --</option>` +
        profesionalesCache.map(p => `<option value="${p.id}">${escapeHtml(p.nombre)}</option>`).join("");

      const filt = $("filterProfessional");
      filt.innerHTML = `<option value="">Todos</option>` +
        profesionalesCache.map(p => `<option value="${p.id}">${escapeHtml(p.nombre)}</option>`).join("");
    }

    function getNombreProfesionalPorId(id){
      return profesionalesCache.find(p => p.id === id)?.nombre || "";
    }

    // =========================
    // Especialidades (cargar select)
    // =========================
    function cargarEspecialidades(){
      const sel = $("especialidad");
      sel.innerHTML =
        `<option value="">-- Selecciona --</option>` +
        ESPECIALIDADES.map(e => `<option value="${escapeHtml(e)}">${escapeHtml(e)}</option>`).join("");

      const filt = $("filterEspecialidad");
      filt.innerHTML =
        `<option value="todos">Todas</option>` +
        ESPECIALIDADES.map(e => `<option value="${escapeHtml(e)}">${escapeHtml(e)}</option>`).join("");
    }

    // =========================
    // Autocompletar paciente desde HISTORIAS CL√çNICAS
    // =========================
    let __lookupTimer = null;

    async function buscarPacienteEnHistorias(documento){
      const docTxt = normalizeText(documento);
      if (!docTxt) return { found: false };

      const docNum = Number(docTxt);
      if (!Number.isFinite(docNum)) return { found: false };

      const selectCols = `"${HIST_COL_NOMBRE}",${HIST_COL_TELEFONO},${HIST_COL_CORREO}`;

      const { data, error } = await supabase
        .from(TABLA_HISTORIAS)
        .select(selectCols)
        .eq(HIST_COL_DOCUMENTO, docNum)
        .maybeSingle();

      if (error){
        console.error("Error HISTORIAS:", error);
        toast(`Error consultando historias: ${error.message}`, "error");
        return { found: false, error };
      }

      if (!data) return { found: false };

      return {
        found: true,
        nombre: data[HIST_COL_NOMBRE] ?? "",
        telefono: data[HIST_COL_TELEFONO] ?? "",
        correo: data[HIST_COL_CORREO] ?? ""
      };
    }

    async function autocompletarPacientePorDocumento({ showToast = false } = {}){
      const doc = normalizeText($("documento_paciente").value);
      if (!doc) return;

      const last = $("documento_paciente").dataset.lastLookup || "";
      if (last === doc) return;

      $("documento_paciente").dataset.lastLookup = doc;

      try{
        setLoading(true);

        const res = await buscarPacienteEnHistorias(doc);

        if (res.found){
          if (!normalizeText($("nombre_paciente").value)) $("nombre_paciente").value = res.nombre || "";
          if (!normalizeText($("telefono_paciente").value)) $("telefono_paciente").value = res.telefono || "";
          if (!normalizeText($("correo_paciente").value)) $("correo_paciente").value = res.correo || "";

          $("documento_paciente").dataset.patientFound = "true";
          if (showToast) toast("Paciente encontrado: datos autocompletados.", "ok");
        } else {
          $("documento_paciente").dataset.patientFound = "false";
          if (showToast) toast("Paciente no encontrado. Diligencia los datos manualmente.", "warn");
        }

        actualizarPreviewTitulo();
      } finally {
        setLoading(false);
      }
    }

    function autocompletarPacienteDebounced(){
      clearTimeout(__lookupTimer);
      __lookupTimer = setTimeout(() => autocompletarPacientePorDocumento({ showToast: false }), 450);
    }

    // =========================
    // T√≠tulo autom√°tico
    // =========================
    function construirTituloAutomatico({ inicioISO, finISO, nombrePaciente, cedulaPaciente, especialidad }){
      const s = new Date(inicioISO);
      const e = new Date(finISO);
      const rango = `${formatHoraLocal(s)} - ${formatHoraLocal(e)}`;
      const mins = duracionMinutos(inicioISO, finISO);
      const dur = formatoDuracion(mins);

      const np = normalizeText(nombrePaciente) || "Paciente";
      const cc = normalizeText(cedulaPaciente) || "Sin c√©dula";
      const esp = normalizeText(especialidad) || "Sin especialidad";

      return `${rango}, ${dur}\n${np}, ${cc}\n${esp}`;
    }

    // =========================
    // CRUD Supabase (citas)
    // =========================
    function rowToEvent(row){
      // ‚úÖ Como ahora inicio/fin son timestamp sin tz, los convertimos a Date desde partes (m√°s seguro)
      const start = new Date(dbTimestampToDatetimeLocal(row.inicio));
      const end   = new Date(dbTimestampToDatetimeLocal(row.fin));

      const estado = row.estado || "programada";

      const titulo = normalizeText(row.titulo)
        ? row.titulo
        : construirTituloAutomatico({
            inicioISO: toISOFromLocalInput(dbTimestampToDatetimeLocal(row.inicio)),
            finISO: toISOFromLocalInput(dbTimestampToDatetimeLocal(row.fin)),
            nombrePaciente: row.nombre_paciente,
            cedulaPaciente: row.documento_paciente,
            especialidad: row.especialidad
          });

      return {
        id: row.id,
        title: titulo,
        start: dbTimestampToDatetimeLocal(row.inicio),
        end: dbTimestampToDatetimeLocal(row.fin),
        backgroundColor: colorPorEstado(estado),
        borderColor: colorPorEstado(estado),
        extendedProps: {
          nombre_paciente: row.nombre_paciente || "",
          documento_paciente: row.documento_paciente || "",
          telefono_paciente: row.telefono_paciente || "",
          correo_paciente: row.correo_paciente || "",  // ‚úÖ ahora s√≠
          profesional_id: row.profesional_id || "",
          nombre_profesional: row.nombre_profesional || "",
          especialidad: row.especialidad || "",
          estado: estado,
          notas: row.notas || "",
          inicio_local: toLocalInputValue(start),
          fin_local: toLocalInputValue(end),
        }
      };
    }

    async function fetchCitas(rangeStartISO, rangeEndISO, profesionalIdFiltro, estadoFiltro, especialidadFiltro){
      // ‚úÖ rangeStartISO/rangeEndISO vienen en ISO UTC por FullCalendar.
      // Convertimos a hora local para comparar con timestamp sin tz en DB.
      const startLocal = toDbFromDate(new Date(rangeStartISO));
      const endLocal   = toDbFromDate(new Date(rangeEndISO));

      let q = supabase
        .from(TABLA_CITAS)
        .select("*")
        .gte("inicio", startLocal)
        .lt("inicio", endLocal)
        .order("inicio", { ascending: true });

      if (profesionalIdFiltro) q = q.eq("profesional_id", profesionalIdFiltro);
      if (estadoFiltro && estadoFiltro !== "todos") q = q.eq("estado", estadoFiltro);
      if (especialidadFiltro && especialidadFiltro !== "todos") q = q.eq("especialidad", especialidadFiltro);

      const { data, error } = await q;
      if (error) throw new Error(error.message);
      return data || [];
    }

    async function getCitaById(id){
      const { data, error } = await supabase
        .from(TABLA_CITAS)
        .select("*")
        .eq("id", id)
        .single();

      if (error) throw new Error(error.message);
      return data;
    }

    async function crearCita(row){
      const { data, error } = await supabase
        .from(TABLA_CITAS)
        .insert(row)
        .select("*")
        .single();

      if (error) throw new Error(error.message);
      return data;
    }

    async function actualizarCita(id, row){
      const { data, error } = await supabase
        .from(TABLA_CITAS)
        .update(row)
        .eq("id", id)
        .select("*")
        .single();

      if (error) throw new Error(error.message);
      return data;
    }

    async function eliminarCita(id){
      const { error } = await supabase
        .from(TABLA_CITAS)
        .delete()
        .eq("id", id);

      if (error) throw new Error(error.message);
      return true;
    }

    // =========================
    // Modal
    // =========================
    function openModal(mode, payload){
      $("modal").classList.add("open");
      $("modal").setAttribute("aria-hidden","false");
      $("modalTitle").textContent = mode === "edit" ? "Editar cita" : "Nueva cita";

      $("citaId").value = payload?.id || "";
      $("titulo").value = payload?.titulo || "";

      $("documento_paciente").value = payload?.documento_paciente || "";
      $("nombre_paciente").value = payload?.nombre_paciente || "";
      $("telefono_paciente").value = payload?.telefono_paciente || "";
      $("correo_paciente").value = payload?.correo_paciente || "";

      $("profesional_id").value = payload?.profesional_id || "";
      $("especialidad").value = payload?.especialidad || "";
      $("estado").value = payload?.estado || "programada";
      $("notas").value = payload?.notas || "";
      $("inicio").value = payload?.inicio_local || "";
      $("fin").value = payload?.fin_local || "";

      $("documento_paciente").dataset.lastLookup = "";
      $("documento_paciente").dataset.patientFound = "";

      if (!normalizeText($("titulo").value) && payload?.inicio_local && payload?.fin_local){
        const inicioISO = toISOFromLocalInput(payload.inicio_local);
        const finISO = toISOFromLocalInput(payload.fin_local);
        if (inicioISO && finISO){
          $("titulo").value = construirTituloAutomatico({
            inicioISO,
            finISO,
            nombrePaciente: $("nombre_paciente").value,
            cedulaPaciente: $("documento_paciente").value,
            especialidad: $("especialidad").value
          });
        }
      }

      $("titulo_preview").textContent = $("titulo").value || "";
      $("btnDelete").style.display = mode === "edit" ? "inline-flex" : "none";
      $("btnSave").textContent = mode === "edit" ? "Guardar cambios" : "Crear cita";

      // En m√≥vil: al abrir, mandamos scroll del cuerpo arriba
      const body = $("modalBody");
      if (body) body.scrollTop = 0;

      if (mode !== "edit" && normalizeText($("documento_paciente").value)){
        autocompletarPacientePorDocumento({ showToast: false });
      } else {
        actualizarPreviewTitulo();
      }
    }

    function closeModal(){
      $("modal").classList.remove("open");
      $("modal").setAttribute("aria-hidden","true");
    }

    function actualizarPreviewTitulo(){
      const inicioLocal = $("inicio").value;
      const finLocal = $("fin").value;
      if (!inicioLocal || !finLocal) return;

      const inicioISO = toISOFromLocalInput(inicioLocal);
      const finISO = toISOFromLocalInput(finLocal);
      if (!inicioISO || !finISO) return;

      const titulo = construirTituloAutomatico({
        inicioISO,
        finISO,
        nombrePaciente: $("nombre_paciente").value,
        cedulaPaciente: $("documento_paciente").value,
        especialidad: $("especialidad").value
      });

      $("titulo").value = titulo;
      $("titulo_preview").textContent = titulo;
    }

    // =========================
    // FullCalendar
    // =========================
    let calendar;
    let currentSession = null;

    function getFilters(){
      return {
        profesional_id: $("filterProfessional").value || "",
        estado: $("filterStatus").value || "todos",
        especialidad: $("filterEspecialidad").value || "todos"
      };
    }

    async function reloadCalendarEvents(){
      if (!calendar) return;
      setLoading(true);
      try{
        const view = calendar.view;
        const rangeStart = view.activeStart.toISOString();
        const rangeEnd   = view.activeEnd.toISOString();

        const { profesional_id, estado, especialidad } = getFilters();
        const rows = await fetchCitas(rangeStart, rangeEnd, profesional_id, estado, especialidad);
        const events = rows.map(rowToEvent);

        calendar.removeAllEvents();
        events.forEach(e => calendar.addEvent(e));

        $("rangeLabel").textContent = view.title || new Date().toLocaleDateString("es-CO");
      } catch(e){
        console.error(e);
        toast("Error cargando agenda: " + e.message, "error");
      } finally {
        setLoading(false);
      }
    }

    async function initCalendar(){
      calendar = new FullCalendar.Calendar($("calendar"), {
        locale: "es",
        timeZone: "local",
        initialView: "timeGridWeek",
        nowIndicator: true,
        selectable: true,
        editable: true,
        eventResizableFromStart: true,
        dayMaxEvents: true,
        allDaySlot: false,
        slotMinTime: "07:00:00",
        slotMaxTime: "20:00:00",
        slotDuration: "00:15:00",
        headerToolbar: false,

        select: (info) => {
          openModal("create", {
            inicio_local: toLocalInputValue(info.start),
            fin_local: toLocalInputValue(info.end),
            estado: "programada"
          });
        },

        dateClick: (info) => {
          const start = info.date;
          const end = new Date(start.getTime() + 30*60*1000);
          openModal("create", {
            inicio_local: toLocalInputValue(start),
            fin_local: toLocalInputValue(end),
            estado: "programada"
          });
        },

        // ‚úÖ al hacer click, consultamos la cita REAL en Supabase por id
        eventClick: async (info) => {
          try{
            setLoading(true);

            const ev = info.event;
            const row = await getCitaById(ev.id);

            openModal("edit", {
              id: row.id,
              titulo: row.titulo,
              nombre_paciente: row.nombre_paciente,
              documento_paciente: row.documento_paciente,
              telefono_paciente: row.telefono_paciente,
              correo_paciente: row.correo_paciente,
              profesional_id: row.profesional_id,
              especialidad: row.especialidad,
              estado: row.estado,
              notas: row.notas,
              // ‚úÖ timestamp sin tz -> input datetime-local directo
              inicio_local: dbTimestampToDatetimeLocal(row.inicio),
              fin_local: dbTimestampToDatetimeLocal(row.fin),
            });

          } catch(e){
            console.error(e);
            toast("No se pudo abrir la cita: " + e.message, "error");
          } finally {
            setLoading(false);
          }
        },

        eventDrop: async (info) => {
          try{
            setLoading(true);
            const id = info.event.id;

            // ‚úÖ Guardar en DB como hora local (no ISO UTC)
            const inicioDB = toDbFromDate(info.event.start);
            const finDB = toDbFromDate(info.event.end);

            // Para t√≠tulo seguimos usando ISO (solo visual)
            const inicioISO = info.event.start.toISOString();
            const finISO = info.event.end.toISOString();

            const nuevoTitulo = construirTituloAutomatico({
              inicioISO,
              finISO,
              nombrePaciente: info.event.extendedProps.nombre_paciente,
              cedulaPaciente: info.event.extendedProps.documento_paciente,
              especialidad: info.event.extendedProps.especialidad
            });

            const row = { inicio: inicioDB, fin: finDB, titulo: nuevoTitulo };
            await actualizarCita(id, row);

            info.event.setProp("title", nuevoTitulo);
            info.event.setExtendedProp("inicio_local", toLocalInputValue(info.event.start));
            info.event.setExtendedProp("fin_local", toLocalInputValue(info.event.end));

            toast("Cita reprogramada.", "ok");
          } catch(e){
            console.error(e);
            info.revert();
            toast("Error al mover: " + e.message, "error");
          } finally {
            setLoading(false);
          }
        },

        eventResize: async (info) => {
          try{
            setLoading(true);
            const id = info.event.id;

            // ‚úÖ Guardar en DB como hora local (no ISO UTC)
            const inicioDB = toDbFromDate(info.event.start);
            const finDB = toDbFromDate(info.event.end);

            // Para t√≠tulo seguimos usando ISO (solo visual)
            const inicioISO = info.event.start.toISOString();
            const finISO = info.event.end.toISOString();

            const nuevoTitulo = construirTituloAutomatico({
              inicioISO,
              finISO,
              nombrePaciente: info.event.extendedProps.nombre_paciente,
              cedulaPaciente: info.event.extendedProps.documento_paciente,
              especialidad: info.event.extendedProps.especialidad
            });

            const row = { inicio: inicioDB, fin: finDB, titulo: nuevoTitulo };
            await actualizarCita(id, row);

            info.event.setProp("title", nuevoTitulo);
            info.event.setExtendedProp("inicio_local", toLocalInputValue(info.event.start));
            info.event.setExtendedProp("fin_local", toLocalInputValue(info.event.end));

            toast("Duraci√≥n actualizada.", "ok");
          } catch(e){
            console.error(e);
            info.revert();
            toast("Error al redimensionar: " + e.message, "error");
          } finally {
            setLoading(false);
          }
        },

        datesSet: async () => {
          await reloadCalendarEvents();
        }
      });

      calendar.render();
      await reloadCalendarEvents();
    }

    // =========================
    // UI
    // =========================
    function wireButtons(){
      $("btnDay").addEventListener("click", ()=> calendar.changeView("timeGridDay"));
      $("btnWeek").addEventListener("click", ()=> calendar.changeView("timeGridWeek"));
      $("btnMonth").addEventListener("click", ()=> calendar.changeView("dayGridMonth"));
      $("btnToday").addEventListener("click", ()=> calendar.today());
      $("btnPrev").addEventListener("click", ()=> calendar.prev());
      $("btnNext").addEventListener("click", ()=> calendar.next());
      $("btnHome").addEventListener("click", ()=> window.location.href = HOME_URL);

      $("filterProfessional").addEventListener("change", ()=> reloadCalendarEvents());
      $("filterStatus").addEventListener("change", ()=> reloadCalendarEvents());
      $("filterEspecialidad").addEventListener("change", ()=> reloadCalendarEvents());

      $("btnNew").addEventListener("click", () => {
        const start = new Date();
        start.setSeconds(0,0);
        const m = start.getMinutes();
        const rounded = Math.ceil(m/15)*15;
        start.setMinutes(rounded);
        const end = new Date(start.getTime() + 30*60*1000);

        openModal("create", {
          inicio_local: toLocalInputValue(start),
          fin_local: toLocalInputValue(end),
          estado: "programada"
        });
      });

      $("btnClose").addEventListener("click", closeModal);
      $("modalBackdrop").addEventListener("click", closeModal);
      window.addEventListener("keydown", (e)=> { if (e.key === "Escape") closeModal(); });

      $("btnCancel").addEventListener("click", closeModal);

      $("btnSave").addEventListener("click", onSave);
      $("btnDelete").addEventListener("click", onDelete);

      ["nombre_paciente","documento_paciente","especialidad","inicio","fin"].forEach(id=>{
        $(id).addEventListener("input", actualizarPreviewTitulo);
        $(id).addEventListener("change", actualizarPreviewTitulo);
      });

      $("documento_paciente").addEventListener("input", autocompletarPacienteDebounced);
      $("documento_paciente").addEventListener("blur", () => autocompletarPacientePorDocumento({ showToast: true }));

      ["nombre_paciente","telefono_paciente","correo_paciente"].forEach(id=>{
        $(id).addEventListener("input", actualizarPreviewTitulo);
        $(id).addEventListener("change", actualizarPreviewTitulo);
      });
    }

    async function onSave(){
      try{
        setLoading(true);

        const id = $("citaId").value.trim();
        const profesionalId = $("profesional_id").value;
        const especialidad = $("especialidad").value;
        const inicioLocal = $("inicio").value;
        const finLocal = $("fin").value;

        if (!profesionalId){ toast("Selecciona un profesional.", "warn"); return; }
        if (!especialidad){ toast("Selecciona la especialidad del procedimiento.", "warn"); return; }
        if (!inicioLocal || !finLocal){ toast("Selecciona inicio y fin.", "warn"); return; }

        // ‚úÖ Para c√°lculos/t√≠tulo seguimos usando ISO (UTC)
        const inicioISO = toISOFromLocalInput(inicioLocal);
        const finISO = toISOFromLocalInput(finLocal);
        if (!inicioISO || !finISO){ toast("Fecha/hora inv√°lida.", "warn"); return; }

        // ‚úÖ Validaci√≥n de rango usando valores del input (local)
        const inicioD = new Date(inicioLocal);
        const finD = new Date(finLocal);
        if (finD <= inicioD){ toast("La hora final debe ser mayor que la inicial.", "warn"); return; }

        const tituloAuto = construirTituloAutomatico({
          inicioISO,
          finISO,
          nombrePaciente: $("nombre_paciente").value,
          cedulaPaciente: $("documento_paciente").value,
          especialidad: especialidad
        });

        $("titulo").value = tituloAuto;
        $("titulo_preview").textContent = tituloAuto;

        // ‚úÖ Guardar en DB como hora local Colombia (timestamp sin tz)
        const inicioDB = toDbLocalTimestamp(inicioLocal);
        const finDB = toDbLocalTimestamp(finLocal);

        const row = {
          usuario_id: currentSession.user.id,
          profesional_id: profesionalId,

          nombre_paciente: normalizeText($("nombre_paciente").value),
          documento_paciente: normalizeText($("documento_paciente").value),
          telefono_paciente: normalizeText($("telefono_paciente").value),
          correo_paciente: normalizeText($("correo_paciente").value),

          especialidad: normalizeText(especialidad),
          titulo: tituloAuto,
          estado: $("estado").value || "programada",
          notas: normalizeText($("notas").value),

          inicio: inicioDB,
          fin: finDB,

          nombre_profesional: getNombreProfesionalPorId(profesionalId)
        };

        if (id){
          await actualizarCita(id, row);
          toast("Cita actualizada.", "ok");
        } else {
          await crearCita(row);
          toast("Cita creada.", "ok");
        }

        closeModal();
        await reloadCalendarEvents();

      } catch(e){
        console.error(e);
        toast("Error guardando: " + e.message, "error");
      } finally {
        setLoading(false);
      }
    }

    async function onDelete(){
      const id = $("citaId").value.trim();
      if (!id) return;

      const ok = confirm("¬øEliminar esta cita definitivamente?");
      if (!ok) return;

      try{
        setLoading(true);
        await eliminarCita(id);
        closeModal();
        toast("Cita eliminada.", "ok");
        await reloadCalendarEvents();
      } catch(e){
        console.error(e);
        toast("Error eliminando: " + e.message, "error");
      } finally {
        setLoading(false);
      }
    }

    // =========================
    // Init (TU MAIN ORIGINAL + GUARD ANTES)
    // =========================
    (async function main(){
      // ‚úÖ 1) Primero valida permisos por m√≥dulo (modulos_permisos)
      const guard = await validarPermisoModulo();
      if (!guard.ok) return;

      // ‚úÖ 2) Luego tu validaci√≥n original (admin/auxiliar) sin cambiar tu l√≥gica
      const res = await verificarSesionYPermisos();
      if (!res.ok) return;

      currentSession = res.session;

      $("today").textContent = new Date().toLocaleDateString("es-CO", {
        year:"numeric", month:"long", day:"2-digit"
      });

      wireButtons();
      cargarEspecialidades();
      await cargarProfesionales();
      await initCalendar();
    })();
  </script>

  <style>
    :root{
      --bg: #f5f7fb;
      --surface: #ffffff;
      --surface-2: #fbfcff;
      --border: rgba(15, 23, 42, 0.10);
      --text: #0f172a;
      --muted: #64748b;
      --accent: #2563eb;
      --accent-2: #1d4ed8;
      --shadow: 0 20px 45px rgba(15,23,42,.10);
      --shadow-2: 0 10px 20px rgba(15,23,42,.08);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(900px 500px at 25% 15%, rgba(37, 99, 235, .08), transparent 55%),
        radial-gradient(700px 420px at 85% 75%, rgba(2, 132, 199, .07), transparent 60%),
        linear-gradient(180deg, #ffffff, var(--bg));
      padding: 22px 14px;
    }

    .shell{
      width: min(1200px, 100%);
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    .topbar{
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-2);
      border-radius: var(--radius);
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap: 3px;
    }

    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
    }

    .brand .sub{
      font-size: 12.5px;
      color: var(--muted);
    }

    .userbox{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap: 2px;
      font-size: 12.5px;
      color: var(--muted);
    }

    .userbox strong{ color: var(--text); font-weight: 700; }

    .actions{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn{
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 650;
      font-size: 13px;
      box-shadow: 0 6px 14px rgba(15,23,42,.06);
      transition: transform .08s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }

    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(37,99,235,.35);
      background: #fff;
    }

    .btn.primary{
      background: var(--accent);
      border-color: rgba(37,99,235,.4);
      color:#fff;
    }
    .btn.primary:hover{ background: var(--accent-2); }

    .btn.danger{
      background: rgba(239,68,68,.08);
      border-color: rgba(239,68,68,.25);
      color: #991b1b;
    }

    .btn.link{
      background: transparent;
      box-shadow: none;
    }

    .grid{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 14px;
      align-items: start;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .userbox{ align-items:flex-start; }
      .actions{ justify-content:flex-start; }
    }

    .panel{
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-2);
      border-radius: var(--radius);
      padding: 14px;
    }

    .panel h2{
      margin:0 0 10px 0;
      font-size: 14px;
      letter-spacing: .2px;
    }

    .muted{
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.45;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin-top: 10px;
    }

    label{
      font-size: 12.5px;
      color: var(--muted);
      font-weight: 650;
    }

    input, select, textarea{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 11px;
      font-size: 13.5px;
      outline: none;
      background: #fff;
      color: var(--text);
    }

    textarea{ min-height: 86px; resize: vertical; }

    .toolbarRow{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content: space-between;
      margin-top: 10px;
    }

    .toolbarLeft, .toolbarRight{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .range{
      font-size: 13px;
      color: var(--muted);
      font-weight: 650;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface-2);
    }

    .calendarWrap{
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 12px;
      overflow:hidden;
    }

    #calendar{
      background: #fff;
      border-radius: 12px;
      padding: 6px;
    }

    /* ‚úÖ MODAL RESPONSIVE: scroll interno + footer sticky */
    .modal{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
      z-index: 50;
    }
    .modal.open{ display:flex; }

    .backdrop{
      position:absolute;
      inset:0;
      background: rgba(2,6,23,.55);
    }

    .modalCard{
      position: relative;
      width: min(860px, 100%);
      max-height: calc(100vh - 24px);
      background: var(--surface);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 18px;
      box-shadow: 0 30px 90px rgba(0,0,0,.35);
      z-index: 2;

      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    .modalHead{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex: 0 0 auto;
    }

    .modalHead h3{
      margin:0;
      font-size: 15px;
      letter-spacing: .2px;
    }

    .modalBody{
      padding: 12px 14px 14px 14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
    }

    .modalGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 780px){
      .modalGrid{ grid-template-columns: 1fr; }
    }

    .modalFoot{
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      flex: 0 0 auto;
      flex-wrap: wrap;
    }

    .loading{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(4px);
      z-index: 60;
    }
    .spinner{
      width: 46px;
      height: 46px;
      border-radius: 999px;
      border: 4px solid rgba(37,99,235,.20);
      border-top-color: rgba(37,99,235,.95);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #0f172a;
      color: #fff;
      font-weight: 650;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease;
      z-index: 70;
      max-width: min(720px, 92vw);
      text-align:center;
      white-space: pre-line;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }
    .toast.ok{ background: rgba(22,163,74,.95); }
    .toast.warn{ background: rgba(245,158,11,.95); color:#111827; }
    .toast.error{ background: rgba(239,68,68,.95); }

    .blocked{
      display:none;
      background: rgba(239,68,68,.08);
      border: 1px solid rgba(239,68,68,.20);
      border-radius: var(--radius);
      padding: 16px;
      color: #991b1b;
      box-shadow: var(--shadow-2);
    }
    .blocked strong{ color:#7f1d1d; }

    .previewTitulo{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 11px;
      background: var(--surface-2);
      font-size: 13px;
      color: var(--text);
      white-space: pre-line;
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div class="shell">

    <div class="topbar">
      <div class="brand">
        <h1>Agendamiento Avanzado</h1>
        <div class="sub">Hoy: <span id="today"></span> ¬∑ Arrastra para mover ¬∑ Estira para cambiar duraci√≥n</div>
      </div>

      <div class="actions">
        <button class="btn link" id="btnHome" type="button">üè† Inicio</button>
        <button class="btn" id="btnNew" type="button">‚ûï Nueva cita</button>
        <button class="btn danger" onclick="cerrarSesion()" type="button">Cerrar sesi√≥n</button>
        <div class="userbox">
          <div><strong id="user-email">usuario</strong></div>
          <div id="user-role">Rol: ...</div>
        </div>
      </div>
    </div>

    <div id="blocked" class="blocked">
      <strong>Acceso restringido.</strong> Esta p√°gina solo puede ser usada por roles <b>admin</b> y <b>auxiliar</b>.
    </div>

    <div id="app" class="grid" style="display:none;">
      <div class="panel">
        <h2>Filtros</h2>
        <div class="muted">Filtra por profesional, estado y especialidad.</div>

        <div class="field">
          <label for="filterProfessional">Profesional</label>
          <select id="filterProfessional">
            <option value="">Cargando...</option>
          </select>
        </div>

        <div class="field">
          <label for="filterStatus">Estado</label>
          <select id="filterStatus">
            <option value="todos">Todos</option>
            <option value="programada">Programada</option>
            <option value="confirmada">Confirmada</option>
            <option value="atendida">Atendida</option>
            <option value="cancelada">Cancelada</option>
          </select>
        </div>

        <div class="field">
          <label for="filterEspecialidad">Especialidad</label>
          <select id="filterEspecialidad">
            <option value="todos">Cargando...</option>
          </select>
        </div>

        <div class="toolbarRow">
          <div class="toolbarLeft">
            <div class="range" id="rangeLabel">Agenda</div>
          </div>
          <div class="toolbarRight">
            <button class="btn" id="btnPrev" type="button">‚óÄ</button>
            <button class="btn" id="btnToday" type="button">Hoy</button>
            <button class="btn" id="btnNext" type="button">‚ñ∂</button>
          </div>
        </div>

        <div class="toolbarRow">
          <div class="toolbarLeft">
            <button class="btn" id="btnDay" type="button">D√≠a</button>
            <button class="btn" id="btnWeek" type="button">Semana</button>
            <button class="btn" id="btnMonth" type="button">Mes</button>
          </div>
        </div>

        <div class="field">
          <div class="muted">
            <b>Formato del t√≠tulo (autom√°tico):</b><br/>
            ‚Ä¢ Rango de hora, Duraci√≥n<br/>
            ‚Ä¢ Nombre del paciente, C√©dula<br/>
            ‚Ä¢ Especialidad
          </div>
        </div>
      </div>

      <div class="calendarWrap">
        <div id="calendar"></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div id="modalBackdrop" class="backdrop"></div>

    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHead">
        <h3 id="modalTitle">Nueva cita</h3>
        <button class="btn" id="btnClose" type="button">‚úï</button>
      </div>

      <div id="modalBody" class="modalBody">
        <input type="hidden" id="citaId" />

        <div class="modalGrid">
          <div class="field">
            <label for="documento_paciente">C√©dula / Documento</label>
            <input id="documento_paciente" type="text" placeholder="Digite la identificaci√≥n (autocompleta si existe)" />
          </div>

          <div class="field">
            <label for="nombre_paciente">Paciente (Nombre)</label>
            <input id="nombre_paciente" type="text" placeholder="Nombre del paciente" />
          </div>

          <div class="field">
            <label for="telefono_paciente">Tel√©fono</label>
            <input id="telefono_paciente" type="text" placeholder="Tel√©fono del paciente" />
          </div>

          <div class="field">
            <label for="correo_paciente">Correo electr√≥nico</label>
            <input id="correo_paciente" type="email" placeholder="correo@ejemplo.com" />
          </div>

          <div class="field">
            <label for="profesional_id">Profesional</label>
            <select id="profesional_id">
              <option value="">Cargando...</option>
            </select>
          </div>

          <div class="field">
            <label for="especialidad">Especialidad del procedimiento</label>
            <select id="especialidad">
              <option value="">Cargando...</option>
            </select>
          </div>

          <div class="field">
            <label for="estado">Estado</label>
            <select id="estado">
              <option value="programada">Programada</option>
              <option value="confirmada">Confirmada</option>
              <option value="atendida">Atendida</option>
              <option value="cancelada">Cancelada</option>
            </select>
          </div>

          <div class="field">
            <label for="inicio">Inicio</label>
            <input id="inicio" type="datetime-local" />
          </div>

          <div class="field">
            <label for="fin">Fin</label>
            <input id="fin" type="datetime-local" />
          </div>

          <div class="field" style="grid-column: 1 / -1;">
            <label>T√≠tulo (autom√°tico)</label>
            <div id="titulo_preview" class="previewTitulo"></div>
            <input id="titulo" type="hidden" />
          </div>

          <div class="field" style="grid-column: 1 / -1;">
            <label for="notas">Notas</label>
            <textarea id="notas" placeholder="Observaciones, motivo, procedimientos, etc."></textarea>
          </div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="btn danger" id="btnDelete" type="button" style="display:none;">Eliminar</button>
        <button class="btn" id="btnCancel" type="button">Cancelar</button>
        <button class="btn primary" id="btnSave" type="button">Crear cita</button>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading" class="loading" aria-hidden="true">
    <div class="spinner" aria-label="Cargando"></div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">Listo</div>
</body>
</html>




