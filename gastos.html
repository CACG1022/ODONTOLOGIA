<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gesti√≥n de Gastos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// ===============================
// CONFIGURACI√ìN SUPABASE
// ===============================
const supabase = createClient(
  "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
);

const LOGIN_URL = "login.html";
const HOME_URL  = "index.html";
const MODULO_ACTUAL = "gastos";

// ===============================
// NORMALIZACI√ìN DE M√ìDULO
// ===============================
function getModuloCandidates(mod){
  const base = String(mod || "").toLowerCase().trim();
  const withHtml = base.endsWith(".html") ? base : base + ".html";
  const undersc = base.replaceAll("-", "_");
  const underscHtml = undersc.endsWith(".html") ? undersc : undersc + ".html";
  return Array.from(new Set([base, withHtml, undersc, underscHtml]));
}

// ===============================
// VALIDAR SESI√ìN Y PERMISOS
// ===============================
async function validarAcceso(){
  const { data:{session} } = await supabase.auth.getSession();
  if(!session){
    window.location.href = LOGIN_URL;
    return;
  }

  const email = session.user.email.toLowerCase();

  const { data:perfil } = await supabase
    .from("profiles")
    .select("role, email, created_at")
    .eq("email", email)
    .order("created_at", { ascending:false })
    .limit(1)
    .maybeSingle();

  const rol = (perfil?.role || "paciente").toLowerCase();

  const candidates = getModuloCandidates(MODULO_ACTUAL);

  const { data:permisos, error } = await supabase
    .from("modulos_permisos")
    .select("admin, doctor, auxiliar, paciente, modulo")
    .in("modulo", candidates);

  if(error || !permisos?.length){
    alert("‚õî M√≥dulo no configurado en permisos.");
    window.location.href = HOME_URL;
    return;
  }

  const permiso = permisos[0];

  if(!permiso[rol]){
    alert("‚õî No autorizado");
    window.location.href = HOME_URL;
    return;
  }

  window.ROL = rol;
  window.USER = session.user;
}

await validarAcceso();

// ===============================
// FUNCIONES DE GASTOS
// ===============================
async function guardarGasto(){
  const data = {
    fecha: document.getElementById("fecha").value,
    tipo: document.getElementById("tipo").value,
    categoria: document.getElementById("categoria").value,
    proveedor: document.getElementById("proveedor").value,
    monto: document.getElementById("monto").value,
    forma_pago: document.getElementById("forma_pago").value,
    descripcion: document.getElementById("descripcion").value,
    usuario_id: window.USER.id
  };

  const { error } = await supabase.from("gastos").insert([data]);
  if(error){
    alert(error.message);
    return;
  }
  cargarGastos();
}

async function cargarGastos(){
  const { data } = await supabase
    .from("gastos")
    .select("*")
    .order("fecha", { ascending:false });

  const tbody = document.getElementById("tabla");
  tbody.innerHTML = "";

  let total=0, fijos=0, variables=0, extra=0;

  (data || []).forEach(g => {
    const m = Number(g.monto || 0);
    total += m;
    if(g.tipo === "fijo") fijos += m;
    if(g.tipo === "variable") variables += m;
    if(g.tipo === "extraordinario") extra += m;

    tbody.innerHTML += `
      <tr>
        <td>${g.fecha}</td>
        <td>${g.tipo}</td>
        <td>${g.categoria}</td>
        <td>${g.proveedor || "-"}</td>
        <td>$${m.toLocaleString()}</td>
        <td>${g.descripcion || ""}</td>
      </tr>`;
  });

  document.getElementById("kpi-total").textContent = "$" + total.toLocaleString();
  document.getElementById("kpi-fijos").textContent = "$" + fijos.toLocaleString();
  document.getElementById("kpi-variables").textContent = "$" + variables.toLocaleString();
  document.getElementById("kpi-extra").textContent = "$" + extra.toLocaleString();
}

window.guardarGasto = guardarGasto;
window.onload = cargarGastos;
</script>

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.container{max-width:1200px;margin:auto;background:#fff;border-radius:14px;padding:20px}
h1{margin-bottom:16px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.card{border:1px solid #e5e7eb;border-radius:12px;padding:14px}
input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db}
button{padding:10px;border:none;border-radius:8px;background:#1f6aa5;color:#fff;font-weight:bold;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{padding:10px;border-bottom:1px solid #e5e7eb}
th{background:#f3f4f6}
.kpi{font-size:20px;font-weight:bold}
</style>
</head>

<body>
<div class="container">
<h1>üí∏ Gesti√≥n de Gastos</h1>

<div class="card">
<h3>Registrar gasto</h3>
<div class="grid">
<input type="date" id="fecha">
<select id="tipo">
  <option value="fijo">Fijo</option>
  <option value="variable">Variable</option>
  <option value="extraordinario">Extraordinario</option>
</select>
<input placeholder="Categor√≠a" id="categoria">
<input placeholder="Proveedor" id="proveedor">
<input placeholder="Monto" type="number" id="monto">
<input placeholder="Forma de pago" id="forma_pago">
</div>
<input style="margin-top:10px;width:100%" placeholder="Descripci√≥n" id="descripcion">
<button onclick="guardarGasto()" style="margin-top:10px">Guardar gasto</button>
</div>

<div class="grid" style="margin-top:20px">
<div class="card"><div>Total Mes</div><div class="kpi" id="kpi-total">$0</div></div>
<div class="card"><div>Gastos Fijos</div><div class="kpi" id="kpi-fijos">$0</div></div>
<div class="card"><div>Gastos Variables</div><div class="kpi" id="kpi-variables">$0</div></div>
<div class="card"><div>Extraordinarios</div><div class="kpi" id="kpi-extra">$0</div></div>
</div>

<table>
<thead>
<tr>
<th>Fecha</th><th>Tipo</th><th>Categor√≠a</th>
<th>Proveedor</th><th>Monto</th><th>Descripci√≥n</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

</div>
</body>
</html>
