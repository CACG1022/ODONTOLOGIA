<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gesti√≥n de Gastos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
);

const LOGIN_URL = "login.html";
const HOME_URL  = "index.html";
const MODULO = "gastos";
let EDIT_ID = null;

/* ================= SESI√ìN Y PERMISOS ================= */
async function validarAcceso(){
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session){ location.href = LOGIN_URL; return; }

  const { data: perfil } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", session.user.id)
    .single();

  const rol = perfil?.role || "paciente";

  const { data: permiso } = await supabase
    .from("modulos_permisos")
    .select("admin,doctor,auxiliar,paciente")
    .eq("modulo", MODULO)
    .single();

  if(!permiso || !permiso[rol]){
    alert("No autorizado");
    location.href = HOME_URL;
    return;
  }

  window.USER = session.user;
  window.ROL = rol;

  userEmail.textContent = session.user.email;
  userRol.textContent = rol;
  responsable.value = session.user.email;
}

/* ================= PROVEEDORES ================= */
async function cargarProveedores(){
  const { data } = await supabase.from("gastos").select("proveedor");
  const unique = [...new Set((data||[]).map(d=>d.proveedor).filter(Boolean))];
  proveedor.innerHTML = "<option value=''>Proveedor</option>";
  unique.forEach(p=>{
    const o = document.createElement("option");
    o.value = p; o.textContent = p;
    proveedor.appendChild(o);
  });
}

/* ================= GUARDAR / EDITAR ================= */
async function guardarGasto(){
  const payload = {
    fecha: fecha.value,
    tipo: tipo.value,
    categoria: categoria.value,
    proveedor: proveedor.value,
    monto: monto.value,
    forma_pago: forma_pago.value,
    descripcion: descripcion.value,
    usuario_id: USER.id
  };

  if(EDIT_ID){
    await supabase.from("gastos").update(payload).eq("id", EDIT_ID);
    EDIT_ID = null;
    btnGuardar.textContent = "Guardar gasto";
  }else{
    await supabase.from("gastos").insert([payload]);
  }

  limpiarFormulario();
  await cargarGastos();
  await cargarProveedores();
}

/* ================= ELIMINAR ================= */
async function eliminarGasto(id){
  if(!confirm("¬øEliminar este gasto?")) return;
  await supabase.from("gastos").delete().eq("id", id);
  await cargarGastos();
}

/* ================= EDITAR ================= */
function editarGasto(g){
  EDIT_ID = g.id;
  fecha.value = g.fecha;
  tipo.value = g.tipo;
  categoria.value = g.categoria;
  proveedor.value = g.proveedor || "";
  monto.value = g.monto;
  forma_pago.value = g.forma_pago || "";
  descripcion.value = g.descripcion || "";
  btnGuardar.textContent = "Actualizar gasto";
  window.scrollTo({top:0, behavior:"smooth"});
}

/* ================= CARGAR ================= */
async function cargarGastos(){
  const { data } = await supabase.from("gastos").select("*").order("fecha",{ascending:false});
  tabla.innerHTML = "";
  let t=0,f=0,v=0,e=0;

  (data||[]).forEach(g=>{
    const m = Number(g.monto||0);
    t+=m;
    if(g.tipo==="fijo")f+=m;
    if(g.tipo==="variable")v+=m;
    if(g.tipo==="extraordinario")e+=m;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${g.fecha}</td>
      <td>${g.tipo}</td>
      <td>${g.categoria}</td>
      <td>${g.proveedor||""}</td>
      <td>$${m.toLocaleString()}</td>
      <td>${g.descripcion||""}</td>
      <td class="actions">
        <button class="edit">‚úèÔ∏è</button>
        <button class="delete">üóëÔ∏è</button>
      </td>
    `;
    row.querySelector(".edit").onclick = ()=>editarGasto(g);
    row.querySelector(".delete").onclick = ()=>eliminarGasto(g.id);
    tabla.appendChild(row);
  });

  kpiTotal.textContent = "$"+t.toLocaleString();
  kpiFijo.textContent  = "$"+f.toLocaleString();
  kpiVar.textContent   = "$"+v.toLocaleString();
  kpiExt.textContent   = "$"+e.toLocaleString();
}

/* ================= UTIL ================= */
function limpiarFormulario(){
  fecha.value=""; monto.value=""; forma_pago.value=""; descripcion.value="";
}

document.addEventListener("DOMContentLoaded", async ()=>{
  await validarAcceso();
  await cargarGastos();
  await cargarProveedores();
});

window.guardarGasto = guardarGasto;
</script>

<style>
:root{
  --bg:#f4f6f8;
  --card:#ffffff;
  --neon:#0fb9a8;
  --border:#e5e7eb;
  --shadow:0 18px 40px rgba(0,0,0,.12);
  --radius:18px;
}
body{margin:0;font-family:Inter,Arial;background:linear-gradient(180deg,#fff,var(--bg))}
.topbar{background:#fff;border-bottom:1px solid var(--border);padding:14px 22px;display:flex;justify-content:space-between}
.brand{font-weight:900;color:var(--neon)}
.meta{display:flex;gap:14px;align-items:center;font-size:13px}
.chip{border:1px solid var(--border);border-radius:999px;padding:6px 14px}
.btn{background:var(--neon);color:#fff;padding:8px 16px;border-radius:999px;text-decoration:none;font-weight:800}
.container{max-width:1200px;margin:26px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:26px;margin-bottom:24px}
.grid{display:grid;gap:26px}
.g-4{grid-template-columns:repeat(4,1fr)}
.g-3{grid-template-columns:repeat(3,minmax(220px,1fr))}
.full{grid-column:1/-1}
input,select{padding:16px;border-radius:14px;border:1px solid var(--border)}
button{background:var(--neon);color:#fff;padding:14px 22px;border:none;border-radius:14px;font-weight:900;cursor:pointer}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:18px}
.kpi{font-size:24px;font-weight:900;color:var(--neon)}
table{width:100%;border-collapse:collapse}
th,td{padding:14px;border-bottom:1px solid var(--border);font-size:13px}
.actions button{background:none;border:none;cursor:pointer;font-size:16px}
.actions .delete{color:#dc2626}
.actions .edit{color:#0fb9a8}
</style>
</head>

<body>

<div class="topbar">
  <div class="brand">üí∏ Gesti√≥n de Gastos</div>
  <div class="meta">
    <span class="chip" id="userEmail"></span>
    <span class="chip">Rol: <b id="userRol"></b></span>
    <a class="btn" href="index.html">HOME</a>
  </div>
</div>

<div class="container">

<div class="card">
<h1>Registrar gasto</h1>

<div class="grid g-4">
  <input type="date" id="fecha">
  <select id="tipo">
    <option value="fijo">Fijo</option>
    <option value="variable">Variable</option>
    <option value="extraordinario">Extraordinario</option>
  </select>
  <select id="categoria">
    <option>Consumibles</option>
    <option>Laboratorio</option>
    <option>Arriendo</option>
    <option>Servicios p√∫blicos</option>
    <option>Internet / software</option>
    <option>Compra de equipos</option>
    <option>Material desechable</option>
    <option>Medicamentos</option>
  </select>
  <select id="proveedor"></select>
</div>

<div class="grid g-3" style="margin-top:26px">
  <input id="monto" type="number" placeholder="Monto">
  <input id="forma_pago" placeholder="Forma de pago">
  <input id="responsable" readonly>
</div>

<div class="grid" style="margin-top:26px">
  <input id="descripcion" class="full" placeholder="Descripci√≥n">
</div>

<button id="btnGuardar" onclick="guardarGasto()">Guardar gasto</button>
</div>

<div class="kpis">
<div class="card"><div>Total Mes</div><div class="kpi" id="kpiTotal">$0</div></div>
<div class="card"><div>Gastos Fijos</div><div class="kpi" id="kpiFijo">$0</div></div>
<div class="card"><div>Gastos Variables</div><div class="kpi" id="kpiVar">$0</div></div>
<div class="card"><div>Extraordinarios</div><div class="kpi" id="kpiExt">$0</div></div>
</div>

<div class="card">
<table>
<thead>
<tr>
<th>Fecha</th><th>Tipo</th><th>Categor√≠a</th><th>Proveedor</th>
<th>Monto</th><th>Descripci√≥n</th><th>Acciones</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

</div>
</body>
</html>

