<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gesti√≥n de Gastos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
 "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
 "TU_PUBLIC_ANON_KEY"
);

const MODULO = "gastos";
const LOGIN_URL = "login.html";
const HOME_URL  = "index.html";

/* ===============================
   üîê SESI√ìN + PERMISOS
================================ */
async function validarAcceso(){
  const { data:{session} } = await supabase.auth.getSession();
  if(!session) location.href = LOGIN_URL;

  const { data:perfil } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", session.user.id)
    .single();

  const rol = perfil?.role || "paciente";

  const { data:permiso } = await supabase
    .from("modulos_permisos")
    .select("admin,doctor,auxiliar,paciente")
    .eq("modulo", MODULO)
    .single();

  if(!permiso || !permiso[rol]){
    alert("‚õî No autorizado");
    location.href = HOME_URL;
  }

  window.ROL = rol;
  window.USER = session.user;
}

await validarAcceso();
</script>

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.container{max-width:1200px;margin:auto;background:#fff;border-radius:14px;padding:20px}
h1{margin-bottom:16px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.card{border:1px solid #e5e7eb;border-radius:12px;padding:14px}
input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db}
button{padding:10px;border:none;border-radius:8px;background:#1f6aa5;color:#fff;font-weight:bold;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{padding:10px;border-bottom:1px solid #e5e7eb}
th{background:#f3f4f6}
.kpi{font-size:20px;font-weight:bold}
</style>
</head>

<body>
<div class="container">

<h1>üí∏ Gesti√≥n de Gastos</h1>

<!-- =======================
     REGISTRO DE GASTO
======================= -->
<div class="card">
<h3>Registrar gasto</h3>
<div class="grid">
<input type="date" id="fecha">
<select id="tipo">
  <option value="fijo">Fijo</option>
  <option value="variable">Variable</option>
  <option value="extraordinario">Extraordinario</option>
</select>
<input placeholder="Categor√≠a" id="categoria">
<input placeholder="Proveedor" id="proveedor">
<input placeholder="Monto" type="number" id="monto">
<input placeholder="Forma de pago" id="forma_pago">
</div>
<input style="margin-top:10px;width:100%" placeholder="Descripci√≥n" id="descripcion">
<button onclick="guardarGasto()" style="margin-top:10px">Guardar gasto</button>
</div>

<!-- =======================
     DASHBOARD
======================= -->
<div class="grid" style="margin-top:20px">
<div class="card"><div>Total Mes</div><div class="kpi" id="kpi-total">$0</div></div>
<div class="card"><div>Gastos Fijos</div><div class="kpi" id="kpi-fijos">$0</div></div>
<div class="card"><div>Gastos Variables</div><div class="kpi" id="kpi-variables">$0</div></div>
<div class="card"><div>Extraordinarios</div><div class="kpi" id="kpi-extra">$0</div></div>
</div>

<!-- =======================
     TABLA
======================= -->
<table>
<thead>
<tr>
<th>Fecha</th><th>Tipo</th><th>Categor√≠a</th>
<th>Proveedor</th><th>Monto</th><th>Descripci√≥n</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

</div>

<script>
async function guardarGasto(){
  const data = {
    fecha: fecha.value,
    tipo: tipo.value,
    categoria: categoria.value,
    proveedor: proveedor.value,
    monto: monto.value,
    forma_pago: forma_pago.value,
    descripcion: descripcion.value,
    usuario_id: USER.id
  };

  const { error } = await supabase.from("gastos").insert([data]);
  if(error){ alert(error.message); return; }

  cargarGastos();
}

async function cargarGastos(){
  const { data } = await supabase.from("gastos").select("*").order("fecha",{ascending:false});
  const tbody = document.getElementById("tabla");
  tbody.innerHTML = "";

  let total=0,fijos=0,variables=0,extra=0;

  data.forEach(g=>{
    total += Number(g.monto);
    if(g.tipo==="fijo") fijos+=Number(g.monto);
    if(g.tipo==="variable") variables+=Number(g.monto);
    if(g.tipo==="extraordinario") extra+=Number(g.monto);

    tbody.innerHTML += `
      <tr>
        <td>${g.fecha}</td>
        <td>${g.tipo}</td>
        <td>${g.categoria}</td>
        <td>${g.proveedor||"-"}</td>
        <td>$${Number(g.monto).toLocaleString()}</td>
        <td>${g.descripcion||""}</td>
      </tr>`;
  });

  kpi-total.textContent = `$${total.toLocaleString()}`;
  kpi-fijos.textContent = `$${fijos.toLocaleString()}`;
  kpi-variables.textContent = `$${variables.toLocaleString()}`;
  kpi-extra.textContent = `$${extra.toLocaleString()}`;
}

cargarGastos();
</script>

</body>
</html>
