<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gesti贸n de Gastos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://dmcfrmpqlkrqbpjhrfyo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE"
);

const LOGIN_URL = "login.html";
const HOME_URL  = "index.html";
const MODULO = "gastos";

async function validarAcceso(){
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session){ location.href = LOGIN_URL; return; }

  const { data: perfil } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", session.user.id)
    .single();

  const rol = perfil?.role || "paciente";

  const { data: permiso } = await supabase
    .from("modulos_permisos")
    .select("admin,doctor,auxiliar,paciente")
    .eq("modulo", MODULO)
    .single();

  if(!permiso || !permiso[rol]){
    alert("No autorizado");
    location.href = HOME_URL;
    return;
  }

  document.getElementById("user-email").textContent = session.user.email;
  document.getElementById("user-rol").textContent = rol;
  window.USER = session.user;
}
await validarAcceso();

async function guardarGasto(){
  const d = id => document.getElementById(id).value;
  await supabase.from("gastos").insert([{
    fecha:d("fecha"), tipo:d("tipo"), categoria:d("categoria"),
    proveedor:d("proveedor"), monto:d("monto"),
    forma_pago:d("forma_pago"), descripcion:d("descripcion"),
    usuario_id:USER.id
  }]);
  cargarGastos();
}

async function cargarGastos(){
  const { data } = await supabase.from("gastos").select("*").order("fecha",{ascending:false});
  const tb = document.getElementById("tabla");
  tb.innerHTML="";
  let t=0,f=0,v=0,e=0;
  (data||[]).forEach(g=>{
    const m=Number(g.monto||0);
    t+=m; if(g.tipo==="fijo")f+=m; if(g.tipo==="variable")v+=m; if(g.tipo==="extraordinario")e+=m;
    tb.innerHTML+=`<tr>
      <td>${g.fecha}</td><td>${g.tipo}</td><td>${g.categoria}</td>
      <td>${g.proveedor||""}</td><td>$${m.toLocaleString()}</td><td>${g.descripcion||""}</td>
    </tr>`;
  });
  kpiTotal.textContent="$"+t.toLocaleString();
  kpiFijo.textContent="$"+f.toLocaleString();
  kpiVar.textContent="$"+v.toLocaleString();
  kpiExt.textContent="$"+e.toLocaleString();
}
window.onload=cargarGastos;
window.guardarGasto=guardarGasto;
</script>

<style>
:root{
  --bg:#f8fafc;
  --card:#ffffff;
  --neon:#20f3c4;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e5e7eb;
  --shadow:0 12px 30px rgba(0,0,0,.08);
  --radius:16px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial;background:var(--bg);color:var(--text)}
.topbar{
  background:#ffffff;
  border-bottom:1px solid var(--border);
  padding:14px 22px;
  display:flex;justify-content:space-between;align-items:center;
  box-shadow:var(--shadow)
}
.topbar .brand{font-weight:900;color:var(--neon);font-size:18px}
.topbar .meta{display:flex;gap:14px;align-items:center;font-size:13px}
.topbar .chip{
  border:1px solid var(--border);border-radius:999px;padding:6px 12px;
}
.topbar a{
  text-decoration:none;color:#fff;background:var(--neon);
  padding:8px 14px;border-radius:999px;font-weight:800;
}

.container{max-width:1200px;margin:24px auto;padding:0 16px}
h1{color:var(--neon);margin-bottom:18px}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:20px;
  margin-bottom:20px;
}
.grid{display:grid;gap:16px}
.g-4{grid-template-columns:repeat(4,1fr)}
.g-2{grid-template-columns:repeat(2,1fr)}
.full{grid-column:1/-1}

input,select{
  width:100%;padding:14px;border-radius:12px;
  border:1px solid var(--border);font-size:14px
}
button{
  background:var(--neon);border:none;color:#003d2f;
  padding:12px 18px;border-radius:12px;font-weight:900;cursor:pointer
}

.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.kpi{font-size:22px;font-weight:900;color:var(--neon)}
.klabel{color:var(--muted);font-size:13px}

table{width:100%;border-collapse:collapse}
th,td{padding:12px;border-bottom:1px solid var(--border);font-size:13px}
th{color:var(--muted);text-align:left}
</style>
</head>

<body>

<div class="topbar">
  <div class="brand"> Gesti贸n de Gastos</div>
  <div class="meta">
    <span class="chip" id="user-email"></span>
    <span class="chip">Rol: <b id="user-rol"></b></span>
    <a href="index.html">Home</a>
  </div>
</div>

<div class="container">

<div class="card">
<h1>Registrar gasto</h1>
<div class="grid g-4">
<input type="date" id="fecha">
<select id="tipo">
  <option value="fijo">Fijo</option>
  <option value="variable">Variable</option>
  <option value="extraordinario">Extraordinario</option>
</select>
<input id="categoria" placeholder="Categor铆a">
<input id="proveedor" placeholder="Proveedor">
<input id="monto" placeholder="Monto" type="number">
<input id="forma_pago" placeholder="Forma de pago">
<input id="descripcion" class="full" placeholder="Descripci贸n">
</div>
<button style="margin-top:16px" onclick="guardarGasto()">Guardar gasto</button>
</div>

<div class="kpis">
<div class="card"><div class="klabel">Total Mes</div><div class="kpi" id="kpiTotal">$0</div></div>
<div class="card"><div class="klabel">Gastos Fijos</div><div class="kpi" id="kpiFijo">$0</div></div>
<div class="card"><div class="klabel">Gastos Variables</div><div class="kpi" id="kpiVar">$0</div></div>
<div class="card"><div class="klabel">Extraordinarios</div><div class="kpi" id="kpiExt">$0</div></div>
</div>

<div class="card">
<table>
<thead>
<tr>
<th>Fecha</th><th>Tipo</th><th>Categor铆a</th><th>Proveedor</th><th>Monto</th><th>Descripci贸n</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

</div>
</body>
</html>


