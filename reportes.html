
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reportes de Ventas - Cl√≠nica Odontol√≥gica</title>

  <!-- ‚úÖ Supabase (UMD) - EVITA PROBLEMAS DEL import type="module" -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <!-- ‚úÖ Chart.js (gr√°ficas) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- ‚úÖ Excel export (SheetJS) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg: #f3f5f7;
      --card: #ffffff;
      --text: #1f2a37;
      --muted: #6b7280;
      --line: #e5e7eb;
      --brand: #1f6aa5;
      --brand2: #114a75;
      --danger: #b42318;
      --shadow: 0 10px 30px rgba(16,24,40,.08);
      --radius: 14px;
      --ok: #16a34a;
      --warn: #f59e0b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 18px;
    }
    .topbar{
      max-width: 1200px;
      margin: 0 auto 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand h1{ font-size: 16px; margin:0; }
    .meta{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }

    .chip{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--muted);
      box-shadow: 0 3px 10px rgba(0,0,0,.03);
      white-space:nowrap;
      display:flex;
      flex-direction:column;
      gap:4px;
      line-height:1.2;
    }
    .chip b{ color: var(--text); }
    .chip .line{ display:flex; gap:6px; align-items:baseline; }
    .chip .line span{ color: var(--muted); }
    .chip .line small{ color: var(--muted); font-weight:700; }

    .btn{
      border: 1px solid var(--line);
      background: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 800;
      color: var(--text);
    }
    .btn:hover{ filter: brightness(.98); }
    .btn.primary{
      background: var(--brand);
      color:#fff;
      border-color: var(--brand);
    }
    .btn.primary:hover{ background: var(--brand2); border-color: var(--brand2); }
    .btn.danger{ color: var(--danger); border-color:#f2c6c6; }
    .btn.small{ padding: 8px 10px; font-size: 12px; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .container{
      max-width: 1200px;
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .header{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      background:#fff;
    }
    .header .title{ font-weight:900; font-size: 14px; }
    .section{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      background: #fff;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
    }
    .ctrl label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin-bottom:6px;
      font-weight:700;
    }
    input, select{
      width:100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      font-size: 14px;
      background:#fff;
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .kpi{
      border: 1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      box-shadow: 0 3px 10px rgba(0,0,0,.03);
      padding: 12px;
      min-height: 86px;
    }
    .kpi .k{ color: var(--muted); font-size: 12px; font-weight: 800; }
    .kpi .v{ margin-top: 8px; font-size: 18px; font-weight: 900; }
    .kpi .s{ margin-top: 6px; color: var(--muted); font-size: 12px; }
    .kpi .row{
      margin-top: 8px;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .kpi .row .line{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      font-size: 12.5px;
      color: var(--muted);
      font-weight: 800;
    }
    .kpi .row .line b{ color: var(--text); font-weight: 900; }
    .kpi .row .line .mono{ font-weight: 900; color: var(--text); }

    .cards{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
    }
    .card{
      border: 1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      box-shadow: 0 3px 10px rgba(0,0,0,.03);
      padding: 12px;
      overflow:hidden;
    }
    .card h3{
      margin:0 0 10px 0;
      font-size: 13px;
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .sub{
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
    }

    table{ width:100%; border-collapse: collapse; }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--line);
      text-align:left;
      vertical-align: middle;
      font-size: 12.5px;
    }
    th{
      font-size: 12px;
      color: var(--muted);
      background: #fafafa;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .empty{ color: var(--muted); text-align:center; padding: 18px; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid var(--line);
      background:#fff;
      color: var(--text);
      white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(22,163,74,.25); color: var(--ok); }
    .pill.warn{ border-color: rgba(245,158,11,.25); color: var(--warn); }

    .footer{
      padding: 12px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      color: var(--muted);
      font-size: 12px;
      border-top: 1px solid var(--line);
      background: #fff;
    }

    #toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      box-shadow: var(--shadow);
      font-weight: 800;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .15s ease, transform .15s ease;
      pointer-events: none;
      max-width: 420px;
      white-space: pre-wrap;
      z-index: 99;
    }
    #toast.show{ opacity: 1; transform: translateY(0); }
    #toast[data-type="ok"]{ border-color: #b7e4c7; }
    #toast[data-type="err"]{ border-color: #f2c6c6; }
    #toast[data-type="warn"]{ border-color: #ffe7b3; }

    .row-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    /* =========================
       ‚úÖ MODAL (Ver factura)
       ========================= */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 999;
    }
    .modal{
      width: min(1100px, 100%);
      max-height: 92vh;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modal-header{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      background:#fff;
    }
    .modal-header .title{
      font-weight: 900;
    }
    .modal-body{
      padding: 14px;
      overflow:auto;
      background:#fff;
    }
    .invoice{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
    }
    .inv-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid var(--line);
      padding-bottom: 10px;
      margin-bottom: 10px;
    }
    .inv-top h2{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .inv-top .meta{
      text-align:right;
      font-size: 12px;
      color: var(--muted);
      line-height:1.3;
    }
    .inv-grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }
    .ibox{
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 10px;
      background:#fff;
      min-height: 54px;
    }
    .ibox .k{ font-size: 11px; color: var(--muted); font-weight: 800; }
    .ibox .v{ margin-top: 6px; font-size: 13px; font-weight: 900; color: var(--text); }
    .inv-sum{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .badge{
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      font-weight: 900;
      background:#fff;
      color: var(--text);
      display:flex;
      gap: 8px;
      align-items:baseline;
      white-space:nowrap;
    }
    .badge .k{ color: var(--muted); font-weight: 900; }
    @media print{
      body{ background:#fff; padding:0; }
      .topbar, .container, #toast{ display:none !important; }
      .modal-backdrop{ display:block !important; position: static; background: #fff; padding:0; }
      .modal{ width:100%; max-height:none; border:none; border-radius:0; box-shadow:none; }
      .modal-header{ display:none; }
      .modal-body{ padding:0; }
      .invoice{ border:none; border-radius:0; }
    }

    @media (max-width: 1050px){
      .kpis{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 720px){
      .kpis{ grid-template-columns: 1fr; }
      .header{ align-items:flex-start; flex-direction:column; }
    }
  
    .totals-card{
      border: 1px solid var(--line);
      border-radius: 14px;
      background:#fff;
      padding: 10px 12px;
      min-width: 280px;
      box-shadow: 0 3px 10px rgba(0,0,0,.03);
    }
    .totals-card .trow{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 14px;
      padding: 4px 0;
      font-size: 12.5px;
      font-weight: 900;
    }
    .totals-card .trow span{ color: var(--text); font-weight: 800; }
    .totals-card .tsep{ border-top: 1px dashed var(--line); margin: 8px 0; }
    .totals-card .trow.total span{ font-size: 13px; font-weight: 900; }
    
  
    .abonos-footer{
      margin-top: 10px;
      border-top: 1px dashed var(--line);
      padding-top: 8px;
      display:flex;
      flex-direction:column;
      gap:6px;
      max-width: 360px;
    }
    .abonos-footer .line{
      display:flex;
      justify-content:space-between;
      font-weight:900;
      font-size:12.5px;
    }
    
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <h1>CL√çNICA ODONTOL√ìGICA ‚Äî Reporte de ventas</h1>
    </div>
    <div class="meta">
      <div class="chip">
        <div class="line"><span>Usuario:</span> <b id="user-email">‚Äî</b></div>
        <div class="line"><small>Rol:</small> <b id="user-role">‚Äî</b></div>
      </div>
      <button class="btn" id="btn-back" type="button">‚¨Ö Volver</button>
      <button class="btn danger" id="btn-logout" type="button">Cerrar sesi√≥n</button>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="title">Dashboard de ventas</div>
      <div class="row-actions">
        <button class="btn" id="btn-this-month" type="button">üìÖ Mes actual</button>
        <button class="btn" id="btn-today" type="button">üìå Hoy</button>
        <button class="btn primary" id="btn-refresh" type="button">üîÑ Actualizar</button>
        <button class="btn" id="btn-export" type="button">‚¨á Excel</button>
      </div>
    </div>

    <div class="section">
      <div class="grid">
        <div class="ctrl" style="grid-column: span 3;">
          <label>Fecha desde</label>
          <input id="fecha_desde" type="date">
        </div>
        <div class="ctrl" style="grid-column: span 3;">
          <label>Fecha hasta</label>
          <input id="fecha_hasta" type="date">
        </div>
        <div class="ctrl" style="grid-column: span 3;">
          <label>Profesional</label>
          <select id="f_profesional">
            <option value="">‚Äî Todos ‚Äî</option>
          </select>
        </div>
        <div class="ctrl" style="grid-column: span 3;">
          <label>M√©todo de pago</label>
          <select id="f_metodo">
            <option value="">‚Äî Todos ‚Äî</option>
            <option value="Efectivo">Efectivo</option>
            <option value="Transferencia">Transferencia</option>
            <option value="Tarjeta">Tarjeta</option>
            <option value="Nequi">Nequi</option>
            <option value="Daviplata">Daviplata</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px; color:var(--muted); font-size:12px;" class="mono">
        Tip: el ‚ÄúTotal facturado (mes actual)‚Äù se calcula siempre con el mes actual (aunque filtres otro rango).
      </div>
    </div>

    <div class="section">
      <div class="kpis">
        <div class="kpi">
          <div class="k">Total facturado (filtro)</div>
          <div class="v mono">$ <span id="k_total_filtro">0</span></div>
          <div class="s" id="k_total_filtro_s">‚Äî</div>
        </div>

        <div class="kpi">
          <div class="k">Total facturado (mes actual)</div>
          <div class="v mono">$ <span id="k_total_mes">0</span></div>
          <div class="s" id="k_total_mes_s">‚Äî</div>
        </div>

        <!-- ‚úÖ AJUSTADO: incluye total de SALDO pendiente -->
        <div class="kpi">
          <div class="k">Facturas (filtro)</div>
          <div class="row">
            <div class="line">
              <span>‚ö†Ô∏è Pendientes:</span>
              <span>
                <b id="k_pendientes">0</b> ‚Ä¢
                <span class="mono">$ <span id="k_saldo_pendiente_total">0</span></span>
              </span>
            </div>
            <div class="line">
              <span>‚úÖ Pagadas:</span>
              <span><b id="k_pagadas">0</b> ‚Ä¢ <span class="mono">$ <span id="k_total_pagadas">0</span></span></span>
            </div>
          </div>
          <div class="s">Pendientes: suma de <b>saldo_pendiente</b> (filtro actual).</div>
        </div>

        <div class="kpi">
          <div class="k">Procedimiento m√°s vendido (filtro)</div>
          <div class="v" id="k_top_proc">‚Äî</div>
          <div class="s">Unidades: <b id="k_top_proc_qty">0</b> ‚Ä¢ Ingreso: <b class="mono">$ <span id="k_top_proc_rev">0</span></b></div>
        </div>
      </div>
    </div>
    <!-- =========================
         ‚úÖ NUEVA SECCI√ìN: GASTOS (KPIs)
         ========================= -->
    <div class="section" id="section_gastos">
      <div style="display:flex; align-items:baseline; justify-content:space-between; gap:10px; margin-bottom:10px;">
        <div style="font-weight:900; font-size:18px;">Gastos</div>
        <div class="mono" style="color:var(--muted); font-size:12px;" id="k_gastos_sub">‚Äî</div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="k">üí∞ Total gastos del mes</div>
          <div class="v mono">$ <span id="k_gastos_mes">0</span></div>
          <div class="s" id="k_gastos_mes_s">‚Äî</div>
        </div>

        <div class="kpi">
          <div class="k">üìâ Variaci√≥n vs mes anterior</div>
          <div class="v mono"><span id="k_gastos_var_pct">0</span>%</div>
          <div class="s" id="k_gastos_var_s">‚Äî</div>
        </div>

        <div class="kpi">
          <div class="k">üìä Gasto promedio diario</div>
          <div class="v mono">$ <span id="k_gastos_prom_dia">0</span></div>
          <div class="s" id="k_gastos_prom_s">‚Äî</div>
        </div>

        <div class="kpi">
          <div class="k">üíµ Ingresos (abonos en rango)</div>
          <div class="v mono">$ <span id="k_ingresos_rango">0</span></div>
          <div class="s" id="k_ingresos_rango_s">‚Äî</div>
        </div>

        <div class="kpi">
          <div class="k">üßÆ Ingreso - Gastos (rango)</div>
          <div class="v mono">$ <span id="k_ingreso_menos_gasto">0</span></div>
          <div class="s" id="k_ingreso_menos_gasto_s">‚Äî</div>
        </div>

        <div class="kpi">
          <div class="k">‚öñÔ∏è Relaci√≥n gastos / ingresos (rango)</div>
          <div class="v mono"><span id="k_rel_gastos_ingresos">0</span>%</div>
          <div class="s" id="k_rel_gastos_ingresos_s">‚Äî</div>
        </div>
      </div>
    
    <!-- =========================
         ‚úÖ NUEVA SECCI√ìN: COSTOS (KPIs)
         ========================= -->
    <div class="section" id="section_costos">
      <div style="display:flex; align-items:baseline; justify-content:space-between; gap:10px; margin-bottom:10px;">
        <div style="font-weight:900; font-size:18px;">Costos</div>
        <div class="mono" style="color:var(--muted); font-size:12px;" id="k_costos_sub">‚Äî</div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="k">üßæ Total costos (rango)</div>
          <div class="v mono">$ <span id="k_costos_total">0</span></div>
          <div class="s" id="k_costos_total_s">‚Äî</div>
        </div>
      </div>
    </div>

</div>


    <div class="section">
      <div class="cards">
        <div class="card" style="grid-column: span 8;">
          <h3>
            <span>Ingresos por d√≠a (filtro)</span>
            <span class="sub" id="sub_line">‚Äî</span>
          </h3>
          <canvas id="chart_line" height="120"></canvas>
        </div>
        <div class="card" style="grid-column: span 4;">
          <h3>
            <span>Pagadas vs Pendientes</span>
            <span class="sub" id="sub_donut">‚Äî</span>
          </h3>
          <canvas id="chart_donut" height="160"></canvas>
        </div>

        <div class="card" style="grid-column: span 7;">
          <h3>
            <span>Top 10 procedimientos (por unidades)</span>
            <span class="sub" id="sub_top_proc">‚Äî</span>
          </h3>
          <canvas id="chart_bar" height="130"></canvas>
        </div>
        <div class="card" style="grid-column: span 5;">
          <h3>
            <span>M√©todos de pago (por facturas)</span>
            <span class="sub" id="sub_pie">‚Äî</span>
          </h3>
          <canvas id="chart_pie" height="160"></canvas>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="cards">
        <div class="card" style="grid-column: span 12;">
          <h3>
            <span>Facturas del filtro</span>
            <span class="sub">Acci√≥n r√°pida: ver pendientes</span>
          </h3>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
            <button class="btn small" id="btn-show-all" type="button">üìÑ Todas</button>
            <button class="btn small" id="btn-show-pending" type="button">‚ö†Ô∏è Solo pendientes</button>
            <button class="btn small" id="btn-show-paid" type="button">‚úÖ Solo pagadas</button>
          </div>

          <!-- ‚úÖ total de la vista (seg√∫n bot√≥n: todas/pendientes/pagadas) -->
          <div class="mono" id="view_total_line" style="margin:-2px 0 10px 0; color:var(--muted);">
            Mostrando: ‚Äî ‚Ä¢ Total: $ 0
          </div>

          <div style="max-height: 52vh; overflow:auto; border:1px solid var(--line); border-radius: 12px;">
            <table>
              <thead>
                <tr>
                  <th style="width:150px;">Fecha</th>
                  <th style="width:220px;">N¬∞ Factura</th>
                  <th>Paciente</th>
                  <th style="width:160px;">C√©dula</th>
                  <th style="width:140px;">Estado</th>
                  <th style="width:170px;">M√©todo</th>
                  <th style="width:160px;">Total</th>
                  <th style="width:180px;">Saldo pendiente</th>
                  <th style="width:170px;">Acciones</th>
                </tr>
              </thead>
              <tbody id="tbody_facturas">
                <tr><td colspan="9" class="empty">Cargando...</td></tr>
              </tbody>
            </table>
          </div>

          <div class="mono" style="margin-top:10px; color:var(--muted);">
            Nota: ‚Äúprocedimiento m√°s vendido‚Äù se calcula sumando cantidades en <b>factura_detalle</b> para las facturas del filtro.
          </div>
        </div>
      </div>
    </div>

    
    <!-- =========================
         ‚úÖ NUEVA SECCI√ìN: ABONOS
         ========================= -->
    <div class="section">
      <div class="cards">
        <div class="card" style="grid-column: span 4;">
          <h3>
            <span>Total abonado (mes seleccionado)</span>
            <span class="sub" id="sub_abonos_mes">‚Äî</span>
          </h3>
          <div class="kpi">
            <div class="k">Total abonos</div>
            <div class="v mono">$ <span id="k_abonos_mes">0</span></div>
            <div class="s">Suma de todos los abonos del mes</div>
          </div>
        </div>

        <div class="card" style="grid-column: span 8;">
          <h3>
            <span>Abonos por d√≠a</span>
            <span class="sub">Selecciona una fecha</span>
          </h3>

          <div class="grid" style="margin-bottom:10px;">
            <div class="ctrl" style="grid-column: span 4;">
              <label>Fecha</label>
              <input id="fecha_abonos_dia" type="date">
            </div>
          </div>

          <div class="mono" id="abonos_dia_resumen" style="margin-bottom:8px; color:var(--muted);">
            ‚Äî
          </div>

          <div style="max-height: 40vh; overflow:auto; border:1px solid var(--line); border-radius: 12px;">
            <table>
              <thead>
                <tr>
                  <th style="width:150px;">Fecha</th>
                  <th>Paciente</th>
                  <th style="width:180px;">Factura</th>
                  <th style="width:160px;">Monto</th>
                </tr>
              </thead>
              <tbody id="tbody_abonos_dia">
                <tr><td colspan="4" class="empty">Selecciona una fecha</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- =========================
     ‚úÖ REPORTE DE ABONOS (DEPENDIENTE DE FILTRO)
     ========================= -->
<div class="section">
  <div class="card">

    <div style="font-weight:900; font-size:18px; margin-bottom:10px;">
      Reporte de Abonos
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Paciente</th>
          <th>Factura</th>
          <th>Monto</th>
        </tr>
      </thead>
      <tbody id="tabla_abonos">
        <tr>
          <td colspan="4" class="muted">Sin datos</td>
        </tr>
      </tbody>
    </table>

  </div>
</div>

<div class="footer">
  <div class="mono" id="status"></div>
  <div>¬© <span id="year"></span></div>
</div>


    <div class="footer">
      <div class="mono" id="status"></div>
      <div>¬© <span id="year"></span></div>
    </div>
  </div>

  <div id="toast" data-type="ok"></div>

  <!-- ‚úÖ MODAL: VER FACTURA -->
  <div class="modal-backdrop" id="modalFacturaBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalFacturaTitle">
      <div class="modal-header">
        <div class="title" id="modalFacturaTitle">Factura</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn" id="btnPrintFactura" type="button">üñ® Imprimir</button>
          <button class="btn danger" id="btnCloseFactura" type="button">‚úñ Cerrar</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="facturaPreview" class="invoice">
          Cargando...
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // ‚úÖ DEBUG GLOBAL (para que NO ‚Äúse muera‚Äù silencioso)
    // =========================
    window.addEventListener("error", (e) => {
      console.error("JS ERROR:", e?.error || e?.message || e);
      try{
        const el = document.getElementById("toast");
        if (el){
          el.textContent = "Error JS: revisa consola (F12)\\n" + (e?.message || "Error");
          el.dataset.type = "err";
          el.classList.add("show");
          clearTimeout(window.__t);
          window.__t = setTimeout(()=> el.classList.remove("show"), 4500);
        }
      }catch(_){}
    });

    // =========================
    // ‚úÖ SUPABASE CLIENT (UMD)
    // =========================
    const SUPABASE_URL = "https://dmcfrmpqlkrqbpjhrfyo.supabase.co".trim();
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRtY2ZybXBxbGtycWJwamhyZnlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzU0MDIsImV4cCI6MjA3ODUxMTQwMn0.YY_6t_lCTs5mK-a_eEdBFa6l9_NBM3B4YDtWOXayCBE".trim();

    if (!window.supabase){
      console.error("Supabase UMD no carg√≥ (CDN bloqueado?)");
    }

    const supabase = window.supabase?.createClient
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    // =========================
    // ‚úÖ CONFIG
    // =========================
    const LOGIN_URL = "https://cacg1022.github.io/ODONTOLOGIA/login.html";
    const INDEX_URL = "https://cacg1022.github.io/ODONTOLOGIA/index.html";

    // ‚úÖ MODULO (debe coincidir EXACTO con modulos_permisos.modulo)
    const MODULO = "reportes";

    const state = {
      session: null,
      role: null,
      profesionales: [],
      facturasFiltro: [],
      detalleFiltro: [],
      _view: "all",
      charts: { line:null, donut:null, bar:null, pie:null }
    };

    const $ = (id) => document.getElementById(id);

    function toast(msg, type="ok"){
      const el = $("toast");
      el.textContent = msg;
      el.dataset.type = type;
      el.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=> el.classList.remove("show"), 2600);
    }
    function setStatus(msg){
      const el = $("status");
      if (el) el.textContent = msg || "";
    }
    function money(n){
      const x = Number(n || 0);
      return x.toLocaleString("es-CO");
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function hoyISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function firstDayOfMonthISO(d = new Date()){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      return `${yyyy}-${mm}-01`;
    }
    function lastDayOfMonthISO(d = new Date()){
      const yyyy = d.getFullYear();
      const mm = d.getMonth();
      const last = new Date(yyyy, mm+1, 0);
      const m = String(last.getMonth()+1).padStart(2,"0");
      const dd = String(last.getDate()).padStart(2,"0");
      return `${yyyy}-${m}-${dd}`;
    }
    function formatFechaHuman(iso){
      if (!iso) return "‚Äî";
      try{
        const s = String(iso);
        const cut = s.includes("T") ? s.slice(0,10) : s.slice(0,10);
        const d = new Date(cut + "T00:00:00");
        if (Number.isNaN(d.getTime())) return cut || s;
        return d.toLocaleDateString("es-CO", { year:"numeric", month:"2-digit", day:"2-digit" });
      } catch(e){
        return String(iso);
      }
    }
    function dateStartISO(d){ return d ? `${d}T00:00:00.000` : null; }
    function dateEndISO(d){ return d ? `${d}T23:59:59.999` : null; }

    // ‚úÖ saldo_pendiente helper (compatibilidad si hay registros viejos sin la columna)
    function getSaldoPendiente(f){
      const sp = f?.saldo_pendiente;
      if (sp === null || sp === undefined || sp === ""){
        // fallback visual
        if (f?.pagada === true) return 0;
        return Number(f?.valor_total || 0);
      }
      return Number(sp || 0);
    }

    // =========================
    // ‚úÖ AUTH + ROLE
    // =========================
    async function cargarRolActual(){
      const email = (state.session?.user?.email || "").trim().toLowerCase();
      const elRole = $("user-role");
      if (!email){
        state.role = "user";
        if (elRole) elRole.textContent = "user";
        return "user";
      }

      try{
        const { data, error } = await supabase
          .from("profiles")
          .select("role, created_at, email")
          .eq("email", email)
          .order("created_at", { ascending: false })
          .limit(1)
          .maybeSingle();

        if (error) throw error;

        const role = (data?.role || "").toString().trim().toLowerCase();
        const finalRole = role || "user";
        state.role = finalRole;
        if (elRole) elRole.textContent = finalRole;

        return finalRole;
      } catch(err){
        console.error("No se pudo leer rol en profiles:", err);
        state.role = "user";
        if (elRole) elRole.textContent = "user";
        return "user";
      }
    }

    // =========================
    // ‚úÖ VALIDAR PERMISO POR MODULO (modulos_permisos)
    // =========================
    async function validarPermisoModulo(){
      const rol = (state.role || "user").toString().trim().toLowerCase();

      const { data: permiso, error: ePerm } = await supabase
        .from("modulos_permisos")
        .select("admin, doctor, auxiliar, paciente")
        .eq("modulo", MODULO)
        .maybeSingle();

      if (ePerm){
        console.error("‚ùå Error leyendo modulos_permisos:", ePerm);
        alert("Error leyendo permisos del m√≥dulo.");
        window.location.href = INDEX_URL;
        return false;
      }

      if (!permiso){
        console.warn("‚ö†Ô∏è No existe fila en modulos_permisos para modulo =", MODULO);
        alert("M√≥dulo no configurado en permisos.");
        window.location.href = INDEX_URL;
        return false;
      }

      if (!permiso[rol]){
        alert("‚õî No tienes permiso para acceder a este m√≥dulo.");
        window.location.href = INDEX_URL;
        return false;
      }

      console.log("‚úÖ Acceso permitido a:", MODULO, "Rol:", rol);
      return true;
    }

    async function proteger(){
      if (!supabase){
        toast("No carg√≥ Supabase (CDN). Revisa tu conexi√≥n o bloqueadores.", "err");
        return false;
      }

      const { data, error } = await supabase.auth.getSession();
      if (error){
        console.error("getSession error:", error);
      }

      const session = data?.session;
      if(!session){
        window.location.href = LOGIN_URL;
        return false;
      }

      state.session = session;
      $("user-email").textContent = (session.user?.email || "Usuario").toString();

      await cargarRolActual();

      // ‚úÖ permiso depende de modulos_permisos
      const okPerm = await validarPermisoModulo();
      if (!okPerm) return false;

      return true;
    }

    function bindAuthListener(){
      if (!supabase) return;
      supabase.auth.onAuthStateChange((event, session) => {
        if ((event === "SIGNED_OUT" || event === "USER_DELETED") && !session) {
          window.location.href = LOGIN_URL;
        }
        if ((event === "SIGNED_IN" || event === "TOKEN_REFRESHED") && session) {
          state.session = session;
          $("user-email").textContent = session.user?.email || "Usuario";
          cargarRolActual().then(()=> validarPermisoModulo());
        }
      });
    }

    async function cerrarSesion(){
      try { await supabase.auth.signOut(); } catch(e) {}
      window.location.href = LOGIN_URL;
    }

    // =========================
    // ‚úÖ DATA LOADERS
    // =========================
    async function cargarProfesionales(){
      const { data, error } = await supabase
        .from("profesionales")
        .select("id, cedula, nombre, activo")
        .order("nombre", { ascending: true });

      if (error){
        console.error(error);
        toast("Error profesionales:\\n" + error.message, "err");
        state.profesionales = [];
        renderProfesionales();
        return;
      }

      const rows = data || [];
      state.profesionales = rows.filter(r => (r.activo === null || r.activo === undefined) ? true : r.activo === true);
      renderProfesionales();
    }

    function renderProfesionales(){
      const sel = $("f_profesional");
      sel.innerHTML = `<option value="">‚Äî Todos ‚Äî</option>`;
      for (const pr of state.profesionales){
        const ced = (pr.cedula ?? "").toString().trim();
        const nom = (pr.nombre ?? "").toString().trim();
        const opt = document.createElement("option");
        opt.value = ced ? ced : nom;
        opt.textContent = nom || ced || "‚Äî";
        sel.appendChild(opt);
      }
    }

    async function cargarFacturasFiltro(){
      const desde = ($("fecha_desde").value || "").trim();
      const hasta = ($("fecha_hasta").value || "").trim();
      const profesional = ($("f_profesional").value || "").trim();
      const metodo = ($("f_metodo").value || "").trim();

      setStatus("Cargando facturas (filtro)...");
      try{
        let query = supabase
          .from("facturas")
          .select("id, fecha, numero_factura, paciente_nombre, paciente_cedula, paciente_correo, tipo_usuario, eps, profesional, metodo_pago, observacion, pagada, fecha_pago, referencia_pago, subtotal, iva_aplica, iva_porcentaje, iva_valor, descuento_pct, descuento_valor, copago, cuota_moderadora, valor_total, saldo_pendiente")
          .order("fecha", { ascending: true });

        if (desde) query = query.gte("fecha", dateStartISO(desde));
        if (hasta) query = query.lte("fecha", dateEndISO(hasta));
        if (profesional) query = query.eq("profesional", profesional);
        if (metodo) query = query.eq("metodo_pago", metodo);

        const { data, error } = await query;
        if (error) throw error;

        state.facturasFiltro = data || [];
        setStatus("");
      } catch(err){
        console.error("cargarFacturasFiltro:", err);
        setStatus("");
        toast("No se pudieron cargar facturas (posible RLS o columnas faltantes):\\n" + (err?.message || "Error"), "err");
        state.facturasFiltro = [];
      }
    }

    async function cargarDetalleFiltro(){
      setStatus("Cargando detalle (procedimientos)...");
      try{
        const ids = (state.facturasFiltro || []).map(f => f.id);
        if (!ids.length){
          state.detalleFiltro = [];
          setStatus("");
          return;
        }

        const { data, error } = await supabase
          .from("factura_detalle")
          .select("factura_id, descripcion, cantidad, valor_total, valor_unitario, codigo_cups")
          .in("factura_id", ids);

        if (error) throw error;

        state.detalleFiltro = data || [];
        setStatus("");
      } catch(err){
        console.error("cargarDetalleFiltro:", err);
        setStatus("");
        toast("No se pudo cargar detalle (posible RLS):\\n" + (err?.message || "Error"), "err");
        state.detalleFiltro = [];
      }
    }

    async function cargarTotalMesActual(){
      const d = new Date();
      const desde = firstDayOfMonthISO(d);
      const hasta = lastDayOfMonthISO(d);

      try{
        const { data, error } = await supabase
          .from("facturas")
          .select("valor_total")
          .gte("fecha", dateStartISO(desde))
          .lte("fecha", dateEndISO(hasta));

        if (error) throw error;

        const total = (data || []).reduce((acc, r) => acc + (Number(r.valor_total) || 0), 0);
        $("k_total_mes").textContent = money(total);
        $("k_total_mes_s").textContent = `Mes: ${formatFechaHuman(desde)} ‚Üí ${formatFechaHuman(hasta)}`;
      } catch(err){
        console.error("cargarTotalMesActual:", err);
        $("k_total_mes").textContent = "0";
        $("k_total_mes_s").textContent = "No disponible (RLS?)";
      }
    }

    // =========================
    // ‚úÖ RENDER
    // =========================
    function pagoPill(pagada){
      if (pagada === true) return `<span class="pill ok">‚úÖ Pagada</span>`;
      if (pagada === false) return `<span class="pill warn">‚ö†Ô∏è Pendiente</span>`;
      return `<span class="pill">‚Äî</span>`;
    }

    function renderTablaFacturas(){
      const tbody = $("tbody_facturas");
      tbody.innerHTML = "";

      let rows = [...(state.facturasFiltro || [])];
      let viewName = "Todas";

      if (state._view === "pending"){
        rows = rows.filter(f => f.pagada === false);
        viewName = "Solo pendientes";
      }
      if (state._view === "paid"){
        rows = rows.filter(f => f.pagada === true);
        viewName = "Solo pagadas";
      }

      const totalVista = rows.reduce((acc,f) => acc + (Number(f.valor_total) || 0), 0);
      const viewLine = $("view_total_line");
      if (viewLine){
        viewLine.textContent = `Mostrando: ${viewName} (${rows.length}) ‚Ä¢ Total: $ ${money(totalVista)}`;
      }

      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="9" class="empty">No hay facturas para mostrar.</td></tr>`;
        return;
      }

      for (const f of rows){
        const saldo = getSaldoPendiente(f);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${escapeHtml(formatFechaHuman(f.fecha))}</td>
          <td class="mono">${escapeHtml(f.numero_factura || "‚Äî")}</td>
          <td>${escapeHtml(f.paciente_nombre || "‚Äî")}</td>
          <td class="mono">${escapeHtml(f.paciente_cedula || "‚Äî")}</td>
          <td>${pagoPill(f.pagada)}</td>
          <td class="mono">${escapeHtml(f.metodo_pago || "‚Äî")}</td>
          <td class="mono">$ ${escapeHtml(money(f.valor_total || 0))}</td>
          <td class="mono">$ ${escapeHtml(money(saldo))}</td>
          <td>
            <button class="btn small" type="button" data-action="ver-factura" data-id="${escapeHtml(f.id)}">üëÅ Ver factura</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    function calcKPIs(){
      const rows = state.facturasFiltro || [];
      const totalFiltro = rows.reduce((acc,f) => acc + (Number(f.valor_total) || 0), 0);

      const pendientesRows = rows.filter(f => f.pagada === false);
      const pagadasRows = rows.filter(f => f.pagada === true);

      const pendientes = pendientesRows.length;
      const pagadas = pagadasRows.length;

      // ‚úÖ requerido: total en dinero de facturas con saldos pendientes (suma saldo_pendiente)
      const saldoPendienteTotal = pendientesRows.reduce((acc,f)=> acc + getSaldoPendiente(f), 0);

      const totalPagadas = pagadasRows.reduce((acc,f)=> acc + (Number(f.valor_total) || 0), 0);

      $("k_total_filtro").textContent = money(totalFiltro);
      const desde = ($("fecha_desde").value || "").trim();
      const hasta = ($("fecha_hasta").value || "").trim();
      $("k_total_filtro_s").textContent =
        (desde || hasta) ? `Rango: ${formatFechaHuman(desde)} ‚Üí ${formatFechaHuman(hasta)}` : "Rango: (sin filtro)";

      $("k_pendientes").textContent = String(pendientes);
      $("k_pagadas").textContent = String(pagadas);

      $("k_saldo_pendiente_total").textContent = money(saldoPendienteTotal);
      $("k_total_pagadas").textContent = money(totalPagadas);

      const det = state.detalleFiltro || [];
      const map = new Map();
      for (const it of det){
        const desc = (it.descripcion || "‚Äî").toString().trim() || "‚Äî";
        const qty = Number(it.cantidad || 0);
        const rev = Number(it.valor_total || 0);
        const cur = map.get(desc) || { desc, qty: 0, rev: 0 };
        cur.qty += qty;
        cur.rev += rev;
        map.set(desc, cur);
      }
      const arr = Array.from(map.values()).sort((a,b)=> b.qty - a.qty);
      const top = arr[0] || null;

      if (!top){
        $("k_top_proc").textContent = "‚Äî";
        $("k_top_proc_qty").textContent = "0";
        $("k_top_proc_rev").textContent = "0";
      } else {
        $("k_top_proc").textContent = top.desc;
        $("k_top_proc_qty").textContent = String(top.qty);
        $("k_top_proc_rev").textContent = money(top.rev);
      }

      return { totalFiltro, pendientes, pagadas, topProcArr: arr };
    }

    function groupRevenueByDay(){
      const rows = state.facturasFiltro || [];
      const map = new Map();
      for (const f of rows){
        const s = String(f.fecha || "");
        const iso = s.includes("T") ? s.slice(0,10) : s.slice(0,10);
        if (!iso) continue;
        map.set(iso, (map.get(iso)||0) + (Number(f.valor_total)||0));
      }
      const labels = Array.from(map.keys()).sort();
      return { labels, values: labels.map(k => map.get(k) || 0) };
    }

    function groupMetodoPago(){
      const rows = state.facturasFiltro || [];
      const map = new Map();
      for (const f of rows){
        const k = (f.metodo_pago || "‚Äî").toString().trim() || "‚Äî";
        map.set(k, (map.get(k)||0) + 1);
      }
      const labels = Array.from(map.keys()).sort((a,b)=> (map.get(b)||0) - (map.get(a)||0));
      return { labels, values: labels.map(l => map.get(l)||0) };
    }

    function destroyChart(ch){
      try{ if (ch) ch.destroy(); } catch(e) {}
    }

    function renderCharts(kpi){
      if (!window.Chart){
        console.error("Chart.js no carg√≥");
        return;
      }

      const line = groupRevenueByDay();
      $("sub_line").textContent = `${line.labels.length} d√≠a(s)`;

      destroyChart(state.charts.line);
      state.charts.line = new Chart($("chart_line"), {
        type: "line",
        data: {
          labels: line.labels,
          datasets: [{ label: "Total por d√≠a", data: line.values }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { y: { ticks: { callback: (v)=> "$ " + money(v) } } }
        }
      });

      $("sub_donut").textContent = `Pagadas: ${kpi.pagadas} ‚Ä¢ Pendientes: ${kpi.pendientes}`;
      destroyChart(state.charts.donut);
      state.charts.donut = new Chart($("chart_donut"), {
        type: "doughnut",
        data: {
          labels: ["Pagadas", "Pendientes"],
          datasets: [{ data: [kpi.pagadas, kpi.pendientes] }]
        },
        options: { responsive: true, plugins: { legend: { display: true } } }
      });

      const top10 = (kpi.topProcArr || []).slice(0, 10);
      $("sub_top_proc").textContent = `${top10.length} item(s)`;
      destroyChart(state.charts.bar);
      state.charts.bar = new Chart($("chart_bar"), {
        type: "bar",
        data: {
          labels: top10.map(x => x.desc.length > 28 ? (x.desc.slice(0,28) + "‚Ä¶") : x.desc),
          datasets: [{ label: "Unidades", data: top10.map(x => x.qty) }]
        },
        options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
      });

      const pie = groupMetodoPago();
      $("sub_pie").textContent = `${pie.labels.length} m√©todo(s)`;
      destroyChart(state.charts.pie);
      state.charts.pie = new Chart($("chart_pie"), {
        type: "pie",
        data: { labels: pie.labels, datasets: [{ data: pie.values }] },
        options: { responsive: true, plugins: { legend: { display: true } } }
      });
    }

    // =========================
    // ‚úÖ MODAL FACTURA
    // =========================
    function openFacturaModal(){
      const bd = $("modalFacturaBackdrop");
      bd.style.display = "flex";
      bd.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }
    function closeFacturaModal(){
      const bd = $("modalFacturaBackdrop");
      bd.style.display = "none";
      bd.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      $("facturaPreview").innerHTML = "‚Äî";
    }

    async function verFacturaPorId(facturaId){
      const f = (state.facturasFiltro || []).find(x => String(x.id) === String(facturaId));
      if (!f){
        toast("No encontr√© esa factura en el filtro actual.", "warn");
        return;
      }

      openFacturaModal();
      $("facturaPreview").innerHTML = "Cargando...";

      // detalle
      let detalle = [];
      try{
        const { data, error } = await supabase
          .from("factura_detalle")
          .select("codigo_cups, descripcion, cantidad, valor_unitario, valor_total")
          .eq("factura_id", f.id)
          .order("descripcion", { ascending: true });
        if (error) throw error;
        detalle = data || [];
      }catch(err){
        console.warn("No se pudo cargar factura_detalle:", err);
        detalle = [];
      }

      // abonos (opcional)
      let abonos = [];
      try{
        // ‚úÖ Intento principal: columna metodo_pago (como en facturaci√≥n)
        let { data, error } = await supabase
          .from("abonos")
          .select("fecha, monto, metodo_pago, referencia, observacion")
          .eq("factura_id", f.id)
          .order("fecha", { ascending: true });

        // ‚úÖ Compatibilidad: algunos esquemas podr√≠an usar 'metodo' en vez de 'metodo_pago'
        if (error){
          const msg = String(error.message || "").toLowerCase();
          const maybeMetodoPagoMissing =
            msg.includes("column") && msg.includes("metodo_pago");
          if (maybeMetodoPagoMissing){
            const r2 = await supabase
              .from("abonos")
              .select("fecha, monto, metodo, referencia, observacion")
              .eq("factura_id", f.id)
              .order("fecha", { ascending: true });
            data = r2.data;
            error = r2.error;
          }
        }

        if (error) throw error;
        abonos = data || [];
      }catch(err){
        // si no existe la tabla o RLS, no rompemos
        abonos = [];
      }

      const total = Number(f.valor_total || 0);
      const totalAbonos = (abonos || []).reduce((acc,a)=> acc + (Number(a.monto)||0), 0);
      const saldo = (f.saldo_pendiente === null || f.saldo_pendiente === undefined)
        ? Math.max(0, total - totalAbonos)
        : Number(f.saldo_pendiente || 0);

      const estadoTxt = (saldo <= 0 || f.pagada === true) ? "PAGADA" : "PENDIENTE";

      
      
      const subtotal = Number(f.subtotal ?? 0) 
  || (detalle || []).reduce((acc,it)=> acc + (Number(it.valor_total)||0), 0);

const descuentoPct   = Number(f.descuento_pct ?? 0);
const descuentoValor = Number(f.descuento_valor ?? 0);

const aplicaIVA = (f.iva_aplica === true);
const ivaPct    = Number(f.iva_porcentaje ?? 0);
const ivaValor  = Number(f.iva_valor ?? 0) 
  || (aplicaIVA ? Math.round((subtotal - descuentoValor) * (ivaPct/100)) : 0);

const copago = Number(f.copago ?? 0);
const cuota  = Number(f.cuota_moderadora ?? 0);

const totalCalc = Number(f.valor_total ?? 0) 
  || (subtotal - descuentoValor + ivaValor + copago + cuota);

      



      const detalleRows = (detalle || []).length

        ? (detalle || []).map(it => `
            <tr>
              <td class="mono">${escapeHtml(it.codigo_cups || "‚Äî")}</td>
              <td>${escapeHtml(it.descripcion || "‚Äî")}</td>
              <td class="mono">${escapeHtml(it.cantidad ?? 0)}</td>
              <td class="mono">$ ${escapeHtml(money(it.valor_unitario || 0))}</td>
              <td class="mono">$ ${escapeHtml(money(it.valor_total || 0))}</td>
            </tr>
          `).join("")
        : `<tr><td colspan="5" class="empty">Sin procedimientos.</td></tr>`;

      const abonosRows = (abonos || []).length
        ? (abonos || []).map(a => `
            <tr>
              <td class="mono">${escapeHtml(formatFechaHuman(a.fecha))}</td>
              <td class="mono">$ ${escapeHtml(money(a.monto || 0))}</td>
              <td>${escapeHtml(a.metodo_pago || a.metodo || "‚Äî")}</td>
              <td>${escapeHtml(a.referencia || "‚Äî")}</td>
              <td>${escapeHtml(a.observacion || "‚Äî")}</td>
            </tr>
          `).join("")
        : `<tr><td colspan="5" class="empty">No hay abonos para esta factura.</td></tr>`;

      $("facturaPreview").innerHTML = `
        <div class="inv-top">
          <div>
            <h2>CL√çNICA ODONTOL√ìGICA ‚Äî FACTURA</h2>
            <div class="mono" style="margin-top:6px;">
              N¬∞ Factura: <b>${escapeHtml(f.numero_factura || "‚Äî")}</b><br/>
              Fecha: <b>${escapeHtml(formatFechaHuman(f.fecha))}</b>
            </div>
          </div>
          <div class="meta">
            Estado: <b>${escapeHtml(estadoTxt)}</b><br/>
            M√©todo: <b>${escapeHtml(f.metodo_pago || "‚Äî")}</b><br/>
            Profesional: <b>${escapeHtml(f.profesional || "‚Äî")}</b>
          </div>
        </div>

        <div class="inv-grid">
          <div class="ibox" style="grid-column: span 4;">
            <div class="k">Paciente</div>
            <div class="v">${escapeHtml(f.paciente_nombre || "‚Äî")}</div>
          </div>
          <div class="ibox" style="grid-column: span 2;">
            <div class="k">C√©dula</div>
            <div class="v mono">${escapeHtml(f.paciente_cedula || "‚Äî")}</div>
          </div>
          <div class="ibox" style="grid-column: span 3;">
            <div class="k">Tipo usuario</div>
            <div class="v">${escapeHtml(f.tipo_usuario || "‚Äî")}</div>
          </div>
          <div class="ibox" style="grid-column: span 3;">
            <div class="k">EPS</div>
            <div class="v">${escapeHtml(f.eps || "‚Äî")}</div>
          </div>

          <div class="ibox" style="grid-column: span 3;">
            <div class="k">M√©todo de pago</div>
            <div class="v">${escapeHtml(f.metodo_pago || "‚Äî")}</div>
          </div>
          <div class="ibox" style="grid-column: span 3;">
            <div class="k">Estado de pago</div>
            <div class="v">${escapeHtml(estadoTxt)}</div>
          </div>
          <div class="ibox" style="grid-column: span 3;">
            <div class="k">¬øAplica IVA?</div>
            <div class="v">${aplicaIVA ? "S√≠" : "No"}</div>
          </div>
          <div class="ibox" style="grid-column: span 3;">
            <div class="k">IVA %</div>
            <div class="v">${escapeHtml(ivaPct)}</div>
          </div>
        </div>

        <div class="inv-grid">
          <div class="ibox" style="grid-column: span 6;">
            <div class="k">Paciente</div>
            <div class="v">${escapeHtml(f.paciente_nombre || "‚Äî")}</div>
          </div>
          <div class="ibox" style="grid-column: span 3;">
            <div class="k">C√©dula</div>
            <div class="v mono">${escapeHtml(f.paciente_cedula || "‚Äî")}</div>
          </div>
          <div class="ibox" style="grid-column: span 3;">
            <div class="k">Referencia</div>
            <div class="v mono">${escapeHtml(f.referencia_pago || "‚Äî")}</div>
          </div>
        </div>

        <div style="border:1px solid var(--line); border-radius:12px; overflow:hidden;">
          <table>
            <thead>
              <tr>
                <th style="width:120px;">CUPS</th>
                <th>Procedimiento</th>
                <th style="width:90px;">Cant</th>
                <th style="width:140px;">V/Unit</th>
                <th style="width:140px;">Total</th>
              </tr>
            </thead>
            <tbody>
              ${detalleRows}
            </tbody>
          </table>
        </div>

        <div class="inv-sum">
          <div class="totals-card">
            <div class="trow"><span>Subtotal</span><b class="mono">$ ${escapeHtml(money(subtotal))}</b></div>
            <div class="trow"><span>Descuento (${escapeHtml(descuentoPct)}%)</span><b class="mono">- $ ${escapeHtml(money(descuentoValor))}</b></div>
            <div class="trow"><span>IVA (${escapeHtml(ivaPct)}%)</span><b class="mono">$ ${escapeHtml(money(ivaValor))}</b></div>
            <div class="trow"><span>Copago</span><b class="mono">$ ${escapeHtml(money(copago))}</b></div>
            <div class="trow"><span>Cuota moderadora</span><b class="mono">$ ${escapeHtml(money(cuota))}</b></div>
            <div class="tsep"></div>
            <div class="trow total"><span>TOTAL</span><b class="mono">$ ${escapeHtml(money(totalCalc))}</b></div>
          </div>
        </div>

        <div style="margin-top:12px; border-top:1px solid var(--line); padding-top:12px;">
          <div style="font-weight:900; margin-bottom:8px;">Abonos</div>
          <div style="border:1px solid var(--line); border-radius:12px; overflow:hidden;">
            <table>
              <thead>
                <tr>
                  <th style="width:140px;">Fecha</th>
                  <th style="width:140px;">Monto</th>
                  <th style="width:150px;">M√©todo</th>
                  <th>Referencia</th>
                  <th>Observaci√≥n</th>
                </tr>
              </thead>
              <tbody>
                ${abonosRows}
              </tbody>
            </table>
          </div>
        </div>
          <div class="abonos-footer">
            <div class="line">
              <span>Total abonado</span>
              <b class="mono">$ ${escapeHtml(money(totalAbonos))}</b>
            </div>
            <div class="line">
              <span>Saldo pendiente</span>
              <b class="mono">$ ${escapeHtml(money(Math.max(0, saldo)))}</b>
            </div>
          </div>

      `;
    }

    // =========================
    // ‚úÖ EXPORT EXCEL
    // =========================
    function exportarExcel(){
      try{
        const rows = state.facturasFiltro || [];
        if (!rows.length){
          toast("No hay facturas para exportar con el filtro actual.", "warn");
          return;
        }

        const desde = ($("fecha_desde")?.value || "").trim();
        const hasta = ($("fecha_hasta")?.value || "").trim();
        const profesional = ($("f_profesional")?.value || "").trim();
        const metodo = ($("f_metodo")?.value || "").trim();

        const data = rows.map(f => ({
          "Fecha": formatFechaHuman(f.fecha),
          "N¬∞ Factura": f.numero_factura || "",
          "Paciente": f.paciente_nombre || "",
          "C√©dula": f.paciente_cedula || "",
          "Estado": (f.pagada === true) ? "Pagada" : (f.pagada === false ? "Pendiente" : ""),
          "M√©todo de pago": f.metodo_pago || "",
          "Referencia": f.referencia_pago || "",
          "Total": Number(f.valor_total || 0),
          "Saldo pendiente": Number(getSaldoPendiente(f) || 0),
        }));

        const totalFacturado = rows.reduce((acc, f) => acc + (Number(f.valor_total) || 0), 0);
        const totalSaldoPendiente = rows
          .filter(f => f.pagada === false)
          .reduce((acc,f)=> acc + getSaldoPendiente(f), 0);

        const ws = XLSX.utils.json_to_sheet(data);
        const lastRow = data.length + 2;
        XLSX.utils.sheet_add_aoa(ws, [
          [],
          ["TOTAL FACTURADO (FILTRO)", totalFacturado],
          ["TOTAL SALDO PENDIENTE (FILTRO)", totalSaldoPendiente]
        ], { origin: `A${lastRow}` });

        const ws2 = XLSX.utils.aoa_to_sheet([
          ["Reporte de Ventas - Facturas (Filtro)"],
          ["Generado:", new Date().toLocaleString("es-CO")],
          ["Fecha desde:", desde || "(vac√≠o)"],
          ["Fecha hasta:", hasta || "(vac√≠o)"],
          ["Profesional:", profesional || "(todos)"],
          ["M√©todo:", metodo || "(todos)"],
          ["Cantidad:", rows.length],
          ["Total facturado:", totalFacturado],
          ["Total saldo pendiente:", totalSaldoPendiente]
        ]);

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Facturas");
        XLSX.utils.book_append_sheet(wb, ws2, "Filtros");

        const filename = `reporte_ventas_${(desde||"NA")}_a_${(hasta||"NA")}.xlsx`;
        XLSX.writeFile(wb, filename);
        toast("Excel descargado ‚úÖ", "ok");
      } catch(err){
        console.error(err);
        toast("No se pudo exportar Excel:\\n" + (err?.message || "Error"), "err");
      }
    }

    // =========================
    // ‚úÖ DASHBOARD
    // =========================
    async function refrescarDashboard(){
      await cargarFacturasFiltro();
      await cargarDetalleFiltro();
      await cargarTotalMesActual();

      // ‚úÖ ABONOS
      await cargarTotalAbonosMes();

      const kpi = calcKPIs();
      renderTablaFacturas();
      renderCharts(kpi);

      if ((state.facturasFiltro || []).length === 0){
        setStatus("Sin resultados (si esperabas datos, revisa RLS/permisos en Supabase).");
      } else {
        setStatus("");
      }
    }

    function setRangeMesActual(){
      const d = new Date();
      $("fecha_desde").value = firstDayOfMonthISO(d);
      $("fecha_hasta").value = hoyISO();
    }
    function setRangeHoy(){
      const h = hoyISO();
      $("fecha_desde").value = h;
      $("fecha_hasta").value = h;
    }

    
    // =========================
    // ‚úÖ ABONOS (MES Y POR D√çA)
    // =========================
    async function cargarTotalAbonosMes(){
      const base = ($("fecha_desde").value || hoyISO()).slice(0,7);
      const desde = base + "-01";
      const d = new Date(desde + "T00:00:00");
      const hasta = lastDayOfMonthISO(d);

      try{
        const { data, error } = await supabase
          .from("abonos")
          .select("monto")
          .gte("fecha", desde)
          .lte("fecha", hasta);

        if (error) throw error;

        const total = (data || []).reduce((a,b)=> a + (Number(b.monto)||0), 0);
        $("k_abonos_mes").textContent = money(total);
        $("sub_abonos_mes").textContent = formatFechaHuman(desde) + " ‚Üí " + formatFechaHuman(hasta);
      }catch(err){
        console.error("cargarTotalAbonosMes:", err);
        $("k_abonos_mes").textContent = "0";
        $("sub_abonos_mes").textContent = "No disponible";
      }
    }

    async function cargarAbonosPorDia(){
      const fecha = $("fecha_abonos_dia").value;
      const tbody = $("tbody_abonos_dia");
      tbody.innerHTML = "";

      if (!fecha){
        tbody.innerHTML = `<tr><td colspan="4" class="empty">Selecciona una fecha</td></tr>`;
        return;
      }

      try{
        const { data, error } = await supabase
          .from("abonos")
          .select(`
            fecha,
            monto,
            factura_id,
            facturas:factura_id (
              numero_factura,
              paciente_nombre
            )
          `)
          .eq("fecha", fecha)
          .order("created_at", { ascending:true });

        if (error) throw error;

        const rows = data || [];
        const totalDia = rows.reduce((a,b)=> a + (Number(b.monto)||0), 0);

        $("abonos_dia_resumen").textContent =
          `Total del d√≠a ${formatFechaHuman(fecha)}: $ ${money(totalDia)} ‚Ä¢ Abonos: ${rows.length}`;

        if (!rows.length){
          tbody.innerHTML = `<tr><td colspan="4" class="empty">No hay abonos este d√≠a.</td></tr>`;
          return;
        }

        for (const a of rows){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="mono">${escapeHtml(formatFechaHuman(a.fecha))}</td>
            <td>${escapeHtml(a.facturas?.paciente_nombre || "‚Äî")}</td>
            <td class="mono">${escapeHtml(a.facturas?.numero_factura || "‚Äî")}</td>
            <td class="mono">$ ${escapeHtml(money(a.monto || 0))}</td>
          `;
          tbody.appendChild(tr);
        }
      }catch(err){
        console.error("cargarAbonosPorDia:", err);
        tbody.innerHTML = `<tr><td colspan="4" class="empty">Error cargando abonos.</td></tr>`;
      }
    }



    // =========================
    // ‚úÖ GASTOS (KPIs) ‚Äî SOLO SE AGREGA LO NECESARIO
    // =========================
    function ymFromISO(d){
      const s = String(d || "");
      if (s.length >= 7) return s.slice(0,7);
      return hoyISO().slice(0,7);
    }
    function firstDayOfYM(ym){ return `${ym}-01`; }
    function lastDayOfYM(ym){
      const [y,m] = ym.split("-").map(Number);
      const last = new Date(y, m, 0);
      const mm = String(last.getMonth()+1).padStart(2,"0");
      const dd = String(last.getDate()).padStart(2,"0");
      return `${y}-${mm}-${dd}`;
    }
    function addMonthsYM(ym, delta){
      const [y,m] = ym.split("-").map(Number);
      const d = new Date(y, (m-1) + delta, 1);
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      return `${yy}-${mm}`;
    }
    function daysBetweenInclusive(a,b){
      try{
        const d1 = new Date(a+"T00:00:00");
        const d2 = new Date(b+"T00:00:00");
        const ms = d2.getTime() - d1.getTime();
        if (Number.isNaN(ms)) return 0;
        return Math.floor(ms / 86400000) + 1;
      }catch(_){ return 0; }
    }

    async function actualizarKPIsGastos(){
      // Usa el mismo rango del filtro de reportes para ingresos/gastos (rango)
      const desde = ($("fecha_desde").value || "").trim();
      const hasta = ($("fecha_hasta").value || "").trim();

      // Total gastos del mes: se calcula por mes del "fecha_desde" (o mes actual si vac√≠o)
      const ym = ymFromISO(desde || hoyISO());
      const mesDesde = firstDayOfYM(ym);
      const mesHasta = lastDayOfYM(ym);

      const ymPrev = addMonthsYM(ym, -1);
      const prevDesde = firstDayOfYM(ymPrev);
      const prevHasta = lastDayOfYM(ymPrev);

      // Subt√≠tulo
      const sub = $("k_gastos_sub");
      if (sub){
        sub.textContent = (desde || hasta)
          ? `Rango activo: ${formatFechaHuman(desde)} ‚Üí ${formatFechaHuman(hasta)}`
          : `Rango activo: (sin filtro)`;
      }

      // Defaults UI (no romper si falla)
      const setText = (id, val)=>{ const el = $(id); if (el) el.textContent = val; };

      try{
        // 1) Total gastos mes actual (seg√∫n ym)
        const rMes = await supabase
          .from("gastos")
          .select("monto, fecha")
          .gte("fecha", mesDesde)
          .lte("fecha", mesHasta);

        if (rMes.error) throw rMes.error;

        const totalMes = (rMes.data || []).reduce((acc, x)=> acc + (Number(x.monto)||0), 0);
        setText("k_gastos_mes", money(totalMes));
        setText("k_gastos_mes_s", `Mes: ${formatFechaHuman(mesDesde)} ‚Üí ${formatFechaHuman(mesHasta)}`);

        // 2) Total mes anterior para variaci√≥n
        const rPrev = await supabase
          .from("gastos")
          .select("monto, fecha")
          .gte("fecha", prevDesde)
          .lte("fecha", prevHasta);

        if (rPrev.error) throw rPrev.error;

        const totalPrev = (rPrev.data || []).reduce((acc, x)=> acc + (Number(x.monto)||0), 0);
        const varPct = totalPrev > 0 ? ((totalMes - totalPrev) / totalPrev) * 100 : (totalMes > 0 ? 100 : 0);
        setText("k_gastos_var_pct", (Math.round(varPct * 10) / 10).toString());
        setText("k_gastos_var_s", `Mes anterior: $ ${money(totalPrev)}`);

        // 3) Gastos e ingresos en rango (para promedio/relaci√≥n)
        // rango vac√≠o => usar mes actual
        const rangoDesde = desde || mesDesde;
        const rangoHasta = hasta || mesHasta;

        const dias = Math.max(1, daysBetweenInclusive(rangoDesde, rangoHasta));

        const rGastoRango = await supabase
          .from("gastos")
          .select("monto, fecha")
          .gte("fecha", rangoDesde)
          .lte("fecha", rangoHasta);

        if (rGastoRango.error) throw rGastoRango.error;

        const totalGastoRango = (rGastoRango.data || []).reduce((acc, x)=> acc + (Number(x.monto)||0), 0);
        const promDia = totalGastoRango / dias;
        setText("k_gastos_prom_dia", money(promDia));
        setText("k_gastos_prom_s", `Promedio en ${dias} d√≠a(s)`);

        // Ingresos del rango desde abonos.monto (seg√∫n pedido)
        const rIng = await supabase
          .from("abonos")
          .select("monto, fecha")
          .gte("fecha", rangoDesde)
          .lte("fecha", rangoHasta);

        if (rIng.error) throw rIng.error;

        const ingresosRango = (rIng.data || []).reduce((acc, x)=> acc + (Number(x.monto)||0), 0);
        setText("k_ingresos_rango", money(ingresosRango));
        setText("k_ingresos_rango_s", `Rango: ${formatFechaHuman(rangoDesde)} ‚Üí ${formatFechaHuman(rangoHasta)}`);

        // Ingreso - Gastos
        const neto = ingresosRango - totalGastoRango;
        setText("k_ingreso_menos_gasto", money(neto));
        setText("k_ingreso_menos_gasto_s", `Gastos en rango: $ ${money(totalGastoRango)}`);

        // Relaci√≥n gastos/ingresos
        const rel = ingresosRango > 0 ? (totalGastoRango / ingresosRango) * 100 : 0;
        setText("k_rel_gastos_ingresos", (Math.round(rel * 10) / 10).toString());
        setText("k_rel_gastos_ingresos_s", ingresosRango > 0 ? "Menor es mejor" : "Sin ingresos en rango");

      }catch(err){
        console.error("actualizarKPIsGastos:", err);
        // NO romper el dashboard
        setText("k_gastos_mes", "0");
        setText("k_gastos_var_pct", "0");
        setText("k_gastos_prom_dia", "0");
        setText("k_ingresos_rango", "0");
        setText("k_ingreso_menos_gasto", "0");
        setText("k_rel_gastos_ingresos", "0");
        setText("k_gastos_mes_s", "No disponible (RLS?)");
        setText("k_gastos_var_s", "‚Äî");
        setText("k_gastos_prom_s", "‚Äî");
        setText("k_ingresos_rango_s", "‚Äî");
        setText("k_ingreso_menos_gasto_s", "‚Äî");
        setText("k_rel_gastos_ingresos_s", "‚Äî");
      }
    }

    // ‚úÖ Hook SIN tocar la l√≥gica existente: extendemos refrescarDashboard
    try{
      if (typeof refrescarDashboard === "function"){
        const __refrescarDashboardBase = refrescarDashboard;
        refrescarDashboard = async function(){
          await __refrescarDashboardBase();
          await actualizarKPIsGastos();
        };
      }
    }catch(err){
      console.error("Hook refrescarDashboard (gastos) fall√≥:", err);
    }

    // =========================
    // ‚úÖ REPORTE DE ABONOS (RANGO)
    // =========================
    async function cargarReporteAbonos(){
      const desde = ($("fecha_desde").value || "").trim();
      const hasta = ($("fecha_hasta").value || "").trim();

      if(!desde || !hasta){
        $("tabla_abonos").innerHTML =
          "<tr><td colspan='4' class='muted'>Seleccione un rango de fechas</td></tr>";
        return;
      }

      const { data, error } = await supabase
  .from("abonos")
  .select(`
    fecha,
    monto,
    factura_id,
    facturas (
      numero_factura,
      paciente_nombre
    )
  `)
  .gte("fecha", desde)
  .lte("fecha", hasta)
  .order("fecha", { ascending:false });


      if(error){
        console.error("Reporte abonos:", error);
        $("tabla_abonos").innerHTML =
          "<tr><td colspan='4' class='muted'>Error cargando abonos</td></tr>";
        return;
      }

      if(!data || data.length === 0){
        $("tabla_abonos").innerHTML =
          "<tr><td colspan='4' class='muted'>Sin abonos en el rango</td></tr>";
        return;
      }

      $("tabla_abonos").innerHTML = data.map(a => `
  <tr>
    <td>${formatFechaHuman(a.fecha)}</td>
    <td>${a.facturas?.paciente_nombre || "-"}</td>
    <td>${a.facturas?.numero_factura || "-"}</td>
    <td class="mono">$ ${money(a.monto)}</td>
  </tr>
`).join("");

    }

    // üîó Hook seguro al refrescarDashboard
    try{
      if (typeof refrescarDashboard === "function"){
        const __refrescarDashboardBase2 = refrescarDashboard;
        refrescarDashboard = async function(){
          await __refrescarDashboardBase2();
          await cargarReporteAbonos();
        };
      }
    }catch(err){
      console.error("Hook reporte abonos fall√≥:", err);
    }
    
    // =========================
    // ‚úÖ COSTOS (desde factura_detalle.costo)
    // =========================
    async function actualizarKPIsCostos(){
      const desde = ($("fecha_desde").value || "").trim();
      const hasta = ($("fecha_hasta").value || "").trim();

      const rangoDesde = desde || firstDayOfMonthISO(new Date());
      const rangoHasta = hasta || hoyISO();

      const sub = $("k_costos_sub");
      if (sub){
        sub.textContent = `Rango activo: ${formatFechaHuman(rangoDesde)} ‚Üí ${formatFechaHuman(rangoHasta)}`;
      }

      try{
        const { data, error } = await supabase
          .from("factura_detalle")
          .select("costo, factura_id, facturas:factura_id (fecha)")
          .gte("facturas.fecha", dateStartISO(rangoDesde))
          .lte("facturas.fecha", dateEndISO(rangoHasta));

        if (error) throw error;

        const totalCostos = (data || []).reduce((acc, r)=> acc + (Number(r.costo)||0), 0);

        $("k_costos_total").textContent = money(totalCostos);
        $("k_costos_total_s").textContent = `Costos sumados desde factura_detalle`;
      }catch(err){
        console.error("actualizarKPIsCostos:", err);
        $("k_costos_total").textContent = "0";
        $("k_costos_total_s").textContent = "No disponible";
      }
    }

    // Hook al refrescarDashboard
    try{
      if (typeof refrescarDashboard === "function"){
        const __refCostos = refrescarDashboard;
        refrescarDashboard = async function(){
          await __refCostos();
          await actualizarKPIsCostos();
        };
      }
    }catch(e){ console.error(e); }


// =========================
    // ‚úÖ INIT
    // =========================
    async function init(){
      $("year").textContent = new Date().getFullYear();

      $("btn-back").addEventListener("click", ()=> window.location.href = INDEX_URL);
      $("btn-logout").addEventListener("click", cerrarSesion);

      $("btn-this-month").addEventListener("click", async () => { setRangeMesActual(); await refrescarDashboard(); });
      $("btn-today").addEventListener("click", async () => { setRangeHoy(); await refrescarDashboard(); });

      $("btn-refresh").addEventListener("click", refrescarDashboard);
      $("btn-export").addEventListener("click", exportarExcel);

      $("fecha_desde").addEventListener("change", refrescarDashboard);
      $("fecha_hasta").addEventListener("change", refrescarDashboard);
      $("f_profesional").addEventListener("change", refrescarDashboard);
      $("f_metodo").addEventListener("change", refrescarDashboard);

      // ‚úÖ ABONOS POR D√çA
      $("fecha_abonos_dia").addEventListener("change", cargarAbonosPorDia);

      $("btn-show-all").addEventListener("click", ()=>{ state._view="all"; renderTablaFacturas(); });
      $("btn-show-pending").addEventListener("click", ()=>{ state._view="pending"; renderTablaFacturas(); });
      $("btn-show-paid").addEventListener("click", ()=>{ state._view="paid"; renderTablaFacturas(); });

      // ‚úÖ acciones de tabla (delegaci√≥n)
      $("tbody_facturas").addEventListener("click", async (e)=>{
        const btn = e.target?.closest?.("button[data-action]");
        if (!btn) return;
        const action = btn.getAttribute("data-action");
        const id = btn.getAttribute("data-id");
        if (action === "ver-factura"){
          await verFacturaPorId(id);
        }
      });

      // modal events
      $("btnCloseFactura").addEventListener("click", closeFacturaModal);
      $("modalFacturaBackdrop").addEventListener("click", (e)=>{
        if (e.target === $("modalFacturaBackdrop")) closeFacturaModal();
      });
      $("btnPrintFactura").addEventListener("click", ()=>{
        // imprime SOLO cuando modal est√° abierto (usa @media print)
        window.print();
      });
      window.addEventListener("keydown", (e)=>{
        if (e.key === "Escape"){
          const isOpen = $("modalFacturaBackdrop").style.display === "flex";
          if (isOpen) closeFacturaModal();
        }
      });

      bindAuthListener();

      // default: mes actual
      setRangeMesActual();

      // ‚úÖ Proteger y cargar
      const ok = await proteger();
      if (!ok) return;

      await cargarProfesionales();
      await refrescarDashboard();
    }

    window.addEventListener("DOMContentLoaded", () => {
      try{
        init();
      }catch(err){
        console.error("INIT FAILED:", err);
        toast("Fall√≥ init: revisa consola (F12)\\n" + (err?.message || "Error"), "err");
      }
    });
  </script>
</body>
</html>










   












































